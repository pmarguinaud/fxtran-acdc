SUBROUTINE ACNEBSM_OPENACC (YDCST, YDPHY0, KIDIA, KFDIA, KLON, KTDIA, KLEV, PT, PQ, PQL,&
& PQI, PAPHI, PAPRSF, PCP, PR, PGM, YDSTA, PQCS, PNEBS, PRHCRI, PICE, PQSATS, YDSTACK)
!$ACC ROUTINE (ACNEBSM_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPRD

USE YOMCST,ONLY:TCST
USE YOMPHY0,ONLY:TPHY0
USE YOMSTA,ONLY:TSTA
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY0), INTENT (IN)::YDPHY0
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PGM (KLON)
TYPE (TSTA), INTENT (IN)::YDSTA
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQCS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PNEBS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PRHCRI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PICE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSATS (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZC 
REAL (KIND=JPRB)::ZB 
REAL (KIND=JPRB)::ZA 
REAL (KIND=JPRB)::ZRHCRI1 
REAL (KIND=JPRB)::ZVETAF
REAL (KIND=JPRB)::ZFACTC
REAL (KIND=JPRB)::ZFACTB
REAL (KIND=JPRB)::ZFACTA
REAL (KIND=JPRB)::ZFACT0
REAL (KIND=JPRB)::ZFACT
REAL (KIND=JPRB)::ZRATQ
REAL (KIND=JPRB)::ZRHC
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZLV
REAL (KIND=JPRB)::ZQI
REAL (KIND=JPRB)::ZQL
REAL (KIND=JPRB)::ZRDSRV
REAL (KIND=JPRB)::ZSQRT6
REAL (KIND=JPRB)::ZQCS
REAL (KIND=JPRB)::ZQC
REAL (KIND=JPRB)::ZRAT2
REAL (KIND=JPRB)::ZSIGS
REAL (KIND=JPRB)::ZTLIQ
REAL (KIND=JPRB)::ZLEFF
REAL (KIND=JPRB)::ZLS
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZESP
REAL (KIND=JPRB)::ZESAT
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON

#include "fcttrm.func.h"
#include "fctdoi.func.h"

JLON = KIDIA



ZFACT0=(YDPHY0%RETAMIN*(YDPHY0%RETAMIN-1.0_JPRB))**2
ZFACTA=(2.0_JPRB*YDPHY0%RETAMIN-1.0_JPRB)
ZFACTB=(1.0_JPRB-3._JPRB*YDPHY0%RETAMIN**2)
ZFACTC=(3._JPRB*YDPHY0%RETAMIN-2.0_JPRB)*YDPHY0%RETAMIN

ZRHCRI1 =YDPHY0%RHCRIT1+(YDPHY0%RHCRIT2-YDPHY0%RHCRIT1)*YDPHY0&
&%GRHCMOD*EXP (-1.0_JPRB/(YDPHY0%TEQH*PGM (JLON)))
ZFACT=(YDPHY0%RHCRIT2-ZRHCRI1 )/ZFACT0
ZA =ZFACTA*ZFACT
ZB =ZFACTB*ZFACT
ZC =ZFACTC*ZFACT


DO JLEV=KTDIA, KLEV
  
  ZVETAF=MAX (YDSTA%SVETAF (JLEV), YDPHY0%RETAMIN)
  PRHCRI (JLON, JLEV)=ZA *ZVETAF**3+ZB *ZVETAF**2+ZC *ZVETAF+YDPHY0%RHCRIT2
  
ENDDO


IF (JPRB==JPRD) THEN
  ZEPS1=1.E-12_JPRB
ELSE
  ZEPS1=1.E-06_JPRB
ENDIF

ZSQRT6=SQRT (6._JPRB)
ZRDSRV=YDCST%RD/YDCST%RV

DO JLEV=KTDIA, KLEV
  
  ZRHC=PRHCRI (JLON, JLEV)
  ZQL=PQL (JLON, JLEV)
  ZQI=PQI (JLON, JLEV)
  ZQC=ZQL+ZQI
  PICE (JLON, JLEV)=FONICE (PT (JLON, JLEV), YDPHY0%RDTFAC)
  ZLV=FOLH (PT (JLON, JLEV), 0.0_JPRB)
  ZLS=FOLH (PT (JLON, JLEV), 1.0_JPRB)
  ZLEFF=ZLV*(1.0_JPRB-PICE (JLON, JLEV))+ZLS*PICE (JLON, JLEV)
  ZTLIQ=PT (JLON, JLEV)-(ZLV*ZQL+ZLS*ZQI)/PCP (JLON, JLEV)
  ZESAT=FOEW (ZTLIQ, 0.0_JPRB)*(1.0_JPRB-PICE (JLON, JLEV))+FOEW (ZTLIQ, 1.0_JPRB)*PICE (JLON, JLEV)
  ZESP=ZESAT/PAPRSF (JLON, JLEV)
  ZQSAT=FOQS (ZESP)
  PQSATS (JLON, JLEV)=ZQSAT
  ZSIGS=(1.0_JPRB-ZRHC)/ZSQRT6*ZQSAT/(1.0_JPRB+ZLEFF*ZLEFF*ZQSAT&
  &*ZRDSRV/PR (JLON, JLEV)/ZTLIQ/ZTLIQ/PCP (JLON, JLEV))
  ZRATQ=(PQ (JLON, JLEV)+ZQC)/ZQSAT
  ZRAT2=(ZRATQ-1.0_JPRB)/(1.0_JPRB-ZRHC)

  IF (ZRATQ<=ZRHC) THEN
    ZQCS=0.0_JPRB
    PNEBS (JLON, JLEV)=0.0_JPRB
  ELSEIF (ZRATQ<=1.0_JPRB.AND.ZRATQ>ZRHC) THEN
    ZQCS=(1.0_JPRB+ZRAT2)**3/ZSQRT6
    PNEBS (JLON, JLEV)=0.5_JPRB*(1.0_JPRB+ZRAT2)**2
  ELSEIF (ZRATQ<(2.0_JPRB-ZRHC).AND.ZRATQ>1.0_JPRB) THEN
    ZQCS=ZRAT2*ZSQRT6+(1.0_JPRB-ZRAT2)**3/ZSQRT6
    PNEBS (JLON, JLEV)=1.0_JPRB-0.5_JPRB*(1.0_JPRB-ZRAT2)**2
  ELSE
    ZQCS=ZRAT2*ZSQRT6
    PNEBS (JLON, JLEV)=1.0_JPRB
  ENDIF

  PQCS (JLON, JLEV)=YDPHY0%RSURF (JLEV)*ZQCS*ZSIGS
  PNEBS (JLON, JLEV)=YDPHY0%RSURF (JLEV)*PNEBS (JLON, JLEV)*YDPHY0%RFACNSM
  PNEBS (JLON, JLEV)=MIN (1.0_JPRB-ZEPS1, MAX (PNEBS (JLON, JLEV), ZEPS1))
  
ENDDO



END SUBROUTINE ACNEBSM_OPENACC
