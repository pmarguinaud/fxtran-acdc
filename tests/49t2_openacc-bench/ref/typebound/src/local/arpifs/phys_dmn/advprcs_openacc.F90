SUBROUTINE ADVPRCS_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA, KFLEV,&
& PT, PQ, PQL, PQI, PAUTOL, PAUTOI, PQR, PQS, PNEB, PCP, PR, PAPHI, PAPRSF, PDELP&
&, PFPLSL, PFPLSN, PFPEVPL, PFPEVPN, PFPFPL, PFPFPN, PSEDIQL, PSEDIQN, YDSTACK)
!$ACC ROUTINE (ADVPRCS_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PAUTOL (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PAUTOI (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PQR (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PQS (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPLSL (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPLSN (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPEVPL (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPEVPN (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPFPL (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPFPN (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PSEDIQL (KLON, 0:KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PSEDIQN (KLON, 0:KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZP2I
REAL (KIND=JPRB)::ZP1I
REAL (KIND=JPRB)::ZP2L
REAL (KIND=JPRB)::ZP1L
REAL (KIND=JPRB)::ZDZI
REAL (KIND=JPRB)::ZDZL1
REAL (KIND=JPRB)::ZDZL0
REAL (KIND=JPRB)::ZDZL
REAL (KIND=JPRB)::ZP3
REAL (KIND=JPRB)::ZP2
REAL (KIND=JPRB)::ZP1
REAL (KIND=JPRB)::ZDZS
REAL (KIND=JPRB)::ZALPHA
REAL (KIND=JPRB)::ZQPRTOT2
REAL (KIND=JPRB)::ZQPSTOT2
REAL (KIND=JPRB)::ZQPSTOT1
REAL (KIND=JPRB)::ZQPRTOT1
REAL (KIND=JPRB)::ZQMLT
REAL (KIND=JPRB)::ZQFPFPN
REAL (KIND=JPRB)::ZQFPFPL
REAL (KIND=JPRB)::ZTCOLLN
REAL (KIND=JPRB)::ZTCOLLL
REAL (KIND=JPRB)::ZTQEVAPPN
REAL (KIND=JPRB)::ZTQEVAPPL
REAL (KIND=JPRB)::ZQFRZ
REAL (KIND=JPRB)::ZQFRZX
REAL (KIND=JPRB)::ZQMLTX
REAL (KIND=JPRB)::ZINT1
REAL (KIND=JPRB)::ZEVAPPN
REAL (KIND=JPRB)::ZEVAPPL
REAL (KIND=JPRB)::ZSUBSA
REAL (KIND=JPRB)::ZLHFUS
REAL (KIND=JPRB)::ZFVENTS2
REAL (KIND=JPRB)::ZFVENTS1
REAL (KIND=JPRB)::ZFVENTR2
REAL (KIND=JPRB)::ZFVENTR1
REAL (KIND=JPRB)::ZSIGMA2
REAL (KIND=JPRB)::ZSIGMA1
REAL (KIND=JPRB)::ZTAU2
REAL (KIND=JPRB)::ZTAU1
REAL (KIND=JPRB)::ZNU2
REAL (KIND=JPRB)::ZNU1
REAL (KIND=JPRB)::ZCOEFF6
REAL (KIND=JPRB)::ZCOEFF5
REAL (KIND=JPRB)::ZCOEFF4
REAL (KIND=JPRB)::ZCOEFF3
REAL (KIND=JPRB)::ZCOEFF2B
REAL (KIND=JPRB)::ZCOEFF2
REAL (KIND=JPRB)::ZCOEFF1
REAL (KIND=JPRB)::ZRIMI
REAL (KIND=JPRB)::ZAGGR
REAL (KIND=JPRB)::ZACCR
REAL (KIND=JPRB)::ZQS
REAL (KIND=JPRB)::ZQR
REAL (KIND=JPRB)::ZSSATI
REAL (KIND=JPRB)::ZCSU
REAL (KIND=JPRB)::ZCEV
REAL (KIND=JPRB)::ZDIFFV
REAL (KIND=JPRB)::ZCONDT
REAL (KIND=JPRB)::ZSSATW
REAL (KIND=JPRB)::ZFACT4
REAL (KIND=JPRB)::ZFACT3
REAL (KIND=JPRB)::ZKDIFF
REAL (KIND=JPRB)::ZCLEAR
REAL (KIND=JPRB)::ZPREF
REAL (KIND=JPRB)::ZEXP6
REAL (KIND=JPRB)::ZEXP4
REAL (KIND=JPRB)::ZEXP1
REAL (KIND=JPRB)::ZRHOREF
REAL (KIND=JPRB)::ZCDARV
REAL (KIND=JPRB)::ZSQTVIS
REAL (KIND=JPRB)::ZDVISC
REAL (KIND=JPRB)::ZNRHOW
REAL (KIND=JPRB)::ZRHOW
REAL (KIND=JPRB)::ZTMELT
REAL (KIND=JPRB)::ZFVELS
REAL (KIND=JPRB)::ZFVELR
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZPOW2 
REAL (KIND=JPRB)::ZPOW1 
REAL (KIND=JPRB)::ZWORK3 
REAL (KIND=JPRB)::ZWORK2 
REAL (KIND=JPRB)::ZWORK1 
REAL (KIND=JPRB)::ZDZ 
REAL (KIND=JPRB)::ZQPSTOT 
fxtran_acdc_temp (REAL (KIND=JPRB), ZAUTOI, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZAUTOL, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSATI, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSATW, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQPS, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQPR, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQI, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQL, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFVEL, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCRIM, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCACC, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCAGG, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCSU2, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCSU1, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCEV2, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCEV1, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZNS, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEFFA, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDELT, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDPSGDT, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDPSG, (KLON, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZALTIH, (KLON, 0:KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRHO, (KLON, KFLEV))
LOGICAL::LLFREEZ
LOGICAL::LLMELTS
LOGICAL::LLEVAPX
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV

#include "fcttrm.func.h"

YLSTACK = YDSTACK



IF (KIND (ZAUTOI) == 8) THEN
    fxtran_acdc_alloc8 (ZAUTOI)
ELSEIF (KIND (ZAUTOI) == 4) THEN
    fxtran_acdc_alloc4 (ZAUTOI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZAUTOL) == 8) THEN
    fxtran_acdc_alloc8 (ZAUTOL)
ELSEIF (KIND (ZAUTOL) == 4) THEN
    fxtran_acdc_alloc4 (ZAUTOL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSATI) == 8) THEN
    fxtran_acdc_alloc8 (ZQSATI)
ELSEIF (KIND (ZQSATI) == 4) THEN
    fxtran_acdc_alloc4 (ZQSATI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSATW) == 8) THEN
    fxtran_acdc_alloc8 (ZQSATW)
ELSEIF (KIND (ZQSATW) == 4) THEN
    fxtran_acdc_alloc4 (ZQSATW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQPS) == 8) THEN
    fxtran_acdc_alloc8 (ZQPS)
ELSEIF (KIND (ZQPS) == 4) THEN
    fxtran_acdc_alloc4 (ZQPS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQPR) == 8) THEN
    fxtran_acdc_alloc8 (ZQPR)
ELSEIF (KIND (ZQPR) == 4) THEN
    fxtran_acdc_alloc4 (ZQPR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQI) == 8) THEN
    fxtran_acdc_alloc8 (ZQI)
ELSEIF (KIND (ZQI) == 4) THEN
    fxtran_acdc_alloc4 (ZQI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQL) == 8) THEN
    fxtran_acdc_alloc8 (ZQL)
ELSEIF (KIND (ZQL) == 4) THEN
    fxtran_acdc_alloc4 (ZQL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFVEL) == 8) THEN
    fxtran_acdc_alloc8 (ZFVEL)
ELSEIF (KIND (ZFVEL) == 4) THEN
    fxtran_acdc_alloc4 (ZFVEL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCRIM) == 8) THEN
    fxtran_acdc_alloc8 (ZCRIM)
ELSEIF (KIND (ZCRIM) == 4) THEN
    fxtran_acdc_alloc4 (ZCRIM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCACC) == 8) THEN
    fxtran_acdc_alloc8 (ZCACC)
ELSEIF (KIND (ZCACC) == 4) THEN
    fxtran_acdc_alloc4 (ZCACC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCAGG) == 8) THEN
    fxtran_acdc_alloc8 (ZCAGG)
ELSEIF (KIND (ZCAGG) == 4) THEN
    fxtran_acdc_alloc4 (ZCAGG)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCSU2) == 8) THEN
    fxtran_acdc_alloc8 (ZCSU2)
ELSEIF (KIND (ZCSU2) == 4) THEN
    fxtran_acdc_alloc4 (ZCSU2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCSU1) == 8) THEN
    fxtran_acdc_alloc8 (ZCSU1)
ELSEIF (KIND (ZCSU1) == 4) THEN
    fxtran_acdc_alloc4 (ZCSU1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCEV2) == 8) THEN
    fxtran_acdc_alloc8 (ZCEV2)
ELSEIF (KIND (ZCEV2) == 4) THEN
    fxtran_acdc_alloc4 (ZCEV2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCEV1) == 8) THEN
    fxtran_acdc_alloc8 (ZCEV1)
ELSEIF (KIND (ZCEV1) == 4) THEN
    fxtran_acdc_alloc4 (ZCEV1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZNS) == 8) THEN
    fxtran_acdc_alloc8 (ZNS)
ELSEIF (KIND (ZNS) == 4) THEN
    fxtran_acdc_alloc4 (ZNS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEFFA) == 8) THEN
    fxtran_acdc_alloc8 (ZEFFA)
ELSEIF (KIND (ZEFFA) == 4) THEN
    fxtran_acdc_alloc4 (ZEFFA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDELT) == 8) THEN
    fxtran_acdc_alloc8 (ZDELT)
ELSEIF (KIND (ZDELT) == 4) THEN
    fxtran_acdc_alloc4 (ZDELT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDPSGDT) == 8) THEN
    fxtran_acdc_alloc8 (ZDPSGDT)
ELSEIF (KIND (ZDPSGDT) == 4) THEN
    fxtran_acdc_alloc4 (ZDPSGDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDPSG) == 8) THEN
    fxtran_acdc_alloc8 (ZDPSG)
ELSEIF (KIND (ZDPSG) == 4) THEN
    fxtran_acdc_alloc4 (ZDPSG)
ELSE
    STOP 1
ENDIF


IF (KIND (ZALTIH) == 8) THEN
    fxtran_acdc_alloc8 (ZALTIH)
ELSEIF (KIND (ZALTIH) == 4) THEN
    fxtran_acdc_alloc4 (ZALTIH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRHO) == 8) THEN
    fxtran_acdc_alloc8 (ZRHO)
ELSEIF (KIND (ZRHO) == 4) THEN
    fxtran_acdc_alloc4 (ZRHO)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZDZL0=YDML_PHY_MF%YRPHY0%TFVL*YDML_PHY_MF%YRPHY2%TSPHY
ZDZL1=(YDML_PHY_MF%YRPHY0%TFVL+YDML_PHY_MF%YRPHY0%TFVLD)*YDML_PHY_MF%YRPHY2%TSPHY
ZDZI=YDML_PHY_MF%YRPHY0%TFVI*YDML_PHY_MF%YRPHY2%TSPHY

IF (YDML_PHY_MF%YRPHY2%TSPHY>0.0_JPRB) THEN
  LLMELTS=YDML_PHY_MF%YRPHY0%YRADVPRCS%LLMELTS
  LLFREEZ=YDML_PHY_MF%YRPHY0%YRADVPRCS%LLFREEZ
  LLEVAPX=YDML_PHY_MF%YRPHY0%YRADVPRCS%LLEVAPX
  ZEPS=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZEPS
  ZNU1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZNU1
  ZNU2=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZNU2
  ZTAU1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZTAU1
  ZTAU2=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZTAU2
  ZSIGMA1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZSIGMA1
  ZSIGMA2=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZSIGMA2
  ZFVENTR1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZFVENTR1
  ZFVENTR2=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZFVENTR2
  ZFVENTS1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZFVENTS1
  ZFVENTS2=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZFVENTS2
  ZFVELR=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZFVELR
  ZFVELS=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZFVELS
  ZTMELT=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZTMELT
  ZRHOW=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZRHOW
  ZNRHOW=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZNRHOW
  ZDVISC=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZDVISC
  ZSQTVIS=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZSQTVIS
  ZCDARV=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCDARV
  ZRHOREF=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZRHOREF
  ZEXP1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZEXP1
  ZEXP4=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZEXP4
  ZEXP6=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZEXP6
  ZPREF=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZPREF
  ZCOEFF1=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF1
  ZCOEFF2=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF2
  ZCOEFF2B=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF2B
  ZCOEFF3=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF3
  ZCOEFF4=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF4
  ZCOEFF5=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF5
  ZCOEFF6=YDML_PHY_MF%YRPHY0%YRADVPRCS%ZCOEFF6

  DO JLEV=0, KFLEV
    
    ZALTIH (JLON, JLEV)=PAPHI (JLON, JLEV)/YDCST%RG
  
  ENDDO


  DO JLEV=KTDIA, KFLEV
    
    ZDPSG (JLON, JLEV)=PDELP (JLON, JLEV)/YDCST%RG
    ZDPSGDT (JLON, JLEV)=ZDPSG (JLON, JLEV)*YDML_PHY_MF%YRPHY2%TSPHY
    ZDELT (JLON, JLEV)=PT (JLON, JLEV)-YDCST%RTT
    ZRHO (JLON, JLEV)=PAPRSF (JLON, JLEV)/PR (JLON, JLEV)/PT (JLON, JLEV)
    ZQPR (JLON, JLEV)=PQR (JLON, JLEV)
    ZQPS (JLON, JLEV)=PQS (JLON, JLEV)
    ZAUTOL (JLON, JLEV)=PAUTOL (JLON, JLEV)*ZDPSGDT (JLON, JLEV)
    ZAUTOI (JLON, JLEV)=PAUTOI (JLON, JLEV)*ZDPSGDT (JLON, JLEV)
  
  ENDDO


  DO JLEV=KTDIA, KFLEV
    
    ZWORK1 =FOEW (PT (JLON, JLEV), 0.0_JPRB)
    ZWORK2 =FOEW (PT (JLON, JLEV), 1.0_JPRB)
    ZWORK3 =(ZRHOREF/ZRHO (JLON, JLEV))**0.4_JPRB
    
    
    ZALPHA=MAX (ZEPS, PQS (JLON, JLEV))/MAX (ZEPS, PQR (JLON, JLEV)+PQS (JLON, JLEV))
    ZFVEL (JLON, JLEV)=ZALPHA*ZFVELS+(1.0_JPRB-ZALPHA)*ZFVELR
    ZEFFA (JLON, JLEV)=EXP (0.025_JPRB*ZDELT (JLON, JLEV))
    ZNS (JLON, JLEV)=YDML_PHY_MF%YRPHY0%RNINTS*EXP (-0.1222_JPRB*ZDELT (JLON, JLEV))
    ZQL (JLON, JLEV)=MAX (0.0_JPRB, PQL (JLON, JLEV)-PAUTOL (JLON, JLEV)*YDML_PHY_MF%YRPHY2%TSPHY)
    ZQI (JLON, JLEV)=MAX (0.0_JPRB, PQI (JLON, JLEV)-PAUTOI (JLON, JLEV)*YDML_PHY_MF%YRPHY2%TSPHY)
    ZCLEAR=1.0_JPRB-PNEB (JLON, JLEV)
    ZKDIFF=2.E-5_JPRB*ZPREF/PAPRSF (JLON, JLEV)
    ZFACT3=(ZSQTVIS*ZKDIFF)**ZEXP1
    ZFACT4=YDCST%RV*PT (JLON, JLEV)/ZKDIFF
    ZQSATW (JLON, JLEV)=FOQS (ZWORK1 /PAPRSF (JLON, JLEV))
    ZSSATW=1.0_JPRB-PQ (JLON, JLEV)/ZQSATW (JLON, JLEV)
    ZCONDT=(FOLH (PT (JLON, JLEV), 0.0_JPRB)/PT (JLON, JLEV))**2/ZCDARV
    ZDIFFV=ZFACT4/ZWORK1 
    ZCEV=ZSSATW*ZCLEAR*YDML_PHY_MF%YRPHY0%RNINTR/ZRHO (JLON, JLEV)/(ZCONDT+ZDIFFV)
    ZCEV=MAX (0.0_JPRB, ZCEV)
    ZCEV1 (JLON, JLEV)=ZCEV*ZCOEFF3
    ZCEV2 (JLON, JLEV)=ZCEV*ZCOEFF4/ZFACT3
    ZQSATI (JLON, JLEV)=FOQS (ZWORK2 /PAPRSF (JLON, JLEV))
    ZSSATI=1.0_JPRB-PQ (JLON, JLEV)/ZQSATI (JLON, JLEV)
    ZCONDT=(FOLH (PT (JLON, JLEV), 1.0_JPRB)/PT (JLON, JLEV))**2/ZCDARV
    ZDIFFV=ZFACT4/ZWORK2 
    ZCSU=ZSSATI*ZCLEAR*ZNS (JLON, JLEV)/ZRHO (JLON, JLEV)/(ZCONDT+ZDIFFV)
    ZCSU=MAX (0.0_JPRB, ZCSU)
    ZCSU1 (JLON, JLEV)=ZCSU*ZCOEFF5
    ZCSU2 (JLON, JLEV)=ZCSU*ZCOEFF6/ZFACT3
    ZCACC (JLON, JLEV)=ZCOEFF1*ZWORK3 
    ZCRIM (JLON, JLEV)=ZCOEFF2*ZWORK3 
    ZCAGG (JLON, JLEV)=ZCOEFF2B*ZWORK3 *ZEFFA (JLON, JLEV)
  
  ENDDO


  DO JLEV=KTDIA, KFLEV

    IF (JLEV<KFLEV) THEN
      ZDZL=ZDZL0
    ELSE
      ZDZL=ZDZL1
    ENDIF

    
    ZDZ =ZFVEL (JLON, JLEV)*YDML_PHY_MF%YRPHY2%TSPHY
    ZWORK3 =MAX (0.0_JPRB, ZDPSG (JLON, JLEV)*ZQPR (JLON, JLEV)+YDML_PHY_MF&
    &%YRPHY2%TSPHY*(PFPLSL (JLON, JLEV-1))+ZAUTOL (JLON, JLEV))
    ZQPSTOT =MAX (0.0_JPRB, ZDPSG (JLON, JLEV)*ZQPS (JLON, JLEV)+YDML_PHY_MF&
    &%YRPHY2%TSPHY*(PFPLSN (JLON, JLEV-1))+ZAUTOI (JLON, JLEV))
    
    
    ZQR=ZWORK3 /ZDZ 
    ZQS=ZQPSTOT /ZDZ 

    IF (YDML_PHY_MF%YRPHY%LEVAPP) THEN
      ZWORK1 =ZQR/ZNRHOW
      ZWORK2 =ZQS/ZNS (JLON, JLEV)
    ENDIF


    

    IF (YDML_PHY_MF%YRPHY%LEVAPP) THEN
      
      ZPOW1 =ZCEV2 (JLON, JLEV)*ZWORK1 **ZEXP6
      ZPOW2 =ZCSU1 (JLON, JLEV)*ZWORK2 **ZEXP4
    
    ENDIF

    
    ZTQEVAPPL=0.0_JPRB
    ZTQEVAPPN=0.0_JPRB
    ZQFPFPL=0.0_JPRB
    ZQFPFPN=0.0_JPRB
    ZTCOLLL=0.0_JPRB
    ZTCOLLN=0.0_JPRB
    ZQMLT=0.0_JPRB
    ZQMLTX=0.0_JPRB
    ZQFRZ=0.0_JPRB
    ZQFRZX=0.0_JPRB
    ZACCR=0.0_JPRB

    IF (YDML_PHY_MF%YRPHY%LEVAPP) THEN
      ZEVAPPL=ZCEV1 (JLON, JLEV)*SQRT (ZWORK1 )+ZPOW1 
      ZEVAPPN=ZPOW2 +ZCSU2 (JLON, JLEV)*ZWORK2 
      ZINT1=1.0_JPRB/MAX (ZEPS, ZEVAPPL+ZEVAPPN)

      IF (LLEVAPX) THEN
        ZSUBSA=YDML_PHY_MF%YRPHY0%REVASX*ZINT1*(1.0_JPRB-EXP (-1.0_JPRB/(YDML_PHY_MF%YRPHY0%REVASX*ZINT1)))
        ZEVAPPL=ZSUBSA*ZEVAPPL
        ZEVAPPN=ZSUBSA*ZEVAPPN
      ENDIF

      ZSUBSA=ZINT1*ZEVAPPL*(ZQSATW (JLON, JLEV)-PQ (JLON, JLEV))
      ZTQEVAPPL=MAX (0.0_JPRB, MIN (ZWORK3 , ZEVAPPL*ZDPSGDT (JLON, JLEV), ZSUBSA*ZDPSG (JLON, JLEV)))
      ZSUBSA=ZINT1*ZEVAPPN*(ZQSATI (JLON, JLEV)-PQ (JLON, JLEV))
      ZTQEVAPPN=MAX (0.0_JPRB, MIN (ZQPSTOT , ZEVAPPN*ZDPSGDT (JLON, JLEV), ZSUBSA*ZDPSG (JLON, JLEV)))
    ENDIF

    ZQPRTOT1=ZWORK3 -ZTQEVAPPL
    ZQPSTOT1=ZQPSTOT -ZTQEVAPPN
    ZQR=ZQPRTOT1/ZDZ 
    ZQS=ZQPSTOT1/ZDZ 

    IF (YDML_PHY_MF%YRPHY%LCOLLEC) THEN
      ZACCR=ZQL (JLON, JLEV)*(1.0_JPRB-EXP (-ZCACC (JLON, JLEV)*ZQR*YDML_PHY_MF%YRPHY2&
      &%TSPHY))*MAX (0.0_JPRB, SIGN (1.0_JPRB, PT (JLON, JLEV)-YDCST%RTT))
      ZAGGR=ZQI (JLON, JLEV)*(1.0_JPRB-EXP (-ZCAGG (JLON, JLEV)*ZQS*YDML_PHY_MF%YRPHY2%TSPHY))
      ZRIMI=ZQL (JLON, JLEV)*(1.0_JPRB-EXP (-ZCRIM (JLON, JLEV)*ZQS*YDML_PHY_MF%YRPHY2%TSPHY))
      ZTCOLLL=MAX (0.0_JPRB, MIN (ZACCR+ZRIMI, ZQL (JLON, JLEV)))*ZDPSG (JLON, JLEV)
      ZTCOLLN=MAX (0.0_JPRB, MIN (ZAGGR, ZQI (JLON, JLEV)))*ZDPSG (JLON, JLEV)
    ENDIF

    ZQPRTOT2=ZWORK3 +ZTCOLLL
    ZQPSTOT2=ZQPSTOT +ZTCOLLN

    IF (LLMELTS) THEN
      ZLHFUS=FOLH (PT (JLON, JLEV), 1.0_JPRB)-FOLH (PT (JLON, JLEV), 0.0_JPRB)
      ZQMLTX=ZDPSG (JLON, JLEV)*PCP (JLON, JLEV)*MAX (0.0_JPRB, ZDELT (JLON, JLEV))/ZLHFUS

      IF (.NOT.YDML_PHY_MF%YRPHY%LSMOOTHMELT) THEN
        ZQMLT=MIN (ZQMLTX, ZQPSTOT2-ZTQEVAPPN)
      ELSE
        ZQMLT=(ZQPSTOT2-ZTQEVAPPN)*(1+TANH (ZDELT (JLON, JLEV)/YDML_PHY_MF%YRPHY0%RSMOOTHMELT))/2.0_JPRB
      ENDIF

    ENDIF


    IF (LLFREEZ) THEN
      ZQFRZX=ZDPSG (JLON, JLEV)*PCP (JLON, JLEV)*MAX (0.0_JPRB,-ZDELT (JLON, JLEV))/ZLHFUS
      ZQFRZ=MIN (ZQFRZX, ZQPRTOT2-ZTQEVAPPL)
    ENDIF

    PFPEVPL (JLON, JLEV)=PFPEVPL (JLON, JLEV-1)+(ZTQEVAPPL-ZQMLT+ZQFRZ)/YDML_PHY_MF%YRPHY2%TSPHY
    PFPEVPN (JLON, JLEV)=PFPEVPN (JLON, JLEV-1)+(ZTQEVAPPN+ZQMLT-ZQFRZ)/YDML_PHY_MF%YRPHY2%TSPHY
    PFPFPL (JLON, JLEV)=PFPFPL (JLON, JLEV-1)+(ZTCOLLL+ZAUTOL (JLON, JLEV))/YDML_PHY_MF%YRPHY2%TSPHY
    PFPFPN (JLON, JLEV)=PFPFPN (JLON, JLEV-1)+(ZTCOLLN+ZAUTOI (JLON, JLEV))/YDML_PHY_MF%YRPHY2%TSPHY
    ZDZS=ZALTIH (JLON, JLEV-1)-ZALTIH (JLON, JLEV)
    ZP1=MIN (1._JPRB, ZDZ /ZDZS)
    ZP2=MAX (0._JPRB, 1._JPRB-ZDZS/ZDZ )
    ZP3=(ZP1+ZP2)/2.0_JPRB
    ZP1L=MIN (1._JPRB, ZDZL/ZDZS)
    ZP2L=MAX (0._JPRB, 1._JPRB-ZDZS/MAX (ZEPS, ZDZL))
    ZP1I=MIN (1._JPRB, ZDZI/ZDZS)
    ZP2I=MAX (0._JPRB, 1._JPRB-ZDZS/MAX (ZEPS, ZDZI))
    PFPLSL (JLON, JLEV)=(ZP1*ZDPSG (JLON, JLEV)*ZQPR (JLON, JLEV)+ZP2*YDML_PHY_MF%YRPHY2&
    &%TSPHY*PFPLSL (JLON, JLEV-1)+ZP3*(ZAUTOL (JLON, JLEV)+ZTCOLLL+ZQMLT))*MAX (0.0_JPRB&
    &,(1._JPRB-(ZTQEVAPPL+ZQFRZ)/MAX (ZEPS, ZQPRTOT2)))/YDML_PHY_MF%YRPHY2%TSPHY
    PFPLSN (JLON, JLEV)=(ZP1*ZDPSG (JLON, JLEV)*ZQPS (JLON, JLEV)+ZP2*YDML_PHY_MF%YRPHY2&
    &%TSPHY*PFPLSN (JLON, JLEV-1)+ZP3*(ZAUTOI (JLON, JLEV)+ZTCOLLN+ZQFRZ))*MAX (0.0_JPRB&
    &,(1._JPRB-(ZTQEVAPPN+ZQMLT)/MAX (ZEPS, ZQPSTOT2)))/YDML_PHY_MF%YRPHY2%TSPHY
    PSEDIQL (JLON, JLEV)=(ZP1L*ZDPSG (JLON, JLEV)*ZQL (JLON, JLEV)+ZP2L*YDML_PHY_MF&
    &%YRPHY2%TSPHY*PSEDIQL (JLON, JLEV-1))/YDML_PHY_MF%YRPHY2%TSPHY
    PSEDIQN (JLON, JLEV)=(ZP1I*ZDPSG (JLON, JLEV)*ZQI (JLON, JLEV)+ZP2I*YDML_PHY_MF&
    &%YRPHY2%TSPHY*PSEDIQN (JLON, JLEV-1))/YDML_PHY_MF%YRPHY2%TSPHY
  
  ENDDO

ENDIF



END SUBROUTINE ADVPRCS_OPENACC
