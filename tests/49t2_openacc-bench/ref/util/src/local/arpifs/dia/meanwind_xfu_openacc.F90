SUBROUTINE MEANWIND_XFU_OPENACC (KLON, KIDIA, KFDIA, KMEANSTEPS&
&, PXFU, PXFV, PXU, PXV, PMWINDCALC, ZUM, ZVM, YDSTACK)
!$ACC ROUTINE (MEANWIND_XFU_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KMEANSTEPS
REAL (KIND=JPRB), INTENT (IN)::PXFU (KLON)
REAL (KIND=JPRB), INTENT (IN)::PXFV (KLON)
REAL (KIND=JPRB), INTENT (IN)::PXU (KLON)
REAL (KIND=JPRB), INTENT (IN)::PXV (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PMWINDCALC (KLON)
REAL (KIND=JPRB), INTENT (OUT)::ZUM (KLON)
REAL (KIND=JPRB), INTENT (OUT)::ZVM (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZMEANMODULE 
REAL (KIND=JPRB)::ZMEANANGLE
REAL (KIND=JPRB)::ZANGLE
REAL (KIND=JPRB)::ZMEANCANGLE
REAL (KIND=JPRB)::ZMEANSANGLE
REAL (KIND=JPRB), PARAMETER::ZEPS=1.E-12_JPRB
INTEGER (KIND=JPIM)::JLON


JLON = KIDIA



IF (KMEANSTEPS==1) THEN
  ZUM (JLON)=PXU (JLON)
  ZVM (JLON)=PXV (JLON)
  PMWINDCALC (JLON)=1.0_JPRB
ELSE
  
  ZMEANMODULE =SQRT (PXFU (JLON)**2+PXFV (JLON)**2)
  
  
  ZMEANMODULE =ZMEANMODULE *REAL (KMEANSTEPS-1, JPRB)+SQRT (PXU (JLON)**2+PXV (JLON)**2)

  

  

  IF (ABS (PXFV (JLON))<ZEPS.AND.ABS (PXFU (JLON))<ZEPS) THEN
    ZMEANANGLE=0.0_JPRB
  ELSE
    ZMEANANGLE=ATAN2 (PXFV (JLON), PXFU (JLON))
  ENDIF


  IF (ABS (PXV (JLON))<ZEPS.AND.ABS (PXU (JLON))<ZEPS) THEN
    ZANGLE=0.0_JPRB
  ELSE
    ZANGLE=ATAN2 (PXV (JLON), PXU (JLON))
  ENDIF

  ZMEANCANGLE=(COS (ZMEANANGLE)*REAL (KMEANSTEPS-1, JPRB)*PMWINDCALC&
  & (JLON)+COS (ZANGLE))/REAL (KMEANSTEPS, JPRB)
  ZMEANSANGLE=(SIN (ZMEANANGLE)*REAL (KMEANSTEPS-1, JPRB)*PMWINDCALC&
  & (JLON)+SIN (ZANGLE))/REAL (KMEANSTEPS, JPRB)
  PMWINDCALC (JLON)=SQRT (ZMEANCANGLE**2+ZMEANSANGLE**2)

  IF (ABS (ZMEANSANGLE)<ZEPS.AND.ABS (ZMEANCANGLE)<ZEPS) THEN
    ZMEANANGLE=0.0_JPRB
  ELSE
    ZMEANANGLE=ATAN2 (ZMEANSANGLE, ZMEANCANGLE)
  ENDIF

  ZUM (JLON)=ZMEANMODULE *COS (ZMEANANGLE)/REAL (KMEANSTEPS, JPRB)
  ZVM (JLON)=ZMEANMODULE *SIN (ZMEANANGLE)/REAL (KMEANSTEPS, JPRB)
  
ENDIF


END SUBROUTINE MEANWIND_XFU_OPENACC
