SUBROUTINE MF_PHYS_FPL_PART2_PARALLEL (YDCPG_BNDS, YDCPG_OPTS, YD_PPFL_FPLCH&
&, YD_PPFL_FPLSH, YD_PCPF_T1, YD_PSPF_T1, YDMODEL)
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK

USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE TYPE_MODEL,ONLY:MODEL
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
CLASS (FIELD_3RB), POINTER :: YD_PPFL_FPLCH
REAL (KIND=JPRB), POINTER::PPFL_FPLCH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PPFL_FPLSH
REAL (KIND=JPRB), POINTER::PPFL_FPLSH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PCPF_T1
REAL (KIND=JPRB), POINTER::PCPF_T1 (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PSPF_T1
REAL (KIND=JPRB), POINTER::PSPF_T1 (:,:,:)
TYPE (MODEL), INTENT (IN)::YDMODEL
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
#include "abor1.intfb.h"
IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','MF_PHYS_FPL_PART2_PARALLEL:PART2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  PCPF_T1 => GET_HOST_DATA_RDWR (YD_PCPF_T1)
  PPFL_FPLCH => GET_HOST_DATA_RDONLY (YD_PPFL_FPLCH)
  PPFL_FPLSH => GET_HOST_DATA_RDONLY (YD_PPFL_FPLSH)
  PSPF_T1 => GET_HOST_DATA_RDWR (YD_PSPF_T1)
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JLON) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    IF (YDMODEL%YRML_PHY_MF%YRPHY%LNEBN.OR.YDMODEL%YRML_PHY_MF&
      &%YRPHY%LNEBR.OR.YDMODEL%YRML_PHY_MF%YRPHY%LRRGUST) THEN

      DO JLEV=1, YDCPG_OPTS%KFLEVG

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          PCPF_T1 (JLON, JLEV, JBLK)=PPFL_FPLCH (JLON, JLEV, JBLK)
        ENDDO

      ENDDO

    ENDIF


    IF (YDMODEL%YRML_PHY_MF%YRPHY%LRRGUST) THEN

      DO JLEV=1, YDCPG_OPTS%KFLEVG

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          PSPF_T1 (JLON, JLEV, JBLK)=PPFL_FPLSH (JLON, JLEV, JBLK)
        ENDDO

      ENDDO

    ENDIF

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('MF_PHYS_FPL_PART2_PARALLEL:PART2')) THEN
    IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    PCPF_T1 => GET_HOST_DATA_RDWR (YD_PCPF_T1)
    PPFL_FPLCH => GET_HOST_DATA_RDWR (YD_PPFL_FPLCH)
    PPFL_FPLSH => GET_HOST_DATA_RDWR (YD_PPFL_FPLSH)
    PSPF_T1 => GET_HOST_DATA_RDWR (YD_PSPF_T1)
    IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  PCPF_T1 => NULL ()
  PPFL_FPLCH => NULL ()
  PPFL_FPLSH => NULL ()
  PSPF_T1 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','MF_PHYS_FPL_PART2_PARALLEL:PART2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  PCPF_T1 => GET_HOST_DATA_RDWR (YD_PCPF_T1)
  PPFL_FPLCH => GET_HOST_DATA_RDONLY (YD_PPFL_FPLCH)
  PPFL_FPLSH => GET_HOST_DATA_RDONLY (YD_PPFL_FPLSH)
  PSPF_T1 => GET_HOST_DATA_RDWR (YD_PSPF_T1)
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JLON, YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

    

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      IF (YDMODEL%YRML_PHY_MF%YRPHY%LNEBN.OR.YDMODEL%YRML_PHY_MF&
        &%YRPHY%LNEBR.OR.YDMODEL%YRML_PHY_MF%YRPHY%LRRGUST) THEN

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PCPF_T1 (JLON, JLEV, JBLK)=PPFL_FPLCH (JLON, JLEV, JBLK)
        
        ENDDO

      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LRRGUST) THEN

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PSPF_T1 (JLON, JLEV, JBLK)=PPFL_FPLSH (JLON, JLEV, JBLK)
        
        ENDDO

      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('MF_PHYS_FPL_PART2_PARALLEL:PART2')) THEN
    IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    PCPF_T1 => GET_HOST_DATA_RDWR (YD_PCPF_T1)
    PPFL_FPLCH => GET_HOST_DATA_RDWR (YD_PPFL_FPLCH)
    PPFL_FPLSH => GET_HOST_DATA_RDWR (YD_PPFL_FPLSH)
    PSPF_T1 => GET_HOST_DATA_RDWR (YD_PSPF_T1)
    IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  PCPF_T1 => NULL ()
  PPFL_FPLCH => NULL ()
  PPFL_FPLSH => NULL ()
  PSPF_T1 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','MF_PHYS_FPL_PART2_PARALLEL:PART2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  PCPF_T1 => GET_DEVICE_DATA_RDWR (YD_PCPF_T1)
  PPFL_FPLCH => GET_DEVICE_DATA_RDONLY (YD_PPFL_FPLCH)
  PPFL_FPLSH => GET_DEVICE_DATA_RDONLY (YD_PPFL_FPLSH)
  PSPF_T1 => GET_DEVICE_DATA_RDWR (YD_PSPF_T1)
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (PCPF_T1, PPFL_FPLCH, PPFL_FPLSH, PSPF_T1, YDCPG_OPTS, YDMODEL, &
    !$ACC&         YFXTRAN_ACDC_STACK) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLEV, JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      IF (YDMODEL%YRML_PHY_MF%YRPHY%LNEBN.OR.YDMODEL%YRML_PHY_MF&
        &%YRPHY%LNEBR.OR.YDMODEL%YRML_PHY_MF%YRPHY%LRRGUST) THEN

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PCPF_T1 (JLON, JLEV, JBLK)=PPFL_FPLCH (JLON, JLEV, JBLK)
        
        ENDDO

      ENDIF


      IF (YDMODEL%YRML_PHY_MF%YRPHY%LRRGUST) THEN

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PSPF_T1 (JLON, JLEV, JBLK)=PPFL_FPLSH (JLON, JLEV, JBLK)
        
        ENDDO

      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('MF_PHYS_FPL_PART2_PARALLEL:PART2')) THEN
    IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    PCPF_T1 => GET_HOST_DATA_RDWR (YD_PCPF_T1)
    PPFL_FPLCH => GET_HOST_DATA_RDWR (YD_PPFL_FPLCH)
    PPFL_FPLSH => GET_HOST_DATA_RDWR (YD_PPFL_FPLSH)
    PSPF_T1 => GET_HOST_DATA_RDWR (YD_PSPF_T1)
    IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  PCPF_T1 => NULL ()
  PPFL_FPLCH => NULL ()
  PPFL_FPLSH => NULL ()
  PSPF_T1 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('MF_PHYS_FPL_PART2_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL:PART2',1,ZHOOK_HANDLE_PARALLEL)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('MF_PHYS_FPL_PART2_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE MF_PHYS_FPL_PART2_PARALLEL
