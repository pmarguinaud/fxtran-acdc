SUBROUTINE VERDISINT_OPENACC (YDVFE, YDCVER, CDOPER, CDBC, KPROMA, KST&
&, KEND, KFLEV, PIN, POUT, POUTS, PINS, KCHUNK, KLOUT, YDSTACK)
!$ACC ROUTINE (VERDISINT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPRD
USE YOMCVER,ONLY:TCVER

USE YOMLUN,ONLY:NULERR
USE YOMVERT,ONLY:TVFE
USE OML_MOD,ONLY:OML_MAX_THREADS
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TVFE), TARGET, INTENT (IN)::YDVFE
TYPE (TCVER), INTENT (IN)::YDCVER
CHARACTER (LEN=*), INTENT (IN)::CDOPER
CHARACTER (LEN=2), INTENT (IN)::CDBC
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), OPTIONAL, INTENT (IN)::KLOUT
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM), OPTIONAL, INTENT (IN)::KCHUNK
REAL (KIND=JPRB), INTENT (IN)::PIN (KPROMA, 0:KFLEV+1)
REAL (KIND=JPRB), OPTIONAL, INTENT (OUT)::POUTS (KPROMA)
REAL (KIND=JPRB), OPTIONAL, INTENT (OUT)::POUT (KPROMA,*)
REAL (KIND=JPRB), OPTIONAL, INTENT (IN)::PINS (KPROMA)
LOGICAL::LLVERINT_ON_CPU
CHARACTER (LEN=2)::CLBC
INTEGER (KIND=JPIM)::JCHUNK
INTEGER (KIND=JPIM)::ITYPE
INTEGER (KIND=JPIM)::IEND
INTEGER (KIND=JPIM)::IND
INTEGER (KIND=JPIM)::ILEVOUT
INTEGER (KIND=JPIM)::ILEVIN
REAL (KIND=JPRD), CONTIGUOUS, POINTER::ZOPER (:,:)
fxtran_acdc_temp (REAL (KIND=JPRD), ZOUTS, (KPROMA))
INTEGER (KIND=JPIM)::IMAXTHREADS


#include "verder_openacc.intfb.h"
#include "verint_openacc.intfb.h"
#include "verints_openacc.intfb.h"
INTEGER (KIND=JPIM) :: JROF

YLSTACK = YDSTACK



IF (KIND (ZOUTS) == 8) THEN
    fxtran_acdc_alloc8 (ZOUTS)
ELSEIF (KIND (ZOUTS) == 4) THEN
    fxtran_acdc_alloc4 (ZOUTS)
ELSE
    STOP 1
ENDIF


JROF = KST



IMAXTHREADS=1


IF (YDCVER%LVFE_ECMWF) THEN

  IF (CDOPER (1:4)/='FDER'.OR.YDCVER%LVFE_NOBC) THEN
    CLBC='XX'
  ELSE
    CLBC='BC'
  ENDIF

ELSE
  CLBC=CDBC
ENDIF


IF (CDOPER (1:4)=='FDER'.OR.CDOPER (1:4)=='DDER') THEN
  ILEVOUT=KFLEV
ELSE
  ILEVOUT=KFLEV+1
ENDIF


IF (CDOPER (1:4)=='IBOT') THEN
  ITYPE=1
ELSE
  ITYPE=0
ENDIF


IF (CDOPER (1:4)=='INGW'.OR.CDOPER (1:4)=='DEGW') THEN
  IND=0
  ILEVIN=KFLEV+1
ELSEIF (CLBC=='XX'.OR.CDOPER=='INTG') THEN
  IND=1
  ILEVIN=KFLEV
ELSE
  IND=0
  ILEVIN=KFLEV+2
ENDIF

IEND=ILEVIN-1+IND

IF (CDOPER (1:4)=='INGW') THEN
  WRITE (0,*)"oper INWG", PRESENT (KLOUT), PRESENT (PINS)
  ZOPER=>YDVFE%RINTGW (:,:)
ELSEIF (ANY (CDOPER (1:4)==(/'ITOP','IBOT'/))) THEN

  IF (CLBC=='XX') THEN
    ZOPER=>YDVFE%RINTE (:,:)
  ELSEIF (CLBC=='00') THEN
    ZOPER=>YDVFE%RINTBF00 (:,:)
  ELSEIF (CLBC=='11') THEN
    ZOPER=>YDVFE%RINTBF11 (:,:)
  ELSE
    PRINT *, 'VERDISINT:ITOP/IBOTNOTIMPLEMENTEDFORCDBC=',CLBC
    CALL FXTRAN_ACDC_ABORT (' VERDISINT: ABOR1 CALLED')
  ENDIF

ELSEIF (CDOPER=='INTG') THEN
  ZOPER=>YDVFE%RINTG (:,:)
ENDIF


IF (CDOPER (1:4)=='DEGW') THEN
  ZOPER=>YDVFE%RDERGW (:,:)
ELSEIF (CDOPER (1:4)=='HDER') THEN

  IF (CLBC=='00') THEN
    ZOPER=>YDVFE%RDERBH00 (:,:)
  ELSEIF (CLBC=='01') THEN
    ZOPER=>YDVFE%RDERBH01 (:,:)
  ELSE
    PRINT *, 'VERDISINT:HDERNOTIMPLEMENTEDFORCDBC=',CLBC
    CALL FXTRAN_ACDC_ABORT (' VERDISINT: ABOR1 CALLED')
  ENDIF

ELSEIF (CDOPER (1:4)=='FDER') THEN

  IF (CLBC=='XX') THEN
    ZOPER=>YDVFE%RDERI (:,:)
  ELSEIF (CLBC=='BC') THEN
    ZOPER=>YDVFE%RDERB (:,:)
  ELSEIF (CLBC=='00') THEN
    ZOPER=>YDVFE%RDERBF00 (:,:)
  ELSEIF (CLBC=='01') THEN
    ZOPER=>YDVFE%RDERBF01 (:,:)
  ELSEIF (CLBC=='10') THEN
    ZOPER=>YDVFE%RDERBF10 (:,:)
  ELSEIF (CLBC=='11') THEN
    ZOPER=>YDVFE%RDERBF11 (:,:)
  ELSE
    PRINT *, 'VERDISINT:FDERNOTIMPLEMENTEDFORCDBC=',CLBC
    CALL FXTRAN_ACDC_ABORT (' VERDISINT: ABOR1 CALLED')
  ENDIF

ELSEIF (CDOPER (1:4)=='DDER') THEN

  IF (CLBC=='XX') THEN
    ZOPER=>YDVFE%RDDERI (:,:)
  ELSEIF (CLBC=='01') THEN
    ZOPER=>YDVFE%RDDERBF01 (:,:)
  ELSE
    PRINT *, 'VERDISINT:DDERNOTIMPLEMENTEDFORCDBC=',CLBC
    CALL FXTRAN_ACDC_ABORT (' VERDISINT: ABOR1 CALLED')
  ENDIF

ENDIF


IF (ANY (CDOPER (1:4)==(/'INGW','ITOP','IBOT'/))) THEN

  IF (PRESENT (KCHUNK)) THEN
    JCHUNK=KCHUNK
  ELSE
    JCHUNK=1+(KEND-KST)/IMAXTHREADS
  ENDIF


  IF (.NOT.PRESENT (POUT)) THEN

    IF (.NOT.PRESENT (POUTS))  THEN
      CALL FXTRAN_ACDC_ABORT ("ERROR: NEEDS AT LEAST 1 OF POUT/POUTS")
    ENDIF


    IF (ITYPE==1)  THEN
      CALL FXTRAN_ACDC_ABORT ("ERROR POUTS: ITYPE=1 NOT POSSIBLE")
    ENDIF


    IF (ILEVOUT==KFLEV)  THEN
      CALL FXTRAN_ACDC_ABORT ("ERROR POUTS: DERIVATIVE NOT POSSIBLE")
    ENDIF

    CALL VERINTS_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, YDSTACK=YLSTACK)
    POUTS (JROF)=ZOUTS (JROF)
  ELSEIF (PRESENT (POUTS)) THEN

    IF (ITYPE==1)  THEN
      CALL FXTRAN_ACDC_ABORT ("ERROR KFLEV+1: ITYPE=1 NOT POSSIBLE")
    ENDIF


    IF (PRESENT (PINS))  THEN
      CALL FXTRAN_ACDC_ABORT ("ERROR: PINS MEANINGLESS WITH POUTS")
    ENDIF

    CALL VERINTS_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, YDSTACK=YLSTACK)
    POUTS (JROF)=ZOUTS (JROF)
    CALL VERINT_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER, PIN&
    & (:, IND:IEND), POUT, ITYPE, JCHUNK, ZOUTS, YDSTACK=YLSTACK)
  ELSEIF (ITYPE==1) THEN
    CALL VERINTS_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, YDSTACK=YLSTACK)
    CALL VERINT_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER, PIN &
    &(:, IND:IEND), POUT, ITYPE, JCHUNK, ZOUTS, PINS, YDSTACK=YLSTACK)
  ELSEIF (ILEVOUT==KFLEV+1.AND..NOT.PRESENT (KLOUT)) THEN

    IF (PRESENT (PINS))  THEN
      CALL FXTRAN_ACDC_ABORT ("ERROR: PINS MEANINGLESS WITH POUTS")
    ENDIF

    CALL VERINTS_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
    &, ZOPER, PIN (:, IND:IEND), ZOUTS, YDSTACK=YLSTACK)
    POUT (JROF, ILEVOUT)=ZOUTS (JROF)
    CALL VERINT_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER, PIN &
    &(:, IND:IEND), POUT, ITYPE, JCHUNK, ZOUTS, PINS, YDSTACK=YLSTACK)
  ELSE
    CALL VERINT_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT, ZOPER, PIN&
    & (:, IND:IEND), POUT, ITYPE, JCHUNK, PINS=PINS, YDSTACK=YLSTACK)
  ENDIF

ELSEIF (ANY (CDOPER (1:4)==(/'FDER','HDER','DEGW','DDER'/))) THEN
  CALL VERDER_OPENACC (KPROMA, KST, KEND, ILEVIN, ILEVOUT&
  &, ZOPER, PIN (:, IND:IEND), POUT, YDSTACK=YLSTACK)
ELSE
  PRINT *, 'VERDISINT:UNKNOWNCDOPER=',CDOPER
  CALL FXTRAN_ACDC_ABORT (' VERDISINT: ABOR1 CALLED')
ENDIF



END SUBROUTINE VERDISINT_OPENACC
