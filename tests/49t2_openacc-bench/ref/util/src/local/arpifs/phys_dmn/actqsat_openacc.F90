
SUBROUTINE ACTQSAT_OPENACC (YDCST, YDPHY, KIDIA, KFDIA, KLON, KTDIA, KLEV, PAPRSF&
&, PCP, PQ, PT, PGEOSLC, PLH, PLSCPE, PQSAT, PQW, PRH, PTW, YDSTACK)
!$ACC ROUTINE (ACTQSAT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMPHY,ONLY:TPHY
USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PGEOSLC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLSCPE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQSAT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQW (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PTW (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZQWI 
REAL (KIND=JPRB)::ZLH 
REAL (KIND=JPRB)::ZCP 
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JIT
REAL (KIND=JPRB)::ZQW
REAL (KIND=JPRB)::ZEW
REAL (KIND=JPRB)::ZESP
REAL (KIND=JPRB)::ZDQW
REAL (KIND=JPRB)::ZDELTA
REAL (KIND=JPRB)::ZDELT
REAL (KIND=JPRB)::ZDELQ
REAL (KIND=JPRB)::ZDCP
REAL (KIND=JPRB)::ZCPVMW
REAL (KIND=JPRB)::ZCPVMS

#include "fcttrm.func.h"

JLON = KIDIA



ZCPVMW=YDCST%RCPV-YDCST%RCW
ZCPVMS=YDCST%RCPV-YDCST%RCS

DO JLEV=KTDIA, KLEV

  

  IF (YDPHY%LNEIGE) THEN
    ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PT (JLON, JLEV)))
  ELSE
    ZDELTA=0.0_JPRB
  ENDIF

  PLH (JLON, JLEV)=FOLH (PT (JLON, JLEV), ZDELTA)
  
  
  PQW (JLON, JLEV)=PQ (JLON, JLEV)
  ZCP =PCP (JLON, JLEV)
  PTW (JLON, JLEV)=PT (JLON, JLEV)
  ZLH =PLH (JLON, JLEV)

  

  DO JIT=1, YDPHY%NBITER

    

    IF (YDPHY%LNEIGE) THEN
      ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PTW (JLON, JLEV)))
    ELSE
      ZDELTA=0.0_JPRB
    ENDIF

    ZEW=FOEW (PTW (JLON, JLEV), ZDELTA)
    ZESP=ZEW/PAPRSF (JLON, JLEV)
    ZQW=FOQS (ZESP)
    ZDQW=FDQW (ZESP, FODLEW (PTW (JLON, JLEV), ZDELTA))
    ZQWI =ZQW
    ZDCP=ZCPVMW+ZDELTA*(ZCPVMS-ZCPVMW)
    ZDELQ=(ZQW-PQW (JLON, JLEV))*ZCP /(ZCP +ZLH *ZDQW)
    ZCP =ZCP +ZDCP*ZDELQ
    ZDELT=-ZDELQ*ZLH /ZCP 
    ZLH =ZLH +ZDCP*ZDELT
    PQW (JLON, JLEV)=PQW (JLON, JLEV)+ZDELQ
    PTW (JLON, JLEV)=PTW (JLON, JLEV)+ZDELT
    PLSCPE (JLON, JLEV)=PLH (JLON, JLEV)/ZCP 
    PGEOSLC (JLON, JLEV)=PTW (JLON, JLEV)*(ZCP +ZLH *ZDQW)/(1.0_JPRB+ZLH *PQW (JLON&
    &, JLEV)/(PTW (JLON, JLEV)*YDCST%RD*(1.0_JPRB+YDCST%RETV*PQW (JLON, JLEV))))

    

    IF (JIT==1) THEN
      
      PQSAT (JLON, JLEV)=ZQWI 
    
    ENDIF

  ENDDO

  
  PRH (JLON, JLEV)=(PQ (JLON, JLEV)*(1.0_JPRB+YDCST%RETV*PQSAT (JLON, JLEV&
  &)))/(PQSAT (JLON, JLEV)*(1.0_JPRB+YDCST%RETV*PQ (JLON, JLEV)))
  
ENDDO



END SUBROUTINE ACTQSAT_OPENACC
