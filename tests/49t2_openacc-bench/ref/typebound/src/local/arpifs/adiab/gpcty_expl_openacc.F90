
SUBROUTINE GPCTY_EXPL_OPENACC (YDVFE, YDCVER, KPROMA, KST, KEND, KFLEV, LDRUBC, YDVAB&
&, YDVETA, PU, PV, PD, PEVT, PSPL, PSPM, PRPREF, PDPHYCTY, PDELP, PLNPR, PRDELP, PALPH&
&, PRTGR, PRPRE, PRPP, PEVEL, PVVEL, PPSDIV, PPSDVBC, PDIVDP, YDSTACK)
!$ACC ROUTINE (GPCTY_EXPL_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMVERT,ONLY:TVFE, TVAB, TVETA
USE YOMCVER,ONLY:TCVER
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TVFE), INTENT (IN)::YDVFE
TYPE (TCVER), INTENT (IN)::YDCVER
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
LOGICAL, INTENT (IN)::LDRUBC
TYPE (TVAB), INTENT (IN)::YDVAB
TYPE (TVETA), INTENT (IN)::YDVETA
REAL (KIND=JPRB), INTENT (IN)::PU (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PD (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PEVT (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PSPL (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PSPM (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PRPREF (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PDPHYCTY (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRPP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRTGR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PPSDIV (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVVEL (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEVEL (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDIVDP (KPROMA, 0:KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (OUT)::PPSDVBC (KPROMA, 0:KFLEV)
fxtran_acdc_temp (REAL (KIND=JPRB), ZSDIV, (KPROMA, 0:KFLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPSDIVFE, (KPROMA))
fxtran_acdc_temp (REAL (KIND=JPRB), ZVP, (KPROMA, KFLEV))
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF


#include "verdisint_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZSDIV) == 8) THEN
    fxtran_acdc_alloc8 (ZSDIV)
ELSEIF (KIND (ZSDIV) == 4) THEN
    fxtran_acdc_alloc4 (ZSDIV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPSDIVFE) == 8) THEN
    fxtran_acdc_alloc8 (ZPSDIVFE)
ELSEIF (KIND (ZPSDIVFE) == 4) THEN
    fxtran_acdc_alloc4 (ZPSDIVFE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZVP) == 8) THEN
    fxtran_acdc_alloc8 (ZVP)
ELSEIF (KIND (ZVP) == 4) THEN
    fxtran_acdc_alloc4 (ZVP)
ELSE
    STOP 1
ENDIF


JROF = KST



IF (LDRUBC.AND.YDCVER%LVERTFE)  THEN
  CALL FXTRAN_ACDC_ABORT ('GPCTY_EXPL: BAD OPTIONS')
ENDIF


DO JLEV=1, KFLEV
  ZVP (JROF, JLEV)=PU (JROF, JLEV)*PSPL (JROF)+PV (JROF, JLEV)*PSPM (JROF)
ENDDO


IF (PRESENT (PDPHYCTY)) THEN

  DO JLEV=1, KFLEV
    PDIVDP (JROF, JLEV)=PD (JROF, JLEV)*PDELP (JROF, JLEV)+YDVAB%VDELB &
    &(JLEV)*ZVP (JROF, JLEV)-PDPHYCTY (JROF, JLEV)*PDELP (JROF, JLEV)
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    PDIVDP (JROF, JLEV)=PD (JROF, JLEV)*PDELP (JROF, JLEV)+YDVAB%VDELB (JLEV)*ZVP (JROF, JLEV)
  ENDDO

ENDIF

PPSDIV (JROF, 0)=0.0_JPRB

IF (YDCVER%LVERTFE) THEN

  DO JLEV=1, KFLEV
    ZSDIV (JROF, JLEV)=PDIVDP (JROF, JLEV)*YDVETA%VFE_RDETAH (JLEV)
  ENDDO

  ZSDIV (JROF, 0)=0.0_JPRB
  ZSDIV (JROF, KFLEV+1)=0.0_JPRB
  CALL VERDISINT_OPENACC (YDVFE, YDCVER,'ITOP','11', KPROMA, KST, KEND, KFLEV&
  &, ZSDIV, PPSDIV (:, 1:KFLEV), POUTS=ZPSDIVFE, YDSTACK=YLSTACK)
ELSE

  DO JLEV=1, KFLEV
    
    PPSDIV (JROF, JLEV)=PPSDIV (JROF, JLEV-1)+PDIVDP (JROF, JLEV)
  
  ENDDO

ENDIF


IF (LDRUBC) THEN

  IF (YDCVER%LVERTFE) THEN
    
    PPSDVBC (JROF, KFLEV)=ZPSDIVFE (JROF)-PEVT (JROF)
  
  ELSE

    DO JLEV=0, KFLEV
      
      PPSDVBC (JROF, JLEV)=PPSDIV (JROF, JLEV)-PEVT (JROF)
    
    ENDDO

  ENDIF

ELSE

  IF (YDCVER%LVERTFE) THEN
    
    PPSDVBC (JROF, KFLEV)=ZPSDIVFE (JROF)
  
  ELSE

    DO JLEV=0, KFLEV
      
      PPSDVBC (JROF, JLEV)=PPSDIV (JROF, JLEV)
    
    ENDDO

  ENDIF

ENDIF


IF (YDCVER%LVERTFE) THEN

  DO JLEV=1, KFLEV
    
    PEVEL (JROF, JLEV)=YDVAB%VBF (JLEV)*ZPSDIVFE (JROF)-PPSDIV (JROF, JLEV)
  
  ENDDO

ELSE

  DO JLEV=1, KFLEV-1
    
    PEVEL (JROF, JLEV)=YDVAB%VBH (JLEV)*PPSDIV (JROF, KFLEV)-PPSDIV (JROF, JLEV)
  
  ENDDO

ENDIF

PEVEL (JROF, 0)=0.0_JPRB

IF (.NOT.YDCVER%LVERTFE)  THEN
  PEVEL (JROF, KFLEV)=0.0_JPRB
ENDIF


IF (LDRUBC) THEN

  IF (YDCVER%LVERTFE) THEN
    CALL FXTRAN_ACDC_ABORT (' GPCTY_EXPL: VFE not coded for LRUBC.')
  ELSE

    DO JLEV=0, KFLEV
      PEVEL (JROF, JLEV)=PEVEL (JROF, JLEV)+(1.0_JPRB-YDVAB%VBH (JLEV))*PEVT (JROF)
    ENDDO

  ENDIF

ENDIF


IF (YDCVER%LVERTFE) THEN

  DO JLEV=1, KFLEV
    
    PVVEL (JROF, JLEV)=(YDVAB%VBF (JLEV)*ZVP (JROF, JLEV)-PPSDIV (JROF, JLEV))*PRPREF (JROF, JLEV)
  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    PVVEL (JROF, JLEV)=PRTGR (JROF, JLEV)*ZVP (JROF, JLEV)-PRDELP (JROF, JLEV)*PALPH&
    & (JROF, JLEV)*YDVAB%VDELB (JLEV)*ZVP (JROF, JLEV)-PALPH (JROF, JLEV)*PD (JROF&
    &, JLEV)-PRDELP (JROF, JLEV)*PPSDVBC (JROF, JLEV-1)*PLNPR (JROF, JLEV)
  
  ENDDO

ENDIF


END SUBROUTINE GPCTY_EXPL_OPENACC
