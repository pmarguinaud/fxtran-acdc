SUBROUTINE SHALLOW_CONVECTION_PART2_OPENACC (CVP_SHAL, CVPEXT, CST, D, NSV, CONVPAR, KICE&
&, OSETTADJ, PTADJS, PPABST, PZZ, PTT, PRVT, PRCT, PRIT, OCH1CONV, KCH1, PCH1, PRDOCP, PTHT&
&, PSTHV, PSTHES, ISDPL, ISPBL, ISLCL, PSTHLCL, PSTLCL, PSRVLCL, PSWLCL, PSZLCL, PSTHVELCL&
&, GTRIG1, PUMF, PTHC, PRVC, PRCC, PRIC, ICTL, IMINCTL, PPCH1TEN, YDSTACK)
!$ACC ROUTINE (SHALLOW_CONVECTION_PART2_OPENACC) SEQ
USE PARKIND1,ONLY:JPRB

USE MODD_CONVPAR,ONLY:CONVPAR_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_CST,ONLY:CST_T
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_NSV,ONLY:NSV_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (NSV_T), INTENT (IN)::NSV
TYPE (CONVPAR_T), INTENT (IN)::CONVPAR
INTEGER, INTENT (IN)::KICE
LOGICAL, INTENT (IN)::OSETTADJ
REAL, INTENT (IN)::PTADJS
REAL, INTENT (IN)::PPABST(D%NIT, D%NKT)
REAL, INTENT (IN)::PZZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PTT(D%NIT, D%NKT)
REAL, INTENT (IN)::PRVT(D%NIT, D%NKT)
REAL, INTENT (IN)::PRCT(D%NIT, D%NKT)
REAL, INTENT (IN)::PRIT(D%NIT, D%NKT)
LOGICAL, INTENT (IN)::OCH1CONV
INTEGER, INTENT (IN)::KCH1
REAL, INTENT (IN)::PCH1(D%NIT, D%NKT, KCH1)
REAL, INTENT (IN)::PRDOCP
REAL, INTENT (IN)::PSTHES(D%NIT, D%NKT)
REAL, INTENT (IN)::PSTHV(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHT(D%NIT, D%NKT)
INTEGER, INTENT (IN)::ISDPL(D%NIT)
INTEGER, INTENT (IN)::ISPBL(D%NIT)
INTEGER, INTENT (IN)::ISLCL(D%NIT)
REAL, INTENT (IN)::PSTHLCL(D%NIT)
REAL, INTENT (IN)::PSTLCL(D%NIT)
REAL, INTENT (IN)::PSRVLCL(D%NIT)
REAL, INTENT (IN)::PSWLCL(D%NIT)
REAL, INTENT (IN)::PSZLCL(D%NIT)
REAL, INTENT (IN)::PSTHVELCL(D%NIT)
LOGICAL, INTENT (IN)::GTRIG1(D%NIT)
REAL, INTENT (OUT)::PUMF(D%NIT, D%NKT)
REAL, INTENT (OUT)::PTHC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRVC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRCC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRIC(D%NIT, D%NKT)
INTEGER, INTENT (OUT)::ICTL(D%NIT)
INTEGER, INTENT (OUT)::IMINCTL(D%NIT)
REAL, INTENT (OUT)::PPCH1TEN(D%NIT, D%NKT, KCH1)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL::ZWORK2B
REAL::ZWORK2
REAL::ZW1
INTEGER::JI
INTEGER::JN
INTEGER::JKP
INTEGER::JKM
INTEGER::JK
INTEGER::IKE
INTEGER::IKB
fxtran_acdc_temp (INTEGER, IETL, (D%NIT))
INTEGER::ILFS
fxtran_acdc_temp (REAL, ZDPRES, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZTHL, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZRW, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUER, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUDR, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUTHL, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUTHV, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZURW, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZURC, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZURI, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZCAPE, (D%NIT))
fxtran_acdc_temp (REAL, ZDMF, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZDER, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZDDR, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZLMASS, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZTIMEC, (D%NIT))
fxtran_acdc_temp (REAL, ZWSUB, (D%NIT, D%NKT))
fxtran_acdc_temp (LOGICAL, GTRIG2, (D%NIT))
REAL::ZCPH
REAL::ZLS
REAL::ZLV
fxtran_acdc_temp (REAL, ZWORK3, (D%NIT, KCH1))
fxtran_acdc_temp (REAL, ZCH1, (D%NIT, D%NKT, KCH1))
fxtran_acdc_temp (REAL, ZCH1C, (D%NIT, D%NKT, KCH1))
INTEGER::IFTSTEPS

#include "convect_updraft_shal_openacc.h"
#include "convect_closure_shal_openacc.h"

YLSTACK = YDSTACK



IF (KIND (IETL) == 8) THEN
    fxtran_acdc_alloc8 (IETL)
ELSEIF (KIND (IETL) == 4) THEN
    fxtran_acdc_alloc4 (IETL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDPRES) == 8) THEN
    fxtran_acdc_alloc8 (ZDPRES)
ELSEIF (KIND (ZDPRES) == 4) THEN
    fxtran_acdc_alloc4 (ZDPRES)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHL) == 8) THEN
    fxtran_acdc_alloc8 (ZTHL)
ELSEIF (KIND (ZTHL) == 4) THEN
    fxtran_acdc_alloc4 (ZTHL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRW) == 8) THEN
    fxtran_acdc_alloc8 (ZRW)
ELSEIF (KIND (ZRW) == 4) THEN
    fxtran_acdc_alloc4 (ZRW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUER) == 8) THEN
    fxtran_acdc_alloc8 (ZUER)
ELSEIF (KIND (ZUER) == 4) THEN
    fxtran_acdc_alloc4 (ZUER)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUDR) == 8) THEN
    fxtran_acdc_alloc8 (ZUDR)
ELSEIF (KIND (ZUDR) == 4) THEN
    fxtran_acdc_alloc4 (ZUDR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUTHL) == 8) THEN
    fxtran_acdc_alloc8 (ZUTHL)
ELSEIF (KIND (ZUTHL) == 4) THEN
    fxtran_acdc_alloc4 (ZUTHL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUTHV) == 8) THEN
    fxtran_acdc_alloc8 (ZUTHV)
ELSEIF (KIND (ZUTHV) == 4) THEN
    fxtran_acdc_alloc4 (ZUTHV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZURW) == 8) THEN
    fxtran_acdc_alloc8 (ZURW)
ELSEIF (KIND (ZURW) == 4) THEN
    fxtran_acdc_alloc4 (ZURW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZURC) == 8) THEN
    fxtran_acdc_alloc8 (ZURC)
ELSEIF (KIND (ZURC) == 4) THEN
    fxtran_acdc_alloc4 (ZURC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZURI) == 8) THEN
    fxtran_acdc_alloc8 (ZURI)
ELSEIF (KIND (ZURI) == 4) THEN
    fxtran_acdc_alloc4 (ZURI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCAPE) == 8) THEN
    fxtran_acdc_alloc8 (ZCAPE)
ELSEIF (KIND (ZCAPE) == 4) THEN
    fxtran_acdc_alloc4 (ZCAPE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMF) == 8) THEN
    fxtran_acdc_alloc8 (ZDMF)
ELSEIF (KIND (ZDMF) == 4) THEN
    fxtran_acdc_alloc4 (ZDMF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDER) == 8) THEN
    fxtran_acdc_alloc8 (ZDER)
ELSEIF (KIND (ZDER) == 4) THEN
    fxtran_acdc_alloc4 (ZDER)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDDR) == 8) THEN
    fxtran_acdc_alloc8 (ZDDR)
ELSEIF (KIND (ZDDR) == 4) THEN
    fxtran_acdc_alloc4 (ZDDR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLMASS) == 8) THEN
    fxtran_acdc_alloc8 (ZLMASS)
ELSEIF (KIND (ZLMASS) == 4) THEN
    fxtran_acdc_alloc4 (ZLMASS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTIMEC) == 8) THEN
    fxtran_acdc_alloc8 (ZTIMEC)
ELSEIF (KIND (ZTIMEC) == 4) THEN
    fxtran_acdc_alloc4 (ZTIMEC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWSUB) == 8) THEN
    fxtran_acdc_alloc8 (ZWSUB)
ELSEIF (KIND (ZWSUB) == 4) THEN
    fxtran_acdc_alloc4 (ZWSUB)
ELSE
    STOP 1
ENDIF


IF (KIND (GTRIG2) == 8) THEN
    fxtran_acdc_alloc8 (GTRIG2)
ELSEIF (KIND (GTRIG2) == 4) THEN
    fxtran_acdc_alloc4 (GTRIG2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK3) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK3)
ELSEIF (KIND (ZWORK3) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK3)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCH1) == 8) THEN
    fxtran_acdc_alloc8 (ZCH1)
ELSEIF (KIND (ZCH1) == 4) THEN
    fxtran_acdc_alloc4 (ZCH1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCH1C) == 8) THEN
    fxtran_acdc_alloc8 (ZCH1C)
ELSEIF (KIND (ZCH1C) == 4) THEN
    fxtran_acdc_alloc4 (ZCH1C)
ELSE
    STOP 1
ENDIF


JI = D%NIB


ZDPRES(JI,:)=0.0
ZTHL(JI,:)=0.0
ZRW(JI,:)=0.0
IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT

DO JK=IKE+1, D%NKT
  PUMF (JI, JK)=0.
  PTHC (JI, JK)=0.
  PRVC (JI, JK)=0.
  PRCC (JI, JK)=0.
  PRIC (JI, JK)=0.
  PPCH1TEN (JI, JK,:)=0.
ENDDO

ZDPRES (JI, IKB)=0.

DO JK=IKB+1, IKE
  ZDPRES (JI, JK)=PPABST (JI, JK-1)-PPABST (JI, JK)
ENDDO


DO JK=IKB, IKE, 1
  ZRW (JI, JK)=MAX (0., PRVT (JI, JK))+MAX (0., PRCT (JI, JK))+MAX (0., PRIT (JI, JK))
  ZCPH =CST%XCPD+CST%XCPV*ZRW (JI, JK)
  ZLV =CST%XLVTT+(CST%XCPV-CST%XCL)*(PTT (JI, JK)-CST%XTT)
  ZLS =CST%XLSTT+(CST%XCPV-CST%XCI)*(PTT (JI, JK)-CST%XTT)
  ZTHL (JI, JK)=ZCPH *PTT (JI, JK)+(1.+ZRW (JI, JK))*CST%XG*PZZ (JI,&
  & JK)-ZLV *MAX (0., PRCT (JI, JK))-ZLS *MAX (0., PRIT (JI, JK))
ENDDO

CALL CONVECT_UPDRAFT_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, CONVPAR, KICE, PPABST&
&, ZDPRES, PZZ, ZTHL, PSTHV, PSTHES, ZRW, PSTHLCL, PSTLCL, PSRVLCL, PSWLCL, PSZLCL&
&, PSTHVELCL, CVP_SHAL%XA25*1.E-3, GTRIG2, ISLCL, ISDPL, ISPBL, PUMF, ZUER, ZUDR,&
& ZUTHL, ZUTHV, ZURW, ZURC, ZURI, ZCAPE, ICTL, IETL, GTRIG1, YDSTACK=YLSTACK)
ZDMF (JI,:)=0.
ZDER (JI,:)=0.
ZDDR (JI,:)=0.
ILFS =IKB

DO JK=IKB, IKE
  ZLMASS (JI, JK)=CVP_SHAL%XA25*ZDPRES (JI, JK)/CST%XG
ENDDO

ZLMASS (JI, IKB)=ZLMASS (JI, IKB+1)
ZTIMEC (JI)=CVP_SHAL%XCTIME_SHAL

IF (OSETTADJ)  THEN
  ZTIMEC (JI)=PTADJS
ENDIF

CALL CONVECT_CLOSURE_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPABST, ZDPRES, PZZ, ZLMASS, ZTHL&
&, PTHT, ZRW, PRCT, PRIT, GTRIG2, PTHC, PRVC, PRCC, PRIC, ZWSUB, ISLCL, ISDPL, ISPBL, ICTL,&
& PUMF, ZUER, ZUDR, ZUTHL, ZURW, ZURC, ZURI, ZCAPE, ZTIMEC, IFTSTEPS, YDSTACK=YLSTACK)

DO JK=IKB, IKE
  
  PTHC (JI, JK)=(PTHC (JI, JK)-PTHT (JI, JK))/ZTIMEC (JI)*(PPABST (JI, JK)/CST%XP00)**PRDOCP
  PRVC (JI, JK)=(PRVC (JI, JK)-ZRW (JI, JK)+MAX (0., PRCT&
  & (JI, JK))+MAX (0., PRIT (JI, JK)))/ZTIMEC (JI)
  PRCC (JI, JK)=(PRCC (JI, JK)-MAX (0., PRCT (JI, JK)))/ZTIMEC (JI)
  PRIC (JI, JK)=(PRIC (JI, JK)-MAX (0., PRIT (JI, JK)))/ZTIMEC (JI)
  
ENDDO


IF (CVP_SHAL%LLSMOOTH) THEN
  
  JK=ICTL (JI)
  JKM=MAX (2, ICTL (JI)-1)
  JKP=MAX (2, ICTL (JI)-2)
  PRVC (JI, JKM)=PRVC (JI, JKM)+.5*PRVC (JI, JK)
  PRCC (JI, JKM)=PRCC (JI, JKM)+.5*PRCC (JI, JK)
  PRIC (JI, JKM)=PRIC (JI, JKM)+.5*PRIC (JI, JK)
  PTHC (JI, JKM)=PTHC (JI, JKM)+.5*PTHC (JI, JK)
  PRVC (JI, JKP)=PRVC (JI, JKP)+.3*PRVC (JI, JK)
  PRCC (JI, JKP)=PRCC (JI, JKP)+.3*PRCC (JI, JK)
  PRIC (JI, JKP)=PRIC (JI, JKP)+.3*PRIC (JI, JK)
  PTHC (JI, JKP)=PTHC (JI, JKP)+.3*PTHC (JI, JK)
  PRVC (JI, JK)=.2*PRVC (JI, JK)
  PRCC (JI, JK)=.2*PRCC (JI, JK)
  PRIC (JI, JK)=.2*PRIC (JI, JK)
  PTHC (JI, JK)=.2*PTHC (JI, JK)
  
ENDIF

JKM=IKE
ZWORK2 =0.
ZWORK2B =0.

DO JK=IKB+1, JKM
  JKP=JK+1

  

  IF (JK<=ICTL (JI)) THEN
    ZW1=PRVC (JI, JK)+PRCC (JI, JK)+PRIC (JI, JK)
    ZWORK2 =ZWORK2 +ZW1*.5*(PPABST (JI, JK-1)-PPABST (JI, JKP))/CST%XG
    ZW1=(CST%XCPD+CST%XCPV*ZRW (JI, JK))*PTHC (JI, JK)-(CST%XLVTT+(CST%XCPV-CST%XCL)*(PTT (JI, JK)-CST&
    &%XTT))*PRCC (JI, JK)-(CST%XLSTT+(CST%XCPV-CST%XCL)*(PTT (JI, JK)-CST%XTT))*PRIC (JI, JK)
    ZWORK2B =ZWORK2B +ZW1*.5*(PPABST (JI, JK-1)-PPABST (JI, JKP))/CST%XG
  ENDIF

  
ENDDO



IF (ICTL (JI)>IKB+1) THEN
  JKP=ICTL (JI)
  ZW1=CST%XG/(PPABST (JI, IKB)-PPABST (JI, JKP)-.5*(ZDPRES (JI, IKB+1)-ZDPRES (JI, JKP+1)))
  ZWORK2 =ZWORK2 *ZW1
  ZWORK2B =ZWORK2B *ZW1
ENDIF



DO JK=JKM, IKB+1,-1

  

  IF (ICTL (JI)>IKB+1.AND.JK<=ICTL (JI)) THEN
    PRVC (JI, JK)=PRVC (JI, JK)-ZWORK2 
    PTHC (JI, JK)=PTHC (JI, JK)-ZWORK2B /CST%XCPD
  ENDIF

  
ENDDO



DO JK=IKB, IKE

  

  IF (ICTL (JI)<=IKB+1) THEN
    PUMF (JI, JK)=0
  ELSE
    PUMF (JI, JK)=PUMF (JI, JK)/CVP_SHAL%XA25
  ENDIF

  
ENDDO


IMINCTL (JI)=MIN (ISLCL (JI), ICTL (JI))


DO JK=IKB, IKE

  

  IF (.NOT.GTRIG1 (JI)) THEN
    PTHC (JI, JK)=0.
    PRVC (JI, JK)=0.
    PRCC (JI, JK)=0.
    PRIC (JI, JK)=0.
  ENDIF

  
ENDDO



IF (.NOT.GTRIG1 (JI)) THEN
  ICTL (JI)=0.
  IMINCTL (JI)=0.
ENDIF


PUMF (JI, D%NKT)=0.
PTHC (JI, D%NKT)=0.
PRVC (JI, D%NKT)=0.
PRCC (JI, D%NKT)=0.
PRIC (JI, D%NKT)=0.
PPCH1TEN (JI, D%NKT,:)=0.

END SUBROUTINE SHALLOW_CONVECTION_PART2_OPENACC
