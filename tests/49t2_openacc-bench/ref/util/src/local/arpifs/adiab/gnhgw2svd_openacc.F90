SUBROUTINE GNHGW2SVD_OPENACC (YDGEOMETRY, YDCST, TOPPRES, KST, KEND, LDNHEE&
&, KPDVAR, KVDVAR, PSP, PRT, PSPD, PSVD, PNHX, PLNPR, PDEP, PREF, PGWH&
&, PGWF, PGWS, PGWRF, PGWRS, PGDWR, PGWDAMP, PTAUD_NL, YDSTACK)
!$ACC ROUTINE (GNHGW2SVD_OPENACC) SEQ
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TCST), INTENT (IN)::YDCST
REAL (KIND=JPRB), INTENT (IN)::TOPPRES
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
LOGICAL, INTENT (IN)::LDNHEE
INTEGER (KIND=JPIM), INTENT (IN)::KPDVAR
INTEGER (KIND=JPIM), INTENT (IN)::KVDVAR
REAL (KIND=JPRB), INTENT (IN)::PSP (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::PRT (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PSPD (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PSVD (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PNHX (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PLNPR (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PDEP (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PREF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGWH (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGWF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGWS (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGWRF (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGWRS (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGDWR (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGWDAMP (0:YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PTAUD_NL
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
LOGICAL::LLINC
fxtran_acdc_temp (REAL (KIND=JPRB), ZDELP, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZLNPR, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRDELP, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZALPH, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRTGR, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRPRE, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRPP, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPREF, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPDEP, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPREH, (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGWH, (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGWF, (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGDW, (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG))
fxtran_acdc_temp (REAL (KIND=JPRB), ZOUT, (YDGEOMETRY%YRDIM%NPROMA, 0:YDGEOMETRY%YRDIMV%NFLEVG))
REAL (KIND=JPRB)::ZKAP_B
REAL (KIND=JPRB)::ZTAUD

#include "gnhpre_openacc.intfb.h"
#include "gphpre_expl_openacc.intfb.h"
#include "verdisint_openacc.intfb.h"


YLSTACK = YDSTACK



IF (KIND (ZDELP) == 8) THEN
    fxtran_acdc_alloc8 (ZDELP)
ELSEIF (KIND (ZDELP) == 4) THEN
    fxtran_acdc_alloc4 (ZDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLNPR) == 8) THEN
    fxtran_acdc_alloc8 (ZLNPR)
ELSEIF (KIND (ZLNPR) == 4) THEN
    fxtran_acdc_alloc4 (ZLNPR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRDELP) == 8) THEN
    fxtran_acdc_alloc8 (ZRDELP)
ELSEIF (KIND (ZRDELP) == 4) THEN
    fxtran_acdc_alloc4 (ZRDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZALPH) == 8) THEN
    fxtran_acdc_alloc8 (ZALPH)
ELSEIF (KIND (ZALPH) == 4) THEN
    fxtran_acdc_alloc4 (ZALPH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRTGR) == 8) THEN
    fxtran_acdc_alloc8 (ZRTGR)
ELSEIF (KIND (ZRTGR) == 4) THEN
    fxtran_acdc_alloc4 (ZRTGR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRPRE) == 8) THEN
    fxtran_acdc_alloc8 (ZRPRE)
ELSEIF (KIND (ZRPRE) == 4) THEN
    fxtran_acdc_alloc4 (ZRPRE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRPP) == 8) THEN
    fxtran_acdc_alloc8 (ZRPP)
ELSEIF (KIND (ZRPP) == 4) THEN
    fxtran_acdc_alloc4 (ZRPP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPREF) == 8) THEN
    fxtran_acdc_alloc8 (ZPREF)
ELSEIF (KIND (ZPREF) == 4) THEN
    fxtran_acdc_alloc4 (ZPREF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPDEP) == 8) THEN
    fxtran_acdc_alloc8 (ZPDEP)
ELSEIF (KIND (ZPDEP) == 4) THEN
    fxtran_acdc_alloc4 (ZPDEP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPREH) == 8) THEN
    fxtran_acdc_alloc8 (ZPREH)
ELSEIF (KIND (ZPREH) == 4) THEN
    fxtran_acdc_alloc4 (ZPREH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGWH) == 8) THEN
    fxtran_acdc_alloc8 (ZGWH)
ELSEIF (KIND (ZGWH) == 4) THEN
    fxtran_acdc_alloc4 (ZGWH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGWF) == 8) THEN
    fxtran_acdc_alloc8 (ZGWF)
ELSEIF (KIND (ZGWF) == 4) THEN
    fxtran_acdc_alloc4 (ZGWF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGDW) == 8) THEN
    fxtran_acdc_alloc8 (ZGDW)
ELSEIF (KIND (ZGDW) == 4) THEN
    fxtran_acdc_alloc4 (ZGDW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZOUT) == 8) THEN
    fxtran_acdc_alloc8 (ZOUT)
ELSEIF (KIND (ZOUT) == 4) THEN
    fxtran_acdc_alloc4 (ZOUT)
ELSE
    STOP 1
ENDIF


JROF = KST







IF (PRESENT (PTAUD_NL)) THEN
  ZTAUD=PTAUD_NL
ELSE
  ZTAUD=1.0_JPRB
ENDIF

ZKAP_B=1.0_JPRB

IF (PRESENT (PLNPR).AND.PRESENT (PDEP).AND.PRESENT (PREF)) THEN
  ZLNPR (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)=PLNPR (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  ZPREF (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)=PREF (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)

  IF (LDNHEE) THEN
    ZPDEP (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)=PDEP (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)
  ELSE
    ZPDEP (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)=0.0_JPRB
  ENDIF

ELSE
  
  ZPREH (JROF, YDGEOMETRY%YRDIMV%NFLEVG)=EXP (PSP (JROF))
  
  CALL GPHPRE_EXPL_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRCVER, TOPPRES, YDCST, YDGEOMETRY%YRDIM%NPROMA,&
  & YDGEOMETRY%YRDIMV%NFLEVG, KST, KEND, YDGEOMETRY%YRVERT_GEOM%YRVAB, ZPREH, ZPREF, PDELP=ZDELP, PLNPR&
  &=ZLNPR, PRDELP=ZRDELP, PALPH=ZALPH, PRTGR=ZRTGR, PRPRE=ZRPRE, PRPP=ZRPP, YDSTACK=YLSTACK)

  IF (LDNHEE) THEN
    CALL GNHPRE_OPENACC (YDGEOMETRY, KPDVAR, YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV&
    &%NFLEVG, KST, KEND, PSPD, ZPREF, PKAP=ZKAP_B, PDEP=ZPDEP, YDSTACK=YLSTACK)
  ELSE
    ZPDEP (JROF, 1:YDGEOMETRY%YRDIMV%NFLEVG)=0.0_JPRB
  ENDIF

ENDIF


IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE.AND.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_GW) THEN

  IF (.NOT.PRESENT (PGWF))  THEN
    CALL FXTRAN_ACDC_ABORT ('GNHGW2SVD: missing input PGWF')
  ENDIF


  IF (PRESENT (PGWRF).AND.PRESENT (PGDWR)) THEN
    LLINC=.TRUE.
  ELSE
    LLINC=.FALSE.
  ENDIF


  IF (LLINC) THEN

    IF (.NOT.PRESENT (PGWRS))  THEN
      CALL FXTRAN_ACDC_ABORT ('GNHGW2SVD: missing input PGWRS')
    ENDIF


    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZGWH (JROF, JLEV)=-((PGWF (JROF, JLEV)-PGWRF (JROF, JLEV))-(PGWS (JROF)-PGWRS (JROF)))
    
    ENDDO

    ZGWH (JROF, 0)=ZGWH (JROF, 1)
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'DEGW','10'&
    &, YDGEOMETRY%YRDIM%NPROMA, KST, KEND, YDGEOMETRY%YRDIMV%NFLEVG, ZGWH, ZOUT, YDSTACK=YLSTACK)

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      ZGDW (JROF, JLEV)=ZOUT (JROF, JLEV)
    ENDDO


    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZGDW (JROF, JLEV)=ZGDW (JROF, JLEV)/YDGEOMETRY%YRVERT_GEOM&
      &%YRVETA%VFE_RDETAH (JLEV)-PGDWR (JROF, JLEV)
    
    ENDDO

  ELSE

    IF (.NOT.PRESENT (PGWS))  THEN
      CALL FXTRAN_ACDC_ABORT ('GNHGW2SVD: missing input PGWS')
    ENDIF


    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZGWF (JROF, JLEV)=-(PGWF (JROF, JLEV)-PGWS (JROF))
    
    ENDDO

    ZGWF (JROF, 0)=0.0_JPRB
    ZGWF (JROF, YDGEOMETRY%YRDIMV%NFLEVG+1)=0.0_JPRB
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'FDER','10'&
    &, YDGEOMETRY%YRDIM%NPROMA, KST, KEND, YDGEOMETRY%YRDIMV%NFLEVG, ZGWF, ZGDW, YDSTACK=YLSTACK)

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZGDW (JROF, JLEV)=ZGDW (JROF, JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
    
    ENDDO

  ENDIF

ELSE

  IF (.NOT.PRESENT (PGWH))  THEN
    CALL FXTRAN_ACDC_ABORT ('GNHGW2SVD: missing input PGWH')
  ENDIF

  ZGWH (JROF, 0:YDGEOMETRY%YRDIMV%NFLEVG)=PGWH (JROF, 0:YDGEOMETRY%YRDIMV%NFLEVG)

  IF (PRESENT (PGWDAMP)) THEN

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZGDW (JROF, JLEV)=PGWDAMP (JLEV-1)*ZGWH (JROF, JLEV-1)-PGWDAMP (JLEV)*ZGWH (JROF, JLEV)
    
    ENDDO

  ELSE

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
      
      ZGDW (JROF, JLEV)=ZGWH (JROF, JLEV-1)-ZGWH (JROF, JLEV)
    
    ENDDO

  ENDIF

ENDIF


IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    PSVD (JROF, JLEV)=YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV)*(ZGDW (JROF, JLEV)/(PRT (JROF&
    &, JLEV)*ZLNPR (JROF, JLEV)))*(ZTAUD*(ZPDEP (JROF, JLEV)/ZPREF (JROF, JLEV))+1.0_JPRB)
  
  ENDDO

ELSE

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    PSVD (JROF, JLEV)=(ZGDW (JROF, JLEV)/(PRT (JROF, JLEV)*ZLNPR (JROF, JLEV&
    &)))*(ZTAUD*(ZPDEP (JROF, JLEV)/ZPREF (JROF, JLEV))+1.0_JPRB)
  
  ENDDO

ENDIF


IF (KVDVAR==4.OR.KVDVAR==5) THEN

  IF (.NOT.PRESENT (PNHX))  THEN
    CALL FXTRAN_ACDC_ABORT ('GNHGW2SVD: missing input PNHX')
  ENDIF


  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    PSVD (JROF, JLEV)=PSVD (JROF, JLEV)+PNHX (JROF, JLEV)
  
  ENDDO

ENDIF




END SUBROUTINE GNHGW2SVD_OPENACC
