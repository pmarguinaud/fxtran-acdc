
SUBROUTINE ACRANEB_TRANSS_OPENACC (YDCST, YDPHY, YDPHY3, KIDIA, KFDIA, KLON, KTDIA, KLEV, KJN, KIIDIA&
&, KIFDIA, KAUCR, PAPRS, PAPRSF, PDELP, PR, PT, PQ, PQCO2, PQO3, PDM0I, PDEOSI, PUEOSI, YDSTACK)
!$ACC ROUTINE (ACRANEB_TRANSS_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMPHY,ONLY:TPHY
USE YOMPHY3,ONLY:TPHY3
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY3), INTENT (IN)::YDPHY3
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KJN
INTEGER (KIND=JPIM), INTENT (IN)::KIIDIA 
INTEGER (KIND=JPIM), INTENT (IN)::KIFDIA 
INTEGER (KIND=JPIM), INTENT (IN)::KAUCR
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQCO2 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQO3 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDM0I (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDEOSI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUEOSI (KLON, 0:KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZTRLI
REAL (KIND=JPRB)::ZEPSU
REAL (KIND=JPRB)::ZEPSP
REAL (KIND=JPRB)::ZEPSD
REAL (KIND=JPRB)::ZARGLI
REAL (KIND=JPRB)::ZB
REAL (KIND=JPRB)::ZA
REAL (KIND=JPRB)::ZVOISIM
REAL (KIND=JPRB)::ZMD
REAL (KIND=JPRB)::ZIZV0
REAL (KIND=JPRB)::ZIBV0
REAL (KIND=JPRB)::ZGAMV
REAL (KIND=JPRB)::ZEPSV
REAL (KIND=JPRB)::ZS_RHOZ0V (3)
REAL (KIND=JPRB)::ZDELP 
REAL (KIND=JPRB)::ZEOSO 
REAL (KIND=JPRB)::ZNSOR 
REAL (KIND=JPRB)::ZP 
REAL (KIND=JPRB)::ZDU (4)
REAL (KIND=JPRB)::ZS_U (3)
REAL (KIND=JPRB)::ZS_PU (3)
REAL (KIND=JPRB)::ZS_TU (3)
REAL (KIND=JPRB)::ZS_UW (3)
REAL (KIND=JPRB)::ZS_US (3)
REAL (KIND=JPRB)::ZS_US_IRHOV (3)
REAL (KIND=JPRB)::ZS_UC 
fxtran_acdc_temp (REAL (KIND=JPRB), ZQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZIRHOV, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOSA, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOSA, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZS_FW, (KLON, 0:KLEV, 3))
fxtran_acdc_temp (REAL (KIND=JPRB), ZS_FS, (KLON, 0:KLEV, 3))
fxtran_acdc_temp (REAL (KIND=JPRB), ZS_FC, (KLON, 0:KLEV))
INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JG
LOGICAL::LL_OZONE
LOGICAL::LL_DESC

INTEGER (KIND=JPIM)::JO
REAL (KIND=JPRB)::ZVOIGT
REAL (KIND=JPRB)::ZVOIEMP
REAL (KIND=JPRB)::ZAFVOI
REAL (KIND=JPRB)::ZA2B
REAL (KIND=JPRB)::Z4BU
REAL (KIND=JPRB)::ZT_AVG
REAL (KIND=JPRB)::ZP_AVG
REAL (KIND=JPRB)::ZLOG
REAL (KIND=JPRB)::ZAUX
REAL (KIND=JPRB)::ZMD_W 
REAL (KIND=JPRB)::ZMD_S 
REAL (KIND=JPRB)::ZDELTA (3)
REAL (KIND=JPRB)::ZAS (3)
REAL (KIND=JPRB)::ZAR (3)
REAL (KIND=JPRB)::ZCOEF (3)
REAL (KIND=JPRB)::ZTAU (3)

YLSTACK = YDSTACK



IF (KIND (ZQ) == 8) THEN
    fxtran_acdc_alloc8 (ZQ)
ELSEIF (KIND (ZQ) == 4) THEN
    fxtran_acdc_alloc4 (ZQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZIRHOV) == 8) THEN
    fxtran_acdc_alloc8 (ZIRHOV)
ELSEIF (KIND (ZIRHOV) == 4) THEN
    fxtran_acdc_alloc4 (ZIRHOV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOSA) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOSA)
ELSEIF (KIND (ZDEOSA) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOSA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOSA) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOSA)
ELSEIF (KIND (ZUEOSA) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOSA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZS_FW) == 8) THEN
    fxtran_acdc_alloc8 (ZS_FW)
ELSEIF (KIND (ZS_FW) == 4) THEN
    fxtran_acdc_alloc4 (ZS_FW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZS_FS) == 8) THEN
    fxtran_acdc_alloc8 (ZS_FS)
ELSEIF (KIND (ZS_FS) == 4) THEN
    fxtran_acdc_alloc4 (ZS_FS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZS_FC) == 8) THEN
    fxtran_acdc_alloc8 (ZS_FC)
ELSEIF (KIND (ZS_FC) == 4) THEN
    fxtran_acdc_alloc4 (ZS_FC)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZARGLI=-250._JPRB
ZTRLI=EXP (ZARGLI)
ZEPSP=1.E-03_JPRB
ZEPSD=1.E-20_JPRB
ZEPSU=ZTRLI
ZS_RHOZ0V (1)=0.296_JPRB
ZS_RHOZ0V (2)=0.046_JPRB
ZS_RHOZ0V (3)=0.202_JPRB
ZGAMV=0.36_JPRB
ZEPSV=0.014_JPRB
ZIBV0=1._JPRB/0.74_JPRB
ZIZV0=1._JPRB/0.0027_JPRB
ZVOISIM=1.21_JPRB
ZMD=0.5_JPRB*EXP (0.5_JPRB)
LL_OZONE=.TRUE.

DO JLEV=KTDIA, KLEV
  
  ZQ (JLON, JLEV)=MAX (0._JPRB, MIN (1._JPRB, PQ (JLON, JLEV)))
  
ENDDO


ZDELP =MAX (ZEPSP, PAPRS (JLON, KTDIA-1))
ZP =0.5_JPRB*ZDELP 


ZNSOR =2._JPRB*MAX (ZEPSP, PAPRS (JLON, 0))*PQO3 (JLON, 0)


DO JLEV=1, KTDIA-1
  
  ZNSOR =ZNSOR +2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)
  
ENDDO


ZIRHOV (JLON, KTDIA-1)=(PR (JLON, KTDIA)*PT (JLON, KTDIA))/ZP 


DO JLEV=KTDIA, KLEV
  
  ZIRHOV (JLON, JLEV)=(PR (JLON, JLEV)*PT (JLON, JLEV))/PAPRSF (JLON, JLEV)
  
ENDDO


DO JG=1, 3
  
  ZA=YDPHY3%FGTS_A(JG, 0)*(1._JPRB+YDPHY3%FGTS_A(JG, 1)*PT (JLON&
  &, KTDIA))/(1._JPRB+YDPHY3%FGTS_A(JG, 2)*PT (JLON, KTDIA))
  ZB=YDPHY3%FGTS_B(JG, 0)*(1._JPRB+YDPHY3%FGTS_B(JG, 1)*PT (JLON&
  &, KTDIA))/(1._JPRB+YDPHY3%FGTS_B(JG, 2)*PT (JLON, KTDIA))
  ZS_FW (JLON, KTDIA-1, JG)=ZA
  ZS_FS (JLON, KTDIA-1, JG)=(ZA*ZA/MAX (ZB, ZEPSU))*ZP 

  

  DO JLEV=KTDIA, KLEV
    
    ZA=YDPHY3%FGTS_A(JG, 0)*(1._JPRB+YDPHY3%FGTS_A(JG, 1)*PT (JLON&
    &, JLEV))/(1._JPRB+YDPHY3%FGTS_A(JG, 2)*PT (JLON, JLEV))
    ZB=YDPHY3%FGTS_B(JG, 0)*(1._JPRB+YDPHY3%FGTS_B(JG, 1)*PT (JLON&
    &, JLEV))/(1._JPRB+YDPHY3%FGTS_B(JG, 2)*PT (JLON, JLEV))
    ZS_FW (JLON, JLEV, JG)=ZA
    ZS_FS (JLON, JLEV, JG)=(ZA*ZA/MAX (ZB, ZEPSU))*PAPRSF (JLON, JLEV)
  
  ENDDO

ENDDO


IF (YDPHY3%FGTS_C(1)==0._JPRB) THEN
  ZS_FC (JLON,:)=0._JPRB
ELSE
  
  ZS_FC (JLON, KTDIA-1)=YDPHY3%FGTS_C(1)*EXP (-YDPHY3%FGTS_C(2)*PT (JLON, KTDIA))*ZP 

  

  DO JLEV=KTDIA, KLEV
    
    ZS_FC (JLON, JLEV)=YDPHY3%FGTS_C(1)*EXP (-YDPHY3%FGTS_C(2)*PT (JLON, JLEV))*PAPRSF (JLON, JLEV)
  
  ENDDO

ENDIF

LL_DESC=.TRUE.

ZDU (1)=2._JPRB*ZDELP *ZQ (JLON, KTDIA)
ZDU (2)=2._JPRB*ZDELP *PQCO2 (JLON, KTDIA)*(1._JPRB-ZQ (JLON, KTDIA))
ZDU (3)=ZNSOR *(1._JPRB-ZQ (JLON, KTDIA))
ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, KTDIA)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, KTDIA))

ZS_UW (:)=ZEPSU
ZS_US (:)=ZEPSU
ZS_US_IRHOV (:)=ZEPSU
ZS_UC =ZEPSU
ZS_U (:)=ZEPSU
ZS_PU (:)=ZEPSU
ZS_TU (:)=ZEPSU




IF (LL_DESC) THEN
  
  ZMD_W =PDM0I (JLON)
  ZMD_S =PDM0I (JLON)
  
ELSE
  
  ZMD_W =1._JPRB
  ZMD_S =ZMD
  
ENDIF


DO JG=1, 3

  IF (LL_OZONE.AND.JG==3)  THEN
    CYCLE
  ENDIF

  
  ZS_UW (JG)=ZS_UW (JG)+ZS_FW (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD_W 
  ZS_US (JG)=ZS_US (JG)+ZS_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD_S 
  ZS_US_IRHOV (JG)=ZS_US_IRHOV (JG)+ZIRHOV (JLON, (KTDIA&
  &-1))*ZS_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD_S 
  ZA2B=ZS_US (JG)/(2._JPRB*ZS_UW (JG))
  Z4BU=4._JPRB*ZS_UW (JG)*ZS_UW (JG)/ZS_US (JG)
  ZAFVOI=1._JPRB

  IF (YDPHY%LVOIGT) THEN
    ZVOIGT=ZS_RHOZ0V (JG)*ZS_US_IRHOV (JG)/ZS_US (JG)

    IF (YDPHY%LVFULL) THEN
      ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
    ELSE
      ZVOIEMP=ZVOISIM
    ENDIF

    ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
    &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
  ENDIF

  ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
ENDDO


IF (LL_OZONE) THEN
  JG=3
  
  ZS_UW (JG)=ZS_UW (JG)+ZS_FW (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD_W 
  ZS_US (JG)=ZS_US (JG)+ZS_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD_S 
  ZS_US_IRHOV (JG)=ZS_US_IRHOV (JG)+ZIRHOV (JLON, (KTDIA&
  &-1))*ZS_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD_S 
  ZA2B=ZS_US (JG)/(2._JPRB*ZS_UW (JG))
  Z4BU=4._JPRB*ZS_UW (JG)*ZS_UW (JG)/ZS_US (JG)
  ZAFVOI=1._JPRB

  IF (YDPHY%LVOIGT) THEN
    ZVOIGT=ZS_RHOZ0V (JG)*ZS_US_IRHOV (JG)/ZS_US (JG)

    IF (YDPHY%LVFULL) THEN
      ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
    ELSE
      ZVOIEMP=ZVOISIM
    ENDIF

    ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
    &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
  ENDIF

  ZDELTA (JG)=ZAFVOI*ZS_UW (JG)
  
ENDIF


IF (YDPHY3%FGTS_C(1)/=0._JPRB) THEN
  
  ZS_UC =ZS_UC +ZS_FC (JLON, (KTDIA-1))*ZDU (4)*ZMD_S 
  ZDELTA (1)=ZDELTA (1)+ZS_UC /(1._JPRB+YDPHY3%FGTS_C(3)&
  &*ZS_UC )+YDPHY3%FGTS_C(4)*ZS_UC **YDPHY3%FGTS_C(5)
  
ENDIF


DO JG=1, 3
  
  ZDELTA (JG)=(YDPHY3%FGTS_DELTA0(JG)/YDPHY3%FGTS_ALPHA(JG))*((1._JPRB+ZDELTA&
  & (JG)/YDPHY3%FGTS_DELTA0(JG))**YDPHY3%FGTS_ALPHA(JG)-1._JPRB)
  ZS_U (JG)=ZS_U (JG)+ZDU (JG)*ZMD_S 
  ZS_PU (JG)=ZS_PU (JG)+ZP *ZDU (JG)*ZMD_S 
  ZS_TU (JG)=ZS_TU (JG)+PT (JLON, KTDIA)*ZDU (JG)*ZMD_S 
  ZP_AVG=ZS_PU (JG)/ZS_U (JG)
  ZT_AVG=ZS_TU (JG)/ZS_U (JG)
  ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTS_D(JG))
  ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTS_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTS_P00(JG, 1)+ZT_AVG*YDPHY3&
  &%FGTS_P00(JG, 2))+ZAUX*(YDPHY3%FGTS_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTS_P&
  &(JG, 0, 2))+ZLOG*(YDPHY3%FGTS_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 1&
  &, 2))+ZLOG*(YDPHY3%FGTS_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 2, 2))+ZLOG&
  &*(YDPHY3%FGTS_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 3, 2))+ZLOG*(YDPHY3&
  &%FGTS_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTS_P&
  &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 5, 2)))))))))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTS_Q(JG, 0)+ZP_AVG*(YDPHY3&
  &%FGTS_Q(JG, 1)+ZP_AVG*YDPHY3%FGTS_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
ENDDO


IF (ANY (YDPHY3%FGTS_OA/=0._JPRB)) THEN
  
  ZAS (1)=1._JPRB-EXP (-ZDELTA (1))
  ZAS (2)=1._JPRB-EXP (-ZDELTA (2))
  ZAS (3)=1._JPRB-EXP (-ZDELTA (3))
  
  
  ZAR (1)=ZAS (1)+ZAS (2)-ZAS (1)*ZAS (2)
  ZAR (2)=ZAS (1)+ZAS (3)-ZAS (1)*ZAS (3)
  ZAR (3)=ZAS (2)+ZAS (3)-ZAS (2)*ZAS (3)
  ZCOEF (1)=2._JPRB*ZAS (1)*ZAS (2)/(ZEPSD+ZAS (1)*ZAS (1)+ZAS (2)*ZAS (2))
  ZCOEF (2)=2._JPRB*ZAS (1)*ZAS (3)/(ZEPSD+ZAS (1)*ZAS (1)+ZAS (3)*ZAS (3))
  ZCOEF (3)=2._JPRB*ZAS (2)*ZAS (3)/(ZEPSD+ZAS (2)*ZAS (2)+ZAS (3)*ZAS (3))

  

  DO JO=1, 3
    
    ZTAU (JO)=1._JPRB-ZAR (JO)-ZCOEF (JO)*YDPHY3%FGTS_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3&
    &%FGTS_OB(JO)*ZAR (JO)**YDPHY3%FGTS_OC(JO)*(1._JPRB-YDPHY3%FGTS_OD(JO)*ZAR (JO))
  
  ENDDO

  
  ZDEOSA (JLON, KTDIA-1)=-LOG (MAX (ZTRLI, ZTAU (1)*ZTAU&
  & (2)*ZTAU (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
  
  
  ZDEOSA (JLON, KTDIA-1)=MAX (ZDEOSA (JLON, KTDIA-1), ZDELTA (1), ZDELTA (2), ZDELTA (3))
  
ELSE
  
  ZDEOSA (JLON, KTDIA-1)=ZDELTA (1)+ZDELTA (2)+ZDELTA (3)
  
ENDIF





PDEOSI (JLON, KTDIA-1)=ZDEOSA (JLON, KTDIA-1)/PDM0I (JLON)


DO JLEV=KTDIA, KLEV
  
  ZEOSO =ZDEOSA (JLON, JLEV-1)
  
  
  ZDU (1)=2._JPRB*PDELP (JLON, JLEV)*ZQ (JLON, JLEV)
  ZDU (2)=2._JPRB*PDELP (JLON, JLEV)*PQCO2 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (3)=2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV))

  

  

  

  IF (LL_DESC) THEN
    
    ZMD_W =PDM0I (JLON)
    ZMD_S =PDM0I (JLON)
  
  ELSE
    
    ZMD_W =1._JPRB
    ZMD_S =ZMD
  
  ENDIF


  DO JG=1, 3

    IF (LL_OZONE.AND.JG==3)  THEN
      CYCLE
    ENDIF

    
    ZS_UW (JG)=ZS_UW (JG)+ZS_FW (JLON, JLEV, JG)*ZDU (JG)*ZMD_W 
    ZS_US (JG)=ZS_US (JG)+ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZS_US_IRHOV (JG)=ZS_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZA2B=ZS_US (JG)/(2._JPRB*ZS_UW (JG))
    Z4BU=4._JPRB*ZS_UW (JG)*ZS_UW (JG)/ZS_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZS_RHOZ0V (JG)*ZS_US_IRHOV (JG)/ZS_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
  ENDDO


  IF (LL_OZONE) THEN
    JG=3
    
    ZS_UW (JG)=ZS_UW (JG)+ZS_FW (JLON, JLEV, JG)*ZDU (JG)*ZMD_W 
    ZS_US (JG)=ZS_US (JG)+ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZS_US_IRHOV (JG)=ZS_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZA2B=ZS_US (JG)/(2._JPRB*ZS_UW (JG))
    Z4BU=4._JPRB*ZS_UW (JG)*ZS_UW (JG)/ZS_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZS_RHOZ0V (JG)*ZS_US_IRHOV (JG)/ZS_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZAFVOI*ZS_UW (JG)
  
  ENDIF


  IF (YDPHY3%FGTS_C(1)/=0._JPRB) THEN
    
    ZS_UC =ZS_UC +ZS_FC (JLON, JLEV)*ZDU (4)*ZMD_S 
    ZDELTA (1)=ZDELTA (1)+ZS_UC /(1._JPRB+YDPHY3%FGTS_C(3)&
    &*ZS_UC )+YDPHY3%FGTS_C(4)*ZS_UC **YDPHY3%FGTS_C(5)
  
  ENDIF


  DO JG=1, 3
    
    ZDELTA (JG)=(YDPHY3%FGTS_DELTA0(JG)/YDPHY3%FGTS_ALPHA(JG))*((1._JPRB+ZDELTA&
    & (JG)/YDPHY3%FGTS_DELTA0(JG))**YDPHY3%FGTS_ALPHA(JG)-1._JPRB)
    ZS_U (JG)=ZS_U (JG)+ZDU (JG)*ZMD_S 
    ZS_PU (JG)=ZS_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)*ZMD_S 
    ZS_TU (JG)=ZS_TU (JG)+PT (JLON, JLEV)*ZDU (JG)*ZMD_S 
    ZP_AVG=ZS_PU (JG)/ZS_U (JG)
    ZT_AVG=ZS_TU (JG)/ZS_U (JG)
    ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTS_D(JG))
    ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTS_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTS_P00(JG, 1)+ZT_AVG*YDPHY3&
    &%FGTS_P00(JG, 2))+ZAUX*(YDPHY3%FGTS_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTS_P&
    &(JG, 0, 2))+ZLOG*(YDPHY3%FGTS_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 1&
    &, 2))+ZLOG*(YDPHY3%FGTS_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 2, 2))+ZLOG&
    &*(YDPHY3%FGTS_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 3, 2))+ZLOG*(YDPHY3&
    &%FGTS_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTS_P&
    &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 5, 2)))))))))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTS_Q(JG, 0)+ZP_AVG*(YDPHY3&
    &%FGTS_Q(JG, 1)+ZP_AVG*YDPHY3%FGTS_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
  ENDDO


  IF (ANY (YDPHY3%FGTS_OA/=0._JPRB)) THEN
    
    ZAS (1)=1._JPRB-EXP (-ZDELTA (1))
    ZAS (2)=1._JPRB-EXP (-ZDELTA (2))
    ZAS (3)=1._JPRB-EXP (-ZDELTA (3))
    
    
    ZAR (1)=ZAS (1)+ZAS (2)-ZAS (1)*ZAS (2)
    ZAR (2)=ZAS (1)+ZAS (3)-ZAS (1)*ZAS (3)
    ZAR (3)=ZAS (2)+ZAS (3)-ZAS (2)*ZAS (3)
    ZCOEF (1)=2._JPRB*ZAS (1)*ZAS (2)/(ZEPSD+ZAS (1)*ZAS (1)+ZAS (2)*ZAS (2))
    ZCOEF (2)=2._JPRB*ZAS (1)*ZAS (3)/(ZEPSD+ZAS (1)*ZAS (1)+ZAS (3)*ZAS (3))
    ZCOEF (3)=2._JPRB*ZAS (2)*ZAS (3)/(ZEPSD+ZAS (2)*ZAS (2)+ZAS (3)*ZAS (3))

    

    DO JO=1, 3
      
      ZTAU (JO)=1._JPRB-ZAR (JO)-ZCOEF (JO)*YDPHY3%FGTS_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3&
      &%FGTS_OB(JO)*ZAR (JO)**YDPHY3%FGTS_OC(JO)*(1._JPRB-YDPHY3%FGTS_OD(JO)*ZAR (JO))
    
    ENDDO

    
    ZDEOSA (JLON, JLEV)=-LOG (MAX (ZTRLI, ZTAU (1)*ZTAU &
    &(2)*ZTAU (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
    
    
    ZDEOSA (JLON, JLEV)=MAX (ZDEOSA (JLON, JLEV), ZDELTA (1), ZDELTA (2), ZDELTA (3))
  
  ELSE
    
    ZDEOSA (JLON, JLEV)=ZDELTA (1)+ZDELTA (2)+ZDELTA (3)
  
  ENDIF

  
  
  
  
  PDEOSI (JLON, JLEV)=MAX ((ZDEOSA (JLON, JLEV)-ZEOSO )/PDM0I (JLON), 0._JPRB)
  
ENDDO


ZEOSO =ZDEOSA (JLON, KLEV)

LL_DESC=.FALSE.

DO JLEV=KLEV, KTDIA,-1
  
  ZDU (1)=2._JPRB*PDELP (JLON, JLEV)*ZQ (JLON, JLEV)
  ZDU (2)=2._JPRB*PDELP (JLON, JLEV)*PQCO2 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (3)=2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV))

  

  

  

  IF (LL_DESC) THEN
    
    ZMD_W =PDM0I (JLON)
    ZMD_S =PDM0I (JLON)
  
  ELSE
    
    ZMD_W =1._JPRB
    ZMD_S =ZMD
  
  ENDIF


  DO JG=1, 3

    IF (LL_OZONE.AND.JG==3)  THEN
      CYCLE
    ENDIF

    
    ZS_UW (JG)=ZS_UW (JG)+ZS_FW (JLON, JLEV, JG)*ZDU (JG)*ZMD_W 
    ZS_US (JG)=ZS_US (JG)+ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZS_US_IRHOV (JG)=ZS_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZA2B=ZS_US (JG)/(2._JPRB*ZS_UW (JG))
    Z4BU=4._JPRB*ZS_UW (JG)*ZS_UW (JG)/ZS_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZS_RHOZ0V (JG)*ZS_US_IRHOV (JG)/ZS_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
  ENDDO


  IF (LL_OZONE) THEN
    JG=3
    
    ZS_UW (JG)=ZS_UW (JG)+ZS_FW (JLON, JLEV, JG)*ZDU (JG)*ZMD_W 
    ZS_US (JG)=ZS_US (JG)+ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZS_US_IRHOV (JG)=ZS_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZS_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD_S 
    ZA2B=ZS_US (JG)/(2._JPRB*ZS_UW (JG))
    Z4BU=4._JPRB*ZS_UW (JG)*ZS_UW (JG)/ZS_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZS_RHOZ0V (JG)*ZS_US_IRHOV (JG)/ZS_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZAFVOI*ZS_UW (JG)
  
  ENDIF


  IF (YDPHY3%FGTS_C(1)/=0._JPRB) THEN
    
    ZS_UC =ZS_UC +ZS_FC (JLON, JLEV)*ZDU (4)*ZMD_S 
    ZDELTA (1)=ZDELTA (1)+ZS_UC /(1._JPRB+YDPHY3%FGTS_C(3)&
    &*ZS_UC )+YDPHY3%FGTS_C(4)*ZS_UC **YDPHY3%FGTS_C(5)
  
  ENDIF


  DO JG=1, 3
    
    ZDELTA (JG)=(YDPHY3%FGTS_DELTA0(JG)/YDPHY3%FGTS_ALPHA(JG))*((1._JPRB+ZDELTA&
    & (JG)/YDPHY3%FGTS_DELTA0(JG))**YDPHY3%FGTS_ALPHA(JG)-1._JPRB)
    ZS_U (JG)=ZS_U (JG)+ZDU (JG)*ZMD_S 
    ZS_PU (JG)=ZS_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)*ZMD_S 
    ZS_TU (JG)=ZS_TU (JG)+PT (JLON, JLEV)*ZDU (JG)*ZMD_S 
    ZP_AVG=ZS_PU (JG)/ZS_U (JG)
    ZT_AVG=ZS_TU (JG)/ZS_U (JG)
    ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTS_D(JG))
    ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTS_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTS_P00(JG, 1)+ZT_AVG*YDPHY3&
    &%FGTS_P00(JG, 2))+ZAUX*(YDPHY3%FGTS_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTS_P&
    &(JG, 0, 2))+ZLOG*(YDPHY3%FGTS_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 1&
    &, 2))+ZLOG*(YDPHY3%FGTS_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 2, 2))+ZLOG&
    &*(YDPHY3%FGTS_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 3, 2))+ZLOG*(YDPHY3&
    &%FGTS_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTS_P&
    &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTS_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTS_P(JG, 5, 2)))))))))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTS_Q(JG, 0)+ZP_AVG*(YDPHY3&
    &%FGTS_Q(JG, 1)+ZP_AVG*YDPHY3%FGTS_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
  ENDDO


  IF (ANY (YDPHY3%FGTS_OA/=0._JPRB)) THEN
    
    ZAS (1)=1._JPRB-EXP (-ZDELTA (1))
    ZAS (2)=1._JPRB-EXP (-ZDELTA (2))
    ZAS (3)=1._JPRB-EXP (-ZDELTA (3))
    
    
    ZAR (1)=ZAS (1)+ZAS (2)-ZAS (1)*ZAS (2)
    ZAR (2)=ZAS (1)+ZAS (3)-ZAS (1)*ZAS (3)
    ZAR (3)=ZAS (2)+ZAS (3)-ZAS (2)*ZAS (3)
    ZCOEF (1)=2._JPRB*ZAS (1)*ZAS (2)/(ZEPSD+ZAS (1)*ZAS (1)+ZAS (2)*ZAS (2))
    ZCOEF (2)=2._JPRB*ZAS (1)*ZAS (3)/(ZEPSD+ZAS (1)*ZAS (1)+ZAS (3)*ZAS (3))
    ZCOEF (3)=2._JPRB*ZAS (2)*ZAS (3)/(ZEPSD+ZAS (2)*ZAS (2)+ZAS (3)*ZAS (3))

    

    DO JO=1, 3
      
      ZTAU (JO)=1._JPRB-ZAR (JO)-ZCOEF (JO)*YDPHY3%FGTS_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3&
      &%FGTS_OB(JO)*ZAR (JO)**YDPHY3%FGTS_OC(JO)*(1._JPRB-YDPHY3%FGTS_OD(JO)*ZAR (JO))
    
    ENDDO

    
    ZUEOSA (JLON, JLEV)=-LOG (MAX (ZTRLI, ZTAU (1)*ZTAU &
    &(2)*ZTAU (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
    
    
    ZUEOSA (JLON, JLEV)=MAX (ZUEOSA (JLON, JLEV), ZDELTA (1), ZDELTA (2), ZDELTA (3))
  
  ELSE
    
    ZUEOSA (JLON, JLEV)=ZDELTA (1)+ZDELTA (2)+ZDELTA (3)
  
  ENDIF

  
  
  
  
  PUEOSI (JLON, JLEV)=MAX (ZUEOSA (JLON, JLEV)-ZEOSO , 0._JPRB)
  ZEOSO =ZUEOSA (JLON, JLEV)
  
ENDDO


PUEOSI (JLON, KTDIA-1)=0._JPRB





END SUBROUTINE ACRANEB_TRANSS_OPENACC
