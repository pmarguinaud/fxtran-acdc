
MODULE MODE_COMPUTE_UPDRAFT_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_UPDRAFT_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KSV, OENTR_DETR&
&, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM&
&, PTKEM, PTHM, PRVM, PTHLM, PRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP, PTHV_UP&
&, PW_UP, PU_UP, PV_UP, PSV_UP, PFRAC_UP, PFRAC_ICE_UP, PRSAT_UP, PEMF, PDETR, PENTR&
&, PBUO_INTEG, KKLCL, KKETL, KKCTL, PDEPTH, PDX, PDY, YDSTACK)
!$ACC ROUTINE (COMPUTE_UPDRAFT_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_NEB_N,ONLY:NEB_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODD_TURB_N,ONLY:TURB_T
USE MODD_CTURB,ONLY:CSTURB_T
USE MODI_SHUMAN_MF,ONLY:MZM_MF, MZF_MF, GZ_M_W_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZM_MF_OPENACC
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZF_MF_OPENACC
USE MODI_SHUMAN_MF_OPENACC, ONLY : GZ_M_W_MF_OPENACC
USE MODE_COMPUTE_BL89_ML,ONLY:COMPUTE_BL89_ML
USE MODE_COMPUTE_BL89_ML_OPENACC,ONLY:COMPUTE_BL89_ML_OPENACC
USE MODE_MSG,ONLY:PRINT_MSG, NVERB_FATAL

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (NEB_T), INTENT (IN)::NEBN
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
TYPE (TURB_T), INTENT (IN)::TURBN
TYPE (CSTURB_T), INTENT (IN)::CSTURB
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::OENTR_DETR
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSFRV(D%NIJT)
REAL, INTENT (IN)::PSFTH(D%NIJT)
REAL, INTENT (IN)::PPABSM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRSAT_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_ICE_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PW_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRI_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRV_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSV_UP(D%NIJT, D%NKT, KSV)
REAL, INTENT (INOUT)::PENTR(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PDETR(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PBUO_INTEG(D%NIJT, D%NKT)
INTEGER, INTENT (INOUT)::KKCTL(D%NIJT)
INTEGER, INTENT (INOUT)::KKETL(D%NIJT)
INTEGER, INTENT (INOUT)::KKLCL(D%NIJT)
REAL, INTENT (OUT)::PDEPTH(D%NIJT)
REAL, INTENT (IN)::PDY
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL, INTENT (IN)::PDX
fxtran_acdc_temp (REAL, ZRVM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZDETR_CLD, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZENTR_CLD, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZBUO_INTEG_CLD, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZBUO_INTEG_DRY, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZW_UP2, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZG_O_THVREF, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHVM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHVM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZPRES_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRHO_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZVM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZUM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTKEM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHLM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRTM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZSVM_F, (D%NIJT, D%NKT, KSV))
fxtran_acdc_temp (REAL, ZRI_MIX, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRC_MIX, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTH_UP, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZCOEF, (D%NIJT, D%NKT))
REAL::ZWTHVSURF
REAL::ZRDORV
REAL::ZRVORD
REAL::ZMIX2_CLD
REAL::ZMIX3_CLD
REAL::ZMIX2
REAL::ZMIX1
fxtran_acdc_temp (REAL, ZLUP, (D%NIJT))
INTEGER::JSV
INTEGER::JI
INTEGER::JK
LOGICAL::GTESTETL
LOGICAL::GTESTLCL
LOGICAL::GTEST
LOGICAL::GLMIX
LOGICAL::GWORK1
fxtran_acdc_temp (LOGICAL, GWORK2, (D%NIJT, D%NKT))
INTEGER::ITEST
REAL::ZPART_DRY
REAL::ZRSATI
REAL::ZRSATW
REAL::ZRV_UP
REAL::ZRI_UP
REAL::ZRC_UP
REAL::ZDEPTH_MAX2
REAL::ZDEPTH_MAX1
REAL::ZRMAX
REAL::ZTMAX
REAL::ZSURF
fxtran_acdc_temp (REAL, ZDVDZ, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZDUDZ, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZSHEAR, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZWK, (D%NIJT, D%NKT))
REAL::ZBUF(16)

REAL::ZKIC_F2
REAL::ZKIC
REAL::ZDELTA
REAL::ZEPSI
REAL::ZEPSI_CLOUD
REAL::ZCOEFFMF_CLOUD
REAL::ZMIXRT
REAL::ZMIXTHL
REAL::ZTHMIX
REAL::ZRIMIX
REAL::ZRCMIX
REAL::ZRVMIX
REAL::ZTHVMIX_F2
REAL::ZTHVMIX
REAL::ZTHV_UP_F2
REAL::ZRSATI_ED
REAL::ZRSATW_ED
REAL::ZTHV
REAL::ZKIC_INIT
REAL::ZCOTHVU
REAL::ZFOESI
REAL::ZFOESW
REAL::ZDRSATODP
REAL::ZT
REAL::ZWK0D
REAL::ZCOEFF_PLUS_HALF
REAL::ZCOEFF_MINUS_HALF
REAL::ZPRE
REAL::ZG_O_THVREF_ED
REAL::ZFRAC_ICE
REAL::ZTHV_PLUS_HALF
REAL::ZTHV_MINUS_HALF
REAL::ZDZ_STOP
REAL::ZDZ
INTEGER::JKLIM
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKB
INTEGER::IKT
INTEGER::II
INTEGER::JITER
INTEGER::IE
INTEGER::IB
INTEGER::J
INTEGER, PARAMETER::I1PRT=16
INTEGER, PARAMETER::I99PP=15
INTEGER, PARAMETER::ILOGT=14
INTEGER, PARAMETER::IFOESI=13
INTEGER, PARAMETER::IFOESW=12
INTEGER, PARAMETER::IDRSATODTI=11
INTEGER, PARAMETER::IDRSATODTW=10
INTEGER, PARAMETER::IDRSATODT=9
INTEGER, PARAMETER::ILSOCPEXN=8
INTEGER, PARAMETER::ILVOCPEXN=7
INTEGER, PARAMETER::IT=6
INTEGER, PARAMETER::ICPH2=5
INTEGER, PARAMETER::IRLTEMP=4
INTEGER, PARAMETER::ICPH=3
INTEGER, PARAMETER::IRVSAT=2
INTEGER, PARAMETER::IEXN=1
REAL::ZDELT
REAL::ZTPOW2
REAL::ZVAR2
REAL::ZVAR1

YLSTACK = YDSTACK



IF (KIND (ZRVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRVM_F)
ELSEIF (KIND (ZRVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHM_F)
ELSEIF (KIND (ZTHM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDETR_CLD) == 8) THEN
    fxtran_acdc_alloc8 (ZDETR_CLD)
ELSEIF (KIND (ZDETR_CLD) == 4) THEN
    fxtran_acdc_alloc4 (ZDETR_CLD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZENTR_CLD) == 8) THEN
    fxtran_acdc_alloc8 (ZENTR_CLD)
ELSEIF (KIND (ZENTR_CLD) == 4) THEN
    fxtran_acdc_alloc4 (ZENTR_CLD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBUO_INTEG_CLD) == 8) THEN
    fxtran_acdc_alloc8 (ZBUO_INTEG_CLD)
ELSEIF (KIND (ZBUO_INTEG_CLD) == 4) THEN
    fxtran_acdc_alloc4 (ZBUO_INTEG_CLD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBUO_INTEG_DRY) == 8) THEN
    fxtran_acdc_alloc8 (ZBUO_INTEG_DRY)
ELSEIF (KIND (ZBUO_INTEG_DRY) == 4) THEN
    fxtran_acdc_alloc4 (ZBUO_INTEG_DRY)
ELSE
    STOP 1
ENDIF


IF (KIND (ZW_UP2) == 8) THEN
    fxtran_acdc_alloc8 (ZW_UP2)
ELSEIF (KIND (ZW_UP2) == 4) THEN
    fxtran_acdc_alloc4 (ZW_UP2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZG_O_THVREF) == 8) THEN
    fxtran_acdc_alloc8 (ZG_O_THVREF)
ELSEIF (KIND (ZG_O_THVREF) == 4) THEN
    fxtran_acdc_alloc4 (ZG_O_THVREF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHVM) == 8) THEN
    fxtran_acdc_alloc8 (ZTHVM)
ELSEIF (KIND (ZTHVM) == 4) THEN
    fxtran_acdc_alloc4 (ZTHVM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHVM_F)
ELSEIF (KIND (ZTHVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPRES_F) == 8) THEN
    fxtran_acdc_alloc8 (ZPRES_F)
ELSEIF (KIND (ZPRES_F) == 4) THEN
    fxtran_acdc_alloc4 (ZPRES_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRHO_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRHO_F)
ELSEIF (KIND (ZRHO_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRHO_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZVM_F)
ELSEIF (KIND (ZVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZUM_F)
ELSEIF (KIND (ZUM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZUM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTKEM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTKEM_F)
ELSEIF (KIND (ZTKEM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTKEM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHLM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHLM_F)
ELSEIF (KIND (ZTHLM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHLM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRTM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRTM_F)
ELSEIF (KIND (ZRTM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRTM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZSVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZSVM_F)
ELSEIF (KIND (ZSVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZSVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRI_MIX) == 8) THEN
    fxtran_acdc_alloc8 (ZRI_MIX)
ELSEIF (KIND (ZRI_MIX) == 4) THEN
    fxtran_acdc_alloc4 (ZRI_MIX)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRC_MIX) == 8) THEN
    fxtran_acdc_alloc8 (ZRC_MIX)
ELSEIF (KIND (ZRC_MIX) == 4) THEN
    fxtran_acdc_alloc4 (ZRC_MIX)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTH_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZTH_UP)
ELSEIF (KIND (ZTH_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZTH_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCOEF) == 8) THEN
    fxtran_acdc_alloc8 (ZCOEF)
ELSEIF (KIND (ZCOEF) == 4) THEN
    fxtran_acdc_alloc4 (ZCOEF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLUP) == 8) THEN
    fxtran_acdc_alloc8 (ZLUP)
ELSEIF (KIND (ZLUP) == 4) THEN
    fxtran_acdc_alloc4 (ZLUP)
ELSE
    STOP 1
ENDIF


IF (KIND (GWORK2) == 8) THEN
    fxtran_acdc_alloc8 (GWORK2)
ELSEIF (KIND (GWORK2) == 4) THEN
    fxtran_acdc_alloc4 (GWORK2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDVDZ) == 8) THEN
    fxtran_acdc_alloc8 (ZDVDZ)
ELSEIF (KIND (ZDVDZ) == 4) THEN
    fxtran_acdc_alloc4 (ZDVDZ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDUDZ) == 8) THEN
    fxtran_acdc_alloc8 (ZDUDZ)
ELSEIF (KIND (ZDUDZ) == 4) THEN
    fxtran_acdc_alloc4 (ZDUDZ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZSHEAR) == 8) THEN
    fxtran_acdc_alloc8 (ZSHEAR)
ELSEIF (KIND (ZSHEAR) == 4) THEN
    fxtran_acdc_alloc4 (ZSHEAR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWK) == 8) THEN
    fxtran_acdc_alloc8 (ZWK)
ELSEIF (KIND (ZWK) == 4) THEN
    fxtran_acdc_alloc4 (ZWK)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKE=D%NKE
IKL=D%NKL
ZTMAX=2.0
ZRMAX=1.E-3
ZRDORV=CST%XRD/CST%XRV
ZRVORD=(CST%XRV/CST%XRD)
ZDEPTH_MAX1=3000.
ZDEPTH_MAX2=4000.

IF (OENTR_DETR) THEN
  KKLCL (JI)=IKE
  KKETL (JI)=IKE
  KKCTL (JI)=IKE
  PEMF (JI,:)=0.
  PDETR (JI,:)=0.
  PENTR (JI,:)=0.
  PRV_UP (JI,:)=0.
  PRC_UP (JI,:)=0.
  PRI_UP (JI,:)=0.
  PW_UP (JI,:)=0.
  ZTH_UP (JI,:)=0.
  PFRAC_UP (JI,:)=0.
  PTHV_UP (JI,:)=0.
  PBUO_INTEG(JI,:)=0.
  PFRAC_ICE_UP (JI,:)=0.

  DO JK=1, IKT
    
    PRSAT_UP (JI, JK)=PRVM (JI, JK)
  
  ENDDO

  ZRC_MIX(JI,:)=0.
  ZRI_MIX(JI,:)=0.
ENDIF

CALL MZM_MF_OPENACC (D, PTHLM (:,:), ZTHLM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), ZRTM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PUM (:,:), ZUM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PVM (:,:), ZVM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTKEM (:,:), ZTKEM_F (:,:), YDSTACK=YLSTACK)

DO JSV=1, KSV

  IF (ONOMIXLG.AND.JSV>=KSV_LGBEG.AND.JSV<=KSV_LGEND)  THEN
    CYCLE
  ENDIF

  CALL MZM_MF_OPENACC (D, PSVM (:,:, JSV), ZSVM_F (:,:, JSV), YDSTACK=YLSTACK)
ENDDO


DO JK=1, IKT
  
  PTHL_UP (JI, JK)=ZTHLM_F (JI, JK)
  PRT_UP (JI, JK)=ZRTM_F (JI, JK)
  PU_UP (JI, JK)=ZUM_F (JI, JK)
  PV_UP (JI, JK)=ZVM_F (JI, JK)
  
ENDDO


DO JSV=1, KSV

  DO JK=1, IKT
    
    PSV_UP (JI, JK, JSV)=ZSVM_F (JI, JK, JSV)
  
  ENDDO

ENDDO


PTHL_UP (JI, IKB)=ZTHLM_F (JI, IKB)+MAX (0., MIN (ZTMAX,(PSFTH&
& (JI)/SQRT (ZTKEM_F (JI, IKB)))*PARAMMF%XALP_PERT))
PRT_UP (JI, IKB)=ZRTM_F (JI, IKB)+MAX (0., MIN (ZRMAX,(PSFRV&
& (JI)/SQRT (ZTKEM_F (JI, IKB)))*PARAMMF%XALP_PERT))


IF (OENTR_DETR) THEN
  CALL MZM_MF_OPENACC (D, PTHM (:,:), ZTHM_F (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PPABSM (:,:), ZPRES_F (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PRHODREF (:,:), ZRHO_F (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PRVM (:,:), ZRVM_F (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    ZTHVM_F (JI, JK)=ZTHM_F (JI, JK)*((1.+ZRVORD*ZRVM_F (JI, JK))/(1.+ZRTM_F (JI, JK)))
    ZTHVM (JI, JK)=PTHM (JI, JK)*((1.+ZRVORD*PRVM (JI, JK))/(1.+PRTM (JI, JK)))
    PTHV_UP (JI, JK)=ZTHVM_F (JI, JK)
  
  ENDDO

  ZW_UP2 (JI,:)=0.
  
  ZW_UP2 (JI, IKB)=MAX (0.0001,(2./3.)*ZTKEM_F (JI, IKB))
  PRC_UP (JI, IKB)=0.
  PRI_UP (JI, IKB)=0.
  
  
  IB=MERGE (D%NIJB, 1, .TRUE.)
  IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
  JITER=2
  ZBUF (ICPH2)=0
  
  
  
  
  ZBUF (IEXN)=(ZPRES_F (JI, IKB)/CST%XP00)**CST%RDSCPD

  DO J=IB, IE
    ZBUF (I99PP)=0.99*ZPRES_F (JI, IKB)
    PRV_UP (JI, IKB)=PRT_UP (JI, IKB)-PRC_UP (JI, IKB)-PRI_UP (JI, IKB)
    ZBUF (ICPH)=CST%XCPD+CST%XCPV*PRV_UP (JI, IKB)+CST%XCL*PRC_UP&
    & (JI, IKB)+CST%XCI*PRI_UP (JI, IKB)+ZBUF (ICPH2)
    ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
    ZDELT=(PTHL_UP (JI, IKB)*ZBUF (IEXN))-CST%XTT
    ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
    ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
    ZTH_UP (JI, IKB)=PTHL_UP (JI, IKB)+ZBUF (ILVOCPEXN)*PRC_UP&
    & (JI, IKB)+ZBUF (ILSOCPEXN)*PRI_UP (JI, IKB)
    ZBUF (I1PRT)=1+PRT_UP (JI, IKB)
  ENDDO


  DO II=1, JITER
    
    ZBUF (IT)=ZTH_UP (JI, IKB)*ZBUF (IEXN)
    
    PFRAC_ICE_UP (JI, IKB)=0.

    DO J=IB, IE

      IF (PRC_UP (JI, IKB)+PRI_UP (JI, IKB)>1.E-20) THEN
        PFRAC_ICE_UP (JI, IKB)=PRI_UP (JI, IKB)/(PRC_UP (JI, IKB)+PRI_UP (JI, IKB))
      ENDIF

    ENDDO


    

    

    

    SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
    CASE ('T')
      PFRAC_ICE_UP (JI, IKB)=MAX (0., MIN (1.,((NEBN%XTMAXMIX-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
    CASE ('O')
      PFRAC_ICE_UP (JI, IKB)=MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
    CASE ('N')
      PFRAC_ICE_UP (JI, IKB)=0.
    CASE ('S')
      PFRAC_ICE_UP (JI, IKB)=MAX (0., MIN (1., PFRAC_ICE_UP (JI, IKB)))
    CASE DEFAULT
    
    ENDSELECT

    
    
    
    ZBUF (ILOGT)=LOG (ZBUF (IT))

    DO J=IB, IE
      ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
      ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
      ZRSATW =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRES_F (JI, IKB)/(1&
      &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F (JI, IKB))
      ZRSATI =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRES_F (JI, IKB)/(1&
      &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F (JI, IKB))
      ZTPOW2=ZBUF (IT)**2
      ZBUF (IDRSATODTW)=ZRSATW /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F&
      & (JI, IKB))*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
      ZBUF (IDRSATODTI)=ZRSATI /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F&
      & (JI, IKB))*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
      ZRSATW =ZRSATW *ZBUF (I1PRT)
      ZRSATI =ZRSATI *ZBUF (I1PRT)
      ZBUF (IRVSAT)=ZRSATW *(1-PFRAC_ICE_UP (JI, IKB))+ZRSATI *PFRAC_ICE_UP (JI, IKB)
      ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-PFRAC_ICE_UP (JI&
      &, IKB))+ZBUF (IDRSATODTI)*PFRAC_ICE_UP (JI, IKB))
      ZBUF (IRLTEMP)=(PRV_UP (JI, IKB)-ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN)*(ZBUF&
      & (ILVOCPEXN)*(1-PFRAC_ICE_UP (JI, IKB))+ZBUF (ILSOCPEXN)*PFRAC_ICE_UP (JI, IKB)))
      ZBUF (IRLTEMP)=MIN (MAX (-PRC_UP (JI, IKB)-PRI_UP (JI, IKB), ZBUF (IRLTEMP)), PRV_UP (JI, IKB))
      PRV_UP (JI, IKB)=PRV_UP (JI, IKB)-ZBUF (IRLTEMP)
      PRC_UP (JI, IKB)=PRC_UP (JI, IKB)+PRI_UP (JI, IKB)+ZBUF (IRLTEMP)
      PRI_UP (JI, IKB)=PFRAC_ICE_UP (JI, IKB)*(PRC_UP (JI, IKB))
      PRC_UP (JI, IKB)=(1-PFRAC_ICE_UP (JI, IKB))*(PRT_UP (JI, IKB)-PRV_UP (JI, IKB))
      ZBUF (ICPH)=CST%XCPD+CST%XCPV*PRV_UP (JI, IKB)+CST%XCL*PRC_UP&
      & (JI, IKB)+CST%XCI*PRI_UP (JI, IKB)+ZBUF (ICPH2)
      ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
      ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
      ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
      ZTH_UP (JI, IKB)=PTHL_UP (JI, IKB)+ZBUF (ILVOCPEXN)*PRC_UP&
      & (JI, IKB)+ZBUF (ILSOCPEXN)*PRI_UP (JI, IKB)
      ZVAR1=ZTH_UP (JI, IKB)*ZBUF (IEXN)-ZBUF (IT)
      ZRSATW =ZRSATW +ZBUF (IDRSATODTW)*ZVAR1
      ZRSATI =ZRSATI +ZBUF (IDRSATODTI)*ZVAR1
    ENDDO

  ENDDO

  
  
  
  PTHV_UP (JI, IKB)=ZTH_UP (JI, IKB)*((1+ZRVORD*PRV_UP (JI, IKB))/(1+PRT_UP (JI, IKB)))
  PRSAT_UP (JI, IKB)=ZRSATW *(1-PFRAC_ICE_UP (JI, IKB))+ZRSATI *PFRAC_ICE_UP (JI, IKB)

  

  DO JK=1, IKT
    
    ZG_O_THVREF (JI, JK)=CST%XG/ZTHVM_F (JI, JK)
  
  ENDDO

  GLMIX=.TRUE.
  
  ZTKEM_F (JI, IKB)=0.

  

  IF (TURBN%CTURBLEN=='RM17') THEN
    CALL GZ_M_W_MF_OPENACC (D, PUM, PDZZ, ZWK, YDSTACK=YLSTACK)
    CALL MZF_MF_OPENACC (D, ZWK, ZDUDZ, YDSTACK=YLSTACK)
    CALL GZ_M_W_MF_OPENACC (D, PVM, PDZZ, ZWK, YDSTACK=YLSTACK)
    CALL MZF_MF_OPENACC (D, ZWK, ZDVDZ, YDSTACK=YLSTACK)

    DO JK=1, IKT
      
      ZSHEAR (JI, JK)=SQRT (ZDUDZ (JI, JK)**2+ZDVDZ (JI, JK)**2)
    
    ENDDO

  ELSE
    ZSHEAR(JI,:)=0.
  ENDIF

  CALL COMPUTE_BL89_ML_OPENACC (D, CST, CSTURB, PDZZ, ZTKEM_F (:, IKB), ZG_O_THVREF&
  & (:, IKB), ZTHVM, IKB, GLMIX,.TRUE., ZSHEAR, ZLUP, YDSTACK=YLSTACK)
  
  ZLUP (JI)=MAX (ZLUP (JI), 1.E-10)
  ZWTHVSURF =(ZTHVM_F (JI, IKB)/ZTHM_F (JI, IKB))*PSFTH (JI)+(0.61*ZTHM_F (JI, IKB))*PSFRV (JI)

  

  IF (PARAMMF%LGZ) THEN

    IF (PDX==0..OR.PDY==0.) THEN
      CALL FXTRAN_ACDC_ABORT ('PDX or PDY is NULL with option LGZ!')
    ENDIF

    
    ZSURF =TANH (PARAMMF%XGZ*SQRT (PDX*PDY)/ZLUP (JI))
  
  ELSE
    ZSURF =1.
  ENDIF


  

  IF (ZWTHVSURF >0.) THEN
    PEMF (JI, IKB)=PARAMMF%XCMF*ZSURF *ZRHO_F (JI, IKB)*((ZG_O_THVREF&
    & (JI, IKB))*ZWTHVSURF *ZLUP (JI))**(1./3.)
    PFRAC_UP (JI, IKB)=MIN (PEMF (JI, IKB)/(SQRT (ZW_UP2 (JI&
    &, IKB))*ZRHO_F (JI, IKB)), PARAMMF%XFRAC_UP_MAX)
    ZW_UP2 (JI, IKB)=(PEMF (JI, IKB)/(PFRAC_UP (JI, IKB)*ZRHO_F (JI, IKB)))**2
    GTEST =.TRUE.
  ELSE
    PEMF (JI, IKB)=0.
    GTEST =.FALSE.
  ENDIF

  
ELSE
  
  GTEST =PEMF (JI, IKB+IKL)>0.
  
ENDIF

GTESTLCL =.FALSE.
GTESTETL =.FALSE.

DO JK=IKB, IKE-IKL, IKL
  ITEST=MERGE (1, 0, GTEST)

  IF (ITEST==0)  THEN
    CYCLE
  ENDIF


  

  IF ((PRC_UP (JI, JK)+PRI_UP (JI, JK)>0.).AND.(.NOT.(GTESTLCL ))) THEN
    KKLCL (JI)=JK
    GTESTLCL =.TRUE.
  ENDIF


  

  IF (OENTR_DETR) THEN

    IF (JK/=IKB) THEN
      
      ZRC_MIX (JI, JK)=ZRC_MIX (JI, JK-IKL)
      ZRI_MIX (JI, JK)=ZRI_MIX (JI, JK-IKL)
    
    ENDIF

    
    ZCOEFFMF_CLOUD=PARAMMF%XENTR_MF*CST%XG/PARAMMF%XCRAD_MF
    
    ZG_O_THVREF_ED =CST%XG/ZTHVM (JI,JK)
    ZFRAC_ICE =PFRAC_ICE_UP (JI, JK)
    ZPRE =ZPRES_F (JI, JK)

    

    

    IF (GTEST .AND.GTESTLCL ) THEN
      ZPART_DRY =0.
      ZDZ_STOP =0.
      ZPRE =ZPRES_F (JI, JK)
    ELSEIF (GTEST .AND..NOT.GTESTLCL ) THEN
      ZT=ZTH_UP (JI, JK)*(ZPRES_F (JI, JK)/CST%XP00)**(CST%XRD/CST%XCPD)
      ZFOESW=MIN (EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*LOG (ZT)), 0.99*ZPRES_F (JI, JK))
      ZFOESI=MIN (EXP (CST%XALPI-CST%XBETAI/ZT-CST%XGAMI*LOG (ZT)), 0.99*ZPRES_F (JI, JK))
      ZDRSATODP=(CST%XBETAW/ZT-CST%XGAMW)*(1-ZFRAC_ICE )+(CST%XBETAI/ZT-CST%XGAMI)*ZFRAC_ICE 
      ZDRSATODP=((CST%XRD/CST%XCPD)*ZDRSATODP-1.)*PRSAT_UP (JI, JK)/(ZPRES_F&
      & (JI, JK)-(ZFOESW*(1-ZFRAC_ICE )+ZFOESI*ZFRAC_ICE ))
      ZPRE =ZPRES_F (JI, JK)+(PRT_UP (JI, JK)-PRSAT_UP (JI, JK))/ZDRSATODP
      ZPART_DRY =MAX (0., MIN (1.,(ZPRES_F (JI, JK)-ZPRE )/(ZPRES_F (JI, JK)-ZPRES_F (JI, JK+IKL))))
      ZDZ_STOP =(PZZ (JI,JK+IKL)-PZZ (JI,JK))*ZPART_DRY 
    ELSE
      ZPART_DRY =0.
    ENDIF


    

    

    IF (JK/=IKB) THEN
      ZCOEFF_MINUS_HALF =((ZTHVM (JI,JK)-ZTHVM (JI,JK-IKL))/PDZZ (JI,JK))
      ZTHV_MINUS_HALF =ZTHVM (JI,JK)-ZCOEFF_MINUS_HALF *0.5*(PZZ (JI,JK+IKL)-PZZ (JI,JK))
    ELSE
      ZCOEFF_MINUS_HALF =0.
      ZTHV_MINUS_HALF =ZTHVM (JI,JK)
    ENDIF

    ZCOEFF_PLUS_HALF =((ZTHVM (JI,JK+IKL)-ZTHVM (JI,JK))/PDZZ (JI,JK+IKL))
    ZTHV_PLUS_HALF =ZTHVM (JI,JK)+ZCOEFF_PLUS_HALF *0.5*(PZZ (JI,JK+IKL)-PZZ (JI,JK))

    

    

    IF (GTEST .AND.ZPART_DRY >0.) THEN
      ZDZ=MIN (ZDZ_STOP ,(PZZ (JI,JK+IKL)-PZZ (JI,JK))*0.5)
      ZBUO_INTEG_DRY (JI, JK)=ZG_O_THVREF_ED *ZDZ*(0.5*(-ZCOEFF_MINUS_HALF&
      & )*ZDZ-ZTHV_MINUS_HALF +PTHV_UP (JI, JK))
      ZDZ=MAX (0., ZDZ_STOP -(PZZ (JI,JK+IKL)-PZZ (JI,JK))*0.5)
      ZBUO_INTEG_DRY (JI, JK)=ZBUO_INTEG_DRY (JI, JK)+ZG_O_THVREF_ED *ZDZ&
      &*(0.5*(-ZCOEFF_PLUS_HALF )*ZDZ-ZTHVM (JI,JK)+PTHV_UP (JI, JK))

      IF (ZBUO_INTEG_DRY (JI, JK)>=0.) THEN
        PENTR (JI, JK)=0.5/(PARAMMF%XABUO-PARAMMF%XBENTR*PARAMMF%XENTR_DRY)*LOG (1.+(2.*(PARAMMF&
        &%XABUO-PARAMMF%XBENTR*PARAMMF%XENTR_DRY)/ZW_UP2 (JI,JK))*ZBUO_INTEG_DRY (JI, JK))
        PDETR (JI, JK)=0.
      ELSE
        PENTR (JI, JK)=0.
        PDETR (JI, JK)=0.5/(PARAMMF%XABUO)*LOG (1.+(2.*(PARAMMF&
        &%XABUO)/ZW_UP2 (JI,JK))*(-ZBUO_INTEG_DRY (JI, JK)))
      ENDIF

      PENTR (JI, JK)=PARAMMF%XENTR_DRY*PENTR (JI, JK)/(PZZ (JI,JK+IKL)-PZZ (JI,JK))
      PDETR (JI, JK)=PARAMMF%XDETR_DRY*PDETR (JI, JK)/(PZZ (JI,JK+IKL)-PZZ (JI,JK))
      ZWK0D=ZLUP (JI)-0.5*(PZZ (JI,JK)+PZZ (JI,JK+IKL))
      ZWK0D=SIGN (MAX (1., ABS (ZWK0D)), ZWK0D)
      PDETR (JI, JK)=MAX (ZPART_DRY *PARAMMF%XDETR_LUP/ZWK0D, PDETR (JI, JK))
    ELSE
      ZBUO_INTEG_DRY (JI, JK)=0.
      PENTR (JI, JK)=0.
      PDETR (JI, JK)=0.
    ENDIF

    
    
    ZRCMIX =PRC_UP (JI, JK)
    ZRIMIX =PRI_UP (JI, JK)
    
    
    IB=MERGE (D%NIJB, 1, .TRUE.)
    IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
    JITER=2
    ZBUF (ICPH2)=0
    
    
    
    
    ZBUF (IEXN)=(ZPRES_F (JI, JK+IKL)/CST%XP00)**CST%RDSCPD

    DO J=IB, IE
      ZBUF (I99PP)=0.99*ZPRES_F (JI, JK+IKL)
      ZRVMIX =PRT_UP (JI, JK)-ZRCMIX -ZRIMIX 
      ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRVMIX +CST%XCL*ZRCMIX +CST%XCI*ZRIMIX +ZBUF (ICPH2)
      ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
      ZDELT=(PTHL_UP (JI, JK)*ZBUF (IEXN))-CST%XTT
      ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
      ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
      ZTHMIX =PTHL_UP (JI, JK)+ZBUF (ILVOCPEXN)*ZRCMIX +ZBUF (ILSOCPEXN)*ZRIMIX 
      ZBUF (I1PRT)=1+PRT_UP (JI, JK)
    ENDDO


    DO II=1, JITER
      
      ZBUF (IT)=ZTHMIX *ZBUF (IEXN)
      
      ZFRAC_ICE =0.

      DO J=IB, IE

        IF (ZRCMIX +ZRIMIX >1.E-20) THEN
          ZFRAC_ICE =ZRIMIX /(ZRCMIX +ZRIMIX )
        ENDIF

      ENDDO


      

      

      

      SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
      CASE ('T')
        ZFRAC_ICE =MAX (0., MIN (1.,((NEBN%XTMAXMIX-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
      CASE ('O')
        ZFRAC_ICE =MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
      CASE ('N')
        ZFRAC_ICE =0.
      CASE ('S')
        ZFRAC_ICE =MAX (0., MIN (1., ZFRAC_ICE ))
      CASE DEFAULT
      
      ENDSELECT

      
      
      
      ZBUF (ILOGT)=LOG (ZBUF (IT))

      DO J=IB, IE
        ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
        ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
        ZRSATW_ED =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL)/(1&
        &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL))
        ZRSATI_ED =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL)/(1&
        &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL))
        ZTPOW2=ZBUF (IT)**2
        ZBUF (IDRSATODTW)=ZRSATW_ED /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F&
        & (JI, JK+IKL))*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
        ZBUF (IDRSATODTI)=ZRSATI_ED /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F&
        & (JI, JK+IKL))*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
        ZRSATW_ED =ZRSATW_ED *ZBUF (I1PRT)
        ZRSATI_ED =ZRSATI_ED *ZBUF (I1PRT)
        ZBUF (IRVSAT)=ZRSATW_ED *(1-ZFRAC_ICE )+ZRSATI_ED *ZFRAC_ICE 
        ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-ZFRAC_ICE )+ZBUF (IDRSATODTI)*ZFRAC_ICE )
        ZBUF (IRLTEMP)=(ZRVMIX -ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN&
        &)*(ZBUF (ILVOCPEXN)*(1-ZFRAC_ICE )+ZBUF (ILSOCPEXN)*ZFRAC_ICE ))
        ZBUF (IRLTEMP)=MIN (MAX (-ZRCMIX -ZRIMIX , ZBUF (IRLTEMP)), ZRVMIX )
        ZRVMIX =ZRVMIX -ZBUF (IRLTEMP)
        ZRCMIX =ZRCMIX +ZRIMIX +ZBUF (IRLTEMP)
        ZRIMIX =ZFRAC_ICE *(ZRCMIX )
        ZRCMIX =(1-ZFRAC_ICE )*(PRT_UP (JI, JK)-ZRVMIX )
        ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRVMIX +CST%XCL*ZRCMIX +CST%XCI*ZRIMIX +ZBUF (ICPH2)
        ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
        ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZTHMIX =PTHL_UP (JI, JK)+ZBUF (ILVOCPEXN)*ZRCMIX +ZBUF (ILSOCPEXN)*ZRIMIX 
        ZVAR1=ZTHMIX *ZBUF (IEXN)-ZBUF (IT)
        ZRSATW_ED =ZRSATW_ED +ZBUF (IDRSATODTW)*ZVAR1
        ZRSATI_ED =ZRSATI_ED +ZBUF (IDRSATODTI)*ZVAR1
      ENDDO

    ENDDO

    
    
    
    ZTHV_UP_F2 =ZTHMIX *(1.+ZRVORD*ZRVMIX )/(1.+PRT_UP (JI, JK))

    

    

    IF (GTEST .AND.ZPART_DRY <1.) THEN
      ZCOTHVU=(ZTHV_UP_F2 -PTHV_UP (JI, JK))/((PZZ (JI,JK+IKL)-PZZ (JI,JK))*(1-ZPART_DRY ))
      ZDZ=MAX (0., 0.5*(PZZ (JI,JK+IKL)-PZZ (JI,JK))-ZDZ_STOP )
      ZBUO_INTEG_CLD (JI, JK)=ZG_O_THVREF_ED *ZDZ*(0.5*(ZCOTHVU-ZCOEFF_MINUS_HALF&
      & )*ZDZ-(ZTHVM (JI,JK)-ZDZ*ZCOEFF_MINUS_HALF )+PTHV_UP (JI, JK))
      ZDZ=(PZZ (JI,JK+IKL)-PZZ (JI,JK))-MAX (ZDZ_STOP , 0.5*(PZZ (JI,JK+IKL)-PZZ (JI,JK)))
      ZBUO_INTEG_CLD (JI, JK)=ZBUO_INTEG_CLD (JI, JK)+ZG_O_THVREF_ED *ZDZ*(0.5*(ZCOTHVU-ZCOEFF_PLUS_HALF )*ZDZ&
      &-(ZTHVM (JI,JK)+(0.5*((PZZ (JI,JK+IKL)-PZZ (JI,JK)))-ZDZ)*ZCOEFF_PLUS_HALF )+PTHV_UP (JI, JK))
    ELSE
      ZBUO_INTEG_CLD (JI, JK)=0.
    ENDIF

    
    ZKIC_INIT=0.1
    JKLIM=IKL*MAX (IKL*(JK-IKL), IKL*IKB)

    

    IF (GTEST .AND.ZPART_DRY >0.5) THEN
      ZDZ=ZDZ_STOP -0.5*(PZZ (JI,JK+IKL)-PZZ (JI,JK))
      ZTHV =ZTHVM (JI,JK)+ZCOEFF_PLUS_HALF *ZDZ
      ZMIXTHL =ZKIC_INIT*(PTHLM (JI,JK)+ZDZ*(PTHLM (JI,JK+IKL)-PTHLM&
      & (JI,JK))/PDZZ (JI,JK+IKL))+(1.-ZKIC_INIT)*PTHL_UP (JI, JK)
      ZMIXRT =ZKIC_INIT*(PRTM (JI,JK)+ZDZ*(PRTM (JI,JK+IKL)-PRTM (JI&
      &,JK))/PDZZ (JI,JK+IKL))+(1.-ZKIC_INIT)*PRT_UP (JI, JK)
    ELSEIF (GTEST ) THEN
      ZDZ=0.5*(PZZ (JI,JK+IKL)-PZZ (JI,JK))-ZDZ_STOP 
      ZTHV =ZTHVM (JI,JK)-ZCOEFF_MINUS_HALF *ZDZ
      ZMIXTHL =ZKIC_INIT*(PTHLM (JI,JK)-ZDZ*(PTHLM (JI,JK)-PTHLM (JI&
      &,JKLIM))/PDZZ (JI,JK))+(1.-ZKIC_INIT)*PTHL_UP (JI, JK)
      ZMIXRT =ZKIC_INIT*(PRTM (JI,JK)-ZDZ*(PRTM (JI,JK)-PRTM (JI&
      &,JKLIM))/PDZZ (JI,JK))+(1.-ZKIC_INIT)*PRT_UP (JI, JK)
    ELSE
      ZMIXTHL =300.
      ZMIXRT =0.1
    ENDIF

    
    
    IB=MERGE (D%NIJB, 1, .TRUE.)
    IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
    JITER=2
    ZBUF (ICPH2)=0
    
    
    
    
    ZBUF (IEXN)=(ZPRE /CST%XP00)**CST%RDSCPD

    DO J=IB, IE
      ZBUF (I99PP)=0.99*ZPRE 
      ZRVMIX =ZMIXRT -ZRC_MIX (JI, JK)-ZRI_MIX (JI, JK)
      ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRVMIX +CST%XCL*ZRC_MIX (JI, JK)+CST%XCI*ZRI_MIX (JI, JK)+ZBUF (ICPH2)
      ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
      ZDELT=(ZMIXTHL *ZBUF (IEXN))-CST%XTT
      ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
      ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
      ZTHMIX =ZMIXTHL +ZBUF (ILVOCPEXN)*ZRC_MIX (JI, JK)+ZBUF (ILSOCPEXN)*ZRI_MIX (JI, JK)
      ZBUF (I1PRT)=1+ZMIXRT 
    ENDDO


    DO II=1, JITER
      
      ZBUF (IT)=ZTHMIX *ZBUF (IEXN)
      
      ZFRAC_ICE =0.

      DO J=IB, IE

        IF (ZRC_MIX (JI, JK)+ZRI_MIX (JI, JK)>1.E-20) THEN
          ZFRAC_ICE =ZRI_MIX (JI, JK)/(ZRC_MIX (JI, JK)+ZRI_MIX (JI, JK))
        ENDIF

      ENDDO


      

      

      

      SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
      CASE ('T')
        ZFRAC_ICE =MAX (0., MIN (1.,((NEBN%XTMAXMIX-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
      CASE ('O')
        ZFRAC_ICE =MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
      CASE ('N')
        ZFRAC_ICE =0.
      CASE ('S')
        ZFRAC_ICE =MAX (0., MIN (1., ZFRAC_ICE ))
      CASE DEFAULT
      
      ENDSELECT

      
      
      
      ZBUF (ILOGT)=LOG (ZBUF (IT))

      DO J=IB, IE
        ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
        ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
        ZRSATW_ED =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRE /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRE )
        ZRSATI_ED =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRE /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRE )
        ZTPOW2=ZBUF (IT)**2
        ZBUF (IDRSATODTW)=ZRSATW_ED /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW&
        &)/ZPRE )*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
        ZBUF (IDRSATODTI)=ZRSATI_ED /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI&
        &)/ZPRE )*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
        ZRSATW_ED =ZRSATW_ED *ZBUF (I1PRT)
        ZRSATI_ED =ZRSATI_ED *ZBUF (I1PRT)
        ZBUF (IRVSAT)=ZRSATW_ED *(1-ZFRAC_ICE )+ZRSATI_ED *ZFRAC_ICE 
        ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-ZFRAC_ICE )+ZBUF (IDRSATODTI)*ZFRAC_ICE )
        ZBUF (IRLTEMP)=(ZRVMIX -ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN&
        &)*(ZBUF (ILVOCPEXN)*(1-ZFRAC_ICE )+ZBUF (ILSOCPEXN)*ZFRAC_ICE ))
        ZBUF (IRLTEMP)=MIN (MAX (-ZRC_MIX (JI, JK)-ZRI_MIX (JI, JK), ZBUF (IRLTEMP)), ZRVMIX )
        ZRVMIX =ZRVMIX -ZBUF (IRLTEMP)
        ZRC_MIX (JI, JK)=ZRC_MIX (JI, JK)+ZRI_MIX (JI, JK)+ZBUF (IRLTEMP)
        ZRI_MIX (JI, JK)=ZFRAC_ICE *(ZRC_MIX (JI, JK))
        ZRC_MIX (JI, JK)=(1-ZFRAC_ICE )*(ZMIXRT -ZRVMIX )
        ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRVMIX +CST%XCL*ZRC_MIX (JI, JK)+CST%XCI*ZRI_MIX (JI, JK)+ZBUF (ICPH2)
        ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
        ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZTHMIX =ZMIXTHL +ZBUF (ILVOCPEXN)*ZRC_MIX (JI, JK)+ZBUF (ILSOCPEXN)*ZRI_MIX (JI, JK)
        ZVAR1=ZTHMIX *ZBUF (IEXN)-ZBUF (IT)
        ZRSATW_ED =ZRSATW_ED +ZBUF (IDRSATODTW)*ZVAR1
        ZRSATI_ED =ZRSATI_ED +ZBUF (IDRSATODTI)*ZVAR1
      ENDDO

    ENDDO

    
    
    
    ZTHVMIX =ZTHMIX *(1.+ZRVORD*ZRVMIX )/(1.+ZMIXRT )
    ZMIXTHL =ZKIC_INIT*0.5*(PTHLM (JI,JK)+PTHLM (JI,JK+IKL))+(1.-ZKIC_INIT)*PTHL_UP (JI, JK)
    ZMIXRT =ZKIC_INIT*0.5*(PRTM (JI,JK)+PRTM (JI,JK+IKL))+(1.-ZKIC_INIT)*PRT_UP (JI, JK)
    
    
    IB=MERGE (D%NIJB, 1, .TRUE.)
    IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
    JITER=2
    ZBUF (ICPH2)=0
    
    
    
    
    ZBUF (IEXN)=(ZPRES_F (JI, JK+IKL)/CST%XP00)**CST%RDSCPD

    DO J=IB, IE
      ZBUF (I99PP)=0.99*ZPRES_F (JI, JK+IKL)
      ZRVMIX =ZMIXRT -ZRC_MIX (JI, JK)-ZRI_MIX (JI, JK)
      ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRVMIX +CST%XCL*ZRC_MIX (JI, JK)+CST%XCI*ZRI_MIX (JI, JK)+ZBUF (ICPH2)
      ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
      ZDELT=(ZMIXTHL *ZBUF (IEXN))-CST%XTT
      ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
      ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
      ZTHMIX =ZMIXTHL +ZBUF (ILVOCPEXN)*ZRC_MIX (JI, JK)+ZBUF (ILSOCPEXN)*ZRI_MIX (JI, JK)
      ZBUF (I1PRT)=1+ZMIXRT 
    ENDDO


    DO II=1, JITER
      
      ZBUF (IT)=ZTHMIX *ZBUF (IEXN)
      
      ZFRAC_ICE =0.

      DO J=IB, IE

        IF (ZRC_MIX (JI, JK)+ZRI_MIX (JI, JK)>1.E-20) THEN
          ZFRAC_ICE =ZRI_MIX (JI, JK)/(ZRC_MIX (JI, JK)+ZRI_MIX (JI, JK))
        ENDIF

      ENDDO


      

      

      

      SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
      CASE ('T')
        ZFRAC_ICE =MAX (0., MIN (1.,((NEBN%XTMAXMIX-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
      CASE ('O')
        ZFRAC_ICE =MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
      CASE ('N')
        ZFRAC_ICE =0.
      CASE ('S')
        ZFRAC_ICE =MAX (0., MIN (1., ZFRAC_ICE ))
      CASE DEFAULT
      
      ENDSELECT

      
      
      
      ZBUF (ILOGT)=LOG (ZBUF (IT))

      DO J=IB, IE
        ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
        ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
        ZRSATW_ED =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL)/(1&
        &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL))
        ZRSATI_ED =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL)/(1&
        &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL))
        ZTPOW2=ZBUF (IT)**2
        ZBUF (IDRSATODTW)=ZRSATW_ED /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F&
        & (JI, JK+IKL))*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
        ZBUF (IDRSATODTI)=ZRSATI_ED /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F&
        & (JI, JK+IKL))*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
        ZRSATW_ED =ZRSATW_ED *ZBUF (I1PRT)
        ZRSATI_ED =ZRSATI_ED *ZBUF (I1PRT)
        ZBUF (IRVSAT)=ZRSATW_ED *(1-ZFRAC_ICE )+ZRSATI_ED *ZFRAC_ICE 
        ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-ZFRAC_ICE )+ZBUF (IDRSATODTI)*ZFRAC_ICE )
        ZBUF (IRLTEMP)=(ZRVMIX -ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN&
        &)*(ZBUF (ILVOCPEXN)*(1-ZFRAC_ICE )+ZBUF (ILSOCPEXN)*ZFRAC_ICE ))
        ZBUF (IRLTEMP)=MIN (MAX (-ZRC_MIX (JI, JK)-ZRI_MIX (JI, JK), ZBUF (IRLTEMP)), ZRVMIX )
        ZRVMIX =ZRVMIX -ZBUF (IRLTEMP)
        ZRC_MIX (JI, JK)=ZRC_MIX (JI, JK)+ZRI_MIX (JI, JK)+ZBUF (IRLTEMP)
        ZRI_MIX (JI, JK)=ZFRAC_ICE *(ZRC_MIX (JI, JK))
        ZRC_MIX (JI, JK)=(1-ZFRAC_ICE )*(ZMIXRT -ZRVMIX )
        ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRVMIX +CST%XCL*ZRC_MIX (JI, JK)+CST%XCI*ZRI_MIX (JI, JK)+ZBUF (ICPH2)
        ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
        ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZTHMIX =ZMIXTHL +ZBUF (ILVOCPEXN)*ZRC_MIX (JI, JK)+ZBUF (ILSOCPEXN)*ZRI_MIX (JI, JK)
        ZVAR1=ZTHMIX *ZBUF (IEXN)-ZBUF (IT)
        ZRSATW_ED =ZRSATW_ED +ZBUF (IDRSATODTW)*ZVAR1
        ZRSATI_ED =ZRSATI_ED +ZBUF (IDRSATODTI)*ZVAR1
      ENDDO

    ENDDO

    
    
    
    ZTHVMIX_F2 =ZTHMIX *(1.+ZRVORD*ZRVMIX )/(1.+ZMIXRT )

    

    

    IF (GTEST ) THEN

      IF (ABS (PTHV_UP (JI, JK)-ZTHVMIX )<1.E-10) THEN
        ZKIC =1.
      ELSE
        ZKIC =MAX (0., PTHV_UP (JI, JK)-ZTHV )*ZKIC_INIT/(PTHV_UP (JI, JK)-ZTHVMIX )
      ENDIF


      IF (ABS (ZTHV_UP_F2 -ZTHVMIX_F2 )<1.E-10) THEN
        ZKIC_F2 =1.
      ELSE
        ZKIC_F2 =MAX (0., ZTHV_UP_F2 -ZTHV_PLUS_HALF )*ZKIC_INIT/(ZTHV_UP_F2 -ZTHVMIX_F2 )
      ENDIF

      ZKIC =MAX (MIN (0.5*(ZKIC +ZKIC_F2 ), 1.), 0.)
    ENDIF


    

    

    IF (GTEST ) THEN
      ZEPSI =ZKIC **2.
      ZDELTA =(1.-ZKIC )**2.
    ENDIF


    

    

    IF (GTEST ) THEN
      ZEPSI_CLOUD=MIN (ZDELTA , ZEPSI )
      ZENTR_CLD (JI, JK)=(1.-ZPART_DRY )*ZCOEFFMF_CLOUD*PRHODREF (JI, JK)*ZEPSI_CLOUD
      ZDETR_CLD (JI, JK)=(1.-ZPART_DRY )*ZCOEFFMF_CLOUD*PRHODREF (JI, JK)*ZDELTA 
      PENTR (JI, JK)=PENTR (JI, JK)+ZENTR_CLD (JI, JK)
      PDETR (JI, JK)=PDETR (JI, JK)+ZDETR_CLD (JI, JK)
    ELSE
      ZENTR_CLD (JI, JK)=0.
      ZDETR_CLD (JI, JK)=0.
    ENDIF

    
    
    
    
    PBUO_INTEG (JI, JK)=ZBUO_INTEG_DRY (JI, JK)+ZBUO_INTEG_CLD (JI, JK)

    IF (JK==IKB) THEN
      PDETR (JI, JK)=0.
      ZDETR_CLD (JI, JK)=0.
    ENDIF


    IF (GTEST ) THEN
      ZMIX1 =0.5*(PZZ (JI, JK+IKL)-PZZ (JI, JK))*(PENTR (JI, JK)-PDETR (JI, JK))
      PEMF (JI, JK+IKL)=PEMF (JI, JK)*EXP (2*ZMIX1 )
    ENDIF

  
  ELSE
    
    GTEST =(PEMF (JI, JK+IKL)>0.)
  
  ENDIF


  

  IF (GTEST .AND.(PEMF (JI, JK+IKL)<=0.)) THEN
    PEMF (JI, JK+IKL)=0.
    KKCTL (JI)=JK+IKL
    GTEST =.FALSE.
    PFRAC_ICE_UP (JI, JK+IKL)=PFRAC_ICE_UP (JI, JK)
    PRSAT_UP (JI, JK+IKL)=PRSAT_UP (JI, JK)
  ENDIF


  

  

  IF (GTEST ) THEN
    ZMIX2 =(PZZ (JI, JK+IKL)-PZZ (JI, JK))*PENTR (JI, JK)
    ZMIX3_CLD =(PZZ (JI, JK+IKL)-PZZ (JI, JK))*(1.-ZPART_DRY )*ZDETR_CLD (JI, JK)
    ZMIX2_CLD =(PZZ (JI, JK+IKL)-PZZ (JI, JK))*(1.-ZPART_DRY )*ZENTR_CLD (JI, JK)
    PTHL_UP (JI, JK+IKL)=(PTHL_UP (JI, JK)*(1.-0.5*ZMIX2 )+PTHLM (JI, JK)*ZMIX2 )/(1.+0.5*ZMIX2 )
    PRT_UP (JI, JK+IKL)=(PRT_UP (JI, JK)*(1.-0.5*ZMIX2 )+PRTM (JI, JK)*ZMIX2 )/(1.+0.5*ZMIX2 )
  ENDIF


  

  IF (PARAMMF%LMIXUV) THEN

    IF (JK/=IKB) THEN

      

      IF (GTEST ) THEN
        PU_UP (JI, JK+IKL)=(PU_UP (JI, JK)*(1-0.5*ZMIX2 )+PUM (JI, JK)*ZMIX2 +0.5*PARAMMF&
        &%XPRES_UV*(PZZ (JI, JK+IKL)-PZZ (JI, JK))*((PUM (JI, JK+IKL)-PUM (JI, JK))/PDZZ&
        & (JI, JK+IKL)+(PUM (JI, JK)-PUM (JI, JK-IKL))/PDZZ (JI, JK)))/(1+0.5*ZMIX2 )
        PV_UP (JI, JK+IKL)=(PV_UP (JI, JK)*(1-0.5*ZMIX2 )+PVM (JI, JK)*ZMIX2 +0.5*PARAMMF&
        &%XPRES_UV*(PZZ (JI, JK+IKL)-PZZ (JI, JK))*((PVM (JI, JK+IKL)-PVM (JI, JK))/PDZZ&
        & (JI, JK+IKL)+(PVM (JI, JK)-PVM (JI, JK-IKL))/PDZZ (JI, JK)))/(1+0.5*ZMIX2 )
      ENDIF

    
    ELSE

      

      IF (GTEST ) THEN
        PU_UP (JI, JK+IKL)=(PU_UP (JI, JK)*(1-0.5*ZMIX2 )+PUM (JI, JK)*ZMIX2 +0.5*PARAMMF%XPRES_UV*(PZZ (JI&
        &, JK+IKL)-PZZ (JI, JK))*((PUM (JI, JK+IKL)-PUM (JI, JK))/PDZZ (JI, JK+IKL)))/(1+0.5*ZMIX2 )
        PV_UP (JI, JK+IKL)=(PV_UP (JI, JK)*(1-0.5*ZMIX2 )+PVM (JI, JK)*ZMIX2 +0.5*PARAMMF%XPRES_UV*(PZZ (JI&
        &, JK+IKL)-PZZ (JI, JK))*((PVM (JI, JK+IKL)-PVM (JI, JK))/PDZZ (JI, JK+IKL)))/(1+0.5*ZMIX2 )
      ENDIF

    
    ENDIF

  ENDIF


  DO JSV=1, KSV

    IF (ONOMIXLG.AND.JSV>=KSV_LGBEG.AND.JSV<=KSV_LGEND)  THEN
      CYCLE
    ENDIF


    

    IF (GTEST ) THEN
      PSV_UP (JI, JK+IKL, JSV)=(PSV_UP (JI, JK, JSV)*(1-0.5&
      &*ZMIX2 )+PSVM (JI, JK, JSV)*ZMIX2 )/(1+0.5*ZMIX2 )
    ENDIF

  
  ENDDO


  IF (OENTR_DETR) THEN
    
    ZRC_UP =PRC_UP (JI, JK)
    ZRI_UP =PRI_UP (JI, JK)
    
    
    IB=MERGE (D%NIJB, 1, .TRUE.)
    IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
    JITER=2
    ZBUF (ICPH2)=0
    
    
    
    
    ZBUF (IEXN)=(ZPRES_F (JI, JK+IKL)/CST%XP00)**CST%RDSCPD

    DO J=IB, IE
      ZBUF (I99PP)=0.99*ZPRES_F (JI, JK+IKL)
      ZRV_UP =PRT_UP (JI, JK+IKL)-ZRC_UP -ZRI_UP 
      ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRV_UP +CST%XCL*ZRC_UP +CST%XCI*ZRI_UP +ZBUF (ICPH2)
      ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
      ZDELT=(PTHL_UP (JI, JK+IKL)*ZBUF (IEXN))-CST%XTT
      ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
      ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
      ZTH_UP (JI, JK+IKL)=PTHL_UP (JI, JK+IKL)+ZBUF (ILVOCPEXN)*ZRC_UP +ZBUF (ILSOCPEXN)*ZRI_UP 
      ZBUF (I1PRT)=1+PRT_UP (JI, JK+IKL)
    ENDDO


    DO II=1, JITER
      
      ZBUF (IT)=ZTH_UP (JI, JK+IKL)*ZBUF (IEXN)
      
      PFRAC_ICE_UP (JI, JK+IKL)=0.

      DO J=IB, IE

        IF (ZRC_UP +ZRI_UP >1.E-20) THEN
          PFRAC_ICE_UP (JI, JK+IKL)=ZRI_UP /(ZRC_UP +ZRI_UP )
        ENDIF

      ENDDO


      

      

      

      SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
      CASE ('T')
        PFRAC_ICE_UP (JI, JK+IKL)=MAX (0., MIN (1.,((NEBN%XTMAXMIX&
        &-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
      CASE ('O')
        PFRAC_ICE_UP (JI, JK+IKL)=MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
      CASE ('N')
        PFRAC_ICE_UP (JI, JK+IKL)=0.
      CASE ('S')
        PFRAC_ICE_UP (JI, JK+IKL)=MAX (0., MIN (1., PFRAC_ICE_UP (JI, JK+IKL)))
      CASE DEFAULT
      
      ENDSELECT

      
      
      
      ZBUF (ILOGT)=LOG (ZBUF (IT))

      DO J=IB, IE
        ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
        ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
        ZRSATW =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL)/(1&
        &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL))
        ZRSATI =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL)/(1&
        &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL))
        ZTPOW2=ZBUF (IT)**2
        ZBUF (IDRSATODTW)=ZRSATW /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F&
        & (JI, JK+IKL))*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
        ZBUF (IDRSATODTI)=ZRSATI /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F&
        & (JI, JK+IKL))*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
        ZRSATW =ZRSATW *ZBUF (I1PRT)
        ZRSATI =ZRSATI *ZBUF (I1PRT)
        ZBUF (IRVSAT)=ZRSATW *(1-PFRAC_ICE_UP (JI, JK+IKL))+ZRSATI *PFRAC_ICE_UP (JI, JK+IKL)
        ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-PFRAC_ICE_UP (JI, JK&
        &+IKL))+ZBUF (IDRSATODTI)*PFRAC_ICE_UP (JI, JK+IKL))
        ZBUF (IRLTEMP)=(ZRV_UP -ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN)*(ZBUF (ILVOCPEXN&
        &)*(1-PFRAC_ICE_UP (JI, JK+IKL))+ZBUF (ILSOCPEXN)*PFRAC_ICE_UP (JI, JK+IKL)))
        ZBUF (IRLTEMP)=MIN (MAX (-ZRC_UP -ZRI_UP , ZBUF (IRLTEMP)), ZRV_UP )
        ZRV_UP =ZRV_UP -ZBUF (IRLTEMP)
        ZRC_UP =ZRC_UP +ZRI_UP +ZBUF (IRLTEMP)
        ZRI_UP =PFRAC_ICE_UP (JI, JK+IKL)*(ZRC_UP )
        ZRC_UP =(1-PFRAC_ICE_UP (JI, JK+IKL))*(PRT_UP (JI, JK+IKL)-ZRV_UP )
        ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRV_UP +CST%XCL*ZRC_UP +CST%XCI*ZRI_UP +ZBUF (ICPH2)
        ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
        ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
        ZTH_UP (JI, JK+IKL)=PTHL_UP (JI, JK+IKL)+ZBUF (ILVOCPEXN)*ZRC_UP +ZBUF (ILSOCPEXN)*ZRI_UP 
        ZVAR1=ZTH_UP (JI, JK+IKL)*ZBUF (IEXN)-ZBUF (IT)
        ZRSATW =ZRSATW +ZBUF (IDRSATODTW)*ZVAR1
        ZRSATI =ZRSATI +ZBUF (IDRSATODTI)*ZVAR1
      ENDDO

    ENDDO


    

    

    

    IF (GTEST ) THEN
      PRC_UP (JI, JK+IKL)=ZRC_UP 
      PRV_UP (JI, JK+IKL)=ZRV_UP 
      PRI_UP (JI, JK+IKL)=ZRI_UP 
      PRSAT_UP (JI, JK+IKL)=ZRSATW *(1-PFRAC_ICE_UP (JI, JK+IKL))+ZRSATI *PFRAC_ICE_UP (JI, JK+IKL)
    ENDIF


    IF (GTEST ) THEN
      PTHV_UP (JI, JK+IKL)=ZTH_UP (JI, JK+IKL)*((1+ZRVORD*PRV_UP (JI, JK+IKL))/(1+PRT_UP (JI, JK+IKL)))

      IF (ZBUO_INTEG_DRY (JI, JK)>0.) THEN
        ZW_UP2 (JI, JK+IKL)=ZW_UP2 (JI, JK)+2.*(PARAMMF%XABUO-PARAMMF&
        &%XBENTR*PARAMMF%XENTR_DRY)*ZBUO_INTEG_DRY (JI, JK)
      ELSE
        ZW_UP2 (JI, JK+IKL)=ZW_UP2 (JI, JK)+2.*PARAMMF%XABUO*ZBUO_INTEG_DRY (JI, JK)
      ENDIF

      ZW_UP2 (JI, JK+IKL)=ZW_UP2 (JI, JK+IKL)*(1.-(PARAMMF%XBDETR*ZMIX3_CLD +PARAMMF%XBENTR*ZMIX2_CLD&
      & ))/(1.+(PARAMMF%XBDETR*ZMIX3_CLD +PARAMMF%XBENTR*ZMIX2_CLD ))+2.*(PARAMMF%XABUO)*ZBUO_INTEG_CLD&
      & (JI, JK)/(1.+(PARAMMF%XBDETR*ZMIX3_CLD +PARAMMF%XBENTR*ZMIX2_CLD ))
    ENDIF


    IF (GTEST .AND.(PBUO_INTEG (JI, JK)<=0.)) THEN
      KKETL (JI)=JK+IKL
      GTESTETL =.TRUE.
    ELSE
      GTESTETL =.FALSE.
    ENDIF


    IF (GTEST .AND.((ZW_UP2 (JI, JK+IKL)<=0.).OR.(PEMF (JI, JK+IKL)<=0.))) THEN
      ZW_UP2 (JI, JK+IKL)=0.
      PEMF (JI, JK+IKL)=0.
      GTEST =.FALSE.
      PTHL_UP (JI, JK+IKL)=ZTHLM_F (JI, JK+IKL)
      PRT_UP (JI, JK+IKL)=ZRTM_F (JI, JK+IKL)
      PRC_UP (JI, JK+IKL)=0.
      PRI_UP (JI, JK+IKL)=0.
      PRV_UP (JI, JK+IKL)=0.
      PTHV_UP (JI, JK+IKL)=ZTHVM_F (JI, JK+IKL)
      PFRAC_UP (JI, JK+IKL)=0.
      KKCTL (JI)=JK+IKL
    ENDIF


    IF (GTEST ) THEN
      PFRAC_UP (JI, JK+IKL)=PEMF (JI, JK+IKL)/(SQRT (ZW_UP2 (JI, JK+IKL))*ZRHO_F (JI, JK+IKL))
    ENDIF


    IF (GTEST ) THEN
      PFRAC_UP (JI, JK+IKL)=MIN (PARAMMF%XFRAC_UP_MAX, PFRAC_UP (JI, JK+IKL))
    ENDIF


    IF ((GTEST .AND.GTESTETL ).AND.GTESTLCL ) THEN
      PFRAC_UP (JI, JK+IKL)=MIN (PFRAC_UP (JI, JK+IKL), PFRAC_UP (JI, JK))
    ENDIF


    IF (OENTR_DETR)  THEN
      PEMF (JI, JK+IKL)=PFRAC_UP (JI, JK+IKL)*SQRT (ZW_UP2 (JI, JK+IKL))*ZRHO_F (JI, JK+IKL)
    ENDIF

  
  ENDIF

ENDDO


IF (OENTR_DETR) THEN

  DO JK=1, IKT
    
    PW_UP (JI, JK)=SQRT (ZW_UP2 (JI, JK))
  
  ENDDO

  
  PEMF (JI, IKB)=0.
  
  
  PDEPTH (JI)=MAX (0., PZZ (JI, KKCTL (JI))-PZZ (JI, KKLCL (JI)))
  
  
  GWORK1 =(GTESTLCL .AND.(PDEPTH (JI)>ZDEPTH_MAX1))

  

  DO JK=1, IKT
    
    GWORK2 (JI, JK)=GWORK1 
    ZCOEF (JI, JK)=(1.-(PDEPTH (JI)-ZDEPTH_MAX1)/(ZDEPTH_MAX2-ZDEPTH_MAX1))
    ZCOEF (JI, JK)=MIN (MAX (ZCOEF (JI, JK), 0.), 1.)
  
  ENDDO


  DO JK=1, IKT

    

    IF (GWORK2 (JI, JK)) THEN
      PEMF (JI, JK)=PEMF (JI, JK)*ZCOEF (JI, JK)
      PFRAC_UP (JI, JK)=PFRAC_UP (JI, JK)*ZCOEF (JI, JK)
    ENDIF

  
  ENDDO

ENDIF








END SUBROUTINE COMPUTE_UPDRAFT_OPENACC

ENDMODULE MODE_COMPUTE_UPDRAFT_OPENACC
