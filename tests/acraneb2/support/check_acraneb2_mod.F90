MODULE CHECK_ACRANEB2_MOD

CONTAINS

SUBROUTINE CHECK_ACRANEB2( KLON,KLEV, KGPBLK, &
 & PFRSO,PFRTH, &
 & PFRSODS,PFRSOPS,PFRSOLU,PFRTHDS)

USE MODEL_PHYSICS_MF_MOD , ONLY : MODEL_PHYSICS_MF_TYPE
USE PARKIND1 ,ONLY : JPIM     ,JPRB

USE YOMRIP   ,ONLY : TRIP
USE YOERDI   ,ONLY : TERDI

USE LOAD_ACRANEB2_MOD

IMPLICIT NONE

! arguments
INTEGER(KIND=JPIM), INTENT(IN) :: KLON 
INTEGER(KIND=JPIM), INTENT(IN) :: KLEV
INTEGER(KIND=JPIM), INTENT(IN) :: KGPBLK

REAL(KIND=JPRB) :: PFRSO(KLON,0:KLEV,KGPBLK) 
REAL(KIND=JPRB) :: PFRTH(KLON,0:KLEV,KGPBLK) 
REAL(KIND=JPRB) :: PFRSODS(KLON,KGPBLK) 
REAL(KIND=JPRB) :: PFRSOPS(KLON,KGPBLK) 
REAL(KIND=JPRB) :: PFRSOLU(KLON,KGPBLK) 
REAL(KIND=JPRB) :: PFRTHDS(KLON,KGPBLK) 

CHARACTER(LEN=1024) :: CDNAME_OUT
! data read from datafile
TYPE(TERDI)        :: YDERDI_OUT
TYPE(MODEL_PHYSICS_MF_TYPE) :: YDML_PHY_MF_OUT
TYPE(TRIP)         :: YDRIP_OUT
INTEGER(KIND=JPIM) :: KIDIA_OUT
INTEGER(KIND=JPIM) :: KFDIA_OUT
INTEGER(KIND=JPIM) :: KLON_OUT
INTEGER(KIND=JPIM) :: KTDIA_OUT
INTEGER(KIND=JPIM) :: KLEV_OUT
INTEGER(KIND=JPIM) :: KJN_OUT
INTEGER(KIND=JPIM) :: KSTEP_OUT
INTEGER(KIND=JPIM) :: KGPBLK_OUT
REAL(KIND=JPRB), POINTER    :: PAPRS_OUT(:,:) 
REAL(KIND=JPRB), POINTER    :: PAPRSF_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PCP_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PR_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PDELP_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PNEB_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PQ_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PQCO2_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PQICE_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PQLI_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PQO3_OUT(:,:) 
REAL(KIND=JPRB), POINTER    :: PT_OUT(:,:)
REAL(KIND=JPRB), POINTER    :: PALB_OUT(:)
REAL(KIND=JPRB), POINTER    :: PALBDIR_OUT(:)
REAL(KIND=JPRB), POINTER    :: PEMIS_OUT(:)
REAL(KIND=JPRB), POINTER    :: PGELAM_OUT(:)
REAL(KIND=JPRB), POINTER    :: PGEMU_OUT(:)
REAL(KIND=JPRB), POINTER    :: PMU0_OUT(:)
REAL(KIND=JPRB), POINTER    :: PMU0LU_OUT(:)
REAL(KIND=JPRB), POINTER    :: PTS_OUT(:)
REAL(KIND=JPRB), POINTER    :: PDECRD_OUT(:)
REAL(KIND=JPRB), POINTER    :: PCLCT_OUT(:)
REAL(KIND=JPRB), POINTER :: PGDEOSI_OUT(:,:,:)
REAL(KIND=JPRB), POINTER :: PGUEOSI_OUT(:,:,:)
REAL(KIND=JPRB), POINTER :: PGMU0_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGMU0_MIN_OUT(:)
REAL(KIND=JPRB), POINTER :: PGMU0_MAX_OUT(:)
REAL(KIND=JPRB), POINTER :: PGDEOTI_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGDEOTI2_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGUEOTI_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGUEOTI2_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGEOLT_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGEOXT_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGRPROX_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGMIXP_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGFLUXC_OUT(:,:)
REAL(KIND=JPRB), POINTER :: PGRSURF_OUT(:)
REAL(KIND=JPRB), POINTER :: PSDUR_OUT(:)
REAL(KIND=JPRB), POINTER   :: PFRSO_OUT(:,:) 
REAL(KIND=JPRB), POINTER   :: PFRTH_OUT(:,:) 
REAL(KIND=JPRB), POINTER   :: PFRSODS_OUT(:)
REAL(KIND=JPRB), POINTER   :: PFRSOPS_OUT(:)
REAL(KIND=JPRB), POINTER   :: PFRSOLU_OUT(:)
REAL(KIND=JPRB), POINTER   :: PFRTHDS_OUT(:)
REAL(KIND=JPRB), POINTER    :: PDAER_OUT(:,:,:) 

! other local variables
INTEGER :: JLON, JBLK, JLON_OUT, JLEV
LOGICAL :: LLFIRST, LLALLOK
REAL(KIND=JPRB) :: TOLERANCE=1.E-12

! short notif message
WRITE (*,'(X,A,E8.2)') 'Checking output with tolerance ',TOLERANCE

! load data from input file
CDNAME_OUT='acraneb2.out'
CALL LOAD_ACRANEB2(CDNAME_OUT, &
 & YDERDI_OUT,YDRIP_OUT,YDML_PHY_MF_OUT,KIDIA_OUT,KFDIA_OUT,KLON_OUT,KTDIA_OUT,KLEV_OUT,KJN_OUT,KSTEP_OUT, &
 & PAPRS_OUT,PAPRSF_OUT,PCP_OUT,PR_OUT,PDELP_OUT,PNEB_OUT,PQ_OUT,PQCO2_OUT,PQICE_OUT,PQLI_OUT,PQO3_OUT,PT_OUT, &
 & PALB_OUT,PALBDIR_OUT,PEMIS_OUT,PGELAM_OUT,PGEMU_OUT,PMU0_OUT,PMU0LU_OUT,PTS_OUT,PDECRD_OUT,PCLCT_OUT, &
 & PGDEOSI_OUT,PGUEOSI_OUT,PGMU0_OUT,PGMU0_MIN_OUT,PGMU0_MAX_OUT, &
 & PGDEOTI_OUT,PGDEOTI2_OUT,PGUEOTI_OUT,PGUEOTI2_OUT,PGEOLT_OUT,PGEOXT_OUT, &
 & PGRPROX_OUT,PGMIXP_OUT,PGFLUXC_OUT,PGRSURF_OUT,PSDUR_OUT, &
 & PFRSO_OUT,PFRTH_OUT, &
 & PFRSODS_OUT,PFRSOPS_OUT,PFRSOLU_OUT,PFRTHDS_OUT, &
 & PDAER_OUT)

! check on vertical levels
IF ( KLEV /= KLEV_OUT ) THEN
  WRITE (0,*) 'ERROR: number of vertical levels for this output file must be set to ',KLEV_OUT
  CALL ABORT()
ENDIF

LLALLOK=.TRUE.

! compare output
LLFIRST=.TRUE.

DO JBLK=1,KGPBLK
  DO JLEV=0,KLEV
    DO JLON=1,KLON
      JLON_OUT=MODULO(JLON-1,KLON_OUT)+1
      IF ( .NOT. ( ABS( PFRSO(JLON,JLEV,JBLK) - PFRSO_OUT(JLON_OUT,JLEV) ) / &
       & MAX( ABS( PFRSO(JLON,JLEV,JBLK) ), ABS( PFRSO_OUT(JLON_OUT,JLEV) ) ) &
       & < TOLERANCE ) ) THEN
        IF ( LLFIRST ) THEN
          WRITE (*,*) '  PFRSO :'
          LLFIRST=.FALSE.
          LLALLOK=.FALSE.
        ENDIF
        WRITE (*,'(5X,3I5,3E24.16)') JLON,JLEV,JBLK,PFRSO(JLON,JLEV,JBLK), &
       & PFRSO_OUT(JLON_OUT,JLEV),PFRSO(JLON,JLEV,JBLK) - PFRSO_OUT(JLON_OUT,JLEV)
      ENDIF
    ENDDO
  ENDDO
ENDDO

LLFIRST=.TRUE.
DO JBLK=1,KGPBLK
  DO JLEV=0,KLEV
    DO JLON=1,KLON
      JLON_OUT=MODULO(JLON-1,KLON_OUT)+1
      IF ( .NOT. ( ABS( PFRTH(JLON,JLEV,JBLK) - PFRTH_OUT(JLON_OUT,JLEV) ) / &
       & MAX( ABS( PFRTH(JLON,JLEV,JBLK) ), ABS( PFRTH_OUT(JLON_OUT,JLEV) ) ) &
       & < TOLERANCE ) ) THEN
        IF ( LLFIRST ) THEN
          WRITE (*,*) '  PFRTH :'
          LLFIRST=.FALSE.
          LLALLOK=.FALSE.
        ENDIF
        WRITE (*,'(5X,3I5,3E24.16)') JLON,JLEV,JBLK,PFRTH(JLON,JLEV,JBLK), &
       & PFRTH_OUT(JLON_OUT,JLEV),PFRTH(JLON,JLEV,JBLK) - PFRTH_OUT(JLON_OUT,JLEV)
      ENDIF
    ENDDO
  ENDDO
ENDDO

LLFIRST=.TRUE.
DO JBLK=1,KGPBLK
  DO JLON=1,KLON
    JLON_OUT=MODULO(JLON-1,KLON_OUT)+1
    IF ( .NOT. ( ABS( PFRSODS(JLON,JBLK) - PFRSODS_OUT(JLON_OUT) ) /&
       &  MAX( ABS( PFRSODS(JLON,JBLK) ), ABS( PFRSODS_OUT(JLON_OUT) ) ) &
       & < TOLERANCE ) ) THEN
      IF ( LLFIRST ) THEN
        WRITE (*,*) '  PFRSODS :'
        LLFIRST=.FALSE.
        LLALLOK=.FALSE.
      ENDIF
      WRITE (*,'(5X,2I5,3E24.16)') JLON,JBLK,PFRSODS(JLON,JBLK),&
       & PFRSODS_OUT(JLON_OUT),PFRSODS(JLON,JBLK) - PFRSODS_OUT(JLON_OUT)
    ENDIF
  ENDDO
ENDDO

LLFIRST=.TRUE.
DO JBLK=1,KGPBLK
  DO JLON=1,KLON
    JLON_OUT=MODULO(JLON-1,KLON_OUT)+1
    IF ( .NOT. ( ABS( PFRSOPS(JLON,JBLK) - PFRSOPS_OUT(JLON_OUT) ) / &
       & MAX( ABS( PFRSOPS(JLON,JBLK) ), ABS( PFRSOPS_OUT(JLON_OUT) ) ) &
       & < TOLERANCE ) ) THEN
      IF ( LLFIRST ) THEN
        WRITE (*,*) '  PFRSOPS :'
        LLFIRST=.FALSE.
        LLALLOK=.FALSE.
      ENDIF
      WRITE (*,'(5X,2I5,3E24.16)') JLON,JBLK,PFRSOPS(JLON,JBLK), &
       & PFRSOPS_OUT(JLON_OUT),PFRSOPS(JLON,JBLK) - PFRSOPS_OUT(JLON_OUT)
    ENDIF
  ENDDO
ENDDO

LLFIRST=.TRUE.
DO JBLK=1,KGPBLK
  DO JLON=1,KLON
    JLON_OUT=MODULO(JLON-1,KLON_OUT)+1
    IF ( .NOT. ( ABS( PFRSOLU(JLON,JBLK) - PFRSOLU_OUT(JLON_OUT) ) / &
       & ( TOLERANCE + MAX( ABS( PFRSOLU(JLON,JBLK) ), ABS( PFRSOLU_OUT(JLON_OUT) ) ) )&
       &  < TOLERANCE ) ) THEN
      IF ( LLFIRST ) THEN
        WRITE (*,*) '  PFRSOLU :'
        LLFIRST=.FALSE.
        LLALLOK=.FALSE.
      ENDIF
      WRITE (*,'(5X,2I5,3E24.16)') JLON,JBLK,PFRSOLU(JLON,JBLK), &
       & PFRSOLU_OUT(JLON_OUT),PFRSOLU(JLON,JBLK) - PFRSOLU_OUT(JLON_OUT)
    ENDIF
  ENDDO
ENDDO

LLFIRST=.TRUE.
DO JBLK=1,KGPBLK
  DO JLON=1,KLON
    JLON_OUT=MODULO(JLON-1,KLON_OUT)+1
    IF ( .NOT. ( ABS( PFRTHDS(JLON,JBLK) - PFRTHDS_OUT(JLON_OUT) ) / &
       & MAX( ABS( PFRTHDS(JLON,JBLK) ), ABS( PFRTHDS_OUT(JLON_OUT) ) ) &
       & < TOLERANCE ) ) THEN
      IF ( LLFIRST ) THEN
        WRITE (*,*) '  PFRTHDS :'
        LLFIRST=.FALSE.
        LLALLOK=.FALSE.
      ENDIF
      WRITE (*,'(5X,2I5,3E24.16)') JLON,JBLK,PFRTHDS(JLON,JBLK), &
       & PFRTHDS_OUT(JLON_OUT),PFRTHDS(JLON,JBLK) - PFRTHDS_OUT(JLON_OUT)
    ENDIF
  ENDDO
ENDDO

IF ( LLALLOK ) THEN
  WRITE (*,*) '  all ok.'
ENDIF

! free memory
IF ( ASSOCIATED(PAPRS_OUT) ) DEALLOCATE(PAPRS_OUT)
IF ( ASSOCIATED(PAPRSF_OUT) ) DEALLOCATE(PAPRSF_OUT)
IF ( ASSOCIATED(PCP_OUT) ) DEALLOCATE(PCP_OUT)
IF ( ASSOCIATED(PR_OUT) ) DEALLOCATE(PR_OUT)
IF ( ASSOCIATED(PDELP_OUT) ) DEALLOCATE(PDELP_OUT)
IF ( ASSOCIATED(PNEB_OUT) ) DEALLOCATE(PNEB_OUT)
IF ( ASSOCIATED(PQ_OUT) ) DEALLOCATE(PQ_OUT)
IF ( ASSOCIATED(PQCO2_OUT) ) DEALLOCATE(PQCO2_OUT)
IF ( ASSOCIATED(PQICE_OUT) ) DEALLOCATE(PQICE_OUT)
IF ( ASSOCIATED(PQLI_OUT) ) DEALLOCATE(PQLI_OUT)
IF ( ASSOCIATED(PQO3_OUT) ) DEALLOCATE(PQO3_OUT)
IF ( ASSOCIATED(PT_OUT) ) DEALLOCATE(PT_OUT)
IF ( ASSOCIATED(PALB_OUT) ) DEALLOCATE(PALB_OUT)
IF ( ASSOCIATED(PALBDIR_OUT) ) DEALLOCATE(PALBDIR_OUT)
IF ( ASSOCIATED(PEMIS_OUT) ) DEALLOCATE(PEMIS_OUT)
IF ( ASSOCIATED(PGELAM_OUT) ) DEALLOCATE(PGELAM_OUT)
IF ( ASSOCIATED(PGEMU_OUT) ) DEALLOCATE(PGEMU_OUT)
IF ( ASSOCIATED(PMU0_OUT) ) DEALLOCATE(PMU0_OUT)
IF ( ASSOCIATED(PMU0LU_OUT) ) DEALLOCATE(PMU0LU_OUT)
IF ( ASSOCIATED(PTS_OUT) ) DEALLOCATE(PTS_OUT)
IF ( ASSOCIATED(PDECRD_OUT) ) DEALLOCATE(PDECRD_OUT)
IF ( ASSOCIATED(PCLCT_OUT) ) DEALLOCATE(PCLCT_OUT)
IF ( ASSOCIATED(PGDEOSI_OUT) ) DEALLOCATE(PGDEOSI_OUT)
IF ( ASSOCIATED(PGUEOSI_OUT) ) DEALLOCATE(PGUEOSI_OUT)
IF ( ASSOCIATED(PGMU0_OUT) ) DEALLOCATE(PGMU0_OUT)
IF ( ASSOCIATED(PGMU0_MIN_OUT) ) DEALLOCATE(PGMU0_MIN_OUT)
IF ( ASSOCIATED(PGMU0_MAX_OUT) ) DEALLOCATE(PGMU0_MAX_OUT)
IF ( ASSOCIATED(PGDEOTI_OUT) ) DEALLOCATE(PGDEOTI_OUT)
IF ( ASSOCIATED(PGDEOTI2_OUT) ) DEALLOCATE(PGDEOTI2_OUT)
IF ( ASSOCIATED(PGUEOTI_OUT) ) DEALLOCATE(PGUEOTI_OUT)
IF ( ASSOCIATED(PGUEOTI2_OUT) ) DEALLOCATE(PGUEOTI2_OUT)
IF ( ASSOCIATED(PGEOLT_OUT) ) DEALLOCATE(PGEOLT_OUT)
IF ( ASSOCIATED(PGEOXT_OUT) ) DEALLOCATE(PGEOXT_OUT)
IF ( ASSOCIATED(PGRPROX_OUT) ) DEALLOCATE(PGRPROX_OUT)
IF ( ASSOCIATED(PGMIXP_OUT) ) DEALLOCATE(PGMIXP_OUT)
IF ( ASSOCIATED(PGFLUXC_OUT) ) DEALLOCATE(PGFLUXC_OUT)
IF ( ASSOCIATED(PGRSURF_OUT) ) DEALLOCATE(PGRSURF_OUT)
IF ( ASSOCIATED(PSDUR_OUT) ) DEALLOCATE(PSDUR_OUT)
IF ( ASSOCIATED(PFRSO_OUT) ) DEALLOCATE(PFRSO_OUT)
IF ( ASSOCIATED(PFRTH_OUT) ) DEALLOCATE(PFRTH_OUT)
IF ( ASSOCIATED(PFRSODS_OUT) ) DEALLOCATE(PFRSODS_OUT)
IF ( ASSOCIATED(PFRSOPS_OUT) ) DEALLOCATE(PFRSOPS_OUT)
IF ( ASSOCIATED(PFRSOLU_OUT) ) DEALLOCATE(PFRSOLU_OUT)
IF ( ASSOCIATED(PFRTHDS_OUT) ) DEALLOCATE(PFRTHDS_OUT)
IF ( ASSOCIATED(PDAER_OUT) ) DEALLOCATE(PDAER_OUT)

END SUBROUTINE CHECK_ACRANEB2

END MODULE CHECK_ACRANEB2_MOD
