
SUBROUTINE CUASCN_OPENACC (YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF, YDSPP_CONFIG, YGFL, KIDIA&
&, KFDIA, KLON, KLEV, LDTDKMF, PTSPHY, PTENH, PQENH, PUEN, PVEN, PTEN, PQEN, PQSEN, PLITOT, PGEO&
&, PGEOH, PAP, PAPH, PVERVEL, PWUBASE, PGP2DSPP, LDLAND, LDCUM, KTYPE, KLAB, LSCVFLAG, PTU, PQU&
&, PLU, PLRAIN, PMFU, PMFUB, PLGLAC, PMFUS, PMFUQ, PMFUL, PLUDE, PLUDELI, PDMFUP, PLCRIT_AER&
&, PDMFEN, KCBOT, KCTOP, KCTOP0, KDPL, PMFUDE_RATE, PKINEU, PWU, PWMEAN, YDSTACK)
!$ACC ROUTINE (CUASCN_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
USE YOECLDP,ONLY:TECLDP
USE YOM_YGFL,ONLY:TYPE_GFLD
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PWUBASE (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
LOGICAL, INTENT (IN)::LDLAND (KLON)
LOGICAL, INTENT (INOUT)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
LOGICAL, INTENT (OUT)::LSCVFLAG (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KLAB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUB (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PDMFUP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDMFEN (KLON, KLEV)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (INOUT)::KCTOP0 (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KDPL (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PKINEU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZLUOLD 
fxtran_acdc_temp (REAL (KIND=JPRB), ZBUO, (KLON, KLEV))
REAL (KIND=JPRB)::ZPRECIP 
REAL (KIND=JPRB)::ZQOLD 
REAL (KIND=JPRB)::ZDMFDE 
REAL (KIND=JPRB)::ZDMFEN 
REAL (KIND=JPRB)::ZDPMEAN 
REAL (KIND=JPRB)::ZPH 
REAL (KIND=JPRB)::ZOENTR 
LOGICAL::LLO3
LOGICAL::LLO1 
LOGICAL::LLFLAGUV 
LOGICAL::LLFLAG 
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JLX 
INTEGER (KIND=JPIM)::JLM
INTEGER (KIND=JPIM)::JLL
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZOCUDET
REAL (KIND=JPRB)::ZZCO
REAL (KIND=JPRB)::ZVW
REAL (KIND=JPRB)::ZVV
REAL (KIND=JPRB)::ZVI
REAL (KIND=JPRB)::ZSEEN
REAL (KIND=JPRB)::ZSCDE
REAL (KIND=JPRB)::ZROLD
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZQUDE
REAL (KIND=JPRB)::ZQEEN
REAL (KIND=JPRB)::ZPRCON
REAL (KIND=JPRB)::ZPRCDGW
REAL (KIND=JPRB)::ZOEALFAP
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZMFUSK
REAL (KIND=JPRB)::ZMFUQK
REAL (KIND=JPRB)::ZMFUN
REAL (KIND=JPRB)::ZMFULK
REAL (KIND=JPRB)::ZMFTEST
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZLNEW
REAL (KIND=JPRB)::ZLEEN
REAL (KIND=JPRB)::ZLCRIT
REAL (KIND=JPRB)::ZKEDKE
REAL (KIND=JPRB)::ZINT
REAL (KIND=JPRB)::ZFACBUO
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDT
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZDNOPRC
REAL (KIND=JPRB)::ZDKEN
REAL (KIND=JPRB)::ZDKBUO
REAL (KIND=JPRB)::ZDFI
REAL (KIND=JPRB)::ZD
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCBF
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZBUOC
REAL (KIND=JPRB)::ZBE
REAL (KIND=JPRB)::ZBC
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::Z_CWIFRAC
REAL (KIND=JPRB)::Z_CWDRAG
REAL (KIND=JPRB)::Z_CPRC2
REAL (KIND=JPRB)::Z_CLDMAX
REAL (KIND=JPRB)::ZXPRCDGW
REAL (KIND=JPRB)::ZXENTSHALP
REAL (KIND=JPRB)::ZXENTRORG
LOGICAL::LLPERT_RPRCON
LOGICAL::LLPERT_ENTSHALP
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::IPRPRCON
INTEGER (KIND=JPIM)::IPENTSHALP
INTEGER (KIND=JPIM)::IPENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1RPRCON
TYPE (SPP_PERT)::PN1ENTSHALP
TYPE (SPP_PERT)::PN1ENTRORG
REAL (KIND=JPRB)::ZXE
REAL (KIND=JPRB)::ZXS
REAL (KIND=JPRB)::ZCHANGE

LOGICAL::LLKLAB 
#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ000
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG_CUADJTQ000 

#include "cuadjtq.func.h"
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ001
LOGICAL::LLFLAG_CUADJTQ001 
REAL (KIND=JPRB)::ZORCPD_CUBASMCN
REAL (KIND=JPRB)::ZRG_CUBASMCN
REAL (KIND=JPRB)::ZZZMB
LOGICAL::LLO1_CUENTR
LOGICAL::LLPERT_DETRPEN
INTEGER (KIND=JPIM)::IPDETRPEN
INTEGER (KIND=JPIM)::IPN_CUENTR
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZXDETRPEN
REAL (KIND=JPRB)::ZRG_CUENTR
REAL (KIND=JPRB)::ZMF
REAL (KIND=JPRB)::ZENTR 
REAL (KIND=JPRB)::ZDZ

YLSTACK = YDSTACK



IF (KIND (ZBUO) == 8) THEN
    fxtran_acdc_alloc8 (ZBUO)
ELSEIF (KIND (ZBUO) == 4) THEN
    fxtran_acdc_alloc4 (ZBUO)
ELSE
    STOP 1
ENDIF


JL = KIDIA



ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZRG=1.0_JPRB/YDCST%RG
ZORCPD=1.0_JPRB/YDCST%RCPD
ZFACBUO=0.5_JPRB/1.5
ZPRCDGW=YDECUMF%RPRCON/YDCST%RG
ZDNOPRC=3.E-4_JPRB
Z_CLDMAX=5.E-3_JPRB
Z_CWIFRAC=0.5_JPRB
Z_CPRC2=0.5_JPRB
Z_CWDRAG=(3._JPRB/8._JPRB)*0.506_JPRB/0.2_JPRB

IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=1.0_JPRB
ELSE
  ZGLAC=0.0_JPRB
ENDIF

LLO3=.FALSE.

ZLUOLD =0.0_JPRB

IF (.NOT.LDCUM (JL)) THEN
  KCBOT (JL)=-1
  PMFUB (JL)=0.0_JPRB
  PQU (JL, KLEV)=0.0_JPRB
  KTYPE (JL)=0
ENDIF

PWMEAN (JL)=0.0_JPRB
ZDPMEAN =0.0_JPRB
ZOENTR =0.0_JPRB
LSCVFLAG (JL)=.FALSE.

IF (KTYPE (JL)>1.AND.YDECUMF%LSCVLIQ)  THEN
  LSCVFLAG (JL)=.TRUE.
ENDIF



LLPERT_ENTRORG=.FALSE.
LLPERT_ENTSHALP=.FALSE.
LLPERT_RPRCON=.FALSE.


LLKLAB =.FALSE.

IF (.NOT.LDCUM (JL).OR.KTYPE (JL)==3)  THEN
  LLKLAB =.TRUE.
ENDIF



DO JK=1, KLEV

  

  IF (JK/=KCBOT (JL)) THEN
    PLU (JL, JK)=0.0_JPRB
  ENDIF

  PKINEU (JL, JK)=0.0_JPRB
  
  
  PMFU (JL, JK)=0.0_JPRB
  PMFUS (JL, JK)=0.0_JPRB
  PMFUQ (JL, JK)=0.0_JPRB
  PMFUL (JL, JK)=0.0_JPRB
  PWU (JL, JK)=0.0_JPRB
  
  
  PLUDE (JL, JK)=0.0_JPRB
  PLUDELI (JL, JK, 1)=0.0_JPRB
  PLUDELI (JL, JK, 2)=0.0_JPRB
  PLGLAC (JL, JK)=0.0_JPRB
  PDMFUP (JL, JK)=0.0_JPRB
  PLRAIN (JL, JK)=0.0_JPRB
  
  
  ZBUO (JL, JK)=0.0_JPRB

  IF (LLKLAB )  THEN
    KLAB (JL, JK)=0
  ENDIF


  IF (.NOT.LDCUM (JL).AND.PAPH (JL, JK)<4.E4_JPRB)  THEN
    KCTOP0 (JL)=JK
  ENDIF

  PDMFEN (JL, JK)=0.0_JPRB
  PMFUDE_RATE (JL, JK)=0.0_JPRB
  
ENDDO



IF (KTYPE (JL)==3)  THEN
  LDCUM (JL)=.FALSE.
ENDIF



KCTOP (JL)=KCBOT (JL)

IF (LDCUM (JL)) THEN
  IKB=KCBOT (JL)
  PKINEU (JL, IKB)=0.5*PWUBASE (JL)**2
  PMFU (JL, IKB)=PMFUB (JL)
  PMFUS (JL, IKB)=PMFUB (JL)*(YDCST%RCPD*PTU (JL, IKB)+PGEOH (JL, IKB))
  PMFUQ (JL, IKB)=PMFUB (JL)*PQU (JL, IKB)
  PMFUL (JL, IKB)=PMFUB (JL)*PLU (JL, IKB)
ENDIF



DO JK=KLEV-1, 3,-1
  IK=JK
  
  
  ZRG_CUBASMCN=1.0_JPRB/YDCST%RG
  ZORCPD_CUBASMCN=1.0_JPRB/YDCST%RCPD

  

  IF (.NOT.LDCUM (JL).AND.KLAB (JL, IK+1)==0) THEN

    IF (YDECUMF%LMFMID.AND.IK>YDECUMF%NJKT7.AND.PQEN (JL, IK)>0.80_JPRB*PQSEN (JL, IK)) THEN
      PTU (JL, IK+1)=(YDCST%RCPD*PTEN (JL, IK)+PGEO (JL, IK)-PGEOH (JL, IK+1))*ZORCPD_CUBASMCN
      PQU (JL, IK+1)=PQEN (JL, IK)
      PLU (JL, IK+1)=0.0_JPRB
      ZZZMB=MAX (1.E-6_JPRB,-PVERVEL (JL, IK)*ZRG_CUBASMCN)
      ZZZMB=MIN (ZZZMB, YDECUMF%RMFLIA)
      PMFUB (JL)=ZZZMB
      PMFU (JL, IK+1)=PMFUB (JL)
      PMFUS (JL, IK+1)=PMFUB (JL)*(YDCST%RCPD*PTU (JL, IK+1)+PGEOH (JL, IK+1))
      PMFUQ (JL, IK+1)=PMFUB (JL)*PQU (JL, IK+1)
      PMFUL (JL, IK+1)=0.0_JPRB
      PDMFUP (JL, IK+1)=0.0_JPRB
      PLRAIN (JL, IK+1)=0.0_JPRB
      KCBOT (JL)=IK
      KLAB (JL, IK+1)=1
      KTYPE (JL)=3
    ENDIF

  ENDIF

  
  
  
  
  IS=0
  JLM=0
  
  LLFLAG =.FALSE.
  ZPRECIP =0.0_JPRB
  LLO1 =.FALSE.
  IS=IS+KLAB (JL, JK+1)

  IF (KLAB (JL, JK+1)==0)  THEN
    KLAB (JL, JK)=0
  ENDIF


  IF ((LDCUM (JL).AND.KLAB (JL, JK+1)==2).OR.(KTYPE (JL)==3.AND.KLAB (JL, JK+1)==1)) THEN
    LLFLAG =.TRUE.
    JLM=JLM+1
    JLX =JL
  ENDIF


  IF (KLAB (JL, JK+1)>0) THEN
    LLFLAGUV =.TRUE.
  ELSE
    LLFLAGUV =.FALSE.
  ENDIF

  ZPH =PAPH (JL, JK)

  IF (KTYPE (JL)==3.AND.JK==KCBOT (JL)) THEN
    ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS2

    IF (PMFUB (JL)>ZMFMAX) THEN
      ZFAC=ZMFMAX/PMFUB (JL)
      PMFU (JL, JK+1)=PMFU (JL, JK+1)*ZFAC
      PMFUS (JL, JK+1)=PMFUS (JL, JK+1)*ZFAC
      PMFUQ (JL, JK+1)=PMFUQ (JL, JK+1)*ZFAC
      PMFUB (JL)=ZMFMAX
    ENDIF

  ENDIF


  

  IF (IS>0)  THEN
    LLO3=.TRUE.
  ENDIF

  IK=JK

  

  

  IF (LLO3) THEN
    ZRG_CUENTR=1.0_JPRB/YDCST%RG
    
    LLPERT_DETRPEN=.FALSE.
    
    
    ZDMFEN =0.0_JPRB
    ZDMFDE =0.0_JPRB
    ZENTR =0.0

    

    

    IF (LDCUM (JL)) THEN
      ZDZ=(PGEOH (JL, IK)-PGEOH (JL, IK+1))*ZRG_CUENTR
      ZMF=PMFU (JL, IK+1)*ZDZ
      LLO1_CUENTR=IK<KCBOT (JL)

      IF (LLO1_CUENTR) THEN
        
        ZXDETRPEN=YDECUMF%DETRPEN
        
        ZDMFEN =ZENTR *ZMF
        ZDMFDE =ZXDETRPEN*ZMF
      ENDIF

    ENDIF

  
  ENDIF


  

  

  

  IF (LLO3) THEN
    
    ZQOLD =0.0_JPRB

    

    DO JLL=1, JLM
      JL=JLX 
      ZDMFDE =MIN (ZDMFDE , 0.75_JPRB*PMFU (JL, JK+1))

      IF (JK==KCBOT (JL)) THEN
        
        ZXENTRORG=YDECUMF%ENTRORG
        
        ZOENTR =-ZXENTRORG*(MIN (1.0_JPRB, PQEN (JL, JK)/PQSEN (JL, JK&
        &))-YDECUMF%ENTR_RH)*(PGEOH (JL, JK)-PGEOH (JL, JK+1))*ZRG
        ZOENTR =MIN (0.4_JPRB, ZOENTR )*PMFU (JL, JK+1)
      ENDIF


      IF (JK<KCBOT (JL)) THEN
        ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS2
        ZXS=MAX (PMFU (JL, JK+1)-ZMFMAX, 0.0_JPRB)
        PWMEAN (JL)=PWMEAN (JL)+PKINEU (JL, JK+1)*(PAP (JL, JK+1)-PAP (JL, JK))
        ZDPMEAN =ZDPMEAN +PAP (JL, JK+1)-PAP (JL, JK)
        ZDMFEN =ZOENTR 

        IF (KTYPE (JL)>=2) THEN
          
          ZXENTSHALP=YDECUMF%ENTSHALP
          
          ZDMFEN =ZXENTSHALP*ZDMFEN 
          ZDMFDE =ZDMFEN 
        ENDIF

        ZDMFDE =ZDMFDE *(1.6_JPRB-MIN (1.0_JPRB, PQEN (JL, JK)/PQSEN (JL, JK)))
        ZMFTEST=PMFU (JL, JK+1)+ZDMFEN -ZDMFDE 
        ZCHANGE=MAX (ZMFTEST-ZMFMAX, 0.0_JPRB)
        ZXE=MAX (ZCHANGE-ZXS, 0.0_JPRB)
        ZDMFEN =ZDMFEN -ZXE
        ZCHANGE=ZCHANGE-ZXE
        ZDMFDE =ZDMFDE +ZCHANGE
      ENDIF

      PDMFEN (JL, JK)=ZDMFEN -ZDMFDE 
      PMFU (JL, JK)=PMFU (JL, JK+1)+ZDMFEN -ZDMFDE 
      ZQEEN=PQENH (JL, JK+1)*ZDMFEN 
      ZSEEN=(YDCST%RCPD*PTENH (JL, JK+1)+PGEOH (JL, JK+1))*ZDMFEN 

      IF (PLITOT (JL, JK)>YDECLDP%RLMIN) THEN
        ZLEEN=PLITOT (JL, JK)*ZDMFEN 
      ELSE
        ZLEEN=0.0_JPRB
      ENDIF

      ZSCDE=(YDCST%RCPD*PTU (JL, JK+1)+PGEOH (JL, JK+1))*ZDMFDE 
      ZQUDE=PQU (JL, JK+1)*ZDMFDE 
      PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE 
      ZMFUSK=PMFUS (JL, JK+1)+ZSEEN-ZSCDE
      ZMFUQK=PMFUQ (JL, JK+1)+ZQEEN-ZQUDE
      ZMFULK=PMFUL (JL, JK+1)+ZLEEN-PLUDE (JL, JK)
      ZFAC=1.0_JPRB/MAX (YDECUMF%RMFCMIN, PMFU (JL, JK))
      PLU (JL, JK)=ZMFULK*ZFAC
      PQU (JL, JK)=ZMFUQK*ZFAC
      PTU (JL, JK)=(ZMFUSK*ZFAC-PGEOH (JL, JK))*ZORCPD
      PTU (JL, JK)=MAX (100._JPRB, PTU (JL, JK))
      PTU (JL, JK)=MIN (400._JPRB, PTU (JL, JK))
      ZQOLD =PQU (JL, JK)
      PLRAIN (JL, JK)=PLRAIN (JL, JK+1)*MAX (0.0_JPRB, PMFU (JL, JK+1)-ZDMFDE )*ZFAC
      ZLUOLD =PLU (JL, JK)
    ENDDO


    

    IF (JK>KDPL (JL)) THEN
      PTU (JL, JK)=PTENH (JL, JK)
      PQU (JL, JK)=PQENH (JL, JK)
      PLU (JL, JK)=0.0_JPRB
      ZLUOLD =PLU (JL, JK)
    ENDIF

    
    IK=JK

    IF (JLM>0) THEN

      IF (YDECUMF%LSCVLIQ) THEN
        
        
        ZQMAX=0.5_JPRB

        IF (.NOT.YDEPHLI%LPHYLIN) THEN
          
          LLFLAG_CUADJTQ000 =LLFLAG 
          
          
          LLFLAG_CUADJTQ000 =LLFLAG_CUADJTQ000 .AND..NOT.LSCVFLAG (JL)

          

          

          

          IF (LLFLAG_CUADJTQ000 ) THEN
            ZQP=1.0_JPRB/ZPH 
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND
            PQU (JL, IK)=PQU (JL, IK)-ZCOND
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND1=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND1
            PQU (JL, IK)=PQU (JL, IK)-ZCOND1
          ENDIF


          

          

          

          IF (LLFLAG .AND.LSCVFLAG (JL)) THEN
            ZQP=1.0_JPRB/ZPH 
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL)
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=YDTHF%R5ALVCP*ZL**2
            ZCOND=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            PTU (JL, IK)=PTU (JL, IK)+YDTHF%RALVDCP*ZCOND
            PQU (JL, IK)=PQU (JL, IK)-ZCOND
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL)
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=YDTHF%R5ALVCP*ZL**2
            ZCOND1=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            PTU (JL, IK)=PTU (JL, IK)+YDTHF%RALVDCP*ZCOND1
            PQU (JL, IK)=PQU (JL, IK)-ZCOND1
          ENDIF

        
        
        
        
        
        
        
        
        ELSE
        
        
        
        
        ENDIF

      
      
      
      ELSE
        
        
        ZQMAX=0.5_JPRB

        IF (.NOT.YDEPHLI%LPHYLIN) THEN
          
          LLFLAG_CUADJTQ001 =LLFLAG 

          

          

          IF (LLFLAG_CUADJTQ001 ) THEN
            ZQP=1.0_JPRB/ZPH 
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=MIN (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
            ZCOND=MAX (ZCOND, 0.0_JPRB)
            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND
            PQU (JL, IK)=PQU (JL, IK)-ZCOND
            ZL=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4LES)
            ZI=1.0_JPRB/(PTU (JL, IK)-YDTHF%R4IES)
            ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JL, IK))*EXP (YDTHF%R3LES*(PTU (JL, IK)-YDCST%RTT)*ZL&
            &)+(1.0_JPRB-FOEALFCU (PTU (JL, IK)))*EXP (YDTHF%R3IES*(PTU (JL, IK)-YDCST%RTT)*ZI))
            ZQSAT=ZQSAT*ZQP
            ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
            ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
            ZF=FOEALFCU (PTU (JL, IK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
            &-FOEALFCU (PTU (JL, IK)))*YDTHF%R5ALSCP*ZI**2
            ZCOND1=(PQU (JL, IK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

            IF (ZCOND==0.0_JPRB)  THEN
              ZCOND1=0.0_JPRB
            ENDIF

            PTU (JL, IK)=PTU (JL, IK)+FOELDCPMCU (PTU (JL, IK))*ZCOND1
            PQU (JL, IK)=PQU (JL, IK)-ZCOND1
          ENDIF

        
        
        
        
        
        
        
        
        ELSE

          

          

          IF (LLFLAG ) THEN
            ZQP=1.0_JPRB/ZPH 
            ZTARG=PTU (JL, IK)
            ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
            ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
            ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
            ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
            Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
            ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
            ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
            ZQSAT=ZQSAT*ZCOR
            Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
            &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
            ZCOND=(PQU (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
            ZCOND=MAX (ZCOND, 0.0_JPRB)

            IF (ZCOND/=0.0_JPRB) THEN
              PTU (JL, IK)=PTU (JL, IK)+(ZOEALFA_CUADJTQ001*YDTHF%RALVDCP&
              &+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND
              PQU (JL, IK)=PQU (JL, IK)-ZCOND
              ZTARG=PTU (JL, IK)
              ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
              ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
              ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
              ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
              Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
              ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
              ZQSAT=ZQSAT*ZCOR
              Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
              &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
              ZCOND1=(PQU (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
              PTU (JL, IK)=PTU (JL, IK)+(ZOEALFA_CUADJTQ001*YDTHF%RALVDCP&
              &+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND1
              PQU (JL, IK)=PQU (JL, IK)-ZCOND1
            ENDIF

          ENDIF

        
        
        
        
        
        ENDIF

      
      
      
      ENDIF

    ENDIF


    IF (YDEPHLI%LPHYLIN) THEN

      DO JLL=1, JLM
        JL=JLX 

        IF (PQU (JL, JK)/=ZQOLD ) THEN
          ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
          ZOEALFAP=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK+1)-YDEPHLI%RLPTRC))+1.0_JPRB))
          PLGLAC (JL, JK)=PLU (JL, JK)*((1.0_JPRB-ZOEALFA)-(1.0_JPRB-ZOEALFAP))
          ZFAC=0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB)
          PLGLAC (JL, JK)=PLGLAC (JL, JK)+ZFAC*PDMFUP (JL, JK+1)/MAX (YDECUMF%RMFCMIN, PMFU&
          & (JL, JK+1))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JL, JK)))*ZGLAC
          PTU (JL, JK)=PTU (JL, JK)+YDTHF%RALFDCP*PLGLAC (JL, JK)
        ENDIF

      ENDDO

    ELSE

      DO JLL=1, JLM
        JL=JLX 

        IF (PQU (JL, JK)/=ZQOLD ) THEN
          PLGLAC (JL, JK)=PLU (JL, JK)*((1.0_JPRB-FOEALFCU (PTU&
          & (JL, JK)))-(1.0_JPRB-FOEALFCU (PTU (JL, JK+1))))

          IF (LSCVFLAG (JL))  THEN
            PLGLAC (JL, JK)=0.0_JPRB
          ENDIF

          ZFAC=FOEALFCU (PTEN (JL, JK))
          PLGLAC (JL, JK)=PLGLAC (JL, JK)+ZFAC*PDMFUP (JL, JK+1)/MAX (YDECUMF%RMFCMIN, PMFU&
          & (JL, JK+1))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JL, JK)))*ZGLAC
          PTU (JL, JK)=PTU (JL, JK)+YDTHF%RALFDCP*PLGLAC (JL, JK)
        ENDIF

      ENDDO

    ENDIF


    DO JLL=1, JLM
      JL=JLX 

      IF (PQU (JL, JK)/=ZQOLD ) THEN
        KLAB (JL, JK)=2
        PLU (JL, JK)=PLU (JL, JK)+ZQOLD -PQU (JL, JK)
        ZBC=PTU (JL, JK)*(1.0_JPRB+YDCST%RETV*PQU (JL, JK)-PLU (JL, JK+1)-PLRAIN (JL, JK+1))
        ZBE=PTENH (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK))
        ZBUO (JL, JK)=ZBC-ZBE

        IF (KTYPE (JL)==3.AND.KLAB (JL, JK+1)==1) THEN

          IF (ZBUO (JL, JK)>-0.5_JPRB) THEN
            LDCUM (JL)=.TRUE.
            KCTOP (JL)=JK
            PKINEU (JL, JK)=0.5_JPRB
          ELSE
            KLAB (JL, JK)=0
            PMFU (JL, JK)=0.0_JPRB
            PLUDE (JL, JK)=0.0_JPRB
            PLU (JL, JK)=0.0_JPRB
          ENDIF

        ENDIF


        IF (KLAB (JL, JK+1)==2) THEN

          IF (ZBUO (JL, JK)<-0.1_JPRB) THEN
            PTENH (JL, JK)=0.5_JPRB*(PTEN (JL, JK)+PTEN (JL, JK-1))
            PQENH (JL, JK)=0.5_JPRB*(PQEN (JL, JK)+PQEN (JL, JK-1))
            ZBUO (JL, JK)=ZBC-PTENH (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK))
          ENDIF

          ZBUOC=0.5*(ZBUO (JL, JK)+ZBUO (JL, JK+1))/(PTENH (JL, JK)*(1.0_JPRB+YDCST%RETV*PQENH (JL, JK)))
          ZDKBUO=(PGEOH (JL, JK)-PGEOH (JL, JK+1))*ZFACBUO*ZBUOC

          IF (ZDMFEN >0.0_JPRB) THEN
            ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFEN /MAX (YDECUMF%RMFCMIN, PMFU (JL, JK+1)))
          ELSE
            ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFDE /MAX (YDECUMF%RMFCMIN, PMFU (JL, JK+1)))
          ENDIF


          IF (LDTDKMF) THEN
            PKINEU (JL, JK)=(PKINEU (JL, JK+1)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN)
            ZBUOC=ZBUO (JL, JK)
          ELSE
            PKINEU (JL, JK)=MAX (-1.E3_JPRB,(PKINEU (JL, JK+1)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN))
          ENDIF


          IF (ZBUOC<0.0_JPRB) THEN
            ZKEDKE=PKINEU (JL, JK)/MAX (1.E-3_JPRB, PKINEU (JL, JK+1))
            ZKEDKE=MAX (0.0_JPRB, MIN (1.0_JPRB, ZKEDKE))
            ZOCUDET=(1.6_JPRB-MIN (1.0_JPRB, PQEN (JL, JK)/PQSEN (JL, JK)))
            ZMFUN=ZOCUDET*SQRT (ZKEDKE)
            ZDMFDE =MAX (ZDMFDE , PMFU (JL, JK+1)*(1.0_JPRB-ZMFUN))
            PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE 
            PMFU (JL, JK)=PMFU (JL, JK+1)+ZDMFEN -ZDMFDE 
          ENDIF


          IF (ZBUO (JL, JK)>-0.2_JPRB) THEN
            IKB=KCBOT (JL)
            
            ZXENTRORG=YDECUMF%ENTRORG
            
            ZOENTR =ZXENTRORG*(0.3_JPRB-(MIN (1.0_JPRB, PQEN (JL, JK-1)/PQSEN (JL, JK-1))-YDECUMF%ENTR_RH&
            &))*(PGEOH (JL, JK-1)-PGEOH (JL, JK))*ZRG*MIN (1.0_JPRB, PQSEN (JL, JK)/PQSEN (JL, IKB))**3
            ZOENTR =MIN (0.4_JPRB, ZOENTR )*PMFU (JL, JK)
          ELSE
            ZOENTR =0.0_JPRB
          ENDIF


          IF (JK>KDPL (JL)) THEN
            PMFU (JL, JK)=PMFU (JL, JK+1)
            PKINEU (JL, JK)=0.5_JPRB
          ENDIF


          IF (PKINEU (JL, JK)>0.0_JPRB.AND.PMFU (JL, JK)>0.0_JPRB.AND.(ZBUO (JL, JK)>-2._JPRB.OR.(PTEN&
            & (JL, JK-1)-PTEN (JL, JK))/(ZRG*(PGEO (JL, JK-1)-PGEO (JL, JK)))<-3.E-3_JPRB)) THEN
            KCTOP (JL)=JK
            LLO1 =.TRUE.
          ELSE
            KLAB (JL, JK)=0
            PMFU (JL, JK)=0.0_JPRB
            PKINEU (JL, JK)=0.0_JPRB
            ZDMFDE =PMFU (JL, JK+1)
            PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE 
          ENDIF


          IF (PMFU (JL, JK+1)>0.0_JPRB) THEN
            PMFUDE_RATE (JL, JK)=ZDMFDE 
          ENDIF

        ENDIF

      ELSEIF (KTYPE (JL)==2.AND.PQU (JL, JK)==ZQOLD ) THEN
        KLAB (JL, JK)=0
        PMFU (JL, JK)=0.0_JPRB
        PKINEU (JL, JK)=0.0_JPRB
        ZDMFDE =PMFU (JL, JK+1)
        PLUDE (JL, JK)=PLU (JL, JK+1)*ZDMFDE 
        PMFUDE_RATE (JL, JK)=ZDMFDE 
      ENDIF

    ENDDO


    

    IF (LLO1 ) THEN

      IF (PLU (JL, JK)>ZDNOPRC) THEN
        PWU (JL, JK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.5_JPRB, PKINEU (JL, JK+1))))

        IF (LDTDKMF) THEN
          ZZCO=FOEALFCU (PTU (JL, JK))*1.3_JPRB+(1.0_JPRB-FOEALFCU (PTU (JL, JK)))
        ELSE
          ZZCO=1.0_JPRB+0.3_JPRB*FOEALFCU (PTU (JL, JK))
        ENDIF

        
        ZXPRCDGW=ZPRCDGW
        
        ZPRCON=ZXPRCDGW/(0.75_JPRB*PWU (JL, JK))*ZZCO
        ZDT=MIN (YDTHF%RTBERCU-YDTHF%RTICECU, MAX (YDTHF%RTBERCU-PTU (JL, JK), 0.0_JPRB))
        ZCBF=1+Z_CPRC2*SQRT (ZDT)
        ZZCO=ZPRCON*ZCBF

        IF (YGFL%NACTAERO>0) THEN

          IF (YDECLDP%LAERLIQAUTOCP) THEN
            ZALFAW=FOEALFCU (PTU (JL, JK))
            ZLCRIT=ZALFAW*PLCRIT_AER (JL, JK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
          ELSEIF (YDECLDP%LAERLIQAUTOCPB) THEN
            ZALFAW=FOEALFCU (PTU (JL, JK))
            ZLCRIT=ZALFAW*PLCRIT_AER (JL, KCBOT (JL))+(1.0_JPRB-ZALFAW)*ZDNOPRC
          ELSE
            ZLCRIT=ZDNOPRC/ZCBF
          ENDIF

        ELSE
          ZLCRIT=ZDNOPRC/ZCBF
        ENDIF

        ZDFI=PGEOH (JL, JK)-PGEOH (JL, JK+1)
        ZC=(PLU (JL, JK)-ZLUOLD )
        ZD=ZZCO*(1.0_JPRB-EXP (-(PLU (JL, JK)/ZLCRIT)**2))*ZDFI
        ZINT=EXP (-ZD)
        ZLNEW=ZLUOLD *ZINT+ZC/ZD*(1.0_JPRB-ZINT)
        ZLNEW=MAX (0.0_JPRB, MIN (PLU (JL, JK), ZLNEW))
        ZLNEW=MIN (Z_CLDMAX, ZLNEW)
        ZPRECIP =MAX (0.0_JPRB, ZLUOLD +ZC-ZLNEW)
        PDMFUP (JL, JK)=ZPRECIP *PMFU (JL, JK)
        PLRAIN (JL, JK)=PLRAIN (JL, JK)+ZPRECIP 
        PLU (JL, JK)=ZLNEW
      ENDIF

    ENDIF


    

    IF (YDEPHLI%LPHYLIN) THEN

      

      IF (LLO1 ) THEN

        IF (PLRAIN (JL, JK)>0.0_JPRB) THEN
          ZVW=21.18_JPRB*PLRAIN (JL, JK)**0.2_JPRB
          ZVI=Z_CWIFRAC*ZVW
          ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
          ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
          ZROLD=PLRAIN (JL, JK)-ZPRECIP 
          ZC=ZPRECIP 
          PWU (JL, JK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JL, JK))))
          ZD=ZVV/PWU (JL, JK)
          ZINT=EXP (-ZD)
          ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
          ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JL, JK), ZRNEW))
          PLRAIN (JL, JK)=ZRNEW
        ENDIF

      ENDIF

    
    ELSE

      

      IF (LLO1 ) THEN

        IF (PLRAIN (JL, JK)>0.0_JPRB) THEN
          ZVW=21.18_JPRB*PLRAIN (JL, JK)**0.2_JPRB
          ZVI=Z_CWIFRAC*ZVW
          ZALFAW=FOEALFCU (PTU (JL, JK))

          IF (LSCVFLAG (JL))  THEN
            ZALFAW=1.0_JPRB
          ENDIF

          ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
          ZROLD=PLRAIN (JL, JK)-ZPRECIP 
          ZC=ZPRECIP 
          PWU (JL, JK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JL, JK))))
          ZD=ZVV/PWU (JL, JK)
          ZINT=EXP (-ZD)
          ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
          ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JL, JK), ZRNEW))
          PLRAIN (JL, JK)=ZRNEW
        ENDIF

      ENDIF

    
    ENDIF


    DO JLL=1, JLM
      JL=JLX 
      PMFUL (JL, JK)=PLU (JL, JK)*PMFU (JL, JK)
      PMFUS (JL, JK)=(YDCST%RCPD*PTU (JL, JK)+PGEOH (JL, JK))*PMFU (JL, JK)
      PMFUQ (JL, JK)=PQU (JL, JK)*PMFU (JL, JK)
      ZALFAW=FOEALFCU (PTU (JL, JK))

      IF (LSCVFLAG (JL))  THEN
        ZALFAW=1.0_JPRB
      ENDIF

      PLUDELI (JL, JK, 1)=ZALFAW*PLUDE (JL, JK)
      PLUDELI (JL, JK, 2)=(1.0_JPRB-ZALFAW)*PLUDE (JL, JK)
    ENDDO

  ENDIF

ENDDO



IF (KCTOP (JL)==-1)  THEN
  LDCUM (JL)=.FALSE.
ENDIF

KCBOT (JL)=MAX (KCBOT (JL), KCTOP (JL))

IF (LDCUM (JL)) THEN
  PWMEAN (JL)=MAX (1.E-2_JPRB, PWMEAN (JL)/MAX (1.0_JPRB, ZDPMEAN ))
  PWMEAN (JL)=SQRT (2.0_JPRB*PWMEAN (JL))
ENDIF




END SUBROUTINE CUASCN_OPENACC
