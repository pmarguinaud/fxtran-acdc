SUBROUTINE MCOORDS_OPENACC (YDSCO, YDRIP, KFLEV, KPROMA, KST, KEND, PA, PGEMU&
&, PGSQM2, PGNORDM, PGNORDL, PU, PV, PSCO, LD2TL, LD2TLM, LDROT, YDSTACK)
!$ACC ROUTINE (MCOORDS_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE FIELD_VARIABLES_MOD,ONLY:GEOMETRY_VARIABLES
USE INTDYNSL_MOD,ONLY:TSCO
USE YOMRIP,ONLY:TRIP
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TSCO), INTENT (IN)::YDSCO
TYPE (TRIP), INTENT (IN)::YDRIP
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
LOGICAL, INTENT (IN)::LD2TLM
LOGICAL, INTENT (IN)::LD2TL
LOGICAL, INTENT (IN), OPTIONAL::LDROT
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB), INTENT (IN)::PA
REAL (KIND=JPRB), INTENT (IN)::PGNORDL (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PGNORDM (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PGSQM2 (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PGEMU (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PU (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PSCO (KPROMA, KFLEV, YDSCO%NDIM)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
LOGICAL::LLROT
REAL (KIND=JPRB)::ZDTS62
REAL (KIND=JPRB)::ZDTS22
REAL (KIND=JPRB)::ZDTSA
REAL (KIND=JPRB)::ZPHI2
REAL (KIND=JPRB)::ZV
REAL (KIND=JPRB)::ZU
REAL (KIND=JPRB)::ZNOR2
REAL (KIND=JPRB)::ZCOPHI
REAL (KIND=JPRB)::ZINT
REAL (KIND=JPRB)::ZSINPHI

#include "rotate.func.h"

JROF = KST



LLROT=.FALSE.

IF (PRESENT (LDROT))  THEN
  LLROT=LDROT
ENDIF


IF (LD2TL) THEN
  ZDTSA=2*YDRIP%RDTSA
  ZDTS22=4*YDRIP%RDTS22
  ZDTS62=4*YDRIP%RDTS62
ELSE
  ZDTSA=YDRIP%RDTSA
  ZDTS22=YDRIP%RDTS22
  ZDTS62=YDRIP%RDTS62
ENDIF


IF (LD2TL.AND..NOT.LD2TLM) THEN

  DO JLEV=1, KFLEV
    
    ZNOR2=PU (JROF, JLEV)**2+PV (JROF, JLEV)**2
    ZPHI2=(YDRIP%RTDT*SQRT (ZNOR2)/PA/2)**2
    ZCOPHI=1-ZPHI2/2
    ZSINPHI=ZCOPHI*YDRIP%RTDT*(1-ZPHI2/6)/PA
    ZCOPHI=2*ZCOPHI**2-1
    PSCO (JROF, JLEV, YDSCO%M_SINLA)=PGEMU (JROF)*ZCOPHI-PGSQM2 (JROF)*PV (JROF, JLEV)*ZSINPHI
    PSCO (JROF, JLEV, YDSCO%M_COSCO)=PGSQM2 (JROF)*ZCOPHI+PGEMU (JROF)*PV (JROF, JLEV)*ZSINPHI
    PSCO (JROF, JLEV, YDSCO%M_SINCO)=-PU (JROF, JLEV)*ZSINPHI
    PSCO (JROF, JLEV, YDSCO%M_COPHI)=ZCOPHI
  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    ZNOR2=PU (JROF, JLEV)**2+PV (JROF, JLEV)**2
    ZCOPHI=1-ZDTS22*ZNOR2
    ZSINPHI=ZDTSA*(1-ZDTS62*ZNOR2)

    IF (LD2TL.AND..NOT.LD2TLM) THEN
      ZPHI2=(YDRIP%RTDT*SQRT (ZNOR2)/PA/2)**2
      ZCOPHI=1-ZPHI2/2
      ZSINPHI=ZCOPHI*YDRIP%RTDT*(1-ZPHI2/6)/PA
      ZCOPHI=2*ZCOPHI**2-1
    ENDIF


    IF (LLROT) THEN
      ZU=FROTU (PU (JROF, JLEV), PV (JROF, JLEV), PGNORDM (JROF), PGNORDL (JROF))
      ZV=FROTV (PU (JROF, JLEV), PV (JROF, JLEV), PGNORDM (JROF), PGNORDL (JROF))
    ELSE
      ZU=PU (JROF, JLEV)
      ZV=PV (JROF, JLEV)
    ENDIF

    ZINT=ZV*ZSINPHI
    PSCO (JROF, JLEV, YDSCO%M_SINLA)=PGEMU (JROF)*ZCOPHI-PGSQM2 (JROF)*ZINT
    PSCO (JROF, JLEV, YDSCO%M_COSCO)=PGSQM2 (JROF)*ZCOPHI+PGEMU (JROF)*ZINT
    PSCO (JROF, JLEV, YDSCO%M_SINCO)=-ZU*ZSINPHI
    PSCO (JROF, JLEV, YDSCO%M_COPHI)=ZCOPHI
  
  ENDDO

ENDIF



END SUBROUTINE MCOORDS_OPENACC
