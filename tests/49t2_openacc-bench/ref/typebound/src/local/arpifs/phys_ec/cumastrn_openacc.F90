SUBROUTINE CUMASTRN_OPENACC (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN, YDML_PHY_EC, YGFL, YDCHEM&
&, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA, KLON, KLEV, PDX, LDTDKMF, LDMCAPEA, LDLAND, PTSPHY, PTEN&
&, PQEN, PUEN, PVEN, PLITOT, PVERVEL, PQSEN, PQHFL, PAHFS, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA&
&, PGP2DSPP, PTENT, PTENQ, PTENU, PTENV, PTENTA, PTENQA, LDCUM, KTYPE, KCBOT, KCTOP, LDCUM_LIG,&
& KCBOT_LIG, KCTOP_LIG, KBOTSC, LDSC, LDSHCV, PLCRIT_AER, PTU, PQU, PLU, PLUDE, PLUDELI, PSNDE,&
& PENTH, PMFLXR, PMFLXS, PRAIN, PLRAIN, PRSUD, PMFU, PMFD, PLGLAC, PMFUDE_RATE, PMFDDE_RATE, PCAPE&
&, PWU, PWMEAN, PVDISCU, PDISS, KTRAC, PCEN, PTENC, PSCAV, PSCAV0, YDSTACK)
!$ACC ROUTINE (CUMASTRN_OPENACC) SEQ
USE MODEL_PHYSICS_ECMWF_MOD,ONLY:MODEL_PHYSICS_ECMWF_TYPE
USE MODEL_PHYSICS_SIMPLINEAR_MOD,ONLY:MODEL_PHYSICS_SIMPLINEAR_TYPE
USE YOM_YGFL,ONLY:TYPE_GFLD
USE YOMCHEM,ONLY:TCHEM
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE YOMPERTPAR,ONLY:TPERTPAR
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_ECMWF_TYPE), INTENT (IN)::YDML_PHY_EC
TYPE (TCHEM), INTENT (IN)::YDCHEM
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TPERTPAR), INTENT (IN)::YDPERTPAR
TYPE (MODEL_PHYSICS_SIMPLINEAR_TYPE), INTENT (IN)::YDML_PHY_SLIN
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
LOGICAL, INTENT (IN)::LDMCAPEA
LOGICAL, INTENT (IN)::LDLAND (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCUCONVCA (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (IN)::PCEN (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV0 (KTRAC)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (IN)::PDX (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
REAL (KIND=JPRB), INTENT (INOUT)::PTENT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENTA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENQA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (KLON, KLEV, KTRAC)
LOGICAL, INTENT (OUT)::LDCUM (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
LOGICAL, INTENT (OUT)::LDCUM_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP_LIG (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (KLON)
LOGICAL, INTENT (OUT)::LDSC (KLON)
LOGICAL, INTENT (IN)::LDSHCV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 4)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PENTH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PRAIN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSUD (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVDISCU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (KLON, KLEV)
fxtran_acdc_temp (REAL (KIND=JPRB), ZKINED, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZKINEU, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZVD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZVU, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUU, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRFL, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUL, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDMFDP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDMFUP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSENH, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQENH2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENH2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQENH, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENH, (KLON, KLEV))
REAL (KIND=JPRB)::ZSATFR 
REAL (KIND=JPRB)::ZMFCFL 
REAL (KIND=JPRB)::ZFACCA 
REAL (KIND=JPRB)::ZDQCV 
REAL (KIND=JPRB)::ZKHFL 
REAL (KIND=JPRB)::ZKHVFL 
REAL (KIND=JPRB)::ZMFUB1 
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUB, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDPMEL, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZWUBASE, (KLON))
REAL (KIND=JPRB)::ZDHPBL 
REAL (KIND=JPRB)::ZDX 
fxtran_acdc_temp (REAL (KIND=JPRB), ZDMFDE, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDMFEN, (KLON, KLEV))
fxtran_acdc_temp (INTEGER (KIND=JPIM), ICTOP0, (KLON))
fxtran_acdc_temp (INTEGER (KIND=JPIM), IDTOP, (KLON))
fxtran_acdc_temp (INTEGER (KIND=JPIM), ILAB, (KLON, KLEV))
fxtran_acdc_temp (INTEGER (KIND=JPIM), IDPL, (KLON))
REAL (KIND=JPRB)::ZCAPDCYCLSE 
REAL (KIND=JPRB)::ZCAPDCYCLLD 
REAL (KIND=JPRB)::ZCAPDCYCL 
REAL (KIND=JPRB)::ZCAPPBL 
REAL (KIND=JPRB)::ZHEAT 
REAL (KIND=JPRB)::ZCAPE2 
REAL (KIND=JPRB)::ZCAPE 
fxtran_acdc_temp (LOGICAL, LLSCVFLAG, (KLON))
fxtran_acdc_temp (LOGICAL, LLDCUM, (KLON))
fxtran_acdc_temp (LOGICAL, LLDDRAF3, (KLON))
fxtran_acdc_temp (LOGICAL, LLDDRAF, (KLON))
LOGICAL::LLO3
LOGICAL::LLMIXS
LOGICAL::LLO2 
LOGICAL::LLO1
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ITOPM2
INTEGER (KIND=JPIM)::IKD
INTEGER (KIND=JPIM)::IKB
REAL (KIND=JPRB)::ZIND
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZAK
REAL (KIND=JPRB)::ZBS
REAL (KIND=JPRB)::ZBR
REAL (KIND=JPRB)::ZAS
REAL (KIND=JPRB)::ZAR
REAL (KIND=JPRB)::ZTAURES
REAL (KIND=JPRB)::ZTDIS
REAL (KIND=JPRB)::ZDVTEN
REAL (KIND=JPRB)::ZDUTEN
REAL (KIND=JPRB)::ZRDOCPD
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZDERATE
REAL (KIND=JPRB)::ZERATE
REAL (KIND=JPRB)::ZMFA
REAL (KIND=JPRB)::ZRO
REAL (KIND=JPRB)::ZQUMQE
REAL (KIND=JPRB)::ZPBMPT
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDZ
REAL (KIND=JPRB)::ZDQMIN
REAL (KIND=JPRB)::ZDH2
REAL (KIND=JPRB)::ZDH
REAL (KIND=JPRB)::ZCONS
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZTAUPBL 
REAL (KIND=JPRB)::ZTAU 
REAL (KIND=JPRB)::ZXTAU 
LOGICAL::LLPERT_RTAU
INTEGER (KIND=JPIM)::IPRTAU
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZSUM22 
REAL (KIND=JPRB)::ZSUM12 
fxtran_acdc_temp (REAL (KIND=JPRB), ZUV2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDMFDPC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDMFUPC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZKMFL, (KLON))
REAL (KIND=JPRB)::ZMF_SHAL 
REAL (KIND=JPRB)::ZMFUVB 
REAL (KIND=JPRB)::ZMFUUB 
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENV, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENU, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDDR, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUDR, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDUS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUUS, (KLON, KLEV))
REAL (KIND=JPRB)::ZMFS 

#include "cuascn_openacc.intfb.h"
#include "cubasen_openacc.intfb.h"
#include "cuddrafn_openacc.intfb.h"
#include "cudlfsn_openacc.intfb.h"
#include "cudtdqn_openacc.intfb.h"
#include "cududv_openacc.intfb.h"
#include "cuflxn_openacc.intfb.h"
#include "cuinin_openacc.intfb.h"
#include "cuctracer_openacc.intfb.h"
#include "fcttre.func.h"

YLSTACK = YDSTACK



IF (KIND (ZKINED) == 8) THEN
    fxtran_acdc_alloc8 (ZKINED)
ELSEIF (KIND (ZKINED) == 4) THEN
    fxtran_acdc_alloc4 (ZKINED)
ELSE
    STOP 1
ENDIF


IF (KIND (ZKINEU) == 8) THEN
    fxtran_acdc_alloc8 (ZKINEU)
ELSEIF (KIND (ZKINEU) == 4) THEN
    fxtran_acdc_alloc4 (ZKINEU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZVD) == 8) THEN
    fxtran_acdc_alloc8 (ZVD)
ELSEIF (KIND (ZVD) == 4) THEN
    fxtran_acdc_alloc4 (ZVD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUD) == 8) THEN
    fxtran_acdc_alloc8 (ZUD)
ELSEIF (KIND (ZUD) == 4) THEN
    fxtran_acdc_alloc4 (ZUD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZVU) == 8) THEN
    fxtran_acdc_alloc8 (ZVU)
ELSEIF (KIND (ZVU) == 4) THEN
    fxtran_acdc_alloc4 (ZVU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUU) == 8) THEN
    fxtran_acdc_alloc8 (ZUU)
ELSEIF (KIND (ZUU) == 4) THEN
    fxtran_acdc_alloc4 (ZUU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRFL) == 8) THEN
    fxtran_acdc_alloc8 (ZRFL)
ELSEIF (KIND (ZRFL) == 4) THEN
    fxtran_acdc_alloc4 (ZRFL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUL) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUL)
ELSEIF (KIND (ZMFUL) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMFDP) == 8) THEN
    fxtran_acdc_alloc8 (ZDMFDP)
ELSEIF (KIND (ZDMFDP) == 4) THEN
    fxtran_acdc_alloc4 (ZDMFDP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMFUP) == 8) THEN
    fxtran_acdc_alloc8 (ZDMFUP)
ELSEIF (KIND (ZDMFUP) == 4) THEN
    fxtran_acdc_alloc4 (ZDMFUP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDQ) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDQ)
ELSEIF (KIND (ZMFDQ) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUQ) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUQ)
ELSEIF (KIND (ZMFUQ) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDS) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDS)
ELSEIF (KIND (ZMFDS) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUS) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUS)
ELSEIF (KIND (ZMFUS) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQD) == 8) THEN
    fxtran_acdc_alloc8 (ZQD)
ELSEIF (KIND (ZQD) == 4) THEN
    fxtran_acdc_alloc4 (ZQD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTD) == 8) THEN
    fxtran_acdc_alloc8 (ZTD)
ELSEIF (KIND (ZTD) == 4) THEN
    fxtran_acdc_alloc4 (ZTD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSENH) == 8) THEN
    fxtran_acdc_alloc8 (ZQSENH)
ELSEIF (KIND (ZQSENH) == 4) THEN
    fxtran_acdc_alloc4 (ZQSENH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQENH2) == 8) THEN
    fxtran_acdc_alloc8 (ZQENH2)
ELSEIF (KIND (ZQENH2) == 4) THEN
    fxtran_acdc_alloc4 (ZQENH2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENH2) == 8) THEN
    fxtran_acdc_alloc8 (ZTENH2)
ELSEIF (KIND (ZTENH2) == 4) THEN
    fxtran_acdc_alloc4 (ZTENH2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQENH) == 8) THEN
    fxtran_acdc_alloc8 (ZQENH)
ELSEIF (KIND (ZQENH) == 4) THEN
    fxtran_acdc_alloc4 (ZQENH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENH) == 8) THEN
    fxtran_acdc_alloc8 (ZTENH)
ELSEIF (KIND (ZTENH) == 4) THEN
    fxtran_acdc_alloc4 (ZTENH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUB) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUB)
ELSEIF (KIND (ZMFUB) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUB)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDPMEL) == 8) THEN
    fxtran_acdc_alloc8 (ZDPMEL)
ELSEIF (KIND (ZDPMEL) == 4) THEN
    fxtran_acdc_alloc4 (ZDPMEL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWUBASE) == 8) THEN
    fxtran_acdc_alloc8 (ZWUBASE)
ELSEIF (KIND (ZWUBASE) == 4) THEN
    fxtran_acdc_alloc4 (ZWUBASE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMFDE) == 8) THEN
    fxtran_acdc_alloc8 (ZDMFDE)
ELSEIF (KIND (ZDMFDE) == 4) THEN
    fxtran_acdc_alloc4 (ZDMFDE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMFEN) == 8) THEN
    fxtran_acdc_alloc8 (ZDMFEN)
ELSEIF (KIND (ZDMFEN) == 4) THEN
    fxtran_acdc_alloc4 (ZDMFEN)
ELSE
    STOP 1
ENDIF


IF (KIND (ICTOP0) == 8) THEN
    fxtran_acdc_alloc8 (ICTOP0)
ELSEIF (KIND (ICTOP0) == 4) THEN
    fxtran_acdc_alloc4 (ICTOP0)
ELSE
    STOP 1
ENDIF


IF (KIND (IDTOP) == 8) THEN
    fxtran_acdc_alloc8 (IDTOP)
ELSEIF (KIND (IDTOP) == 4) THEN
    fxtran_acdc_alloc4 (IDTOP)
ELSE
    STOP 1
ENDIF


IF (KIND (ILAB) == 8) THEN
    fxtran_acdc_alloc8 (ILAB)
ELSEIF (KIND (ILAB) == 4) THEN
    fxtran_acdc_alloc4 (ILAB)
ELSE
    STOP 1
ENDIF


IF (KIND (IDPL) == 8) THEN
    fxtran_acdc_alloc8 (IDPL)
ELSEIF (KIND (IDPL) == 4) THEN
    fxtran_acdc_alloc4 (IDPL)
ELSE
    STOP 1
ENDIF


IF (KIND (LLSCVFLAG) == 8) THEN
    fxtran_acdc_alloc8 (LLSCVFLAG)
ELSEIF (KIND (LLSCVFLAG) == 4) THEN
    fxtran_acdc_alloc4 (LLSCVFLAG)
ELSE
    STOP 1
ENDIF


IF (KIND (LLDCUM) == 8) THEN
    fxtran_acdc_alloc8 (LLDCUM)
ELSEIF (KIND (LLDCUM) == 4) THEN
    fxtran_acdc_alloc4 (LLDCUM)
ELSE
    STOP 1
ENDIF


IF (KIND (LLDDRAF3) == 8) THEN
    fxtran_acdc_alloc8 (LLDDRAF3)
ELSEIF (KIND (LLDDRAF3) == 4) THEN
    fxtran_acdc_alloc4 (LLDDRAF3)
ELSE
    STOP 1
ENDIF


IF (KIND (LLDDRAF) == 8) THEN
    fxtran_acdc_alloc8 (LLDDRAF)
ELSEIF (KIND (LLDDRAF) == 4) THEN
    fxtran_acdc_alloc4 (LLDDRAF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUV2) == 8) THEN
    fxtran_acdc_alloc8 (ZUV2)
ELSEIF (KIND (ZUV2) == 4) THEN
    fxtran_acdc_alloc4 (ZUV2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMFDPC) == 8) THEN
    fxtran_acdc_alloc8 (ZDMFDPC)
ELSEIF (KIND (ZDMFDPC) == 4) THEN
    fxtran_acdc_alloc4 (ZDMFDPC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDMFUPC) == 8) THEN
    fxtran_acdc_alloc8 (ZDMFUPC)
ELSEIF (KIND (ZDMFUPC) == 4) THEN
    fxtran_acdc_alloc4 (ZDMFUPC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZKMFL) == 8) THEN
    fxtran_acdc_alloc8 (ZKMFL)
ELSEIF (KIND (ZKMFL) == 4) THEN
    fxtran_acdc_alloc4 (ZKMFL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENV) == 8) THEN
    fxtran_acdc_alloc8 (ZTENV)
ELSEIF (KIND (ZTENV) == 4) THEN
    fxtran_acdc_alloc4 (ZTENV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENU) == 8) THEN
    fxtran_acdc_alloc8 (ZTENU)
ELSEIF (KIND (ZTENU) == 4) THEN
    fxtran_acdc_alloc4 (ZTENU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDDR) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDDR)
ELSEIF (KIND (ZMFDDR) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDDR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUDR) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUDR)
ELSEIF (KIND (ZMFUDR) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUDR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDUS) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDUS)
ELSEIF (KIND (ZMFDUS) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDUS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUUS) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUUS)
ELSEIF (KIND (ZMFUUS) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUUS)
ELSE
    STOP 1
ENDIF


JL = KIDIA



ZCONS2=YDML_PHY_EC%YRECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZCONS=1.0_JPRB/(YDCST%RG*PTSPHY)
ZORCPD=1.0_JPRB/YDCST%RCPD
ZRDOCPD=YDCST%RD*ZORCPD
ZRG=1.0_JPRB/YDCST%RG
ZTAU =0.0

LLPERT_RTAU=.FALSE.


PCAPE (JL)=0.0_JPRB
PVDISCU (JL)=0.0_JPRB
LDCUM (JL)=.FALSE.

CALL CUININ_OPENACC (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA&
&, KFDIA, KLON, KLEV, PTEN, PQEN, PQSEN, PUEN, PVEN, PGEO, PAPH, ILAB, ZTENH, ZQENH&
&, ZQSENH, PGEOH, PTU, PQU, ZTD, ZQD, ZUU, ZVU, ZUD, ZVD, PLU, YDSTACK=YLSTACK)
ZKMFL (JL)=0.0_JPRB
LLMIXS=LDTDKMF
CALL CUBASEN_OPENACC (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP, YDML_PHY_EC&
&%YRECUMF, YDSPP_CONFIG, KIDIA, KFDIA, KLON, KLEV, YDML_PHY_EC%YRECUMF%NJKT1, LLMIXS, LDTDKMF, ZTENH&
&, ZQENH, PGEOH, PAPH, PQHFL, PAHFS, PGP2DSPP, ZKMFL, PTEN, PQEN, PQSEN, PGEO, PTU, PQU, PLU, ZKINEU&
&, ZWUBASE, ILAB, LDCUM, LDSC, KCBOT, KBOTSC, ICTOP0, IDPL, PCAPE, YDSTACK=YLSTACK)

ZDHPBL =0.0_JPRB
IDTOP (JL)=0
ZCAPPBL =0.
ZKHVFL =(-PAHFS (JL, KLEV+1)*ZORCPD-YDCST%RETV*PTEN (JL, KLEV)*PQHFL (JL, KLEV+1))/(PPLRG*PPLDARE)
ZKHFL =(-PAHFS (JL, KLEV+1)-YDCST%RLVTT*PQHFL (JL, KLEV+1))/(PPLRG*PPLDARE)


DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV

  

  IF (LDCUM (JL).AND.JK>=KCBOT (JL)) THEN
    ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
    ZDHPBL =ZDHPBL +(YDCST%RLVTT*PTENQ (JL, JK)+YDCST%RCPD*PTENT (JL, JK))*ZDZ
    ZCAPPBL =ZCAPPBL +(PTENT (JL, JK)+YDCST%RETV*PTEN (JL, JK)*PTENQ (JL, JK))*ZDZ
  ENDIF

  
ENDDO



IF (LDCUM (JL)) THEN
  IKB=KCBOT (JL)
  ITOPM2=ICTOP0 (JL)
  ZPBMPT=PAPH (JL, IKB)-PAPH (JL, ITOPM2)

  IF (ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS) THEN
    KTYPE (JL)=1
  ELSE
    KTYPE (JL)=2
  ENDIF

ELSE
  KTYPE (JL)=0
ENDIF



IF (YDML_PHY_EC%YRECUMF%LMFWSTAR) THEN

  

  IF (LDCUM (JL)) THEN
    IKB=KCBOT (JL)
    ZDZ=MAX (0.0_JPRB, MIN (1.5E3_JPRB,(PGEOH (JL, IKB)-PGEOH (JL, KLEV+1))/YDCST%RG))
    ZMF_SHAL =0.07_JPRB*(YDCST%RG/PTEN (JL, KLEV)*ZDZ*MAX (0.0_JPRB, ZKHVFL ))**.3333
    ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2
    ZMF_SHAL =MIN (ZMF_SHAL , ZMFMAX)
  ENDIF

  
ENDIF



IF (LDCUM (JL)) THEN
  IKB=KCBOT (JL)
  ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2

  IF (KTYPE (JL)==1) THEN
    ZMFUB (JL)=ZMFMAX*0.1_JPRB
  ELSEIF (KTYPE (JL)==2) THEN
    ZQUMQE=PQU (JL, IKB)+PLU (JL, IKB)-ZQENH (JL, IKB)
    ZDQMIN=MAX (0.01_JPRB*ZQENH (JL, IKB), 1.E-10_JPRB)
    ZDH=YDCST%RCPD*(PTU (JL, IKB)-ZTENH (JL, IKB))+YDCST%RLVTT*ZQUMQE
    ZDH=YDCST%RG*MAX (ZDH, 1.E5_JPRB*ZDQMIN)

    IF (ZDHPBL >0.0_JPRB) THEN
      ZMFUB (JL)=ZDHPBL /ZDH
      ZMFUB (JL)=MIN (ZMFUB (JL), ZMFMAX)
    ELSE
      ZMFUB (JL)=ZMFMAX*0.1_JPRB
      LDCUM (JL)=.FALSE.
    ENDIF


    IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
      ZMFUB (JL)=ZMF_SHAL 
    ENDIF

  ENDIF

ELSE
  ZMFUB (JL)=0.0_JPRB
ENDIF


CALL CUASCN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP, YDML_PHY_EC%YRECUMF, YDSPP_CONFIG&
&, YGFL, KIDIA, KFDIA, KLON, KLEV, LDTDKMF, PTSPHY, ZTENH, ZQENH, PUEN, PVEN, PTEN, PQEN, PQSEN, PLITOT&
&, PGEO, PGEOH, PAP, PAPH, PVERVEL, ZWUBASE, PGP2DSPP, LDLAND, LDCUM, KTYPE, ILAB, LLSCVFLAG, PTU, PQU&
&, PLU, PLRAIN, PMFU, ZMFUB, PLGLAC, ZMFUS, ZMFUQ, ZMFUL, PLUDE, PLUDELI, ZDMFUP, PLCRIT_AER, ZDMFEN&
&, KCBOT, KCTOP, ICTOP0, IDPL, PMFUDE_RATE, ZKINEU, PWU, PWMEAN, YDSTACK=YLSTACK)


IF (LDCUM (JL)) THEN
  IKB=KCBOT (JL)
  ITOPM2=KCTOP (JL)
  ZPBMPT=PAPH (JL, IKB)-PAPH (JL, ITOPM2)

  IF (KTYPE (JL)==1.AND.ZPBMPT<YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
    KTYPE (JL)=2
  ENDIF


  IF (KTYPE (JL)==2.AND.ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
    KTYPE (JL)=1
  ENDIF

  ICTOP0 (JL)=KCTOP (JL)
ENDIF

ZRFL (JL)=ZDMFUP (JL, 1)


DO JK=2, KLEV
  
  ZRFL (JL)=ZRFL (JL)+ZDMFUP (JL, JK)
  
ENDDO


DO JK=1, KLEV
  
  PMFD (JL, JK)=0.0_JPRB
  ZMFDS (JL, JK)=0.0_JPRB
  ZMFDQ (JL, JK)=0.0_JPRB
  ZDMFDP (JL, JK)=0.0_JPRB
  ZDPMEL (JL, JK)=0.0_JPRB
  
ENDDO


DO JK=1, KLEV
  
  ZTENU (JL, JK)=PTENU (JL, JK)
  ZTENV (JL, JK)=PTENV (JL, JK)
  
ENDDO


IF (YDML_PHY_EC%YRECUMF%LMFDD) THEN
  CALL CUDLFSN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA, KFDIA&
  &, KLON, KLEV, KCBOT, KCTOP, LDCUM, ZTENH, ZQENH, PTEN, PQSEN, PGEO, PGEOH, PAPH, PTU, PQU&
  &, ZMFUB, ZRFL, ZTD, ZQD, PMFD, ZMFDS, ZMFDQ, ZDMFDP, IDTOP, LLDDRAF, YDSTACK=YLSTACK)
  CALL CUDDRAFN_OPENACC (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA&
  &, KFDIA, KLON, KLEV, LLDDRAF, ZTENH, ZQENH, PQSEN, PGEO, PGEOH, PAPH, ZRFL, ZTD, ZQD&
  &, PMFU, PMFD, ZMFDS, ZMFDQ, ZDMFDP, ZDMFDE, PMFDDE_RATE, ZKINED, YDSTACK=YLSTACK)
ENDIF


ZHEAT =0.0_JPRB
ZCAPE =0.0_JPRB
ZCAPE2 =0.0_JPRB
ZMFUB1 =ZMFUB (JL)
ZDQCV =0.0_JPRB
ZSATFR =0.0_JPRB
ZDX =2*YDCST%RA*SQRT (YDCST%RPI*PGAW (JL))
ZDX =MAX (ZDX , 1.E2_JPRB)


DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV
  
  LLO1=LDCUM (JL).AND.KTYPE (JL)==1
  LLO3=LLO1.AND.JK<=KCBOT (JL).AND.JK>KCTOP (JL)

  IF (LLO3) THEN
    ZDZ=(PGEO (JL, JK-1)-PGEO (JL, JK))

    IF (LDTDKMF) THEN
      ZHEAT =ZHEAT +((PTEN (JL, JK-1)-PTEN (JL, JK)+ZDZ*ZORCPD)/ZTENH (JL, JK)+YDCST%RETV&
      &*(PQEN (JL, JK-1)-PQEN (JL, JK)))*(YDCST%RG*(PMFU (JL, JK)+PMFD (JL, JK)))
    ELSE
      ZHEAT =ZHEAT +MAX (0.0_JPRB,((PTEN (JL, JK-1)-PTEN (JL, JK)+ZDZ*ZORCPD)/ZTENH (JL, JK)+YDCST&
      &%RETV*(PQEN (JL, JK-1)-PQEN (JL, JK)))*(YDCST%RG*(PMFU (JL, JK)+PMFD (JL, JK))))
    ENDIF

    ZDZ=(PAP (JL, JK)-PAP (JL, JK-1))
    ZCAPE =ZCAPE +((PTU (JL, JK)-ZTENH (JL, JK))/ZTENH (JL, JK)+YDCST&
    &%RETV*(PQU (JL, JK)-ZQENH (JL, JK))-PLU (JL, JK))*ZDZ
  ENDIF


  IF (LLO3.AND.YDML_PHY_EC%YRECUMF%RCAPQADV>0.0_JPRB) THEN
    ZTENH2 (JL, JK)=ZTENH (JL, JK)-0.5_JPRB*(PTENTA (JL, JK)+PTENTA (JL, JK-1))*PTSPHY
    ZQENH2 (JL, JK)=ZQENH (JL, JK)-0.5_JPRB*(PTENQA (JL, JK)+PTENQA (JL, JK-1))*PTSPHY
    ZCAPE2 =ZCAPE2 +((PTU (JL, JK)-ZTENH2 (JL, JK))/ZTENH2 (JL, JK)&
    &+YDCST%RETV*(PQU (JL, JK)-ZQENH2 (JL, JK))-PLU (JL, JK))*ZDZ
  ENDIF


  IF (LLO1) THEN
    ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
    ZDQCV =ZDQCV +PTENQA (JL, JK)*ZDZ*(PQEN (JL, JK)/PQSEN (JL, JK))
  ENDIF


  IF (LLO1.AND.JK>=KCTOP (JL)) THEN
    ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
    ZSATFR =ZSATFR +(PQEN (JL, JK)/PQSEN (JL, JK))*ZDZ
  ENDIF

  
ENDDO


ZCAPDCYCL =0.0_JPRB
ZTAU =0.0_JPRB

IF (LDTDKMF) THEN
  ZDX =PDX (JL)
  ZDX =MAX (ZDX , 1.E2_JPRB)
ENDIF


IF (LDCUM (JL).AND.KTYPE (JL)==1) THEN

  IF (YDML_PHY_EC%YRECUMF%LNEWTAU) THEN
    ZTAURES=YDML_PHY_EC%YRECUMF%RTAULIM*(1._JPRB+YDML_PHY_EC%YRECUMF%RTAUFAC&
    &/((ZDX /1000._JPRB-YDML_PHY_EC%YRECUMF%RXMIN+1._JPRB)**2))
  ELSE
    ZTAURES=1.0_JPRB+1.60_JPRB*ZDX /125.E3_JPRB

    IF (ZDX <8.E3_JPRB) THEN
      ZTAURES=1.0_JPRB+(LOG (8.E3_JPRB/ZDX ))**2
    ENDIF

  ENDIF


  IF (ZDX >125.E3_JPRB)  THEN
    ZTAURES=MIN (3.0_JPRB, ZTAURES)
  ENDIF

  IKD=IDPL (JL)
  IKB=KCBOT (JL)
  IK=KCTOP (JL)
  ZTAU =(PGEOH (JL, IK)-PGEOH (JL, IKB))/((2.0_JPRB+MIN (15.0_JPRB&
  &, PWMEAN (JL)))*YDCST%RG)*ZTAURES*YDML_PHY_EC%YRECUMF%RTAUA
  
  ZXTAU =ZTAU 
  
  LLO1=PAPH (JL, KLEV+1)-PAPH (JL, IKD)<50.E2_JPRB

  IF (LLO1.AND.LDLAND (JL).AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==1.0_JPRB) THEN
    ZDZ=MIN (1.E4_JPRB, PGEOH (JL, IKB)-PGEOH (JL, KLEV+1))/YDCST%RG
    ZCAPDCYCL =ZXTAU *MAX (0.0_JPRB, ZKHVFL )*YDCST%RCPD/ZDZ
  ENDIF


  IF (LLO1.AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==2.0_JPRB) THEN
    ZIND=MAX (0._JPRB, MIN (1._JPRB,(YDML_PHY_EC%YRECUMF%RDXMAX-ZDX&
    & )/(YDML_PHY_EC%YRECUMF%RDXMAX-YDML_PHY_EC%YRECUMF%RDXMIN)))

    IF (LDLAND (JL))  THEN
      ZIND=1._JPRB
    ENDIF

    ZCAPDCYCLLD =ZCAPPBL *ZTAU /ZTAURES
    ZDUTEN=2.0_JPRB+SQRT (0.5*(PUEN (JL, IKB)**2+PVEN (JL, IKB)**2+PUEN (JL, YDML_PHY_EC&
    &%YRECUMF%NJKT3)**2+PVEN (JL, YDML_PHY_EC%YRECUMF%NJKT3)**2))
    ZTAUPBL =MIN (1.E4_JPRB, PGEOH (JL, IKB)-PGEOH (JL, KLEV+1))/(YDCST%RG*ZDUTEN)
    ZCAPDCYCLSE =ZCAPPBL *ZTAUPBL 
    ZCAPDCYCL =ZIND*ZCAPDCYCLLD +(1._JPRB-ZIND)*ZCAPDCYCLSE 
  ENDIF

  ZDQCV =ZDQCV *YDCST%RLVTT/PGEOH (JL, IK)*ZXTAU /MAX &
  &(1.25_JPRB, ZTAURES)*YDML_PHY_EC%YRECUMF%RCAPQADV
  ZSATFR =ZSATFR /(PAPH (JL, KLEV+1)-PAPH (JL, IK))
ELSE
  ZTAU =0.0_JPRB
ENDIF



IF (YDML_PHY_EC%YRECUMF%LMFCUCA) THEN
  
  ZFACCA =MAX (0.3_JPRB, MIN (1.8_JPRB, PCUCONVCA (JL)))
  
ELSE
  ZFACCA =1.0_JPRB
ENDIF



IF (LDCUM (JL).AND.KTYPE (JL)==1) THEN
  IKB=KCBOT (JL)
  ZCAPE2 =YDML_PHY_EC%YRECUMF%RCAPQADV*ZCAPE2 +(1.0_JPRB-YDML_PHY_EC%YRECUMF%RCAPQADV)*ZCAPE 
  ZCAPDCYCL =MAX (ZCAPDCYCL ,-2*ZCAPE2 )

  IF (ZSATFR <=0.94.OR.PVERVEL (JL, YDML_PHY_EC%YRECUMF%NJKT5)<-100._JPRB) THEN
    ZCAPE =MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE , ZCAPE2 -ZCAPDCYCL +ZDQCV )
  ELSE
    ZCAPE =MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE , ZCAPE -ZCAPDCYCL )
  ENDIF

  ZCAPE =MIN (ZCAPE , 5000.0_JPRB)
  ZHEAT =MAX (1.E-4_JPRB, ZHEAT )
  ZXTAU =MAX (3.6E3_JPRB/(5.0_JPRB*PPLRG*PPLDARE), MIN (3.0_JPRB*3.6E3_JPRB/(PPLRG*PPLDARE), ZXTAU ))
  ZMFUB1 =(ZCAPE *ZMFUB (JL))/(ZHEAT *ZXTAU )
  ZMFUB1 =MAX (ZMFUB1 , 0.001_JPRB)*ZFACCA 
  ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2
  ZMFUB1 =MIN (ZMFUB1 , ZMFMAX)
ENDIF



IF (LDMCAPEA) THEN
  
  PCAPE (JL)=YDCST%RG*ZCAPE 
  
ENDIF



IF (LDCUM (JL).AND.KTYPE (JL)>=2) THEN
  IKB=KCBOT (JL)

  IF (PMFD (JL, IKB)<0.0_JPRB) THEN
    ZEPS=-PMFD (JL, IKB)/MAX (ZMFUB (JL), 1.E-10_JPRB)
  ELSE
    ZEPS=0.0_JPRB
  ENDIF

  ZMFMAX=(PAPH (JL, IKB)-PAPH (JL, IKB-1))*ZCONS2

  IF (KTYPE (JL)==2) THEN

    IF (ZDHPBL >0.0_JPRB) THEN
      ZQUMQE=PQU (JL, IKB)+PLU (JL, IKB)-ZEPS*ZQD (JL, IKB)-(1.0_JPRB-ZEPS)*ZQENH (JL, IKB)
      ZDH=YDCST%RCPD*(PTU (JL, IKB)-ZEPS*ZTD (JL, IKB)-(1.0_JPRB-ZEPS)*ZTENH (JL, IKB))+YDCST%RLVTT*ZQUMQE
      ZDH2=YDCST%RCPD*(PTU (JL, IKB-1)-ZEPS*ZTD (JL, IKB-1)-(1&
      &.0_JPRB-ZEPS)*ZTENH (JL, IKB-1))+YDCST%RLVTT*ZQUMQE
      ZDH=0.5_JPRB*(ZDH+ZDH2)
      ZDH=YDCST%RG*MAX (ZDH, 0.1_JPRB*YDCST%RCPD)
      ZMFUB1 =ZDHPBL /ZDH

      IF (.NOT.LDTDKMF) THEN

        IF (ZMFUB1 >0.9_JPRB*ZMFMAX/YDML_PHY_EC%YRECUMF%RMFCFL.AND.ZDH<0.5_JPRB*YDCST%RG*YDCST%RCPD) THEN
          ZDH=0.75_JPRB*YDCST%RCPD*YDCST%RG
          ZMFUB1 =ZDHPBL /ZDH
        ENDIF

      ENDIF

    ELSE
      ZMFUB1 =ZMFUB (JL)
    ENDIF


    IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
      ZMFUB1 =ZMF_SHAL 
    ENDIF

    ZMFUB1 =MIN (ZMFUB1 , ZMFMAX)
  ENDIF


  IF (KTYPE (JL)==3) THEN

    IF (LDTDKMF) THEN
      ZMFUB1 =MAX (ZMFUB (JL), ZKHFL /PGEOH (JL, IKB))*(1.0_JPRB+ZEPS)
    ELSE
      ZMFUB1 =MAX (ZMFUB (JL), 5*ZKHFL /PGEOH (JL, IKB))*(1.0_JPRB+ZEPS)
    ENDIF


    IF (PGEOH (JL, IKB)<1.5E3_JPRB) THEN
      ZMFUB1 =MIN (ZMFUB1 , ZMFMAX/(1.05_JPRB*YDML_PHY_EC%YRECUMF%RMFCFL))
    ELSE
      ZMFUB1 =MIN (ZMFUB1 , ZMFMAX)
    ENDIF

  ENDIF

ENDIF



DO JK=1, KLEV

  

  IF (LLDDRAF (JL).AND.(KTYPE (JL)==1.OR.KTYPE (JL)==2)) THEN
    ZFAC=ZMFUB1 /MAX (ZMFUB (JL), 1.E-10_JPRB)
    PMFD (JL, JK)=PMFD (JL, JK)*ZFAC
    ZMFDS (JL, JK)=ZMFDS (JL, JK)*ZFAC
    ZMFDQ (JL, JK)=ZMFDQ (JL, JK)*ZFAC
    ZDMFDP (JL, JK)=ZDMFDP (JL, JK)*ZFAC
    PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)*ZFAC
  ENDIF

  
ENDDO



IF (LDCUM (JL)) THEN
  ZMFS =ZMFUB1 /MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUB (JL))
ENDIF



DO JK=2, KLEV

  

  IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
    IKB=KCBOT (JL)

    IF (JK>IKB) THEN
      ZDZ=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))
      PMFU (JL, JK)=PMFU (JL, IKB)*ZDZ
    ENDIF

    ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS2

    IF (.NOT.LDTDKMF)  THEN
      ZMFMAX=MIN (ZMFMAX, YDML_PHY_EC%YRECUMF%RMFLIA)
    ENDIF


    IF (PMFU (JL, JK)*ZMFS >ZMFMAX) THEN
      ZMFS =MIN (ZMFS , ZMFMAX/PMFU (JL, JK))
      ZMFS =MAX (ZMFS , 1.E-10_JPRB)
    ENDIF

  ENDIF

  
ENDDO


IF (YDML_PHY_EC%YRECUMF%RMFADVW>0.0_JPRB) THEN

  DO JK=2, KLEV-1

    

    IF (KTYPE (JL)==1.AND.JK>=KCTOP (JL)-1) THEN
      ZFAC=ZMFS *YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JL, JK)-PMFU (JL, JK+1)+YDML_PHY_EC%YRECUMF&
      &%RMFADVWDD*(PMFD (JL, JK)-PMFD (JL, JK+1)))/(PAPH (JL, JK)-PAPH (JL, JK+1))*PTSPHY

      IF (ABS (ZFAC)>0.98_JPRB)  THEN
        ZMFS =ZMFS /MAX (1.02_JPRB, ABS (ZFAC))
      ENDIF

    ENDIF

  
  ENDDO

  JK=KLEV

  

  IF (KTYPE (JL)==1) THEN
    ZFAC=ZMFS *YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JL, JK)+YDML_PHY_EC%YRECUMF&
    &%RMFADVWDD*PMFD (JL, JK))/(PAPH (JL, JK)-PAPH (JL, JK+1))*PTSPHY

    IF (ABS (ZFAC)>0.98_JPRB)  THEN
      ZMFS =ZMFS /MAX (1.02_JPRB, ABS (ZFAC))
    ENDIF

  ENDIF

  
ENDIF


DO JK=2, KLEV

  

  IF (LDCUM (JL).AND.JK<=KCBOT (JL).AND.JK>=KCTOP (JL)-1) THEN
    PMFU (JL, JK)=PMFU (JL, JK)*ZMFS 
    ZMFUS (JL, JK)=ZMFUS (JL, JK)*ZMFS 
    ZMFUQ (JL, JK)=ZMFUQ (JL, JK)*ZMFS 
    ZMFUL (JL, JK)=ZMFUL (JL, JK)*ZMFS 
    ZDMFUP (JL, JK)=ZDMFUP (JL, JK)*ZMFS 
    ZDMFEN (JL, JK)=ZDMFEN (JL, JK)*ZMFS 
    PLUDE (JL, JK)=PLUDE (JL, JK)*ZMFS 
    PLUDELI (JL, JK, 1)=PLUDELI (JL, JK, 1)*ZMFS 
    PLUDELI (JL, JK, 2)=PLUDELI (JL, JK, 2)*ZMFS 
    PMFUDE_RATE (JL, JK)=PMFUDE_RATE (JL, JK)*ZMFS 
  ENDIF

  
ENDDO



IF (KTYPE (JL)==2.AND.KCBOT (JL)==KCTOP (JL).AND.KCBOT (JL)>=KLEV-1) THEN
  LDCUM (JL)=.FALSE.
  KTYPE (JL)=0
ENDIF



LLO2 =.FALSE.

IF ((.NOT.LDSHCV (JL).AND.KTYPE (JL)==2)) THEN
  LLO2 =.TRUE.
  LDCUM (JL)=.FALSE.
ENDIF



LDCUM_LIG (JL)=LDCUM (JL)
KCTOP_LIG (JL)=KCTOP (JL)
KCBOT_LIG (JL)=KCBOT (JL)


IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

  

  IF ((.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.AND.KTYPE (JL)==2).OR.(&
    &.NOT.YDML_PHY_EC%YRECUMF%LMFPEN.AND.KTYPE (JL)==1)) THEN
    LLO2 =.TRUE.
    LDCUM (JL)=.FALSE.
  ENDIF

  
ENDIF



IF (LLDDRAF (JL).AND.IDTOP (JL)<=KCTOP (JL)) THEN
  IDTOP (JL)=KCTOP (JL)+1
ENDIF



DO JK=2, KLEV

  

  IF (LLDDRAF (JL)) THEN

    IF (JK<IDTOP (JL)) THEN
      PMFD (JL, JK)=0.0_JPRB
      ZMFDS (JL, JK)=0.0_JPRB
      ZMFDQ (JL, JK)=0.0_JPRB
      PMFDDE_RATE (JL, JK)=0.0_JPRB
      ZDMFDP (JL, JK)=0.0_JPRB
    ELSEIF (JK==IDTOP (JL)) THEN
      PMFDDE_RATE (JL, JK)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO

CALL CUFLXN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA&
&, KFDIA, KLON, KLEV, PTSPHY, PTEN, PQEN, PQSEN, ZTENH, ZQENH, PAPH, PAP, PGEOH, LDLAND&
&, LDCUM, LDTDKMF, KCBOT, KCTOP, IDTOP, ITOPM2, KTYPE, LLDDRAF, PMFU, PMFD, ZMFUS, ZMFDS&
&, ZMFUQ, ZMFDQ, ZMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, ZDMFUP, ZDMFDP, ZDPMEL, PLGLAC&
&, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK=YLSTACK)

DO JK=2, KLEV-1

  

  IF (LLDDRAF (JL).AND.JK>=IDTOP (JL)-1) THEN
    ZERATE=-PMFD (JL, JK)+PMFD (JL, JK-1)+PMFDDE_RATE (JL, JK)

    IF (ZERATE<0.0_JPRB) THEN
      PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)-ZERATE
    ENDIF

  ENDIF


  IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
    ZERATE=PMFU (JL, JK)-PMFU (JL, JK+1)+PMFUDE_RATE (JL, JK)

    IF (ZERATE<0.0_JPRB) THEN
      PMFUDE_RATE (JL, JK)=PMFUDE_RATE (JL, JK)-ZERATE
    ENDIF

    ZDMFUP (JL, JK)=PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1)-PMFLXR (JL, JK)-PMFLXS (JL, JK)
    ZDMFDP (JL, JK)=0.0_JPRB
  ENDIF

  
ENDDO



IF (LLDDRAF (JL)) THEN
  JK=IDTOP (JL)
  IK=MIN (JK+1, KLEV)

  IF (ZMFDQ (JL, JK)<0.3_JPRB*ZMFDQ (JL, IK)) THEN

    IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ==0.0_JPRB) THEN
      ZMFDQ (JL, JK)=0.3_JPRB*ZMFDQ (JL, IK)
    ELSE
      PMFD (JL, JK)=0.3_JPRB*PMFD (JL, IK)
    ENDIF

  ENDIF

ENDIF



DO JK=2, KLEV

  

  IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1.AND.JK<KCBOT (JL)) THEN
    ZDZ=PTSPHY*YDCST%RG/(PAPH (JL, JK+1)-PAPH (JL, JK))
    ZMFA=ZMFUQ (JL, JK+1)+ZMFDQ (JL, JK+1)-ZMFUQ (JL, JK)-ZMFDQ (JL, JK)+ZMFUL (JL&
    &, JK+1)-ZMFUL (JL, JK)+ZDMFUP (JL, JK)-PSNDE (JL, JK, 1)-PSNDE (JL, JK, 2)
    ZMFA=(ZMFA-PLUDE (JL, JK))*ZDZ

    IF (PQEN (JL, JK)+ZMFA<0.0_JPRB.AND.PLUDE (JL, JK)>0.0_JPRB) THEN
      ZFAC=MIN (-(PQEN (JL, JK)+ZMFA)/ZDZ, PLUDE (JL, JK))
      PLUDE (JL, JK)=PLUDE (JL, JK)+ZFAC
      PLUDELI (JL, JK, 1)=PLUDELI (JL, JK, 1)+ZFAC*PLUDELI (JL, JK, 1)/PLUDE (JL, JK)
      PLUDELI (JL, JK, 2)=PLUDELI (JL, JK, 2)+ZFAC*PLUDELI (JL, JK, 2)/PLUDE (JL, JK)
    ENDIF


    IF (PLUDE (JL, JK)<0.0_JPRB) THEN
      PLUDE (JL, JK)=0.0_JPRB
      PLUDELI (JL, JK, 1)=0.0_JPRB
      PLUDELI (JL, JK, 2)=0.0_JPRB
    ENDIF

  ENDIF


  IF (.NOT.LDCUM (JL)) THEN
    PMFUDE_RATE (JL, JK)=0.0_JPRB
  ENDIF


  IF (PMFD (JL, JK-1)==0.0_JPRB) THEN
    PMFDDE_RATE (JL, JK)=0.0_JPRB
  ENDIF

  
ENDDO


IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ>0.0_JPRB) THEN

  DO JK=KLEV, 2,-1

    

    IF (LDCUM (JL)) THEN

      IF (JK>KCBOT (JL)) THEN
        ZMFA=1.0_JPRB/MAX (1.E-15_JPRB, PMFU (JL, JK))
        PQU (JL, JK)=ZQENH (JL, JK)+ZMFUQ (JL, JK)*ZMFA
        PTU (JL, JK)=ZTENH (JL, JK)+ZMFUS (JL, JK)*ZMFA*ZORCPD
        ZMFUS (JL, JK)=PMFU (JL, JK)*(YDCST%RCPD*PTU (JL, JK)+PGEOH (JL, JK))
        ZMFUQ (JL, JK)=PMFU (JL, JK)*PQU (JL, JK)

        IF (LLDDRAF (JL)) THEN
          ZMFA=1.0_JPRB/MIN (-1.E-15_JPRB, PMFD (JL, JK))
          ZQD (JL, JK)=ZQENH (JL, JK)+ZMFDQ (JL, JK)*ZMFA
          ZTD (JL, JK)=ZTENH (JL, JK)+ZMFDS (JL, JK)*ZMFA*ZORCPD
          ZMFDQ (JL, JK)=PMFD (JL, JK)*ZQD (JL, JK)
          ZMFDS (JL, JK)=PMFD (JL, JK)*(YDCST%RCPD*ZTD (JL, JK)+PGEOH (JL, JK))
        ENDIF

      ELSEIF (JK<=KCBOT (JL).AND.JK>=KCTOP (JL)) THEN
        ZMFUS (JL, JK)=PMFU (JL, JK)*(YDCST%RCPD*PTU (JL, JK)+PGEOH (JL, JK))
        ZMFUQ (JL, JK)=PMFU (JL, JK)*PQU (JL, JK)
        ZMFDS (JL, JK)=PMFD (JL, JK)*(YDCST%RCPD*ZTD (JL, JK)+PGEOH (JL, JK))
        ZMFDQ (JL, JK)=PMFD (JL, JK)*ZQD (JL, JK)
      ENDIF

    ENDIF

  
  ENDDO

ENDIF

CALL CUDTDQN_OPENACC (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_SLIN%YRPHNC, YDML_PHY_EC&
&%YRECUMF, YDML_PHY_EC%YREPHY, KIDIA, KFDIA, KLON, KLEV, ITOPM2, KTYPE, KCTOP, KCBOT, IDTOP&
&, LDTDKMF, LDCUM, LLDDRAF, LLSCVFLAG, PTSPHY, PAPH, PAP, PGEOH, PGEO, PTEN, ZTENH, PQEN&
&, ZQENH, PQSEN, PLGLAC, PLUDE, PLUDELI, PSNDE, PMFU, PMFD, ZMFUS, ZMFDS, ZMFUQ, ZMFDQ, ZMFUL&
&, ZDMFUP, ZDPMEL, PMFLXR, PMFLXS, PTENT, PTENQ, PENTH, YDSTACK=YLSTACK)

IF (YDML_PHY_EC%YRECUMF%LMFDUDV) THEN

  DO JK=KLEV-1, 2,-1
    IK=JK+1

    

    IF (LDCUM (JL)) THEN

      IF (JK==KCBOT (JL).AND.KTYPE (JL)<3) THEN
        IKB=IDPL (JL)
        ZUU (JL, JK)=PUEN (JL, IKB-1)
        ZVU (JL, JK)=PVEN (JL, IKB-1)
      ELSEIF (JK==KCBOT (JL).AND.KTYPE (JL)==3) THEN
        ZUU (JL, JK)=PUEN (JL, JK-1)
        ZVU (JL, JK)=PVEN (JL, JK-1)
      ENDIF


      IF (JK<KCBOT (JL).AND.JK>=KCTOP (JL)) THEN
        ZFAC=0.0_JPRB

        IF (LDTDKMF.AND.(KTYPE (JL)==1.OR.KTYPE (JL)==3))  THEN
          ZFAC=2.0_JPRB
        ENDIF

        ZERATE=PMFU (JL, JK)-PMFU (JL, IK)+(1.0_JPRB+ZFAC)*PMFUDE_RATE (JL, JK)
        ZDERATE=(1.0_JPRB+ZFAC)*PMFUDE_RATE (JL, JK)
        ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, PMFU (JL, JK))
        ZUU (JL, JK)=(ZUU (JL, IK)*PMFU (JL, IK)+ZERATE*PUEN (JL, JK)-ZDERATE*ZUU (JL, IK))*ZMFA
        ZVU (JL, JK)=(ZVU (JL, IK)*PMFU (JL, IK)+ZERATE*PVEN (JL, JK)-ZDERATE*ZVU (JL, IK))*ZMFA
      ENDIF

    ENDIF

  
  ENDDO


  DO JK=3, KLEV
    IK=JK-1

    

    IF (LDCUM (JL)) THEN

      IF (JK==IDTOP (JL)) THEN
        ZUD (JL, JK)=0.5_JPRB*(ZUU (JL, JK)+PUEN (JL, IK))
        ZVD (JL, JK)=0.5_JPRB*(ZVU (JL, JK)+PVEN (JL, IK))
      ELSEIF (JK>IDTOP (JL)) THEN
        ZERATE=-PMFD (JL, JK)+PMFD (JL, IK)+PMFDDE_RATE (JL, JK)
        ZMFA=1.0_JPRB/MIN (-YDML_PHY_EC%YRECUMF%RMFCMIN, PMFD (JL, JK))
        ZUD (JL, JK)=(ZUD (JL, IK)*PMFD (JL, IK)-ZERATE*PUEN&
        & (JL, IK)+PMFDDE_RATE (JL, JK)*ZUD (JL, IK))*ZMFA
        ZVD (JL, JK)=(ZVD (JL, IK)*PMFD (JL, IK)-ZERATE*PVEN&
        & (JL, IK)+PMFDDE_RATE (JL, JK)*ZVD (JL, IK))*ZMFA
      ENDIF

    ENDIF

  
  ENDDO

  ZMFS =1.0_JPRB

  IF (YDML_PHY_EC%YRECUMF%RMFSOLUV<=1.0_JPRB) THEN

    DO JK=2, KLEV

      

      IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
        ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*ZCONS

        IF (PMFU (JL, JK)>ZMFMAX.AND.JK>=KCTOP (JL))  THEN
          ZMFS =MIN (ZMFS , ZMFMAX/PMFU (JL, JK))
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF


  DO JK=1, KLEV
    
    ZMFUUS (JL, JK)=PMFU (JL, JK)
    ZMFDUS (JL, JK)=PMFD (JL, JK)

    IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
      ZMFUUS (JL, JK)=PMFU (JL, JK)*ZMFS 
      ZMFDUS (JL, JK)=PMFD (JL, JK)*ZMFS 
    ENDIF

  
  ENDDO


  IF (YDML_PHY_EC%YRECUMF%RMFSOLUV>0.0_JPRB) THEN

    

    IF (LDCUM (JL)) THEN
      JK=KCBOT (JL)
      IK=JK-1
      ZMFUUB =ZMFUUS (JL, JK)*(ZUU (JL, JK)-PUEN (JL, IK))
      ZMFUVB =ZMFUUS (JL, JK)*(ZVU (JL, JK)-PVEN (JL, IK))
    ENDIF


    

    DO JK=2, KLEV
      IK=JK-1

      

      IF (LDCUM (JL).AND.JK>KCBOT (JL)) THEN
        IKB=KCBOT (JL)
        ZDZ=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))

        IF (KTYPE (JL)==3) THEN
          ZDZ=ZDZ*ZDZ
        ENDIF

        ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUUS (JL, JK))
        ZUU (JL, JK)=PUEN (JL, IK)+ZMFUUB *ZDZ*ZMFA
        ZVU (JL, JK)=PVEN (JL, IK)+ZMFUVB *ZDZ*ZMFA
        ZMFDUS (JL, JK)=ZMFDUS (JL, IKB)*ZDZ
        ZUD (JL, JK)=PUEN (JL, IK)+ZUD (JL, IKB)-PUEN (JL, IKB-1)
        ZVD (JL, JK)=PVEN (JL, IK)+ZVD (JL, IKB)-PVEN (JL, IKB-1)
      ENDIF


      IF (LDCUM (JL).AND.JK>=KCTOP (JL)) THEN

        IF (LDTDKMF) THEN
          ZUU (JL, JK)=ZUU (JL, JK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZUU (JL, JK))
          ZVU (JL, JK)=ZVU (JL, JK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZVU (JL, JK))
        ELSE
          ZUU (JL, JK)=ZUU (JL, JK)-MIN (ABS (ZUU (JL, JK)), YDML_PHY_EC&
          &%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZUU (JL, JK))
          ZVU (JL, JK)=ZVU (JL, JK)-MIN (ABS (ZVU (JL, JK)), YDML_PHY_EC&
          &%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZVU (JL, JK))
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF

  CALL CUDUDV_OPENACC (YDCST, YDML_PHY_EC%YRECUMF, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA,&
  & KLON, KLEV, ITOPM2, KTYPE, KCBOT, KCTOP, LDCUM, PTSPHY, PAPH, PAP, PUEN, PVEN, ZMFUUS&
  &, ZMFDUS, PMFU, PMFD, ZUU, ZUD, ZVU, ZVD, PGP2DSPP, PTENU, PTENV, YDSTACK=YLSTACK)

  IF (YDML_PHY_EC%YRECUMF%LMFUVDIS) THEN
    
    ZSUM12 =0.0_JPRB
    ZSUM22 =0.0_JPRB

    

    DO JK=1, KLEV
      
      ZUV2 (JL, JK)=0.0_JPRB

      IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
        ZDZ=(PAPH (JL, JK+1)-PAPH (JL, JK))
        ZDUTEN=PTENU (JL, JK)-ZTENU (JL, JK)
        ZDVTEN=PTENV (JL, JK)-ZTENV (JL, JK)
        ZUV2 (JL, JK)=SQRT (ZDUTEN**2+ZDVTEN**2)
        ZSUM22 =ZSUM22 +ZUV2 (JL, JK)*ZDZ
        ZSUM12 =ZSUM12 -(PUEN (JL, JK)*ZDUTEN+PVEN (JL, JK)*ZDVTEN)*ZDZ
      ENDIF

    
    ENDDO

    
    PVDISCU (JL)=ZSUM12 *ZRG

    

    DO JK=1, KLEV

      

      IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
        ZTDIS=ZORCPD*ZSUM12 *ZUV2 (JL, JK)/MAX (1.E-15_JPRB, ZSUM22 )
        PTENT (JL, JK)=PTENT (JL, JK)+ZTDIS
      ENDIF

    
    ENDDO

  ENDIF

ENDIF


IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

  DO JK=2, KLEV

    

    IF (LLO2 .AND.JK>=KCTOP (JL)-1) THEN
      PMFUDE_RATE (JL, JK)=0.0_JPRB
      PMFDDE_RATE (JL, JK)=0.0_JPRB
    ENDIF

  
  ENDDO


  

  IF (LLO2 ) THEN
    KCTOP (JL)=KLEV-1
    KCBOT (JL)=KLEV-1
  ENDIF

  
ENDIF


IF (YDML_PHY_EC%YREPHY%LMFTRAC.AND.KTRAC>0) THEN

  

  IF (LDCUM (JL).AND.KTYPE (JL)/=3.AND.KCBOT (JL)-KCTOP (JL)>=1) THEN
    LLDCUM (JL)=.TRUE.
    LLDDRAF3 (JL)=LLDDRAF (JL)
  ELSE
    LLDCUM (JL)=.FALSE.
    LLDDRAF3 (JL)=.FALSE.
  ENDIF

  
  ZMFS =1.0_JPRB

  IF (YDML_PHY_EC%YRECUMF%RMFSOLCT<=3.0_JPRB) THEN

    DO JK=2, KLEV

      

      IF (LLDCUM (JL).AND.JK>=KCTOP (JL)) THEN
        ZMFMAX=(PAPH (JL, JK)-PAPH (JL, JK-1))*0.8_JPRB*ZCONS

        IF (PMFU (JL, JK)>ZMFMAX)  THEN
          ZMFS =MIN (ZMFS , ZMFMAX/PMFU (JL, JK))
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF


  DO JK=1, KLEV

    

    IF (LLDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
      ZMFUUS (JL, JK)=PMFU (JL, JK)*ZMFS 
      ZMFUDR (JL, JK)=PMFUDE_RATE (JL, JK)*ZMFS 
      ZDMFUPC (JL, JK)=(PMFLXR (JL, JK)+PMFLXS (JL, JK))*ZMFS 
      IKB=KCBOT (JL)

      IF (JK>IKB) THEN
        ZDMFUPC (JL, JK)=ZDMFUPC (JL, IKB)
      ENDIF

    ELSE
      ZMFUUS (JL, JK)=0._JPRB
      ZMFUDR (JL, JK)=0._JPRB
    ENDIF


    IF (LLDDRAF3 (JL).AND.JK>=IDTOP (JL)-1) THEN
      ZMFDUS (JL, JK)=PMFD (JL, JK)*ZMFS 
      ZMFDDR (JL, JK)=PMFDDE_RATE (JL, JK)*ZMFS 
      ZDMFDPC (JL, JK)=0.0_JPRB
    ELSE
      ZMFDUS (JL, JK)=0._JPRB
      ZMFDDR (JL, JK)=0._JPRB
    ENDIF

  
  ENDDO


  IF (YDML_PHY_EC%YRECUMF%LMFSMOOTH) THEN

    DO JK=2, KLEV-1

      

      IF (LLDDRAF3 (JL).AND.ZMFDUS (JL, JK)<0.0_JPRB.AND.ZMFDUS (JL, JK+1)==0.0_JPRB) THEN
        ZERATE=MIN (0._JPRB, ZMFDUS (JL, JK)-0.5*ZMFDUS (JL, JK-1))
        ZMFDUS (JL, JK)=ZMFDUS (JL, JK)-ZERATE
        ZMFDDR (JL, JK)=ZMFDDR (JL, JK)-ZERATE
        ZMFDDR (JL, JK+1)=-ZMFDUS (JL, JK)
      ENDIF


      IF (LLDCUM (JL).AND.JK==KCTOP (JL)) THEN
        ZERATE=MAX (0.0_JPRB, ZMFUUS (JL, JK)-0.5_JPRB*ZMFUUS (JL, JK+1))
        ZMFUUS (JL, JK)=ZMFUUS (JL, JK)-ZERATE
        ZMFUDR (JL, JK)=ZMFUDR (JL, JK)+ZERATE
        ZMFUDR (JL, JK-1)=ZMFUUS (JL, JK)
      ENDIF

    
    ENDDO


    DO JK=KLEV-1, 2,-1

      

      IF (LLDCUM (JL)) THEN

        IF (ZMFUDR (JL, JK)==0.0_JPRB.AND.ZMFUDR (JL, JK-1)>0.0_JPRB) THEN
          ZMFUDR (JL, JK)=0.5_JPRB*ZMFUDR (JL, JK-1)
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF


  IF (YDML_PHY_EC%YREPHY%LMFSCAV) THEN
    CALL CUCTRACER_OPENACC (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF,&
    & KIDIA, KFDIA, KLON, KLEV, KTRAC, KCTOP, IDTOP, KTYPE, LLDCUM, LLDDRAF3, PTSPHY, PAPH, PAP, ZMFUUS&
    &, ZMFDUS, PMFU, PMFD, ZMFUDR, ZMFDDR, ZDMFUPC, ZDMFDPC, PCEN, PTENC, PSCAV, YDSTACK=YLSTACK)
  ELSE
    ZDMFUPC (JL,:)=0.0_JPRB
    CALL CUCTRACER_OPENACC (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF,&
    & KIDIA, KFDIA, KLON, KLEV, KTRAC, KCTOP, IDTOP, KTYPE, LLDCUM, LLDDRAF3, PTSPHY, PAPH, PAP, ZMFUUS&
    &, ZMFDUS, PMFU, PMFD, ZMFUDR, ZMFDDR, ZDMFUPC, ZDMFDPC, PCEN, PTENC, PSCAV0, YDSTACK=YLSTACK)
  ENDIF

ENDIF

PDISS (JL, 1)=0.0_JPRB
ZAR=1.0_JPRB/20.89_JPRB
ZAS=1.0_JPRB/29.51_JPRB
ZBR=1.0_JPRB/1.15_JPRB
ZBS=1.0_JPRB/1.10_JPRB
ZAK=1.0_JPRB/5.09E-3_JPRB

DO JK=1, KLEV
  IK=MIN (JK+1, KLEV)
  IKD=MAX (JK-1, 1)
  
  PDISS (JL, JK)=0.0_JPRB
  PRSUD (JL, JK, 1)=0.0_JPRB
  PRSUD (JL, JK, 2)=0.0_JPRB

  IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
    PLUDELI (JL, JK, 3)=PMFUDE_RATE (JL, JK)*(PQU (JL, IK)-ZQENH (JL&
    &, IK))+PMFDDE_RATE (JL, JK)*(ZQD (JL, IKD)-ZQENH (JL, IKD))
    PLUDELI (JL, JK, 4)=PMFUDE_RATE (JL, JK)*(PTU (JL, IK)-ZTENH (JL&
    &, IK))+PMFDDE_RATE (JL, JK)*(ZTD (JL, IKD)-ZTENH (JL, IKD))
    ZRO=YDCST%RG/(PGEOH (JL, JK)-PGEOH (JL, JK+1))
    PMFUDE_RATE (JL, JK)=PMFUDE_RATE (JL, JK)*ZRO
    PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)*ZRO
    ZRO=YDCST%RD*PTEN (JL, JK)*(1.0_JPRB+YDCST%RETV*PQEN (JL, JK))/PAP (JL, JK)
    ZDUTEN=PTENU (JL, JK)-ZTENU (JL, JK)
    ZDVTEN=PTENV (JL, JK)-ZTENV (JL, JK)
    PDISS (JL, JK)=ABS (PUEN (JL, JK)*ZDUTEN+PVEN (JL, JK)*ZDVTEN)**0.3333
    PRSUD (JL, JK, 1)=1.E-3_JPRB*ZRO*(PMFLXR (JL, JK)*3600._JPRB*ZAR)**ZBR
    PRSUD (JL, JK, 2)=0.5*1.E-3_JPRB*ZRO*(10.0_JPRB*PMFLXS (JL, JK)*3600._JPRB*ZAS)**ZBS
  ELSE
    PMFU (JL, JK)=0.0_JPRB
    PMFD (JL, JK)=0.0_JPRB
    PLUDE (JL, JK)=0.0_JPRB
    PLUDELI (JL, JK, 1)=0.0_JPRB
    PLUDELI (JL, JK, 2)=0.0_JPRB
    PLUDELI (JL, JK, 3)=0.0_JPRB
    PLUDELI (JL, JK, 4)=0.0_JPRB
    PSNDE (JL, JK, 1)=0.0_JPRB
    PSNDE (JL, JK, 2)=0.0_JPRB
    PTU (JL, JK)=PTEN (JL, JK)
    PQU (JL, JK)=PQEN (JL, JK)
    PLU (JL, JK)=0.0_JPRB
    PENTH (JL, JK)=0.0_JPRB
    PMFUDE_RATE (JL, JK)=0.0_JPRB
    PMFDDE_RATE (JL, JK)=0.0_JPRB
  ENDIF

  
ENDDO



END SUBROUTINE CUMASTRN_OPENACC
