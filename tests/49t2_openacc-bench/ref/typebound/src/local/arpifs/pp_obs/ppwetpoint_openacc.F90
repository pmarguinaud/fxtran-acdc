SUBROUTINE PPWETPOINT_OPENACC (YDCST, YDPHY, KIDIA, KFDIA, KLON&
&, KLEV, PAPRS, PT, PQV, PQL, PQI, PWETPOINT, YDSTACK)
!$ACC ROUTINE (PPWETPOINT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMPHY,ONLY:TPHY
USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PWETPOINT (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZPITER 
REAL (KIND=JPRB)::ZFUNCT 
REAL (KIND=JPRB)::ZS2 
REAL (KIND=JPRB)::ZDEL 
REAL (KIND=JPRB)::ZTITER 
REAL (KIND=JPRB)::ZCONS 
REAL (KIND=JPRB)::ZS1 
REAL (KIND=JPRB)::ZRRT 
REAL (KIND=JPRB)::ZCPT 
REAL (KIND=JPRB)::ZRT 
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JIT
REAL (KIND=JPRB)::ZTMIN
REAL (KIND=JPRB)::ZTMAX
REAL (KIND=JPRB)::ZTIN
REAL (KIND=JPRB)::ZRV
REAL (KIND=JPRB)::ZRS
REAL (KIND=JPRB)::ZRL
REAL (KIND=JPRB)::ZRI
REAL (KIND=JPRB)::ZRDSV
REAL (KIND=JPRB)::ZQVSAT
REAL (KIND=JPRB)::ZQV
REAL (KIND=JPRB)::ZQL
REAL (KIND=JPRB)::ZQI
REAL (KIND=JPRB)::ZPRS
REAL (KIND=JPRB)::ZLSTTW
REAL (KIND=JPRB)::ZLSTTI
REAL (KIND=JPRB)::ZLSTT
REAL (KIND=JPRB)::ZLSTC
REAL (KIND=JPRB)::ZLHZW
REAL (KIND=JPRB)::ZLHZI
REAL (KIND=JPRB)::ZLHZ
REAL (KIND=JPRB)::ZLH
REAL (KIND=JPRB)::ZKNW
REAL (KIND=JPRB)::ZKNI
REAL (KIND=JPRB)::ZKDW
REAL (KIND=JPRB)::ZKDI
REAL (KIND=JPRB)::ZKAPPA
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZEW
REAL (KIND=JPRB)::ZEPSRH
REAL (KIND=JPRB)::ZEPSP
REAL (KIND=JPRB)::ZE
REAL (KIND=JPRB)::ZDLSTT
REAL (KIND=JPRB)::ZDLEW
REAL (KIND=JPRB)::ZDF
REAL (KIND=JPRB)::ZDELTA
REAL (KIND=JPRB)::ZCWS
REAL (KIND=JPRB)::ZCPLNTT

#include "fcttrm.func.h"

JLON = KIDIA



ZRDSV=YDCST%RD/YDCST%RV
ZLSTTW=FOLH (YDCST%RTT, 0.0_JPRB)/YDCST%RTT+YDCST%RCW&
&*YDCST%RV/(FOLH (YDCST%RTT, 0.0_JPRB)/YDCST%RTT)
ZLSTTI=FOLH (YDCST%RTT, 1.0_JPRB)/YDCST%RTT+YDCST%RCS&
&*YDCST%RV/(FOLH (YDCST%RTT, 1.0_JPRB)/YDCST%RTT)
ZLHZW=FOLH (0.0_JPRB, 0.0_JPRB)
ZLHZI=FOLH (0.0_JPRB, 1.0_JPRB)
ZKNW=YDCST%RESTT*FOLH (YDCST%RTT, 0.0_JPRB)/(YDCST%RV*YDCST%RTT)
ZKNI=YDCST%RESTT*FOLH (YDCST%RTT, 1.0_JPRB)/(YDCST%RV*YDCST%RTT)
ZKDW=YDCST%RKAPPA*YDCST%RESTT*(FOLH (YDCST%RTT, 0.0_JPRB)/(YDCST%RV*YDCST%RTT))**2
ZKDI=YDCST%RKAPPA*YDCST%RESTT*(FOLH (YDCST%RTT, 1.0_JPRB)/(YDCST%RV*YDCST%RTT))**2
ZCPLNTT=YDCST%RCPD*LOG (YDCST%RTT)
ZEPSP=10._JPRB
ZEPSRH=0.001_JPRB
ZTMIN=155._JPRB
ZTMAX=355._JPRB

DO JLEV=1, KLEV

  

  IF (YDPHY%LNEIGE) THEN
    ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PT (JLON, JLEV)))
  ELSE
    ZDELTA=0.0_JPRB
  ENDIF

  ZQL=MAX (0.0_JPRB, PQL (JLON, JLEV))
  ZQI=MAX (0.0_JPRB, PQI (JLON, JLEV))
  ZTIN=MAX (ZTMIN, MIN (ZTMAX, PT (JLON, JLEV)))
  ZPRS=MAX (ZEPSP, PAPRS (JLON, JLEV))
  ZQVSAT=FOQS (FOEW (ZTIN, ZDELTA)/ZPRS)
  ZQV=MAX (ZEPSRH*ZQVSAT, PQV (JLON, JLEV))
  ZRV=ZQV/(1.0_JPRB-ZQV-ZQL-ZQI)
  ZRL=ZQL/(1.0_JPRB-ZQV-ZQL-ZQI)
  ZRI=ZQI/(1.0_JPRB-ZQV-ZQL-ZQI)
  ZRT =ZRV+ZRL+ZRI
  ZCPT =YDCST%RCPD+YDCST%RCPV*ZRT 
  ZRRT =YDCST%RD+YDCST%RV*ZRT 
  ZE=(ZRV*ZPRS)/(ZRV+ZRDSV)
  ZS1 =ZCPT *LOG (ZTIN)-YDCST%RD*LOG (ZPRS-ZE)-YDCST%RV*ZRT *LOG (ZE&
  &)-(FOLH (ZTIN, 0.0_JPRB)*ZRL+FOLH (ZTIN, 1.0_JPRB)*ZRI)/ZTIN
  ZCONS =ZS1 +YDCST%RD*LOG (ZRDSV/ZRT )
  ZTITER =ZTIN

  

  DO JIT=1, YDPHY%NBITER

    

    IF (YDPHY%LNEIGE) THEN
      ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-ZTITER ))
    ELSE
      ZDELTA=0.0_JPRB
    ENDIF

    ZEW=FOEW (ZTITER , ZDELTA)
    ZDLEW=FODLEW (ZTITER , ZDELTA)
    ZF=ZCONS +ZRRT *LOG (ZEW)-ZCPT *LOG (ZTITER )
    ZDF=ZRRT *ZDLEW-ZCPT /ZTITER 
    ZTITER =ZTITER -ZF/ZDF
  
  ENDDO


  

  IF (YDPHY%LNEIGE) THEN
    ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-ZTITER ))
  ELSE
    ZDELTA=0.0_JPRB
  ENDIF

  ZDEL =ZDELTA
  ZEW=FOEW (ZTITER , ZDELTA)
  ZLSTT=ZLSTTW+ZDELTA*(ZLSTTI-ZLSTTW)
  ZCWS=YDCST%RCW+ZDELTA*(YDCST%RCS-YDCST%RCW)
  ZLSTC=FOLH (ZTITER , ZDELTA)/ZTITER +ZCWS*YDCST%RV/(FOLH (ZTITER , ZDELTA)/ZTITER )
  ZFUNCT =ZRDSV*YDCST%RESTT*ZLSTT
  ZS2 =ZS1 +ZRT *(ZLSTC+YDCST%RV*LOG (ZEW)-YDCST%RCPV*LOG (ZTITER ))
  ZCONS =ZS2 -ZCPLNTT
  ZKAPPA=YDCST%RKAPPA*(1.0_JPRB+ZRT *FOLH (ZTITER , ZDELTA)/(YDCST%RD*ZTITER ))/(1.0_JPRB&
  &+YDCST%RKAPPA*ZRT *FOLH (ZTITER , ZDELTA)**2/(YDCST%RD*YDCST%RV*ZTITER **2))
  ZPITER =(ZRDSV*ZEW/ZRT )*(YDCST%RTT/ZTITER )**(1.0_JPRB/ZKAPPA)-YDCST%RESTT
  ZPITER =MAX (ZPITER , ZEPSP)

  

  DO JIT=1, YDPHY%NBITER+1
    
    ZF=ZCONS +YDCST%RD*LOG (ZPITER )-ZFUNCT /ZPITER 
    ZDF=(YDCST%RD*ZPITER +ZFUNCT )/ZPITER **2
    ZPITER =ZPITER -ZF/ZDF
  
  ENDDO

  
  ZPITER =ZPITER +YDCST%RESTT

  

  

  IF (YDPHY%LNEIGE) THEN
    ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, ZPITER -PAPRS (JLON, JLEV)))
  ELSE
    ZDELTA=0.0_JPRB
  ENDIF

  ZDLSTT=(ZDELTA-ZDEL )*(ZLSTTI-ZLSTTW)
  ZDEL =ZDELTA
  ZS2 =ZS2 +ZDLSTT*ZRDSV*YDCST%RESTT/(ZPITER -YDCST%RESTT)
  ZKAPPA=YDCST%RKAPPA*(1.0_JPRB+(ZKNW+ZDELTA*(ZKNI-ZKNW))/ZPITER&
  & )/(1.0_JPRB+(ZKDW+ZDELTA*(ZKDI-ZKDW))/ZPITER )
  ZTITER =YDCST%RTT*(PAPRS (JLON, JLEV)/ZPITER )**ZKAPPA

  

  DO JIT=1, YDPHY%NBITER
    
    ZEW=FOEW (ZTITER , ZDEL )
    ZCWS=YDCST%RCW+ZDEL *(YDCST%RCS-YDCST%RCW)
    ZLHZ=ZLHZW+ZDEL *(ZLHZI-ZLHZW)
    ZLH=FOLH (ZTITER , ZDEL )
    ZLSTC=ZLH/ZTITER +ZCWS*YDCST%RV/(ZLH/ZTITER )
    ZRS=ZRDSV*ZEW/(PAPRS (JLON, JLEV)-ZEW)
    ZF=ZS2 -YDCST%RCPD*LOG (ZTITER )+YDCST%RD*LOG (PAPRS (JLON, JLEV)-ZEW)-ZRS*ZLSTC
    ZDF=-YDCST%RCPD/ZTITER -ZRS*((PAPRS (JLON, JLEV)/(PAPRS (JLON, JLEV)-ZEW))*ZLSTC*ZLH&
    &/(YDCST%RV*ZTITER **2)+ZCWS*YDCST%RV*ZLHZ/ZLH**2+(YDCST%RCPV-ZCWS)/ZTITER )
    ZTITER =ZTITER -ZF/ZDF
  
  ENDDO

  
  PWETPOINT (JLON, JLEV)=ZTITER 
  
ENDDO



END SUBROUTINE PPWETPOINT_OPENACC
