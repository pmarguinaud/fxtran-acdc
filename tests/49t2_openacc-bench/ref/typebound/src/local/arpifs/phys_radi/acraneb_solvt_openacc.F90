SUBROUTINE ACRANEB_SOLVT_OPENACC (YDPHY, LDNUMX, KIDIA, KFDIA, KLON, KTDIA, KLEV, PQICE, PQLI, PNEB, PB1&
&, PB2, PB3, PB4, PDELP, PBB, PDEOTI, PDEOTI2, PUEOTI, PUEOTI2, PEOLT, PEOXT, PRPROX, PMIXP, PFLUXC, PEO1TI&
&, PEO2TI, PEO1TN, PEO2TN, PEO1TA, PEO2TA, PDAMP, PEMIS, PRSURF, PFRTH, PFRTHDS, YDSTACK)
!$ACC ROUTINE (ACRANEB_SOLVT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMPHY,ONLY:TPHY

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TPHY), INTENT (IN)::YDPHY
LOGICAL, INTENT (IN)::LDNUMX
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PQICE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PB1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PB2 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PB3 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PB4 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PBB (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDEOTI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDEOTI2 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEOTI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEOTI2 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEOLT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEOXT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PRPROX (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMIXP (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFLUXC (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEO1TI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEO2TI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEO1TN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEO2TN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEO1TA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEO2TA (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDAMP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEMIS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PRSURF (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRTH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFRTHDS (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZEONT, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA5N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA4N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA5C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA4C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZTMN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZTMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZTDN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZTDC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZTMN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZTMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZTDN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZTDC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTMN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTDN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTDC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZFMN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZFMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZFDN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZZFDC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZFMN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZFMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZFDN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZFDC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFMN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFDN, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFDC, (KLON, 0:KLEV))
REAL (KIND=JPRB)::ZZFRS 
REAL (KIND=JPRB)::ZZFRB 
REAL (KIND=JPRB)::ZFRS 
REAL (KIND=JPRB)::ZFRB 
REAL (KIND=JPRB)::ZZTRS 
REAL (KIND=JPRB)::ZZTRB 
REAL (KIND=JPRB)::ZTRS 
REAL (KIND=JPRB)::ZTRB 
REAL (KIND=JPRB)::ZDRS 
REAL (KIND=JPRB)::ZDRB 
fxtran_acdc_temp (REAL (KIND=JPRB), ZDA4X, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDA4L, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDA4G, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZXEPC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZLEPC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGEPC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZTRTH, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZFRTH, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRTH, (KLON, 0:KLEV))
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
LOGICAL::LLREWS
REAL (KIND=JPRB)::ZTARSP
REAL (KIND=JPRB)::ZFTPP
REAL (KIND=JPRB)::ZDEL2
REAL (KIND=JPRB)::ZDEL1
REAL (KIND=JPRB)::ZTARE2
REAL (KIND=JPRB)::ZEFFE2
REAL (KIND=JPRB)::ZTRLI
REAL (KIND=JPRB)::ZARGLI

#include "acraneb_coeft_openacc.intfb.h"
#include "acraneb_solvt1_openacc.intfb.h"
#include "acraneb_solvt3_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZEONT) == 8) THEN
    fxtran_acdc_alloc8 (ZEONT)
ELSEIF (KIND (ZEONT) == 4) THEN
    fxtran_acdc_alloc4 (ZEONT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA5N) == 8) THEN
    fxtran_acdc_alloc8 (ZA5N)
ELSEIF (KIND (ZA5N) == 4) THEN
    fxtran_acdc_alloc4 (ZA5N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA4N) == 8) THEN
    fxtran_acdc_alloc8 (ZA4N)
ELSEIF (KIND (ZA4N) == 4) THEN
    fxtran_acdc_alloc4 (ZA4N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA5C) == 8) THEN
    fxtran_acdc_alloc8 (ZA5C)
ELSEIF (KIND (ZA5C) == 4) THEN
    fxtran_acdc_alloc4 (ZA5C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA4C) == 8) THEN
    fxtran_acdc_alloc8 (ZA4C)
ELSEIF (KIND (ZA4C) == 4) THEN
    fxtran_acdc_alloc4 (ZA4C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZTMN) == 8) THEN
    fxtran_acdc_alloc8 (ZZZTMN)
ELSEIF (KIND (ZZZTMN) == 4) THEN
    fxtran_acdc_alloc4 (ZZZTMN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZTMC) == 8) THEN
    fxtran_acdc_alloc8 (ZZZTMC)
ELSEIF (KIND (ZZZTMC) == 4) THEN
    fxtran_acdc_alloc4 (ZZZTMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZTDN) == 8) THEN
    fxtran_acdc_alloc8 (ZZZTDN)
ELSEIF (KIND (ZZZTDN) == 4) THEN
    fxtran_acdc_alloc4 (ZZZTDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZTDC) == 8) THEN
    fxtran_acdc_alloc8 (ZZZTDC)
ELSEIF (KIND (ZZZTDC) == 4) THEN
    fxtran_acdc_alloc4 (ZZZTDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZTMN) == 8) THEN
    fxtran_acdc_alloc8 (ZZTMN)
ELSEIF (KIND (ZZTMN) == 4) THEN
    fxtran_acdc_alloc4 (ZZTMN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZTMC) == 8) THEN
    fxtran_acdc_alloc8 (ZZTMC)
ELSEIF (KIND (ZZTMC) == 4) THEN
    fxtran_acdc_alloc4 (ZZTMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZTDN) == 8) THEN
    fxtran_acdc_alloc8 (ZZTDN)
ELSEIF (KIND (ZZTDN) == 4) THEN
    fxtran_acdc_alloc4 (ZZTDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZTDC) == 8) THEN
    fxtran_acdc_alloc8 (ZZTDC)
ELSEIF (KIND (ZZTDC) == 4) THEN
    fxtran_acdc_alloc4 (ZZTDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTMN) == 8) THEN
    fxtran_acdc_alloc8 (ZTMN)
ELSEIF (KIND (ZTMN) == 4) THEN
    fxtran_acdc_alloc4 (ZTMN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTMC) == 8) THEN
    fxtran_acdc_alloc8 (ZTMC)
ELSEIF (KIND (ZTMC) == 4) THEN
    fxtran_acdc_alloc4 (ZTMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTDN) == 8) THEN
    fxtran_acdc_alloc8 (ZTDN)
ELSEIF (KIND (ZTDN) == 4) THEN
    fxtran_acdc_alloc4 (ZTDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTDC) == 8) THEN
    fxtran_acdc_alloc8 (ZTDC)
ELSEIF (KIND (ZTDC) == 4) THEN
    fxtran_acdc_alloc4 (ZTDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZFMN) == 8) THEN
    fxtran_acdc_alloc8 (ZZZFMN)
ELSEIF (KIND (ZZZFMN) == 4) THEN
    fxtran_acdc_alloc4 (ZZZFMN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZFMC) == 8) THEN
    fxtran_acdc_alloc8 (ZZZFMC)
ELSEIF (KIND (ZZZFMC) == 4) THEN
    fxtran_acdc_alloc4 (ZZZFMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZFDN) == 8) THEN
    fxtran_acdc_alloc8 (ZZZFDN)
ELSEIF (KIND (ZZZFDN) == 4) THEN
    fxtran_acdc_alloc4 (ZZZFDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZFDC) == 8) THEN
    fxtran_acdc_alloc8 (ZZZFDC)
ELSEIF (KIND (ZZZFDC) == 4) THEN
    fxtran_acdc_alloc4 (ZZZFDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZFMN) == 8) THEN
    fxtran_acdc_alloc8 (ZZFMN)
ELSEIF (KIND (ZZFMN) == 4) THEN
    fxtran_acdc_alloc4 (ZZFMN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZFMC) == 8) THEN
    fxtran_acdc_alloc8 (ZZFMC)
ELSEIF (KIND (ZZFMC) == 4) THEN
    fxtran_acdc_alloc4 (ZZFMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZFDN) == 8) THEN
    fxtran_acdc_alloc8 (ZZFDN)
ELSEIF (KIND (ZZFDN) == 4) THEN
    fxtran_acdc_alloc4 (ZZFDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZFDC) == 8) THEN
    fxtran_acdc_alloc8 (ZZFDC)
ELSEIF (KIND (ZZFDC) == 4) THEN
    fxtran_acdc_alloc4 (ZZFDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFMN) == 8) THEN
    fxtran_acdc_alloc8 (ZFMN)
ELSEIF (KIND (ZFMN) == 4) THEN
    fxtran_acdc_alloc4 (ZFMN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFMC) == 8) THEN
    fxtran_acdc_alloc8 (ZFMC)
ELSEIF (KIND (ZFMC) == 4) THEN
    fxtran_acdc_alloc4 (ZFMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFDN) == 8) THEN
    fxtran_acdc_alloc8 (ZFDN)
ELSEIF (KIND (ZFDN) == 4) THEN
    fxtran_acdc_alloc4 (ZFDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFDC) == 8) THEN
    fxtran_acdc_alloc8 (ZFDC)
ELSEIF (KIND (ZFDC) == 4) THEN
    fxtran_acdc_alloc4 (ZFDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDA4X) == 8) THEN
    fxtran_acdc_alloc8 (ZDA4X)
ELSEIF (KIND (ZDA4X) == 4) THEN
    fxtran_acdc_alloc4 (ZDA4X)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDA4L) == 8) THEN
    fxtran_acdc_alloc8 (ZDA4L)
ELSEIF (KIND (ZDA4L) == 4) THEN
    fxtran_acdc_alloc4 (ZDA4L)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDA4G) == 8) THEN
    fxtran_acdc_alloc8 (ZDA4G)
ELSEIF (KIND (ZDA4G) == 4) THEN
    fxtran_acdc_alloc4 (ZDA4G)
ELSE
    STOP 1
ENDIF


IF (KIND (ZXEPC) == 8) THEN
    fxtran_acdc_alloc8 (ZXEPC)
ELSEIF (KIND (ZXEPC) == 4) THEN
    fxtran_acdc_alloc4 (ZXEPC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLEPC) == 8) THEN
    fxtran_acdc_alloc8 (ZLEPC)
ELSEIF (KIND (ZLEPC) == 4) THEN
    fxtran_acdc_alloc4 (ZLEPC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGEPC) == 8) THEN
    fxtran_acdc_alloc8 (ZGEPC)
ELSEIF (KIND (ZGEPC) == 4) THEN
    fxtran_acdc_alloc4 (ZGEPC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZTRTH) == 8) THEN
    fxtran_acdc_alloc8 (ZZTRTH)
ELSEIF (KIND (ZZTRTH) == 4) THEN
    fxtran_acdc_alloc4 (ZZTRTH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZFRTH) == 8) THEN
    fxtran_acdc_alloc8 (ZZFRTH)
ELSEIF (KIND (ZZFRTH) == 4) THEN
    fxtran_acdc_alloc4 (ZZFRTH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRTH) == 8) THEN
    fxtran_acdc_alloc8 (ZFRTH)
ELSEIF (KIND (ZFRTH) == 4) THEN
    fxtran_acdc_alloc4 (ZFRTH)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZARGLI=-250._JPRB
ZTRLI=EXP (ZARGLI)

DO JLEV=KTDIA-1, KLEV
  
  ZEONT (JLON, JLEV)=MIN (PUEOTI (JLON, JLEV), PDEOTI (JLON, JLEV))
  
ENDDO

CALL ACRANEB_COEFT_OPENACC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PDEOTI2 (1, 1), PEO1TI, PEO2TI&
&, PEO1TN, PEO2TN, PQICE, PQLI, PEO1TA, PEO2TA, ZA4C, ZA5C, ZA4N, ZA5N, YDSTACK=YLSTACK)

ZFDC (JLON, KTDIA-1)=EXP (MAX (-PDEOTI2 (JLON, KTDIA-1), ZARGLI))
ZFMC (JLON, KTDIA-1)=0._JPRB

IF (LDNUMX) THEN
  ZFDN (JLON, KTDIA-1)=0._JPRB
  ZFMN (JLON, KTDIA-1)=0._JPRB
ENDIF



DO JLEV=KTDIA, KLEV
  
  ZFMC (JLON, JLEV)=0._JPRB
  ZFDC (JLON, JLEV)=0._JPRB

  IF (LDNUMX) THEN
    ZFDN (JLON, JLEV)=0._JPRB
    ZFMN (JLON, JLEV)=0._JPRB
  ENDIF

  
ENDDO

CALL ACRANEB_SOLVT1_OPENACC (LDNUMX, KIDIA, KFDIA, KLON, KTDIA, KLEV, PEMIS, PNEB, PB1&
&, PB2, PB3, PB4, ZA4C, ZA5C, ZA4N, ZA5N, ZFDC, ZFMC, ZFDN, ZFMN, YDSTACK=YLSTACK)

ZTRS =ZFDC (JLON, KLEV)-ZFMC (JLON, KLEV)

IF (LDNUMX) THEN
  ZTRS =ZTRS +ZFDN (JLON, KLEV)-ZFMN (JLON, KLEV)
ENDIF

PFRTH (JLON, KLEV)=-PBB (JLON, KLEV)*MIN (1._JPRB, ZTRS *PRSURF (JLON))


DO JLEV=KLEV, KTDIA,-1
  
  ZTRB =ZTRS 
  
  
  ZTRS =ZFDC (JLON, JLEV-1)-ZFMC (JLON, JLEV-1)

  IF (LDNUMX) THEN
    ZTRS =ZTRS +ZFDN (JLON, JLEV-1)-ZFMN (JLON, JLEV-1)
  ENDIF

  PFRTH (JLON, JLEV-1)=PFRTH (JLON, JLEV)+PBB (JLON, JLEV-1)*&
  &(ZTRB -ZTRS )/(1._JPRB-(ZTRB -ZTRS )*PDAMP (JLON, JLEV))
  
ENDDO

CALL ACRANEB_COEFT_OPENACC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PUEOTI2 (1, 1), PEO1TI, PEO2TI&
&, PEO1TN, PEO2TN, PQICE, PQLI, PEO1TA, PEO2TA, ZA4C, ZA5C, ZA4N, ZA5N, YDSTACK=YLSTACK)

IF (LDNUMX) THEN
  
  ZFDC (JLON, KTDIA-1)=0._JPRB
  ZFMC (JLON, KTDIA-1)=0._JPRB
  ZFDC (JLON, KTDIA)=0._JPRB
  ZFMC (JLON, KLEV-1)=-ZA4C (JLON, KLEV)
  ZFDC (JLON, KLEV)=-ZA5C (JLON, KLEV)
  ZFMC (JLON, KLEV)=1._JPRB-PEMIS (JLON)
  ZFMC (JLON, KLEV-1)=ZFMC (JLON, KLEV-1)*(1._JPRB-PNEB (JLON, KLEV))
  ZFDC (JLON, KLEV)=ZFDC (JLON, KLEV)*(1._JPRB-PNEB (JLON, KLEV))
  ZFMC (JLON, KLEV)=ZFMC (JLON, KLEV)*(1._JPRB-PNEB (JLON, KLEV))
  ZFDN (JLON, KTDIA-1)=0._JPRB
  ZFMN (JLON, KTDIA-1)=0._JPRB
  ZFDN (JLON, KTDIA)=0._JPRB
  ZFMN (JLON, KLEV-1)=-ZA4N (JLON, KLEV)*PNEB (JLON, KLEV)
  ZFDN (JLON, KLEV)=-ZA5N (JLON, KLEV)*PNEB (JLON, KLEV)
  ZFMN (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*PNEB (JLON, KLEV)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZFDC (JLON, JLEV)=0._JPRB
    ZFMC (JLON, JLEV-1)=0._JPRB
    ZFDN (JLON, JLEV)=0._JPRB
    ZFMN (JLON, JLEV-1)=0._JPRB
  
  ENDDO

ELSE
  
  ZFDC (JLON, KTDIA-1)=0._JPRB
  ZFMC (JLON, KTDIA-1)=0._JPRB
  ZFDC (JLON, KTDIA)=0._JPRB
  ZFMC (JLON, KLEV-1)=-(ZA4C (JLON, KLEV)*PB1 (JLON, KLEV)+ZA4N (JLON, KLEV)*PNEB (JLON, KLEV))
  ZFDC (JLON, KLEV)=-(ZA5C (JLON, KLEV)*PB1 (JLON, KLEV)+ZA5N (JLON, KLEV)*PNEB (JLON, KLEV))
  ZFMC (JLON, KLEV)=1._JPRB-PEMIS (JLON)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZFDC (JLON, JLEV)=0._JPRB
    ZFMC (JLON, JLEV-1)=0._JPRB
  
  ENDDO

ENDIF

CALL ACRANEB_SOLVT1_OPENACC (LDNUMX, KIDIA, KFDIA, KLON, KTDIA, KLEV, PEMIS, PNEB, PB1&
&, PB2, PB3, PB4, ZA4C, ZA5C, ZA4N, ZA5N, ZFDC, ZFMC, ZFDN, ZFMN, YDSTACK=YLSTACK)

ZTRB =ZFDC (JLON, KTDIA-1)-ZFMC (JLON, KTDIA-1)

IF (LDNUMX) THEN
  ZTRB =ZTRB +ZFDN (JLON, KTDIA-1)-ZFMN (JLON, KTDIA-1)
ENDIF

ZFRTH (JLON, KTDIA-1)=0._JPRB


DO JLEV=KTDIA, KLEV
  LLREWS=(JLEV==KLEV)
  
  ZTRS =ZTRB 
  
  
  ZTRB =ZFDC (JLON, JLEV)-ZFMC (JLON, JLEV)

  IF (LDNUMX) THEN
    ZTRB =ZTRB +ZFDN (JLON, JLEV)-ZFMN (JLON, JLEV)
  ENDIF


  IF (LLREWS) THEN
    ZTRB =ZTRB +1._JPRB
  ENDIF

  ZFRTH (JLON, JLEV)=ZFRTH (JLON, JLEV-1)+(PBB (JLON, KLEV)-PBB (JLON, JLEV&
  &-1))*(ZTRS -ZTRB )/(1._JPRB-(ZTRS -ZTRB )*PDAMP (JLON, JLEV))
  
ENDDO

CALL ACRANEB_COEFT_OPENACC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, ZEONT (1, 1), PEO1TI, PEO2TI&
&, PEO1TN, PEO2TN, PQICE, PQLI, PEO1TA, PEO2TA, ZA4C, ZA5C, ZA4N, ZA5N, YDSTACK=YLSTACK)

IF (YDPHY%LRPROX) THEN

  DO JLEV=KTDIA, KLEV
    
    ZGEPC (JLON, JLEV)=(1._JPRB-PNEB (JLON, JLEV))*ZA4C (JLON, JLEV)+PNEB (JLON, JLEV)*ZA4N (JLON, JLEV)
    ZDA4G (JLON, JLEV)=ZA4C (JLON, JLEV)-ZA4N (JLON, JLEV)
  
  ENDDO

ENDIF


ZTDC (JLON, KTDIA-1)=EXP (MAX (-ZEONT (JLON, KTDIA-1), ZARGLI))
ZTMC (JLON, KTDIA-1)=0._JPRB

IF (LDNUMX) THEN
  ZTDN (JLON, KTDIA-1)=0._JPRB
  ZTMN (JLON, KTDIA-1)=0._JPRB
ENDIF



DO JLEV=KTDIA, KLEV
  
  ZTMC (JLON, JLEV)=0._JPRB
  ZTDC (JLON, JLEV)=0._JPRB

  IF (LDNUMX) THEN
    ZTDN (JLON, JLEV)=0._JPRB
    ZTMN (JLON, JLEV)=0._JPRB
  ENDIF

  
ENDDO


IF (LDNUMX) THEN
  
  ZZZTDC (JLON, KTDIA-1)=0._JPRB
  ZZZTMC (JLON, KTDIA-1)=0._JPRB
  ZZZTDC (JLON, KTDIA)=0._JPRB
  ZZZTMC (JLON, KLEV-1)=-ZA4C (JLON, KLEV)
  ZZZTDC (JLON, KLEV)=-ZA5C (JLON, KLEV)
  ZZZTMC (JLON, KLEV)=1._JPRB-PEMIS (JLON)
  ZZZTMC (JLON, KLEV-1)=ZZZTMC (JLON, KLEV-1)*(1._JPRB-PNEB (JLON, KLEV))
  ZZZTDC (JLON, KLEV)=ZZZTDC (JLON, KLEV)*(1._JPRB-PNEB (JLON, KLEV))
  ZZZTMC (JLON, KLEV)=ZZZTMC (JLON, KLEV)*(1._JPRB-PNEB (JLON, KLEV))
  ZZZTDN (JLON, KTDIA-1)=0._JPRB
  ZZZTMN (JLON, KTDIA-1)=0._JPRB
  ZZZTDN (JLON, KTDIA)=0._JPRB
  ZZZTMN (JLON, KLEV-1)=-ZA4N (JLON, KLEV)*PNEB (JLON, KLEV)
  ZZZTDN (JLON, KLEV)=-ZA5N (JLON, KLEV)*PNEB (JLON, KLEV)
  ZZZTMN (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*PNEB (JLON, KLEV)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZZZTDC (JLON, JLEV)=0._JPRB
    ZZZTMC (JLON, JLEV-1)=0._JPRB
    ZZZTDN (JLON, JLEV)=0._JPRB
    ZZZTMN (JLON, JLEV-1)=0._JPRB
  
  ENDDO

ELSE
  
  ZZZTDC (JLON, KTDIA-1)=0._JPRB
  ZZZTMC (JLON, KTDIA-1)=0._JPRB
  ZZZTDC (JLON, KTDIA)=0._JPRB
  ZZZTMC (JLON, KLEV-1)=-(ZA4C (JLON, KLEV)*PB1 (JLON, KLEV)+ZA4N (JLON, KLEV)*PNEB (JLON, KLEV))
  ZZZTDC (JLON, KLEV)=-(ZA5C (JLON, KLEV)*PB1 (JLON, KLEV)+ZA5N (JLON, KLEV)*PNEB (JLON, KLEV))
  ZZZTMC (JLON, KLEV)=1._JPRB-PEMIS (JLON)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZZZTDC (JLON, JLEV)=0._JPRB
    ZZZTMC (JLON, JLEV-1)=0._JPRB
  
  ENDDO

ENDIF


IF (LDNUMX) THEN
  
  ZZTDC (JLON, KTDIA-1)=PBB (JLON, KTDIA-1)*ZTDC (JLON, KTDIA-1)
  ZZTMC (JLON, KTDIA-1)=ZA4C (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZTDC (JLON, KTDIA)=ZA5C (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZTMC (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*(PBB (JLON, KLEV)-PBB (JLON, KLEV-1))
  ZZTMC (JLON, KTDIA-1)=(1._JPRB-PNEB (JLON, KTDIA))*ZZTMC (JLON, KTDIA-1)
  ZZTDC (JLON, KTDIA)=(1._JPRB-PNEB (JLON, KTDIA))*ZZTDC (JLON, KTDIA)
  ZZTMC (JLON, KLEV)=(1._JPRB-PNEB (JLON, KLEV))*ZZTMC (JLON, KLEV)
  ZZTDN (JLON, KTDIA-1)=0._JPRB
  ZZTMN (JLON, KTDIA-1)=ZA4N (JLON, KTDIA)*PNEB (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZTDN (JLON, KTDIA)=ZA5N (JLON, KTDIA)*PNEB (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZTMN (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*PNEB (JLON, KLEV)*(PBB (JLON, KLEV)-PBB (JLON, KLEV-1))

  

  DO JLEV=KTDIA+1, KLEV
    
    ZZTMC (JLON, JLEV-1)=ZA4C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON,&
    & JLEV))+ZA5C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
    ZZTDC (JLON, JLEV)=ZA5C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV&
    &))+ZA4C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
    ZZTMC (JLON, JLEV-1)=(1._JPRB-PNEB (JLON, JLEV))*ZZTMC (JLON, JLEV-1)
    ZZTDC (JLON, JLEV)=(1._JPRB-PNEB (JLON, JLEV))*ZZTDC (JLON, JLEV)
    ZZTMN (JLON, JLEV-1)=PNEB (JLON, JLEV)*(ZA4N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB&
    & (JLON, JLEV))+ZA5N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2)))
    ZZTDN (JLON, JLEV)=PNEB (JLON, JLEV)*(ZA5N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB&
    & (JLON, JLEV))+ZA4N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2)))
  
  ENDDO

ELSE
  
  ZZTDC (JLON, KTDIA-1)=PBB (JLON, KTDIA-1)*ZTDC (JLON, KTDIA-1)
  ZZTMC (JLON, KTDIA-1)=(ZA4C (JLON, KTDIA)*PB1 (JLON, KTDIA)+ZA4N (JLON,&
  & KTDIA)*PNEB (JLON, KTDIA))*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZTDC (JLON, KTDIA)=(ZA5C (JLON, KTDIA)*PB1 (JLON, KTDIA)+ZA5N (JLON, KTDIA&
  &)*PNEB (JLON, KTDIA))*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZTMC (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*(PBB (JLON, KLEV)-PBB (JLON, KLEV-1))

  

  DO JLEV=KTDIA+1, KLEV
    
    ZZTMC (JLON, JLEV-1)=(ZA4C (JLON, JLEV)*PB1 (JLON, JLEV)+ZA4N (JLON, JLEV)*PNEB (JLON&
    &, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV))+(ZA5C (JLON, JLEV)*PB1 (JLON, JLEV)&
    &+ZA5N (JLON, JLEV)*PNEB (JLON, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
    ZZTDC (JLON, JLEV)=(ZA5C (JLON, JLEV)*PB1 (JLON, JLEV)+ZA5N (JLON, JLEV)*PNEB (JLON&
    &, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV))+(ZA4C (JLON, JLEV)*PB1 (JLON, JLEV&
    &)+ZA4N (JLON, JLEV)*PNEB (JLON, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
  
  ENDDO

ENDIF

CALL ACRANEB_SOLVT3_OPENACC (LDNUMX, KIDIA, KFDIA, KLON, KTDIA, KLEV, PEMIS, PNEB&
&, PB1, PB2, PB3, PB4, ZA4C, ZA5C, ZA4N, ZA5N, ZTDC, ZTMC, ZTDN, ZTMN, ZZTDC,&
& ZZTMC, ZZTDN, ZZTMN, ZZZTDC, ZZZTMC, ZZZTDN, ZZZTMN, YDSTACK=YLSTACK)

IF (YDPHY%LRPROX) THEN
  CALL ACRANEB_COEFT_OPENACC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PEOLT, PEO1TI, PEO2TI,&
  & PEO1TN, PEO2TN, PQICE, PQLI, PEO1TA, PEO2TA, ZA4C, ZA5C, ZA4N, ZA5N, YDSTACK=YLSTACK)

  DO JLEV=KTDIA, KLEV
    
    ZLEPC (JLON, JLEV)=(1._JPRB-PNEB (JLON, JLEV))*ZA4C (JLON, JLEV)+PNEB (JLON, JLEV)*ZA4N (JLON, JLEV)
    ZDA4L (JLON, JLEV)=ZA4C (JLON, JLEV)-ZA4N (JLON, JLEV)
  
  ENDDO

ENDIF

CALL ACRANEB_COEFT_OPENACC (KIDIA, KFDIA, KLON, KTDIA, KLEV, PDELP, PEOXT, PEO1TI, PEO2TI,&
& PEO1TN, PEO2TN, PQICE, PQLI, PEO1TA, PEO2TA, ZA4C, ZA5C, ZA4N, ZA5N, YDSTACK=YLSTACK)

IF (YDPHY%LRPROX) THEN

  DO JLEV=KTDIA, KLEV
    
    ZXEPC (JLON, JLEV)=(1._JPRB-PNEB (JLON, JLEV))*ZA4C (JLON, JLEV)+PNEB (JLON, JLEV)*ZA4N (JLON, JLEV)
    ZDA4X (JLON, JLEV)=ZA4C (JLON, JLEV)-ZA4N (JLON, JLEV)
  
  ENDDO

ELSEIF (YDPHY%LRTPP) THEN
  
  ZLEPC (JLON, KLEV)=(1._JPRB-PNEB (JLON, KLEV))*ZA4C (JLON, KLEV)+PNEB (JLON, KLEV)*ZA4N (JLON, KLEV)
  
ENDIF


ZFDC (JLON, KTDIA-1)=EXP (MAX (-PDEOTI (JLON, KTDIA-1), ZARGLI))
ZFMC (JLON, KTDIA-1)=0._JPRB

IF (LDNUMX) THEN
  ZFDN (JLON, KTDIA-1)=0._JPRB
  ZFMN (JLON, KTDIA-1)=0._JPRB
ENDIF



DO JLEV=KTDIA, KLEV
  
  ZFMC (JLON, JLEV)=0._JPRB
  ZFDC (JLON, JLEV)=0._JPRB

  IF (LDNUMX) THEN
    ZFDN (JLON, JLEV)=0._JPRB
    ZFMN (JLON, JLEV)=0._JPRB
  ENDIF

  
ENDDO


IF (LDNUMX) THEN
  
  ZZFDC (JLON, KTDIA-1)=PBB (JLON, KTDIA-1)*ZFDC (JLON, KTDIA-1)
  ZZFMC (JLON, KTDIA-1)=ZA4C (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZFDC (JLON, KTDIA)=ZA5C (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZFMC (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*(PBB (JLON, KLEV)-PBB (JLON, KLEV-1))
  ZZFMC (JLON, KTDIA-1)=(1._JPRB-PNEB (JLON, KTDIA))*ZZFMC (JLON, KTDIA-1)
  ZZFDC (JLON, KTDIA)=(1._JPRB-PNEB (JLON, KTDIA))*ZZFDC (JLON, KTDIA)
  ZZFMC (JLON, KLEV)=(1._JPRB-PNEB (JLON, KLEV))*ZZFMC (JLON, KLEV)
  ZZFDN (JLON, KTDIA-1)=0._JPRB
  ZZFMN (JLON, KTDIA-1)=ZA4N (JLON, KTDIA)*PNEB (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZFDN (JLON, KTDIA)=ZA5N (JLON, KTDIA)*PNEB (JLON, KTDIA)*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZFMN (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*PNEB (JLON, KLEV)*(PBB (JLON, KLEV)-PBB (JLON, KLEV-1))

  

  DO JLEV=KTDIA+1, KLEV
    
    ZZFMC (JLON, JLEV-1)=ZA4C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON,&
    & JLEV))+ZA5C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
    ZZFDC (JLON, JLEV)=ZA5C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV&
    &))+ZA4C (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
    ZZFMC (JLON, JLEV-1)=(1._JPRB-PNEB (JLON, JLEV))*ZZFMC (JLON, JLEV-1)
    ZZFDC (JLON, JLEV)=(1._JPRB-PNEB (JLON, JLEV))*ZZFDC (JLON, JLEV)
    ZZFMN (JLON, JLEV-1)=PNEB (JLON, JLEV)*(ZA4N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB&
    & (JLON, JLEV))+ZA5N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2)))
    ZZFDN (JLON, JLEV)=PNEB (JLON, JLEV)*(ZA5N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB&
    & (JLON, JLEV))+ZA4N (JLON, JLEV)*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2)))
  
  ENDDO

ELSE
  
  ZZFDC (JLON, KTDIA-1)=PBB (JLON, KTDIA-1)*ZFDC (JLON, KTDIA-1)
  ZZFMC (JLON, KTDIA-1)=(ZA4C (JLON, KTDIA)*PB1 (JLON, KTDIA)+ZA4N (JLON,&
  & KTDIA)*PNEB (JLON, KTDIA))*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZFDC (JLON, KTDIA)=(ZA5C (JLON, KTDIA)*PB1 (JLON, KTDIA)+ZA5N (JLON, KTDIA&
  &)*PNEB (JLON, KTDIA))*(PBB (JLON, KTDIA-1)-PBB (JLON, KTDIA))
  ZZFMC (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*(PBB (JLON, KLEV)-PBB (JLON, KLEV-1))

  

  DO JLEV=KTDIA+1, KLEV
    
    ZZFMC (JLON, JLEV-1)=(ZA4C (JLON, JLEV)*PB1 (JLON, JLEV)+ZA4N (JLON, JLEV)*PNEB (JLON&
    &, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV))+(ZA5C (JLON, JLEV)*PB1 (JLON, JLEV)&
    &+ZA5N (JLON, JLEV)*PNEB (JLON, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
    ZZFDC (JLON, JLEV)=(ZA5C (JLON, JLEV)*PB1 (JLON, JLEV)+ZA5N (JLON, JLEV)*PNEB (JLON&
    &, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV))+(ZA4C (JLON, JLEV)*PB1 (JLON, JLEV&
    &)+ZA4N (JLON, JLEV)*PNEB (JLON, JLEV))*(PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2))
  
  ENDDO

ENDIF


IF (LDNUMX) THEN
  
  ZZZFDC (JLON, KTDIA-1)=0._JPRB
  ZZZFMC (JLON, KTDIA-1)=0._JPRB
  ZZZFDC (JLON, KTDIA)=0._JPRB
  ZZZFMC (JLON, KLEV-1)=-ZA4C (JLON, KLEV)
  ZZZFDC (JLON, KLEV)=-ZA5C (JLON, KLEV)
  ZZZFMC (JLON, KLEV)=1._JPRB-PEMIS (JLON)
  ZZZFMC (JLON, KLEV-1)=ZZZFMC (JLON, KLEV-1)*(1._JPRB-PNEB (JLON, KLEV))
  ZZZFDC (JLON, KLEV)=ZZZFDC (JLON, KLEV)*(1._JPRB-PNEB (JLON, KLEV))
  ZZZFMC (JLON, KLEV)=ZZZFMC (JLON, KLEV)*(1._JPRB-PNEB (JLON, KLEV))
  ZZZFDN (JLON, KTDIA-1)=0._JPRB
  ZZZFMN (JLON, KTDIA-1)=0._JPRB
  ZZZFDN (JLON, KTDIA)=0._JPRB
  ZZZFMN (JLON, KLEV-1)=-ZA4N (JLON, KLEV)*PNEB (JLON, KLEV)
  ZZZFDN (JLON, KLEV)=-ZA5N (JLON, KLEV)*PNEB (JLON, KLEV)
  ZZZFMN (JLON, KLEV)=(1._JPRB-PEMIS (JLON))*PNEB (JLON, KLEV)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZZZFDC (JLON, JLEV)=0._JPRB
    ZZZFMC (JLON, JLEV-1)=0._JPRB
    ZZZFDN (JLON, JLEV)=0._JPRB
    ZZZFMN (JLON, JLEV-1)=0._JPRB
  
  ENDDO

ELSE
  
  ZZZFDC (JLON, KTDIA-1)=0._JPRB
  ZZZFMC (JLON, KTDIA-1)=0._JPRB
  ZZZFDC (JLON, KTDIA)=0._JPRB
  ZZZFMC (JLON, KLEV-1)=-(ZA4C (JLON, KLEV)*PB1 (JLON, KLEV)+ZA4N (JLON, KLEV)*PNEB (JLON, KLEV))
  ZZZFDC (JLON, KLEV)=-(ZA5C (JLON, KLEV)*PB1 (JLON, KLEV)+ZA5N (JLON, KLEV)*PNEB (JLON, KLEV))
  ZZZFMC (JLON, KLEV)=1._JPRB-PEMIS (JLON)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZZZFDC (JLON, JLEV)=0._JPRB
    ZZZFMC (JLON, JLEV-1)=0._JPRB
  
  ENDDO

ENDIF

CALL ACRANEB_SOLVT3_OPENACC (LDNUMX, KIDIA, KFDIA, KLON, KTDIA, KLEV, PEMIS, PNEB&
&, PB1, PB2, PB3, PB4, ZA4C, ZA5C, ZA4N, ZA5N, ZFDC, ZFMC, ZFDN, ZFMN, ZZFDC,&
& ZZFMC, ZZFDN, ZZFMN, ZZZFDC, ZZZFMC, ZZZFDN, ZZZFMN, YDSTACK=YLSTACK)

ZTRB =ZZZTDC (JLON, KTDIA-1)-ZZZTMC (JLON, KTDIA-1)
ZFRB =ZZZFDC (JLON, KTDIA-1)-ZZZFMC (JLON, KTDIA-1)

IF (LDNUMX) THEN
  ZTRB =ZTRB +ZZZTDN (JLON, KTDIA-1)-ZZZTMN (JLON, KTDIA-1)
  ZFRB =ZFRB +ZZZFDN (JLON, KTDIA-1)-ZZZFMN (JLON, KTDIA-1)
ENDIF

ZZTRTH (JLON, KTDIA-1)=0._JPRB
ZZFRTH (JLON, KTDIA-1)=0._JPRB


DO JLEV=KTDIA, KLEV
  LLREWS=(JLEV==KLEV)
  
  ZTRS =ZTRB 
  ZFRS =ZFRB 
  
  
  ZTRB =ZZZTDC (JLON, JLEV)-ZZZTMC (JLON, JLEV)
  ZFRB =ZZZFDC (JLON, JLEV)-ZZZFMC (JLON, JLEV)

  IF (LDNUMX) THEN
    ZTRB =ZTRB +ZZZTDN (JLON, JLEV)-ZZZTMN (JLON, JLEV)
    ZFRB =ZFRB +ZZZFDN (JLON, JLEV)-ZZZFMN (JLON, JLEV)
  ENDIF


  IF (LLREWS) THEN
    ZTRB =ZTRB +1._JPRB
    ZFRB =ZFRB +1._JPRB
  ENDIF

  ZZTRTH (JLON, JLEV)=ZZTRTH (JLON, JLEV-1)+(PBB (JLON, KLEV)-PBB (JLON, JLEV-1))*(ZTRS -ZTRB )
  ZZFRTH (JLON, JLEV)=ZZFRTH (JLON, JLEV-1)+(PBB (JLON, KLEV)-PBB (JLON, JLEV-1))*(ZFRS -ZFRB )
  ZFRTH (JLON, JLEV)=ZFRTH (JLON, JLEV)-(ZZTRTH (JLON, JLEV)+PMIXP&
  & (JLON, JLEV)*(ZZFRTH (JLON, JLEV)-ZZTRTH (JLON, JLEV)))
  
ENDDO


ZTRS =ZTDC (JLON, KLEV)-ZTMC (JLON, KLEV)
ZFRS =ZFDC (JLON, KLEV)-ZFMC (JLON, KLEV)
ZZTRS =ZZTDC (JLON, KLEV)-ZZTMC (JLON, KLEV)+PBB (JLON, KLEV)-PBB (JLON, KLEV-1)
ZZFRS =ZZFDC (JLON, KLEV)-ZZFMC (JLON, KLEV)+PBB (JLON, KLEV)-PBB (JLON, KLEV-1)

IF (LDNUMX) THEN
  ZTRS =ZTRS +ZTDN (JLON, KLEV)-ZTMN (JLON, KLEV)
  ZFRS =ZFRS +ZFDN (JLON, KLEV)-ZFMN (JLON, KLEV)
  ZZTRS =ZZTRS +ZZTDN (JLON, KLEV)-ZZTMN (JLON, KLEV)
  ZZFRS =ZZFRS +ZZFDN (JLON, KLEV)-ZZFMN (JLON, KLEV)
ENDIF

ZDRS =PFRTH (JLON, KLEV)
ZZTRTH (JLON, KLEV)=ZDRS +PBB (JLON, KLEV)*ZTRS -ZZTRS 
ZZFRTH (JLON, KLEV)=ZDRS +PBB (JLON, KLEV)*ZFRS -ZZFRS 
PFRTH (JLON, KLEV)=ZZTRTH (JLON, KLEV)+PMIXP (JLON, KLEV)*(ZZFRTH (JLON, KLEV)-ZZTRTH (JLON, KLEV))


DO JLEV=KLEV, KTDIA+1,-1
  
  ZTRB =ZTRS 
  ZFRB =ZFRS 
  ZZTRB =ZZTRS 
  ZZFRB =ZZFRS 
  ZDRB =ZDRS 
  
  
  ZTRS =ZTDC (JLON, JLEV-1)-ZTMC (JLON, JLEV-1)
  ZFRS =ZFDC (JLON, JLEV-1)-ZFMC (JLON, JLEV-1)
  ZZTRS =ZZTDC (JLON, JLEV-1)-ZZTMC (JLON, JLEV-1)+PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2)
  ZZFRS =ZZFDC (JLON, JLEV-1)-ZZFMC (JLON, JLEV-1)+PBB (JLON, JLEV-1)-PBB (JLON, JLEV-2)

  IF (LDNUMX) THEN
    ZTRS =ZTRS +ZTDN (JLON, JLEV-1)-ZTMN (JLON, JLEV-1)
    ZFRS =ZFRS +ZFDN (JLON, JLEV-1)-ZFMN (JLON, JLEV-1)
    ZZTRS =ZZTRS +ZZTDN (JLON, JLEV-1)-ZZTMN (JLON, JLEV-1)
    ZZFRS =ZZFRS +ZZFDN (JLON, JLEV-1)-ZZFMN (JLON, JLEV-1)
  ENDIF

  ZDRS =PFRTH (JLON, JLEV-1)
  ZZTRTH (JLON, JLEV-1)=ZZTRTH (JLON, JLEV)+ZDRS -ZDRB -PBB (JLON, JLEV-1)*(ZTRB -ZTRS )+ZZTRB -ZZTRS 
  ZZFRTH (JLON, JLEV-1)=ZZFRTH (JLON, JLEV)+ZDRS -ZDRB -PBB (JLON, JLEV-1)*(ZFRB -ZFRS )+ZZFRB -ZZFRS 
  PFRTH (JLON, JLEV-1)=ZZTRTH (JLON, JLEV-1)+PMIXP (JLON, JLEV&
  &-1)*(ZZFRTH (JLON, JLEV-1)-ZZTRTH (JLON, JLEV-1))
  
ENDDO


ZTRB =ZTRS 
ZFRB =ZFRS 
ZZTRB =ZZTRS 
ZZFRB =ZZFRS 
ZDRB =ZDRS 


ZTRS =ZTDC (JLON, KTDIA-1)-ZTMC (JLON, KTDIA-1)
ZFRS =ZFDC (JLON, KTDIA-1)-ZFMC (JLON, KTDIA-1)
ZZTRS =ZZTDC (JLON, KTDIA-1)-ZZTMC (JLON, KTDIA-1)
ZZFRS =ZZFDC (JLON, KTDIA-1)-ZZFMC (JLON, KTDIA-1)

IF (LDNUMX) THEN
  ZTRS =ZTRS +ZTDN (JLON, KTDIA-1)-ZTMN (JLON, KTDIA-1)
  ZFRS =ZFRS +ZFDN (JLON, KTDIA-1)-ZFMN (JLON, KTDIA-1)
  ZZTRS =ZZTRS +ZZTDN (JLON, KTDIA-1)-ZZTMN (JLON, KTDIA-1)
  ZZFRS =ZZFRS +ZZFDN (JLON, KTDIA-1)-ZZFMN (JLON, KTDIA-1)
ENDIF

ZDRS =PFRTH (JLON, KTDIA-1)
ZZTRTH (JLON, KTDIA-1)=ZZTRTH (JLON, KTDIA)+ZDRS -ZDRB&
& -PBB (JLON, KTDIA-1)*(ZTRB -ZTRS )+ZZTRB -ZZTRS 
ZZFRTH (JLON, KTDIA-1)=ZZFRTH (JLON, KTDIA)+ZDRS -ZDRB&
& -PBB (JLON, KTDIA-1)*(ZFRB -ZFRS )+ZZFRB -ZZFRS 
PFRTH (JLON, KTDIA-1)=ZZTRTH (JLON, KTDIA-1)+PMIXP (JLON, KTDIA&
&-1)*(ZZFRTH (JLON, KTDIA-1)-ZZTRTH (JLON, KTDIA-1))


DO JLEV=KTDIA-1, KLEV
  
  PFRTH (JLON, JLEV)=PFRTH (JLON, JLEV)+ZFRTH (JLON, JLEV)
  
ENDDO


IF (YDPHY%LRPROX) THEN

  DO JLEV=KTDIA, KLEV-1
    
    ZDEL1=-LOG (MAX (ZTRLI, ZLEPC (JLON, JLEV)))
    ZDEL2=-LOG (MAX (ZTRLI, ZLEPC (JLON, JLEV+1)))
    ZFTPP=1._JPRB

    IF (YDPHY%LRTPP) THEN
      ZFTPP=MAX (0._JPRB, 1._JPRB-((2._JPRB-(1._JPRB-ZLEPC (JLON, JLEV))*(1._JPRB&
      &+2._JPRB/ZDEL1))+(2._JPRB-(1._JPRB-ZLEPC (JLON, JLEV+1))*(1._JPRB+2._JPRB/ZDEL2&
      &)))/((1._JPRB-ZLEPC (JLON, JLEV))+(1._JPRB-ZLEPC (JLON, JLEV+1))))
    ENDIF

    ZTARE2=(1._JPRB-ZXEPC (JLON, JLEV))*(1._JPRB-ZXEPC (JLON, JLEV+1))
    ZEFFE2=(1._JPRB-ZGEPC (JLON, JLEV))*(1._JPRB-ZGEPC (JLON, JLEV+1))
    ZTARSP=1._JPRB-ZLEPC (JLON, JLEV)-ZLEPC (JLON, JLEV+1)+PRPROX&
    & (JLON, JLEV)*ZLEPC (JLON, JLEV)*ZLEPC (JLON, JLEV+1)
    ZTARSP=MAX (0._JPRB, MIN (1._JPRB, ZTARSP))

    IF (LDNUMX) THEN
      ZTARE2=ZTARE2+MIN (PNEB (JLON, JLEV), PNEB (JLON, JLEV+1))*(1._JPRB-MAX (PNEB (JLON&
      &, JLEV), PNEB (JLON, JLEV+1)))*(ZDA4X (JLON, JLEV)*ZDA4X (JLON, JLEV+1))
      ZEFFE2=ZEFFE2+MIN (PNEB (JLON, JLEV), PNEB (JLON, JLEV+1))*(1._JPRB-MAX (PNEB (JLON&
      &, JLEV), PNEB (JLON, JLEV+1)))*(ZDA4G (JLON, JLEV)*ZDA4G (JLON, JLEV+1))
      ZTARSP=MIN (1._JPRB, ZTARSP+MIN (PNEB (JLON, JLEV), PNEB (JLON, JLEV+1))*(1._JPRB-MAX (PNEB (JLON&
      &, JLEV), PNEB (JLON, JLEV+1)))*(ZDA4L (JLON, JLEV)*ZDA4L (JLON, JLEV+1))*PRPROX (JLON, JLEV))
    ENDIF

    ZEFFE2=ZEFFE2*(1._JPRB-PMIXP (JLON, JLEV))+ZTARE2*PMIXP (JLON, JLEV)
    ZTARE2=ZTARSP
    ZTARE2=ZTARE2*ZFTPP
    ZTARE2=ZTARE2/(1._JPRB+(PDAMP (JLON, JLEV)+PDAMP (JLON, JLEV+1))*ZTARE2)
    PFRTH (JLON, JLEV)=PFRTH (JLON, JLEV)+(PBB (JLON, JLEV-1)-PBB (JLON, JLEV))*(ZTARE2-ZEFFE2)
  
  ENDDO

ENDIF


IF (YDPHY%LRTPP) THEN
  
  ZDEL1=-LOG (MAX (ZTRLI, ZLEPC (JLON, KLEV)))
  ZEFFE2=(1._JPRB-ZLEPC (JLON, KLEV))*PEMIS (JLON)
  ZTARE2=2._JPRB*PEMIS (JLON)*((1._JPRB-ZLEPC (JLON, KLEV))*(1._JPRB+1._JPRB/ZDEL1)-1._JPRB)
  PFRTH (JLON, KLEV)=PFRTH (JLON, KLEV)+(PBB (JLON, KLEV-1)-PBB (JLON&
  &, KLEV))*(ZTARE2-ZEFFE2)/(1._JPRB+PDAMP (JLON, KLEV)*ZEFFE2)
  
ENDIF


DO JLEV=KTDIA-1, KLEV
  
  PFRTH (JLON, JLEV)=PFRTH (JLON, JLEV)+PFLUXC (JLON, JLEV)
  
ENDDO


DO JLEV=0, KTDIA-2
  
  PFRTH (JLON, JLEV)=PFRTH (JLON, KTDIA-1)
  
ENDDO


PFRTHDS (JLON)=PBB (JLON, KLEV)+PFRTH (JLON, KLEV)/PEMIS (JLON)



END SUBROUTINE ACRANEB_SOLVT_OPENACC
