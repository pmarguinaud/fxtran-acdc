
SUBROUTINE ACSOL_OPENACC (YDCLI, YDCST, YDPHY, YDPHY1, KIDIA, KFDIA, KLON, PARG, PD2, PGZ0F, PGZ0HF&
&, PGZ0RLF, PLSM, PIVEG, PLAI, PALBNS, PRHONS, PSAB, PSNS, PTS, PVEG0, PWP, PWPI, PWS, PWSI, LDHMT&
&, PC1, PC2, PC3, PCG, PCN, PCT, PNEIJG, PNEIJV, PWFC, PWPMX, PWSEQ, PWSMX, PWWILT, YDSTACK)
!$ACC ROUTINE (ACSOL_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMPHY1,ONLY:TPHY1
USE YOMPHY,ONLY:TPHY
USE YOMCST,ONLY:TCST
USE YOMCLI,ONLY:TCLI
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCLI), INTENT (IN)::YDCLI
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY1), INTENT (IN)::YDPHY1
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PARG (KLON)
REAL (KIND=JPRB), INTENT (IN)::PD2 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGZ0F (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGZ0HF (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGZ0RLF (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLSM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PIVEG (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLAI (KLON)
REAL (KIND=JPRB), INTENT (IN)::PALBNS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PRHONS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PSAB (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PSNS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PVEG0 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWP (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWPI (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWSI (KLON)
LOGICAL, INTENT (IN)::LDHMT
REAL (KIND=JPRB), INTENT (INOUT)::PC1 (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PC2 (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PC3 (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PCG (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCT (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PNEIJG (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PNEIJV (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PWFC (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWPMX (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWSEQ (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PWSMX (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PWWILT (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZWSAT, (KLON))
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::ZZC
REAL (KIND=JPRB)::ZZB
REAL (KIND=JPRB)::ZZA
REAL (KIND=JPRB)::ZZ0V
REAL (KIND=JPRB)::ZWSSWS
REAL (KIND=JPRB)::ZWS
REAL (KIND=JPRB)::ZWPSWS
REAL (KIND=JPRB)::ZWPI
REAL (KIND=JPRB)::ZWP
REAL (KIND=JPRB)::ZTSVAR
REAL (KIND=JPRB)::ZTS
REAL (KIND=JPRB)::ZSAB
REAL (KIND=JPRB)::ZP
REAL (KIND=JPRB)::ZNEIJV
REAL (KIND=JPRB)::ZNEIJC
REAL (KIND=JPRB)::ZLYMY1
REAL (KIND=JPRB)::ZEPW
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDELTA
REAL (KIND=JPRB)::ZD2
REAL (KIND=JPRB)::ZD1
REAL (KIND=JPRB)::ZCRIN
REAL (KIND=JPRB)::ZCGSAT
REAL (KIND=JPRB)::ZC3REF
REAL (KIND=JPRB)::ZC2REF
REAL (KIND=JPRB)::ZC1Y2
REAL (KIND=JPRB)::ZC1X2
REAL (KIND=JPRB)::ZC1SAT
REAL (KIND=JPRB)::ZC1MAX
REAL (KIND=JPRB)::ZBWB
REAL (KIND=JPRB)::ZBWA
REAL (KIND=JPRB)::ZB
REAL (KIND=JPRB)::ZARG
REAL (KIND=JPRB)::ZA
REAL (KIND=JPRB)::Z2
REAL (KIND=JPRB)::Z1
REAL (KIND=JPRB)::ZUZ0CN
REAL (KIND=JPRB)::Z0CR
REAL (KIND=JPRB)::ZCK
REAL (KIND=JPRB)::ZCFN
REAL (KIND=JPRB)::ZCOEF

#include "acsolw_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZWSAT) == 8) THEN
    fxtran_acdc_alloc8 (ZWSAT)
ELSEIF (KIND (ZWSAT) == 4) THEN
    fxtran_acdc_alloc4 (ZWSAT)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPS=1.E-1_JPRB
ZEPS1=1.E-5_JPRB
ZEPW=1.E-2_JPRB
ZTSVAR=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDPHY1%GTSVAP))
ZD1=YDPHY1%RD1*YDPHY1%GCONV
Z0CR=YDCST%RG*YDPHY1%ALRCN1
ZUZ0CN=1.0_JPRB/(YDCST%RG*YDPHY1%ALRCN2)
CALL ACSOLW_OPENACC (YDPHY1, KIDIA, KFDIA, KLON, PARG, PD2, PLSM, PIVEG&
&, PSAB, LDHMT, PWFC, PWPMX, ZWSAT, PWSMX, PWWILT, YDSTACK=YLSTACK)

IF (.NOT.LDHMT) THEN
  
  ZSAB=MAX (ZEPS, PSAB (JLON))
  ZARG=MAX (ZEPS, PARG (JLON))
  ZA=YDPHY1%GA*(ZARG**YDPHY1%EA)
  ZB=YDPHY1%G1B*ZARG+YDPHY1%G2B
  ZP=YDPHY1%G1P*ZARG+YDPHY1%G2P
  ZC1SAT=(YDPHY1%G1C1SAT*ZARG+YDPHY1%G2C1SAT)*YDPHY1%GC2
  ZCGSAT=YDPHY1%G1CGSAT*ZSAB+YDPHY1%G2CGSAT*ZARG+YDPHY1%G3CGSAT
  ZC2REF=YDPHY1%GC2REF*(ZARG**YDPHY1%EC2REF)
  ZC3REF=YDPHY1%GC31*(ZARG**YDPHY1%GC32)
  ZD2=PD2 (JLON)*YDPHY1%GCONV
  ZWP=PWP (JLON)/ZD2

  IF (YDPHY%LFGEL) THEN
    ZWPSWS=MAX (ZEPW, ZWP/MAX (ZEPW, ZWSAT (JLON)-PWPI (JLON)/ZD2))
  ELSE
    ZWPSWS=MAX (ZEPW, ZWP/ZWSAT (JLON))
  ENDIF


  IF (NINT (PIVEG (JLON))==YDPHY1%NTVGLA)  THEN
    ZWPSWS=1.0_JPRB
  ENDIF

  PWSEQ (JLON)=(ZWPSWS-ZA*(ZWPSWS**ZP)*(1.0_JPRB-(ZWPSWS**(YDPHY1%GC3*ZP))))*PWSMX (JLON)

  IF (NINT (PIVEG (JLON))==YDPHY1%NTVMER) THEN
    PSNS (JLON)=0.0_JPRB
    PNEIJG (JLON)=0.0_JPRB
    PNEIJV (JLON)=0.0_JPRB
    PCN (JLON)=YDPHY1%RCTGLA
    PCG (JLON)=ZCGSAT
    PCT (JLON)=PCG (JLON)
    PC1 (JLON)=100._JPRB*YDPHY1%RD1
    PC2 (JLON)=1.0_JPRB
    PC3 (JLON)=1.0_JPRB
  ELSE

    IF (YDPHY%LSNV) THEN
      PSNS (JLON)=MAX (0.0_JPRB, PSNS (JLON))
      PNEIJG (JLON)=PSNS (JLON)/(PSNS (JLON)+YDPHY1%WCRIN*(1.0_JPRB+PGZ0RLF (JLON)*YDPHY1%XCRINR))
      ZZ0V=SQRT (MAX (0.0_JPRB, PGZ0F (JLON)**2-PGZ0RLF (JLON)**2))/YDCST%RG
      ZCRIN=MAX (YDPHY1%WCRING, PRHONS (JLON)*YDPHY1%XCRINV*ZZ0V)
      PNEIJV (JLON)=PNEIJG (JLON)*(PSNS (JLON)+YDPHY1%WCRING)/(PSNS (JLON)+ZCRIN)
    ELSEIF (YDPHY%LVGSN) THEN

      IF (YDPHY%LZ0HSREL.AND.YDPHY%LCOEFKSURF) THEN
        PNEIJG (JLON)=PLSM (JLON)*PSNS (JLON)/(PSNS (JLON)+YDPHY1&
        &%WCRIN*(1.0_JPRB+ZUZ0CN*PGZ0HF (JLON)/YDCLI%STHER))
      ELSE
        PNEIJG (JLON)=PLSM (JLON)*PSNS (JLON)/(PSNS (JLON)+YDPHY1%WCRIN)
      ENDIF

      ZCFN=(1.0_JPRB-MAX (0.0_JPRB, MIN (1.0_JPRB, PLAI (JLON)/YDPHY1%RLAIMX)))*MAX (0.0_JPRB, SIGN (1.0_JPRB&
      &, PLAI (JLON)-YDPHY1%RLAI))+(1.0_JPRB-MAX (0.0_JPRB, SIGN (1.0_JPRB, PLAI (JLON)-YDPHY1%RLAI)))
      ZCK=MAX (0.0_JPRB,(YDPHY1%ALB1-MAX (YDPHY1%ALB2, PALBNS (JLON))))/(YDPHY1%ALB1-YDPHY1%ALB2)
      ZCOEF=ZCFN*ZCK+(1.0_JPRB-ZCK)
      PNEIJV (JLON)=PNEIJG (JLON)*ZCOEF
    ENDIF


    IF (NINT (PIVEG (JLON))/=YDPHY1%NTVGLA) THEN
      ZBWB=YDPHY1%GC1*ZB/LOG (YDPHY1%GC2)

      IF (YDPHY1%LIMW)  THEN
        ZWPSWS=MAX (ZEPW, PWWILT (JLON)/ZWSAT (JLON), ZWPSWS)
      ENDIF

      PCG (JLON)=ZCGSAT/(ZWPSWS**ZBWB)

      IF (YDPHY%LFGEL) THEN
        ZWPI=PWPI (JLON)/MAX (PWP (JLON)+PWPI (JLON), ZEPS1)
        PCG (JLON)=1.0_JPRB/((1-ZWPI)/PCG (JLON)+ZWPI/YDPHY1%RCTGLA)
      ENDIF


      IF (YDPHY1%LIMC)  THEN
        PCG (JLON)=MIN (YDPHY1%RCGMAX, PCG (JLON))
      ENDIF


      IF (YDPHY%LSNV) THEN
        ZNEIJC=MIN (1.0_JPRB, PSNS (JLON)/YDPHY1%WCRINC)
        ZNEIJV=MIN (ZNEIJC, PNEIJV (JLON))
        PCN (JLON)=2.0_JPRB*SQRT (YDPHY1%GSNC1/(PRHONS (JLON)**YDPHY1%GSNC2))
        PCT (JLON)=1.0_JPRB/((1.0_JPRB-PVEG0 (JLON))*(1.0_JPRB-ZNEIJC)/PCG (JLON)&
        &+(1.0_JPRB-PVEG0 (JLON))*ZNEIJC/PCN (JLON)+PVEG0 (JLON)*ZNEIJV/PCN (JLON&
        &)+PVEG0 (JLON)*(1.0_JPRB-ZNEIJV)/YDPHY1%RCTVEG(NINT (PIVEG (JLON))))
      ELSE
        PCT (JLON)=1.0_JPRB/((1.0_JPRB-PVEG0 (JLON))/PCG (JLON&
        &)+PVEG0 (JLON)/YDPHY1%RCTVEG(NINT (PIVEG (JLON))))
      ENDIF

      ZBWA=YDPHY1%GC1*ZB+1.0_JPRB

      IF (YDPHY%LFGEL) THEN
        ZWS=PWS (JLON)+PWSI (JLON)
      ELSE
        ZWS=PWS (JLON)
      ENDIF

      ZWSSWS=MAX (ZEPW, ZWS/PWSMX (JLON))

      IF (YDPHY1%LIMW.AND.(.NOT.YDPHY1%LC1VAP))  THEN
        ZWSSWS=MAX (ZEPW, PWWILT (JLON)/ZWSAT (JLON), ZWSSWS)
      ENDIF

      PC1 (JLON)=ZC1SAT*YDPHY1%RD1/(ZWSSWS**ZBWA)

      IF (YDPHY1%LIMC.AND.(.NOT.YDPHY1%LC1VAP))  THEN
        PC1 (JLON)=MIN (YDPHY1%RC1MAX*YDPHY1%RD1, PC1 (JLON))
      ENDIF


      IF (YDPHY1%LC1VAP.AND.((ZWS/ZD1)<PWWILT (JLON))) THEN
        ZTS=ZTSVAR*MAX (YDCST%RTT, PTS (JLON))+(1.0_JPRB-ZTSVAR)*(YDCST%RTT-YDPHY1%GTSVAP)
        ZC1MAX=(YDPHY1%GC1S1*PWWILT (JLON)+YDPHY1%GC1S2)*ZTS+(YDPHY1%GC1S3*PWWILT (JLON)+YDPHY1%GC1S4)
        ZC1X2=PWWILT (JLON)*ZD1
        ZC1Y2=ZC1SAT/((PWWILT (JLON)/ZWSAT (JLON))**ZBWA)
        ZC1MAX=MAX (ZC1Y2, ZC1MAX)
        ZZA=LOG (ZC1Y2/YDPHY1%GC1Y1)
        ZLYMY1=LOG (ZC1MAX/YDPHY1%GC1Y1)
        ZZB=-2.0_JPRB*ZC1X2*ZLYMY1
        ZZC=ZC1X2**2*ZLYMY1
        ZDELTA=ZZB**2-4._JPRB*ZZA*ZZC
        ZDELTA=MAX (0.0_JPRB, ZDELTA)
        Z1=(-ZZB-SQRT (ZDELTA))/(2.0_JPRB*ZZA)
        Z2=Z1**2/ZLYMY1
        PC1 (JLON)=ZC1MAX*YDPHY1%RD1*EXP (-(ZWS-Z1)**2/Z2)
      ENDIF


      IF (YDPHY%LFGEL) THEN
        ZWP=ZWP+PWPI (JLON)/ZD2
      ENDIF


      IF (YDPHY1%LIMW)  THEN
        ZWP=MAX (PWWILT (JLON), ZWP)
      ENDIF

      PC2 (JLON)=MAX (0.0_JPRB, ZC2REF*ZWP/(ZWSAT (JLON)-ZWP+ZEPW))
      PC3 (JLON)=ZC3REF/PD2 (JLON)
    ELSE
      PCG (JLON)=YDPHY1%RCTGLA

      IF (YDPHY%LGLACIERS) THEN
        ZNEIJC=MIN (1.0_JPRB, PSNS (JLON)/YDPHY1%WCRINC)
        PCN (JLON)=2.0_JPRB*SQRT (YDPHY1%GSNC1/(PRHONS (JLON)**YDPHY1%GSNC2))
        PCT (JLON)=1.0_JPRB/((1.0_JPRB-ZNEIJC)/PCG (JLON)+ZNEIJC/PCN (JLON))
      ELSE
        PCN (JLON)=YDPHY1%RCTGLA
        PCT (JLON)=YDPHY1%RCTGLA
      ENDIF

      PC1 (JLON)=0.0_JPRB
      PC2 (JLON)=0.0_JPRB
      PC3 (JLON)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDIF



END SUBROUTINE ACSOL_OPENACC
