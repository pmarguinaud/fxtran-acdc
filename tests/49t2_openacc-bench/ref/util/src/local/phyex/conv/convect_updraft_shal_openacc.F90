
SUBROUTINE CONVECT_UPDRAFT_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, CONVPAR, KICE, PPRES, PDPRES, PZ&
&, PTHL, PTHV, PTHES, PRW, PTHLCL, PTLCL, PRVLCL, PWLCL, PZLCL, PTHVELCL, PMFLCL, OTRIG, KLCL, KDPL&
&, KPBL, PUMF, PUER, PUDR, PUTHL, PUTHV, PURW, PURC, PURI, PCAPE, KCTL, KETL, GTRIG1, YDSTACK)
!$ACC ROUTINE (CONVECT_UPDRAFT_SHAL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR,ONLY:CONVPAR_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CONVPAR_T), INTENT (IN)::CONVPAR
INTEGER, INTENT (IN)::KICE
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PDPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHL(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHV(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHES(D%NIT, D%NKT)
REAL, INTENT (IN)::PRW(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHLCL(D%NIT)
REAL, INTENT (IN)::PTLCL(D%NIT)
REAL, INTENT (IN)::PRVLCL(D%NIT)
REAL, INTENT (IN)::PWLCL(D%NIT)
REAL, INTENT (IN)::PZLCL(D%NIT)
REAL, INTENT (IN)::PTHVELCL(D%NIT)
REAL, INTENT (IN)::PMFLCL
LOGICAL, INTENT (INOUT)::OTRIG(D%NIT)
INTEGER, INTENT (IN)::KLCL(D%NIT)
INTEGER, INTENT (IN)::KDPL(D%NIT)
INTEGER, INTENT (IN)::KPBL(D%NIT)
REAL, INTENT (OUT)::PUMF(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUER(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUDR(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUTHL(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUTHV(D%NIT, D%NKT)
REAL, INTENT (OUT)::PURW(D%NIT, D%NKT)
REAL, INTENT (OUT)::PURC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PURI(D%NIT, D%NKT)
REAL, INTENT (OUT)::PCAPE(D%NIT)
INTEGER, INTENT (OUT)::KCTL(D%NIT)
INTEGER, INTENT (OUT)::KETL(D%NIT)
LOGICAL, INTENT (IN)::GTRIG1(D%NIT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER::IKE
INTEGER::IKB
INTEGER::JI
INTEGER::JK2
INTEGER::JK1
INTEGER::JKM
INTEGER::JKP
INTEGER::JK
REAL::ZEPSA
REAL::ZRDOCP
fxtran_acdc_temp (REAL, ZUT, (D%NIT))
REAL::ZUW2
REAL::ZUW1
fxtran_acdc_temp (REAL, ZD2, (D%NIT))
REAL::ZD1
fxtran_acdc_temp (REAL, ZE2, (D%NIT))
REAL::ZE1
fxtran_acdc_temp (REAL, ZMIXF, (D%NIT))
fxtran_acdc_temp (REAL, ZCPH, (D%NIT))
fxtran_acdc_temp (REAL, ZLS, (D%NIT))
fxtran_acdc_temp (REAL, ZLV, (D%NIT))
fxtran_acdc_temp (REAL, ZURV, (D%NIT))
REAL::ZPI
REAL::ZTHEUL
REAL::ZWORK6
fxtran_acdc_temp (REAL, ZWORK5, (D%NIT))
fxtran_acdc_temp (REAL, ZWORK4, (D%NIT))
fxtran_acdc_temp (REAL, ZWORK3, (D%NIT))
fxtran_acdc_temp (REAL, ZWORK2, (D%NIT))
fxtran_acdc_temp (REAL, ZWORK1, (D%NIT))
INTEGER::IWORK
LOGICAL::GWORK4
LOGICAL::GWORK2
LOGICAL::GWORK1

#include "convect_condens_openacc.h"
#include "convect_mixing_funct_openacc.h"

YLSTACK = YDSTACK



IF (KIND (ZUT) == 8) THEN
    fxtran_acdc_alloc8 (ZUT)
ELSEIF (KIND (ZUT) == 4) THEN
    fxtran_acdc_alloc4 (ZUT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZD2) == 8) THEN
    fxtran_acdc_alloc8 (ZD2)
ELSEIF (KIND (ZD2) == 4) THEN
    fxtran_acdc_alloc4 (ZD2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZE2) == 8) THEN
    fxtran_acdc_alloc8 (ZE2)
ELSEIF (KIND (ZE2) == 4) THEN
    fxtran_acdc_alloc4 (ZE2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMIXF) == 8) THEN
    fxtran_acdc_alloc8 (ZMIXF)
ELSEIF (KIND (ZMIXF) == 4) THEN
    fxtran_acdc_alloc4 (ZMIXF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCPH) == 8) THEN
    fxtran_acdc_alloc8 (ZCPH)
ELSEIF (KIND (ZCPH) == 4) THEN
    fxtran_acdc_alloc4 (ZCPH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLS) == 8) THEN
    fxtran_acdc_alloc8 (ZLS)
ELSEIF (KIND (ZLS) == 4) THEN
    fxtran_acdc_alloc4 (ZLS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLV) == 8) THEN
    fxtran_acdc_alloc8 (ZLV)
ELSEIF (KIND (ZLV) == 4) THEN
    fxtran_acdc_alloc4 (ZLV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZURV) == 8) THEN
    fxtran_acdc_alloc8 (ZURV)
ELSEIF (KIND (ZURV) == 4) THEN
    fxtran_acdc_alloc4 (ZURV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK5) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK5)
ELSEIF (KIND (ZWORK5) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK5)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK4) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK4)
ELSEIF (KIND (ZWORK4) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK4)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK3) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK3)
ELSEIF (KIND (ZWORK3) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK3)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK2) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK2)
ELSEIF (KIND (ZWORK2) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK1) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK1)
ELSEIF (KIND (ZWORK1) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK1)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
ZEPSA=CST%XRV/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
PUMF (JI,:)=0.
PUER (JI,:)=0.
PUDR (JI,:)=0.
PUTHL (JI,:)=0.
PUTHV (JI,:)=0.
PURW (JI,:)=0.
PURC (JI,:)=0.
PURI (JI,:)=0.
ZUW1 =PWLCL (JI)*PWLCL (JI)
ZUW2 =0.
ZE1 =0.
ZD1 =0.
PCAPE (JI)=0.
KCTL (JI)=IKB
KETL (JI)=KLCL (JI)
GWORK2 =.TRUE.
ZPI =1.
ZWORK3 (JI)=0.
ZWORK4 (JI)=0.
ZWORK5 (JI)=0.
ZWORK6 =0.
GWORK1 =.FALSE.
GWORK4 =.FALSE.

ZTHEUL =PTLCL (JI)*(PTHLCL (JI)/PTLCL (JI))**(1.-0.28*PRVLCL (JI))*EXP&
& ((3374.6525/PTLCL (JI)-2.5403)*PRVLCL (JI)*(1.+0.81*PRVLCL (JI)))
ZWORK1 (JI)=(CST%XCPD+PRVLCL (JI)*CST%XCPV)*PTLCL (JI)+(1.+PRVLCL (JI))*CST%XG*PZLCL (JI)

JKP=IKE
JKM=IKB

DO JK=JKM, JKP

  

  IF (JK>=KDPL (JI).AND.JK<KLCL (JI)) THEN
    PUMF (JI, JK)=PMFLCL
    PUTHL (JI, JK)=ZWORK1 (JI)
    PUTHV (JI, JK)=PTHLCL (JI)*(1.+ZEPSA*PRVLCL (JI))/(1.+PRVLCL (JI))
    PURW (JI, JK)=PRVLCL (JI)
  ENDIF

  
ENDDO


DO JK=IKB+1, IKE-1
  ZWORK6 =1.
  JKP=JK+1
  
  GWORK4 =JK>=KLCL (JI)-1
  GWORK1 =GWORK4 .AND.GWORK2 

  

  

  IF (JK==KLCL (JI)-1)  THEN
    ZWORK6 =0.
  ENDIF

  
  ZWORK1 (JI)=PURC (JI, JK)
  ZWORK2 (JI)=PURI (JI, JK)
  CALL CONVECT_CONDENS_OPENACC (CST, D, CONVPAR, KICE, PPRES (:, JKP), PUTHL (:, JK), PURW (:, JK), ZWORK1&
  &, ZWORK2, PZ (:, JKP), ZUT, ZURV, PURC (:, JKP), PURI (:, JKP), ZLV, ZLS, ZCPH, YDSTACK=YLSTACK)
  
  ZPI =(CST%XP00/PPRES (JI, JKP))**ZRDOCP

  

  

  IF (GWORK1 ) THEN
    PUTHV (JI, JKP)=ZPI *ZUT (JI)*(1.+ZEPSA*ZURV (JI))/(1.+PURW (JI, JK))
    ZWORK3 (JI)=PZ (JI, JKP)-PZ (JI, JK)*ZWORK6 -(1.-ZWORK6 )*PZLCL (JI)
    ZWORK4 (JI)=PTHV (JI, JK)*ZWORK6 +(1.-ZWORK6 )*PTHVELCL (JI)
    ZWORK5 (JI)=2.*ZUW1 *PUER (JI, JK)/MAX (.1, PUMF (JI, JK))
    ZUW2 =ZUW1 +ZWORK3 (JI)*CVP_SHAL%XNHGAM*CST%XG*((PUTHV (JI, JK)+PUTHV&
    & (JI, JKP))/(ZWORK4 (JI)+PTHV (JI, JKP))-1.)-ZWORK5 (JI)
    ZWORK2 (JI)=0.5*(SQRT (MAX (1.E-2, ZUW2 ))+SQRT (MAX (1.E-2, ZUW1 )))
    PURW (JI, JKP)=PURW (JI, JK)
    PURC (JI, JKP)=PURC (JI, JKP)
    PURI (JI, JKP)=PURI (JI, JKP)
    PUTHL (JI, JKP)=PUTHL (JI, JK)
    ZUW1 =ZUW2 
  ENDIF

  
  
  ZMIXF (JI)=0.1
  ZWORK1 (JI)=ZMIXF (JI)*PTHL (JI, JKP)+(1.-ZMIXF (JI))*PUTHL (JI, JKP)
  ZWORK2 (JI)=ZMIXF (JI)*PRW (JI, JKP)+(1.-ZMIXF (JI))*PURW (JI, JKP)
  
  CALL CONVECT_CONDENS_OPENACC (CST, D, CONVPAR, KICE, PPRES (:, JKP), ZWORK1, ZWORK2, PURC (:, JKP&
  &), PURI (:, JKP), PZ (:, JKP), ZUT, ZWORK3, ZWORK4, ZWORK5, ZLV, ZLS, ZCPH, YDSTACK=YLSTACK)
  
  ZWORK3 (JI)=ZUT (JI)*ZPI *(1.+ZEPSA*(ZWORK2 (JI)-ZWORK4 (JI)-ZWORK5 (JI)))/(1.+ZWORK2 (JI))
  ZMIXF (JI)=MAX (0., PUTHV (JI, JKP)-PTHV (JI, JKP))*ZMIXF (JI)/(PUTHV (JI, JKP)-ZWORK3 (JI)+1.E-10)
  ZMIXF (JI)=MAX (0., MIN (1., ZMIXF (JI)))
  
  CALL CONVECT_MIXING_FUNCT_OPENACC (D, ZMIXF, 1, ZE2, ZD2, YDSTACK=YLSTACK)
  ZE2(JI)=MIN (ZD2(JI), MAX (.3, ZE2(JI)))
  
  ZWORK1 (JI)=CVP_SHAL%XENTR*CST%XG/CVP_SHAL%XCRAD*PUMF (JI, JK)*(PZ (JI, JKP)-PZ (JI, JK))
  
  ZWORK2 (JI)=0.

  

  IF (GWORK1 )  THEN
    ZWORK2 (JI)=1.
  ENDIF


  

  

  IF (PUTHV (JI, JKP)>PTHV (JI, JKP)) THEN
    PUER (JI, JKP)=0.5*ZWORK1 (JI)*(ZE1 +ZE2 (JI))*ZWORK2 (JI)
    PUDR (JI, JKP)=0.5*ZWORK1 (JI)*(ZD1 +ZD2 (JI))*ZWORK2 (JI)
  ELSE
    PUER (JI, JKP)=0.
    PUDR (JI, JKP)=ZWORK1 (JI)*ZWORK2 (JI)
  ENDIF


  

  

  IF (PUTHV (JI, JKP)>PTHV (JI, JKP).AND.JK>KLCL (JI)+1.AND.GWORK1 ) THEN
    KETL (JI)=JKP
  ENDIF


  

  

  IF (GWORK1 ) THEN
    GWORK2 =PUMF (JI, JK)-PUDR (JI, JKP)>10..AND.ZUW2 >0.
  ENDIF


  

  

  IF (GWORK2 )  THEN
    KCTL (JI)=JKP
  ENDIF

  
  
  GWORK1 =GWORK2 .AND.GWORK4 

  

  

  IF (GWORK1 ) THEN
    ZWORK3 (JI)=PZ (JI, JKP)-PZ (JI, JK)*ZWORK6 -(1.-ZWORK6 )*PZLCL (JI)
    ZWORK2 (JI)=PTHES (JI, JK)+(1.-ZWORK6 )*(PTHES (JI, JKP)-PTHES (JI&
    &, JK))/(PZ (JI, JKP)-PZ (JI, JK))*(PZLCL (JI)-PZ (JI, JK))
    ZWORK1 (JI)=(2.*ZTHEUL )/(ZWORK2 (JI)+PTHES (JI, JKP))-1.
    PCAPE (JI)=PCAPE (JI)+CST%XG*ZWORK3 (JI)*MAX (0., ZWORK1 (JI))
    PUMF (JI, JKP)=PUMF (JI, JK)-PUDR (JI, JKP)+PUER (JI, JKP)
    PUMF (JI, JKP)=MAX (PUMF (JI, JKP), 0.1)
    PUTHL (JI, JKP)=(PUMF (JI, JK)*PUTHL (JI, JK)+PUER (JI, JKP)*PTHL&
    & (JI, JK)-PUDR (JI, JKP)*PUTHL (JI, JK))/PUMF (JI, JKP)
    PURW (JI, JKP)=(PUMF (JI, JK)*PURW (JI, JK)+PUER (JI, JKP)*PRW&
    & (JI, JK)-PUDR (JI, JKP)*PURW (JI, JK))/PUMF (JI, JKP)
    ZE1 =ZE2 (JI)
    ZD1 =ZD2 (JI)
  ENDIF

  
ENDDO


JK=KCTL (JI)
ZWORK1 (JI)=PZ (JI, JK)-PZLCL (JI)
OTRIG (JI)=ZWORK1 (JI)>=CVP_SHAL%XCDEPTH.AND.ZWORK1 (JI)<CVP_SHAL%XCDEPTH_D.AND.PCAPE (JI)>1.



IF (.NOT.OTRIG (JI))  THEN
  KCTL (JI)=IKB
ENDIF



KETL (JI)=MAX (KETL (JI), KLCL (JI)+2)
KETL (JI)=MIN (KETL (JI), KCTL (JI))

ZWORK1 (JI)=0.


IF (KETL (JI)==KCTL (JI))  THEN
  ZWORK1 (JI)=1.
ENDIF



JK=KETL (JI)
PUDR (JI, JK)=PUDR (JI, JK)+(PUMF (JI, JK)-PUER (JI, JK))*ZWORK1 (JI)
PUER (JI, JK)=PUER (JI, JK)*(1.-ZWORK1 (JI))
PUMF (JI, JK)=PUMF (JI, JK)*(1.-ZWORK1 (JI))
JKP=KCTL (JI)+1
PUER (JI, JKP)=0.
PUDR (JI, JKP)=0.
PURW (JI, JKP)=0.
PURC (JI, JKP)=0.
PURI (JI, JKP)=0.
PUTHL (JI, JKP)=0.
PURC (JI, JKP+1)=0.
PURI (JI, JKP+1)=0.

ZWORK1 (JI)=0.
JK1=IKB
JK2=IKE

DO JK=JK1, JK2

  

  IF (JK>KETL (JI).AND.JK<=KCTL (JI)) THEN
    ZWORK1 (JI)=ZWORK1 (JI)+PDPRES (JI, JK)
  ENDIF

  
ENDDO


JK=KETL (JI)
ZWORK1 (JI)=PUMF (JI, JK)/MAX (1., ZWORK1 (JI))


DO JK=JK1+1, JK2
  JKP=JK-1

  

  IF (JK>KETL (JI).AND.JK<=KCTL (JI)) THEN
    PUDR (JI, JK)=PDPRES (JI, JK)*ZWORK1 (JI)
    PUMF (JI, JK)=PUMF (JI, JKP)-PUDR (JI, JK)
  ENDIF

  
ENDDO

IWORK =KPBL (JI)

JK=KDPL (JI)
JKP=IWORK 
ZWORK2 (JI)=PPRES (JI, JK)-PPRES (JI, JKP)+PDPRES (JI, JK)

JKP=IKE

DO JK=JKM, JKP

  

  IF (JK>=KDPL (JI).AND.JK<=IWORK .AND.GTRIG1 (JI)) THEN
    PUER (JI, JK)=PUER (JI, JK)+PMFLCL*PDPRES (JI, JK)/(ZWORK2 (JI)+0.1)
    PUMF (JI, JK)=PUMF (JI, JK-1)+PUER (JI, JK)
  ENDIF

  
ENDDO


DO JK=1, D%NKT

  

  IF (.NOT.OTRIG (JI)) THEN
    PUMF (JI, JK)=0.
    PUDR (JI, JK)=0.
    PUER (JI, JK)=0.
    PUTHL (JI, JK)=PTHL (JI, JK)
    PURW (JI, JK)=PRW (JI, JK)
    PURC (JI, JK)=0.
    PURI (JI, JK)=0.
  ENDIF

  
ENDDO


END SUBROUTINE CONVECT_UPDRAFT_SHAL_OPENACC
