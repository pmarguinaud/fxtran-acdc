SUBROUTINE LATTEX_EXPL_VSPLTRANS_PARALLEL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDML_DYN, YDCPG_SL1)

USE YOMHOOK,ONLY:DR_HOOK, LHOOK, JPHOOK
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MODEL_DYNAMICS_MOD,ONLY:MODEL_DYNAMICS_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (MODEL_DYNAMICS_TYPE), INTENT (IN)::YDML_DYN
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1
#include "vspltrans.intfb.h"
#include "abor1.intfb.h"
LOGICAL::LLTDIABLIN
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JGFL
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL (KIND=JPRB), POINTER :: Z_YDCPG_SL1_GFL_P(:,:,:)
REAL (KIND=JPRB), POINTER :: Z_YDCPG_SL1_GFL_P_F(:,:,:)
REAL (KIND=JPRB), POINTER :: Z_YDCPG_SL1_GFL_P_SP(:,:,:)
REAL (KIND=JPRB), POINTER :: Z_YDCPG_SL1_GFL_P_SPF(:,:,:)
IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)

DO JGFL=1, SIZE (YDCPG_SL1%GFL)

  IF (YDCPG_SL1%GFL (JGFL)%YCOMP%LADV.AND.YDCPG_SL1%GFL (JGFL)%YCOMP%CSLINT=='LAITVSPCQM  ') THEN
    LLTDIABLIN=YDCPG_SL1%GFL (JGFL)%YCOMP%LTDIABLIN

    IF ((YDML_DYN%YRDYN%NSPLTHOI/=0).OR.LLTDIABLIN) THEN
      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0',0,ZHOOK_HANDLE_PARALLEL)

      IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','LATTEX_EXPL_VSPLTRANS_PARALLEL:0')) THEN
        
        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
        Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDONLY (YDCPG_SL1%GFL (JGFL)%F_P_F)
        Z_YDCPG_SL1_GFL_P_SPF => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_SPF)
        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
        
        CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
        !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JROF) FIRSTPRIVATE (YLCPG_BNDS)

        DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
          CALL YLCPG_BNDS%UPDATE (JBLK)

          

          DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

            DO JROF=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
              Z_YDCPG_SL1_GFL_P_SPF  (JROF, JLEV, JBLK)=Z_YDCPG_SL1_GFL_P_F  (JROF, JLEV, JBLK)
            ENDDO

          ENDDO

          CALL VSPLTRANS (YDML_DYN%YRSLINT%YRVSPLIP, YDGEOMETRY%YRDIM%NPROMA, YLCPG_BNDS&
          &%KIDIA, YLCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA&
          &, YDGEOMETRY%YRDIMV%NFLEN, Z_YDCPG_SL1_GFL_P_SPF(:,:, JBLK))
        ENDDO

        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

        IF (FXTRAN_ACDC_LSYNCHOST ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0')) THEN
          IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
          Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
          Z_YDCPG_SL1_GFL_P_SPF => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_SPF)
          IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
          
          
        ENDIF

        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
        Z_YDCPG_SL1_GFL_P_F => NULL ()
        Z_YDCPG_SL1_GFL_P_SPF => NULL ()
        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ELSE
          CALL ABOR1 ('LATTEX_EXPL_VSPLTRANS_PARALLEL: NOT METHOD WAS FOUND')
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:0',1,ZHOOK_HANDLE_PARALLEL)
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1',0,ZHOOK_HANDLE_PARALLEL)

    IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','LATTEX_EXPL_VSPLTRANS_PARALLEL:1')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P => GET_HOST_DATA_RDONLY (YDCPG_SL1%GFL (JGFL)%F_P)
      Z_YDCPG_SL1_GFL_P_SP => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_SP)
      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
      !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JROF) FIRSTPRIVATE (YLCPG_BNDS)

      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
        CALL YLCPG_BNDS%UPDATE (JBLK)

        

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
            Z_YDCPG_SL1_GFL_P_SP  (JROF, JLEV, JBLK)=Z_YDCPG_SL1_GFL_P  (JROF, JLEV, JBLK)
          ENDDO

        ENDDO

        CALL VSPLTRANS (YDML_DYN%YRSLINT%YRVSPLIP, YDGEOMETRY%YRDIM%NPROMA, YLCPG_BNDS&
        &%KIDIA, YLCPG_BNDS%KFDIA, YDGEOMETRY%YRDIMV%NFLEVG, YDGEOMETRY%YRDIMV%NFLSA&
        &, YDGEOMETRY%YRDIMV%NFLEN, Z_YDCPG_SL1_GFL_P_SP(:,:, JBLK))
      ENDDO

      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1')) THEN
        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        Z_YDCPG_SL1_GFL_P => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P)
        Z_YDCPG_SL1_GFL_P_SP => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_SP)
        IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P => NULL ()
      Z_YDCPG_SL1_GFL_P_SP => NULL ()
      IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSE
        CALL ABOR1 ('LATTEX_EXPL_VSPLTRANS_PARALLEL: NOT METHOD WAS FOUND')
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL:1',1,ZHOOK_HANDLE_PARALLEL)
  ENDIF

ENDDO


CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('LATTEX_EXPL_VSPLTRANS_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE LATTEX_EXPL_VSPLTRANS_PARALLEL
