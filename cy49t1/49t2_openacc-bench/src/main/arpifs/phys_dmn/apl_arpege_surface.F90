SUBROUTINE APL_ARPEGE_SURFACE (YDMF_PHYS_BASE_STATE, YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC, &
& YDCPG_GPAR, YDMF_PHYS, YDMF_PHYS_SURF, YDVARS, YDMODEL, PALBD, PALBP, PALPHA1, PCDROV,             &
& PCEROV, PCFATH, PCFAU, PCFBTH, PCFBU, PCFBV, PCHROV, PCOEFA, PCOEFN, PCP, PDIFEXT, PDIFWQ, PDIFWS, &
& PDQSTS, PDSA_CPS, PDSA_LHS, PDTMSE, PEDMFQ, PEDMFS, PEDMFU, PEDMFV, PFLU_CD, PFLU_CDN, PFLU_EMIS,  &
& PFLU_FEVI, PFLU_NEIJ, PFLU_QSATS, PFLU_VEG, PHQ, PHTR, PHU, PKQLROV, PKQROV, PKTROV, PKUROV, PLVT, &
& PMF_UP, PNEBCH, PNEBDIFF, PNEBS, PPOID, PQI, PQICE, PQL, PQV, PRDG_MU0, PRDG_MU0N, PRHGMT,         &
& PSC_FCLL, PSC_FCLN, PSC_FEVI, PSC_FEVN, PSFSWDIF, PSFSWDIR, PSGROUPEL, PSRAIN, PSSNOW, PSTATI,     &
& PTSN, PXDROV, PXHROV, PXQRO, PXTRO, PXTROV, PXURO, PXUROV)

!**** *APL_ARPEGE_SURFACE*

!     Author. 
!     ------- 
!      Philippe Marguinaud *METEO-FRANCE*
!      Original : 28-04-2021

USE YOMHOOK, ONLY : LHOOK, DR_HOOK, JPHOOK
USE PARKIND1, ONLY : JPIM, JPRB

USE MF_PHYS_BASE_STATE_TYPE_MOD &
                       , ONLY : MF_PHYS_BASE_STATE_TYPE
USE GEOMETRY_MOD       , ONLY : GEOMETRY
USE CPG_OPTS_TYPE_MOD  , ONLY : CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD       , ONLY : CPG_MISC_TYPE, CPG_GPAR_TYPE
USE MF_PHYS_TYPE_MOD   , ONLY : MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD  &
                       , ONLY : MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD, ONLY : FIELD_VARIABLES
USE SURFACE_FIELDS_MIX , ONLY : TSURF
USE TYPE_MODEL         , ONLY : MODEL


IMPLICIT NONE

TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT(IN)    :: YDMF_PHYS_BASE_STATE
TYPE(GEOMETRY),                 INTENT(IN)    :: YDGEOMETRY
TYPE(CPG_BNDS_TYPE),            INTENT(IN)    :: YDCPG_BNDS
TYPE(CPG_OPTS_TYPE),            INTENT(IN)    :: YDCPG_OPTS
TYPE(CPG_MISC_TYPE),            INTENT(INOUT) :: YDCPG_MISC
TYPE(CPG_GPAR_TYPE),            INTENT(INOUT) :: YDCPG_GPAR
TYPE(MF_PHYS_TYPE),             INTENT(INOUT) :: YDMF_PHYS
TYPE(MF_PHYS_SURF_TYPE),        INTENT(INOUT) :: YDMF_PHYS_SURF
TYPE(FIELD_VARIABLES),          INTENT(INOUT) :: YDVARS
TYPE(MODEL),                    INTENT(IN)    :: YDMODEL
REAL(KIND=JPRB),                INTENT(INOUT) :: PALBD(YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(INOUT) :: PALBP(YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(OUT)   :: PALPHA1(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCDROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PCEROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFATH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFAU(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFBTH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFBU(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCFBV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCHROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PCOEFA (YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCOEFN(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PCP(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDIFEXT(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG,YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDIFWQ (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDIFWS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDQSTS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDSA_CPS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PDSA_LHS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PDTMSE
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFQ(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFS(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFU(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PEDMFV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_CD (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_CDN (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PFLU_EMIS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PFLU_FEVI (YDCPG_OPTS%KLON, 1:YDCPG_OPTS%KTSSG+1)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_NEIJ (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_QSATS (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PFLU_VEG (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PHQ(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PHTR(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PHU(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PKQLROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PKQROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PKTROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PKUROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PLVT (YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PMF_UP(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEBCH(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PNEBDIFF(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PNEBS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PPOID(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQI(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PQICE  (YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQL(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PQV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(IN)    :: PRDG_MU0 (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PRDG_MU0N (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PRHGMT
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FCLL(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FCLN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FEVI (YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PSC_FEVN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSFSWDIF (YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSFSWDIR (YDCPG_OPTS%KLON,YDCPG_OPTS%KSW)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSGROUPEL(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSRAIN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PSSNOW(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(IN)    :: PSTATI
REAL(KIND=JPRB),                INTENT(INOUT) :: PTSN(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXDROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXHROV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB),                INTENT(OUT)   :: PXQRO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(OUT)   :: PXTRO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXTROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXURO(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB),                INTENT(INOUT) :: PXUROV(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)

#include "acaa1.intfb.h"
#include "acdifv1.intfb.h"
#include "acdifv2.intfb.h"
#include "aro_ground_diag.h"
#include "aro_ground_diag_2isba.h"
#include "aro_ground_param.h"
#include "arp_ground_param.intfb.h"

REAL(KIND=JPRB) :: ZZS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZTWSNOW(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZTOWNS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZSVM (YDCPG_OPTS%KLON,1,1)
REAL(KIND=JPRB) :: ZSSO_STDEV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZSFSV (YDCPG_OPTS%KLON,1)
REAL(KIND=JPRB) :: ZSFCO2(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZRHODREFM(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZQT(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZHV2(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFMDV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFMDU(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFEVS(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFEV(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZFCLL  (YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZDSE(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZDEPTH_HEIGHT(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBSV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB) :: ZCFBS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBQ(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFASV(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG,1:YDMODEL%YRML_GCONF%YGFL%NGFL_EXT)
REAL(KIND=JPRB) :: ZCFAS(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFAQ(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCD(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZCH(YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZBUDTH (YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZBUDSO (YDCPG_OPTS%KLON)
REAL(KIND=JPRB) :: ZCARDI
REAL(KIND=JPRB) :: ZDUMMY(YDCPG_OPTS%KLON,0:YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBU_G(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBV_G(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBS_G(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
REAL(KIND=JPRB) :: ZCFBQ_G(YDCPG_OPTS%KLON,YDCPG_OPTS%KFLEVG)
INTEGER(KIND=JPIM) :: IRR
INTEGER(KIND=JPIM) :: JLEV
INTEGER(KIND=JPIM) :: JLON
INTEGER(KIND=JPIM) :: JSG

REAL (KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SURFACE', 0, ZHOOK_HANDLE)

ASSOCIATE (KLON => YDCPG_OPTS%KLON, KIDIA => YDCPG_BNDS%KIDIA, KFDIA => YDCPG_BNDS%KFDIA, KFLEVG => YDCPG_OPTS%KFLEVG)

ASSOCIATE (YDCST => YDMODEL%YRCST)

! VERTICAL DIFFUSION AND IMPLICIT SURFACE
! Sauvegarde temporaire de l'ancien acdifus pour les besoins du Climat
    
!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn,NAME=ACDIFV1 {

CALL ACDIFV1 (YDMODEL%YRCST, YDMODEL%YRML_GCONF%YGFL, YDMODEL%YRML_PHY_MF, KIDIA, KFDIA, KLON,                                 &
& YDCPG_OPTS%KTDIA, KFLEVG, 0, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF,                      &
& PCP, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%DELP, PKTROV, PKQROV, PKUROV, PQV, PQL, PQI, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, &
& YDMF_PHYS_BASE_STATE%T, YDMF_PHYS_BASE_STATE%U, YDMF_PHYS_BASE_STATE%V, ZSVM, PXTROV, PXUROV,                                &
& PXDROV, PXHROV, PEDMFS, PEDMFQ, PEDMFU, PEDMFV, ZDUMMY, PMF_UP, PXURO, PXQRO, PXTRO, ZCFAQ, ZCFAS, PCFATH,                   &
& PCFAU, ZCFASV, ZCFBQ, ZCFBS, PCFBTH, PCFBU, PCFBV, ZCFBSV, ZDSE, ZQT)   

!$ACDC }
        
IF ( YDMODEL%YRML_PHY_MF%YRARPHY%LMSE.AND.YDCPG_OPTS%LCALLSFX ) THEN

  ZCARDI=YDMODEL%YRML_PHY_RAD%YRERDI%RCARDI
  IRR=2

!$ACDC PARALLEL {

  DO JLON = KIDIA, KFDIA
    ZRHODREFM(JLON)=YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF(JLON,KFLEVG)/(YDMF_PHYS_BASE_STATE%T(JLON,KFLEVG)*YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%R(JLON,KFLEVG))
    ZZS(JLON)=YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(JLON,KFLEVG)/YDCST%RG
  ENDDO

  DO JLEV = 1, KFLEVG
    DO JLON = KIDIA, KFDIA
      ZDEPTH_HEIGHT(JLON,JLEV)=(YDMF_PHYS_BASE_STATE%YCPG_DYN%PHIF(JLON,JLEV)-YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI(JLON,KFLEVG))/YDCST%RG
    ENDDO
  ENDDO

  CALL ARO_GROUND_PARAM( YDCPG_BNDS%KBL, KFDIA-KIDIA+1, KIDIA,                                                                &
  & KFDIA, YDCPG_OPTS%NSTEP, IRR, YDMODEL%YRML_PHY_RAD%YRERAD%NSW, YDMODEL%YRML_GCONF%YGFL%NGFL_EXT,                          &
  & YDGEOMETRY%YRDIM%NDGUNG, YDGEOMETRY%YRDIM%NDGUXG, YDGEOMETRY%YRDIM%NDLUNG, YDGEOMETRY%YRDIM%NDLUXG,                       &
  & YDMODEL%YRML_PHY_MF%YRARPHY%LMPA, YDMODEL%YRML_PHY_MF%YRARPHY%CCOUPLING,                                                  &
  & YDCPG_OPTS%LCONFX, YDCPG_OPTS%NINDAT, PRHGMT, PSTATI, YDMODEL%YRML_GCONF%YRRIP%RSOVR, YDMODEL%YRML_GCONF%YRRIP%RCODEC,    &
  & YDMODEL%YRML_GCONF%YRRIP%RSIDEC, YDVARS%GEOMETRY%RINDX%T0(KIDIA:KFDIA), YDVARS%GEOMETRY%RINDY%T0(KIDIA:KFDIA),            &
  & YDMF_PHYS_BASE_STATE%U(KIDIA:KFDIA, KFLEVG:KFLEVG), YDMF_PHYS_BASE_STATE%V(KIDIA:KFDIA, KFLEVG:KFLEVG),                   &
  & YDMF_PHYS_BASE_STATE%T(KIDIA:KFDIA, KFLEVG:KFLEVG), YDMF_PHYS_BASE_STATE%Q(KIDIA:KFDIA, KFLEVG:KFLEVG),                   &
  & ZSVM, ZCARDI, ZRHODREFM(KIDIA:KFDIA), YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYDF(KIDIA:KFDIA, KFLEVG:KFLEVG),                  &
  & YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD(KIDIA:KFDIA, KFLEVG:KFLEVG),                                                         &
  & PDTMSE, ZDEPTH_HEIGHT(KIDIA:KFDIA, KFLEVG), ZZS(KIDIA:KFDIA),                                                             &
  & YDMODEL%YRML_PHY_MF%YRMSE%XZSEPS, PRDG_MU0(KIDIA:KFDIA), PRDG_MU0N(KIDIA:KFDIA),                                          &
  & YDVARS%GEOMETRY%GELAM%T0(KIDIA:KFDIA), YDVARS%GEOMETRY%GEMU%T0(KIDIA:KFDIA),                                              &
  & YDMODEL%YRML_PHY_MF%YRPARAR%XSW_BANDS, PSRAIN(KIDIA:KFDIA), PSSNOW(KIDIA:KFDIA),                                          &
  & PSGROUPEL(KIDIA:KFDIA), YDMF_PHYS%OUT%FRTHDS(KIDIA:KFDIA),                                                                &
  & PSFSWDIF(KIDIA:KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW), PSFSWDIR(KIDIA:KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW),       &
  & ZCFAQ(KIDIA:KFDIA, KFLEVG:KFLEVG), PCFATH(KIDIA:KFDIA, KFLEVG:KFLEVG),                                                    &
  & PCFAU(KIDIA:KFDIA, KFLEVG:KFLEVG), ZCFBQ(KIDIA:KFDIA, KFLEVG:KFLEVG),                                                     &
  & PCFBTH(KIDIA:KFDIA, KFLEVG:KFLEVG), PCFBU(KIDIA:KFDIA, KFLEVG:KFLEVG),                                                    &
  & PCFBV(KIDIA:KFDIA, KFLEVG:KFLEVG), YDMF_PHYS%OUT%FCS(KIDIA:KFDIA, 1),                                                     &
  & ZFEV(KIDIA:KFDIA), ZSFSV, ZSFCO2(KIDIA:KFDIA), ZFMDU(KIDIA:KFDIA),                                                        &
  & ZFMDV(KIDIA:KFDIA), PALBP(KIDIA:KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW),                                                &
  & PALBD(KIDIA:KFDIA, 1:YDMODEL%YRML_PHY_RAD%YRERAD%NSW), PFLU_EMIS(KIDIA:KFDIA),                                            &
  & PTSN(KIDIA:KFDIA), YDMF_PHYS%OUT%FRTH(KIDIA:KFDIA, KFLEVG, 1),                                                            &
  & YDMODEL )

! Opposite water vapor flux

  ZFEVS(:)=-ZFEV(:)

  CALL ARO_GROUND_DIAG( YDCPG_BNDS%KBL, KFDIA-KIDIA+1, KIDIA,                                       &
  & KFDIA, KFLEVG, -1, YDGEOMETRY%YRDIM%NDGUNG, YDGEOMETRY%YRDIM%NDGUXG, YDGEOMETRY%YRDIM%NDLUNG,   &
  & YDGEOMETRY%YRDIM%NDLUXG, ZZS(KIDIA:KFDIA),                                                      &
  & ZFEVS(KIDIA:KFDIA), YDMF_PHYS_BASE_STATE%U(KIDIA:KFDIA, 1:KFLEVG),                              &
  & YDMF_PHYS_BASE_STATE%V(KIDIA:KFDIA, 1:KFLEVG), ZDEPTH_HEIGHT(KIDIA:KFDIA, 1:KFLEVG),            &
  & YDMF_PHYS%OUT%FRTH(KIDIA:KFDIA, KFLEVG, 1), YDMF_PHYS%OUT%FRSO(KIDIA:KFDIA, KFLEVG, 1),         &
  & YDVARS%GEOMETRY%RINDX%T0(KIDIA:KFDIA), YDVARS%GEOMETRY%RINDY%T0(KIDIA:KFDIA),                   &
  & YDCPG_MISC%QS(KIDIA:KFDIA), YDMF_PHYS%OUT%GZ0(KIDIA:KFDIA),                                     &
  & YDMF_PHYS%OUT%GZ0H(KIDIA:KFDIA), YDMF_PHYS%OUT%TCLS (KIDIA:KFDIA),                              &
  & YDMF_PHYS%OUT%QCLS(KIDIA:KFDIA), YDMF_PHYS%OUT%RHCLS(KIDIA:KFDIA),                              &
  & YDMF_PHYS%OUT%UCLS(KIDIA:KFDIA), YDMF_PHYS%OUT%VCLS(KIDIA:KFDIA),                               &
  & YDMF_PHYS%OUT%NUCLS(KIDIA:KFDIA), YDMF_PHYS%OUT%NVCLS(KIDIA:KFDIA),                             &
  & YDMF_PHYS%OUT%FCLL(KIDIA:KFDIA, 1), YDMF_PHYS%OUT%FCLN(KIDIA:KFDIA, 1),                         &
  & YDMF_PHYS%OUT%FEVL(KIDIA:KFDIA, 1), YDMF_PHYS%OUT%FEVN(KIDIA:KFDIA, 1),                         &
  & ZSSO_STDEV(KIDIA:KFDIA), ZTWSNOW(KIDIA:KFDIA),                                                  &
  & YDMF_PHYS%OUT%SNWDE(KIDIA:KFDIA), ZBUDTH(KIDIA:KFDIA),                                          &
  & ZBUDSO(KIDIA:KFDIA), ZFCLL(KIDIA:KFDIA), ZTOWNS(KIDIA:KFDIA),                                   &
  & ZCD(KIDIA:KFDIA), ZCH(KIDIA:KFDIA), YDMF_PHYS%OUT%SIC(KIDIA:KFDIA))

  DO JLON = KIDIA, KFDIA
    YDCPG_GPAR%GZ0(JLON)   = YDMF_PHYS%OUT%GZ0 (JLON)
    YDCPG_GPAR%GZ0H(JLON)  = YDMF_PHYS%OUT%GZ0H(JLON)
    YDCPG_GPAR%VEMIS(JLON) = PFLU_EMIS(JLON)
    YDCPG_GPAR%VQS(JLON)   = YDCPG_MISC%QS  (JLON)
    YDCPG_GPAR%CD(JLON)    = ZCD  (JLON)
  ENDDO

  DO JSG=1,YDMODEL%YRML_PHY_RAD%YRERAD%NSW
    YDCPG_GPAR%ALBSCA(:,JSG) = PALBD(:,JSG)
    YDCPG_GPAR%ALBDIR(:,JSG) = PALBP(:,JSG)
  ENDDO

  DO JSG  = 1, YDMODEL%YRML_PHY_G%YRDPHY%NTSSG+1
    DO JLEV = 0, KFLEVG
      DO JLON = KIDIA, KFDIA
        YDMF_PHYS%OUT%FRTH(JLON,JLEV,JSG)=YDMF_PHYS%OUT%FRTH(JLON,JLEV,JSG)+ZBUDTH(JLON)
      ENDDO
    ENDDO
  ENDDO

! calculation of variables for the old "ISBA" atmosphere scheme
        
  CALL ARO_GROUND_DIAG_2ISBA( YDCPG_BNDS%KBL, KFDIA-KIDIA+1,                                                           &
  & KIDIA, KFDIA, YDGEOMETRY%YRDIM%NDGUNG, YDGEOMETRY%YRDIM%NDGUXG, YDGEOMETRY%YRDIM%NDLUNG,                           &
  & YDGEOMETRY%YRDIM%NDLUXG, YDVARS%GEOMETRY%RINDX%T0(KIDIA:KFDIA),                                                    &
  & YDVARS%GEOMETRY%RINDY%T0(KIDIA:KFDIA), YDMF_PHYS_SURF%GSD_VF%PLSM, YDMF_PHYS_SURF%GSD_VV%PARG,                     &
  & YDMF_PHYS_SURF%GSD_VV%PSAB, YDMF_PHYS_SURF%GSD_VV%PD2, PTSN, ZTWSNOW, YDMF_PHYS_SURF%GSP_SB%PT_T1(KIDIA:KFDIA, 1), &
  & YDMF_PHYS_SURF%GSP_RR%PW_T1(KIDIA:KFDIA), YDMF_PHYS_SURF%GSP_SB%PQ_T1(KIDIA:KFDIA, 1),                             &
  & YDMF_PHYS_SURF%GSP_RR%PIC_T1(KIDIA:KFDIA), YDMF_PHYS_SURF%GSP_SB%PTL_T1(KIDIA:KFDIA, 1),                           &
  & YDMF_PHYS_SURF%GSP_RR%PFC_T1(KIDIA:KFDIA), YDMF_PHYS_SURF%GSP_SG%PA_T1(KIDIA:KFDIA, 1),                            &
  & YDMF_PHYS_SURF%GSP_SG%PR_T1(KIDIA:KFDIA, 1), ZHV2 )
  DO JLON = KIDIA, KFDIA
    YDMF_PHYS_SURF%GSD_VV%PHV(JLON) = ZHV2(JLON)
  ENDDO        

  IF (.NOT.YDMODEL%YRML_PHY_MF%YRPHY%LNODIFQC) THEN
    CALL ACAA1 (YDMODEL%YRCST, YDMODEL%YRML_PHY_MF, KIDIA, KFDIA, KLON, YDCPG_OPTS%KTDIA,            &
    & KFLEVG, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD, PCOEFN, YDMF_PHYS_BASE_STATE%YCPG_DYN%RCP%CP,    &
    & PQL, PQI, YDMF_PHYS_BASE_STATE%T, PALPHA1, PCOEFA, PLVT, PQICE)
  ENDIF

!$ACDC }

ELSEIF (.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMSE) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn,NAME=LMSE_F {

  IF(YDMODEL%YRML_PHY_MF%YRPHY%NDIFFNEB == 5) THEN
    PNEBDIFF(:,:)=PNEBS(:,:)
  ELSEIF(YDMODEL%YRML_PHY_MF%YRPHY%NDIFFNEB == 2) THEN
    DO JLEV = 1, KFLEVG
      DO JLON = KIDIA, KFDIA
        PNEBDIFF(JLON,JLEV)=YDCPG_MISC%NEB(JLON,JLEV)
      ENDDO
    ENDDO
  ELSEIF(YDMODEL%YRML_PHY_MF%YRPHY%NDIFFNEB == 3) THEN
    PNEBDIFF(:,:)=PNEBS(:,:)+(1.0_JPRB-PNEBS(:,:))*PNEBCH(:,:)
  ENDIF

  IF (YDMODEL%YRML_PHY_MF%YRPHY%LEDMFI) THEN
    ZCFBS_G(:,:) = ZCFBS(:,:)
    ZCFBQ_G(:,:) = ZCFBQ(:,:) 
    ZCFBU_G(:,:) = PCFBU(:,:)
    ZCFBV_G(:,:) = PCFBV(:,:)
  ENDIF   

  CALL ARP_GROUND_PARAM (YDMODEL%YRCST,  YDMODEL%YRML_AOC%YRMCC, YDMODEL%YRML_PHY_MF, KIDIA, KFDIA,                                      &
  & KLON, YDCPG_OPTS%KTDIA, KFLEVG, YDCPG_OPTS%YRSURF_DIMS%YSP_SBD%NLEVS, YDMF_PHYS_BASE_STATE%YCPG_DYN%PHI,                             &
  & PCP, YDMF_PHYS%OUT%FRSO, PQV, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP, YDMF_PHYS_BASE_STATE%T, YDMF_PHYS_BASE_STATE%U,               &
  & YDMF_PHYS_BASE_STATE%V, PXURO, PXQRO, PXTRO, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD, PQL, PQI,                                         &
  & PNEBDIFF, PFLU_CD, PFLU_CDN, PCDROV, PCHROV, PCEROV, PDSA_CPS, YDMF_PHYS%OUT%CT, PDQSTS,                                             &
  & PFLU_EMIS, YDMF_PHYS_SURF%GSD_VH%PSPSH, PHQ, PHTR, PHU, YDMF_PHYS_SURF%GSD_VV%PHV, YDMF_PHYS_SURF%GSD_VF%PLSM,                       &
  & YDMF_PHYS_SURF%GSD_VV%PIVEG, PFLU_NEIJ, YDCPG_MISC%QS, PFLU_QSATS, YDMF_PHYS_BASE_STATE%YGSP_SB%T,                                   &
  & YDMF_PHYS_BASE_STATE%YGSP_RR%T, PFLU_VEG, PXDROV, PXHROV, YDMF_PHYS_BASE_STATE%YGSP_RR%W, YDMF_PHYS_BASE_STATE%YGSP_RR%IC,           &
  & ZDSE, ZCFAS, PCFAU, ZCFBS, PCFBU, PCFBV, ZCFBQ, PCOEFA, PALPHA1, PLVT, PQICE, PDIFWQ, PDIFWS,                                        &
  & ZFMDU, ZFMDV, PSC_FEVI, PSC_FEVN, PSC_FCLL, PSC_FCLN, YDMF_PHYS%OUT%FCHSP, YDMF_PHYS%OUT%FCLL (:,1), YDMF_PHYS%OUT%FCLN (:,1),       &
  & YDMF_PHYS%OUT%FCS (:,1), PFLU_FEVI (:,1), YDMF_PHYS%OUT%FEVL (:,1), YDMF_PHYS%OUT%FEVN (:,1), YDMF_PHYS%OUT%FEVV,                    &
  & YDMF_PHYS%OUT%FTR, PDSA_LHS, YDMF_PHYS_SURF%GSD_VH%PQSH, YDMF_PHYS%OUT%FRTH, YDMF_PHYS_SURF%GSD_VF%PZ0F, YDMF_PHYS_SURF%GSD_VV%PZ0H)

  DO JLON = KIDIA, KFDIA
    YDMF_PHYS%OUT%DIFTQ(JLON,KFLEVG)=PDIFWQ(JLON)
    YDMF_PHYS%OUT%DIFTS(JLON,KFLEVG)=PDIFWS(JLON)
  ENDDO

  IF (YDMODEL%YRML_PHY_MF%YRPHY%LEDMFI) THEN
    ZCFBQ(:,:)  = ZCFBQ_G(:,:)
    ZCFBS(:,:)  = ZCFBS_G(:,:) 
    PCFBU(:,KFLEVG)  = ZCFBU_G(:,KFLEVG)
    PCFBV(:,KFLEVG)  = ZCFBV_G(:,KFLEVG) 
  ENDIF   

!$ACDC }
             
ELSEIF (.NOT. YDCPG_OPTS%LCALLSFX) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn,NAME=CALLSFX_F {

  DO JSG = 1, YDCPG_OPTS%KTSSG+1
    YDMF_PHYS%OUT%FCS(:,JSG) = 0.0_JPRB
  ENDDO
  ZFEV(:)   = 0.0_JPRB

!$ACDC }

ENDIF

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn,NAME=ACDIFV2 {

CALL ACDIFV2 (YDCPG_OPTS%LSFORCS, YDMODEL%YRCST, YDMODEL%YRML_GCONF%YGFL, YDMODEL%YRML_PHY_MF, KIDIA, KFDIA,      &
& KLON, YDCPG_OPTS%KTDIA, KFLEVG, 0, YDMF_PHYS_BASE_STATE%YCPG_PHY%PREHYD, ZCFAQ, ZCFAS, PCFAU,                   &
& ZCFASV, ZCFBQ, ZCFBS, PCFBU, PCFBV, ZCFBSV, PKTROV, PKQROV, PKQLROV, PKUROV, ZDSE, ZQT, YDMF_PHYS_BASE_STATE%U, &
& YDMF_PHYS_BASE_STATE%V, PPOID, YDMF_PHYS_BASE_STATE%T, PQL, PQI, YDMF_PHYS_BASE_STATE%YCPG_PHY%XYB%RDELP,       &
& PCOEFA, PALPHA1, PLVT, PQICE, ZSFSV, YDMF_PHYS%OUT%FCS (:,1), ZFEV, ZFMDU, ZFMDV, PTSN, PXHROV, PDIFEXT,        &
& YDMF_PHYS%OUT%DIFTQ, YDMF_PHYS%OUT%DIFTS, YDMF_PHYS%OUT%STRTU, YDMF_PHYS%OUT%STRTV, YDMF_PHYS%OUT%DIFTQL,       &
& YDMF_PHYS%OUT%DIFTQN, YDMF_PHYS%OUT%DIFCQ, YDMF_PHYS%OUT%DIFCS, YDMF_PHYS%OUT%STRCU, YDMF_PHYS%OUT%STRCV,       &
& YDVARS%SHTUR%T0          )
      
!$ACDC }

IF ( YDMODEL%YRML_PHY_MF%YRPHY%LEDKF ) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn,NAME=LEDKF {

  DO JLON = KIDIA, KFDIA             
     YDMF_PHYS_SURF%GSD_SFL%PGROUP(JLON,1) = YDMF_PHYS%OUT%DIFTS(JLON,KFLEVG)
     YDMF_PHYS_SURF%GSD_SFL%PGROUP(JLON,2) = YDMF_PHYS%OUT%DIFTQ(JLON,KFLEVG)
  ENDDO

!$ACDC }

ENDIF

IF ( YDMODEL%YRML_PHY_MF%YRARPHY%LMSE ) THEN

!$ACDC PARALLEL, TARGET=OpenMP/OpenMPSingleColumn/OpenACCSingleColumn,NAME=LMSE_F2 {

  DO JLON = KIDIA, KFDIA
    YDCPG_GPAR%VTS(JLON) = PTSN (JLON)
    YDMF_PHYS_SURF%GSP_SG%PF_T1(JLON,1) = ZTWSNOW (JLON)
  ENDDO

!$ACDC }

ENDIF

END ASSOCIATE

END ASSOCIATE

IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SURFACE', 1, ZHOOK_HANDLE)

END SUBROUTINE APL_ARPEGE_SURFACE

