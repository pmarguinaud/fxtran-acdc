
SUBROUTINE CONVECT_CONDENS_OPENACC (CST, D, CONVPAR, KICE, PPRES, PTHL&
&, PRW, PRCO, PRIO, PZ, PT, PEW, PRC, PRI, PLV, PLS, PCPH, YDSTACK)
!$ACC ROUTINE (CONVECT_CONDENS_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR,ONLY:CONVPAR_T
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CONVPAR_T), INTENT (IN)::CONVPAR
INTEGER, INTENT (IN)::KICE
REAL, INTENT (IN)::PPRES(D%NIT)
REAL, INTENT (IN)::PTHL(D%NIT)
REAL, INTENT (IN)::PRW(D%NIT)
REAL, INTENT (IN)::PRCO(D%NIT)
REAL, INTENT (IN)::PRIO(D%NIT)
REAL, INTENT (IN)::PZ(D%NIT)
REAL, INTENT (OUT)::PT(D%NIT)
REAL, INTENT (OUT)::PEW(D%NIT)
REAL, INTENT (OUT)::PRC(D%NIT)
REAL, INTENT (OUT)::PRI(D%NIT)
REAL, INTENT (OUT)::PLV(D%NIT)
REAL, INTENT (OUT)::PLS(D%NIT)
REAL, INTENT (OUT)::PCPH(D%NIT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER::JI
INTEGER::JITER
REAL::ZEPS
REAL::ZEI
REAL::ZT
REAL::ZWORK3
REAL::ZWORK2
REAL::ZWORK1


JI = D%NIB


ZEPS=CST%XRD/CST%XRV

PCPH (JI)=CST%XCPD+CST%XCPV*PRW (JI)
ZWORK1 =(1.+PRW (JI))*CST%XG*PZ (JI)
PT (JI)=(PTHL (JI)+PRCO (JI)*CST%XLVTT+PRIO (JI)*CST%XLSTT-ZWORK1 )/PCPH (JI)
PT (JI)=MAX (180., MIN (330., PT (JI)))


DO JITER=1, 6
  
  PEW (JI)=EXP (CST%XALPW-CST%XBETAW/PT (JI)-CST%XGAMW*ALOG (PT (JI)))
  ZEI =EXP (CST%XALPI-CST%XBETAI/PT (JI)-CST%XGAMI*ALOG (PT (JI)))
  PEW (JI)=ZEPS*PEW (JI)/(PPRES (JI)-PEW (JI))
  ZEI =ZEPS*ZEI /(PPRES (JI)-ZEI )
  PLV (JI)=CST%XLVTT+(CST%XCPV-CST%XCL)*(PT (JI)-CST%XTT)
  PLS (JI)=CST%XLSTT+(CST%XCPV-CST%XCI)*(PT (JI)-CST%XTT)
  ZWORK2 =(CONVPAR%XTFRZ1-PT (JI))/(CONVPAR%XTFRZ1-CONVPAR%XTFRZ2)
  ZWORK2 =MAX (0., MIN (1., ZWORK2 ))*REAL (KICE)
  ZWORK3 =(1.-ZWORK2 )*PEW (JI)+ZWORK2 *ZEI 
  PRC (JI)=MAX (0.,(1.-ZWORK2 )*(PRW (JI)-ZWORK3 ))
  PRI (JI)=MAX (0., ZWORK2 *(PRW (JI)-ZWORK3 ))
  ZT =(PTHL (JI)+PRC (JI)*PLV (JI)+PRI (JI)*PLS (JI)-ZWORK1 )/PCPH (JI)
  PT (JI)=PT (JI)+(ZT -PT (JI))*0.4
  PT (JI)=MAX (175., MIN (330., PT (JI)))
  
ENDDO


END SUBROUTINE CONVECT_CONDENS_OPENACC
