
MODULE MODE_COMPUTE_UPDRAFT_RAHA_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_UPDRAFT_RAHA_OPENACC (D, CST, NEBN, PARAMMF, KSV, OENTR_DETR, ONOMIXLG, KSV_LGBEG&
&, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM, PTKEM, PEXNM, PTHM, PRVM, PTHLM, PRTM&
&, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP, PTHV_UP, PW_UP, PU_UP, PV_UP, PSV_UP, PFRAC_UP, PFRAC_ICE_UP&
&, PRSAT_UP, PEMF, PDETR, PENTR, PBUO_INTEG, KKLCL, KKETL, KKCTL, PDEPTH, YDSTACK)
!$ACC ROUTINE (COMPUTE_UPDRAFT_RAHA_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_NEB_N,ONLY:NEB_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODI_SHUMAN_MF,ONLY:MZM_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZM_MF_OPENACC

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (NEB_T), INTENT (IN)::NEBN
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::OENTR_DETR
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSFRV(D%NIJT)
REAL, INTENT (IN)::PSFTH(D%NIJT)
REAL, INTENT (IN)::PPABSM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEXNM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRI_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PW_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_ICE_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRSAT_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSV_UP(D%NIJT, D%NKT, KSV)
REAL, INTENT (INOUT)::PENTR(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PDETR(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PBUO_INTEG(D%NIJT, D%NKT)
INTEGER, INTENT (INOUT)::KKCTL(D%NIJT)
INTEGER, INTENT (INOUT)::KKETL(D%NIJT)
INTEGER, INTENT (INOUT)::KKLCL(D%NIJT)
REAL, INTENT (OUT)::PDEPTH(D%NIJT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL, ZRVM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTKEM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHLM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRTM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRHO_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZVM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZUM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHVM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHVM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZPRES_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZG_O_THVREF, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZW_UP2, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTH_UP, (D%NIJT, D%NKT))
REAL::ZT_UP
REAL::ZLVOCPEXN
REAL::ZCP
fxtran_acdc_temp (REAL, ZBUO, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHSM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHS_UP, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZCOEF, (D%NIJT, D%NKT))
REAL::ZRDORV
REAL::ZRVORD
REAL::ZMIX3
REAL::ZMIX2
REAL::ZMIX1
INTEGER::JI
INTEGER::JK
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKB
INTEGER::IKT
LOGICAL::GTESTETL
LOGICAL::GTESTLCL
LOGICAL::GTEST
LOGICAL::GWORK1
fxtran_acdc_temp (LOGICAL, GWORK2, (D%NIJT, D%NKT))
REAL::ZRSATI
REAL::ZRSATW
REAL::ZRV_UP
REAL::ZRI_UP
REAL::ZRC_UP
REAL::ZALIM_STAR_TOT
REAL::ZPHI
fxtran_acdc_temp (REAL, ZZZ, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZZDZ, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZALIM_STAR, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZDTHETASDZ, (D%NIJT, D%NKT))
INTEGER::IALIM
REAL::ZWUP_MEAN
REAL::ZDZ
REAL::ZTEST
REAL::ZBUCOE
REAL::ZWCOE
REAL::ZCOE
REAL::ZDETR_RT
REAL::ZDETR_BUO
REAL::ZW_MAX
REAL::ZZTOP
REAL::ZQT_UP
REAL::ZQTM
REAL::ZDEPTH_MAX2
REAL::ZDEPTH_MAX1
REAL::ZEPS
REAL::ZRMAX
REAL::ZTMAX
REAL::ZBUF(16)

INTEGER::II
INTEGER::JITER
INTEGER::IE
INTEGER::IB
INTEGER::J
INTEGER, PARAMETER::I1PRT=16
INTEGER, PARAMETER::I99PP=15
INTEGER, PARAMETER::ILOGT=14
INTEGER, PARAMETER::IFOESI=13
INTEGER, PARAMETER::IFOESW=12
INTEGER, PARAMETER::IDRSATODTI=11
INTEGER, PARAMETER::IDRSATODTW=10
INTEGER, PARAMETER::IDRSATODT=9
INTEGER, PARAMETER::ILSOCPEXN=8
INTEGER, PARAMETER::ILVOCPEXN=7
INTEGER, PARAMETER::IT=6
INTEGER, PARAMETER::ICPH2=5
INTEGER, PARAMETER::IRLTEMP=4
INTEGER, PARAMETER::ICPH=3
INTEGER, PARAMETER::IRVSAT=2
INTEGER, PARAMETER::IEXN=1
REAL::ZDELT
REAL::ZTPOW2
REAL::ZVAR2
REAL::ZVAR1

YLSTACK = YDSTACK



IF (KIND (ZRVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRVM_F)
ELSEIF (KIND (ZRVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHM_F)
ELSEIF (KIND (ZTHM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTKEM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTKEM_F)
ELSEIF (KIND (ZTKEM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTKEM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHLM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHLM_F)
ELSEIF (KIND (ZTHLM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHLM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRTM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRTM_F)
ELSEIF (KIND (ZRTM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRTM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRHO_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRHO_F)
ELSEIF (KIND (ZRHO_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRHO_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZVM_F)
ELSEIF (KIND (ZVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZUM_F)
ELSEIF (KIND (ZUM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZUM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHVM) == 8) THEN
    fxtran_acdc_alloc8 (ZTHVM)
ELSEIF (KIND (ZTHVM) == 4) THEN
    fxtran_acdc_alloc4 (ZTHVM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHVM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHVM_F)
ELSEIF (KIND (ZTHVM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHVM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPRES_F) == 8) THEN
    fxtran_acdc_alloc8 (ZPRES_F)
ELSEIF (KIND (ZPRES_F) == 4) THEN
    fxtran_acdc_alloc4 (ZPRES_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZG_O_THVREF) == 8) THEN
    fxtran_acdc_alloc8 (ZG_O_THVREF)
ELSEIF (KIND (ZG_O_THVREF) == 4) THEN
    fxtran_acdc_alloc4 (ZG_O_THVREF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZW_UP2) == 8) THEN
    fxtran_acdc_alloc8 (ZW_UP2)
ELSEIF (KIND (ZW_UP2) == 4) THEN
    fxtran_acdc_alloc4 (ZW_UP2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTH_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZTH_UP)
ELSEIF (KIND (ZTH_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZTH_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBUO) == 8) THEN
    fxtran_acdc_alloc8 (ZBUO)
ELSEIF (KIND (ZBUO) == 4) THEN
    fxtran_acdc_alloc4 (ZBUO)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHSM) == 8) THEN
    fxtran_acdc_alloc8 (ZTHSM)
ELSEIF (KIND (ZTHSM) == 4) THEN
    fxtran_acdc_alloc4 (ZTHSM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHS_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZTHS_UP)
ELSEIF (KIND (ZTHS_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZTHS_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCOEF) == 8) THEN
    fxtran_acdc_alloc8 (ZCOEF)
ELSEIF (KIND (ZCOEF) == 4) THEN
    fxtran_acdc_alloc4 (ZCOEF)
ELSE
    STOP 1
ENDIF


IF (KIND (GWORK2) == 8) THEN
    fxtran_acdc_alloc8 (GWORK2)
ELSEIF (KIND (GWORK2) == 4) THEN
    fxtran_acdc_alloc4 (GWORK2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZZ) == 8) THEN
    fxtran_acdc_alloc8 (ZZZ)
ELSEIF (KIND (ZZZ) == 4) THEN
    fxtran_acdc_alloc4 (ZZZ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZDZ) == 8) THEN
    fxtran_acdc_alloc8 (ZZDZ)
ELSEIF (KIND (ZZDZ) == 4) THEN
    fxtran_acdc_alloc4 (ZZDZ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZALIM_STAR) == 8) THEN
    fxtran_acdc_alloc8 (ZALIM_STAR)
ELSEIF (KIND (ZALIM_STAR) == 4) THEN
    fxtran_acdc_alloc4 (ZALIM_STAR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDTHETASDZ) == 8) THEN
    fxtran_acdc_alloc8 (ZDTHETASDZ)
ELSEIF (KIND (ZDTHETASDZ) == 4) THEN
    fxtran_acdc_alloc4 (ZDTHETASDZ)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKE=D%NKE
IKL=D%NKL
ZTMAX=2.0
ZRMAX=1.E-3
ZEPS=1.E-15
ZRDORV=CST%XRD/CST%XRV
ZRVORD=(CST%XRV/CST%XRD)
ZDEPTH_MAX1=4500.
ZDEPTH_MAX2=5000.
KKLCL (JI)=IKE
KKETL (JI)=IKE
KKCTL (JI)=IKE
PEMF (JI,:)=0.
PDETR (JI,:)=0.
PENTR (JI,:)=0.
PRV_UP (JI,:)=0.
PRC_UP (JI,:)=0.
PW_UP (JI,:)=0.
ZTH_UP (JI,:)=0.
PFRAC_UP (JI,:)=0.
PTHV_UP (JI,:)=0.
PBUO_INTEG (JI,:)=0.
ZBUO (JI,:)=0.
PRI_UP (JI,:)=0.
PFRAC_ICE_UP (JI,:)=0.

DO JK=1, IKT
  
  PRSAT_UP (JI, JK)=PRVM (JI, JK)
  
ENDDO

CALL MZM_MF_OPENACC (D, PTHLM (:,:), ZTHLM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), ZRTM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PUM (:,:), ZUM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PVM (:,:), ZVM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTKEM (:,:), ZTKEM_F (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  PTHL_UP (JI, JK)=ZTHLM_F (JI, JK)
  PRT_UP (JI, JK)=ZRTM_F (JI, JK)
  PU_UP (JI, JK)=ZUM_F (JI, JK)
  PV_UP (JI, JK)=ZVM_F (JI, JK)
  
ENDDO

PSV_UP (JI,:,:)=0.

PTHL_UP (JI, IKB)=ZTHLM_F (JI, IKB)+MAX (0., MIN (ZTMAX,(PSFTH&
& (JI)/SQRT (ZTKEM_F (JI, IKB)))*PARAMMF%XALP_PERT))
PRT_UP (JI, IKB)=ZRTM_F (JI, IKB)+MAX (0., MIN (ZRMAX,(PSFRV&
& (JI)/SQRT (ZTKEM_F (JI, IKB)))*PARAMMF%XALP_PERT))
ZQT_UP =PRT_UP (JI, IKB)/(1.+PRT_UP (JI, IKB))
ZTHS_UP (JI, IKB)=PTHL_UP (JI, IKB)*(1.+PARAMMF%XLAMBDA_MF*ZQT_UP )

CALL MZM_MF_OPENACC (D, PTHM (:,:), ZTHM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PPABSM (:,:), ZPRES_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRHODREF (:,:), ZRHO_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRVM (:,:), ZRVM_F (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  ZTHVM_F (JI, JK)=ZTHM_F (JI, JK)*((1.+ZRVORD*ZRVM_F (JI, JK))/(1.+ZRTM_F (JI, JK)))
  ZTHVM (JI, JK)=PTHM (JI, JK)*((1.+ZRVORD*PRVM (JI, JK))/(1.+PRTM (JI, JK)))
  PTHV_UP (JI, JK)=ZTHVM_F (JI, JK)
  PRV_UP (JI, JK)=ZRVM_F (JI, JK)
  
ENDDO

ZW_UP2 (JI,:)=ZEPS

ZW_UP2 (JI, IKB)=MAX (0.0001,(1./6.)*ZTKEM_F (JI, IKB))
GTEST =(ZW_UP2 (JI, IKB)>ZEPS)


PRC_UP (JI, IKB)=0.
PRI_UP (JI, IKB)=0.


IB=MERGE (D%NIJB, 1, .TRUE.)
IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
JITER=2
ZBUF (ICPH2)=0




ZBUF (IEXN)=(ZPRES_F (JI, IKB)/CST%XP00)**CST%RDSCPD

DO J=IB, IE
  ZBUF (I99PP)=0.99*ZPRES_F (JI, IKB)
  PRV_UP (JI, IKB)=PRT_UP (JI, IKB)-PRC_UP (JI, IKB)-PRI_UP (JI, IKB)
  ZBUF (ICPH)=CST%XCPD+CST%XCPV*PRV_UP (JI, IKB)+CST%XCL*PRC_UP&
  & (JI, IKB)+CST%XCI*PRI_UP (JI, IKB)+ZBUF (ICPH2)
  ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
  ZDELT=(PTHL_UP (JI, IKB)*ZBUF (IEXN))-CST%XTT
  ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
  ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
  ZTH_UP (JI, IKB)=PTHL_UP (JI, IKB)+ZBUF (ILVOCPEXN)*PRC_UP&
  & (JI, IKB)+ZBUF (ILSOCPEXN)*PRI_UP (JI, IKB)
  ZBUF (I1PRT)=1+PRT_UP (JI, IKB)
ENDDO


DO II=1, JITER
  
  ZBUF (IT)=ZTH_UP (JI, IKB)*ZBUF (IEXN)
  
  PFRAC_ICE_UP (JI, IKB)=0.

  DO J=IB, IE

    IF (PRC_UP (JI, IKB)+PRI_UP (JI, IKB)>1.E-20) THEN
      PFRAC_ICE_UP (JI, IKB)=PRI_UP (JI, IKB)/(PRC_UP (JI, IKB)+PRI_UP (JI, IKB))
    ENDIF

  ENDDO


  

  

  

  SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
  CASE ('T')
    PFRAC_ICE_UP (JI, IKB)=MAX (0., MIN (1.,((NEBN%XTMAXMIX-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
  CASE ('O')
    PFRAC_ICE_UP (JI, IKB)=MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
  CASE ('N')
    PFRAC_ICE_UP (JI, IKB)=0.
  CASE ('S')
    PFRAC_ICE_UP (JI, IKB)=MAX (0., MIN (1., PFRAC_ICE_UP (JI, IKB)))
  CASE DEFAULT
  
  ENDSELECT

  
  
  
  ZBUF (ILOGT)=LOG (ZBUF (IT))

  DO J=IB, IE
    ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
    ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
    ZRSATW =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRES_F (JI, IKB)/(1&
    &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F (JI, IKB))
    ZRSATI =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRES_F (JI, IKB)/(1&
    &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F (JI, IKB))
    ZTPOW2=ZBUF (IT)**2
    ZBUF (IDRSATODTW)=ZRSATW /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F&
    & (JI, IKB))*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
    ZBUF (IDRSATODTI)=ZRSATI /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F&
    & (JI, IKB))*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
    ZRSATW =ZRSATW *ZBUF (I1PRT)
    ZRSATI =ZRSATI *ZBUF (I1PRT)
    ZBUF (IRVSAT)=ZRSATW *(1-PFRAC_ICE_UP (JI, IKB))+ZRSATI *PFRAC_ICE_UP (JI, IKB)
    ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-PFRAC_ICE_UP (JI&
    &, IKB))+ZBUF (IDRSATODTI)*PFRAC_ICE_UP (JI, IKB))
    ZBUF (IRLTEMP)=(PRV_UP (JI, IKB)-ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN)*(ZBUF&
    & (ILVOCPEXN)*(1-PFRAC_ICE_UP (JI, IKB))+ZBUF (ILSOCPEXN)*PFRAC_ICE_UP (JI, IKB)))
    ZBUF (IRLTEMP)=MIN (MAX (-PRC_UP (JI, IKB)-PRI_UP (JI, IKB), ZBUF (IRLTEMP)), PRV_UP (JI, IKB))
    PRV_UP (JI, IKB)=PRV_UP (JI, IKB)-ZBUF (IRLTEMP)
    PRC_UP (JI, IKB)=PRC_UP (JI, IKB)+PRI_UP (JI, IKB)+ZBUF (IRLTEMP)
    PRI_UP (JI, IKB)=PFRAC_ICE_UP (JI, IKB)*(PRC_UP (JI, IKB))
    PRC_UP (JI, IKB)=(1-PFRAC_ICE_UP (JI, IKB))*(PRT_UP (JI, IKB)-PRV_UP (JI, IKB))
    ZBUF (ICPH)=CST%XCPD+CST%XCPV*PRV_UP (JI, IKB)+CST%XCL*PRC_UP&
    & (JI, IKB)+CST%XCI*PRI_UP (JI, IKB)+ZBUF (ICPH2)
    ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
    ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
    ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
    ZTH_UP (JI, IKB)=PTHL_UP (JI, IKB)+ZBUF (ILVOCPEXN)*PRC_UP&
    & (JI, IKB)+ZBUF (ILSOCPEXN)*PRI_UP (JI, IKB)
    ZVAR1=ZTH_UP (JI, IKB)*ZBUF (IEXN)-ZBUF (IT)
    ZRSATW =ZRSATW +ZBUF (IDRSATODTW)*ZVAR1
    ZRSATI =ZRSATI +ZBUF (IDRSATODTI)*ZVAR1
  ENDDO

ENDDO




PTHV_UP (JI, IKB)=ZTH_UP (JI, IKB)*((1+ZRVORD*PRV_UP (JI, IKB))/(1+PRT_UP (JI, IKB)))
PRSAT_UP (JI, IKB)=ZRSATW *(1-PFRAC_ICE_UP (JI, IKB))+ZRSATI *PFRAC_ICE_UP (JI, IKB)


DO JK=1, IKT
  
  ZG_O_THVREF (JI, JK)=CST%XG/ZTHVM_F (JI, JK)
  
ENDDO

ZALIM_STAR (JI,:)=0.
ZALIM_STAR_TOT =0.
IALIM =IKB

DO JK=IKB, IKE-IKL, IKL
  
  ZZDZ (JI, JK)=MAX (ZEPS, PZZ (JI, JK+IKL)-PZZ (JI, JK))
  ZZZ (JI, JK)=MAX (0., 0.5*(PZZ (JI, JK+IKL)+PZZ (JI, JK)))
  ZDTHETASDZ (JI, JK)=(ZTHVM_F (JI, JK)-ZTHVM_F (JI, JK+IKL))

  IF ((ZTHVM_F (JI, JK+IKL)<ZTHVM_F (JI, JK)).AND.(ZTHVM_F (JI, IKB)>=ZTHVM_F (JI, JK))) THEN
    ZALIM_STAR (JI, JK)=SQRT (ZZZ (JI, JK))*ZDTHETASDZ (JI, JK)/ZZDZ (JI, JK)
    ZALIM_STAR_TOT =ZALIM_STAR_TOT +ZALIM_STAR (JI, JK)*ZZDZ (JI, JK)
    IALIM =JK
  ENDIF

  
ENDDO


DO JK=IKB, IKE-IKL, IKL

  

  IF (ZALIM_STAR_TOT >ZEPS) THEN
    ZALIM_STAR (JI, JK)=ZALIM_STAR (JI, JK)/ZALIM_STAR_TOT 
  ENDIF

  
ENDDO

ZALIM_STAR_TOT =0.
GTESTLCL =.FALSE.
GTESTETL =.FALSE.
ZW_MAX =0.
ZZTOP =0.
ZPHI =0.

DO JK=IKB, IKE-IKL, IKL

  

  IF ((PRC_UP (JI, JK)+PRI_UP (JI, JK)>0.).AND.(.NOT.(GTESTLCL ))) THEN
    KKLCL (JI)=JK
    GTESTLCL =.TRUE.
  ENDIF

  ZRC_UP =PRC_UP (JI, JK)
  ZRI_UP =PRI_UP (JI, JK)
  ZRV_UP =PRV_UP (JI, JK)
  ZBUO (JI, JK)=ZG_O_THVREF (JI, JK)*(PTHV_UP (JI, JK)-ZTHVM_F (JI, JK))
  PBUO_INTEG (JI, JK)=ZBUO (JI, JK)*(PZZ (JI, JK+IKL)-PZZ (JI, JK))
  ZDZ =MAX (ZEPS, PZZ (JI, JK+IKL)-PZZ (JI, JK))
  ZTEST =PARAMMF%XA1*ZBUO (JI, JK)-PARAMMF%XB*ZW_UP2 (JI, JK)
  ZCOE =ZDZ 

  IF (ZTEST >0.) THEN
    ZCOE =ZDZ /(1.+PARAMMF%XBETA1)
  ENDIF

  ZWCOE =(1.-PARAMMF%XB*ZCOE )/(1.+PARAMMF%XB*ZCOE )
  ZBUCOE =2.*ZCOE /(1.+PARAMMF%XB*ZCOE )
  ZW_UP2 (JI, JK+IKL)=MAX (ZEPS, ZW_UP2 (JI, JK)*ZWCOE +PARAMMF%XA1*ZBUO (JI, JK)*ZBUCOE )
  ZW_MAX =MAX (ZW_MAX , SQRT (ZW_UP2 (JI, JK+IKL)))
  ZWUP_MEAN =MAX (ZEPS, 0.5*(ZW_UP2 (JI, JK+IKL)+ZW_UP2 (JI, JK)))
  PENTR (JI, JK)=MAX (0.,(PARAMMF%XBETA1/(1.+PARAMMF%XBETA1&
  &))*(PARAMMF%XA1*ZBUO (JI, JK)/ZWUP_MEAN -PARAMMF%XB))
  ZDETR_BUO =MAX (0.,-(PARAMMF%XBETA1/(1.+PARAMMF%XBETA1))*PARAMMF%XA1*ZBUO (JI, JK)/ZWUP_MEAN )
  ZDETR_RT =PARAMMF%XC*SQRT (MAX (0.,(PRT_UP (JI, JK)-ZRTM_F&
  & (JI, JK)))/MAX (ZEPS, ZRTM_F (JI, JK))/ZWUP_MEAN )
  PDETR (JI, JK)=ZDETR_RT +ZDETR_BUO 

  IF (GTEST ) THEN
    ZZTOP =MAX (ZZTOP , PZZ (JI, JK+IKL))
    ZMIX2 =(PZZ (JI, JK+IKL)-PZZ (JI, JK))*PENTR (JI, JK)
    ZMIX3 =(PZZ (JI, JK+IKL)-PZZ (JI, JK))*PDETR (JI, JK)
    ZQTM =PRTM (JI, JK)/(1.+PRTM (JI, JK))
    ZTHSM (JI, JK)=PTHLM (JI, JK)*(1.+PARAMMF%XLAMBDA_MF*ZQTM )
    ZTHS_UP (JI, JK+IKL)=(ZTHS_UP (JI, JK)*(1.-0.5*ZMIX2 )+ZTHSM (JI, JK)*ZMIX2 )/(1.+0.5*ZMIX2 )
    PRT_UP (JI, JK+IKL)=(PRT_UP (JI, JK)*(1.-0.5*ZMIX2 )+PRTM (JI, JK)*ZMIX2 )/(1.+0.5*ZMIX2 )
    ZQT_UP =PRT_UP (JI, JK+IKL)/(1.+PRT_UP (JI, JK+IKL))
    PTHL_UP (JI, JK+IKL)=ZTHS_UP (JI, JK+IKL)/(1.+PARAMMF%XLAMBDA_MF*ZQT_UP )
  ENDIF


  IF (PARAMMF%LMIXUV) THEN

    IF (JK/=IKB) THEN

      IF (GTEST ) THEN
        PU_UP (JI, JK+IKL)=(PU_UP (JI, JK)*(1-0.5*ZMIX2 )+PUM (JI, JK)*ZMIX2 +0.5*PARAMMF&
        &%XPRES_UV*(PZZ (JI, JK+IKL)-PZZ (JI, JK))*((PUM (JI, JK+IKL)-PUM (JI, JK))/PDZZ&
        & (JI, JK+IKL)+(PUM (JI, JK)-PUM (JI, JK-IKL))/PDZZ (JI, JK)))/(1+0.5*ZMIX2 )
        PV_UP (JI, JK+IKL)=(PV_UP (JI, JK)*(1-0.5*ZMIX2 )+PVM (JI, JK)*ZMIX2 +0.5*PARAMMF&
        &%XPRES_UV*(PZZ (JI, JK+IKL)-PZZ (JI, JK))*((PVM (JI, JK+IKL)-PVM (JI, JK))/PDZZ&
        & (JI, JK+IKL)+(PVM (JI, JK)-PVM (JI, JK-IKL))/PDZZ (JI, JK)))/(1+0.5*ZMIX2 )
      ENDIF

    ELSE

      IF (GTEST ) THEN
        PU_UP (JI, JK+IKL)=(PU_UP (JI, JK)*(1-0.5*ZMIX2 )+PUM (JI, JK)*ZMIX2 +0.5*PARAMMF%XPRES_UV*(PZZ (JI&
        &, JK+IKL)-PZZ (JI, JK))*((PUM (JI, JK+IKL)-PUM (JI, JK))/PDZZ (JI, JK+IKL)))/(1+0.5*ZMIX2 )
        PV_UP (JI, JK+IKL)=(PV_UP (JI, JK)*(1-0.5*ZMIX2 )+PVM (JI, JK)*ZMIX2 +0.5*PARAMMF%XPRES_UV*(PZZ (JI&
        &, JK+IKL)-PZZ (JI, JK))*((PVM (JI, JK+IKL)-PVM (JI, JK))/PDZZ (JI, JK+IKL)))/(1+0.5*ZMIX2 )
      ENDIF

    ENDIF

  ENDIF

  ZRC_UP =PRC_UP (JI, JK)
  ZRI_UP =PRI_UP (JI, JK)
  ZRV_UP =PRV_UP (JI, JK)
  
  
  IB=MERGE (D%NIJB, 1, .TRUE.)
  IE=MERGE (D%NIJE, D%NIJT, .TRUE.)
  JITER=2
  ZBUF (ICPH2)=0
  
  
  
  
  ZBUF (IEXN)=(ZPRES_F (JI, JK+IKL)/CST%XP00)**CST%RDSCPD

  DO J=IB, IE
    ZBUF (I99PP)=0.99*ZPRES_F (JI, JK+IKL)
    ZRV_UP =PRT_UP (JI, JK+IKL)-ZRC_UP -ZRI_UP 
    ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRV_UP +CST%XCL*ZRC_UP +CST%XCI*ZRI_UP +ZBUF (ICPH2)
    ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
    ZDELT=(PTHL_UP (JI, JK+IKL)*ZBUF (IEXN))-CST%XTT
    ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*ZDELT)/ZVAR2
    ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*ZDELT)/ZVAR2
    ZTH_UP (JI, JK+IKL)=PTHL_UP (JI, JK+IKL)+ZBUF (ILVOCPEXN)*ZRC_UP +ZBUF (ILSOCPEXN)*ZRI_UP 
    ZBUF (I1PRT)=1+PRT_UP (JI, JK+IKL)
  ENDDO


  DO II=1, JITER
    
    ZBUF (IT)=ZTH_UP (JI, JK+IKL)*ZBUF (IEXN)
    
    PFRAC_ICE_UP (JI, JK+IKL)=0.

    DO J=IB, IE

      IF (ZRC_UP +ZRI_UP >1.E-20) THEN
        PFRAC_ICE_UP (JI, JK+IKL)=ZRI_UP /(ZRC_UP +ZRI_UP )
      ENDIF

    ENDDO


    

    

    

    SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
    CASE ('T')
      PFRAC_ICE_UP (JI, JK+IKL)=MAX (0., MIN (1.,((NEBN%XTMAXMIX&
      &-ZBUF (IT))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
    CASE ('O')
      PFRAC_ICE_UP (JI, JK+IKL)=MAX (0., MIN (1.,((CST%XTT-ZBUF (IT))/40.)))
    CASE ('N')
      PFRAC_ICE_UP (JI, JK+IKL)=0.
    CASE ('S')
      PFRAC_ICE_UP (JI, JK+IKL)=MAX (0., MIN (1., PFRAC_ICE_UP (JI, JK+IKL)))
    CASE DEFAULT
    
    ENDSELECT

    
    
    
    ZBUF (ILOGT)=LOG (ZBUF (IT))

    DO J=IB, IE
      ZBUF (IFOESW)=MIN (EXP (CST%XALPW-CST%XBETAW/ZBUF (IT)-CST%XGAMW*ZBUF (ILOGT)), ZBUF (I99PP))
      ZBUF (IFOESI)=MIN (EXP (CST%XALPI-CST%XBETAI/ZBUF (IT)-CST%XGAMI*ZBUF (ILOGT)), ZBUF (I99PP))
      ZRSATW =CST%XRD/CST%XRV*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL)/(1&
      &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F (JI, JK+IKL))
      ZRSATI =CST%XRD/CST%XRV*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL)/(1&
      &.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F (JI, JK+IKL))
      ZTPOW2=ZBUF (IT)**2
      ZBUF (IDRSATODTW)=ZRSATW /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESW)/ZPRES_F&
      & (JI, JK+IKL))*(CST%XBETAW/ZTPOW2-CST%XGAMW/ZBUF (IT))*ZBUF (I1PRT)
      ZBUF (IDRSATODTI)=ZRSATI /(1.+(CST%XRD/CST%XRV-1.)*ZBUF (IFOESI)/ZPRES_F&
      & (JI, JK+IKL))*(CST%XBETAI/ZTPOW2-CST%XGAMI/ZBUF (IT))*ZBUF (I1PRT)
      ZRSATW =ZRSATW *ZBUF (I1PRT)
      ZRSATI =ZRSATI *ZBUF (I1PRT)
      ZBUF (IRVSAT)=ZRSATW *(1-PFRAC_ICE_UP (JI, JK+IKL))+ZRSATI *PFRAC_ICE_UP (JI, JK+IKL)
      ZBUF (IDRSATODT)=(ZBUF (IDRSATODTW)*(1-PFRAC_ICE_UP (JI, JK&
      &+IKL))+ZBUF (IDRSATODTI)*PFRAC_ICE_UP (JI, JK+IKL))
      ZBUF (IRLTEMP)=(ZRV_UP -ZBUF (IRVSAT))/(1+ZBUF (IDRSATODT)*ZBUF (IEXN)*(ZBUF (ILVOCPEXN&
      &)*(1-PFRAC_ICE_UP (JI, JK+IKL))+ZBUF (ILSOCPEXN)*PFRAC_ICE_UP (JI, JK+IKL)))
      ZBUF (IRLTEMP)=MIN (MAX (-ZRC_UP -ZRI_UP , ZBUF (IRLTEMP)), ZRV_UP )
      ZRV_UP =ZRV_UP -ZBUF (IRLTEMP)
      ZRC_UP =ZRC_UP +ZRI_UP +ZBUF (IRLTEMP)
      ZRI_UP =PFRAC_ICE_UP (JI, JK+IKL)*(ZRC_UP )
      ZRC_UP =(1-PFRAC_ICE_UP (JI, JK+IKL))*(PRT_UP (JI, JK+IKL)-ZRV_UP )
      ZBUF (ICPH)=CST%XCPD+CST%XCPV*ZRV_UP +CST%XCL*ZRC_UP +CST%XCI*ZRI_UP +ZBUF (ICPH2)
      ZVAR2=ZBUF (ICPH)*ZBUF (IEXN)
      ZBUF (ILVOCPEXN)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZBUF (IT)-CST%XTT))/ZVAR2
      ZBUF (ILSOCPEXN)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZBUF (IT)-CST%XTT))/ZVAR2
      ZTH_UP (JI, JK+IKL)=PTHL_UP (JI, JK+IKL)+ZBUF (ILVOCPEXN)*ZRC_UP +ZBUF (ILSOCPEXN)*ZRI_UP 
      ZVAR1=ZTH_UP (JI, JK+IKL)*ZBUF (IEXN)-ZBUF (IT)
      ZRSATW =ZRSATW +ZBUF (IDRSATODTW)*ZVAR1
      ZRSATI =ZRSATI +ZBUF (IDRSATODTI)*ZVAR1
    ENDDO

  ENDDO


  

  

  

  IF (GTEST ) THEN
    ZT_UP =ZTH_UP (JI, JK+IKL)*PEXNM (JI, JK+IKL)
    ZCP =CST%XCPD+CST%XCL*ZRC_UP 
    ZLVOCPEXN =(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT_UP -CST%XTT))/ZCP /PEXNM (JI, JK+IKL)
    PRC_UP (JI, JK+IKL)=MIN (0.5E-3, ZRC_UP )
    PTHL_UP (JI, JK+IKL)=PTHL_UP (JI, JK+IKL)+ZLVOCPEXN *(ZRC_UP -PRC_UP (JI, JK+IKL))
    PRV_UP (JI, JK+IKL)=ZRV_UP 
    PRI_UP (JI, JK+IKL)=ZRI_UP 
    PRT_UP (JI, JK+IKL)=PRC_UP (JI, JK+IKL)+PRV_UP (JI, JK+IKL)
    PRSAT_UP (JI, JK+IKL)=ZRSATW *(1-PFRAC_ICE_UP (JI, JK+IKL))+ZRSATI *PFRAC_ICE_UP (JI, JK+IKL)
  ENDIF


  IF (GTEST ) THEN
    PTHV_UP (JI, JK+IKL)=ZTH_UP (JI, JK+IKL)*(1.+0.608*PRV_UP (JI, JK+IKL)-PRC_UP (JI, JK+IKL))
  ENDIF

  GTESTETL =.FALSE.

  IF (GTEST .AND.(PBUO_INTEG (JI, JK)<=0.)) THEN
    KKETL (JI)=JK+IKL
    GTESTETL =.TRUE.
  ENDIF


  IF (GTEST .AND.((ZW_UP2 (JI, JK+IKL)<=ZEPS))) THEN
    ZW_UP2 (JI, JK+IKL)=ZEPS
    GTEST =.FALSE.
    PTHL_UP (JI, JK+IKL)=ZTHLM_F (JI, JK+IKL)
    PRT_UP (JI, JK+IKL)=ZRTM_F (JI, JK+IKL)
    PRC_UP (JI, JK+IKL)=0.
    PRI_UP (JI, JK+IKL)=0.
    PRV_UP (JI, JK+IKL)=0.
    PTHV_UP (JI, JK+IKL)=ZTHVM_F (JI, JK+IKL)
    PFRAC_UP (JI, JK+IKL)=0.
    KKCTL (JI)=JK+IKL
  ENDIF

  
ENDDO


ZZTOP =MAX (ZZTOP , ZEPS)


DO JK=IKB+IKL, IKE-IKL, IKL

  

  IF (JK<=IALIM ) THEN
    ZALIM_STAR_TOT =ZALIM_STAR_TOT +ZALIM_STAR (JI, JK)**2*ZZDZ (JI, JK)/PRHODREF (JI, JK)
  ENDIF

  
ENDDO



IF (ZALIM_STAR_TOT *ZZTOP >ZEPS) THEN
  ZPHI =ZW_MAX /(PARAMMF%XR*ZZTOP *ZALIM_STAR_TOT )
ENDIF

GTEST =.TRUE.
PEMF (JI, IKB+IKL)=ZPHI *ZZDZ (JI, IKB)*ZALIM_STAR (JI, IKB)
PFRAC_UP (JI, IKB+IKL)=PEMF (JI, IKB+IKL)/(SQRT (ZW_UP2 (JI, IKB+IKL))*ZRHO_F (JI, IKB+IKL))
PFRAC_UP (JI, IKB+IKL)=MIN (PARAMMF%XFRAC_UP_MAX, PFRAC_UP (JI, IKB+IKL))
PEMF (JI, IKB+IKL)=ZRHO_F (JI, IKB+IKL)*PFRAC_UP (JI, IKB+IKL)*SQRT (ZW_UP2 (JI, IKB+IKL))


DO JK=IKB+IKL, IKE-IKL, IKL
  
  GTEST =(ZW_UP2 (JI, JK)>ZEPS)

  IF (GTEST ) THEN

    IF (JK<IALIM ) THEN
      PEMF (JI, JK+IKL)=MAX (0., PEMF (JI, JK)+ZPHI *ZZDZ (JI, JK)*(PENTR (JI, JK)-PDETR (JI, JK)))
    ELSE
      ZMIX1 =ZZDZ (JI, JK)*(PENTR (JI, JK)-PDETR (JI, JK))
      PEMF (JI, JK+IKL)=PEMF (JI, JK)*EXP (ZMIX1 )
    ENDIF

    PFRAC_UP (JI, JK+IKL)=PEMF (JI, JK+IKL)/(SQRT (ZW_UP2 (JI, JK+IKL))*ZRHO_F (JI, JK+IKL))
    PFRAC_UP (JI, JK+IKL)=MIN (PARAMMF%XFRAC_UP_MAX, PFRAC_UP (JI, JK+IKL))
    PEMF (JI, JK+IKL)=ZRHO_F (JI, JK+IKL)*PFRAC_UP (JI, JK+IKL)*SQRT (ZW_UP2 (JI, JK+IKL))
  ENDIF

  
ENDDO


DO JK=1, IKT
  
  PW_UP (JI, JK)=SQRT (ZW_UP2 (JI, JK))
  
ENDDO


PEMF (JI, IKB)=0.


PDEPTH (JI)=MAX (0., PZZ (JI, KKCTL (JI))-PZZ (JI, KKLCL (JI)))


GWORK1 =(GTESTLCL .AND.(PDEPTH (JI)>ZDEPTH_MAX1))


DO JK=1, D%NKT
  
  GWORK2 (JI, JK)=GWORK1 
  ZCOEF (JI, JK)=(1.-(PDEPTH (JI)-ZDEPTH_MAX1)/(ZDEPTH_MAX2-ZDEPTH_MAX1))
  ZCOEF (JI, JK)=MIN (MAX (ZCOEF (JI, JK), 0.), 1.)
  
ENDDO


DO JK=1, IKT

  

  IF (GWORK2 (JI, JK)) THEN
    PEMF (JI, JK)=PEMF (JI, JK)*ZCOEF (JI, JK)
    PFRAC_UP (JI, JK)=PFRAC_UP (JI, JK)*ZCOEF (JI, JK)
  ENDIF

  
ENDDO







END SUBROUTINE COMPUTE_UPDRAFT_RAHA_OPENACC

ENDMODULE MODE_COMPUTE_UPDRAFT_RAHA_OPENACC
