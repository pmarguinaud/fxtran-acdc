
SUBROUTINE GPGRGEO_EXPL_OPENACC (YDGEOMETRY, KPROMA, KST, KEND, KFLEV, PRT, PRTL, PRTM, PLNPR&
&, PALPH, POROGL, POROGM, PHIFL, PHIFM, PHIHL, PHIHM, LDNHEE, LDNHHY, PRNHPPI, PQCHAL, PQCHAM&
&, PEPS_NL, PNH1L, PNH1M, PLNPRL_DER, PLNPRM_DER, PALPHL_DER, PALPHM_DER, YDSTACK)
!$ACC ROUTINE (GPGRGEO_EXPL_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE GEOMETRY_MOD,ONLY:GEOMETRY
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
REAL (KIND=JPRB), INTENT (IN)::PRT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRTL (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRTM (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::POROGL (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::POROGM (KPROMA)
REAL (KIND=JPRB), INTENT (OUT)::PHIFL (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PHIFM (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PHIHL (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PHIHM (KPROMA, 0:KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LDNHEE
LOGICAL, INTENT (IN), OPTIONAL::LDNHHY
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PRNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PQCHAL (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PQCHAM (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PEPS_NL (KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PNH1L (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PNH1M (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PLNPRL_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PLNPRM_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PALPHL_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PALPHM_DER (KPROMA, KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
LOGICAL::LLNHHY
LOGICAL::LLNHEE
CHARACTER (LEN=4)::CLOPER
fxtran_acdc_temp (REAL (KIND=JPRB), ZNH1M, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZNH1L, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZINM, (KPROMA, 0:KFLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZINL, (KPROMA, 0:KFLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRNHPPI, (KPROMA, KFLEV))


#include "verdisint_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZNH1M) == 8) THEN
    fxtran_acdc_alloc8 (ZNH1M)
ELSEIF (KIND (ZNH1M) == 4) THEN
    fxtran_acdc_alloc4 (ZNH1M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZNH1L) == 8) THEN
    fxtran_acdc_alloc8 (ZNH1L)
ELSEIF (KIND (ZNH1L) == 4) THEN
    fxtran_acdc_alloc4 (ZNH1L)
ELSE
    STOP 1
ENDIF


IF (KIND (ZINM) == 8) THEN
    fxtran_acdc_alloc8 (ZINM)
ELSEIF (KIND (ZINM) == 4) THEN
    fxtran_acdc_alloc4 (ZINM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZINL) == 8) THEN
    fxtran_acdc_alloc8 (ZINL)
ELSEIF (KIND (ZINL) == 4) THEN
    fxtran_acdc_alloc4 (ZINL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRNHPPI) == 8) THEN
    fxtran_acdc_alloc8 (ZRNHPPI)
ELSEIF (KIND (ZRNHPPI) == 4) THEN
    fxtran_acdc_alloc4 (ZRNHPPI)
ELSE
    STOP 1
ENDIF


JROF = KST



IF (PRESENT (LDNHEE)) THEN
  LLNHEE=LDNHEE
ELSE
  LLNHEE=.FALSE.
ENDIF


IF (PRESENT (LDNHHY)) THEN
  LLNHHY=LDNHHY
ELSE
  LLNHHY=.FALSE.
ENDIF

CLOPER='IBOT'

IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE)  THEN
  CLOPER='INTG'
ENDIF


PHIHL (JROF, KFLEV)=POROGL (JROF)
PHIHM (JROF, KFLEV)=POROGM (JROF)


IF (LLNHEE) THEN

  IF (.NOT.(PRESENT (PRNHPPI).AND.PRESENT (PQCHAL).AND.PRESENT (PQCHAM)))  THEN
    CALL FXTRAN_ACDC_ABORT (' GPGRGEO_EXPL: missing input PRNHPPI, PQCHAL, PQCHAM !!!')
  ENDIF


  IF (PRESENT (PEPS_NL).AND.LLNHHY) THEN

    DO JLEV=1, KFLEV
      
      ZRNHPPI (JROF, JLEV)=1.0_JPRB+PEPS_NL (JLEV)*(PRNHPPI (JROF, JLEV)-1.0_JPRB)
      ZNH1L (JROF, JLEV)=-PEPS_NL (JLEV)*PRT (JROF, JLEV)*PQCHAL (JROF, JLEV)
      ZNH1M (JROF, JLEV)=-PEPS_NL (JLEV)*PRT (JROF, JLEV)*PQCHAM (JROF, JLEV)
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      ZRNHPPI (JROF, JLEV)=PRNHPPI (JROF, JLEV)
      ZNH1L (JROF, JLEV)=-PRT (JROF, JLEV)*PQCHAL (JROF, JLEV)
      ZNH1M (JROF, JLEV)=-PRT (JROF, JLEV)*PQCHAM (JROF, JLEV)
    
    ENDDO

  ENDIF


  DO JLEV=KFLEV, 1,-1
    
    PHIHL (JROF, JLEV-1)=PHIHL (JROF, JLEV)+PLNPR (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*(PRTL (JROF,&
    & JLEV)+ZNH1L (JROF, JLEV))+PLNPRL_DER (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*PRT (JROF, JLEV)
    PHIHM (JROF, JLEV-1)=PHIHM (JROF, JLEV)+PLNPR (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*(PRTM (JROF,&
    & JLEV)+ZNH1M (JROF, JLEV))+PLNPRM_DER (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*PRT (JROF, JLEV)
  
  ENDDO


  IF (PRESENT (PNH1L).AND.PRESENT (PNH1M)) THEN
    PNH1L (JROF, 1:KFLEV)=ZNH1L (JROF, 1:KFLEV)
    PNH1M (JROF, 1:KFLEV)=ZNH1M (JROF, 1:KFLEV)
  ENDIF

ELSE

  IF (PRESENT (PNH1L).AND.PRESENT (PNH1M)) THEN
    PNH1L (JROF, 1:KFLEV)=0.0_JPRB
    PNH1M (JROF, 1:KFLEV)=0.0_JPRB
  ENDIF


  DO JLEV=KFLEV, 1,-1
    
    PHIHL (JROF, JLEV-1)=PHIHL (JROF, JLEV)+PLNPR (JROF, JLEV)*PRTL&
    & (JROF, JLEV)+PLNPRL_DER (JROF, JLEV)*PRT (JROF, JLEV)
    PHIHM (JROF, JLEV-1)=PHIHM (JROF, JLEV)+PLNPR (JROF, JLEV)*PRTM&
    & (JROF, JLEV)+PLNPRM_DER (JROF, JLEV)*PRT (JROF, JLEV)
  
  ENDDO

ENDIF


IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN

  IF (LLNHEE) THEN

    DO JLEV=1, KFLEV
      
      ZINL (JROF, JLEV)=(-PLNPR (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*(PRTL (JROF&
      &, JLEV)+ZNH1L (JROF, JLEV))-PLNPRL_DER (JROF, JLEV)*ZRNHPPI (JROF, JLEV&
      &)*PRT (JROF, JLEV))*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
      ZINM (JROF, JLEV)=(-PLNPR (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*(PRTM (JROF&
      &, JLEV)+ZNH1M (JROF, JLEV))-PLNPRM_DER (JROF, JLEV)*ZRNHPPI (JROF, JLEV&
      &)*PRT (JROF, JLEV))*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      ZINL (JROF, JLEV)=(-PLNPR (JROF, JLEV)*PRTL (JROF, JLEV)-PLNPRL_DER (JROF, JLEV&
      &)*PRT (JROF, JLEV))*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
      ZINM (JROF, JLEV)=(-PLNPR (JROF, JLEV)*PRTM (JROF, JLEV)-PLNPRM_DER (JROF, JLEV&
      &)*PRT (JROF, JLEV))*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
    
    ENDDO

  ENDIF

  ZINL (JROF, 0)=0.0_JPRB
  ZINL (JROF, KFLEV+1)=0.0_JPRB
  ZINM (JROF, 0)=0.0_JPRB
  ZINM (JROF, KFLEV+1)=0.0_JPRB
  CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER, CLOPER&
  &,'11', KPROMA, KST, KEND, KFLEV, ZINL, PHIFL, PINS=POROGL, YDSTACK=YLSTACK)
  CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER, CLOPER&
  &,'11', KPROMA, KST, KEND, KFLEV, ZINM, PHIFM, PINS=POROGM, YDSTACK=YLSTACK)
ELSE

  IF (LLNHEE) THEN

    DO JLEV=1, KFLEV
      
      PHIFL (JROF, JLEV)=PHIHL (JROF, JLEV)+PALPH (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*(PRTL (JROF, JLEV&
      &)+ZNH1L (JROF, JLEV))+PALPHL_DER (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*PRT (JROF, JLEV)
      PHIFM (JROF, JLEV)=PHIHM (JROF, JLEV)+PALPH (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*(PRTM (JROF, JLEV&
      &)+ZNH1M (JROF, JLEV))+PALPHM_DER (JROF, JLEV)*ZRNHPPI (JROF, JLEV)*PRT (JROF, JLEV)
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      PHIFL (JROF, JLEV)=PHIHL (JROF, JLEV)+PALPH (JROF, JLEV)*PRTL&
      & (JROF, JLEV)+PALPHL_DER (JROF, JLEV)*PRT (JROF, JLEV)
      PHIFM (JROF, JLEV)=PHIHM (JROF, JLEV)+PALPH (JROF, JLEV)*PRTM&
      & (JROF, JLEV)+PALPHM_DER (JROF, JLEV)*PRT (JROF, JLEV)
    
    ENDDO

  ENDIF

ENDIF


END SUBROUTINE GPGRGEO_EXPL_OPENACC
