SUBROUTINE CPPHINP_OPENACC (YDGEOMETRY, YDMODEL, KLON, KLEV, KIDIA, KFDIA, PGEMU,&
& PGELAM, PUT0, PVT0, PTT0L, PTT0M, PQT0, PQT0L, PQT0M, PQSLT0L, PQSLT0M, PRDELP0&
&, PEVEL0, PCVGQSL, PMU0, PSOLO, PMU0LU, PMU0M, PMU0N, PCVGQ, PCVGT, YDSTACK)
!$ACC ROUTINE (CPPHINP_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE TYPE_MODEL,ONLY:MODEL
USE GEOMETRY_MOD,ONLY:GEOMETRY
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (MODEL), INTENT (IN)::YDMODEL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PGEMU (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGELAM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PUT0 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVT0 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQT0 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQT0L (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQT0M (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTT0L (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTT0M (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSLT0L (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSLT0M (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PRDELP0 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PEVEL0 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCVGQSL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMU0 (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PSOLO (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PMU0LU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PMU0M (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PMU0N (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCVGQ (YDGEOMETRY%YRDIM%NPROMM, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCVGT (YDGEOMETRY%YRDIM%NPROMM, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK

INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZED
REAL (KIND=JPRB)::ZUSTSPHY
REAL (KIND=JPRB)::ZABSTSPHY
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::Z2MU0M 
REAL (KIND=JPRB)::Z1MU0M 
REAL (KIND=JPRB)::ZSIN 
REAL (KIND=JPRB)::ZCOS 
LOGICAL::LLCOMPUTE_CVGQ

#include "smpos_parall_openacc.intfb.h"

YLSTACK = YDSTACK



JLON = KIDIA





ZCOS =COS (PGELAM (JLON))


ZSIN =SIN (PGELAM (JLON))


PMU0 (JLON)=MIN (1.0_JPRB, MAX (YDMODEL%YRML_GCONF%YRRIP%RSIDEC*PGEMU (JLON)-YDMODEL%YRML_GCONF%YRRIP&
&%RCODEC*YDMODEL%YRML_GCONF%YRRIP%RCOVSR*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZCOS +YDMODEL%YRML_GCONF%YRRIP&
&%RCODEC*YDMODEL%YRML_GCONF%YRRIP%RSIVSR*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZSIN , 0.0_JPRB))


IF (YDMODEL%YRML_PHY_MF%YRARPHY%LMSE) THEN
  
  PMU0N (JLON)=MIN (1.0_JPRB, MAX (YDMODEL%YRML_GCONF%YRRIP%RSIDECN*PGEMU (JLON)-YDMODEL%YRML_GCONF%YRRIP&
  &%RCODECN*YDMODEL%YRML_GCONF%YRRIP%RCOVSRN*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZCOS +YDMODEL%YRML_GCONF%YRRIP&
  &%RCODECN*YDMODEL%YRML_GCONF%YRRIP%RSIVSRN*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZSIN , 0.0_JPRB))
  
ELSE
  
  PMU0N (JLON)=0.0
  
ENDIF


IF (YDMODEL%YRML_PHY_MF%YRPHY%LRAYLU) THEN
  
  PMU0LU (JLON)=MAX (YDMODEL%YRML_GCONF%YRRIP%RSIDECLU*PGEMU (JLON)-YDMODEL%YRML_GCONF%YRRIP%RCODECLU&
  &*YDMODEL%YRML_GCONF%YRRIP%RCOVSRLU*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZCOS +YDMODEL%YRML_GCONF%YRRIP&
  &%RCODECLU*YDMODEL%YRML_GCONF%YRRIP%RSIVSRLU*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZSIN , 0.0_JPRB)
  
ENDIF


IF (YDMODEL%YRML_PHY_MF%YRPHY%NSOLE<=0) THEN
  PSOLO (JLON)=0._JPRB
ELSE
  CALL SMPOS_PARALL_OPENACC (YDGEOMETRY, YDMODEL, KIDIA, KFDIA, PGEMU, PGELAM, PSOLO, YDSTACK=YLSTACK)
ENDIF


IF (YDMODEL%YRML_PHY_EC%YREPHY%LEPHYS.OR.(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.AND.YDMODEL&
  &%YRML_PHY_MF%YRPHY%LRAYFM.AND.(.NOT.YDMODEL%YRML_PHY_MF%YRPHY%LRMU0M))) THEN
  
  PMU0M (JLON)=MAX (YDMODEL%YRML_PHY_RAD%YRERIP%RSIDECM*PGEMU (JLON)-YDMODEL%YRML_PHY_RAD%YRERIP%RCODECM&
  &*YDMODEL%YRML_PHY_RAD%YRERIP%RCOVSRM*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZCOS +YDMODEL%YRML_PHY_RAD%YRERIP&
  &%RCODECM*YDMODEL%YRML_PHY_RAD%YRERIP%RSIVSRM*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZSIN , 0.0_JPRB)

  

  IF (YDMODEL%YRML_PHY_RAD%YRERAD%NRADFR==1) THEN
    
    PMU0M (JLON)=PMU0 (JLON)
  
  ENDIF

ELSEIF (YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.AND.YDMODEL%YRML_PHY_MF&
  &%YRPHY%LRAYFM.AND.YDMODEL%YRML_PHY_MF%YRPHY%LRMU0M) THEN
  
  Z1MU0M =MAX (YDMODEL%YRML_PHY_RAD%YRERIP%RSIDECM*PGEMU (JLON)-YDMODEL%YRML_PHY_RAD%YRERIP%RCODECM*YDMODEL&
  &%YRML_PHY_RAD%YRERIP%RCOVSRM*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZCOS +YDMODEL%YRML_PHY_RAD%YRERIP%RCODECM&
  &*YDMODEL%YRML_PHY_RAD%YRERIP%RSIVSRM*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZSIN , 0.0_JPRB)
  Z2MU0M =0.5_JPRB*(MAX (YDMODEL%YRML_GCONF%YRRIP%RSIDECF*PGEMU (JLON)-YDMODEL%YRML_GCONF%YRRIP%RCODECF*YDMODEL&
  &%YRML_GCONF%YRRIP%RCOVSRF*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZCOS +YDMODEL%YRML_GCONF%YRRIP%RCODECF*YDMODEL&
  &%YRML_GCONF%YRRIP%RSIVSRF*SQRT (1.0_JPRB-PGEMU (JLON)**2)*ZSIN , 0.0_JPRB)+PMU0 (JLON))
  PMU0M (JLON)=MAX (Z1MU0M , Z2MU0M )
  
ELSEIF (YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.AND.YDMODEL%YRML_PHY_MF%YRPHY%LRAYFM15) THEN
  CALL FXTRAN_ACDC_ABORT ('RADIATION SCHEME FROM CYCLE 15 NO LONGER AVAILABLE')
ELSE
  
  PMU0M (JLON)=0.0_JPRB
  
ENDIF

LLCOMPUTE_CVGQ=(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL%YRML_PHY_MF&
&%YRSIMPHL%LSIMPH).AND.(.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMPA)

IF (LLCOMPUTE_CVGQ) THEN

  DO JLEV=1, KLEV
    
    PCVGT (JLON, JLEV)=-PTT0L (JLON, JLEV)*PUT0 (JLON, JLEV)-PTT0M (JLON, JLEV)*PVT0 (JLON, JLEV)
  
  ENDDO


  IF ((YDMODEL%YRML_DYN%YRDYN%NCOMP_CVGQ==0).OR.(YDMODEL%YRML_DYN%YRDYN%NCOMP_CVGQ==1)) THEN

    IF (YDMODEL%YRML_DYN%YRDYN%NCOMP_CVGQ==0) THEN

      DO JLEV=1, KLEV
        
        PCVGQ (JLON, JLEV)=-PQT0L (JLON, JLEV)*PUT0 (JLON, JLEV)-PQT0M (JLON, JLEV)*PVT0 (JLON, JLEV)
      
      ENDDO

    ELSE

      DO JLEV=1, KLEV
        
        PCVGQ (JLON, JLEV)=-PQSLT0L (JLON, JLEV)*PUT0 (JLON, JLEV)-PQSLT0M (JLON, JLEV)*PVT0 (JLON, JLEV)
      
      ENDDO

    ENDIF


    IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE) THEN
      
      PCVGQ (JLON, 1)=PCVGQ (JLON, 1)+(PQT0 (JLON, 1)-PQT0 (JLON, 2))*PEVEL0 (JLON, 1)*PRDELP0 (JLON, 1)

      

      DO JLEV=2, KLEV-1
        
        ZED=0.5_JPRB*PEVEL0 (JLON, JLEV)
        PCVGQ (JLON, JLEV)=PCVGQ (JLON, JLEV)+(PQT0 (JLON, JLEV&
        &-1)-PQT0 (JLON, JLEV+1))*ZED*PRDELP0 (JLON, JLEV)
      
      ENDDO

      
      PCVGQ (JLON, KLEV)=PCVGQ (JLON, KLEV)+(PQT0 (JLON, KLEV-1)-PQT0&
      & (JLON, KLEV))*PEVEL0 (JLON, KLEV)*PRDELP0 (JLON, KLEV)
    
    ELSE

      DO JLEV=1, KLEV-1
        
        ZED=0.5_JPRB*PEVEL0 (JLON, JLEV)
        PCVGQ (JLON, JLEV)=PCVGQ (JLON, JLEV)+(PQT0 (JLON, JLEV&
        &)-PQT0 (JLON, JLEV+1))*ZED*PRDELP0 (JLON, JLEV)
        PCVGQ (JLON, JLEV+1)=PCVGQ (JLON, JLEV+1)+(PQT0 (JLON, JLEV&
        &)-PQT0 (JLON, JLEV+1))*ZED*PRDELP0 (JLON, JLEV+1)
      
      ENDDO

    ENDIF

  ELSE
    ZEPS=1.E-12
    ZABSTSPHY=MAX (ZEPS, ABS (YDMODEL%YRML_PHY_MF%YRPHY2%TSPHY))

    IF (YDMODEL%YRML_PHY_MF%YRPHY2%TSPHY>=0) THEN
      ZUSTSPHY=1.0_JPRB/ZABSTSPHY
    ELSE
      ZUSTSPHY=-1.0_JPRB/ZABSTSPHY
    ENDIF


    DO JLEV=1, KLEV
      
      PCVGQ (JLON, JLEV)=PCVGQSL (JLON, JLEV)*ZUSTSPHY
    
    ENDDO

  ENDIF

ENDIF




END SUBROUTINE CPPHINP_OPENACC
