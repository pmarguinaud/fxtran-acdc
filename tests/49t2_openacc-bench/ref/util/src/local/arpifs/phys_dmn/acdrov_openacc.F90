
SUBROUTINE ACDROV_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KLEV, KCSS, PFPLCL, PFPLCN, PFPLSL&
&, PFPLSN, PFRSO, PFRTH, PC1, PC2, PC3, PCN, PCT, PD2, PFEVV, PFTR, PLAI, PNEIJ, PVEG, PWFC, PWPMX&
&, PWL, PWLMX, PWSEQ, PWSMX, PFCHSP, PFCLL, PFCLN, PFCS, PFEVI, PFEVL, PFEVN, PLSM, PSNS, PTP, PTS&
&, PWP, PWPI, PWS, PWSI, PFGEL, PFGELS, PFLWSP, PFONTE, PRUISP, PRUISL, PRUISS, YDSTACK)
!$ACC ROUTINE (ACDROV_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KCSS
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PFPLCL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLCN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLSL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLSN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFRSO (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFRTH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PC1 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PC2 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PC3 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCN (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCT (KLON)
REAL (KIND=JPRB), INTENT (IN)::PD2 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFEVV (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFTR (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLAI (KLON)
REAL (KIND=JPRB), INTENT (IN)::PNEIJ (KLON)
REAL (KIND=JPRB), INTENT (IN)::PVEG (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWFC (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWPMX (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWL (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWLMX (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWSEQ (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWSMX (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFCHSP (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFCLL (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFCLN (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFCS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFEVI (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFEVL (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFEVN (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLSM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PSNS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTP (KLON, KCSS)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWP (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWPI (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWSI (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PFGEL (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PFGELS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFLWSP (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PFONTE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRUISP (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRUISL (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRUISS (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZITS 
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::ZZK
REAL (KIND=JPRB)::ZZ
REAL (KIND=JPRB)::ZWSP
REAL (KIND=JPRB)::ZWSMX
REAL (KIND=JPRB)::ZWPP
REAL (KIND=JPRB)::ZWPMX
REAL (KIND=JPRB)::ZWPIMX
REAL (KIND=JPRB)::ZWPID
REAL (KIND=JPRB)::ZWFC
REAL (KIND=JPRB)::ZVEG
REAL (KIND=JPRB)::ZTSP
REAL (KIND=JPRB)::ZTPP
REAL (KIND=JPRB)::ZTF
REAL (KIND=JPRB)::ZSNSP
REAL (KIND=JPRB)::ZPCTDT
REAL (KIND=JPRB)::ZPCNDT
REAL (KIND=JPRB)::ZNEIJC
REAL (KIND=JPRB)::ZITSP
REAL (KIND=JPRB)::ZIDAY
REAL (KIND=JPRB)::ZFONTES
REAL (KIND=JPRB)::ZFONTE
REAL (KIND=JPRB)::ZFLDT
REAL (KIND=JPRB)::ZFGELS
REAL (KIND=JPRB)::ZFGEL
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZCONV
REAL (KIND=JPRB)::ZCI
REAL (KIND=JPRB)::ZBFLO


JLON = KIDIA



ZITSP=1.0_JPRB/YDML_PHY_MF%YRPHY2%TSPHY
ZIDAY=1.0_JPRB/YDCST%RDAY
ZEPS1=1.E-08_JPRB
ZCONV=1.E+3_JPRB

ZITS =PLSM (JLON)*ZIDAY


ZVEG=PVEG (JLON)/(1.0_JPRB+YDML_PHY_MF%YRPHY0%USUPRC*PFPLCL (JLON, KLEV))
ZFLDT=YDML_PHY_MF%YRPHY2%TSPHY*(ZVEG*(PFPLSL (JLON, KLEV&
&)+PFPLCL (JLON, KLEV))+PFEVV (JLON)-PFTR (JLON))
PRUISL (JLON)=ZITSP*PLSM (JLON)*(ZFLDT-MIN (PWLMX (JLON)-PWL (JLON), MAX (-PWL (JLON), ZFLDT)))
ZBFLO=(1.0_JPRB-ZVEG)*(PFPLSL (JLON, KLEV)+PFPLCL (JLON&
&, KLEV))+PRUISL (JLON)+PFEVL (JLON)-PFEVV (JLON)

IF (YDML_PHY_MF%YRPHY%LNEIGE) THEN
  ZPCTDT=PCT (JLON)*YDML_PHY_MF%YRPHY2%TSPHY*PLSM (JLON)
  ZTSP=PTS (JLON)+ZPCTDT*(PFRSO (JLON, KLEV)+PFRTH (JLON, KLEV&
  &)+PFCS (JLON)+PFCLL (JLON)+PFCLN (JLON)-PFCHSP (JLON))
  ZSNSP=PSNS (JLON)*ZITSP+(PFPLSN (JLON, KLEV)+PFPLCN (JLON, KLEV)+PFEVN (JLON)-PFEVI (JLON))

  IF (YDML_PHY_MF%YRPHY%LSNV) THEN
    ZTF=(1.0_JPRB-PVEG (JLON))*ZTSP+PVEG (JLON)*PTP (JLON, 1)
    PFONTE (JLON)=MAX (0.0_JPRB,(ZTF-(PLSM (JLON)*YDCST%RTT+(1.0_JPRB-PLSM (JLON&
    &))*YDML_PHY_MF%YRPHY1%TMERGL))/(MAX (ZEPS1, ZPCTDT)*YDCST%RLMLT))
    ZNEIJC=MAX (0.0_JPRB, MIN (1.0_JPRB, PSNS (JLON)/YDML_PHY_MF%YRPHY1%WCRINC))
    ZPCNDT=PCN (JLON)*YDML_PHY_MF%YRPHY2%TSPHY*PLSM (JLON)
    PFONTE (JLON)=ZNEIJC/MAX (ZEPS1, ZPCNDT)*MAX (ZEPS1, ZPCTDT)*PFONTE (JLON)
    PFONTE (JLON)=PLSM (JLON)*MIN (ZSNSP, PFONTE (JLON))
  ELSE
    PFONTE (JLON)=PLSM (JLON)*MIN (ZSNSP, MAX (0.0_JPRB,(ZTSP-(PLSM (JLON)*YDCST%RTT+(1.0_JPRB&
    &-PLSM (JLON))*YDML_PHY_MF%YRPHY1%TMERGL))/(MAX (ZEPS1, ZPCTDT)*YDCST%RLMLT)))
  ENDIF

  ZTSP=ZTSP-ZPCTDT*YDCST%RLMLT*PFONTE (JLON)

  IF (YDML_PHY_MF%YRPHY%LFGEL) THEN
    ZZK=PLSM (JLON)*YDML_PHY_MF%YRPHY1%GCGELS*MAX (0.0_JPRB, 1.0_JPRB-PVEG (JLON)/YDML_PHY_MF&
    &%YRPHY1%GVEGMXS)*MAX (0.0_JPRB, 1.0_JPRB-PLAI (JLON)/YDML_PHY_MF%YRPHY1%GLAIMXS&
    &)*MAX (0.0_JPRB, 1.0_JPRB-PNEIJ (JLON)/YDML_PHY_MF%YRPHY1%GNEIMXS)
    ZZ=ZZK*(YDCST%RTT-ZTSP)/(YDML_PHY_MF%YRPHY1%RCTGLA*YDCST%RLMLT)
    ZWSP=MAX (0.0_JPRB, PWS (JLON))
    ZFGELS=ZWSP/PWSMX (JLON)*MAX (0.0_JPRB, ZZ)
    ZFGELS=MAX (0.0_JPRB, MIN (ZFGELS, ZWSP*ZITSP))
    ZFONTES=MIN (0.0_JPRB, ZZ)
    ZFONTES=-MAX (0.0_JPRB, MIN (-ZFONTES, PWSI (JLON)*ZITSP))
    PFGELS (JLON)=ZFGELS+ZFONTES
    ZZK=PLSM (JLON)*YDML_PHY_MF%YRPHY1%GCGEL*MAX (0.0_JPRB, 1.0_JPRB-PVEG (JLON)/YDML_PHY_MF&
    &%YRPHY1%GVEGMX)*MAX (0.0_JPRB, 1.0_JPRB-PLAI (JLON)/YDML_PHY_MF%YRPHY1%GLAIMX&
    &)*MAX (0.0_JPRB, 1.0_JPRB-PNEIJ (JLON)/YDML_PHY_MF%YRPHY1%GNEIMX)
    ZTPP=PTP (JLON, 1)+ZPCTDT*(YDML_PHY_MF%YRPHY1%SODELX(0)/YDML_PHY_MF%YRPHY1%SODELX(1))*PFCHSP (JLON)
    ZZ=ZZK*(YDCST%RTT-ZTPP)/(YDML_PHY_MF%YRPHY1%RCTGLA*YDCST%RLMLT)
    ZWPP=MAX (0.0_JPRB, PWP (JLON)-PWS (JLON)-PWSI (JLON))
    ZFGEL=ZWPP/PWPMX (JLON)*MAX (0.0_JPRB, ZZ)
    ZFGEL=MAX (0.0_JPRB, MIN (ZFGEL, ZWPP*ZITSP))
    ZWPIMX=MIN (YDML_PHY_MF%YRPHY1%GWPIMX, PWPMX (JLON))
    ZWPID=MAX (0.0_JPRB, PWPI (JLON)-PWSI (JLON))
    ZFGEL=MAX (0.0_JPRB, MIN ((ZWPIMX-ZWPID)*ZITSP, ZFGEL))
    ZFONTE=MIN (0.0_JPRB, ZZ)
    ZFONTE=-MAX (0.0_JPRB, MIN (-ZFONTE, ZWPID*ZITSP))
    PFGEL (JLON)=ZFGEL+ZFONTE
  ELSE
    PFGEL (JLON)=0.0_JPRB
    PFGELS (JLON)=0.0_JPRB
  ENDIF

ELSE
  PFONTE (JLON)=0.0_JPRB
  PFGEL (JLON)=0.0_JPRB
  PFGELS (JLON)=0.0_JPRB
ENDIF

PFLWSP (JLON)=PC2 (JLON)*ZITS *(PWS (JLON)-PWSEQ (JLON))
ZBFLO=ZBFLO+PFONTE (JLON)
ZCI=PC2 (JLON)*YDML_PHY_MF%YRPHY2%TSPHY*ZITS 

IF (YDML_PHY_MF%YRPHY%LFGEL) THEN
  PFLWSP (JLON)=PC2 (JLON)*ZITS *(PWS (JLON)-MAX (0.0_JPRB, PWSEQ (JLON)-PWSI (JLON)))
  ZWSMX=PWSMX (JLON)-PWSI (JLON)
  PFLWSP (JLON)=MAX (-ZITSP*PWP (JLON), PFLWSP (JLON))
ELSE
  ZWSMX=PWSMX (JLON)
ENDIF

ZFLDT=YDML_PHY_MF%YRPHY2%TSPHY*((PC1 (JLON)*ZBFLO-PFLWSP (JLON))/(1.0_JPRB+ZCI)-PFGELS (JLON))
PRUISS (JLON)=ZITSP*PLSM (JLON)*(ZFLDT-MIN (ZWSMX-PWS (JLON), MAX (-PWS (JLON), ZFLDT)))
ZFLDT=YDML_PHY_MF%YRPHY2%TSPHY*(ZBFLO+PFTR (JLON)-PFGEL (JLON))

IF (YDML_PHY_MF%YRPHY%LFGEL) THEN
  ZWPMX=MAX (0.0_JPRB, PWPMX (JLON)-PWPI (JLON))
  ZWFC=MAX (0.0_JPRB, PWFC (JLON)*PD2 (JLON)*ZCONV-PWPI (JLON))
ELSE
  ZWPMX=PWPMX (JLON)
  ZWFC=PWFC (JLON)*PD2 (JLON)*ZCONV
ENDIF

PRUISP (JLON)=ZITSP*PLSM (JLON)*(ZFLDT-MIN (ZWPMX-PWP (JLON), MAX (-PWP&
& (JLON), ZFLDT)))+PC3 (JLON)*ZITS *MAX (0.0_JPRB, PWP (JLON)-ZWFC)



END SUBROUTINE ACDROV_OPENACC
