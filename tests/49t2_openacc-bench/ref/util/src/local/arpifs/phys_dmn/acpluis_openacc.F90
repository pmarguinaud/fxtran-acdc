
SUBROUTINE ACPLUIS_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA&
&, KLEV, PAPRSF, PDELP, PNEBS, PQ, PQLIS, PQW, PR, PT, PFCSQL, PFCSQN&
&, PFPLSL, PFPLSN, PFPEVPL, PFPEVPN, PFPFPL, PFPFPN, YDSTACK)
!$ACC ROUTINE (ACPLUIS_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEBS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLIS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQW (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFPEVPL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFPEVPN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFPFPL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFPFPN (KLON, 0:KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (OUT)::PFPLSL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFPLSN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFCSQL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFCSQN (KLON, 0:KLEV)
REAL (KIND=JPRB)::ZRME 
REAL (KIND=JPRB)::ZPLH 
REAL (KIND=JPRB)::ZNEIGE 
fxtran_acdc_temp (REAL (KIND=JPRB), ZFONTE, (KLON, KLEV))
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZIWTNEBGY
REAL (KIND=JPRB)::ZINEBGY
REAL (KIND=JPRB)::ZZC
REAL (KIND=JPRB)::ZZB
REAL (KIND=JPRB)::ZZA
REAL (KIND=JPRB)::ZTVF
REAL (KIND=JPRB)::ZTENDT
REAL (KIND=JPRB)::ZTENDNU
REAL (KIND=JPRB)::ZTENDL
REAL (KIND=JPRB)::ZTENDI
REAL (KIND=JPRB)::ZTENDCL
REAL (KIND=JPRB)::ZRPTH
REAL (KIND=JPRB)::ZRPTB
REAL (KIND=JPRB)::ZQLI
REAL (KIND=JPRB)::ZQLL
REAL (KIND=JPRB)::ZQL
REAL (KIND=JPRB)::ZPLS
REAL (KIND=JPRB)::ZPLC
REAL (KIND=JPRB)::ZPLBS
REAL (KIND=JPRB)::ZPLBK
REAL (KIND=JPRB)::ZPLB
REAL (KIND=JPRB)::ZNUTEND
REAL (KIND=JPRB)::ZNEBS
REAL (KIND=JPRB)::ZINDQ
REAL (KIND=JPRB)::ZIFSAT
REAL (KIND=JPRB)::ZIFNSAT
REAL (KIND=JPRB)::ZHE
REAL (KIND=JPRB)::ZH
REAL (KIND=JPRB)::ZGENN
REAL (KIND=JPRB)::ZGENE
REAL (KIND=JPRB)::ZFONT
REAL (KIND=JPRB)::ZFONS
REAL (KIND=JPRB)::ZFON
REAL (KIND=JPRB)::ZEVA
REAL (KIND=JPRB)::ZEPS2
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDELTAQ
REAL (KIND=JPRB)::ZCLTEND

#include "fctdoi.func.h"

YLSTACK = YDSTACK



IF (KIND (ZFONTE) == 8) THEN
    fxtran_acdc_alloc8 (ZFONTE)
ELSEIF (KIND (ZFONTE) == 4) THEN
    fxtran_acdc_alloc4 (ZFONTE)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPS=1.E-5_JPRB
ZEPS1=1.E-10_JPRB
ZEPS2=1.E-5_JPRB

IF (YDML_PHY_MF%YRPHY%LNEBGY) THEN
  ZINEBGY=1.0_JPRB
ELSE
  ZINEBGY=0.0_JPRB
ENDIF


IF (YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY%LNEBGY) THEN
  ZIWTNEBGY=1.0_JPRB
ELSE
  ZIWTNEBGY=0.0_JPRB
ENDIF


DO JLEV=KTDIA, KLEV

  

  IF (JLEV==KTDIA) THEN
    ZPLH =0.0_JPRB
    ZNEIGE =0.0_JPRB
    ZRME =0.0_JPRB
  ENDIF


  IF (YDML_PHY_MF%YRPHY%LNEIGE) THEN
    ZH=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PT (JLON, JLEV)))
  ELSE
    ZH=0.0_JPRB
  ENDIF

  ZNEBS=MAX (0.0_JPRB, SIGN (1.0_JPRB, 1.0_JPRB-PNEBS (JLON, JLEV)-ZEPS))
  ZIFNSAT=ZNEBS*(1.0_JPRB-PNEBS (JLON, JLEV))+(1.0_JPRB-ZNEBS)*ZEPS
  ZIFNSAT=1.0_JPRB/ZIFNSAT
  ZDELTAQ=PQW (JLON, JLEV)-PQ (JLON, JLEV)
  ZEVA=YDML_PHY_MF%YRPHY0%EVAP*(1.0_JPRB-ZRME *(1.0_JPRB-YDML_PHY_MF%YRPHY0%REVGSL))
  ZPLC=SQRT (ZPLH )-ZEVA*MAX (ZDELTAQ, 0.0_JPRB)*PDELP (JLON, JLEV)/PAPRSF (JLON, JLEV)**2
  ZPLC=MAX (ZPLC, 0.0_JPRB)
  ZPLC=ZPLC**2
  ZCLTEND=(ZPLC-ZPLH )*YDCST%RG/PDELP (JLON, JLEV)
  ZTENDCL=ZCLTEND*(1.0_JPRB-PNEBS (JLON, JLEV))
  ZTENDCL=-MIN (ABS (ZDELTAQ/YDML_PHY_MF%YRPHY2%TSPHY),-ZTENDCL)
  PFPEVPL (JLON, JLEV)=ZTENDCL*PDELP (JLON, JLEV)/YDCST%RG
  PFPEVPN (JLON, JLEV)=ZIWTNEBGY*(PFPEVPN (JLON, JLEV-1)+ZH*PFPEVPL (JLON, JLEV))
  PFPEVPL (JLON, JLEV)=ZIWTNEBGY*(PFPEVPL (JLON, JLEV-1)+(1.0_JPRB-ZH)*PFPEVPL (JLON, JLEV))
  ZCLTEND=ZTENDCL*ZIFNSAT
  ZPLC=MAX (0.0_JPRB, ZCLTEND*PDELP (JLON, JLEV)/YDCST%RG+ZPLH )
  ZIFSAT=1.0_JPRB/PNEBS (JLON, JLEV)
  ZNEBS=MAX (0.0_JPRB, SIGN (1.0_JPRB, PNEBS (JLON, JLEV)-ZEPS))
  ZQL=ZNEBS*PQLIS (JLON, JLEV)*ZIFSAT
  ZQLL=ZQL*(1.0_JPRB-ZH)
  ZZA=YDML_PHY_MF%YRPHY0%TCT*MAX (0.0_JPRB, 1.0_JPRB-EXP (-ZQLL*&
  &*2/YDML_PHY_MF%YRPHY0%TCW**2))+YDML_PHY_MF%YRPHY0%TCA*ZPLH 
  ZTENDL=ZZA*ZQLL/(1.0_JPRB+YDML_PHY_MF%YRPHY2%TSPHY*ZZA)

  IF (YDML_PHY_MF%YRPHY%LNEIGE) THEN
    ZQLI=ZQL*ZH
    ZTVF=YDML_PHY_MF%YRPHY0%TVF*(ZINEBGY*(ZQLI*1000._JPRB)**0.2_JPRB+(1.0_JPRB-ZINEBGY))
    ZZB=YDCST%RG/PDELP (JLON, JLEV)*ZPLH 
    ZZC=YDCST%RG/PDELP (JLON, JLEV)*PAPRSF (JLON, JLEV)*ZTVF/PR (JLON, JLEV)/PT (JLON, JLEV)
    ZTENDI=-MIN (0.0_JPRB, ZZB-ZZC*ZQLI)/(1.0_JPRB+YDML_PHY_MF%YRPHY2%TSPHY*ZZC)
  ELSE
    ZTENDI=0.0_JPRB
  ENDIF

  ZNUTEND=ZTENDI+ZTENDL
  ZTENDNU=ZNUTEND*PNEBS (JLON, JLEV)
  ZTENDNU=ZINEBGY*ZTENDNU+(1.0_JPRB-ZINEBGY)*MAX (0.0_JPRB, MIN (ZTENDNU&
  &, PQ (JLON, JLEV)/(2.0_JPRB*YDML_PHY_MF%YRPHY2%TSPHY)))
  ZNUTEND=ZTENDNU*ZIFSAT
  ZPLS=ZNUTEND*PDELP (JLON, JLEV)/YDCST%RG+ZPLH 
  ZPLBS=PNEBS (JLON, JLEV)*ZPLS+(1.0_JPRB-PNEBS (JLON, JLEV))*ZPLC
  ZDELTAQ=PQW (JLON, JLEV)-PQ (JLON, JLEV)
  ZPLBK=MAX (0.0_JPRB, ZPLH -ZDELTAQ*PDELP (JLON, JLEV)/(YDCST%RG*YDML_PHY_MF%YRPHY2%TSPHY))
  ZRPTH=SQRT (MAX (ZPLH , ZPLBK))
  ZRPTB=MAX (0.0_JPRB, ZRPTH-ZEVA*MAX (0.0_JPRB, ZDELTAQ)*PDELP (JLON, JLEV)/PAPRSF (JLON, JLEV)**2)
  ZPLBK=MAX (ZPLBK, ZRPTB**2)
  ZINDQ=MAX (0.0_JPRB, SIGN (1.0_JPRB, PQ (JLON, JLEV)-YDML_PHY_MF%YRPHY0%QSMIN))
  ZPLB=ZPLBS

  IF (YDML_PHY_MF%YRPHY%LNEIGE) THEN
    ZGENN=(ZNEIGE *ZPLH +ZH*ZTENDNU*PDELP (JLON, JLEV)/YDCST%RG)&
    &/MAX (ZEPS1,(ZPLH +ZTENDNU*PDELP (JLON, JLEV)/YDCST%RG))
    ZHE=FONICE (PT (JLON, JLEV), YDML_PHY_MF%YRPHY0%RDTFAC)
    ZGENE=(ZRME *ZPLH +ZHE*ZTENDNU*PDELP (JLON, JLEV)/YDCST%RG)&
    &/MAX (ZEPS1,(ZPLH +ZTENDNU*PDELP (JLON, JLEV)/YDCST%RG))
    ZFONT=YDML_PHY_MF%YRPHY0%FONT*(1.0_JPRB-ZRME *(1.0_JPRB-YDML_PHY_MF%YRPHY0%REVGSL))
    ZFON=-2.0_JPRB*ZFONT*(PT (JLON, JLEV)-YDCST%RTT)*PDELP (JLON, JLEV&
    &)/PAPRSF (JLON, JLEV)**2/MAX (ZEPS2, SQRT (ZPLB)+SQRT (ZPLH ))
    ZFONS=MAX (0.0_JPRB, MIN (1.0_JPRB, PNEBS (JLON, JLEV)*ZGENN+(1.0_JPRB-PNEBS (JLON, JLEV))*ZNEIGE ))
    ZNEIGE =MAX (0.0_JPRB, MIN (1.0_JPRB, PNEBS (JLON, JLEV&
    &)*ZGENN+(1.0_JPRB-PNEBS (JLON, JLEV))*ZNEIGE +ZFON))
    ZFONS=ZNEIGE -ZFONS
    ZRME =MAX (0.0_JPRB, MIN (1.0_JPRB, PNEBS (JLON, JLEV&
    &)*ZGENE+(1.0_JPRB-PNEBS (JLON, JLEV))*ZRME +ZFON))
  ELSE
    ZNEIGE =0.0_JPRB
    ZRME =0.0_JPRB
    ZFONS=0.0_JPRB
  ENDIF

  ZTENDT=ZTENDNU+ZTENDCL
  ZPLH =MAX (0.0_JPRB, ZPLH +ZTENDT*PDELP (JLON, JLEV)/YDCST%RG)
  PFPLSL (JLON, JLEV)=(1.0_JPRB-ZNEIGE )*ZPLH 
  PFPLSN (JLON, JLEV)=ZNEIGE *ZPLH 
  PFPFPL (JLON, JLEV)=PFPLSL (JLON, JLEV)-PFPEVPL (JLON, JLEV)
  PFPFPN (JLON, JLEV)=PFPLSN (JLON, JLEV)-PFPEVPN (JLON, JLEV)
  PFCSQL (JLON, JLEV)=PFPLSL (JLON, JLEV)
  PFCSQN (JLON, JLEV)=PFPLSN (JLON, JLEV)
  ZFONTE (JLON, JLEV)=ZIWTNEBGY*ZFONS*ZPLH 
  
ENDDO


DO JLEV=KTDIA, KLEV
  
  PFPEVPL (JLON, JLEV)=-(PFPEVPL (JLON, JLEV)-ZFONTE (JLON, JLEV))
  PFPEVPN (JLON, JLEV)=-(PFPEVPN (JLON, JLEV)+ZFONTE (JLON, JLEV))
  
ENDDO



END SUBROUTINE ACPLUIS_OPENACC
