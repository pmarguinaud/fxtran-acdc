
MODULE MODE_TRIDIAG_MASSFLUX_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE TRIDIAG_MASSFLUX_OPENACC (D, PVARM, PF, PDFDT&
&, PTSTEP, PIMPL, PDZZ, PRHODJ, PVARP, YDSTACK)
!$ACC ROUTINE (TRIDIAG_MASSFLUX_OPENACC) SEQ

USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODI_SHUMAN_MF,ONLY:MZM_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZM_MF_OPENACC
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
REAL, INTENT (IN)::PVARM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDFDT(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTSTEP
REAL, INTENT (IN)::PIMPL
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PVARP(D%NIJT, D%NKT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL, ZRHODJ_DFDT_O_DZ, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZMZM_RHODJ, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZC, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZB, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZA, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZGAM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZY, (D%NIJT, D%NKT))
REAL::ZBET
INTEGER::JI
INTEGER::JK
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKTE
INTEGER::IKTB
INTEGER::IKE
INTEGER::IKU
INTEGER::IKA
INTEGER::IKB
INTEGER::IKT
INTEGER::IKL


YLSTACK = YDSTACK



IF (KIND (ZRHODJ_DFDT_O_DZ) == 8) THEN
    fxtran_acdc_alloc8 (ZRHODJ_DFDT_O_DZ)
ELSEIF (KIND (ZRHODJ_DFDT_O_DZ) == 4) THEN
    fxtran_acdc_alloc4 (ZRHODJ_DFDT_O_DZ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMZM_RHODJ) == 8) THEN
    fxtran_acdc_alloc8 (ZMZM_RHODJ)
ELSEIF (KIND (ZMZM_RHODJ) == 4) THEN
    fxtran_acdc_alloc4 (ZMZM_RHODJ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZC) == 8) THEN
    fxtran_acdc_alloc8 (ZC)
ELSEIF (KIND (ZC) == 4) THEN
    fxtran_acdc_alloc4 (ZC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB) == 8) THEN
    fxtran_acdc_alloc8 (ZB)
ELSEIF (KIND (ZB) == 4) THEN
    fxtran_acdc_alloc4 (ZB)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA) == 8) THEN
    fxtran_acdc_alloc8 (ZA)
ELSEIF (KIND (ZA) == 4) THEN
    fxtran_acdc_alloc4 (ZA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGAM) == 8) THEN
    fxtran_acdc_alloc8 (ZGAM)
ELSEIF (KIND (ZGAM) == 4) THEN
    fxtran_acdc_alloc4 (ZGAM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZY) == 8) THEN
    fxtran_acdc_alloc8 (ZY)
ELSEIF (KIND (ZY) == 4) THEN
    fxtran_acdc_alloc4 (ZY)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKL=D%NKL
IKA=D%NKA
IKU=D%NKU
IKE=D%NKE
IKTB=D%NKTB
IKTE=D%NKTE
CALL MZM_MF_OPENACC (D, PRHODJ, ZMZM_RHODJ, YDSTACK=YLSTACK)

DO JK=1, IKT
  
  ZRHODJ_DFDT_O_DZ (JI, JK)=ZMZM_RHODJ (JI, JK)*PDFDT (JI, JK)/PDZZ (JI, JK)
  
ENDDO

ZA(JI,:)=0.
ZB(JI,:)=0.
ZC(JI,:)=0.
ZY(JI,:)=0.

ZY (JI, IKB)=PRHODJ (JI, IKB)*PVARM (JI, IKB)/PTSTEP-ZMZM_RHODJ (JI, IKB+IKL)*PF (JI, IKB+IKL)/PDZZ&
& (JI, IKB+IKL)+ZMZM_RHODJ (JI, IKB)*PF (JI, IKB)/PDZZ (JI, IKB)+ZRHODJ_DFDT_O_DZ (JI, IKB+IKL)&
&*0.5*PIMPL*PVARM (JI, IKB+IKL)+ZRHODJ_DFDT_O_DZ (JI, IKB+IKL)*0.5*PIMPL*PVARM (JI, IKB)


DO JK=1+IKTB, IKTE-1
  
  ZY (JI, JK)=PRHODJ (JI, JK)*PVARM (JI, JK)/PTSTEP-ZMZM_RHODJ (JI, JK+IKL)*PF (JI, JK+IKL)/PDZZ &
  &(JI, JK+IKL)+ZMZM_RHODJ (JI, JK)*PF (JI, JK)/PDZZ (JI, JK)+ZRHODJ_DFDT_O_DZ (JI, JK+IKL)*0.5*PIMPL&
  &*PVARM (JI, JK+IKL)+ZRHODJ_DFDT_O_DZ (JI, JK+IKL)*0.5*PIMPL*PVARM (JI, JK)-ZRHODJ_DFDT_O_DZ (JI&
  &, JK)*0.5*PIMPL*PVARM (JI, JK)-ZRHODJ_DFDT_O_DZ (JI, JK)*0.5*PIMPL*PVARM (JI, JK-IKL)
  
ENDDO


IF (IKE==IKU) THEN
  
  ZY (JI, IKE)=PRHODJ (JI, IKE)*PVARM (JI, IKE)/PTSTEP
  
ELSE
  
  ZY (JI, IKE)=PRHODJ (JI, IKE)*PVARM (JI, IKE)/PTSTEP-ZMZM_RHODJ (JI, IKE+IKL)*PF (JI, IKE+IKL&
  &)/PDZZ (JI, IKE+IKL)+ZMZM_RHODJ (JI, IKE)*PF (JI, IKE)/PDZZ (JI, IKE)-ZRHODJ_DFDT_O_DZ (JI,&
  & IKE)*0.5*PIMPL*PVARM (JI, IKE)-ZRHODJ_DFDT_O_DZ (JI, IKE)*0.5*PIMPL*PVARM (JI, IKE-IKL)
  
ENDIF


IF (PIMPL>1.E-10) THEN
  
  ZB (JI, IKB)=PRHODJ (JI, IKB)/PTSTEP+ZRHODJ_DFDT_O_DZ (JI, IKB+IKL)*0.5*PIMPL
  ZC (JI, IKB)=ZRHODJ_DFDT_O_DZ (JI, IKB+IKL)*0.5*PIMPL

  

  DO JK=1+IKTB, IKTE-1
    
    ZA (JI, JK)=-ZRHODJ_DFDT_O_DZ (JI, JK)*0.5*PIMPL
    ZB (JI, JK)=PRHODJ (JI, JK)/PTSTEP+ZRHODJ_DFDT_O_DZ (JI, JK&
    &+IKL)*0.5*PIMPL-ZRHODJ_DFDT_O_DZ (JI, JK)*0.5*PIMPL
    ZC (JI, JK)=ZRHODJ_DFDT_O_DZ (JI, JK+IKL)*0.5*PIMPL
  
  ENDDO

  
  ZA (JI, IKE)=-ZRHODJ_DFDT_O_DZ (JI, IKE)*0.5*PIMPL
  ZB (JI, IKE)=PRHODJ (JI, IKE)/PTSTEP-ZRHODJ_DFDT_O_DZ (JI, IKE)*0.5*PIMPL
  
  
  ZBET =ZB (JI, IKB)
  PVARP (JI, IKB)=ZY (JI, IKB)/ZBET 

  

  DO JK=IKB+IKL, IKE-IKL, IKL
    
    ZGAM (JI, JK)=ZC (JI, JK-IKL)/ZBET 
    ZBET =ZB (JI, JK)-ZA (JI, JK)*ZGAM (JI, JK)
    PVARP (JI, JK)=(ZY (JI, JK)-ZA (JI, JK)*PVARP (JI, JK-IKL))/ZBET 
  
  ENDDO

  
  ZGAM (JI, IKE)=ZC (JI, IKE-IKL)/ZBET 
  ZBET =ZB (JI, IKE)-ZA (JI, IKE)*ZGAM (JI, IKE)
  PVARP (JI, IKE)=(ZY (JI, IKE)-ZA (JI, IKE)*PVARP (JI, IKE-IKL))/ZBET 

  

  DO JK=IKE-IKL, IKB,-IKL
    
    PVARP (JI, JK)=PVARP (JI, JK)-ZGAM (JI, JK+IKL)*PVARP (JI, JK+IKL)
  
  ENDDO

ELSE

  DO JK=IKTB, IKTE
    
    PVARP (JI, JK)=ZY (JI, JK)*PTSTEP/PRHODJ (JI, JK)
  
  ENDDO

ENDIF


PVARP (JI, IKA)=PVARP (JI, IKB)
PVARP (JI, IKU)=PVARP (JI, IKE)


END SUBROUTINE TRIDIAG_MASSFLUX_OPENACC

ENDMODULE MODE_TRIDIAG_MASSFLUX_OPENACC
