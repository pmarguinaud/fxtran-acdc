SUBROUTINE CUADJTQS_OPENACC (YDTHF, YDCST, KIDIA, KFDIA,&
& KLON, KLEV, KK, PSP, PT, PQ, LDFLAG, KCALL, YDSTACK)
!$ACC ROUTINE (CUADJTQS_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KK
REAL (KIND=JPRB), INTENT (IN)::PSP (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQ (KLON, KLEV)
LOGICAL, INTENT (IN)::LDFLAG (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCALL
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZALDCP 
REAL (KIND=JPRB)::Z5ALCP 
REAL (KIND=JPRB)::Z4ES 
REAL (KIND=JPRB)::Z3ES 
INTEGER (KIND=JPIM)::JL
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::ZFOEEW
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZQMAX

#include "fcttre.func.h"

JL = KIDIA



ZQMAX=0.5_JPRB


IF (PT (JL, KK)>YDCST%RTT) THEN
  Z3ES =YDTHF%R3LES
  Z4ES =YDTHF%R4LES
  Z5ALCP =YDTHF%R5ALVCP
  ZALDCP =YDTHF%RALVDCP
ELSE
  Z3ES =YDTHF%R3IES
  Z4ES =YDTHF%R4IES
  Z5ALCP =YDTHF%R5ALSCP
  ZALDCP =YDTHF%RALSDCP
ENDIF



IF (KCALL==1) THEN

  

  IF (LDFLAG (JL)) THEN
    ZQP=1.0_JPRB/PSP (JL)
    ZTARG=PT (JL, KK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
    ZQSAT=ZQP*ZFOEEW

    IF (ZQSAT>ZQMAX) THEN
      ZQSAT=ZQMAX
    ENDIF

    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    Z2S=Z5ALCP /(ZTARG-Z4ES )**2
    ZCOND=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
    ZCOND=MAX (ZCOND, 0.0_JPRB)
    PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND
    PQ (JL, KK)=PQ (JL, KK)-ZCOND
    ZTARG=PT (JL, KK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
    ZQSAT=ZQP*ZFOEEW

    IF (ZQSAT>ZQMAX) THEN
      ZQSAT=ZQMAX
    ENDIF

    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    Z2S=Z5ALCP /(ZTARG-Z4ES )**2
    ZCOND1=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)

    IF (ZCOND==0.0_JPRB)  THEN
      ZCOND1=0.0_JPRB
    ENDIF

    PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND1
    PQ (JL, KK)=PQ (JL, KK)-ZCOND1
  ENDIF

  
ENDIF


IF (KCALL==2) THEN

  

  IF (LDFLAG (JL)) THEN
    ZQP=1.0_JPRB/PSP (JL)
    ZTARG=PT (JL, KK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
    ZQSAT=ZQP*ZFOEEW

    IF (ZQSAT>ZQMAX) THEN
      ZQSAT=ZQMAX
    ENDIF

    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    Z2S=Z5ALCP /(ZTARG-Z4ES )**2
    ZCOND=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
    ZCOND=MIN (ZCOND, 0.0_JPRB)
    PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND
    PQ (JL, KK)=PQ (JL, KK)-ZCOND
    ZTARG=PT (JL, KK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
    ZQSAT=ZQP*ZFOEEW

    IF (ZQSAT>ZQMAX) THEN
      ZQSAT=ZQMAX
    ENDIF

    ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
    ZQSAT=ZQSAT*ZCOR
    Z2S=Z5ALCP /(ZTARG-Z4ES )**2
    ZCOND1=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)

    IF (ZCOND==0.0_JPRB)  THEN
      ZCOND1=0.0_JPRB
    ENDIF

    PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND1
    PQ (JL, KK)=PQ (JL, KK)-ZCOND1
  ENDIF

  
ENDIF


IF (KCALL==0) THEN
  
  ZQP=1.0_JPRB/PSP (JL)
  ZTARG=PT (JL, KK)
  ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
  ZQSAT=ZQP*ZFOEEW

  IF (ZQSAT>ZQMAX) THEN
    ZQSAT=ZQMAX
  ENDIF

  ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
  ZQSAT=ZQSAT*ZCOR
  Z2S=Z5ALCP /(ZTARG-Z4ES )**2
  ZCOND1=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
  PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND1
  PQ (JL, KK)=PQ (JL, KK)-ZCOND1
  ZTARG=PT (JL, KK)
  ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
  ZQSAT=ZQP*ZFOEEW

  IF (ZQSAT>ZQMAX) THEN
    ZQSAT=ZQMAX
  ENDIF

  ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
  ZQSAT=ZQSAT*ZCOR
  Z2S=Z5ALCP /(ZTARG-Z4ES )**2
  ZCOND1=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
  PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND1
  PQ (JL, KK)=PQ (JL, KK)-ZCOND1
  
ENDIF


IF (KCALL==4) THEN
  
  ZQP=1.0_JPRB/PSP (JL)
  ZTARG=PT (JL, KK)
  ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
  ZQSAT=ZQP*ZFOEEW

  IF (ZQSAT>ZQMAX) THEN
    ZQSAT=ZQMAX
  ENDIF

  ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
  ZQSAT=ZQSAT*ZCOR
  Z2S=Z5ALCP /(ZTARG-Z4ES )**2
  ZCOND=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
  PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND
  PQ (JL, KK)=PQ (JL, KK)-ZCOND
  ZTARG=PT (JL, KK)
  ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG-YDCST%RTT)/(ZTARG-Z4ES ))
  ZQSAT=ZQP*ZFOEEW

  IF (ZQSAT>ZQMAX) THEN
    ZQSAT=ZQMAX
  ENDIF

  ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
  ZQSAT=ZQSAT*ZCOR
  Z2S=Z5ALCP /(ZTARG-Z4ES )**2
  ZCOND1=(PQ (JL, KK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
  PT (JL, KK)=PT (JL, KK)+ZALDCP *ZCOND1
  PQ (JL, KK)=PQ (JL, KK)-ZCOND1
  
ENDIF



END SUBROUTINE CUADJTQS_OPENACC
