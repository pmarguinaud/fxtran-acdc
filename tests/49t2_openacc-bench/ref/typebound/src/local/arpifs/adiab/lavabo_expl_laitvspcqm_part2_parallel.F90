SUBROUTINE LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1)

USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1
INTEGER (KIND=JPIM)::JGFL
INTEGER (KIND=JPIM)::JLEV1
INTEGER (KIND=JPIM)::JLEV0
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER (KIND=JPIM) :: JROF
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL (KIND=JPRB), POINTER :: Z_YDCPG_SL1_GFL_P_F(:,:,:)
#include "abor1.intfb.h"
IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
JLEV0=0
JLEV1=YDGEOMETRY%YRDIMV%NFLEVG+1

DO JGFL=1, SIZE (YDCPG_SL1%GFL)

  IF ((YDCPG_SL1%GFL (JGFL)%YCOMP%CSLINT/='LAITVSPCQM  ').AND.YDCPG_SL1%GFL (JGFL)%YCOMP%LADV) THEN
    IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0',0,ZHOOK_HANDLE_PARALLEL)

    IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
      &:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
      &:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
      !$OMP PARALLEL DO PRIVATE (JBLK) FIRSTPRIVATE (YLCPG_BNDS)

      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
        CALL YLCPG_BNDS%UPDATE (JBLK)
        
        Z_YDCPG_SL1_GFL_P_F  (:, JLEV0, JBLK)=0.0_JPRB
        Z_YDCPG_SL1_GFL_P_F  (:, JLEV1, JBLK)=0.0_JPRB
      ENDDO

      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0')) THEN
        IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
        &:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
        IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
        &:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P_F => NULL ()
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN&
      &','LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
      &:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
      &:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      !$OMP PARALLEL DO PRIVATE (JBLK, JROF, YLCPG_BNDS)

      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

        

        

        DO JROF = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
          YLCPG_BNDS%KIDIA = JROF
          YLCPG_BNDS%KFDIA = JROF
          
          Z_YDCPG_SL1_GFL_P_F  (JROF, JLEV0, JBLK)=0.0_JPRB
          Z_YDCPG_SL1_GFL_P_F  (JROF, JLEV1, JBLK)=0.0_JPRB
        ENDDO

      ENDDO

      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0')) THEN
        IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
        &:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
        IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
        &:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P_F => NULL ()
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN&
      &','LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
      &:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P_F => GET_DEVICE_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
      &:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      
        !$ACC PARALLEL LOOP GANG &
        !$ACC&PRESENT (YDCPG_OPTS, YFXTRAN_ACDC_STACK, Z_YDCPG_SL1_GFL_P_F) &
        !$ACC&PRIVATE (JBLK) &
        !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
        
        DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
        
        
        
        !$ACC LOOP VECTOR &
        !$ACC&PRIVATE (JROF, YLCPG_BNDS) 

        

        DO JROF = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
          YLCPG_BNDS%KIDIA = JROF
          YLCPG_BNDS%KFDIA = JROF
          
          Z_YDCPG_SL1_GFL_P_F  (JROF, JLEV0, JBLK)=0.0_JPRB
          Z_YDCPG_SL1_GFL_P_F  (JROF, JLEV1, JBLK)=0.0_JPRB
        ENDDO

      ENDDO

      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0')) THEN
        IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
        &:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        Z_YDCPG_SL1_GFL_P_F => GET_HOST_DATA_RDWR (YDCPG_SL1%GFL (JGFL)%F_P_F)
        IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL&
        &:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      Z_YDCPG_SL1_GFL_P_F => NULL ()
      IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSE
        CALL ABOR1 ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL: NOT METHOD WAS FOUND')
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL:0',1,ZHOOK_HANDLE_PARALLEL)
  ENDIF

ENDDO


CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE LAVABO_EXPL_LAITVSPCQM_PART2_PARALLEL
