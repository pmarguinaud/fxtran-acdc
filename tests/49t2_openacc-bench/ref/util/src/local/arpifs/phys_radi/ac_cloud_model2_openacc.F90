SUBROUTINE AC_CLOUD_MODEL2_OPENACC (YDCST, YDPHY, YDPHY3, KIDIA, KFDIA, KLON, KTDIA&
&, KLEV, KJN, KIIDIA, KIFDIA, KAUCR, PDELP, PNEB, PQI, PQL, PR, PAPRSF, PT, PDEOSA&
&, PBSFSI, PBSFSL, PBSFTI, PBSFTL, PEOASI, PEOASL, PEOATI, PEOATL, PEODSI, PEODSL&
&, PEODTI, PEODTL, PEOSIDIR, PEOSLDIR, PUSAI, PUSAL, PUSBI, PUSBL, YDSTACK)
!$ACC ROUTINE (AC_CLOUD_MODEL2_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB
USE YOMCST,ONLY:TCST

USE YOMPHY,ONLY:TPHY
USE YOMPHY3,ONLY:TPHY3
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY3), INTENT (IN)::YDPHY3
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KJN
INTEGER (KIND=JPIM), INTENT (IN)::KIIDIA 
INTEGER (KIND=JPIM), INTENT (IN)::KIFDIA 
INTEGER (KIND=JPIM), INTENT (IN)::KAUCR
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDEOSA (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PBSFSI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PBSFSL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PBSFTI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PBSFTL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOASI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOASL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOATI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOATL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEODSI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEODSL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEODTI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEODTL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOSIDIR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOSLDIR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUSAI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUSAL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUSBI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUSBL (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::IAUCR
INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV2
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JB
INTEGER (KIND=JPIM)::IFDIA 
INTEGER (KIND=JPIM)::IIDIA 
REAL (KIND=JPRB)::ZGL0
REAL (KIND=JPRB)::ZGI0
REAL (KIND=JPRB)::ZCL
REAL (KIND=JPRB)::ZCI
REAL (KIND=JPRB)::ZB
REAL (KIND=JPRB)::ZA
REAL (KIND=JPRB)::ZARGL
REAL (KIND=JPRB)::ZARGI
REAL (KIND=JPRB)::ZTRLI
REAL (KIND=JPRB)::ZRRG
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZRE
REAL (KIND=JPRB)::ZDE
REAL (KIND=JPRB)::ZDI2L
REAL (KIND=JPRB)::ZAI2L

fxtran_acdc_temp (REAL (KIND=JPRB), ZIWC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZLWC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEL0_EFFA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEL0_EFFD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDE1, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRE1, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEL0, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOAI, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOAL, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEODI, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEODL, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGI, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGL, (KLON, KLEV, YDPHY3%N_SPBAND))
fxtran_acdc_temp (LOGICAL, LLQL, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLQI, (KLON, KLEV))
REAL (KIND=JPRB)::ZQ
REAL (KIND=JPRB)::ZP
REAL (KIND=JPRB)::ZSIZE

YLSTACK = YDSTACK



IF (KIND (ZIWC) == 8) THEN
    fxtran_acdc_alloc8 (ZIWC)
ELSEIF (KIND (ZIWC) == 4) THEN
    fxtran_acdc_alloc4 (ZIWC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLWC) == 8) THEN
    fxtran_acdc_alloc8 (ZLWC)
ELSEIF (KIND (ZLWC) == 4) THEN
    fxtran_acdc_alloc4 (ZLWC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEL0_EFFA) == 8) THEN
    fxtran_acdc_alloc8 (ZDEL0_EFFA)
ELSEIF (KIND (ZDEL0_EFFA) == 4) THEN
    fxtran_acdc_alloc4 (ZDEL0_EFFA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEL0_EFFD) == 8) THEN
    fxtran_acdc_alloc8 (ZDEL0_EFFD)
ELSEIF (KIND (ZDEL0_EFFD) == 4) THEN
    fxtran_acdc_alloc4 (ZDEL0_EFFD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDE1) == 8) THEN
    fxtran_acdc_alloc8 (ZDE1)
ELSEIF (KIND (ZDE1) == 4) THEN
    fxtran_acdc_alloc4 (ZDE1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRE1) == 8) THEN
    fxtran_acdc_alloc8 (ZRE1)
ELSEIF (KIND (ZRE1) == 4) THEN
    fxtran_acdc_alloc4 (ZRE1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEL0) == 8) THEN
    fxtran_acdc_alloc8 (ZDEL0)
ELSEIF (KIND (ZDEL0) == 4) THEN
    fxtran_acdc_alloc4 (ZDEL0)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOAI) == 8) THEN
    fxtran_acdc_alloc8 (ZEOAI)
ELSEIF (KIND (ZEOAI) == 4) THEN
    fxtran_acdc_alloc4 (ZEOAI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOAL) == 8) THEN
    fxtran_acdc_alloc8 (ZEOAL)
ELSEIF (KIND (ZEOAL) == 4) THEN
    fxtran_acdc_alloc4 (ZEOAL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEODI) == 8) THEN
    fxtran_acdc_alloc8 (ZEODI)
ELSEIF (KIND (ZEODI) == 4) THEN
    fxtran_acdc_alloc4 (ZEODI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEODL) == 8) THEN
    fxtran_acdc_alloc8 (ZEODL)
ELSEIF (KIND (ZEODL) == 4) THEN
    fxtran_acdc_alloc4 (ZEODL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGI) == 8) THEN
    fxtran_acdc_alloc8 (ZGI)
ELSEIF (KIND (ZGI) == 4) THEN
    fxtran_acdc_alloc4 (ZGI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGL) == 8) THEN
    fxtran_acdc_alloc8 (ZGL)
ELSEIF (KIND (ZGL) == 4) THEN
    fxtran_acdc_alloc4 (ZGL)
ELSE
    STOP 1
ENDIF


IF (KIND (LLQL) == 8) THEN
    fxtran_acdc_alloc8 (LLQL)
ELSEIF (KIND (LLQL) == 4) THEN
    fxtran_acdc_alloc4 (LLQL)
ELSE
    STOP 1
ENDIF


IF (KIND (LLQI) == 8) THEN
    fxtran_acdc_alloc8 (LLQI)
ELSEIF (KIND (LLQI) == 4) THEN
    fxtran_acdc_alloc4 (LLQI)
ELSE
    STOP 1
ENDIF


JLON = KIDIA





IF (.NOT.YDPHY%LCLSATUR) THEN

  DO JLEV=KTDIA, KLEV
    
    PEOASI (JLON, JLEV)=YDPHY3%EOASI
    PEOASL (JLON, JLEV)=YDPHY3%EOASN
    PEOATI (JLON, JLEV)=YDPHY3%EOATI
    PEOATL (JLON, JLEV)=YDPHY3%EOATN
    PEODSI (JLON, JLEV)=YDPHY3%EODSI
    PEODSL (JLON, JLEV)=YDPHY3%EODSN
    PEODTI (JLON, JLEV)=YDPHY3%EODTI
    PEODTL (JLON, JLEV)=YDPHY3%EODTN
    PBSFSI (JLON, JLEV)=YDPHY3%BSFSI
    PBSFSL (JLON, JLEV)=YDPHY3%BSFSN
    PBSFTI (JLON, JLEV)=YDPHY3%BSFTI
    PBSFTL (JLON, JLEV)=YDPHY3%BSFTN
    PUSAI (JLON, JLEV)=YDPHY3%USAI
    PUSAL (JLON, JLEV)=YDPHY3%USAN
    PUSBI (JLON, JLEV)=YDPHY3%USBI
    PUSBL (JLON, JLEV)=YDPHY3%USBN
    PEOSIDIR (JLON, JLEV)=0._JPRB
    PEOSLDIR (JLON, JLEV)=0._JPRB
  
  ENDDO

ELSE
  ZTRLI=EXP (-250._JPRB)
  ZRRG=1._JPRB/YDCST%RG
  ZAI2L=LOG (YDPHY3%FCM_DEL_AI/YDPHY3%FCM_DEL_AL)
  ZDI2L=LOG (YDPHY3%FCM_DEL_DI/YDPHY3%FCM_DEL_DL)
  LLQI (JLON,:)=PQI (JLON,:)>0._JPRB
  LLQL (JLON,:)=PQL (JLON,:)>0._JPRB

  DO JLEV=KTDIA, KLEV
    
    ZRHO=PAPRSF (JLON, JLEV)/(PR (JLON, JLEV)*PT (JLON, JLEV))
    ZIWC (JLON, JLEV)=ZRHO*PQI (JLON, JLEV)*1000._JPRB
    ZLWC (JLON, JLEV)=ZRHO*PQL (JLON, JLEV)*1000._JPRB
  
  ENDDO


  DO JB=1, YDPHY3%N_SPBAND

    DO JLEV=KTDIA, KLEV

      

      IF (LLQI (JLON, JLEV)) THEN
        ZDE=YDPHY3%FCM_IWC2DE(JB, 0)+YDPHY3%FCM_IWC2DE(JB, 1)*(ZIWC (JLON&
        &, JLEV)+YDPHY3%FCM_IWC2DE(JB, 2))**YDPHY3%FCM_IWC2DE(JB, 3)
        ZDE=MAX (YDPHY3%FCM_IWC2DE(JB,-2), MIN (YDPHY3%FCM_IWC2DE(JB,-1), ZDE))
        ZDE1 (JLON, JLEV, JB)=LOG (MAX (ZDE, ZTRLI))
      ELSE
        ZDE1 (JLON, JLEV, JB)=0._JPRB
      ENDIF


      IF (LLQL (JLON, JLEV)) THEN
        ZRE=YDPHY3%FCM_LWC2RE(JB, 0)+YDPHY3%FCM_LWC2RE(JB, 1)*(ZLWC (JLON&
        &, JLEV)+YDPHY3%FCM_LWC2RE(JB, 2))**YDPHY3%FCM_LWC2RE(JB, 3)
        ZRE=MAX (YDPHY3%FCM_LWC2RE(JB,-2), MIN (YDPHY3%FCM_LWC2RE(JB,-1), ZRE))
        ZRE1 (JLON, JLEV, JB)=LOG (MAX (ZRE, ZTRLI))
      ELSE
        ZRE1 (JLON, JLEV, JB)=0._JPRB
      ENDIF

    
    ENDDO

  ENDDO

  ZEOAI (JLON,:,:)=0._JPRB
  ZEOAL (JLON,:,:)=0._JPRB
  ZEODI (JLON,:,:)=0._JPRB
  ZEODL (JLON,:,:)=0._JPRB
  ZGI (JLON,:,:)=0._JPRB
  ZGL (JLON,:,:)=0._JPRB

  DO JB=1, YDPHY3%N_SPBAND

    IF (JB==1) THEN
      IAUCR=KAUCR
    
    
    ELSE
      IAUCR=1
    
    
    ENDIF


    

    DO JLEV=KTDIA, KLEV
      
      ZSIZE=ZDE1 (JLON,JLEV, JB)
      ZP=YDPHY3 %FCM_P_AI(JB,0)+ZSIZE*(YDPHY3 %FCM_P_AI(JB,1)+ZSIZE&
      &*(YDPHY3 %FCM_P_AI(JB,2)+ZSIZE*YDPHY3 %FCM_P_AI(JB,3)))
      ZQ=1.0_JPRB+ZSIZE*(YDPHY3 %FCM_Q_AI(JB,1)+ZSIZE*(YDPHY3&
      & %FCM_Q_AI(JB,2)+ZSIZE*YDPHY3 %FCM_Q_AI(JB,3)))
      ZEOAI (JLON,JLEV, JB)=ZP/ZQ
    
    ENDDO


    

    

    

    DO JLEV=KTDIA, KLEV
      
      ZSIZE=ZRE1 (JLON,JLEV, JB)
      ZP=YDPHY3 %FCM_P_AL(JB,0)+ZSIZE*(YDPHY3 %FCM_P_AL(JB,1)+ZSIZE&
      &*(YDPHY3 %FCM_P_AL(JB,2)+ZSIZE*YDPHY3 %FCM_P_AL(JB,3)))
      ZQ=1.0_JPRB+ZSIZE*(YDPHY3 %FCM_Q_AL(JB,1)+ZSIZE*(YDPHY3&
      & %FCM_Q_AL(JB,2)+ZSIZE*YDPHY3 %FCM_Q_AL(JB,3)))
      ZEOAL (JLON,JLEV, JB)=ZP/ZQ
    
    ENDDO


    

    

    

    DO JLEV=KTDIA, KLEV
      
      ZSIZE=ZDE1 (JLON,JLEV, JB)
      ZP=YDPHY3 %FCM_P_DI(JB,0)+ZSIZE*(YDPHY3 %FCM_P_DI(JB,1)+ZSIZE&
      &*(YDPHY3 %FCM_P_DI(JB,2)+ZSIZE*YDPHY3 %FCM_P_DI(JB,3)))
      ZQ=1.0_JPRB+ZSIZE*(YDPHY3 %FCM_Q_DI(JB,1)+ZSIZE*(YDPHY3&
      & %FCM_Q_DI(JB,2)+ZSIZE*YDPHY3 %FCM_Q_DI(JB,3)))
      ZEODI (JLON,JLEV, JB)=ZP/ZQ
    
    ENDDO


    

    

    

    DO JLEV=KTDIA, KLEV
      
      ZSIZE=ZRE1 (JLON,JLEV, JB)
      ZP=YDPHY3 %FCM_P_DL(JB,0)+ZSIZE*(YDPHY3 %FCM_P_DL(JB,1)+ZSIZE&
      &*(YDPHY3 %FCM_P_DL(JB,2)+ZSIZE*YDPHY3 %FCM_P_DL(JB,3)))
      ZQ=1.0_JPRB+ZSIZE*(YDPHY3 %FCM_Q_DL(JB,1)+ZSIZE*(YDPHY3&
      & %FCM_Q_DL(JB,2)+ZSIZE*YDPHY3 %FCM_Q_DL(JB,3)))
      ZEODL (JLON,JLEV, JB)=ZP/ZQ
    
    ENDDO


    

    

    

    DO JLEV=KTDIA, KLEV
      
      ZSIZE=ZDE1 (JLON,JLEV, JB)
      ZP=YDPHY3 %FCM_P_GI(JB,0)+ZSIZE*(YDPHY3 %FCM_P_GI(JB,1)+ZSIZE&
      &*(YDPHY3 %FCM_P_GI(JB,2)+ZSIZE*YDPHY3 %FCM_P_GI(JB,3)))
      ZQ=1.0_JPRB+ZSIZE*(YDPHY3 %FCM_Q_GI(JB,1)+ZSIZE*(YDPHY3&
      & %FCM_Q_GI(JB,2)+ZSIZE*YDPHY3 %FCM_Q_GI(JB,3)))
      ZGI (JLON,JLEV, JB)=ZP/ZQ
    
    ENDDO


    

    

    

    DO JLEV=KTDIA, KLEV
      
      ZSIZE=ZRE1 (JLON,JLEV, JB)
      ZP=YDPHY3 %FCM_P_GL(JB,0)+ZSIZE*(YDPHY3 %FCM_P_GL(JB,1)+ZSIZE&
      &*(YDPHY3 %FCM_P_GL(JB,2)+ZSIZE*YDPHY3 %FCM_P_GL(JB,3)))
      ZQ=1.0_JPRB+ZSIZE*(YDPHY3 %FCM_Q_GL(JB,1)+ZSIZE*(YDPHY3&
      & %FCM_Q_GL(JB,2)+ZSIZE*YDPHY3 %FCM_Q_GL(JB,3)))
      ZGL (JLON,JLEV, JB)=ZP/ZQ
    
    ENDDO


    

    

    DO JLEV=KTDIA, KLEV

      

      IF (LLQI (JLON, JLEV)) THEN
        ZEOAI (JLON, JLEV, JB)=EXP (ZEOAI (JLON, JLEV, JB))*ZRRG
        ZEODI (JLON, JLEV, JB)=EXP (ZEODI (JLON, JLEV, JB))*ZRRG
        ZGI (JLON, JLEV, JB)=0.5_JPRB/(1.0_JPRB+EXP (-2.0_JPRB*ZGI (JLON, JLEV, JB)))
      ENDIF


      IF (LLQL (JLON, JLEV)) THEN
        ZEOAL (JLON, JLEV, JB)=EXP (ZEOAL (JLON, JLEV, JB))*ZRRG
        ZEODL (JLON, JLEV, JB)=EXP (ZEODL (JLON, JLEV, JB))*ZRRG
        ZGL (JLON, JLEV, JB)=0.5_JPRB/(1.0_JPRB+EXP (-2.0_JPRB*ZGL (JLON, JLEV, JB)))
      ENDIF

      ZDEL0 (JLON, JLEV, JB)=PDELP (JLON, JLEV)*(PQI (JLON, JLEV)*(ZEOAI (JLON, JLEV, JB)+ZEODI&
      & (JLON, JLEV, JB))+PQL (JLON, JLEV)*(ZEOAL (JLON, JLEV, JB)+ZEODL (JLON, JLEV, JB)))
    
    ENDDO

  ENDDO

  JB=1

  DO JLEV=KTDIA, KLEV
    
    ZDEL0_EFFA (JLON, JLEV)=ZDEL0 (JLON, JLEV, JB)
    ZDEL0_EFFD (JLON, JLEV)=ZDEL0 (JLON, JLEV, JB)

    

    DO JLEV2=KTDIA, JLEV-1
      
      ZB=(YDPHY3%FCM_B_AI*ZIWC (JLON, JLEV)+YDPHY3%FCM_B_AL*ZLWC (JLON&
      &, JLEV))/(ZIWC (JLON, JLEV)+ZLWC (JLON, JLEV)+ZTRLI)
      ZDEL0_EFFA (JLON, JLEV)=ZDEL0_EFFA (JLON, JLEV)+PNEB (JLON, JLEV2)*ZDEL0 (JLON, JLEV2, JB)*ZB
      ZDEL0_EFFD (JLON, JLEV)=ZDEL0_EFFD (JLON, JLEV)+PNEB (JLON, JLEV2)*ZDEL0 (JLON, JLEV2, JB)
    
    ENDDO


    DO JLEV2=JLEV+1, KLEV
      
      ZB=(YDPHY3%FCM_B_BI*ZIWC (JLON, JLEV)+YDPHY3%FCM_B_BL*ZLWC (JLON&
      &, JLEV))/(ZIWC (JLON, JLEV)+ZLWC (JLON, JLEV)+ZTRLI)
      ZDEL0_EFFA (JLON, JLEV)=ZDEL0_EFFA (JLON, JLEV)+PNEB (JLON, JLEV2)*ZDEL0 (JLON, JLEV2, JB)*ZB
      ZDEL0_EFFD (JLON, JLEV)=ZDEL0_EFFD (JLON, JLEV)+PNEB (JLON, JLEV2)*ZDEL0 (JLON, JLEV2, JB)
    
    ENDDO

    
    ZA=(YDPHY3%FCM_AI*ZIWC (JLON, JLEV)+YDPHY3%FCM_AL*ZLWC (JLON&
    &, JLEV))/(ZIWC (JLON, JLEV)+ZLWC (JLON, JLEV)+ZTRLI)
    ZARGI=LOG (MAX ((ZDEL0_EFFA (JLON, JLEV)+ZA*PDEOSA (JLON, JLEV))/YDPHY3%FCM_DEL_AI, ZTRLI))
    ZARGL=ZARGI+ZAI2L
    ZCI=EXP (-YDPHY3%FCM_NU_AI*LOG (1.0_JPRB+EXP (YDPHY3%FCM_MU_AI*ZARGI)))
    ZCL=EXP (-YDPHY3%FCM_NU_AL*LOG (1.0_JPRB+EXP (YDPHY3%FCM_MU_AL*ZARGL)))
    ZEOAI (JLON, JLEV, JB)=ZCI*ZEOAI (JLON, JLEV, JB)
    ZEOAL (JLON, JLEV, JB)=ZCL*ZEOAL (JLON, JLEV, JB)

    

    IF (YDPHY3%FCM_NU_DI/=0._JPRB.OR.YDPHY3%FCM_NU_DL/=0._JPRB) THEN
      
      ZARGI=LOG (MAX (ZDEL0_EFFD (JLON, JLEV)/YDPHY3%FCM_DEL_DI, ZTRLI))
      ZARGL=ZARGI+ZDI2L
      ZCI=EXP (-YDPHY3%FCM_NU_DI*LOG (1.0_JPRB+EXP (YDPHY3%FCM_MU_DI*ZARGI)))
      ZCL=EXP (-YDPHY3%FCM_NU_DL*LOG (1.0_JPRB+EXP (YDPHY3%FCM_MU_DL*ZARGL)))
      ZEODI (JLON, JLEV, JB)=ZCI*ZEODI (JLON, JLEV, JB)
      ZEODL (JLON, JLEV, JB)=ZCL*ZEODL (JLON, JLEV, JB)
    
    ENDIF

  ENDDO

  JB=1

  DO JLEV=KTDIA, KLEV
    
    PEOASI (JLON, JLEV)=ZEOAI (JLON, JLEV, JB)
    PEOASL (JLON, JLEV)=ZEOAL (JLON, JLEV, JB)
    PEODSI (JLON, JLEV)=ZEODI (JLON, JLEV, JB)
    PEODSL (JLON, JLEV)=ZEODL (JLON, JLEV, JB)
    PBSFSI (JLON, JLEV)=0.5_JPRB-0.375_JPRB*ZGI (JLON, JLEV, JB)
    PBSFSL (JLON, JLEV)=0.5_JPRB-0.375_JPRB*ZGL (JLON, JLEV, JB)
    ZGI0=ZGI (JLON, JLEV, JB)/(1._JPRB-ZGI (JLON, JLEV, JB))
    ZGL0=ZGL (JLON, JLEV, JB)/(1._JPRB-ZGL (JLON, JLEV, JB))
    PEOSIDIR (JLON, JLEV)=PEOASI (JLON, JLEV)+PEODSI (JLON, JLEV)/(1._JPRB-ZGI0*ZGI0)
    PEOSLDIR (JLON, JLEV)=PEOASL (JLON, JLEV)+PEODSL (JLON, JLEV)/(1._JPRB-ZGL0*ZGL0)
    PUSAI (JLON, JLEV)=2.0_JPRB*PBSFSI (JLON, JLEV)-1.0_JPRB
    PUSAL (JLON, JLEV)=2.0_JPRB*PBSFSL (JLON, JLEV)-1.0_JPRB
    PUSBI (JLON, JLEV)=0.0_JPRB
    PUSBL (JLON, JLEV)=0.0_JPRB
  
  ENDDO

  JB=2

  DO JLEV=KTDIA, KLEV
    
    PEOATI (JLON, JLEV)=ZEOAI (JLON, JLEV, JB)
    PEOATL (JLON, JLEV)=ZEOAL (JLON, JLEV, JB)
    PEODTI (JLON, JLEV)=ZEODI (JLON, JLEV, JB)
    PEODTL (JLON, JLEV)=ZEODL (JLON, JLEV, JB)
    PBSFTI (JLON, JLEV)=0.5_JPRB-0.375_JPRB*ZGI (JLON, JLEV, JB)
    PBSFTL (JLON, JLEV)=0.5_JPRB-0.375_JPRB*ZGL (JLON, JLEV, JB)
  
  ENDDO

ENDIF





END SUBROUTINE AC_CLOUD_MODEL2_OPENACC
