
MODULE MODE_THL_RT_FROM_TH_R_MF_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE THL_RT_FROM_TH_R_MF_OPENACC (D, CST, KRR, KRRL, KRRI, PTH, PR, PEXN, PTHL, PRT, YDSTACK)
!$ACC ROUTINE (THL_RT_FROM_TH_R_MF_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
INTEGER, INTENT (IN)::KRR
INTEGER, INTENT (IN)::KRRL
INTEGER, INTENT (IN)::KRRI
REAL, INTENT (IN)::PTH(D%NIJT, D%NKT)
REAL, INTENT (IN)::PR(D%NIJT, D%NKT, KRR)
REAL, INTENT (IN)::PEXN(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHL(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRT(D%NIJT, D%NKT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL, ZT, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZCP, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZLSOCPEXN, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZLVOCPEXN, (D%NIJT, D%NKT))
INTEGER::JK
INTEGER::JI
INTEGER::JRR
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT


YLSTACK = YDSTACK



IF (KIND (ZT) == 8) THEN
    fxtran_acdc_alloc8 (ZT)
ELSEIF (KIND (ZT) == 4) THEN
    fxtran_acdc_alloc4 (ZT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCP) == 8) THEN
    fxtran_acdc_alloc8 (ZCP)
ELSEIF (KIND (ZCP) == 4) THEN
    fxtran_acdc_alloc4 (ZCP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLSOCPEXN) == 8) THEN
    fxtran_acdc_alloc8 (ZLSOCPEXN)
ELSEIF (KIND (ZLSOCPEXN) == 4) THEN
    fxtran_acdc_alloc4 (ZLSOCPEXN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZLVOCPEXN) == 8) THEN
    fxtran_acdc_alloc8 (ZLVOCPEXN)
ELSEIF (KIND (ZLVOCPEXN) == 4) THEN
    fxtran_acdc_alloc4 (ZLVOCPEXN)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT

DO JK=1, IKT
  
  ZT (JI, JK)=PTH (JI, JK)*PEXN (JI, JK)
  ZCP (JI, JK)=CST%XCPD

  IF (KRR>0)  THEN
    ZCP (JI, JK)=ZCP (JI, JK)+CST%XCPV*PR (JI, JK, 1)
  ENDIF

  
ENDDO


DO JRR=2, 1+KRRL

  DO JK=1, IKT
    
    ZCP (JI, JK)=ZCP (JI, JK)+CST%XCL*PR (JI, JK, JRR)
  
  ENDDO

ENDDO


DO JRR=2+KRRL, 1+KRRL+KRRI

  DO JK=1, IKT
    
    ZCP (JI, JK)=ZCP (JI, JK)+CST%XCI*PR (JI, JK, JRR)
  
  ENDDO

ENDDO


IF (KRRL>=1) THEN

  IF (KRRI>=1) THEN

    DO JK=1, IKT
      
      ZLVOCPEXN (JI, JK)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT (JI, JK)-CST%XTT))/ZCP (JI, JK)/PEXN (JI, JK)
      ZLSOCPEXN (JI, JK)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT (JI, JK)-CST%XTT))/ZCP (JI, JK)/PEXN (JI, JK)
      PRT (JI, JK)=PR (JI, JK, 1)+PR (JI, JK, 2)+PR (JI, JK, 4)
      PTHL (JI, JK)=PTH (JI, JK)-ZLVOCPEXN (JI, JK)*PR (JI, JK, 2)-ZLSOCPEXN (JI, JK)*PR (JI, JK, 4)
    
    ENDDO

  ELSE

    DO JK=1, IKT
      
      ZLVOCPEXN (JI, JK)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT (JI, JK)-CST%XTT))/ZCP (JI, JK)/PEXN (JI, JK)
      PRT (JI, JK)=PR (JI, JK, 1)+PR (JI, JK, 2)
      PTHL (JI, JK)=PTH (JI, JK)-ZLVOCPEXN (JI, JK)*PR (JI, JK, 2)
    
    ENDDO

  ENDIF

ELSE

  DO JK=1, IKT
    
    PRT (JI, JK)=PR (JI, JK, 1)
    PTHL (JI, JK)=PTH (JI, JK)
  
  ENDDO

ENDIF


END SUBROUTINE THL_RT_FROM_TH_R_MF_OPENACC

ENDMODULE MODE_THL_RT_FROM_TH_R_MF_OPENACC
