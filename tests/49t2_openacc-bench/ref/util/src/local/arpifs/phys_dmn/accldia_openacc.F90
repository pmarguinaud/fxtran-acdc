SUBROUTINE ACCLDIA_OPENACC (YDCST, LDXCLP, LDXTGST, LDXXGST, YDPHY, YDPHY2&
&, YDTOPH, KIDIA, KFDIA, KLON, KLEV, PUCLS, PVCLS, PU, PV, PCAPE, PDCAPE&
&, PTKE, PAPHIFM, POROG, PUGST, PVGST, PBLH, KCLPH, YDSTACK)
!$ACC ROUTINE (ACCLDIA_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMPHY,ONLY:TPHY
USE YOMPHY2,ONLY:TPHY2
USE YOMCST,ONLY:TCST
USE YOMTOPH,ONLY:TTOPH
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY2), INTENT (IN)::YDPHY2
TYPE (TTOPH), INTENT (IN)::YDTOPH
TYPE (TCST), INTENT (IN)::YDCST
LOGICAL, INTENT (IN)::LDXCLP
LOGICAL, INTENT (IN)::LDXTGST
LOGICAL, INTENT (IN)::LDXXGST
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
REAL (KIND=JPRB), INTENT (IN)::POROG (KLON)
REAL (KIND=JPRB), INTENT (IN)::PVCLS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PUCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PBLH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVGST (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PUGST (KLON)
REAL (KIND=JPRB), INTENT (IN)::PAPHIFM (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTKE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDCAPE (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
INTEGER (KIND=JPIM), INTENT (OUT)::KCLPH (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::ILEVM1
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::ILEVBI 
fxtran_acdc_temp (INTEGER (KIND=JPIM), ICM, (KLON, KLEV))
INTEGER (KIND=JPIM)::JLEVM1 
INTEGER (KIND=JPIM)::JJLEVM1 
REAL (KIND=JPRB)::ZCVGUSTS
REAL (KIND=JPRB)::ZHTOP
REAL (KIND=JPRB)::ZHBOT
REAL (KIND=JPRB)::ZECTBLH
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZZ
REAL (KIND=JPRB)::ZVCLS
REAL (KIND=JPRB)::ZALPHA


YLSTACK = YDSTACK



IF (KIND (ICM) == 8) THEN
    fxtran_acdc_alloc8 (ICM)
ELSEIF (KIND (ICM) == 4) THEN
    fxtran_acdc_alloc4 (ICM)
ELSE
    STOP 1
ENDIF


JLON = KIDIA





IF ((LDXTGST.OR.LDXXGST).AND.YDPHY2%LRAFTKE) THEN
  ZEPS=1.E-6_JPRB
  JLEVM1 =0

  DO JLEV=KLEV, 1,-1
    
    ZZ=PAPHIFM (JLON, JLEV)-POROG (JLON)-YDPHY2%HTKERAF*YDCST%RG
    JJLEVM1 =MAX (0._JPRB, SIGN (1._JPRB, ZZ))*JLEV
    JLEVM1 =MAX (JJLEVM1 , JLEVM1 )
  
  ENDDO

  
  JLEVM1 =MIN (JLEVM1 , KLEV-1)
  ZVCLS=MAX (ZEPS, PUCLS (JLON)**2+PVCLS (JLON)**2)
  ZALPHA=PTKE (JLON, JLEVM1 )*(YDPHY2%HTKERAF*YDCST%RG+POROG (JLON)-PAPHIFM (JLON, JLEVM1 +1)&
  &)-PTKE (JLON, JLEVM1 +1)*(YDPHY2%HTKERAF*YDCST%RG+POROG (JLON)-PAPHIFM (JLON, JLEVM1 ))
  ZALPHA=MAX (ZEPS, ZALPHA/(PAPHIFM (JLON, JLEVM1 )-PAPHIFM (JLON, JLEVM1 +1)))
  ZALPHA=ZALPHA/ZVCLS
  ZCVGUSTS=MAX (0._JPRB, SQRT (PU (JLON, YDTOPH%NT850)**2+PV (JLON, YDTOPH%NT850)**2)-SQRT (PU (JLON&
  &, YDTOPH%NT950)**2+PV (JLON, YDTOPH%NT950)**2))*MAX (0._JPRB, SIGN (1._JPRB, PCAPE (JLON)-YDPHY2&
  &%GCAPERAF))*MIN (1._JPRB, SQRT (MAX (0._JPRB, PCAPE (JLON)/(5._JPRB*YDPHY2%GCAPERAF))))
  ZALPHA=1.0_JPRB+YDPHY2%FACRAF*SQRT (ZALPHA)+YDPHY2%FACRAFCV*ZCVGUSTS/SQRT (ZVCLS&
  &)+YDPHY2%FACRAFDCAPE*SQRT (2._JPRB*MAX (0._JPRB,-PDCAPE (JLON)))/SQRT (ZVCLS)
  PUGST (JLON)=ZALPHA*PUCLS (JLON)
  PVGST (JLON)=ZALPHA*PVCLS (JLON)
  
ENDIF


IF (LDXCLP.AND..NOT.YDPHY%LCOEFKTKE) THEN
  
  ILEVBI =0
  
  ICM (JLON,:)=0
  ZECTBLH=0.01_JPRB

  DO JLEV=YDTOPH%NTCOET, KLEV
    
    ICM (JLON, JLEV)=INT (MAX (0.0_JPRB, SIGN (1.0_JPRB, PTKE (JLON, JLEV)-ZECTBLH)))
  
  ENDDO


  DO JLEV=KLEV, YDTOPH%NTCOET,-1
    
    ILEVM1=MAX (YDTOPH%NTCOET, JLEV-1)

    IF ((ICM (JLON, JLEV)==1).AND.(ICM (JLON, ILEVM1)==0)) THEN
      ILEVBI =MAX (JLEV, ILEVBI )
    ENDIF

  
  ENDDO

  
  ILEVBI =ILEVBI *MAX (ICM (JLON, KLEV), ICM (JLON, KLEV-1))

  IF ((ICM (JLON, KLEV)==0).AND.(ILEVBI ==0))  THEN
    ILEVBI =KLEV
  ENDIF

  
  
  KCLPH (JLON)=MAX (1, ILEVBI )

  

  

  IF ((ILEVBI >1).AND.(ILEVBI <KLEV)) THEN
    ZHBOT=(PAPHIFM (JLON, ILEVBI )-POROG (JLON))/YDCST%RG
    ZHTOP=(PAPHIFM (JLON, ILEVBI -1)-POROG (JLON))/YDCST%RG
    PBLH (JLON)=ZHBOT+(ZHTOP-ZHBOT)/(PTKE (JLON, ILEVBI -1)-PTKE&
    & (JLON, ILEVBI ))*(ZECTBLH-PTKE (JLON, ILEVBI ))
  ELSEIF (ILEVBI ==KLEV) THEN
    PBLH (JLON)=(PAPHIFM (JLON, KLEV)-POROG (JLON))/YDCST%RG
  ELSEIF (ILEVBI ==0) THEN
    PBLH (JLON)=(PAPHIFM (JLON, YDTOPH%NTCOET)-POROG (JLON))/YDCST%RG
  ELSE
    PBLH (JLON)=(PAPHIFM (JLON, ILEVBI )-POROG (JLON))/YDCST%RG
  ENDIF

  
ENDIF



END SUBROUTINE ACCLDIA_OPENACC
