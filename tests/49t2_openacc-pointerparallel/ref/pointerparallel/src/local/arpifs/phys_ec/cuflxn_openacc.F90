
SUBROUTINE CUFLXN_OPENACC (YDTHF, YDCST, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON, KLEV, PTSPHY, PTEN&
&, PQEN, PQSEN, PTENH, PQENH, PAPH, PAP, PGEOH, LDLAND, LDCUM, LDTDKMF, KCBOT, KCTOP, KDTOP, KTOPM2&
&, KTYPE, LDDRAF, PMFU, PMFD, PMFUS, PMFDS, PMFUQ, PMFDQ, PMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, PDMFUP&
&, PDMFDP, PDPMEL, PLGLAC, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK)
!$ACC ROUTINE (CUFLXN_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOEPHLI,ONLY:TEPHLI
USE YOECUMF,ONLY:TECUMF
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
LOGICAL, INTENT (IN)::LDLAND (KLON)
LOGICAL, INTENT (IN)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KDTOP (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KTOPM2
INTEGER (KIND=JPIM), INTENT (INOUT)::KTYPE (KLON)
LOGICAL, INTENT (INOUT)::LDDRAF (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFDS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFDQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFUL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (IN)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (INOUT)::PDMFUP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PDMFDP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDPMEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PLGLAC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PRAIN (KLON)
REAL (KIND=JPRB), INTENT (IN)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PMFDDE_RATE (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZRCUCOV 
REAL (KIND=JPRB)::ZMFS 
REAL (KIND=JPRB)::ZRHEBC 
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IDBAS 
LOGICAL::LLDDRAF
REAL (KIND=JPRB)::ZRHM
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZTEN
REAL (KIND=JPRB)::ZWETB
REAL (KIND=JPRB)::ZTWETB
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZTMST
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZSNMLT
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZRMIN
REAL (KIND=JPRB)::ZRFLN
REAL (KIND=JPRB)::ZRFL
REAL (KIND=JPRB)::ZPDS
REAL (KIND=JPRB)::ZPDR
REAL (KIND=JPRB)::ZOELHM
REAL (KIND=JPRB)::ZOEEWM
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDRFL1
REAL (KIND=JPRB)::ZDRFL
REAL (KIND=JPRB)::ZDENOM
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCONS1A
REAL (KIND=JPRB)::ZCONS1
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB), PARAMETER::ZTW1=1329.31_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW2=0.0074615_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW3=0.85E5_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW4=40.637_JPRB
REAL (KIND=JPRB), PARAMETER::ZTW5=275.0_JPRB

#include "fcttre.func.h"

JL = KIDIA



ZTMST=PTSPHY
ZCONS1A=YDCST%RCPD/(YDCST%RLMLT*YDCST%RG*YDECUMF%RTAUMEL)
ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*ZTMST)

IF (YDECUMF%LMFWETB) THEN
  ZWETB=1.0_JPRB
ELSE
  ZWETB=0.0_JPRB
ENDIF


IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=0.0_JPRB
ELSE
  ZGLAC=1.0_JPRB
ENDIF


PRAIN (JL)=0.0_JPRB

IF (.NOT.LDCUM (JL).OR.KDTOP (JL)<KCTOP (JL))  THEN
  LDDRAF (JL)=.FALSE.
ENDIF


IF (.NOT.LDCUM (JL))  THEN
  KTYPE (JL)=0
ENDIF

IDBAS =KLEV

IF (LDLAND (JL)) THEN
  ZRHEBC =0.75_JPRB

  IF (KTYPE (JL)==1)  THEN
    ZRHEBC =0.70_JPRB
  ENDIF

ELSE
  ZRHEBC =YDECUMF%RHEBC

  IF (KTYPE (JL)==1)  THEN
    ZRHEBC =0.85_JPRB
  ENDIF

ENDIF



DO JK=KTOPM2, KLEV
  IKB=MIN (JK+1, KLEV)
  
  PMFLXR (JL, JK)=0.0_JPRB
  PMFLXS (JL, JK)=0.0_JPRB
  PDPMEL (JL, JK)=0.0_JPRB
  PSNDE (JL, JK, 1)=0.0_JPRB
  PSNDE (JL, JK, 2)=0.0_JPRB

  IF (LDCUM (JL).AND.JK>=KCTOP (JL)) THEN
    PMFUS (JL, JK)=PMFUS (JL, JK)-PMFU (JL, JK)*(YDCST%RCPD*PTENH (JL, JK)+PGEOH (JL, JK))
    PMFUQ (JL, JK)=PMFUQ (JL, JK)-PMFU (JL, JK)*PQENH (JL, JK)
    PLGLAC (JL, JK)=PMFU (JL, JK)*PLGLAC (JL, JK)
    LLDDRAF=LDDRAF (JL).AND.JK>=KDTOP (JL)

    IF (LLDDRAF) THEN
      PMFDS (JL, JK)=PMFDS (JL, JK)-PMFD (JL, JK)*(YDCST%RCPD*PTENH (JL, JK)+PGEOH (JL, JK))
      PMFDQ (JL, JK)=PMFDQ (JL, JK)-PMFD (JL, JK)*PQENH (JL, JK)
    ELSE
      PMFD (JL, JK)=0.0_JPRB
      PMFDS (JL, JK)=0.0_JPRB
      PMFDQ (JL, JK)=0.0_JPRB
      PDMFDP (JL, JK-1)=0.0_JPRB
    ENDIF


    IF (LLDDRAF.AND.PMFD (JL, JK)<0._JPRB.AND.PMFD (JL, IKB)==0._JPRB) THEN
      IDBAS =JK
    ENDIF

  ELSE
    PMFU (JL, JK)=0.0_JPRB
    PMFD (JL, JK)=0.0_JPRB
    PMFUS (JL, JK)=0.0_JPRB
    PMFDS (JL, JK)=0.0_JPRB
    PMFUQ (JL, JK)=0.0_JPRB
    PMFDQ (JL, JK)=0.0_JPRB
    PMFUL (JL, JK)=0.0_JPRB
    PLGLAC (JL, JK)=0.0_JPRB
    PDMFUP (JL, JK-1)=0.0_JPRB
    PDMFDP (JL, JK-1)=0.0_JPRB
    PLUDE (JL, JK-1)=0.0_JPRB
    PLUDELI (JL, JK-1, 1)=0.0_JPRB
    PLUDELI (JL, JK-1, 2)=0.0_JPRB
  ENDIF

  
ENDDO

PMFLXR (JL, KLEV+1)=0.0_JPRB
PMFLXS (JL, KLEV+1)=0.0_JPRB
PMFLXR (JL, 1)=0.0_JPRB
PMFLXS (JL, 1)=0.0_JPRB
PSNDE (JL, 1, 1)=0.0_JPRB
PSNDE (JL, 1, 2)=0.0_JPRB


IF (LDCUM (JL)) THEN
  IKB=KCBOT (JL)
  IK=IKB+1
  ZZP=((PAPH (JL, KLEV+1)-PAPH (JL, IK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))

  IF (KTYPE (JL)==3)  THEN
    ZZP=ZZP*ZZP
  ENDIF

  PMFU (JL, IK)=PMFU (JL, IKB)*ZZP

  IF (YDEPHLI%LPHYLIN) THEN
    ZTARG=PTENH (JL, IKB)
    ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
    ZOELHM=ZOEALFA*YDCST%RLVTT+(1.0_JPRB-ZOEALFA)*YDCST%RLSTT
    PMFUS (JL, IK)=(PMFUS (JL, IKB)-ZOELHM*PMFUL (JL, IKB))*ZZP
  ELSE
    PMFUS (JL, IK)=(PMFUS (JL, IKB)-FOELHMCU (PTENH (JL, IKB))*PMFUL (JL, IKB))*ZZP
  ENDIF

  PMFUQ (JL, IK)=(PMFUQ (JL, IKB)+PMFUL (JL, IKB))*ZZP
  PMFUL (JL, IK)=0.0_JPRB
ENDIF



DO JK=KTOPM2, KLEV

  

  IF (LDCUM (JL).AND.JK>KCBOT (JL)+1) THEN
    IKB=KCBOT (JL)+1
    ZZP=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))

    IF (KTYPE (JL)==3)  THEN
      ZZP=ZZP*ZZP
    ENDIF

    PMFU (JL, JK)=PMFU (JL, IKB)*ZZP
    PMFUS (JL, JK)=PMFUS (JL, IKB)*ZZP
    PMFUQ (JL, JK)=PMFUQ (JL, IKB)*ZZP
    PMFUL (JL, JK)=0.0_JPRB
  ENDIF

  IK=IDBAS 
  LLDDRAF=LDDRAF (JL).AND.JK>IK.AND.IK<KLEV

  IF (LLDDRAF.AND.IK==KCBOT (JL)+1) THEN
    ZZP=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IK)))

    IF (KTYPE (JL)==3)  THEN
      ZZP=ZZP*ZZP
    ENDIF

    PMFD (JL, JK)=PMFD (JL, IK)*ZZP
    PMFDS (JL, JK)=PMFDS (JL, IK)*ZZP
    PMFDQ (JL, JK)=PMFDQ (JL, IK)*ZZP
    PMFDDE_RATE (JL, JK)=-(PMFD (JL, JK-1)-PMFD (JL, JK))
  ELSEIF (LLDDRAF.AND.IK/=KCBOT (JL)+1.AND.JK==IK+1) THEN
    PMFDDE_RATE (JL, JK)=-(PMFD (JL, JK-1)-PMFD (JL, JK))
  ENDIF

  
ENDDO

ZMFS =1.0_JPRB

DO JK=2, KLEV

  

  IF (LDDRAF (JL).AND.JK>=KDTOP (JL)-1) THEN
    ZMFMAX=ABS (PMFU (JL, JK))*0.98_JPRB

    IF (PMFD (JL, JK)+ZMFMAX+1.E-15_JPRB<0.0_JPRB) THEN
      ZMFS =MIN (ZMFS ,-ZMFMAX/PMFD (JL, JK))
    ENDIF

  ENDIF

  
ENDDO


DO JK=2, KLEV

  

  IF (ZMFS <1.0_JPRB.AND.JK>=KDTOP (JL)-1) THEN
    PMFD (JL, JK)=PMFD (JL, JK)*ZMFS 
    PMFDS (JL, JK)=PMFDS (JL, JK)*ZMFS 
    PMFDQ (JL, JK)=PMFDQ (JL, JK)*ZMFS 
    PMFDDE_RATE (JL, JK)=PMFDDE_RATE (JL, JK)*ZMFS 
    PDMFDP (JL, JK)=PDMFDP (JL, JK)*ZMFS 
  ENDIF

  
ENDDO


DO JK=KTOPM2, KLEV

  

  IF (LDCUM (JL).AND.JK>=KCTOP (JL)-1) THEN
    PRAIN (JL)=PRAIN (JL)+PDMFUP (JL, JK)
    ZTWETB=PTEN (JL, JK)-MAX (0.0_JPRB, PQSEN (JL, JK)-PQEN (JL, JK&
    &))*(ZTW1+ZTW2*(PAP (JL, JK)-ZTW3)-ZTW4*(PTEN (JL, JK)-ZTW5))
    ZTEN=ZTWETB*ZWETB+(1.0_JPRB-ZWETB)*PTEN (JL, JK)

    IF (PMFLXS (JL, JK)>0.0_JPRB.AND.ZTEN>YDCST%RTT) THEN
      ZCONS1=ZCONS1A*(1.0_JPRB+0.5_JPRB*(ZTEN-YDCST%RTT))
      ZFAC=ZCONS1*(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZSNMLT=MIN (PMFLXS (JL, JK), ZFAC*(ZTEN-YDCST%RTT))
      PDPMEL (JL, JK)=ZSNMLT

      IF (YDEPHLI%LPHYLIN) THEN
        ZTARG=ZTEN-ZSNMLT/ZFAC
        ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB))
        ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
        ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
        ZOEEWM=ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI
        PQSEN (JL, JK)=ZOEEWM/PAP (JL, JK)
      ELSE
        PQSEN (JL, JK)=FOEEWMCU (ZTEN-ZSNMLT/ZFAC)/PAP (JL, JK)
      ENDIF

    ENDIF


    IF (YDEPHLI%LPHYLIN) THEN
      ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(ZTEN-YDEPHLI%RLPTRC))+1.0_JPRB))
    ELSE
      ZALFAW=FOEALFCU (ZTEN)
    ENDIF


    IF (PTEN (JL, JK)<=YDCST%RTT.AND.ZALFAW>0.0_JPRB) THEN
      PLGLAC (JL, JK)=PLGLAC (JL, JK)+ZGLAC*ZALFAW*PDMFUP (JL, JK)+ZALFAW*PDMFDP (JL, JK)
      ZALFAW=0.0_JPRB
    ENDIF


    IF (YDECUMF%LMFDSNOW.AND.JK<=KCBOT (JL)) THEN
      PSNDE (JL, JK, 2)=PLRAIN (JL, JK+1)*PMFUDE_RATE (JL, JK)
      PSNDE (JL, JK, 1)=PSNDE (JL, JK, 2)*ZALFAW
      PSNDE (JL, JK, 2)=PSNDE (JL, JK, 2)*(1.0_JPRB-ZALFAW)
      PSNDE (JL, JK, 1)=MIN (PSNDE (JL, JK, 1), ZALFAW*(PDMFUP (JL, JK)+PDMFDP (JL, JK)))
      PSNDE (JL, JK, 2)=MIN (PSNDE (JL, JK, 2),(1.0_JPRB-ZALFAW&
      &)*(PDMFUP (JL, JK)+PDMFDP (JL, JK))-PDPMEL (JL, JK))
      PSNDE (JL, JK, 1)=MAX (PSNDE (JL, JK, 1), 0.0_JPRB)
      PSNDE (JL, JK, 2)=MAX (PSNDE (JL, JK, 2), 0.0_JPRB)
    ENDIF

    PMFLXR (JL, JK+1)=PMFLXR (JL, JK)+ZALFAW*(PDMFUP (JL, JK&
    &)+PDMFDP (JL, JK))+PDPMEL (JL, JK)-PSNDE (JL, JK, 1)
    PMFLXS (JL, JK+1)=PMFLXS (JL, JK)+(1.0_JPRB-ZALFAW)*(PDMFUP (JL&
    &, JK)+PDMFDP (JL, JK))-PDPMEL (JL, JK)-PSNDE (JL, JK, 2)

    IF (PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1)<0.0_JPRB) THEN
      PDMFDP (JL, JK)=-(PMFLXR (JL, JK)+PMFLXS (JL, JK)+PDMFUP (JL, JK))
      PMFLXR (JL, JK+1)=0.0_JPRB
      PMFLXS (JL, JK+1)=0.0_JPRB
      PDPMEL (JL, JK)=0.0_JPRB
    ELSEIF (PMFLXR (JL, JK+1)<0.0_JPRB) THEN
      PMFLXS (JL, JK+1)=PMFLXS (JL, JK+1)+PMFLXR (JL, JK+1)
      PMFLXR (JL, JK+1)=0.0_JPRB
    ELSEIF (PMFLXS (JL, JK+1)<0.0_JPRB) THEN
      PMFLXR (JL, JK+1)=PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1)
      PMFLXS (JL, JK+1)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO


IF (.NOT.LDTDKMF) THEN

  

  IF (KTYPE (JL)>=2) THEN
    IKB=KCBOT (JL)
    IK=KCTOP (JL)
    ZRHM=0.5*(PQEN (JL, IKB)/PQSEN (JL, IKB)+PQEN (JL, IK)/PQSEN (JL, IK))
    ZRCUCOV =YDECUMF%RCUCOV*(1.0_JPRB+(MAX (0.8_JPRB, ZRHM)-0.8_JPRB)/0.025_JPRB)
  ELSE
    ZRCUCOV =YDECUMF%RCUCOV*0.6
  ENDIF

  
ELSE
  
  ZRCUCOV =YDECUMF%RCUCOV
  
ENDIF


DO JK=KTOPM2, KLEV

  

  IF (LDCUM (JL).AND.JK>=KCBOT (JL)) THEN
    ZRFL=PMFLXR (JL, JK)+PMFLXS (JL, JK)

    IF (ZRFL>1.E-12_JPRB) THEN
      ZDRFL1=YDECUMF%RCPECONS*MAX (0.0_JPRB, PQSEN (JL, JK)-PQEN (JL, JK))*ZRCUCOV *(SQRT (PAPH (JL, JK)/PAPH&
      & (JL, KLEV+1))/YDECUMF%RCVRFACTOR*ZRFL/ZRCUCOV )**0.5777_JPRB*(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZRNEW=ZRFL-ZDRFL1
      ZRMIN=ZRFL-ZRCUCOV *MAX (0.0_JPRB, ZRHEBC *PQSEN (JL, JK)&
      &-PQEN (JL, JK))*ZCONS2*(PAPH (JL, JK+1)-PAPH (JL, JK))
      ZRNEW=MAX (ZRNEW, ZRMIN)
      ZRFLN=MAX (ZRNEW, 0.0_JPRB)
      ZDRFL=MIN (0.0_JPRB, ZRFLN-ZRFL)

      IF (YDEPHLI%LPHYLIN) THEN
        ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JL, JK)-YDEPHLI%RLPTRC))+1.0_JPRB))
      ELSE
        ZALFAW=FOEALFCU (PTEN (JL, JK))
      ENDIF


      IF (PTEN (JL, JK)<YDCST%RTT)  THEN
        ZALFAW=0.0_JPRB
      ENDIF

      ZPDR=ZALFAW*PDMFDP (JL, JK)
      ZPDS=(1.0_JPRB-ZALFAW)*PDMFDP (JL, JK)
      ZDENOM=1.0_JPRB/MAX (1.E-12_JPRB, PMFLXR (JL, JK)+PMFLXS (JL, JK))
      PMFLXR (JL, JK+1)=PMFLXR (JL, JK)+ZPDR+PDPMEL (JL, JK)+ZDRFL*PMFLXR (JL, JK)*ZDENOM
      PMFLXS (JL, JK+1)=PMFLXS (JL, JK)+ZPDS-PDPMEL (JL, JK)+ZDRFL*PMFLXS (JL, JK)*ZDENOM
      PDMFUP (JL, JK)=PDMFUP (JL, JK)+ZDRFL

      IF (PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1)<0.0_JPRB) THEN
        PDMFUP (JL, JK)=PDMFUP (JL, JK)-(PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1))
        PMFLXR (JL, JK+1)=0.0_JPRB
        PMFLXS (JL, JK+1)=0.0_JPRB
        PDPMEL (JL, JK)=0.0_JPRB
      ELSEIF (PMFLXR (JL, JK+1)<0.0_JPRB) THEN
        PMFLXS (JL, JK+1)=PMFLXS (JL, JK+1)+PMFLXR (JL, JK+1)
        PMFLXR (JL, JK+1)=0.0_JPRB
      ELSEIF (PMFLXS (JL, JK+1)<0.0_JPRB) THEN
        PMFLXR (JL, JK+1)=PMFLXR (JL, JK+1)+PMFLXS (JL, JK+1)
        PMFLXS (JL, JK+1)=0.0_JPRB
      ENDIF

    ELSE
      PMFLXR (JL, JK+1)=0.0_JPRB
      PMFLXS (JL, JK+1)=0.0_JPRB
      PDMFDP (JL, JK)=0.0_JPRB
      PDPMEL (JL, JK)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO



END SUBROUTINE CUFLXN_OPENACC
