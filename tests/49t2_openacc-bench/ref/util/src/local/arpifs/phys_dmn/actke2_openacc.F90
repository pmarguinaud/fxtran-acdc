SUBROUTINE ACTKE2_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIAT, KTDIAN&
&, KLEV, PAPHI, PAPHIF, PAPRS, PAPRSF, PDELP, PR, PT, PU, PV, PECT, PPRODTH,&
& PKUROV, PUSLE, PKCLS, PECTCLS, PFECT, PECT1, PTPRDY, PEDR, YDSTACK)
!$ACC ROUTINE (ACTKE2_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIAT
INTEGER (KIND=JPIM), INTENT (IN)::KTDIAN
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PECT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PPRODTH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PECT1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFECT (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PTPRDY (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEDR (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (IN)::PUSLE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PKCLS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PECTCLS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PKUROV (KLON, 0:KLEV)
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
fxtran_acdc_temp (REAL (KIND=JPRB), ZPRDY, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDISS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDIFF, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZECT1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZECT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDELPSG, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDET, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEDR, (KLON, KLEV))

#include "acevolet_openacc.intfb.h"
#include "hl2fl_openacc.intfb.h"
#include "fl2hl_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZPRDY) == 8) THEN
    fxtran_acdc_alloc8 (ZPRDY)
ELSEIF (KIND (ZPRDY) == 4) THEN
    fxtran_acdc_alloc4 (ZPRDY)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDISS) == 8) THEN
    fxtran_acdc_alloc8 (ZDISS)
ELSEIF (KIND (ZDISS) == 4) THEN
    fxtran_acdc_alloc4 (ZDISS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDIFF) == 8) THEN
    fxtran_acdc_alloc8 (ZDIFF)
ELSEIF (KIND (ZDIFF) == 4) THEN
    fxtran_acdc_alloc4 (ZDIFF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZECT1) == 8) THEN
    fxtran_acdc_alloc8 (ZECT1)
ELSEIF (KIND (ZECT1) == 4) THEN
    fxtran_acdc_alloc4 (ZECT1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZECT) == 8) THEN
    fxtran_acdc_alloc8 (ZECT)
ELSEIF (KIND (ZECT) == 4) THEN
    fxtran_acdc_alloc4 (ZECT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDELPSG) == 8) THEN
    fxtran_acdc_alloc8 (ZDELPSG)
ELSEIF (KIND (ZDELPSG) == 4) THEN
    fxtran_acdc_alloc4 (ZDELPSG)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDET) == 8) THEN
    fxtran_acdc_alloc8 (ZDET)
ELSEIF (KIND (ZDET) == 4) THEN
    fxtran_acdc_alloc4 (ZDET)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEDR) == 8) THEN
    fxtran_acdc_alloc8 (ZEDR)
ELSEIF (KIND (ZEDR) == 4) THEN
    fxtran_acdc_alloc4 (ZEDR)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



PEDR (JLON,:)=0.0_JPRB
PTPRDY (JLON,:)=0.0_JPRB
ZDET (JLON,:)=0.0_JPRB
ZDELPSG (JLON,:)=0.0_JPRB

IF (YDML_PHY_MF%YRPHY%LECTFL) THEN
  CALL FL2HL_OPENACC (KIDIA, KFDIA, KLON, 1, KLEV, PAPRS, PAPRSF, PECT, ZECT, 1, YDSTACK=YLSTACK)
ELSE

  DO JLEV=1, KLEV
    
    ZECT (JLON, JLEV)=PECT (JLON, JLEV)
  
  ENDDO

ENDIF


DO JLEV=KTDIAT, KLEV
  
  ZECT (JLON, JLEV)=MAX (YDML_PHY_MF%YRPHY0%ECTMIN, ZECT (JLON, JLEV))
  ZDELPSG (JLON, JLEV)=PDELP (JLON, JLEV)/YDCST%RG
  
ENDDO

CALL ACEVOLET_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIAT, KTDIAN,&
& KLEV, PAPHI, PAPHIF, PAPRS, PAPRSF, PDELP, ZECT, PKUROV, PR, PT, PU, PV, PUSLE&
&, PPRODTH, PKCLS, PECTCLS, ZECT1, ZPRDY, ZDIFF, ZDISS, YDSTACK=YLSTACK)
PECT1 (JLON,:)=YDML_PHY_MF%YRPHY0%ECTMIN

DO JLEV=KTDIAT, KLEV
  
  ZEDR (JLON, JLEV)=MIN (100._JPRB, PUSLE (JLON, JLEV)*YDCST%RG&
  &)*(0.5_JPRB*(ZECT1 (JLON, JLEV)+PECT (JLON, JLEV)))**1.5
  
ENDDO


IF (YDML_PHY_MF%YRPHY%LECTFL) THEN
  CALL HL2FL_OPENACC (KIDIA, KFDIA, KLON, 1, KLEV, PAPRS, PAPRSF, ZECT1, 1, PECT1, YDSTACK=YLSTACK)

  DO JLEV=KTDIAT, KLEV
    
    ZDET (JLON, JLEV)=(PECT1 (JLON, JLEV)-PECT (JLON, JLEV))/YDML_PHY_MF%YRPHY2%TSPHY
  
  ENDDO

  CALL HL2FL_OPENACC (KIDIA, KFDIA, KLON, 1, KLEV, PAPRS, PAPRSF, ZPRDY, 1, PTPRDY, YDSTACK=YLSTACK)
  CALL HL2FL_OPENACC (KIDIA, KFDIA, KLON, 1, KLEV, PAPRS, PAPRSF, ZEDR, 1, PEDR, YDSTACK=YLSTACK)
ELSE

  DO JLEV=KTDIAT, KLEV
    
    ZDET (JLON, JLEV)=(ZECT1 (JLON, JLEV)-PECT (JLON, JLEV))/YDML_PHY_MF%YRPHY2%TSPHY
    PECT1 (JLON, JLEV)=ZECT1 (JLON, JLEV)
    PTPRDY (JLON, JLEV)=ZPRDY (JLON, JLEV)
    PEDR (JLON, JLEV)=ZEDR (JLON, JLEV)
  
  ENDDO

ENDIF


DO JLEV=KTDIAT, KLEV
  
  PFECT (JLON, JLEV)=PFECT (JLON, JLEV-1)-ZDET (JLON, JLEV)*ZDELPSG (JLON, JLEV)
  
ENDDO



END SUBROUTINE ACTKE2_OPENACC
