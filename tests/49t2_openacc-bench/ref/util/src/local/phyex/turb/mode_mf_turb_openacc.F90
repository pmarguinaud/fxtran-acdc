
MODULE MODE_MF_TURB_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE MF_TURB_OPENACC (D, KSV, OMIXUV, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PIMPL&
&, PTSTEP, PDZZ, PRHODJ, PTHLM, PTHVM, PRTM, PUM, PVM, PSVM, PTHLDT, PRTDT, PUDT&
&, PVDT, PSVDT, PEMF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP, PSV_UP, PFLXZTHMF&
&, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, PFLXZSVMF, YDSTACK)
!$ACC ROUTINE (MF_TURB_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODI_SHUMAN_MF,ONLY:MZM_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZM_MF_OPENACC
USE MODE_TRIDIAG_MASSFLUX,ONLY:TRIDIAG_MASSFLUX
USE MODE_TRIDIAG_MASSFLUX_OPENACC,ONLY:TRIDIAG_MASSFLUX_OPENACC

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::OMIXUV
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PIMPL
REAL, INTENT (IN)::PTSTEP
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PTHLDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRTDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PUDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PVDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSVDT(D%NIJT, D%NKT, KSV)
REAL, INTENT (IN)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSV_UP(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PFLXZVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZUMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZRMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZSVMF(D%NIJT, D%NKT, KSV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL, ZEMFO, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZVARS, (D%NIJT, D%NKT))
INTEGER::JSV
INTEGER::JK
INTEGER::JI
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT


YLSTACK = YDSTACK



IF (KIND (ZEMFO) == 8) THEN
    fxtran_acdc_alloc8 (ZEMFO)
ELSEIF (KIND (ZEMFO) == 4) THEN
    fxtran_acdc_alloc4 (ZEMFO)
ELSE
    STOP 1
ENDIF


IF (KIND (ZVARS) == 8) THEN
    fxtran_acdc_alloc8 (ZVARS)
ELSEIF (KIND (ZVARS) == 4) THEN
    fxtran_acdc_alloc4 (ZVARS)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
PFLXZSVMF(JI,:,:)=0.
PSVDT(JI,:,:)=0.
ZEMFO(JI,:)=-PEMF(JI,:)
CALL MZM_MF_OPENACC (D, PTHLM (:,:), PFLXZTHMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), PFLXZRMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTHVM (:,:), PFLXZTHVMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  PFLXZTHMF (JI, JK)=PEMF (JI, JK)*(PTHL_UP (JI, JK)-PFLXZTHMF (JI, JK))
  PFLXZRMF (JI, JK)=PEMF (JI, JK)*(PRT_UP (JI, JK)-PFLXZRMF (JI, JK))
  PFLXZTHVMF (JI, JK)=PEMF (JI, JK)*(PTHV_UP (JI, JK)-PFLXZTHVMF (JI, JK))
  
ENDDO


IF (OMIXUV) THEN
  CALL MZM_MF_OPENACC (D, PUM (:,:), PFLXZUMF (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PVM (:,:), PFLXZVMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    PFLXZUMF (JI, JK)=PEMF (JI, JK)*(PU_UP (JI, JK)-PFLXZUMF (JI, JK))
    PFLXZVMF (JI, JK)=PEMF (JI, JK)*(PV_UP (JI, JK)-PFLXZVMF (JI, JK))
  
  ENDDO

ELSE
  PFLXZUMF (JI,:)=0.
  PFLXZVMF (JI,:)=0.
ENDIF

CALL TRIDIAG_MASSFLUX_OPENACC (D, PTHLM, PFLXZTHMF, ZEMFO&
&, PTSTEP, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZTHMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  PFLXZTHMF (JI, JK)=PEMF (JI, JK)*(PTHL_UP (JI, JK)-PFLXZTHMF (JI, JK))
  PTHLDT (JI, JK)=(ZVARS (JI, JK)-PTHLM (JI, JK))/PTSTEP
  
ENDDO

CALL TRIDIAG_MASSFLUX_OPENACC (D, PRTM (:,:), PFLXZRMF, ZEMFO&
&, PTSTEP, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZRMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  PFLXZRMF (JI, JK)=PEMF (JI, JK)*(PRT_UP (JI, JK)-PFLXZRMF (JI, JK))
  PRTDT (JI, JK)=(ZVARS (JI, JK)-PRTM (JI, JK))/PTSTEP
  
ENDDO


IF (OMIXUV) THEN
  CALL TRIDIAG_MASSFLUX_OPENACC (D, PUM, PFLXZUMF, ZEMFO, PTSTEP&
  &, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZUMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    PFLXZUMF (JI, JK)=PEMF (JI, JK)*(PU_UP (JI, JK)-PFLXZUMF (JI, JK))
    PUDT (JI, JK)=(ZVARS (JI, JK)-PUM (JI, JK))/PTSTEP
  
  ENDDO

  CALL TRIDIAG_MASSFLUX_OPENACC (D, PVM, PFLXZVMF, ZEMFO, PTSTEP&
  &, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZVMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    PFLXZVMF (JI, JK)=PEMF (JI, JK)*(PV_UP (JI, JK)-PFLXZVMF (JI, JK))
    PVDT (JI, JK)=(ZVARS (JI, JK)-PVM (JI, JK))/PTSTEP
  
  ENDDO

ELSE
  PUDT (JI,:)=0.
  PVDT (JI,:)=0.
ENDIF


DO JSV=1, KSV

  IF (ONOMIXLG.AND.JSV>=KSV_LGBEG.AND.JSV<=KSV_LGEND)  THEN
    CYCLE
  ENDIF

  CALL MZM_MF_OPENACC (D, PSVM (:,:, JSV), PFLXZSVMF (:,:, JSV), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    PFLXZSVMF (JI, JK, JSV)=PEMF (JI, JK)*(PSV_UP (JI, JK, JSV)-PFLXZSVMF (JI, JK, JSV))
  
  ENDDO

  CALL TRIDIAG_MASSFLUX_OPENACC (D, PSVM (:,:, JSV), PFLXZSVMF (:,:, JSV&
  &), ZEMFO, PTSTEP, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, ZVARS, PFLXZSVMF (:,:, JSV), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    PFLXZSVMF (JI, JK, JSV)=PEMF (JI, JK)*(PSV_UP (JI, JK, JSV)-PFLXZSVMF (JI, JK, JSV))
    PSVDT (JI, JK, JSV)=(ZVARS (JI, JK)-PSVM (JI, JK, JSV))/PTSTEP
  
  ENDDO

ENDDO


END SUBROUTINE MF_TURB_OPENACC

ENDMODULE MODE_MF_TURB_OPENACC
