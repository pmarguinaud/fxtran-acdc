#!/usr/bin/env perl 

=head1 NAME

fxtran-cxx

=head1 DESCRIPTION

This script is a wrapper for the C and the C++ compilers. The ACDC library is included in the link,
and archive may be replaced by list of objects if the script is invoked to perform a link.

=head1 AUTHOR

philippe.marguinaud@meteo.fr

=head1 COPYRIGHT

Meteo-France 2025

=cut

use warnings;

use FindBin qw ($Bin);
use lib "$Bin/../lib";

use Fxtran::Common;

use Data::Dumper;
use Getopt::Long;

use strict;

use Fxtran::AR;

my @opts_f = qw ();
my @opts_s = qw (config prefix);

my %opts;

&GetOptions
(
  (map { ($_, \$opts{$_}) } @opts_f),
  (map { ("$_=s", \$opts{$_}) } @opts_s),
);

my @argv;

my $seen_flang_rt_hostdevice; # Specific to ROCM

for (my $i = 0; $i < scalar (@ARGV); $i++)
  {
    if ($ARGV[$i] eq '-lflang_rt.hostdevice')
      {
        push @argv, $ARGV[$i] unless ($seen_flang_rt_hostdevice++);
      }
    else
      {
        push @argv, $ARGV[$i];
      }
  }

unless ($ENV{FXTRAN_BOOT})
  {
    push @argv, "-L$opts{prefix}/lib", '-lFxtranACDC' if ($opts{prefix});
  }

if (grep { $_ eq '-c' } @argv)
  {
    exec (@argv);
  }

&Fxtran::AR::expandObjects (\@argv);

exec (@argv);


