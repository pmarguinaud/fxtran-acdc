
SUBROUTINE ACRALU_OPENACC (YDRIP, YDPHY3, KIDIA, KFDIA, KLON, KTDIA, KLEV, PAPRS, PAPRSF,&
& PDELP, PNEB, PQ, PQCO2, PQICE, PQLI, PQO3, PT, PALB, PMU0LU, PFRSOLU, PDAER, YDSTACK)
!$ACC ROUTINE (ACRALU_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPRD

USE YOMPHY3,ONLY:TPHY3
USE YOMRIP,ONLY:TRIP
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TPHY3), INTENT (IN)::YDPHY3
TYPE (TRIP), INTENT (IN)::YDRIP
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQCO2 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQICE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQO3 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PALB (KLON)
REAL (KIND=JPRB), INTENT (IN)::PMU0LU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOLU (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDAER (KLON, KLEV, 6)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRSO, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTU6, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTU2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFPC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFMC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFDC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQICE, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQLI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUUEOT, (KLON, KLEV))
REAL (KIND=JPRB)::ZII0 
REAL (KIND=JPRB)::ZMU0 
REAL (KIND=JPRB)::ZUSN 
REAL (KIND=JPRB)::ZUSI 
REAL (KIND=JPRB)::ZUETS 
REAL (KIND=JPRB)::ZRTO 
REAL (KIND=JPRB)::ZRTH 
REAL (KIND=JPRB)::ZRTC 
REAL (KIND=JPRB)::ZRSO 
REAL (KIND=JPRB)::ZRSH 
REAL (KIND=JPRB)::ZRSC 
REAL (KIND=JPRB)::ZNTO 
REAL (KIND=JPRB)::ZNTH 
REAL (KIND=JPRB)::ZNTC 
REAL (KIND=JPRB)::ZNSOR 
REAL (KIND=JPRB)::ZNSO 
REAL (KIND=JPRB)::ZNSH 
REAL (KIND=JPRB)::ZNSC 
REAL (KIND=JPRB)::ZMU0I 
REAL (KIND=JPRB)::ZEOTS 
REAL (KIND=JPRB)::ZEOTO 
REAL (KIND=JPRB)::ZEOT 
REAL (KIND=JPRB)::ZEOSS 
REAL (KIND=JPRB)::ZEOSO 
REAL (KIND=JPRB)::ZEOS 
REAL (KIND=JPRB)::ZDM0I 
REAL (KIND=JPRB)::ZCTH 
REAL (KIND=JPRB)::ZA5N 
REAL (KIND=JPRB)::ZA5C 
REAL (KIND=JPRB)::ZA4N 
REAL (KIND=JPRB)::ZA4C 
REAL (KIND=JPRB)::ZA3N 
REAL (KIND=JPRB)::ZA3C 
REAL (KIND=JPRB)::ZA2N 
REAL (KIND=JPRB)::ZA2C 
REAL (KIND=JPRB)::ZA1N 
REAL (KIND=JPRB)::ZA1C 
REAL (KIND=JPRB)::ZUUETS 
REAL (KIND=JPRB)::ZG4B (6)
REAL (KIND=JPRB)::ZGAS2B (6)
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JGA
INTEGER (KIND=JPIM)::JAE
REAL (KIND=JPRB)::ZUSA
REAL (KIND=JPRB)::ZZEO2SA
REAL (KIND=JPRB)::ZEPSNEB
REAL (KIND=JPRB)::ZEPSEXC
REAL (KIND=JPRB)::ZTES
REAL (KIND=JPRB)::ZDES
REAL (KIND=JPRB)::ZASC
REAL (KIND=JPRB)::ZWTO
REAL (KIND=JPRB)::ZWTH
REAL (KIND=JPRB)::ZWTC
REAL (KIND=JPRB)::ZWSO
REAL (KIND=JPRB)::ZWSH
REAL (KIND=JPRB)::ZWSC
REAL (KIND=JPRB)::ZTI
REAL (KIND=JPRB)::ZTDS1
REAL (KIND=JPRB)::ZTD4
REAL (KIND=JPRB)::ZTD1
REAL (KIND=JPRB)::ZTAU
REAL (KIND=JPRB)::ZT4I
REAL (KIND=JPRB)::ZT3
REAL (KIND=JPRB)::ZT2I
REAL (KIND=JPRB)::ZT2
REAL (KIND=JPRB)::ZRT
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZQ
REAL (KIND=JPRB)::ZP
REAL (KIND=JPRB)::ZMU0IN
REAL (KIND=JPRB)::ZMU0IC
REAL (KIND=JPRB)::ZMD
REAL (KIND=JPRB)::ZIEART
REAL (KIND=JPRB)::ZG2
REAL (KIND=JPRB)::ZG1
REAL (KIND=JPRB)::ZEPSAL
REAL (KIND=JPRB)::ZEPS3
REAL (KIND=JPRB)::ZEPS2
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZEOSN
REAL (KIND=JPRB)::ZEOSI
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSA, (KLON, KLEV))
REAL (KIND=JPRB)::ZEO5
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO4SA, (KLON, KLEV))
REAL (KIND=JPRB)::ZEO4
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO3SA, (KLON, KLEV))
REAL (KIND=JPRB)::ZEO3
REAL (KIND=JPRB)::ZEO2SN
REAL (KIND=JPRB)::ZEO2SI
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2SA, (KLON, KLEV))
REAL (KIND=JPRB)::ZEO2
REAL (KIND=JPRB)::ZEO1SN
REAL (KIND=JPRB)::ZEO1SI
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1SA, (KLON, KLEV))
REAL (KIND=JPRB)::ZEO1
REAL (KIND=JPRB)::ZEO
REAL (KIND=JPRB)::ZEARRT
REAL (KIND=JPRB)::ZDUO
REAL (KIND=JPRB)::ZDUH
REAL (KIND=JPRB)::ZDUC
REAL (KIND=JPRB)::ZARGLI
REAL (KIND=JPRB)::ZALP
REAL (KIND=JPRB)::ZAL
REAL (KIND=JPRD)::ZTDETA


YLSTACK = YDSTACK



IF (KIND (ZFRSO) == 8) THEN
    fxtran_acdc_alloc8 (ZFRSO)
ELSEIF (KIND (ZFRSO) == 4) THEN
    fxtran_acdc_alloc4 (ZFRSO)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOT) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOT)
ELSEIF (KIND (ZUEOT) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOS) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOS)
ELSEIF (KIND (ZUEOS) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTU6) == 8) THEN
    fxtran_acdc_alloc8 (ZTU6)
ELSEIF (KIND (ZTU6) == 4) THEN
    fxtran_acdc_alloc4 (ZTU6)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTU2) == 8) THEN
    fxtran_acdc_alloc8 (ZTU2)
ELSEIF (KIND (ZTU2) == 4) THEN
    fxtran_acdc_alloc4 (ZTU2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFPC) == 8) THEN
    fxtran_acdc_alloc8 (ZFPC)
ELSEIF (KIND (ZFPC) == 4) THEN
    fxtran_acdc_alloc4 (ZFPC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFMC) == 8) THEN
    fxtran_acdc_alloc8 (ZFMC)
ELSEIF (KIND (ZFMC) == 4) THEN
    fxtran_acdc_alloc4 (ZFMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFDC) == 8) THEN
    fxtran_acdc_alloc8 (ZFDC)
ELSEIF (KIND (ZFDC) == 4) THEN
    fxtran_acdc_alloc4 (ZFDC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOT) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOT)
ELSEIF (KIND (ZDEOT) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOS) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOS)
ELSEIF (KIND (ZDEOS) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB1) == 8) THEN
    fxtran_acdc_alloc8 (ZB1)
ELSEIF (KIND (ZB1) == 4) THEN
    fxtran_acdc_alloc4 (ZB1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQICE) == 8) THEN
    fxtran_acdc_alloc8 (ZQICE)
ELSEIF (KIND (ZQICE) == 4) THEN
    fxtran_acdc_alloc4 (ZQICE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQLI) == 8) THEN
    fxtran_acdc_alloc8 (ZQLI)
ELSEIF (KIND (ZQLI) == 4) THEN
    fxtran_acdc_alloc4 (ZQLI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUUEOT) == 8) THEN
    fxtran_acdc_alloc8 (ZUUEOT)
ELSEIF (KIND (ZUUEOT) == 4) THEN
    fxtran_acdc_alloc4 (ZUUEOT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSA) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSA)
ELSEIF (KIND (ZEOSA) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO4SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO4SA)
ELSEIF (KIND (ZEO4SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO4SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO3SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO3SA)
ELSEIF (KIND (ZEO3SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO3SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2SA)
ELSEIF (KIND (ZEO2SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1SA)
ELSEIF (KIND (ZEO1SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1SA)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPSNEB=1.E-10_JPRB

DO JLEV=KTDIA, KLEV
  
  ZQLI (JLON, JLEV)=PQLI (JLON, JLEV)/MAX (ZEPSNEB, PNEB (JLON, JLEV))
  ZQICE (JLON, JLEV)=PQICE (JLON, JLEV)/MAX (ZEPSNEB, PNEB (JLON, JLEV))
  
ENDDO


DO JGA=1, 6
  ZGAS2B (JGA)=YDPHY3%GCA(JGA)/(2.0_JPRB*YDPHY3%GCB(JGA))
  ZG4B (JGA)=4._JPRB*YDPHY3%GCB(JGA)
ENDDO

ZEO2SA(JLON,:)=0._JPRB
ZEO1SA(JLON,:)=0._JPRB
ZEOSA(JLON,:)=0._JPRB

DO JAE=1, 6

  DO JLEV=KTDIA, KLEV
    
    ZZEO2SA=2._JPRB*YDPHY3%BSFSA(JAE)*YDPHY3%EODSA(JAE)*PDAER (JLON, JLEV, JAE)
    ZEO2SA (JLON, JLEV)=ZEO2SA (JLON, JLEV)+ZZEO2SA
    ZEO1SA (JLON, JLEV)=ZEO1SA (JLON, JLEV)+ZZEO2SA+2._JPRB*YDPHY3%EOASA(JAE)*PDAER (JLON, JLEV, JAE)
    ZEOSA (JLON, JLEV)=ZEOSA (JLON, JLEV)+(YDPHY3%EODSA(JAE)+YDPHY3%EOASA(JAE))*PDAER (JLON, JLEV, JAE)
  
  ENDDO

ENDDO

ZEO2SI=2.0_JPRB*YDPHY3%BSFSI*YDPHY3%EODSI
ZEO1SI=ZEO2SI+2.0_JPRB*YDPHY3%EOASI
ZEO2SN=2.0_JPRB*YDPHY3%BSFSN*YDPHY3%EODSN
ZEO1SN=ZEO2SN+2.0_JPRB*YDPHY3%EOASN
ZEOSI=YDPHY3%EODSI+YDPHY3%EOASI
ZEOSN=YDPHY3%EODSN+YDPHY3%EOASN
ZEPS1=1.E-03_JPRB
ZEPS2=1.E-09_JPRB

IF (JPRB==JPRD) THEN
  ZEPS3=1.E-12_JPRB
ELSE
  ZEPS3=1.E-06_JPRB
ENDIF

ZEPSAL=1.E-04_JPRB
ZARGLI=-250._JPRB

ZMU0 =PMU0LU (JLON)
ZII0 =YDRIP%RIP0LU


ZII0 =ZII0 

ZMD=0.5_JPRB*EXP (0.5_JPRB)
ZEARRT=YDPHY3%EARRT*(YDPHY3%EARRT+2.0_JPRB)
ZIEART=1.0_JPRB/YDPHY3%EARRT

ZDM0I =0.5_JPRB*(SQRT (ZMU0 *ZMU0 +ZEARRT)-ZMU0 )*ZIEART


ZNSOR =2.0_JPRB*MAX (PAPRS (JLON, 0), ZEPS1)*PQO3 (JLON, 0)


DO JLEV=1, KTDIA-1
  
  ZNSOR =ZNSOR +2.0_JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)
  
ENDDO


ZP=MAX (ZEPS1, PAPRS (JLON, KTDIA-1))
ZQ=MAX (ZEPS2, PQ (JLON, KTDIA))
ZRT=SQRT (PT (JLON, KTDIA))
ZTI=1.0_JPRB/PT (JLON, KTDIA)
ZT2=PT (JLON, KTDIA)*PT (JLON, KTDIA)
ZT2I=ZTI*ZTI
ZT4I=ZT2I*ZT2I
ZTDETA=REAL (ZRT, JPRD)**49*REAL (EXP (REAL (YDPHY3%GCE4&
&, JPRD)/REAL (PT (JLON, KTDIA), JPRD)), JPRD)
ZT3=ZT2*PT (JLON, KTDIA)
ZNSH =(2.0_JPRB*ZP)*ZQ
ZNSC =(2.0_JPRB*ZP)*PQCO2 (JLON, KTDIA)
ZNSO =ZNSOR 
ZNTH =ZNSH *ZTI
ZNTC =ZNSC 
ZNTO =ZNSO *ZT2
ZRSH =ZNSH *(ZMD*0.5_JPRB*ZP)*ZRT
ZRSC =ZNSC *(ZMD*0.5_JPRB*ZP)*PT (JLON, KTDIA)
ZRSO =ZNSO *(ZMD*0.5_JPRB*ZP)*ZRT
ZRTH =ZRSH *ZT2I*ZRT
ZCTH =ZRTH *ZT4I*(1.0_JPRB+YDPHY3%GCD4*ZQ*ZTDETA)
ZRTC =ZRSC *PT (JLON, KTDIA)
ZRTO =ZRSO *ZT3*ZRT
ZNSH =ZNSH *ZDM0I 
ZNSC =ZNSC *ZDM0I 
ZNSO =ZNSO *ZDM0I 
ZRSH =ZRSH *(ZDM0I /ZMD)
ZRSC =ZRSC *(ZDM0I /ZMD)
ZRSO =ZRSO *(ZDM0I /ZMD)


ZWSH=(ZGAS2B (1)*(ZRSH /ZNSH ))*(SQRT (1.0_JPRB+ZG4B (1&
&)*ZNSH /(ZRSH /ZNSH ))-1.0_JPRB)+YDPHY3%GCC(1)*ZRSH 
ZWSC=(ZGAS2B (2)*(ZRSC /ZNSC ))*(SQRT (1.0_JPRB+ZG4B (2&
&)*ZNSC /(ZRSC /ZNSC ))-1.0_JPRB)+YDPHY3%GCC(2)*ZRSC 
ZWSO=(ZGAS2B (3)*(ZRSO /ZNSO ))*(SQRT (1.0_JPRB+ZG4B (3&
&)*ZNSO /(ZRSO /ZNSO ))-1.0_JPRB)+YDPHY3%GCC(3)*ZRSO 
ZEOS =(ZWSH*(1.0_JPRB+ZWSH*(YDPHY3%VNP(1, 1)+ZWSH*(YDPHY3%VNP(2, 1)+ZWSH*(YDPHY3%VNP(3, 1)&
&+ZWSH*(YDPHY3%VNP(4, 1)+ZWSH*YDPHY3%VNP(5, 1)))))))/(1.0_JPRB+ZWSH*(YDPHY3%VDP(1, 1)+ZWSH&
&*(YDPHY3%VDP(2, 1)+ZWSH*(YDPHY3%VDP(3, 1)+ZWSH*(YDPHY3%VDP(4, 1)+ZWSH*YDPHY3%VDP(5, 1))))&
&))+(ZWSC*(1.0_JPRB+ZWSC*(YDPHY3%VNP(1, 2)+ZWSC*(YDPHY3%VNP(2, 2)+ZWSC*(YDPHY3%VNP(3, 2)+ZWSC&
&*(YDPHY3%VNP(4, 2)+ZWSC*YDPHY3%VNP(5, 2)))))))/(1.0_JPRB+ZWSC*(YDPHY3%VDP(1, 2)+ZWSC*(YDPHY3&
&%VDP(2, 2)+ZWSC*(YDPHY3%VDP(3, 2)+ZWSC*(YDPHY3%VDP(4, 2)+ZWSC*YDPHY3%VDP(5, 2))))))+(ZWSO&
&*(1.0_JPRB+ZWSO*(YDPHY3%VNP(1, 3)+ZWSO*(YDPHY3%VNP(2, 3)+ZWSO*YDPHY3%VNP(3, 3)))))/(1.0_JPRB&
&+ZWSO*(YDPHY3%VDP(1, 3)+ZWSO*(YDPHY3%VDP(2, 3)+ZWSO*YDPHY3%VDP(3, 3))))
ZEOSS =ZEOS /ZDM0I 


ZWTH=(ZGAS2B (4)*(ZRTH /ZNTH ))*(SQRT (1.0_JPRB+ZG4B (4&
&)*ZNTH /(ZRTH /ZNTH ))-1.0_JPRB)+YDPHY3%GCC(4)*ZCTH 
ZWTC=(ZGAS2B (5)*(ZRTC /ZNTC ))*(SQRT (1.0_JPRB+ZG4B (5&
&)*ZNTC /(ZRTC /ZNTC ))-1.0_JPRB)+YDPHY3%GCC(5)*ZRTC 
ZWTO=(ZGAS2B (6)*(ZRTO /ZNTO ))*(SQRT (1.0_JPRB+ZG4B (6&
&)*ZNTO /(ZRTO /ZNTO ))-1.0_JPRB)+YDPHY3%GCC(6)*ZRTO 
ZEOT =(ZWTH*(1.0_JPRB+ZWTH*(YDPHY3%VNP(1, 4)+ZWTH*(YDPHY3%VNP(2, 4)+ZWTH*(YDPHY3%VNP(3, 4)+ZWTH*(YDPHY3&
&%VNP(4, 4)+ZWTH*YDPHY3%VNP(5, 4)))))))/(1.0_JPRB+ZWTH*(YDPHY3%VDP(1, 4)+ZWTH*(YDPHY3%VDP(2, 4)+ZWTH*(YDPHY3&
&%VDP(3, 4)+ZWTH*(YDPHY3%VDP(4, 4)+ZWTH*YDPHY3%VDP(5, 4))))))+(ZWTC*(1.0_JPRB+ZWTC*(YDPHY3%VNP(1, 5)+ZWTC&
&*(YDPHY3%VNP(2, 5)+ZWTC*(YDPHY3%VNP(3, 5)+ZWTC*(YDPHY3%VNP(4, 5)+ZWTC*YDPHY3%VNP(5, 5)))))))/(1.0_JPRB&
&+ZWTC*(YDPHY3%VDP(1, 5)+ZWTC*(YDPHY3%VDP(2, 5)+ZWTC*(YDPHY3%VDP(3, 5)+ZWTC*(YDPHY3%VDP(4, 5)+ZWTC*YDPHY3&
&%VDP(5, 5))))))+(ZWTO*(1.0_JPRB+ZWTO*(YDPHY3%VNP(1, 6)+ZWTO*(YDPHY3%VNP(2, 6)+ZWTO*(YDPHY3%VNP(3, 6)+ZWTO&
&*(YDPHY3%VNP(4, 6)+ZWTO*YDPHY3%VNP(5, 6)))))))/(1.0_JPRB+ZWTO*(YDPHY3%VDP(1, 6)+ZWTO*(YDPHY3%VDP(2, 6&
&)+ZWTO*(YDPHY3%VDP(3, 6)+ZWTO*(YDPHY3%VDP(4, 6)+ZWTO*YDPHY3%VDP(5, 6))))))
ZEOTS =ZEOT 


DO JLEV=KTDIA, KLEV
  
  ZEOSO =ZEOS 
  
  
  ZEOTO =ZEOT 
  
  
  ZP=PAPRS (JLON, JLEV)
  ZQ=MAX (ZEPS2, PQ (JLON, JLEV))
  ZRT=SQRT (PT (JLON, JLEV))
  ZTI=1.0_JPRB/PT (JLON, JLEV)
  ZT2=PT (JLON, JLEV)*PT (JLON, JLEV)
  ZT2I=ZTI*ZTI
  ZT4I=ZT2I*ZT2I
  ZTDETA=REAL (ZRT, JPRD)**49*EXP (REAL (YDPHY3%GCE4, JPRD)/REAL (PT (JLON, JLEV), JPRD))
  ZT3=ZT2*PT (JLON, JLEV)
  ZDUH=(2.0_JPRB*PDELP (JLON, JLEV))*ZQ
  ZDUC=(2.0_JPRB*PDELP (JLON, JLEV))*PQCO2 (JLON, JLEV)
  ZDUO=(2.0_JPRB*PDELP (JLON, JLEV))*PQO3 (JLON, JLEV)
  ZNSH =ZNSH +ZDUH*ZDM0I 
  ZNSC =ZNSC +ZDUC*ZDM0I 
  ZNSO =ZNSO +ZDUO*ZDM0I 
  ZNTH =ZNTH +ZDUH*ZTI
  ZNTC =ZNTC +ZDUC
  ZNTO =ZNTO +ZDUO*ZT2
  ZDUH=ZDUH*(ZMD*PAPRSF (JLON, JLEV))*ZRT
  ZDUC=ZDUC*(ZMD*PAPRSF (JLON, JLEV))*PT (JLON, JLEV)
  ZDUO=ZDUO*(ZMD*PAPRSF (JLON, JLEV))*ZRT
  ZRSH =ZRSH +ZDUH*(ZDM0I /ZMD)
  ZRSC =ZRSC +ZDUC*(ZDM0I /ZMD)
  ZRSO =ZRSO +ZDUO*(ZDM0I /ZMD)
  ZRTH =ZRTH +(ZDUH*ZT2I*ZRT)
  ZCTH =ZCTH +(ZDUH*ZT2I*ZRT)*ZT4I*(1.0_JPRB+YDPHY3%GCD4*ZQ*ZTDETA)
  ZRTC =ZRTC +ZDUC*PT (JLON, JLEV)
  ZRTO =ZRTO +ZDUO*ZT3*ZRT
  
  
  ZWSH=(ZGAS2B (1)*(ZRSH /ZNSH ))*(SQRT (1.0_JPRB+ZG4B (1&
  &)*ZNSH /(ZRSH /ZNSH ))-1.0_JPRB)+YDPHY3%GCC(1)*ZRSH 
  ZWSC=(ZGAS2B (2)*(ZRSC /ZNSC ))*(SQRT (1.0_JPRB+ZG4B (2&
  &)*ZNSC /(ZRSC /ZNSC ))-1.0_JPRB)+YDPHY3%GCC(2)*ZRSC 
  ZWSO=(ZGAS2B (3)*(ZRSO /ZNSO ))*(SQRT (1.0_JPRB+ZG4B (3&
  &)*ZNSO /(ZRSO /ZNSO ))-1.0_JPRB)+YDPHY3%GCC(3)*ZRSO 
  ZEOS =(ZWSH*(1.0_JPRB+ZWSH*(YDPHY3%VNP(1, 1)+ZWSH*(YDPHY3%VNP(2, 1)+ZWSH*(YDPHY3%VNP(3, 1)&
  &+ZWSH*(YDPHY3%VNP(4, 1)+ZWSH*YDPHY3%VNP(5, 1)))))))/(1.0_JPRB+ZWSH*(YDPHY3%VDP(1, 1)+ZWSH&
  &*(YDPHY3%VDP(2, 1)+ZWSH*(YDPHY3%VDP(3, 1)+ZWSH*(YDPHY3%VDP(4, 1)+ZWSH*YDPHY3%VDP(5, 1))))&
  &))+(ZWSC*(1.0_JPRB+ZWSC*(YDPHY3%VNP(1, 2)+ZWSC*(YDPHY3%VNP(2, 2)+ZWSC*(YDPHY3%VNP(3, 2)+ZWSC&
  &*(YDPHY3%VNP(4, 2)+ZWSC*YDPHY3%VNP(5, 2)))))))/(1.0_JPRB+ZWSC*(YDPHY3%VDP(1, 2)+ZWSC*(YDPHY3&
  &%VDP(2, 2)+ZWSC*(YDPHY3%VDP(3, 2)+ZWSC*(YDPHY3%VDP(4, 2)+ZWSC*YDPHY3%VDP(5, 2))))))+(ZWSO&
  &*(1.0_JPRB+ZWSO*(YDPHY3%VNP(1, 3)+ZWSO*(YDPHY3%VNP(2, 3)+ZWSO*YDPHY3%VNP(3, 3)))))/(1.0_JPRB&
  &+ZWSO*(YDPHY3%VDP(1, 3)+ZWSO*(YDPHY3%VDP(2, 3)+ZWSO*YDPHY3%VDP(3, 3))))
  ZDEOS (JLON, JLEV)=(ZEOS -ZEOSO )/ZDM0I 
  
  
  ZWTH=(ZGAS2B (4)*(ZRTH /ZNTH ))*(SQRT (1.0_JPRB+ZG4B (4&
  &)*ZNTH /(ZRTH /ZNTH ))-1.0_JPRB)+YDPHY3%GCC(4)*ZCTH 
  ZWTC=(ZGAS2B (5)*(ZRTC /ZNTC ))*(SQRT (1.0_JPRB+ZG4B (5&
  &)*ZNTC /(ZRTC /ZNTC ))-1.0_JPRB)+YDPHY3%GCC(5)*ZRTC 
  ZWTO=(ZGAS2B (6)*(ZRTO /ZNTO ))*(SQRT (1.0_JPRB+ZG4B (6&
  &)*ZNTO /(ZRTO /ZNTO ))-1.0_JPRB)+YDPHY3%GCC(6)*ZRTO 
  ZEOT =(ZWTH*(1.0_JPRB+ZWTH*(YDPHY3%VNP(1, 4)+ZWTH*(YDPHY3%VNP(2, 4)+ZWTH*(YDPHY3%VNP(3, 4)+ZWTH*(YDPHY3&
  &%VNP(4, 4)+ZWTH*YDPHY3%VNP(5, 4)))))))/(1.0_JPRB+ZWTH*(YDPHY3%VDP(1, 4)+ZWTH*(YDPHY3%VDP(2, 4)+ZWTH*(YDPHY3&
  &%VDP(3, 4)+ZWTH*(YDPHY3%VDP(4, 4)+ZWTH*YDPHY3%VDP(5, 4))))))+(ZWTC*(1.0_JPRB+ZWTC*(YDPHY3%VNP(1, 5)+ZWTC&
  &*(YDPHY3%VNP(2, 5)+ZWTC*(YDPHY3%VNP(3, 5)+ZWTC*(YDPHY3%VNP(4, 5)+ZWTC*YDPHY3%VNP(5, 5)))))))/(1.0_JPRB&
  &+ZWTC*(YDPHY3%VDP(1, 5)+ZWTC*(YDPHY3%VDP(2, 5)+ZWTC*(YDPHY3%VDP(3, 5)+ZWTC*(YDPHY3%VDP(4, 5)+ZWTC*YDPHY3&
  &%VDP(5, 5))))))+(ZWTO*(1.0_JPRB+ZWTO*(YDPHY3%VNP(1, 6)+ZWTO*(YDPHY3%VNP(2, 6)+ZWTO*(YDPHY3%VNP(3, 6)+ZWTO&
  &*(YDPHY3%VNP(4, 6)+ZWTO*YDPHY3%VNP(5, 6)))))))/(1.0_JPRB+ZWTO*(YDPHY3%VDP(1, 6)+ZWTO*(YDPHY3%VDP(2, 6&
  &)+ZWTO*(YDPHY3%VDP(3, 6)+ZWTO*(YDPHY3%VDP(4, 6)+ZWTO*YDPHY3%VDP(5, 6))))))
  ZDEOT (JLON, JLEV)=ZEOT -ZEOTO 
  
ENDDO


ZEOT =0.0_JPRB
ZNTH =0.0_JPRB
ZNTC =0.0_JPRB
ZNTO =0.0_JPRB
ZRTH =0.0_JPRB
ZCTH =0.0_JPRB
ZRTC =0.0_JPRB
ZRTO =0.0_JPRB


DO JLEV=KLEV, KTDIA,-1
  
  ZEOSO =ZEOS 
  
  
  ZEOTO =ZEOT 
  
  
  ZP=MAX (ZEPS1, PAPRS (JLON, JLEV-1))
  ZQ=MAX (ZEPS2, PQ (JLON, JLEV))
  ZRT=SQRT (PT (JLON, JLEV))
  ZTI=1.0_JPRB/PT (JLON, JLEV)
  ZT2=PT (JLON, JLEV)*PT (JLON, JLEV)
  ZT2I=ZTI*ZTI
  ZT4I=ZT2I*ZT2I
  ZTDETA=REAL (ZRT, JPRD)**49*EXP (REAL (YDPHY3%GCE4, JPRD)/REAL (PT (JLON, JLEV), JPRD))
  ZT3=ZT2*PT (JLON, JLEV)
  ZDUH=(2.0_JPRB*PDELP (JLON, JLEV))*ZQ
  ZDUC=(2.0_JPRB*PDELP (JLON, JLEV))*PQCO2 (JLON, JLEV)
  ZDUO=(2.0_JPRB*PDELP (JLON, JLEV))*PQO3 (JLON, JLEV)
  ZNSH =ZNSH +ZDUH
  ZNSC =ZNSC +ZDUC
  ZNSO =ZNSO +ZDUO
  ZNTH =ZNTH +ZDUH*ZTI
  ZNTC =ZNTC +ZDUC
  ZNTO =ZNTO +ZDUO*ZT2
  ZDUH=ZDUH*(ZMD*PAPRSF (JLON, JLEV))*ZRT
  ZDUC=ZDUC*(ZMD*PAPRSF (JLON, JLEV))*PT (JLON, JLEV)
  ZDUO=ZDUO*(ZMD*PAPRSF (JLON, JLEV))*ZRT
  ZRSH =ZRSH +ZDUH
  ZRSC =ZRSC +ZDUC
  ZRSO =ZRSO +ZDUO
  ZRTH =ZRTH +(ZDUH*ZT2I*ZRT)
  ZCTH =ZCTH +(ZDUH*ZT2I*ZRT)*ZT4I*(1.0_JPRB+YDPHY3%GCD4*ZQ*ZTDETA)
  ZRTC =ZRTC +ZDUC*PT (JLON, JLEV)
  ZRTO =ZRTO +ZDUO*ZT3*ZRT
  
  
  ZWSH=(ZGAS2B (1)*(ZRSH /ZNSH ))*(SQRT (1.0_JPRB+ZG4B (1&
  &)*ZNSH /(ZRSH /ZNSH ))-1.0_JPRB)+YDPHY3%GCC(1)*ZRSH 
  ZWSC=(ZGAS2B (2)*(ZRSC /ZNSC ))*(SQRT (1.0_JPRB+ZG4B (2&
  &)*ZNSC /(ZRSC /ZNSC ))-1.0_JPRB)+YDPHY3%GCC(2)*ZRSC 
  ZWSO=(ZGAS2B (3)*(ZRSO /ZNSO ))*(SQRT (1.0_JPRB+ZG4B (3&
  &)*ZNSO /(ZRSO /ZNSO ))-1.0_JPRB)+YDPHY3%GCC(3)*ZRSO 
  ZEOS =(ZWSH*(1.0_JPRB+ZWSH*(YDPHY3%VNP(1, 1)+ZWSH*(YDPHY3%VNP(2, 1)+ZWSH*(YDPHY3%VNP(3, 1)&
  &+ZWSH*(YDPHY3%VNP(4, 1)+ZWSH*YDPHY3%VNP(5, 1)))))))/(1.0_JPRB+ZWSH*(YDPHY3%VDP(1, 1)+ZWSH&
  &*(YDPHY3%VDP(2, 1)+ZWSH*(YDPHY3%VDP(3, 1)+ZWSH*(YDPHY3%VDP(4, 1)+ZWSH*YDPHY3%VDP(5, 1))))&
  &))+(ZWSC*(1.0_JPRB+ZWSC*(YDPHY3%VNP(1, 2)+ZWSC*(YDPHY3%VNP(2, 2)+ZWSC*(YDPHY3%VNP(3, 2)+ZWSC&
  &*(YDPHY3%VNP(4, 2)+ZWSC*YDPHY3%VNP(5, 2)))))))/(1.0_JPRB+ZWSC*(YDPHY3%VDP(1, 2)+ZWSC*(YDPHY3&
  &%VDP(2, 2)+ZWSC*(YDPHY3%VDP(3, 2)+ZWSC*(YDPHY3%VDP(4, 2)+ZWSC*YDPHY3%VDP(5, 2))))))+(ZWSO&
  &*(1.0_JPRB+ZWSO*(YDPHY3%VNP(1, 3)+ZWSO*(YDPHY3%VNP(2, 3)+ZWSO*YDPHY3%VNP(3, 3)))))/(1.0_JPRB&
  &+ZWSO*(YDPHY3%VDP(1, 3)+ZWSO*(YDPHY3%VDP(2, 3)+ZWSO*YDPHY3%VDP(3, 3))))
  ZUEOS (JLON, JLEV)=ZEOS -ZEOSO 
  
  
  ZWTH=(ZGAS2B (4)*(ZRTH /ZNTH ))*(SQRT (1.0_JPRB+ZG4B (4&
  &)*ZNTH /(ZRTH /ZNTH ))-1.0_JPRB)+YDPHY3%GCC(4)*ZCTH 
  ZWTC=(ZGAS2B (5)*(ZRTC /ZNTC ))*(SQRT (1.0_JPRB+ZG4B (5&
  &)*ZNTC /(ZRTC /ZNTC ))-1.0_JPRB)+YDPHY3%GCC(5)*ZRTC 
  ZWTO=(ZGAS2B (6)*(ZRTO /ZNTO ))*(SQRT (1.0_JPRB+ZG4B (6&
  &)*ZNTO /(ZRTO /ZNTO ))-1.0_JPRB)+YDPHY3%GCC(6)*ZRTO 
  ZEOT =(ZWTH*(1.0_JPRB+ZWTH*(YDPHY3%VNP(1, 4)+ZWTH*(YDPHY3%VNP(2, 4)+ZWTH*(YDPHY3%VNP(3, 4)+ZWTH*(YDPHY3&
  &%VNP(4, 4)+ZWTH*YDPHY3%VNP(5, 4)))))))/(1.0_JPRB+ZWTH*(YDPHY3%VDP(1, 4)+ZWTH*(YDPHY3%VDP(2, 4)+ZWTH*(YDPHY3&
  &%VDP(3, 4)+ZWTH*(YDPHY3%VDP(4, 4)+ZWTH*YDPHY3%VDP(5, 4))))))+(ZWTC*(1.0_JPRB+ZWTC*(YDPHY3%VNP(1, 5)+ZWTC&
  &*(YDPHY3%VNP(2, 5)+ZWTC*(YDPHY3%VNP(3, 5)+ZWTC*(YDPHY3%VNP(4, 5)+ZWTC*YDPHY3%VNP(5, 5)))))))/(1.0_JPRB&
  &+ZWTC*(YDPHY3%VDP(1, 5)+ZWTC*(YDPHY3%VDP(2, 5)+ZWTC*(YDPHY3%VDP(3, 5)+ZWTC*(YDPHY3%VDP(4, 5)+ZWTC*YDPHY3&
  &%VDP(5, 5))))))+(ZWTO*(1.0_JPRB+ZWTO*(YDPHY3%VNP(1, 6)+ZWTO*(YDPHY3%VNP(2, 6)+ZWTO*(YDPHY3%VNP(3, 6)+ZWTO&
  &*(YDPHY3%VNP(4, 6)+ZWTO*YDPHY3%VNP(5, 6)))))))/(1.0_JPRB+ZWTO*(YDPHY3%VDP(1, 6)+ZWTO*(YDPHY3%VDP(2, 6&
  &)+ZWTO*(YDPHY3%VDP(3, 6)+ZWTO*(YDPHY3%VDP(4, 6)+ZWTO*YDPHY3%VDP(5, 6))))))
  ZASC=ZDEOT (JLON, JLEV)
  ZDES=ZEOT -ZEOTO 
  ZTES=MAX (0.0_JPRB, SIGN (1.0_JPRB, ZASC-ZDES))
  ZEPSEXC=(YDPHY3%GIREC1+ZTES*YDPHY3%GIREC3)*(MIN (ZASC, ZDES&
  &)/MAX (ZASC, ZDES))**(YDPHY3%GIREC2+ZTES*YDPHY3%GIREC4)
  ZUEOT (JLON, JLEV)=MAX (ZASC, ZDES)*(MIN (ZASC, ZDES)/MAX (ZASC, ZDES))**(1.0_JPRB-ZEPSEXC)
  ZUUEOT (JLON, JLEV)=ZDES
  
ENDDO


ZEOTO =ZEOT 


ZP=MAX (ZEPS1, PAPRS (JLON, KTDIA-1))
ZQ=MAX (ZEPS2, PQ (JLON, KTDIA))
ZRT=SQRT (PT (JLON, KTDIA))
ZTI=1.0_JPRB/PT (JLON, KTDIA)
ZT2=PT (JLON, KTDIA)*PT (JLON, KTDIA)
ZT2I=ZTI*ZTI
ZT4I=ZT2I*ZT2I
ZTDETA=REAL (ZRT, JPRD)**49*EXP (REAL (YDPHY3%GCE4, JPRD)/REAL (PT (JLON, KTDIA), JPRD))
ZT3=ZT2*PT (JLON, KTDIA)
ZDUH=(2.0_JPRB*ZP)*ZQ
ZDUC=(2.0_JPRB*ZP)*PQCO2 (JLON, KTDIA)
ZDUO=ZNSOR 
ZNTH =ZNTH +ZDUH*ZTI
ZNTC =ZNTC +ZDUC
ZNTO =ZNTO +ZDUO*ZT2
ZDUH=ZDUH*(ZMD*0.5_JPRB*ZP)*ZRT
ZDUC=ZDUC*(ZMD*0.5_JPRB*ZP)*PT (JLON, KTDIA)
ZDUO=ZDUO*(ZMD*0.5_JPRB*ZP)*ZRT
ZRTH =ZRTH +(ZDUH*ZT2I*ZRT)
ZCTH =ZCTH +(ZDUH*ZT2I*ZRT)*ZT4I*(1.0_JPRB+YDPHY3%GCD4*ZQ*ZTDETA)
ZRTC =ZRTC +ZDUC*PT (JLON, KTDIA)
ZRTO =ZRTO +ZDUO*ZT3*ZRT
ZWTH=(ZGAS2B (4)*(ZRTH /ZNTH ))*(SQRT (1.0_JPRB+ZG4B (4&
&)*ZNTH /(ZRTH /ZNTH ))-1.0_JPRB)+YDPHY3%GCC(4)*ZCTH 
ZWTC=(ZGAS2B (5)*(ZRTC /ZNTC ))*(SQRT (1.0_JPRB+ZG4B (5&
&)*ZNTC /(ZRTC /ZNTC ))-1.0_JPRB)+YDPHY3%GCC(5)*ZRTC 
ZWTO=(ZGAS2B (6)*(ZRTO /ZNTO ))*(SQRT (1.0_JPRB+ZG4B (6&
&)*ZNTO /(ZRTO /ZNTO ))-1.0_JPRB)+YDPHY3%GCC(6)*ZRTO 
ZEOT =(ZWTH*(1.0_JPRB+ZWTH*(YDPHY3%VNP(1, 4)+ZWTH*(YDPHY3%VNP(2, 4)+ZWTH*(YDPHY3%VNP(3, 4)+ZWTH*(YDPHY3&
&%VNP(4, 4)+ZWTH*YDPHY3%VNP(5, 4)))))))/(1.0_JPRB+ZWTH*(YDPHY3%VDP(1, 4)+ZWTH*(YDPHY3%VDP(2, 4)+ZWTH*(YDPHY3&
&%VDP(3, 4)+ZWTH*(YDPHY3%VDP(4, 4)+ZWTH*YDPHY3%VDP(5, 4))))))+(ZWTC*(1.0_JPRB+ZWTC*(YDPHY3%VNP(1, 5)+ZWTC&
&*(YDPHY3%VNP(2, 5)+ZWTC*(YDPHY3%VNP(3, 5)+ZWTC*(YDPHY3%VNP(4, 5)+ZWTC*YDPHY3%VNP(5, 5)))))))/(1.0_JPRB&
&+ZWTC*(YDPHY3%VDP(1, 5)+ZWTC*(YDPHY3%VDP(2, 5)+ZWTC*(YDPHY3%VDP(3, 5)+ZWTC*(YDPHY3%VDP(4, 5)+ZWTC*YDPHY3&
&%VDP(5, 5))))))+(ZWTO*(1.0_JPRB+ZWTO*(YDPHY3%VNP(1, 6)+ZWTO*(YDPHY3%VNP(2, 6)+ZWTO*(YDPHY3%VNP(3, 6)+ZWTO&
&*(YDPHY3%VNP(4, 6)+ZWTO*YDPHY3%VNP(5, 6)))))))/(1.0_JPRB+ZWTO*(YDPHY3%VDP(1, 6)+ZWTO*(YDPHY3%VDP(2, 6&
&)+ZWTO*(YDPHY3%VDP(3, 6)+ZWTO*(YDPHY3%VDP(4, 6)+ZWTO*YDPHY3%VDP(5, 6))))))
ZEPSEXC=(YDPHY3%GIREC1+YDPHY3%GIREC3)*((ZEOT -ZEOTO )/ZEOTS )**(YDPHY3%GIREC2+YDPHY3%GIREC4)
ZUETS =ZEOTS *((ZEOT -ZEOTO )/ZEOTS )**(1.0_JPRB-ZEPSEXC)
ZUUETS =ZEOT -ZEOTO 


DO JLEV=KTDIA, KLEV
  
  ZB1 (JLON, JLEV)=1.0_JPRB-PNEB (JLON, JLEV)
  
ENDDO


ZMU0I =2.0_JPRB*ZDM0I 
ZUSI =(0.5_JPRB+YDPHY3%USAI*ZMU0 )/(1.0_JPRB+YDPHY3%USBI*ZMU0 )
ZUSN =(0.5_JPRB+YDPHY3%USAN*ZMU0 )/(1.0_JPRB+YDPHY3%USBN*ZMU0 )

ZEO3SA(JLON,:)=0._JPRB
ZEO4SA(JLON,:)=0._JPRB

DO JAE=1, 6

  DO JLEV=KTDIA, KLEV
    
    ZUSA=(0.5_JPRB+YDPHY3%USAA(JAE)*ZMU0 )/(1._JPRB+YDPHY3%USBA*ZMU0 )
    ZEO3SA (JLON, JLEV)=ZEO3SA (JLON, JLEV)+YDPHY3%EODSA(JAE)*PDAER (JLON, JLEV, JAE)*ZUSA
    ZEO4SA (JLON, JLEV)=ZEO4SA (JLON, JLEV)+YDPHY3%EODSA(JAE)*PDAER (JLON, JLEV, JAE)*(1._JPRB-ZUSA)
  
  ENDDO

ENDDO


ZFPC (JLON, KTDIA-1)=ZII0 *ZMU0 *EXP (MAX (-0.5_JPRB*ZMU0I *ZEOSS , ZARGLI))
ZFDC (JLON, KTDIA-1)=0.0_JPRB


ZEO1=ZUEOS (JLON, KTDIA)+ZEO1SA (JLON, KTDIA)+(YDPHY3%EORAY*PDELP (JLON, KTDIA))
ZEO2=ZEO2SA (JLON, KTDIA)+(YDPHY3%EORAY*PDELP (JLON, KTDIA))

IF (JPRB==JPRD) THEN
  ZEPS=SQRT (ZEO1*ZEO1-ZEO2*ZEO2)
ELSE
  ZEPS=SQRT ((ZEO1-ZEO2)*(ZEO1+ZEO2))
ENDIF

ZTAU=EXP (MAX (-ZEPS, ZARGLI))
ZRHO=ZEO2/(ZEO1+ZEPS)
ZA4C =ZTAU*(1.0_JPRB-(ZRHO*ZRHO))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
ZA5C =ZRHO*(1.0_JPRB-(ZTAU*ZTAU))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
ZEO=0.5_JPRB*ZDEOS (JLON, KTDIA)+ZEOSA (JLON, KTDIA)+(YDPHY3%EORAY*PDELP (JLON, KTDIA))
ZMU0IC=(ZEPS/ZEO)+SIGN (MAX (ABS (ZMU0I -(ZEPS/ZEO)), ZEPS3),(ZMU0I -(ZEPS/ZEO)))
ZEO3=(ZEO3SA (JLON, KTDIA)+(0.5_JPRB*(YDPHY3%EORAY*PDELP (JLON, KTDIA))))*ZMU0IC
ZEO4=(ZEO4SA (JLON, KTDIA)+(0.5_JPRB*(YDPHY3%EORAY*PDELP (JLON, KTDIA))))*ZMU0IC
ZEO5=ZEO*ZMU0IC
ZA1C =EXP (MAX (-ZEO5, ZARGLI))
ZG1=(ZEO3*(ZEO5-ZEO1)-ZEO2*ZEO4)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
ZG2=-(ZEO4*(ZEO5+ZEO1)+ZEO2*ZEO3)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
ZA2C =ZG2*(ZA1C -ZA4C )-ZG1*ZA5C *ZA1C 
ZA3C =ZG1*(1.0_JPRB-ZA4C *ZA1C )-ZG2*ZA5C 
ZEO1=ZEO1+ZEO1SN*(PDELP (JLON, KTDIA)*ZQLI (JLON, KTDIA&
&))+ZEO1SI*(PDELP (JLON, KTDIA)*ZQICE (JLON, KTDIA))
ZEO2=ZEO2+ZEO2SN*(PDELP (JLON, KTDIA)*ZQLI (JLON, KTDIA&
&))+ZEO2SI*(PDELP (JLON, KTDIA)*ZQICE (JLON, KTDIA))
ZEPS=SQRT ((ZEO1-ZEO2)*(ZEO1+ZEO2))
ZTAU=EXP (MAX (-ZEPS, ZARGLI))
ZRHO=ZEO2/(ZEO1+ZEPS)
ZA4N =ZTAU*(1.0_JPRB-(ZRHO*ZRHO))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
ZA5N =ZRHO*(1.0_JPRB-(ZTAU*ZTAU))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
ZEO=ZEO+ZEOSN*(PDELP (JLON, KTDIA)*ZQLI (JLON, KTDIA)&
&)+ZEOSI*(PDELP (JLON, KTDIA)*ZQICE (JLON, KTDIA))
ZMU0IN=(ZEPS/ZEO)+SIGN (MAX (ABS (ZMU0I -(ZEPS/ZEO)), ZEPS3),(ZMU0I -(ZEPS/ZEO)))
ZEO3=(ZEO3/ZMU0IC+ZUSN *((PDELP (JLON, KTDIA)*ZQLI (JLON, KTDIA))*YDPHY3%EODSN&
&)+ZUSI *((PDELP (JLON, KTDIA)*ZQICE (JLON, KTDIA))*YDPHY3%EODSI))*ZMU0IN
ZEO4=(ZEO4/ZMU0IC+(1.0_JPRB-ZUSN )*((PDELP (JLON, KTDIA)*ZQLI (JLON, KTDIA))*YDPHY3%EODSN&
&)+(1.0_JPRB-ZUSI )*((PDELP (JLON, KTDIA)*ZQICE (JLON, KTDIA))*YDPHY3%EODSI))*ZMU0IN
ZEO5=ZEO*ZMU0IN
ZA1N =EXP (MAX (-ZEO5, ZARGLI))
ZG1=(ZEO3*(ZEO5-ZEO1)-ZEO2*ZEO4)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
ZG2=-(ZEO4*(ZEO5+ZEO1)+ZEO2*ZEO3)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
ZA2N =ZG2*(ZA1N -ZA4N )-ZG1*ZA5N *ZA1N 
ZA3N =ZG1*(1.0_JPRB-ZA4N *ZA1N )-ZG2*ZA5N 
ZA1C =ZA1C *ZB1 (JLON, KTDIA)+ZA1N *PNEB (JLON, KTDIA)
ZA2C =ZA2C *ZB1 (JLON, KTDIA)+ZA2N *PNEB (JLON, KTDIA)
ZA3C =ZA3C *ZB1 (JLON, KTDIA)+ZA3N *PNEB (JLON, KTDIA)
ZA4C =ZA4C *ZB1 (JLON, KTDIA)+ZA4N *PNEB (JLON, KTDIA)
ZA5C =ZA5C *ZB1 (JLON, KTDIA)+ZA5N *PNEB (JLON, KTDIA)


ZFMC (JLON, KTDIA-1)=ZA3C *ZFPC (JLON, KTDIA-1)
ZFPC (JLON, KTDIA)=ZA1C *ZFPC (JLON, KTDIA-1)
ZFDC (JLON, KTDIA)=ZA2C *ZFPC (JLON, KTDIA-1)
ZTU2 (JLON, KTDIA)=ZA4C 
ZTU6 (JLON, KTDIA)=ZA5C 


DO JLEV=KTDIA+1, KLEV
  
  ZEO1=ZUEOS (JLON, JLEV)+ZEO1SA (JLON, JLEV)+(YDPHY3%EORAY*PDELP (JLON, JLEV))
  ZEO2=ZEO2SA (JLON, JLEV)+(YDPHY3%EORAY*PDELP (JLON, JLEV))
  ZEPS=SQRT ((ZEO1-ZEO2)*(ZEO1+ZEO2))
  ZTAU=EXP (MAX (-ZEPS, ZARGLI))
  ZRHO=ZEO2/(ZEO1+ZEPS)
  ZA4C =ZTAU*(1.0_JPRB-(ZRHO*ZRHO))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
  ZA5C =ZRHO*(1.0_JPRB-(ZTAU*ZTAU))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
  ZEO=0.5_JPRB*ZDEOS (JLON, JLEV)+ZEOSA (JLON, JLEV)+(YDPHY3%EORAY*PDELP (JLON, JLEV))
  ZMU0IC=(ZEPS/ZEO)+SIGN (MAX (ABS (ZMU0I -(ZEPS/ZEO)), ZEPS3),(ZMU0I -(ZEPS/ZEO)))
  ZEO3=(ZEO3SA (JLON, JLEV)+(0.5_JPRB*(YDPHY3%EORAY*PDELP (JLON, JLEV))))*ZMU0IC
  ZEO4=(ZEO4SA (JLON, JLEV)+(0.5_JPRB*(YDPHY3%EORAY*PDELP (JLON, JLEV))))*ZMU0IC
  ZEO5=ZEO*ZMU0IC
  ZA1C =EXP (MAX (-ZEO5, ZARGLI))
  ZG1=(ZEO3*(ZEO5-ZEO1)-ZEO2*ZEO4)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
  ZG2=-(ZEO4*(ZEO5+ZEO1)+ZEO2*ZEO3)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
  ZA2C =ZG2*(ZA1C -ZA4C )-ZG1*ZA5C *ZA1C 
  ZA3C =ZG1*(1.0_JPRB-ZA4C *ZA1C )-ZG2*ZA5C 
  ZEO1=ZEO1+ZEO1SN*(PDELP (JLON, JLEV)*ZQLI (JLON, JLEV&
  &))+ZEO1SI*(PDELP (JLON, JLEV)*ZQICE (JLON, JLEV))
  ZEO2=ZEO2+ZEO2SN*(PDELP (JLON, JLEV)*ZQLI (JLON, JLEV&
  &))+ZEO2SI*(PDELP (JLON, JLEV)*ZQICE (JLON, JLEV))
  ZEPS=SQRT ((ZEO1-ZEO2)*(ZEO1+ZEO2))
  ZTAU=EXP (MAX (-ZEPS, ZARGLI))
  ZRHO=ZEO2/(ZEO1+ZEPS)
  ZA4N =ZTAU*(1.0_JPRB-(ZRHO*ZRHO))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
  ZA5N =ZRHO*(1.0_JPRB-(ZTAU*ZTAU))*(1.0_JPRB/(1.0_JPRB-(ZRHO*ZRHO)*(ZTAU*ZTAU)))
  ZEO=ZEO+ZEOSN*(PDELP (JLON, JLEV)*ZQLI (JLON, JLEV))+ZEOSI*(PDELP (JLON, JLEV)*ZQICE (JLON, JLEV))
  ZMU0IN=(ZEPS/ZEO)+SIGN (MAX (ABS (ZMU0I -(ZEPS/ZEO)), ZEPS3),(ZMU0I -(ZEPS/ZEO)))
  ZEO3=(ZEO3/ZMU0IC+ZUSN *((PDELP (JLON, JLEV)*ZQLI (JLON, JLEV))*YDPHY3%EODSN&
  &)+ZUSI *((PDELP (JLON, JLEV)*ZQICE (JLON, JLEV))*YDPHY3%EODSI))*ZMU0IN
  ZEO4=(ZEO4/ZMU0IC+(1.0_JPRB-ZUSN )*((PDELP (JLON, JLEV)*ZQLI (JLON, JLEV))*YDPHY3%EODSN&
  &)+(1.0_JPRB-ZUSI )*((PDELP (JLON, JLEV)*ZQICE (JLON, JLEV))*YDPHY3%EODSI))*ZMU0IN
  ZEO5=ZEO*ZMU0IN
  ZA1N =EXP (MAX (-ZEO5, ZARGLI))
  ZG1=(ZEO3*(ZEO5-ZEO1)-ZEO2*ZEO4)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
  ZG2=-(ZEO4*(ZEO5+ZEO1)+ZEO2*ZEO3)*(1.0_JPRB/((ZEO5-ZEPS)*(ZEO5+ZEPS)))
  ZA2N =ZG2*(ZA1N -ZA4N )-ZG1*ZA5N *ZA1N 
  ZA3N =ZG1*(1.0_JPRB-ZA4N *ZA1N )-ZG2*ZA5N 
  ZA1C =ZA1C *ZB1 (JLON, JLEV)+ZA1N *PNEB (JLON, JLEV)
  ZA2C =ZA2C *ZB1 (JLON, JLEV)+ZA2N *PNEB (JLON, JLEV)
  ZA3C =ZA3C *ZB1 (JLON, JLEV)+ZA3N *PNEB (JLON, JLEV)
  ZA4C =ZA4C *ZB1 (JLON, JLEV)+ZA4N *PNEB (JLON, JLEV)
  ZA5C =ZA5C *ZB1 (JLON, JLEV)+ZA5N *PNEB (JLON, JLEV)
  
  
  ZTD1=1.0_JPRB/(1.0_JPRB-ZA5C *ZTU6 (JLON, JLEV-1))
  ZFMC (JLON, JLEV-1)=ZTD1*(ZA5C *ZFDC (JLON, JLEV-1)+ZA3C *ZFPC (JLON, JLEV-1))
  ZTU2 (JLON, JLEV)=ZTD1*ZA4C 
  
  
  ZFPC (JLON, JLEV)=ZA1C *ZFPC (JLON, JLEV-1)
  ZTD4=ZA4C *ZTU6 (JLON, JLEV-1)
  ZFDC (JLON, JLEV)=ZA4C *ZFDC (JLON, JLEV-1)+ZTD4*ZFMC (JLON, JLEV-1)+ZA2C *ZFPC (JLON, JLEV-1)
  ZTU6 (JLON, JLEV)=ZA5C +ZTD4*ZTU2 (JLON, JLEV)
  
ENDDO


ZAL=PALB (JLON)
ZALP=(1.0_JPRB+0.5_JPRB*(ZMU0 *(1.0_JPRB/ZAL-1.0_JPRB&
&)))/(1.0_JPRB+(ZMU0 *(1.0_JPRB/ZAL-1.0_JPRB)))**2
ZTDS1=1.0_JPRB/(1.0_JPRB-ZAL*ZTU6 (JLON, KLEV))
ZFMC (JLON, KLEV)=ZTDS1*(ZAL*ZFDC (JLON, KLEV)+ZALP*ZFPC (JLON, KLEV))


DO JLEV=KLEV, KTDIA,-1
  
  ZFDC (JLON, JLEV)=ZFDC (JLON, JLEV)+ZTU6 (JLON, JLEV)*ZFMC (JLON, JLEV)
  ZFMC (JLON, JLEV-1)=ZFMC (JLON, JLEV-1)+ZTU2 (JLON, JLEV)*ZFMC (JLON, JLEV)
  
ENDDO


DO JLEV=KTDIA-1, KLEV
  
  ZFRSO (JLON, JLEV)=0.0_JPRB
  
  
  ZFRSO (JLON, JLEV)=ZFPC (JLON, JLEV)+ZFDC (JLON, JLEV)-ZFMC (JLON, JLEV)
  
ENDDO


DO JLEV=0, KTDIA-2
  
  ZFRSO (JLON, JLEV)=ZFRSO (JLON, KTDIA-1)
  
ENDDO


PFRSOLU (JLON)=1.0_JPRB/(MAX (ZEPSAL, 1.0_JPRB-PALB (JLON)))*ZFRSO (JLON, KLEV)



END SUBROUTINE ACRALU_OPENACC
