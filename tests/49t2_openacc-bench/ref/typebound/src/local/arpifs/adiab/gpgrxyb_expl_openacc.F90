SUBROUTINE GPGRXYB_EXPL_OPENACC (YDCVER, KPROMA, KST, KEND, KFLEV, LDCOEF, YDVAB, PREL, PREM&
&, PDELP, PLNPR, PRDELP, PALPH, PRTGR, PRPRE, PRPP, PCOEFD_DER, PLNPRL_DER, PLNPRM_DER, PCOEFA_DER&
&, PCOEFAPL_DER, PALPHPLL_DER, PALPHPLM_DER, PALPHL_DER, PALPHM_DER, YDSTACK)
!$ACC ROUTINE (GPGRXYB_EXPL_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCVER,ONLY:TCVER
USE YOMVERT,ONLY:TVAB
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCVER), INTENT (IN)::YDCVER
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
LOGICAL, INTENT (IN)::LDCOEF
TYPE (TVAB), INTENT (IN)::YDVAB
REAL (KIND=JPRB), INTENT (IN)::PREL (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PREM (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRPP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRTGR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), TARGET::PCOEFD_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLNPRL_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLNPRM_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), TARGET::PCOEFAPL_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), TARGET::PCOEFA_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PALPHPLL_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PALPHM_DER (KPROMA, KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB), INTENT (OUT)::PALPHL_DER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PALPHPLM_DER (KPROMA, KFLEV)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZCOEFAPLT
REAL (KIND=JPRB)::ZCOEFAT
REAL (KIND=JPRB)::ZCOEFDT


JROF = KST



IF (YDCVER%LVERTFE) THEN

  DO JLEV=1, KFLEV
    
    ZCOEFDT=(YDVAB%VDELB (JLEV)*PRDELP (JROF, JLEV)-PRTGR (JROF, JLEV))*PLNPR (JROF, JLEV)
    PLNPRL_DER (JROF, JLEV)=ZCOEFDT*PREL (JROF)
    PLNPRM_DER (JROF, JLEV)=ZCOEFDT*PREM (JROF)

    IF (LDCOEF) THEN
      PCOEFD_DER (JROF, JLEV)=ZCOEFDT
    ENDIF

  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    ZCOEFDT=-YDVAB%VC (JLEV)*PRPP (JROF, JLEV)
    PLNPRL_DER (JROF, JLEV)=ZCOEFDT*PREL (JROF)
    PLNPRM_DER (JROF, JLEV)=ZCOEFDT*PREM (JROF)

    IF (LDCOEF) THEN
      PCOEFD_DER (JROF, JLEV)=ZCOEFDT
    ENDIF

  
  ENDDO


  IF (YDCVER%NDLNPR==0) THEN

    DO JLEV=1, KFLEV
      
      ZCOEFAPLT=YDVAB%VBH (JLEV)*PRPRE (JROF, JLEV)
      PALPHPLL_DER (JROF, JLEV)=ZCOEFAPLT*PREL (JROF)
      PALPHPLM_DER (JROF, JLEV)=ZCOEFAPLT*PREM (JROF)
      ZCOEFAT=ZCOEFAPLT-PRTGR (JROF, JLEV)
      PALPHL_DER (JROF, JLEV)=ZCOEFAT*PREL (JROF)
      PALPHM_DER (JROF, JLEV)=ZCOEFAT*PREM (JROF)

      IF (LDCOEF) THEN
        PCOEFA_DER (JROF, JLEV)=ZCOEFAT
        PCOEFAPL_DER (JROF, JLEV)=ZCOEFAPLT
      ENDIF

    
    ENDDO

  ELSEIF (YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2) THEN

    DO JLEV=1, KFLEV
      
      ZCOEFAT=-YDVAB%VC (JLEV)*PRPP (JROF, JLEV)*PALPH (JROF, JLEV)/PLNPR (JROF, JLEV)
      PALPHL_DER (JROF, JLEV)=ZCOEFAT*PREL (JROF)
      PALPHM_DER (JROF, JLEV)=ZCOEFAT*PREM (JROF)
      ZCOEFAPLT=ZCOEFAT+PRTGR (JROF, JLEV)
      PALPHPLL_DER (JROF, JLEV)=ZCOEFAPLT*PREL (JROF)
      PALPHPLM_DER (JROF, JLEV)=ZCOEFAPLT*PREM (JROF)

      IF (LDCOEF) THEN
        PCOEFA_DER (JROF, JLEV)=ZCOEFAT
        PCOEFAPL_DER (JROF, JLEV)=ZCOEFAPLT
      ENDIF

    
    ENDDO

  ENDIF

ENDIF


END SUBROUTINE GPGRXYB_EXPL_OPENACC
