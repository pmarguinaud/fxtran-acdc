SUBROUTINE APL_ARPEGE_SOIL_HYDRO_PARALLEL (YDMF_PHYS_BASE_STATE, YDCPG_BNDS, YDCPG_OPTS, YDMF_PHYS&
&, YDMF_PHYS_SURF, YDMODEL, YD_PCHROV, YD_PFLU_NEIJ, YD_PFLU_QSAT, YD_PFLU_QSATS, YD_PFLU_VEG&
&, YD_PGWDCS, YD_PHQ, YD_PHTR, YD_PHU, YD_PQV, YD_PWFC, YD_PWLMX, YD_PWWILT)
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK

USE MF_PHYS_BASE_STATE_TYPE_MOD,ONLY:MF_PHYS_BASE_STATE_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MF_PHYS_TYPE_MOD,ONLY:MF_PHYS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE
USE TYPE_MODEL,ONLY:MODEL
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (MF_PHYS_BASE_STATE_TYPE), INTENT (IN)::YDMF_PHYS_BASE_STATE
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (MF_PHYS_TYPE), INTENT (INOUT)::YDMF_PHYS
TYPE (MF_PHYS_SURF_TYPE), INTENT (INOUT)::YDMF_PHYS_SURF
TYPE (MODEL), INTENT (IN)::YDMODEL
CLASS (FIELD_2RB), POINTER :: YD_PCHROV
REAL (KIND=JPRB), POINTER::PCHROV (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PFLU_NEIJ
REAL (KIND=JPRB), POINTER::PFLU_NEIJ (:,:)
CLASS (FIELD_3RB), POINTER :: YD_PFLU_QSAT
REAL (KIND=JPRB), POINTER::PFLU_QSAT (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PFLU_QSATS
REAL (KIND=JPRB), POINTER::PFLU_QSATS (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PFLU_VEG
REAL (KIND=JPRB), POINTER::PFLU_VEG (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PGWDCS
REAL (KIND=JPRB), POINTER::PGWDCS (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PHQ
REAL (KIND=JPRB), POINTER::PHQ (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PHTR
REAL (KIND=JPRB), POINTER::PHTR (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PHU
REAL (KIND=JPRB), POINTER::PHU (:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQV
REAL (KIND=JPRB), POINTER::PQV (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PWFC
REAL (KIND=JPRB), POINTER::PWFC (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PWLMX
REAL (KIND=JPRB), POINTER::PWLMX (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PWWILT
REAL (KIND=JPRB), POINTER::PWWILT (:,:)
#include "acveg.intfb.h"
#include "abor1.intfb.h"
#include "acveg_openacc.intfb.h"
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER (KIND=JPIM) :: JLON
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL (KIND=JPRB), POINTER :: Z_YDMF_PHYS_BASE_STATE_T(:,:,:)
REAL (KIND=JPRB), POINTER :: Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC(:,:)
REAL (KIND=JPRB), POINTER :: Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q(:,:,:)
REAL (KIND=JPRB), POINTER :: Z_YDMF_PHYS_OUT_FRSO(:,:,:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VF_PLSM(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VV_PD2(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VV_PHV(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VV_PIVEG(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VV_PLAI(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN(:,:)
IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)



IF (YDMODEL%YRML_PHY_MF%YRPHY%LSOLV.AND.(.NOT.YDMODEL%YRML_PHY_MF%YRARPHY%LMSE)) THEN
  IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG',0,ZHOOK_HANDLE_PARALLEL)

  IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PCHROV => GET_HOST_DATA_RDONLY (YD_PCHROV)
    PFLU_NEIJ => GET_HOST_DATA_RDONLY (YD_PFLU_NEIJ)
    PFLU_QSAT => GET_HOST_DATA_RDONLY (YD_PFLU_QSAT)
    PFLU_QSATS => GET_HOST_DATA_RDONLY (YD_PFLU_QSATS)
    PFLU_VEG => GET_HOST_DATA_RDONLY (YD_PFLU_VEG)
    PGWDCS => GET_HOST_DATA_RDONLY (YD_PGWDCS)
    PHQ => GET_HOST_DATA_RDWR (YD_PHQ)
    PHTR => GET_HOST_DATA_RDWR (YD_PHTR)
    PHU => GET_HOST_DATA_RDWR (YD_PHU)
    PQV => GET_HOST_DATA_RDONLY (YD_PQV)
    PWFC => GET_HOST_DATA_RDONLY (YD_PWFC)
    PWLMX => GET_HOST_DATA_RDWR (YD_PWLMX)
    PWWILT => GET_HOST_DATA_RDONLY (YD_PWWILT)
    Z_YDMF_PHYS_BASE_STATE_T => GET_HOST_DATA_RDONLY (YDMF_PHYS_BASE_STATE%F_T)
    Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => GET_HOST_DATA_RDONLY (YDMF_PHYS_BASE_STATE%YGSP_RR%F_FC)
    Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => GET_HOST_DATA_RDONLY (YDMF_PHYS_BASE_STATE%YGSP_SB%F_Q)
    Z_YDMF_PHYS_OUT_FRSO => GET_HOST_DATA_RDONLY (YDMF_PHYS%OUT%F_FRSO)
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VF%F_LSM)
    Z_YDMF_PHYS_SURF_GSD_VV_PD2 => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_D2)
    Z_YDMF_PHYS_SURF_GSD_VV_PHV => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_HV)
    Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_IVEG)
    Z_YDMF_PHYS_SURF_GSD_VV_PLAI => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_LAI)
    Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_RSMIN)
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
    !$OMP PARALLEL DO PRIVATE (JBLK) FIRSTPRIVATE (YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      CALL YLCPG_BNDS%UPDATE (JBLK)
      
      CALL ACVEG (YDMODEL%YRML_PHY_MF%YRPHY, YDMODEL%YRML_PHY_MF%YRPHY1, YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA&
      &, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, Z_YDMF_PHYS_OUT_FRSO(:,:,:, JBLK), PQV(:,:, JBLK), PFLU_QSAT&
      &(:,:, JBLK), Z_YDMF_PHYS_BASE_STATE_T(:,:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PD2(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VF_PLSM&
      &(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PIVEG(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PLAI(:, JBLK), PFLU_NEIJ&
      &(:, JBLK), PFLU_VEG(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN(:, JBLK), PCHROV(:, JBLK), PGWDCS(&
      &:, JBLK), PWFC(:, JBLK), Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC(:, JBLK), PWWILT(:, JBLK), Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q&
      & (:, 1, JBLK), PFLU_QSATS(:, JBLK), PHQ(:, JBLK), PHTR(:, JBLK), PHU(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PHV&
      &(:, JBLK), PWLMX(:, JBLK))
    ENDDO

    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG')) THEN
      IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PCHROV => GET_HOST_DATA_RDWR (YD_PCHROV)
      PFLU_NEIJ => GET_HOST_DATA_RDWR (YD_PFLU_NEIJ)
      PFLU_QSAT => GET_HOST_DATA_RDWR (YD_PFLU_QSAT)
      PFLU_QSATS => GET_HOST_DATA_RDWR (YD_PFLU_QSATS)
      PFLU_VEG => GET_HOST_DATA_RDWR (YD_PFLU_VEG)
      PGWDCS => GET_HOST_DATA_RDWR (YD_PGWDCS)
      PHQ => GET_HOST_DATA_RDWR (YD_PHQ)
      PHTR => GET_HOST_DATA_RDWR (YD_PHTR)
      PHU => GET_HOST_DATA_RDWR (YD_PHU)
      PQV => GET_HOST_DATA_RDWR (YD_PQV)
      PWFC => GET_HOST_DATA_RDWR (YD_PWFC)
      PWLMX => GET_HOST_DATA_RDWR (YD_PWLMX)
      PWWILT => GET_HOST_DATA_RDWR (YD_PWWILT)
      Z_YDMF_PHYS_BASE_STATE_T => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%F_T)
      Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%YGSP_RR%F_FC)
      Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%YGSP_SB%F_Q)
      Z_YDMF_PHYS_OUT_FRSO => GET_HOST_DATA_RDWR (YDMF_PHYS%OUT%F_FRSO)
      Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VF%F_LSM)
      Z_YDMF_PHYS_SURF_GSD_VV_PD2 => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_D2)
      Z_YDMF_PHYS_SURF_GSD_VV_PHV => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_HV)
      Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_IVEG)
      Z_YDMF_PHYS_SURF_GSD_VV_PLAI => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_LAI)
      Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_RSMIN)
      IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PCHROV => NULL ()
    PFLU_NEIJ => NULL ()
    PFLU_QSAT => NULL ()
    PFLU_QSATS => NULL ()
    PFLU_VEG => NULL ()
    PGWDCS => NULL ()
    PHQ => NULL ()
    PHTR => NULL ()
    PHU => NULL ()
    PQV => NULL ()
    PWFC => NULL ()
    PWLMX => NULL ()
    PWWILT => NULL ()
    Z_YDMF_PHYS_BASE_STATE_T => NULL ()
    Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => NULL ()
    Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => NULL ()
    Z_YDMF_PHYS_OUT_FRSO => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PD2 => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PHV => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PLAI => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => NULL ()
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN&
    &','APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PCHROV => GET_HOST_DATA_RDONLY (YD_PCHROV)
    PFLU_NEIJ => GET_HOST_DATA_RDONLY (YD_PFLU_NEIJ)
    PFLU_QSAT => GET_HOST_DATA_RDONLY (YD_PFLU_QSAT)
    PFLU_QSATS => GET_HOST_DATA_RDONLY (YD_PFLU_QSATS)
    PFLU_VEG => GET_HOST_DATA_RDONLY (YD_PFLU_VEG)
    PGWDCS => GET_HOST_DATA_RDONLY (YD_PGWDCS)
    PHQ => GET_HOST_DATA_RDWR (YD_PHQ)
    PHTR => GET_HOST_DATA_RDWR (YD_PHTR)
    PHU => GET_HOST_DATA_RDWR (YD_PHU)
    PQV => GET_HOST_DATA_RDONLY (YD_PQV)
    PWFC => GET_HOST_DATA_RDONLY (YD_PWFC)
    PWLMX => GET_HOST_DATA_RDWR (YD_PWLMX)
    PWWILT => GET_HOST_DATA_RDONLY (YD_PWWILT)
    Z_YDMF_PHYS_BASE_STATE_T => GET_HOST_DATA_RDONLY (YDMF_PHYS_BASE_STATE%F_T)
    Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => GET_HOST_DATA_RDONLY (YDMF_PHYS_BASE_STATE%YGSP_RR%F_FC)
    Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => GET_HOST_DATA_RDONLY (YDMF_PHYS_BASE_STATE%YGSP_SB%F_Q)
    Z_YDMF_PHYS_OUT_FRSO => GET_HOST_DATA_RDONLY (YDMF_PHYS%OUT%F_FRSO)
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VF%F_LSM)
    Z_YDMF_PHYS_SURF_GSD_VV_PD2 => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_D2)
    Z_YDMF_PHYS_SURF_GSD_VV_PHV => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_HV)
    Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_IVEG)
    Z_YDMF_PHYS_SURF_GSD_VV_PLAI => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_LAI)
    Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_RSMIN)
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    !$OMP PARALLEL DO PRIVATE (JBLK, JLON, YLCPG_BNDS, YLSTACK)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

      

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON
        YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        
        CALL ACVEG_OPENACC (YDMODEL%YRML_PHY_MF%YRPHY, YDMODEL%YRML_PHY_MF%YRPHY1, YLCPG_BNDS%KIDIA, YLCPG_BNDS&
        &%KFDIA, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, Z_YDMF_PHYS_OUT_FRSO(:,:,:, JBLK), PQV(:,:, JBLK), PFLU_QSAT&
        &(:,:, JBLK), Z_YDMF_PHYS_BASE_STATE_T(:,:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PD2(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VF_PLSM&
        &(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PIVEG(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PLAI(:, JBLK), PFLU_NEIJ&
        &(:, JBLK), PFLU_VEG(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN(:, JBLK), PCHROV(:, JBLK), PGWDCS(:, JBLK&
        &), PWFC(:, JBLK), Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC(:, JBLK), PWWILT(:, JBLK), Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q&
        & (:, 1, JBLK), PFLU_QSATS(:, JBLK), PHQ(:, JBLK), PHTR(:, JBLK), PHU(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PHV&
        &(:, JBLK), PWLMX(:, JBLK),YDSTACK=YLSTACK)
      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG')) THEN
      IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PCHROV => GET_HOST_DATA_RDWR (YD_PCHROV)
      PFLU_NEIJ => GET_HOST_DATA_RDWR (YD_PFLU_NEIJ)
      PFLU_QSAT => GET_HOST_DATA_RDWR (YD_PFLU_QSAT)
      PFLU_QSATS => GET_HOST_DATA_RDWR (YD_PFLU_QSATS)
      PFLU_VEG => GET_HOST_DATA_RDWR (YD_PFLU_VEG)
      PGWDCS => GET_HOST_DATA_RDWR (YD_PGWDCS)
      PHQ => GET_HOST_DATA_RDWR (YD_PHQ)
      PHTR => GET_HOST_DATA_RDWR (YD_PHTR)
      PHU => GET_HOST_DATA_RDWR (YD_PHU)
      PQV => GET_HOST_DATA_RDWR (YD_PQV)
      PWFC => GET_HOST_DATA_RDWR (YD_PWFC)
      PWLMX => GET_HOST_DATA_RDWR (YD_PWLMX)
      PWWILT => GET_HOST_DATA_RDWR (YD_PWWILT)
      Z_YDMF_PHYS_BASE_STATE_T => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%F_T)
      Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%YGSP_RR%F_FC)
      Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%YGSP_SB%F_Q)
      Z_YDMF_PHYS_OUT_FRSO => GET_HOST_DATA_RDWR (YDMF_PHYS%OUT%F_FRSO)
      Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VF%F_LSM)
      Z_YDMF_PHYS_SURF_GSD_VV_PD2 => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_D2)
      Z_YDMF_PHYS_SURF_GSD_VV_PHV => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_HV)
      Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_IVEG)
      Z_YDMF_PHYS_SURF_GSD_VV_PLAI => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_LAI)
      Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_RSMIN)
      IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PCHROV => NULL ()
    PFLU_NEIJ => NULL ()
    PFLU_QSAT => NULL ()
    PFLU_QSATS => NULL ()
    PFLU_VEG => NULL ()
    PGWDCS => NULL ()
    PHQ => NULL ()
    PHTR => NULL ()
    PHU => NULL ()
    PQV => NULL ()
    PWFC => NULL ()
    PWLMX => NULL ()
    PWWILT => NULL ()
    Z_YDMF_PHYS_BASE_STATE_T => NULL ()
    Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => NULL ()
    Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => NULL ()
    Z_YDMF_PHYS_OUT_FRSO => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PD2 => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PHV => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PLAI => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => NULL ()
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN&
    &','APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PCHROV => GET_DEVICE_DATA_RDONLY (YD_PCHROV)
    PFLU_NEIJ => GET_DEVICE_DATA_RDONLY (YD_PFLU_NEIJ)
    PFLU_QSAT => GET_DEVICE_DATA_RDONLY (YD_PFLU_QSAT)
    PFLU_QSATS => GET_DEVICE_DATA_RDONLY (YD_PFLU_QSATS)
    PFLU_VEG => GET_DEVICE_DATA_RDONLY (YD_PFLU_VEG)
    PGWDCS => GET_DEVICE_DATA_RDONLY (YD_PGWDCS)
    PHQ => GET_DEVICE_DATA_RDWR (YD_PHQ)
    PHTR => GET_DEVICE_DATA_RDWR (YD_PHTR)
    PHU => GET_DEVICE_DATA_RDWR (YD_PHU)
    PQV => GET_DEVICE_DATA_RDONLY (YD_PQV)
    PWFC => GET_DEVICE_DATA_RDONLY (YD_PWFC)
    PWLMX => GET_DEVICE_DATA_RDWR (YD_PWLMX)
    PWWILT => GET_DEVICE_DATA_RDONLY (YD_PWWILT)
    Z_YDMF_PHYS_BASE_STATE_T => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_BASE_STATE%F_T)
    Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_BASE_STATE%YGSP_RR%F_FC)
    Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_BASE_STATE%YGSP_SB%F_Q)
    Z_YDMF_PHYS_OUT_FRSO => GET_DEVICE_DATA_RDONLY (YDMF_PHYS%OUT%F_FRSO)
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VF%F_LSM)
    Z_YDMF_PHYS_SURF_GSD_VV_PD2 => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_D2)
    Z_YDMF_PHYS_SURF_GSD_VV_PHV => GET_DEVICE_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_HV)
    Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_IVEG)
    Z_YDMF_PHYS_SURF_GSD_VV_PLAI => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_LAI)
    Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VV%F_RSMIN)
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    
      !$ACC PARALLEL LOOP GANG &
      !$ACC&PRESENT (PCHROV, PFLU_NEIJ, PFLU_QSAT, PFLU_QSATS, PFLU_VEG, PGWDCS, PHQ, &
      !$ACC&         PHTR, PHU, PQV, PWFC, PWLMX, PWWILT, YDCPG_OPTS, YDMODEL, YFXTRAN_ACDC_STACK, &
      !$ACC&         Z_YDMF_PHYS_BASE_STATE_T, Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC, &
      !$ACC&         Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q, Z_YDMF_PHYS_OUT_FRSO, &
      !$ACC&         Z_YDMF_PHYS_SURF_GSD_VF_PLSM, Z_YDMF_PHYS_SURF_GSD_VV_PD2, &
      !$ACC&         Z_YDMF_PHYS_SURF_GSD_VV_PHV, Z_YDMF_PHYS_SURF_GSD_VV_PIVEG, &
      !$ACC&         Z_YDMF_PHYS_SURF_GSD_VV_PLAI, Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN) &
      !$ACC&PRIVATE (JBLK) &
      !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
      
      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      
      
      
      !$ACC LOOP VECTOR &
      !$ACC&PRIVATE (JLON, YLCPG_BNDS, YLSTACK) 

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON
        YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
        
        CALL ACVEG_OPENACC (YDMODEL%YRML_PHY_MF%YRPHY, YDMODEL%YRML_PHY_MF%YRPHY1, YLCPG_BNDS%KIDIA, YLCPG_BNDS&
        &%KFDIA, YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG, Z_YDMF_PHYS_OUT_FRSO(:,:,:, JBLK), PQV(:,:, JBLK), PFLU_QSAT&
        &(:,:, JBLK), Z_YDMF_PHYS_BASE_STATE_T(:,:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PD2(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VF_PLSM&
        &(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PIVEG(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PLAI(:, JBLK), PFLU_NEIJ&
        &(:, JBLK), PFLU_VEG(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN(:, JBLK), PCHROV(:, JBLK), PGWDCS(:, JBLK&
        &), PWFC(:, JBLK), Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC(:, JBLK), PWWILT(:, JBLK), Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q&
        & (:, 1, JBLK), PFLU_QSATS(:, JBLK), PHQ(:, JBLK), PHTR(:, JBLK), PHU(:, JBLK), Z_YDMF_PHYS_SURF_GSD_VV_PHV&
        &(:, JBLK), PWLMX(:, JBLK),YDSTACK=YLSTACK)
      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG')) THEN
      IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PCHROV => GET_HOST_DATA_RDWR (YD_PCHROV)
      PFLU_NEIJ => GET_HOST_DATA_RDWR (YD_PFLU_NEIJ)
      PFLU_QSAT => GET_HOST_DATA_RDWR (YD_PFLU_QSAT)
      PFLU_QSATS => GET_HOST_DATA_RDWR (YD_PFLU_QSATS)
      PFLU_VEG => GET_HOST_DATA_RDWR (YD_PFLU_VEG)
      PGWDCS => GET_HOST_DATA_RDWR (YD_PGWDCS)
      PHQ => GET_HOST_DATA_RDWR (YD_PHQ)
      PHTR => GET_HOST_DATA_RDWR (YD_PHTR)
      PHU => GET_HOST_DATA_RDWR (YD_PHU)
      PQV => GET_HOST_DATA_RDWR (YD_PQV)
      PWFC => GET_HOST_DATA_RDWR (YD_PWFC)
      PWLMX => GET_HOST_DATA_RDWR (YD_PWLMX)
      PWWILT => GET_HOST_DATA_RDWR (YD_PWWILT)
      Z_YDMF_PHYS_BASE_STATE_T => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%F_T)
      Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%YGSP_RR%F_FC)
      Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => GET_HOST_DATA_RDWR (YDMF_PHYS_BASE_STATE%YGSP_SB%F_Q)
      Z_YDMF_PHYS_OUT_FRSO => GET_HOST_DATA_RDWR (YDMF_PHYS%OUT%F_FRSO)
      Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VF%F_LSM)
      Z_YDMF_PHYS_SURF_GSD_VV_PD2 => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_D2)
      Z_YDMF_PHYS_SURF_GSD_VV_PHV => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_HV)
      Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_IVEG)
      Z_YDMF_PHYS_SURF_GSD_VV_PLAI => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_LAI)
      Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VV%F_RSMIN)
      IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PCHROV => NULL ()
    PFLU_NEIJ => NULL ()
    PFLU_QSAT => NULL ()
    PFLU_QSATS => NULL ()
    PFLU_VEG => NULL ()
    PGWDCS => NULL ()
    PHQ => NULL ()
    PHTR => NULL ()
    PHU => NULL ()
    PQV => NULL ()
    PWFC => NULL ()
    PWLMX => NULL ()
    PWWILT => NULL ()
    Z_YDMF_PHYS_BASE_STATE_T => NULL ()
    Z_YDMF_PHYS_BASE_STATE_YGSP_RR_FC => NULL ()
    Z_YDMF_PHYS_BASE_STATE_YGSP_SB_Q => NULL ()
    Z_YDMF_PHYS_OUT_FRSO => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PD2 => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PHV => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PIVEG => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PLAI => NULL ()
    Z_YDMF_PHYS_SURF_GSD_VV_PRSMIN => NULL ()
    IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSE
      CALL ABOR1 ('APL_ARPEGE_SOIL_HYDRO_PARALLEL: NOT METHOD WAS FOUND')
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL:ACVEG',1,ZHOOK_HANDLE_PARALLEL)
ENDIF



CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('APL_ARPEGE_SOIL_HYDRO_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE APL_ARPEGE_SOIL_HYDRO_PARALLEL
