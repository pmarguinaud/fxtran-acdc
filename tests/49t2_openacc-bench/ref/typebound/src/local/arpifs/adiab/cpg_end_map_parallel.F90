SUBROUTINE CPG_END_MAP_PARALLEL (YDGEOMETRY, YDMODEL, YDVARS, YDCPG_BNDS, YDCPG_OPTS)

USE YOMHOOK,ONLY:DR_HOOK, LHOOK, JPHOOK
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE TYPE_MODEL,ONLY:MODEL
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
#include "gpmpfc_expl_parallel.intfb.h"
INTEGER (KIND=JPIM), PARAMETER::IFLAG=1_JPIM
REAL (KIND=JPRB), PARAMETER::ZEPS=100.0_JPRB*TINY (1.0_JPRB)
LOGICAL::LLSTR
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER (KIND=JPIM) :: JLON
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
IF (LHOOK) CALL DR_HOOK ('CPG_END_MAP_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
LLSTR=(ABS (YDGEOMETRY%YRGEM%RSTRET-1.0_JPRB)>ZEPS)

IF (LLSTR.AND.(.NOT.YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY)) THEN
  CALL GPMPFC_EXPL_PARALLEL (YDVARS, YDMODEL%YRML_GCONF, YDMODEL%YRML_DYN%YRDYN, YDMODEL&
  &%YRML_DYN%YRDYNA, YDCPG_OPTS, YDCPG_BNDS, IFLAG, YDVARS%GEOMETRY%GM%FT0)
ENDIF


CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CPG_END_MAP_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE CPG_END_MAP_PARALLEL
