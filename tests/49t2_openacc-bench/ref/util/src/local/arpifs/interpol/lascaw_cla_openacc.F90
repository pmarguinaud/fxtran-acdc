SUBROUTINE LASCAW_CLA_OPENACC (YDSL, YDDYNA, KFLEV, KPROMA, KST, KEND, LDT, PSLHDKMIN&
&, KILA, PDLAT, PKAPPA, YDDHSLMER, PSLDW, PCLA, PCLASLD, YDSTACK)
!$ACC ROUTINE (LASCAW_CLA_OPENACC) SEQ
USE PARKIND1,ONLY:JPIB, JPIM, JPRB

USE YOMDYNA,ONLY:TDYNA
USE EINT_MOD,ONLY:SL_STRUCT
USE YOMHSLMER,ONLY:THSLMER
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (SL_STRUCT), INTENT (IN)::YDSL
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
LOGICAL, INTENT (IN)::LDT (4)
INTEGER (KIND=JPIM), INTENT (IN)::KILA (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PSLHDKMIN
REAL (KIND=JPRB), INTENT (IN)::PDLAT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PKAPPA (KPROMA, KFLEV)
TYPE (THSLMER), INTENT (IN)::YDDHSLMER
REAL (KIND=JPRB), INTENT (IN)::PSLDW (3, 3, YDSL%NDGSAH:YDSL%NDGENH)
REAL (KIND=JPRB), INTENT (INOUT)::PCLA (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (OUT)::PCLASLD (KPROMA, KFLEV, 3)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIB)::ILA64
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::ILA
LOGICAL::LLSLHD_OLD
LOGICAL::LLSLHDQUAD
LOGICAL::LLSLHD
REAL (KIND=JPRB)::ZSQR
REAL (KIND=JPRB)::ZWL3
REAL (KIND=JPRB)::ZWL2
REAL (KIND=JPRB)::ZWL1
REAL (KIND=JPRB)::ZWDS3
REAL (KIND=JPRB)::ZWDS2
REAL (KIND=JPRB)::ZWDS1
REAL (KIND=JPRB)::ZWD3
REAL (KIND=JPRB)::ZWD2
REAL (KIND=JPRB)::ZWD1
REAL (KIND=JPRB)::ZKAP
REAL (KIND=JPRB)::ZSLHDKMIN


JROF = KST


LLSLHD=LDT (1)
LLSLHDQUAD=LDT (2)
LLSLHD_OLD=LDT (3)

IF (LLSLHDQUAD.OR.LLSLHD) THEN

  DO JLEV=1, KFLEV

    

    IF (LLSLHDQUAD) THEN
      ILA=KILA (JROF, JLEV)+1
      ZSQR=PDLAT (JROF, JLEV)*(1._JPRB-PDLAT (JROF, JLEV))
      ZWL1=ZSQR*YDDHSLMER%RSLD (ILA, 1)+(1._JPRB-PDLAT (JROF, JLEV))
      ZWL2=ZSQR*YDDHSLMER%RSLD (ILA, 2)+PDLAT (JROF, JLEV)
      ZWL3=ZSQR*YDDHSLMER%RSLD (ILA, 3)
    ENDIF


    IF (LLSLHD) THEN

      IF (LLSLHD_OLD) THEN
        ZWL2=PDLAT (JROF, JLEV)
        ZWL1=1.0_JPRB-ZWL2
        ZWL3=0.0_JPRB
      ENDIF

      ILA64=KILA (JROF, JLEV)+1
      
      ZWD1=PCLA (JROF, JLEV, 1)+YDDYNA%SLHDKMAX*(ZWL1-PCLA (JROF, JLEV, 1))
      ZWD2=PCLA (JROF, JLEV, 2)+YDDYNA%SLHDKMAX*(ZWL2-PCLA (JROF, JLEV, 2))
      ZWD3=PCLA (JROF, JLEV, 3)+YDDYNA%SLHDKMAX*(ZWL3-PCLA (JROF, JLEV, 3))
      ZWDS1=PSLDW (1, 1, ILA64)*ZWD1+PSLDW (1, 2, ILA64)*ZWD2+PSLDW (1, 3, ILA64)*ZWD3
      ZWDS2=PSLDW (2, 1, ILA64)*ZWD1+PSLDW (2, 2, ILA64)*ZWD2+PSLDW (2, 3, ILA64)*ZWD3
      ZWDS3=PSLDW (3, 1, ILA64)*ZWD1+PSLDW (3, 2, ILA64)*ZWD2+PSLDW (3, 3, ILA64)*ZWD3

      IF (PKAPPA (JROF, JLEV)<0._JPRB) THEN
        ZKAP=-PKAPPA (JROF, JLEV)
        ZSLHDKMIN=YDDYNA%SLHDKREF
      ELSE
        ZKAP=PKAPPA (JROF, JLEV)
        ZSLHDKMIN=PSLHDKMIN
      ENDIF

      PCLA (JROF, JLEV, 1)=PCLA (JROF, JLEV, 1)+ZSLHDKMIN*(ZWL1-PCLA (JROF, JLEV, 1))
      PCLA (JROF, JLEV, 2)=PCLA (JROF, JLEV, 2)+ZSLHDKMIN*(ZWL2-PCLA (JROF, JLEV, 2))
      PCLA (JROF, JLEV, 3)=PCLA (JROF, JLEV, 3)+ZSLHDKMIN*(ZWL3-PCLA (JROF, JLEV, 3))
      PCLASLD (JROF, JLEV, 1)=PCLA (JROF, JLEV, 1)+ZKAP*(ZWDS1-PCLA (JROF, JLEV, 1))
      PCLASLD (JROF, JLEV, 2)=PCLA (JROF, JLEV, 2)+ZKAP*(ZWDS2-PCLA (JROF, JLEV, 2))
      PCLASLD (JROF, JLEV, 3)=PCLA (JROF, JLEV, 3)+ZKAP*(ZWDS3-PCLA (JROF, JLEV, 3))
    ELSE
      PCLA (JROF, JLEV, 1)=PCLA (JROF, JLEV, 1)+PSLHDKMIN*(ZWL1-PCLA (JROF, JLEV, 1))
      PCLA (JROF, JLEV, 2)=PCLA (JROF, JLEV, 2)+PSLHDKMIN*(ZWL2-PCLA (JROF, JLEV, 2))
      PCLA (JROF, JLEV, 3)=PCLA (JROF, JLEV, 3)+PSLHDKMIN*(ZWL3-PCLA (JROF, JLEV, 3))
      PCLASLD (JROF, JLEV, 1)=PCLA (JROF, JLEV, 1)
      PCLASLD (JROF, JLEV, 2)=PCLA (JROF, JLEV, 2)
      PCLASLD (JROF, JLEV, 3)=PCLA (JROF, JLEV, 3)
    ENDIF

  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    PCLASLD (JROF, JLEV, 1)=PCLA (JROF, JLEV, 1)
    PCLASLD (JROF, JLEV, 2)=PCLA (JROF, JLEV, 2)
    PCLASLD (JROF, JLEV, 3)=PCLA (JROF, JLEV, 3)
  
  ENDDO

ENDIF


END SUBROUTINE LASCAW_CLA_OPENACC
