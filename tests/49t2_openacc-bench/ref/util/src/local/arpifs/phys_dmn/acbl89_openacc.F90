SUBROUTINE ACBL89_OPENACC (YDCST, YDPHY, YDPHY0, KIDIA, KFDIA, KLON, KTDIAN, KLEV, PAPHI, PAPHIF, PAPRS&
&, PAPRSF, PT, PECT, PQV, PQICE, PQLI, PNLAB, PNLABCVP, PGZ0, PTS, PUSLE, PLMECT, PPHI3, YDSTACK)
!$ACC ROUTINE (ACBL89_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMPHY,ONLY:TPHY
USE YOMPHY0,ONLY:TPHY0
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY0), INTENT (IN)::YDPHY0
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIAN
REAL (KIND=JPRB), INTENT (IN)::PNLAB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNLABCVP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PECT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQICE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGZ0 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PUSLE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLMECT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PPHI3 (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZGDZH, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGDZF, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDTHETA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTHETA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTHETAH, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTHETAP, (KLON, KLEV))
REAL (KIND=JPRB)::ZGZTOPCVP 
REAL (KIND=JPRB)::ZGZBOTCVP 
REAL (KIND=JPRB)::ZGZTOP 
REAL (KIND=JPRB)::ZGZBOT 
REAL (KIND=JPRB)::ZEN 
fxtran_acdc_temp (REAL (KIND=JPRB), ZPHIH, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGLMDN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGLMUP, (KLON, KLEV))
REAL (KIND=JPRB)::ZTESTSAVE 
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JJLEV
REAL (KIND=JPRB)::ZLWK1 
REAL (KIND=JPRB)::ZLWK0
REAL (KIND=JPRB)::ZLDN
REAL (KIND=JPRB)::ZLUP 
REAL (KIND=JPRB)::Z2SQRT2
REAL (KIND=JPRB)::ZGZLCVPDN
REAL (KIND=JPRB)::ZGZLCVPUP
REAL (KIND=JPRB)::ZQCS
REAL (KIND=JPRB)::ZZTHVLP
REAL (KIND=JPRB)::ZZTHVL
REAL (KIND=JPRB)::ZZDTHVLP
REAL (KIND=JPRB)::ZZDTHVL
REAL (KIND=JPRB)::ZX
REAL (KIND=JPRB)::ZUSX
REAL (KIND=JPRB)::ZTESTM
REAL (KIND=JPRB)::ZTEST0
REAL (KIND=JPRB)::ZTEST
REAL (KIND=JPRB)::ZPHI3MAX
REAL (KIND=JPRB)::ZGLMIX
REAL (KIND=JPRB)::ZGLMINF
REAL (KIND=JPRB)::ZGLMCBR
REAL (KIND=JPRB)::ZGLKARMN
REAL (KIND=JPRB)::ZGLDIS
REAL (KIND=JPRB)::ZG2L2SLD2
REAL (KIND=JPRB)::ZINCR
REAL (KIND=JPRB)::ZEPSX
REAL (KIND=JPRB)::ZDPHI
REAL (KIND=JPRB)::ZDLUP2
REAL (KIND=JPRB)::ZDLUP1
REAL (KIND=JPRB)::ZDLUP
REAL (KIND=JPRB)::ZDLDN2
REAL (KIND=JPRB)::ZDLDN1
REAL (KIND=JPRB)::ZDLDN


YLSTACK = YDSTACK



IF (KIND (ZGDZH) == 8) THEN
    fxtran_acdc_alloc8 (ZGDZH)
ELSEIF (KIND (ZGDZH) == 4) THEN
    fxtran_acdc_alloc4 (ZGDZH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGDZF) == 8) THEN
    fxtran_acdc_alloc8 (ZGDZF)
ELSEIF (KIND (ZGDZF) == 4) THEN
    fxtran_acdc_alloc4 (ZGDZF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDTHETA) == 8) THEN
    fxtran_acdc_alloc8 (ZDTHETA)
ELSEIF (KIND (ZDTHETA) == 4) THEN
    fxtran_acdc_alloc4 (ZDTHETA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHETA) == 8) THEN
    fxtran_acdc_alloc8 (ZTHETA)
ELSEIF (KIND (ZTHETA) == 4) THEN
    fxtran_acdc_alloc4 (ZTHETA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHETAH) == 8) THEN
    fxtran_acdc_alloc8 (ZTHETAH)
ELSEIF (KIND (ZTHETAH) == 4) THEN
    fxtran_acdc_alloc4 (ZTHETAH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHETAP) == 8) THEN
    fxtran_acdc_alloc8 (ZTHETAP)
ELSEIF (KIND (ZTHETAP) == 4) THEN
    fxtran_acdc_alloc4 (ZTHETAP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPHIH) == 8) THEN
    fxtran_acdc_alloc8 (ZPHIH)
ELSEIF (KIND (ZPHIH) == 4) THEN
    fxtran_acdc_alloc4 (ZPHIH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGLMDN) == 8) THEN
    fxtran_acdc_alloc8 (ZGLMDN)
ELSEIF (KIND (ZGLMDN) == 4) THEN
    fxtran_acdc_alloc4 (ZGLMDN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGLMUP) == 8) THEN
    fxtran_acdc_alloc8 (ZGLMUP)
ELSEIF (KIND (ZGLMUP) == 4) THEN
    fxtran_acdc_alloc4 (ZGLMUP)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPSX=YDPHY0%ECTMIN
ZPHI3MAX=(1.0_JPRB-YDPHY0%ACBRPHIM)/YDPHY0%ACBRPHIM

DO JLEV=KTDIAN, KLEV
  
  ZGDZH (JLON, JLEV)=PAPHIF (JLON, JLEV)-PAPHI (JLON, JLEV)
  
ENDDO


DO JLEV=KTDIAN+1, KLEV
  
  ZGDZF (JLON, JLEV)=PAPHIF (JLON, JLEV-1)-PAPHIF (JLON, JLEV)
  
ENDDO

ZGZTOP =0.0_JPRB
ZGZBOT =100000.0_JPRB
ZGZTOPCVP =0.0_JPRB
ZGZBOTCVP =100000.0_JPRB

DO JLEV=KTDIAN, KLEV
  
  ZGZTOP =MAX (ZGZTOP , PAPHIF (JLON, JLEV)*PNLAB (JLON, JLEV))
  ZGZBOT =(1.0_JPRB-PNLAB (JLON, JLEV))*ZGZBOT +PNLAB (JLON, JLEV)*MIN (ZGZBOT , PAPHIF (JLON, JLEV))
  
ENDDO


DO JLEV=KTDIAN, KLEV
  
  ZGZTOPCVP =MAX (ZGZTOPCVP , PAPHIF (JLON, JLEV)*PNLABCVP (JLON, JLEV))
  ZGZBOTCVP =(1.0_JPRB-PNLABCVP (JLON, JLEV))*ZGZBOTCVP +PNLABCVP&
  & (JLON, JLEV)*MIN (ZGZBOTCVP , PAPHIF (JLON, JLEV))
  
ENDDO


DO JLEV=KTDIAN, KLEV
  
  ZTHETA (JLON, JLEV)=(PT (JLON, JLEV)*(YDCST%RATM/PAPRSF (JLON, JLEV))**(YDCST%RKAPPA&
  &))*(1.0_JPRB+YDCST%RETV*PQV (JLON, JLEV)-(PQLI (JLON, JLEV)+PQICE (JLON, JLEV)))
  
ENDDO


DO JLEV=KTDIAN, KLEV-1
  
  ZTHETAH (JLON, JLEV)=0.5_JPRB*(ZTHETA (JLON, JLEV)+ZTHETA (JLON, JLEV+1))
  
ENDDO


ZTHETAH (JLON, KLEV)=PTS (JLON)*(YDCST%RATM/PAPRS (JLON, KLEV))**(YDCST%RKAPPA)


DO JLEV=KTDIAN+1, KLEV
  
  ZDTHETA (JLON, JLEV)=ZTHETA (JLON, JLEV-1)-ZTHETA (JLON, JLEV)
  
ENDDO

ZQCS=1.0E-6_JPRB

DO JLEV=KTDIAN, KLEV-1

  DO JJLEV=KTDIAN, KLEV
    
    ZTHETAP (JLON, JJLEV)=ZTHETAH (JLON, JLEV)
  
  ENDDO

  
  ZEN =PECT (JLON, JLEV)
  ZGLMUP (JLON, JLEV)=0.0_JPRB
  
  
  ZDLUP1=ZGDZH (JLON, JLEV)
  ZINCR=(ZTHETA (JLON, JLEV)-ZTHETAP (JLON, JLEV))/ZTHETAH (JLON, JLEV)/2.0_JPRB*ZDLUP1
  ZINCR=SIGN (1._JPRB, ZINCR)*MAX (1.E-10_JPRB, ABS (ZINCR))
  ZTEST0=0.5_JPRB+SIGN (0.5_JPRB, ZEN )
  ZTEST=0.5_JPRB+SIGN (0.5_JPRB, ZEN -ZINCR)
  ZTESTSAVE =ZTEST
  ZDLUP2=SQRT (ABS (ZEN /ZINCR))*ZDLUP1
  ZDLUP=ZTEST*ZDLUP1+(1.0_JPRB-ZTEST)*ZDLUP2
  ZGLMUP (JLON, JLEV)=ZGLMUP (JLON, JLEV)+ZDLUP*ZTEST0
  ZEN =ZEN -ZINCR*ZTEST0
  
  ZTESTM=ZTESTSAVE

  DO JJLEV=JLEV, KTDIAN+1,-1

    IF (ZTESTM>0.0_JPRB) THEN
      
      ZDLUP1=ZGDZF (JLON, JJLEV)
      ZZTHVL=(ZTHETA (JLON, JJLEV)+ZTHETA (JLON, JJLEV-1))/2.0_JPRB
      ZZTHVLP=(ZTHETAP (JLON, JJLEV)+ZTHETAP (JLON, JJLEV-1))/2.0_JPRB
      ZINCR=(ZZTHVL-ZZTHVLP)/ZTHETAH (JLON, JLEV)*ZDLUP1
      ZINCR=SIGN (1._JPRB, ZINCR)*MAX (1.E-10_JPRB, ABS (ZINCR))
      ZTEST0=0.5_JPRB+SIGN (0.5_JPRB, ZEN )
      ZTEST=0.5_JPRB+SIGN (0.5_JPRB, ZEN -ZINCR)
      ZTESTSAVE =ZTEST
      ZZDTHVL=ZTHETA (JLON, JJLEV-1)-ZTHETA (JLON, JJLEV)
      ZZDTHVLP=ZTHETAP (JLON, JJLEV-1)-ZTHETAP (JLON, JJLEV)
      ZX=(ZZDTHVL-ZZDTHVLP)/ZTHETAH (JLON, JLEV)/ZINCR*ZDLUP1
      ZUSX=1.0_JPRB/(SIGN (1.0_JPRB, ZX)*MAX (ZEPSX, ABS (ZX)))
      ZDLUP2=(-(ZUSX-0.5_JPRB)+SIGN (1.0_JPRB, ZX)*SQRT (ABS ((ZUSX-0.5_JPRB&
      &)*(ZUSX-0.5_JPRB)+2.0_JPRB*ZUSX*ABS (ZEN /ZINCR))))*ZDLUP1
      ZDLUP=ZTEST*ZDLUP1+(1.0_JPRB-ZTEST)*ZDLUP2
      ZGLMUP (JLON, JLEV)=ZGLMUP (JLON, JLEV)+ZDLUP*ZTEST0
      ZEN =ZEN -ZINCR*ZTEST0
      
      ZTESTM=ZTESTSAVE
    ENDIF

  ENDDO

  
  ZEN =PECT (JLON, JLEV)
  ZGLMDN (JLON, JLEV)=0.0_JPRB
  
  
  ZDLDN1=ZGDZF (JLON, JLEV+1)-ZGDZH (JLON, JLEV)
  ZINCR=(ZTHETAP (JLON, JLEV+1)-ZTHETA (JLON, JLEV+1))/ZTHETAH (JLON, JLEV)/2.0_JPRB*ZDLDN1
  ZINCR=SIGN (1._JPRB, ZINCR)*MAX (1.E-10_JPRB, ABS (ZINCR))
  ZTEST0=0.5_JPRB+SIGN (0.5_JPRB, ZEN )
  ZTEST=0.5_JPRB+SIGN (0.5_JPRB, ZEN -ZINCR)
  ZTESTSAVE =ZTEST
  ZDLDN2=SQRT (ABS (ZEN /ZINCR))*ZDLDN1
  ZDLDN=ZTEST*ZDLDN1+(1.0_JPRB-ZTEST)*ZDLDN2
  ZGLMDN (JLON, JLEV)=ZGLMDN (JLON, JLEV)+ZDLDN*ZTEST0
  ZEN =ZEN -ZINCR*ZTEST0
  
  ZTESTM=ZTESTSAVE

  DO JJLEV=JLEV+1, KLEV-1

    IF (ZTESTM>0.0_JPRB) THEN
      ZTESTM=0.0_JPRB
      
      ZDLDN1=ZGDZF (JLON, JJLEV+1)
      ZZTHVL=(ZTHETA (JLON, JJLEV)+ZTHETA (JLON, JJLEV+1))/2.0_JPRB
      ZZTHVLP=(ZTHETAP (JLON, JJLEV)+ZTHETAP (JLON, JJLEV+1))/2.0_JPRB
      ZINCR=(ZZTHVLP-ZZTHVL)/ZTHETAH (JLON, JLEV)*ZDLDN1
      ZINCR=SIGN (1._JPRB, ZINCR)*MAX (1.E-10_JPRB, ABS (ZINCR))
      ZTEST0=0.5_JPRB+SIGN (0.5_JPRB, ZEN )
      ZTEST=0.5_JPRB+SIGN (0.5_JPRB, ZEN -ZINCR)
      ZTESTSAVE =ZTEST
      ZZDTHVL=ZTHETA (JLON, JJLEV)-ZTHETA (JLON, JJLEV+1)
      ZZDTHVLP=ZTHETAP (JLON, JJLEV)-ZTHETAP (JLON, JJLEV+1)
      ZX=(ZZDTHVL-ZZDTHVLP)/ZTHETAH (JLON, JLEV)/ZINCR*ZDLDN1
      ZUSX=1.0_JPRB/(SIGN (1.0_JPRB, ZX)*MAX (ZEPSX, ABS (ZX)))
      ZDLDN2=(-(ZUSX-0.5_JPRB)+SIGN (1.0_JPRB, ZX)*SQRT (ABS ((ZUSX-0.5_JPRB&
      &)*(ZUSX-0.5_JPRB)+2.0_JPRB*ZUSX*ABS (ZEN /ZINCR))))*ZDLDN1
      ZDLDN=ZTEST*ZDLDN1+(1.0_JPRB-ZTEST)*ZDLDN2
      ZGLMDN (JLON, JLEV)=ZGLMDN (JLON, JLEV)+ZDLDN*ZTEST0
      ZEN =ZEN -ZINCR*ZTEST0
      
      ZTESTM=ZTESTSAVE
    ENDIF

  ENDDO

  
  ZPHIH (JLON, JLEV)=PAPHI (JLON, JLEV)-PAPHI (JLON, KLEV)+PGZ0 (JLON)
  ZTEST0=0.5_JPRB+SIGN (0.5_JPRB, ZEN )
  ZGLMDN (JLON, JLEV)=ZGLMDN (JLON, JLEV)+ZTEST0*(PAPHIF (JLON, KLEV)-PAPHI (JLON, KLEV))
  ZGLMDN (JLON, JLEV)=MIN (ZPHIH (JLON, JLEV), ZGLMDN (JLON, JLEV))

  IF (YDPHY%LECSHAL) THEN
    ZGLMUP (JLON, JLEV)=MAX (ZGLMUP (JLON, JLEV), PNLAB (JLON, JLEV)*(ZGZTOP -PAPHI (JLON, JLEV)))
    ZGLMDN (JLON, JLEV)=MAX (ZGLMDN (JLON, JLEV), PNLAB (JLON, JLEV)*(PAPHI (JLON, JLEV)-ZGZBOT ))
  ENDIF


  IF (YDPHY%LECDEEP) THEN
    ZGZLCVPUP=MIN (YDCST%RG*YDPHY0%ALMAVX, ZGZTOPCVP -PAPHI (JLON, JLEV))
    ZGZLCVPDN=MIN (YDCST%RG*YDPHY0%ALMAVX, PAPHI (JLON, JLEV)-ZGZBOTCVP )
    ZGLMUP (JLON, JLEV)=MAX (ZGLMUP (JLON, JLEV), PNLABCVP (JLON, JLEV)*ZGZLCVPUP)
    ZGLMDN (JLON, JLEV)=MAX (ZGLMDN (JLON, JLEV), PNLABCVP (JLON, JLEV)*ZGZLCVPDN)
  ENDIF

  
ENDDO


DO JLEV=KLEV-2, KTDIAN,-1
  
  ZGLMUP (JLON, JLEV)=MAX (ZGLMUP (JLON, JLEV), ZGLMUP (JLON&
  &, JLEV+1)+PAPHI (JLON, JLEV+1)-PAPHI (JLON, JLEV))
  
ENDDO


DO JLEV=KTDIAN+1, KLEV-1
  
  ZGLMDN (JLON, JLEV)=MAX (ZGLMDN (JLON, JLEV), ZGLMDN (JLON&
  &, JLEV-1)+PAPHI (JLON, JLEV)-PAPHI (JLON, JLEV-1))
  
ENDDO

Z2SQRT2=2._JPRB*SQRT (2._JPRB)

DO JLEV=KTDIAN, KLEV-1
  
  ZLUP =MAX (ZGLMUP (JLON, JLEV), 1.E-10_JPRB)
  ZLDN=MAX (ZGLMDN (JLON, JLEV), 1.E-10_JPRB)
  ZLWK0=ZLUP /ZLDN
  ZLWK1 =1._JPRB+ZLWK0**(2.0_JPRB/3._JPRB)
  
  
  ZGLMCBR=Z2SQRT2*ZLUP /(ZLWK1 *SQRT (ZLWK1 ))
  ZGLKARMN=YDPHY0%VKARMN*ZPHIH (JLON, JLEV)
  ZGLMINF=MIN (YDCST%RG*YDPHY0%ALMAVE, ZGLKARMN)
  ZGLMIX=MAX (ZGLMINF, ZGLMCBR)
  ZGLDIS=MAX (ZGLMINF, ZGLMCBR)
  PLMECT (JLON, JLEV)=ZGLMIX
  PUSLE (JLON, JLEV)=1.0_JPRB/(YDPHY0%ALD*ZGLDIS)
  ZDPHI=ZGDZF (JLON, JLEV+1)
  ZG2L2SLD2=MAX (ZPHI3MAX, YDPHY0%ARSC1*MIN (2.0_JPRB, ZGLMCBR*ZGLMCBR*ZDTHETA&
  & (JLON, JLEV+1)/ZDPHI/PECT (JLON, JLEV)/ZTHETAH (JLON, JLEV)))
  PPHI3 (JLON, JLEV)=1.0_JPRB/(1.0_JPRB+ZG2L2SLD2)
  
ENDDO


PLMECT (JLON, KLEV)=0.5_JPRB*PLMECT (JLON, KLEV-1)
PUSLE (JLON, KLEV)=1.0_JPRB/(YDPHY0%ALD*0.5_JPRB*PLMECT (JLON, KLEV-1))
PPHI3 (JLON, KLEV)=PPHI3 (JLON, KLEV-1)



END SUBROUTINE ACBL89_OPENACC
