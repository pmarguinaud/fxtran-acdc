SUBROUTINE CUININ_OPENACC (YDCST, YDTHF, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON&
&, KLEV, PTEN, PQEN, PQSEN, PUEN, PVEN, PGEO, PAPH, KLAB, PTENH, PQENH, PQSENH&
&, PGEOH, PTU, PQU, PTD, PQD, PUU, PVU, PUD, PVD, PLU, YDSTACK)
!$ACC ROUTINE (CUININ_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
INTEGER (KIND=JPIM), INTENT (OUT)::KLAB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PTD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZPH 
LOGICAL::LLFLAG 
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZORCPD

REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG_CUADJTQ 

#include "fcttre.func.h"
#include "cuadjtq.func.h"
REAL (KIND=JPRB)::ZALDCP 
REAL (KIND=JPRB)::Z5ALCP 
REAL (KIND=JPRB)::Z4ES 
REAL (KIND=JPRB)::Z3ES 
REAL (KIND=JPRB)::Z2S_CUADJTQS
REAL (KIND=JPRB)::ZFOEEW
REAL (KIND=JPRB)::ZQSAT_CUADJTQS
REAL (KIND=JPRB)::ZCOR_CUADJTQS
REAL (KIND=JPRB)::ZTARG_CUADJTQS
REAL (KIND=JPRB)::ZCOND1_CUADJTQS
REAL (KIND=JPRB)::ZCOND_CUADJTQS
REAL (KIND=JPRB)::ZQP_CUADJTQS
REAL (KIND=JPRB)::ZQMAX_CUADJTQS

JL = KIDIA



ZORCPD=1._JPRB/YDCST%RCPD

DO JK=2, KLEV
  
  PTENH (JL, JK)=(MAX (YDCST%RCPD*PTEN (JL, JK-1)+PGEO (JL, JK-1), YDCST&
  &%RCPD*PTEN (JL, JK)+PGEO (JL, JK))-PGEOH (JL, JK))*ZORCPD
  PQENH (JL, JK)=PQEN (JL, JK-1)
  PQSENH (JL, JK)=PQSEN (JL, JK-1)
  ZPH =PAPH (JL, JK)
  LLFLAG =.TRUE.

  

  IF (JK>=KLEV-1.OR.JK<YDECUMF%NJKT2)  THEN
    CYCLE
  ENDIF

  IK=JK

  IF (YDEPHLI%LPHYLIN) THEN
    
    
    ZQMAX_CUADJTQS=0.5_JPRB

    

    IF (PTENH (JL, IK)>YDCST%RTT) THEN
      Z3ES =YDTHF%R3LES
      Z4ES =YDTHF%R4LES
      Z5ALCP =YDTHF%R5ALVCP
      ZALDCP =YDTHF%RALVDCP
    ELSE
      Z3ES =YDTHF%R3IES
      Z4ES =YDTHF%R4IES
      Z5ALCP =YDTHF%R5ALSCP
      ZALDCP =YDTHF%RALSDCP
    ENDIF

    
    
    
    
    
    ZQP_CUADJTQS=1.0_JPRB/ZPH 
    ZTARG_CUADJTQS=PTENH (JL, IK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG_CUADJTQS-YDCST%RTT)/(ZTARG_CUADJTQS-Z4ES ))
    ZQSAT_CUADJTQS=ZQP_CUADJTQS*ZFOEEW

    IF (ZQSAT_CUADJTQS>ZQMAX_CUADJTQS) THEN
      ZQSAT_CUADJTQS=ZQMAX_CUADJTQS
    ENDIF

    ZCOR_CUADJTQS=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT_CUADJTQS)
    ZQSAT_CUADJTQS=ZQSAT_CUADJTQS*ZCOR_CUADJTQS
    Z2S_CUADJTQS=Z5ALCP /(ZTARG_CUADJTQS-Z4ES )**2
    ZCOND1_CUADJTQS=(PQSENH (JL, IK)-ZQSAT_CUADJTQS)/(1.0_JPRB&
    &+ZQSAT_CUADJTQS*ZCOR_CUADJTQS*Z2S_CUADJTQS)
    PTENH (JL, IK)=PTENH (JL, IK)+ZALDCP *ZCOND1_CUADJTQS
    PQSENH (JL, IK)=PQSENH (JL, IK)-ZCOND1_CUADJTQS
    ZTARG_CUADJTQS=PTENH (JL, IK)
    ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG_CUADJTQS-YDCST%RTT)/(ZTARG_CUADJTQS-Z4ES ))
    ZQSAT_CUADJTQS=ZQP_CUADJTQS*ZFOEEW

    IF (ZQSAT_CUADJTQS>ZQMAX_CUADJTQS) THEN
      ZQSAT_CUADJTQS=ZQMAX_CUADJTQS
    ENDIF

    ZCOR_CUADJTQS=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT_CUADJTQS)
    ZQSAT_CUADJTQS=ZQSAT_CUADJTQS*ZCOR_CUADJTQS
    Z2S_CUADJTQS=Z5ALCP /(ZTARG_CUADJTQS-Z4ES )**2
    ZCOND1_CUADJTQS=(PQSENH (JL, IK)-ZQSAT_CUADJTQS)/(1.0_JPRB&
    &+ZQSAT_CUADJTQS*ZCOR_CUADJTQS*Z2S_CUADJTQS)
    PTENH (JL, IK)=PTENH (JL, IK)+ZALDCP *ZCOND1_CUADJTQS
    PQSENH (JL, IK)=PQSENH (JL, IK)-ZCOND1_CUADJTQS
  
  
  
  
  
  
  ELSE
    
    
    ZQMAX=0.5_JPRB

    IF (.NOT.YDEPHLI%LPHYLIN) THEN
      
      
      
      
      
      
      
      ZQP=1.0_JPRB/ZPH 
      ZQSAT=FOEEWMCU (PTENH (JL, IK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQSENH (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTENH (JL, IK)))
      PTENH (JL, IK)=PTENH (JL, IK)+FOELDCPMCU (PTENH (JL, IK))*ZCOND1
      PQSENH (JL, IK)=PQSENH (JL, IK)-ZCOND1
      ZQSAT=FOEEWMCU (PTENH (JL, IK))*ZQP
      ZQSAT=MIN (0.5_JPRB, ZQSAT)
      ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
      ZQSAT=ZQSAT*ZCOR
      ZCOND1=(PQSENH (JL, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTENH (JL, IK)))
      PTENH (JL, IK)=PTENH (JL, IK)+FOELDCPMCU (PTENH (JL, IK))*ZCOND1
      PQSENH (JL, IK)=PQSENH (JL, IK)-ZCOND1
    
    
    ELSE
    
    
    
    
    ENDIF

  
  
  
  ENDIF

  
  PQENH (JL, JK)=MIN (PQEN (JL, JK-1), PQSEN (JL, JK-1))+(PQSENH (JL, JK)-PQSEN (JL, JK-1))
  PQENH (JL, JK)=MAX (PQENH (JL, JK), 0.0_JPRB)
  
ENDDO


PTENH (JL, KLEV)=(YDCST%RCPD*PTEN (JL, KLEV)+PGEO (JL, KLEV)-PGEOH (JL, KLEV))*ZORCPD
PQENH (JL, KLEV)=PQEN (JL, KLEV)
PTENH (JL, 1)=PTEN (JL, 1)
PQENH (JL, 1)=PQEN (JL, 1)


DO JK=1, KLEV
  IK=JK-1

  IF (JK==1)  THEN
    IK=1
  ENDIF

  
  PTU (JL, JK)=PTENH (JL, JK)
  PTD (JL, JK)=PTENH (JL, JK)
  PQU (JL, JK)=PQENH (JL, JK)
  PQD (JL, JK)=PQENH (JL, JK)
  PLU (JL, JK)=0.0_JPRB
  PUU (JL, JK)=PUEN (JL, IK)
  PUD (JL, JK)=PUEN (JL, IK)
  PVU (JL, JK)=PVEN (JL, IK)
  PVD (JL, JK)=PVEN (JL, IK)
  KLAB (JL, JK)=0
  
ENDDO



END SUBROUTINE CUININ_OPENACC
