
SUBROUTINE CONVECT_TRIGGER_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPRES, PTH, PTHV, PTHES, PRV, PW&
&, PZ, PTKECLS, PTHLCL, PTLCL, PRVLCL, PWLCL, PZLCL, PTHVELCL, KLCL, KDPL, KPBL, OTRIG, YDSTACK)
!$ACC ROUTINE (CONVECT_TRIGGER_SHAL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
REAL, INTENT (IN)::PTKECLS(D%NIT)
REAL, INTENT (IN)::PTHV(D%NIT, D%NKT)
REAL, INTENT (IN)::PTH(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHES(D%NIT, D%NKT)
REAL, INTENT (IN)::PRV(D%NIT, D%NKT)
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PW(D%NIT, D%NKT)
REAL, INTENT (OUT)::PTHLCL(D%NIT)
REAL, INTENT (OUT)::PTLCL(D%NIT)
REAL, INTENT (OUT)::PRVLCL(D%NIT)
REAL, INTENT (OUT)::PWLCL(D%NIT)
REAL, INTENT (OUT)::PZLCL(D%NIT)
REAL, INTENT (OUT)::PTHVELCL(D%NIT)
LOGICAL, INTENT (OUT)::OTRIG(D%NIT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER, INTENT (INOUT)::KLCL(D%NIT)
INTEGER, INTENT (INOUT)::KDPL(D%NIT)
INTEGER, INTENT (INOUT)::KPBL(D%NIT)
INTEGER::JT
INTEGER::JL
INTEGER::JKM
INTEGER::JK
INTEGER::JKK
INTEGER::JI
INTEGER::IKE
INTEGER::IKB
REAL::ZEPSA
REAL::ZEPS
REAL::ZRDOCP
REAL::ZCPORD
REAL::ZX2
REAL::ZX1
REAL::ZTHVELCL
REAL::ZZLCL
REAL::ZWLCL
REAL::ZRVLCL
REAL::ZTLCL
REAL::ZTHLCL
INTEGER::ILCL
INTEGER::IPBL
INTEGER::IDPL
REAL::ZPLCL
REAL::ZZDPL
REAL::ZTHVLCL
REAL::ZTMIX
REAL::ZEVMIX
REAL::ZPRESMIX
REAL::ZDPTHMIX
REAL::ZCAPE
REAL::ZCAP
REAL::ZTHEUL
REAL::ZCPHA
REAL::ZLVA
REAL::ZCPHB
REAL::ZLVB
REAL::ZEWB
REAL::ZEWA
REAL::ZLSB
REAL::ZLSA
REAL::ZDP
REAL::ZTOPP
REAL::ZTOP
REAL::ZWORK3
REAL::ZWORK2
REAL::ZWORK1
LOGICAL::GTRIG2
LOGICAL::GWORK1

REAL::ZT

JI = D%NIB


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
ZEPS=CST%XRD/CST%XRV
ZEPSA=CST%XRV/CST%XRD
ZCPORD=CST%XCPD/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
OTRIG (JI)=.FALSE.
IDPL =KDPL (JI)
IPBL =KPBL (JI)
ILCL =KLCL (JI)
PWLCL (JI)=0.
ZWLCL =0.
PTHLCL (JI)=1.
PTHVELCL (JI)=1.
PTLCL (JI)=1.
PRVLCL (JI)=0.
PWLCL (JI)=0.
PZLCL (JI)=PZ (JI, IKB)
ZZDPL =PZ (JI, IKB)
GTRIG2 =.TRUE.
JT=IKE-2

DO JKK=IKB+1, IKE-2
  
  GWORK1 =ZZDPL -PZ (JI, IKB)<CVP_SHAL%XZLCL

  

  

  IF (GWORK1 ) THEN
    ZDPTHMIX =0.
    ZPRESMIX =0.
    ZTHLCL =0.
    ZRVLCL =0.
    ZZDPL =PZ (JI, JKK)
    IDPL =JKK
  ENDIF


  

  DO JK=JKK, IKE-1
    JKM=JK+1

    

    IF (GWORK1 .AND.ZDPTHMIX <CVP_SHAL%XZPBL) THEN
      IPBL =JK
      ZX1=PPRES (JI, JK)-PPRES (JI, JKM)
      ZDPTHMIX =ZDPTHMIX +ZX1
      ZPRESMIX =ZPRESMIX +PPRES (JI, JK)*ZX1
      ZTHLCL =ZTHLCL +PTH (JI, JK)*ZX1
      ZRVLCL =ZRVLCL +MAX (0., PRV (JI, JK))*ZX1
    ENDIF

  
  ENDDO


  

  IF (GWORK1 ) THEN
    ZPRESMIX =ZPRESMIX /ZDPTHMIX 
    ZTHLCL =ZTHLCL /ZDPTHMIX +(CVP_SHAL%XATPERT*MIN (3., PTKECLS&
    & (JI))/CST%XCPD+CVP_SHAL%XBTPERT)*CVP_SHAL%XDTPERT
    ZRVLCL =ZRVLCL /ZDPTHMIX 
    ZTHVLCL =ZTHLCL *(1.+ZEPSA*ZRVLCL )/(1.+ZRVLCL )
    ZTMIX =ZTHLCL *(ZPRESMIX /CST%XP00)**ZRDOCP
    ZEVMIX =ZRVLCL *ZPRESMIX /(ZRVLCL +ZEPS)
    ZEVMIX =MAX (1.E-8, ZEVMIX )
    ZX1=LOG (ZEVMIX /613.3)
    ZX1=(4780.8-32.19*ZX1)/(17.502-ZX1)
    ZTLCL =ZX1-(.212+1.571E-3*(ZX1-CST%XTT)-4.36E-4*(ZTMIX -CST%XTT))*(ZTMIX -ZX1)
    ZTLCL =MIN (ZTLCL , ZTMIX )
    ZPLCL =CST%XP00*(ZTLCL /ZTHLCL )**ZCPORD
  ENDIF

  
  
  
  ZT=MIN (400., MAX (ZTLCL , 10.))
  ZEWA =EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*ALOG (ZT))
  ZEWA =ZEPS*ZEWA /(ZPLCL -ZEWA )
  ZLVA =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT-CST%XTT)
  ZLSA =CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT-CST%XTT)
  ZCPHA =CST%XCPD+CST%XCPV*ZEWA 
  
  
  
  ZT=MIN (400., MAX (ZTMIX , 10.))
  ZEWB =EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*ALOG (ZT))
  ZEWB =ZEPS*ZEWB /(ZPRESMIX -ZEWB )
  ZLVB =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT-CST%XTT)
  ZLSB =CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT-CST%XTT)
  ZCPHB =CST%XCPD+CST%XCPV*ZEWB 

  

  

  

  

  IF (GWORK1 ) THEN
    ZLSA =ZEWA /ZTLCL *(CST%XBETAW/ZTLCL -CST%XGAMW)
    ZLSA =(ZEWA -ZRVLCL )/(1.+ZLVA /ZCPHA *ZLSA )
    ZTLCL =ZTLCL -ZLVA /ZCPHA *ZLSA 
  ENDIF


  

  

  IF (GWORK1 .AND.ZRVLCL >ZEWB ) THEN
    ZLSB =ZEWB /ZTMIX *(CST%XBETAW/ZTMIX -CST%XGAMW)
    ZLSB =(ZEWB -ZRVLCL )/(1.+ZLVB /ZCPHB *ZLSB )
    ZTLCL =ZTMIX -ZLVB /ZCPHB *ZLSB 
    ZRVLCL =ZRVLCL -ZLSB 
    ZPLCL =ZPRESMIX 
    ZTHLCL =ZTLCL *(CST%XP00/ZPLCL )**ZRDOCP
    ZTHVLCL =ZTHLCL *(1.+ZEPSA*ZRVLCL )/(1.+ZRVLCL )
  ENDIF


  

  DO JK=JKK, IKE-1

    

    IF (ZPLCL <=PPRES (JI, JK).AND.GWORK1 )  THEN
      ILCL =JK+1
    ENDIF

  
  ENDDO

  
  JK=ILCL 
  JKM=JK-1
  ZDP =LOG (ZPLCL /PPRES (JI, JKM))/LOG (PPRES (JI, JK)/PPRES (JI, JKM))
  ZWORK1 =PTHV (JI, JKM)+(PTHV (JI, JK)-PTHV (JI, JKM))*ZDP 
  ZWORK2 =PZ (JI, JKM)+(PZ (JI, JK)-PZ (JI, JKM))*ZDP 

  

  

  IF (GWORK1 ) THEN
    ZTHVELCL =ZWORK1 
    ZZLCL =ZWORK2 
  ENDIF

  
  
  ZWLCL =CVP_SHAL%XAW*MAX (0., PW (JI, IKB))+CVP_SHAL%XBW
  ZTHEUL =ZTLCL *(ZTHLCL /ZTLCL )**(1.-0.28*ZRVLCL )*EXP (&
  &(3374.6525/ZTLCL -2.5403)*ZRVLCL *(1.+0.81*ZRVLCL ))
  
  ZCAPE =0.
  ZCAP =0.
  ZTOP =0.
  ZTOPP =0.
  ZWORK3 =0.
  JKM=IKB

  DO JL=JKM, JT
    JK=JL+1
    
    ZX1=(2.*ZTHEUL /(PTHES (JI, JK)+PTHES (JI, JL))-1.)*(PZ (JI, JK)-PZ (JI, JL))

    IF (JL<ILCL )  THEN
      ZX1=0.
    ENDIF

    ZCAPE =ZCAPE +CST%XG*MAX (1., ZX1)
    ZCAP =ZCAP +ZX1
    ZX2=SIGN (1.,(CVP_SHAL%XNHGAM*CST%XG*ZCAP +1.05*ZWLCL *ZWLCL ))
    ZWORK3 =MAX (-1.,(ZWORK3 +MIN (0., ZX2)))
    ZTOPP =ZTOP 
    ZTOP =PZ (JI, JL)*.5*(1.+ZX2)*(1.+ZWORK3 )+ZTOP *.5*(1.-ZX2)
    ZTOP =MAX (ZTOP , ZTOPP )
    ZTOPP =ZTOP 
  
  ENDDO


  

  IF ((ZTOP -ZZLCL ).GE.CVP_SHAL%XCDEPTH.AND.GTRIG2 .AND.ZCAPE >10.) THEN
    GTRIG2 =.FALSE.
    OTRIG (JI)=.TRUE.
    PTHLCL (JI)=ZTHLCL 
    PRVLCL (JI)=ZRVLCL 
    PTLCL (JI)=ZTLCL 
    PWLCL (JI)=ZWLCL 
    PZLCL (JI)=ZZLCL 
    PTHVELCL (JI)=ZTHVELCL 
    KDPL (JI)=IDPL 
    KPBL (JI)=IPBL 
    KLCL (JI)=ILCL 
  ENDIF

  
ENDDO





END SUBROUTINE CONVECT_TRIGGER_SHAL_OPENACC
