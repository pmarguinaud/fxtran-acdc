MODULE YOMXFU_TYPE

!$ACDC methods --methods-list=size,wipe,copy,host --skip-components TXFU%XFUBUF_B,TXFU%RMWINDCALC_B,TXFU%RMNWINDCALC_B --field-api --field-api-class flu


USE PARKIND1  ,ONLY : JPIM, JPRB
USE YOMHOOK   ,ONLY : LHOOK, JPHOOK, DR_HOOK

USE TYPE_FLUXES, ONLY : FLUXES_DESCRIPTOR
USE PTRXFU, ONLY : TXFUPTR
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE

IMPLICIT NONE

SAVE


!     ------------------------------------------------------------

!*    Contains variables to control activation of instantaneous fluxes.

INTEGER(KIND=JPIM), PARAMETER :: JPFUXT=250  ! maximum number of timesteps where XFU can be activated

TYPE :: TXFU_KEYS

LOGICAL :: LXFU=.FALSE.                      ! controls switch on/off all XFU
LOGICAL :: LXTRD=.FALSE.                     ! activates gravity wave drag momentum XFU if .T.
LOGICAL :: LXTRC=.FALSE.                     ! activates contribution of convection to U, V, q and (cp T) XFU if .T.
LOGICAL :: LXTRT=.FALSE.                     ! activates contribution of turbulence to U, V, q and (cp T) XFU if .T.
LOGICAL :: LXPLC=.FALSE.                     ! activates convective precipitation XFU if .T.
LOGICAL :: LXPLCG=.FALSE.                    ! activates convective graupels CFU if .T.
LOGICAL :: LXPLCH=.FALSE.                    ! activates convective hail CFU if .T.
LOGICAL :: LXPLS=.FALSE.                     ! activates stratiform precipitation XFU if .T.
LOGICAL :: LXPLSG=.FALSE.                    ! activates stratiform graupels CFU if .T.
LOGICAL :: LXPLSH=.FALSE.                    ! activates stratiform hail CFU if .T.
LOGICAL :: LXR=.FALSE.                       ! activates radiation XFU if .T.
LOGICAL :: LXNEBTT=.FALSE.                   ! activates total cloudiness XFU if .T.
LOGICAL :: LXNEBPA=.FALSE.                   ! activates partial cloudiness XFU if .T.
LOGICAL :: LXCLS=.FALSE.                     ! activates U, V, T, q and relative humidity at 2 or 10 m (time t-dt) if .T.
LOGICAL :: LXMWINDCLS=.FALSE.                ! activates mean of U and V at 10 m if .T., also NU/NV if LXNUVCLS
LOGICAL :: LXNUVCLS=.FALSE.                  ! activates neutral U and V at 10 m (time t-dt) if .T.
LOGICAL :: LXTTCLS=.FALSE.                   ! activates extreme temperatures at 2 m if .T.
LOGICAL :: LXHHCLS=.FALSE.                   ! activates extreme relative moistures at 2 m if .T
LOGICAL :: LXTPWCLS=.FALSE.                  ! activates T'w at 2 m if .T
LOGICAL :: LXSOIL=.FALSE.                    ! activates soil XFU if .T.
LOGICAL :: LTXTRD=.FALSE.                    ! activates gravity wave drag momentum XFU at all levels if .T.
LOGICAL :: LTXTRC=.FALSE.                    ! activates contribution of convection to U, V, q and (cp T) XFU if .T.
LOGICAL :: LTXTRT=.FALSE.                    ! activates contribution of turbulence to U, V, q and (cp T) XFU if .T.
LOGICAL :: LTXR=.FALSE.                      ! activates radiation XFU at all levels if .T.
LOGICAL :: LTXNEB=.FALSE.                    ! activates cloudiness XFU at all levels if .T.
LOGICAL :: LTXQICE=.FALSE.                   ! total ice water content at all levels
LOGICAL :: LTXQLI=.FALSE.                    ! total liquid water content at all levels
LOGICAL :: LXICV=.FALSE.                     ! activates indices of convection
                                             ! (CAPE and moisture convergence) XFU at all levels if .T.
LOGICAL :: LXCTOP=.FALSE.                    ! activates pressure of top deep convection
LOGICAL :: LXCLP=.FALSE.                     ! activates height (in meters) of PBL XFU at all levels if .T.
LOGICAL :: LXCLPMF=.FALSE.                   ! activates height (in meters) of CBL XFU if .T.
LOGICAL :: LXVMAXTH=.FALSE.                  ! activates maximal BL thermal velocity (in ms-1) if .T.
LOGICAL :: LXVEIN=.FALSE.                    ! activates ventilation index
LOGICAL :: LXTGST=.FALSE.                    ! activates gusts as U and V components XFU at all levels if .T.
LOGICAL :: LXXGST=.FALSE.                    ! activates extreme gusts as U and V components XFU at all levels if .T.
LOGICAL :: LXXGST2=.FALSE.                   ! activates extreme gusts2 as U and V components XFU at all levels if .T.
LOGICAL :: LXQCLS=.FALSE.                    ! activates specific moisture at 2 meters
LOGICAL :: LXTHW=.FALSE.                     ! activates "theta'_w" surface flux
LOGICAL :: LXXDIAGH=.FALSE.                  ! activates extreme value of hail diagnostic
LOGICAL :: LXMRT=.FALSE.                     ! activates mean radiant temperature
LOGICAL :: LXVISI=.FALSE.                    ! activates visibilities diagnostic
LOGICAL :: LXVISI2=.FALSE.                   ! activates visibilities diagnostic
LOGICAL :: LXPRECIPS1=.FALSE.                ! activates precipitations types nr 1 diagnostic
LOGICAL :: LXPRECIPS2=.FALSE.                ! activates precipitations types nr 2 diagnostic
LOGICAL :: LXSNOWDEPTH=.FALSE.               ! activates snow depth diagnostic

CONTAINS
PROCEDURE :: ACDC_COPY => ACDC_COPY_TXFU_KEYS
PROCEDURE :: ACDC_HOST => ACDC_HOST_TXFU_KEYS
PROCEDURE :: ACDC_SIZE => ACDC_SIZE_TXFU_KEYS
PROCEDURE :: ACDC_WIPE => ACDC_WIPE_TXFU_KEYS
END TYPE TXFU_KEYS

TYPE, EXTENDS(TXFU_KEYS) :: TXFU

TYPE(FLUXES_DESCRIPTOR), ALLOCATABLE :: TYPE_XFU(:) ! contains the fluxes descriptor for the XFU

REAL(KIND=JPRB), POINTER :: RMWINDCALC_B(:,:)  => NULL ()  ! needed for mean wind calculation
REAL(KIND=JPRB), POINTER :: RMWINDCALC(:)  => NULL () 
CLASS (FIELD_2RB), POINTER :: F_RMWINDCALC => NULL ()

REAL(KIND=JPRB), POINTER :: RMNWINDCALC_B(:,:)  => NULL ()  ! needed for mean neutral wind calculation
REAL(KIND=JPRB), POINTER :: RMNWINDCALC(:)  => NULL () 
CLASS (FIELD_2RB), POINTER :: F_RMNWINDCALC => NULL ()


INTEGER(KIND=JPIM) :: MEANPERIOD             ! period (in seconds) for the mean calculation
INTEGER(KIND=JPIM) :: NMEANSTEPS             ! number of timesteps involved in mean calculation
INTEGER(KIND=JPIM) :: NXGSTPERIOD            ! period for maximum gusts
INTEGER(KIND=JPIM) :: NXGSTPERIOD2           ! period for second maximum gusts
INTEGER(KIND=JPIM) :: NVISIPERIOD            ! period for visibilities
INTEGER(KIND=JPIM) :: NVISIPERIOD2           ! period for second visibilities
INTEGER(KIND=JPIM) :: NXGSTTS                ! number of timesteps involved in max gust calculation
INTEGER(KIND=JPIM) :: NTYPXFU                ! number of fluxes types in buffer
INTEGER(KIND=JPIM) :: NXFUTS(0:JPFUXT)       ! array containing flux accumulation write-up steps
INTEGER(KIND=JPIM) :: NFRXFU                 ! frequency of write up of flux diagnostics
INTEGER(KIND=JPIM) :: NRAZTS(0:JPFUXT)       ! array containing instantaneous flux reset steps
INTEGER(KIND=JPIM) :: NFRRAZ                 ! frequency of reset of flux diagnostics
INTEGER(KIND=JPIM) :: N1RAZ                  ! over-riding switch for instantaneous flux reset (0 = false)
INTEGER(KIND=JPIM) :: NFDXFU                 ! total number of fields in buffer

LOGICAL :: LRESET                            ! reset extreme temperatures to zero
LOGICAL :: LRESET_GST                        ! reset Gust calculation
LOGICAL :: LRESET_GST2                       ! reset Gust2 calculation
LOGICAL :: LRESET_PRECIP                     ! reset Precips type calcultation
LOGICAL :: LRESET_PRECIP2                    ! reset Precips type calcultation
LOGICAL :: LRESET_VISI                       ! reset visibilities calculations
LOGICAL :: LRESET_VISI2                      ! reset visibilities calculations

LOGICAL :: LREAXFU                           ! read first input on historic file if .T.

TYPE(TXFUPTR) :: YXFUPT

REAL (KIND=JPRB), POINTER :: XFUBUF_B(:,:,:)  => NULL () ! Buffer for instantaneous diagnostics

! CAPE (convective available potential energy)
REAL (KIND=JPRB), POINTER :: CAPE (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_CAPE => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YCAPE

! height of the PBL out of the model
REAL (KIND=JPRB), POINTER :: CLPH (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_CLPH => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YCLPH

! height of the PBL for minimum of buoyancy
REAL (KIND=JPRB), POINTER :: CLPHMF (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_CLPHMF => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YCLPHMF

! diagnostic of maximal wind speed of the BL thermal
REAL (KIND=JPRB), POINTER :: VMAXTH (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VMAXTH => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVMAXTH

! maximum of CLWC
REAL (KIND=JPRB), POINTER :: CLWC2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_CLWC2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YCLWC2

! maximum of CLWC
REAL (KIND=JPRB), POINTER :: CLWC (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_CLWC => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YCLWC

! pressure of top of deep convection
REAL (KIND=JPRB), POINTER :: CTOP (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_CTOP => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YCTOP

! contribution of convection to q
REAL (KIND=JPRB), POINTER :: DICQ (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_DICQ => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YDICQ

! contribution of convection to (cp T)
REAL (KIND=JPRB), POINTER :: DICS (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_DICS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YDICS

! contribution of turbulence to T
REAL (KIND=JPRB), POINTER :: DITQ (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_DITQ => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YDITQ

! contribution of turbulence to (cp T)
REAL (KIND=JPRB), POINTER :: DITS (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_DITS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YDITS

! heat flux in soil
REAL (KIND=JPRB), POINTER :: FCHSP (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_FCHSP => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YFCHSP

! liquid evaporation
REAL (KIND=JPRB), POINTER :: FEVL (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_FEVL => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YFEVL

! evapotranspiration
REAL (KIND=JPRB), POINTER :: FEVV (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_FEVV => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YFEVV

! water flux in soil
REAL (KIND=JPRB), POINTER :: FLWSP (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_FLWSP => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YFLWSP

! melt snow
REAL (KIND=JPRB), POINTER :: FONTE (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_FONTE => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YFONTE

! transpiration
REAL (KIND=JPRB), POINTER :: FTR (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_FTR => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YFTR

! minimum relative humidity at 2 meters (pbl)
REAL (KIND=JPRB), POINTER :: HUN (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_HUN => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YHUN

! maximum relative humidity at 2 meters (pbl)
REAL (KIND=JPRB), POINTER :: HUX (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_HUX => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YHUX

! moisture convergence
REAL (KIND=JPRB), POINTER :: MOCON (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_MOCON => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YMOCON

! mean radiant temperature at 2 meters
REAL (KIND=JPRB), POINTER :: MRT (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_MRT => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YMRT

! low cloud cover
REAL (KIND=JPRB), POINTER :: NBBAS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NBBAS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNBBAS

! convective cloud cover
REAL (KIND=JPRB), POINTER :: NBCON (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NBCON => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNBCON

! high cloud cover
REAL (KIND=JPRB), POINTER :: NBHAU (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NBHAU => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNBHAU

! medium cloud cover
REAL (KIND=JPRB), POINTER :: NBMOY (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NBMOY => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNBMOY

! cloud cover
REAL (KIND=JPRB), POINTER :: NEB (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_NEB => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNEB

! total cloudiness
REAL (KIND=JPRB), POINTER :: NEBT (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NEBT => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNEBT

! U-component of neutral wind at 10 meters (pbl)
REAL (KIND=JPRB), POINTER :: NUCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NUCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNUCLS

! V-component of neutral wind at 10 meters (pbl)
REAL (KIND=JPRB), POINTER :: NVCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_NVCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YNVCLS

! convective graupel fall
REAL (KIND=JPRB), POINTER :: PLCG (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLCG => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLCG

! convective hail fall
REAL (KIND=JPRB), POINTER :: PLCH (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLCH => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLCH

! convective precipitation
REAL (KIND=JPRB), POINTER :: PLCL (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLCL => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLCL

! convective snow fall
REAL (KIND=JPRB), POINTER :: PLCN (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLCN => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLCN

! large scale graupel fall (stratiform)
REAL (KIND=JPRB), POINTER :: PLSG (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLSG => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLSG

! large scale hail fall (stratiform)
REAL (KIND=JPRB), POINTER :: PLSH (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLSH => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLSH

! large scale precipitation (stratiform)
REAL (KIND=JPRB), POINTER :: PLSL (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLSL => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLSL

! large scale snow fall (stratiform)
REAL (KIND=JPRB), POINTER :: PLSN (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_PLSN => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPLSN

! frequent precipitations type
REAL (KIND=JPRB), POINTER :: PTYPE2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_PTYPE2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPTYPE2

! frequent precipitations type
REAL (KIND=JPRB), POINTER :: PTYPE (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_PTYPE => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPTYPE

! severe precipitations type
REAL (KIND=JPRB), POINTER :: PTYPESEV2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_PTYPESEV2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPTYPESEV2

! severe precipitations type
REAL (KIND=JPRB), POINTER :: PTYPESEV (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_PTYPESEV => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YPTYPESEV

! specific humidity at 2 meters (pbl)
REAL (KIND=JPRB), POINTER :: QCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_QCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YQCLS

! ice water
REAL (KIND=JPRB), POINTER :: QICE (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_QICE => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YQICE

! liquid water
REAL (KIND=JPRB), POINTER :: QLI (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_QLI => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YQLI

! relative humidity at 2 meters (pbl)
REAL (KIND=JPRB), POINTER :: RHCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_RHCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YRHCLS

! solar radiation
REAL (KIND=JPRB), POINTER :: RSO (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_RSO => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YRSO

! surface radiation
REAL (KIND=JPRB), POINTER :: RTH (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_RTH => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YRTH

! interception soil layer runoff
REAL (KIND=JPRB), POINTER :: RUISL (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_RUISL => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YRUISL

! deep soil runoff
REAL (KIND=JPRB), POINTER :: RUISP (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_RUISP => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YRUISP

! surface soil runoff
REAL (KIND=JPRB), POINTER :: RUISS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_RUISS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YRUISS

! 
REAL (KIND=JPRB), POINTER :: SIC (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_SIC => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YSIC

! temperature at 2 meters (pbl)
REAL (KIND=JPRB), POINTER :: TCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_TCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTCLS

! theta prime_w surface
REAL (KIND=JPRB), POINTER :: THW (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_THW => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTHW

! minimum temperature at 2 meters
REAL (KIND=JPRB), POINTER :: TN (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_TN => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTN

! wet bulb temperature at 2 meters (pbl)
REAL (KIND=JPRB), POINTER :: TPWCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_TPWCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTPWCLS

! contribution of convection to U
REAL (KIND=JPRB), POINTER :: TRCU (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_TRCU => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTRCU

! contribution of convection to V
REAL (KIND=JPRB), POINTER :: TRCV (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_TRCV => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTRCV

! U-wind gravity wave stress
REAL (KIND=JPRB), POINTER :: TRDU (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_TRDU => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTRDU

! V-wind gravity wave stress
REAL (KIND=JPRB), POINTER :: TRDV (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_TRDV => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTRDV

! contribution of turbulence to U
REAL (KIND=JPRB), POINTER :: TRTU (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_TRTU => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTRTU

! contribution of turbulence to V
REAL (KIND=JPRB), POINTER :: TRTV (:,:) => NULL ()
CLASS (FIELD_3RB), POINTER :: F_TRTV => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTRTV

! maximum temperature at 2 meters
REAL (KIND=JPRB), POINTER :: TX (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_TX => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YTX

! U-component of wind at 10 meters (pbl)
REAL (KIND=JPRB), POINTER :: UCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_UCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YUCLS

! U-momentum of gusts2
REAL (KIND=JPRB), POINTER :: UGST2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_UGST2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YUGST2

! U-momentum of gusts out of the model
REAL (KIND=JPRB), POINTER :: UGST (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_UGST => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YUGST

! V-component of wind at 10 meters (pbl)
REAL (KIND=JPRB), POINTER :: VCLS (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VCLS => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVCLS

! ventilation index in PBL
REAL (KIND=JPRB), POINTER :: VEIN (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VEIN => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVEIN

! V-momentum of gusts2
REAL (KIND=JPRB), POINTER :: VGST2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VGST2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVGST2

! V-momentum of gusts out of the model
REAL (KIND=JPRB), POINTER :: VGST (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VGST => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVGST

! visibility due to water and/or ice cloud
REAL (KIND=JPRB), POINTER :: VISICLD2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VISICLD2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVISICLD2

! visibility due to water and/or ice cloud
REAL (KIND=JPRB), POINTER :: VISICLD (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VISICLD => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVISICLD

! visibility due to precipitations
REAL (KIND=JPRB), POINTER :: VISIHYD2 (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VISIHYD2 => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVISIHYD2

! visibility due to precipitations
REAL (KIND=JPRB), POINTER :: VISIHYD (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_VISIHYD => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YVISIHYD

! hail diagnostic
REAL (KIND=JPRB), POINTER :: XDIAGH (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_XDIAGH => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YXDIAGH

! snow depth diagnostic
REAL (KIND=JPRB), POINTER :: SNWDE (:) => NULL ()
CLASS (FIELD_2RB), POINTER :: F_SNWDE => NULL ()
TYPE (FLUXES_DESCRIPTOR) :: YSNWDE


CONTAINS
  PROCEDURE :: INIT => TXFU_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => TXFU_TYPE_UPDATE_VIEW
  PROCEDURE :: FINAL => TXFU_TYPE_FINAL
  PROCEDURE :: RESET => TXFU_TYPE_RESET
PROCEDURE :: ACDC_COPY => ACDC_COPY_TXFU
PROCEDURE :: ACDC_HOST => ACDC_HOST_TXFU
PROCEDURE :: ACDC_SIZE => ACDC_SIZE_TXFU
PROCEDURE :: ACDC_WIPE => ACDC_WIPE_TXFU
END TYPE TXFU

!     ------------------------------------------------------------

INTERFACE

MODULE SUBROUTINE ACDC_COPY_TXFU_KEYS (SELF, LDCREATED, LDFIELDAPI)

IMPLICIT NONE
CLASS (TXFU_KEYS), INTENT (IN), TARGET :: SELF
LOGICAL, OPTIONAL, INTENT (IN) :: LDCREATED, LDFIELDAPI
END SUBROUTINE

MODULE SUBROUTINE ACDC_HOST_TXFU_KEYS (SELF)

IMPLICIT NONE
CLASS (TXFU_KEYS), TARGET :: SELF
END SUBROUTINE

MODULE FUNCTION ACDC_SIZE_TXFU_KEYS (SELF, CDPATH, LDPRINT) RESULT (KSIZE)

IMPLICIT NONE
CLASS (TXFU_KEYS),     INTENT (IN), TARGET :: SELF
CHARACTER(LEN=*), INTENT (IN), OPTIONAL :: CDPATH
LOGICAL,          INTENT (IN), OPTIONAL :: LDPRINT
INTEGER*8 :: KSIZE
END FUNCTION

MODULE SUBROUTINE ACDC_WIPE_TXFU_KEYS (SELF, LDDELETED, LDFIELDAPI)

IMPLICIT NONE
CLASS (TXFU_KEYS), INTENT (IN), TARGET :: SELF
LOGICAL, OPTIONAL, INTENT (IN) :: LDDELETED, LDFIELDAPI
END SUBROUTINE

MODULE SUBROUTINE ACDC_COPY_TXFU (SELF, LDCREATED, LDFIELDAPI)
USE FIELD_UTIL_MODULE
IMPLICIT NONE
CLASS (TXFU), INTENT (IN), TARGET :: SELF
LOGICAL, OPTIONAL, INTENT (IN) :: LDCREATED, LDFIELDAPI
END SUBROUTINE

MODULE SUBROUTINE ACDC_HOST_TXFU (SELF)
USE FIELD_UTIL_MODULE
IMPLICIT NONE
CLASS (TXFU), TARGET :: SELF
END SUBROUTINE

MODULE FUNCTION ACDC_SIZE_TXFU (SELF, CDPATH, LDPRINT) RESULT (KSIZE)
USE FIELD_UTIL_MODULE
IMPLICIT NONE
CLASS (TXFU),     INTENT (IN), TARGET :: SELF
CHARACTER(LEN=*), INTENT (IN), OPTIONAL :: CDPATH
LOGICAL,          INTENT (IN), OPTIONAL :: LDPRINT
INTEGER*8 :: KSIZE
END FUNCTION

MODULE SUBROUTINE ACDC_WIPE_TXFU (SELF, LDDELETED, LDFIELDAPI)
USE FIELD_UTIL_MODULE
IMPLICIT NONE
CLASS (TXFU), INTENT (IN), TARGET :: SELF
LOGICAL, OPTIONAL, INTENT (IN) :: LDDELETED, LDFIELDAPI
END SUBROUTINE


END INTERFACE

CONTAINS

SUBROUTINE TXFU_TYPE_INIT (SELF)

CLASS (TXFU), INTENT (INOUT) :: SELF

INTEGER (KIND=JPIM) :: ILEV, IOFF

REAL (KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_INIT', 0, ZHOOK_HANDLE)

IF (ASSOCIATED (SELF%RMWINDCALC_B)) THEN
  CALL FIELD_NEW (SELF%F_RMWINDCALC, DATA=SELF%RMWINDCALC_B, PERSISTENT=.TRUE.)
ENDIF

IF (ASSOCIATED (SELF%RMNWINDCALC_B)) THEN
  CALL FIELD_NEW (SELF%F_RMNWINDCALC, DATA=SELF%RMNWINDCALC_B, PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXCAPE
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_CAPE, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXCLPH
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_CLPH, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXCLPHMF
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_CLPHMF, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVMAXTH
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VMAXTH, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXCLWC2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_CLWC2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXCLWC
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_CLWC, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXCTOP
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_CTOP, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXDICQ
IF (IOFF > 0) THEN
  ILEV = SELF%YDICQ%ILEV
  CALL FIELD_NEW (SELF%F_DICQ, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXDICS
IF (IOFF > 0) THEN
  ILEV = SELF%YDICS%ILEV
  CALL FIELD_NEW (SELF%F_DICS, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXDITQ
IF (IOFF > 0) THEN
  ILEV = SELF%YDITQ%ILEV
  CALL FIELD_NEW (SELF%F_DITQ, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXDITS
IF (IOFF > 0) THEN
  ILEV = SELF%YDITS%ILEV
  CALL FIELD_NEW (SELF%F_DITS, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXFCHSP
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_FCHSP, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXFEVL
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_FEVL, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXFEVV
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_FEVV, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXFLWSP
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_FLWSP, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXFONTE
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_FONTE, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXFTR
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_FTR, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXHUN
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_HUN, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXHUX
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_HUX, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXMOCON
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_MOCON, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXMRT
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_MRT, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNBBAS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NBBAS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNBCON
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NBCON, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNBHAU
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NBHAU, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNBMOY
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NBMOY, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNEB
IF (IOFF > 0) THEN
  ILEV = SELF%YNEB%ILEV
  CALL FIELD_NEW (SELF%F_NEB, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNEBT
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NEBT, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNUCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NUCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXNVCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_NVCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLCG
IF (IOFF > 0) THEN
  ILEV = SELF%YPLCG%ILEV
  CALL FIELD_NEW (SELF%F_PLCG, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLCH
IF (IOFF > 0) THEN
  ILEV = SELF%YPLCH%ILEV
  CALL FIELD_NEW (SELF%F_PLCH, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLCL
IF (IOFF > 0) THEN
  ILEV = SELF%YPLCL%ILEV
  CALL FIELD_NEW (SELF%F_PLCL, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLCN
IF (IOFF > 0) THEN
  ILEV = SELF%YPLCN%ILEV
  CALL FIELD_NEW (SELF%F_PLCN, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLSG
IF (IOFF > 0) THEN
  ILEV = SELF%YPLSG%ILEV
  CALL FIELD_NEW (SELF%F_PLSG, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLSH
IF (IOFF > 0) THEN
  ILEV = SELF%YPLSH%ILEV
  CALL FIELD_NEW (SELF%F_PLSH, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLSL
IF (IOFF > 0) THEN
  ILEV = SELF%YPLSL%ILEV
  CALL FIELD_NEW (SELF%F_PLSL, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPLSN
IF (IOFF > 0) THEN
  ILEV = SELF%YPLSN%ILEV
  CALL FIELD_NEW (SELF%F_PLSN, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPTYPE2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_PTYPE2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPTYPE
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_PTYPE, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPTYPESEV2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_PTYPESEV2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXPTYPESEV
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_PTYPESEV, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXQCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_QCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXQICE
IF (IOFF > 0) THEN
  ILEV = SELF%YQICE%ILEV
  CALL FIELD_NEW (SELF%F_QICE, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXQLI
IF (IOFF > 0) THEN
  ILEV = SELF%YQLI%ILEV
  CALL FIELD_NEW (SELF%F_QLI, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXRHCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_RHCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXRSO
IF (IOFF > 0) THEN
  ILEV = SELF%YRSO%ILEV
  CALL FIELD_NEW (SELF%F_RSO, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXRTH
IF (IOFF > 0) THEN
  ILEV = SELF%YRTH%ILEV
  CALL FIELD_NEW (SELF%F_RTH, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXRUISL
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_RUISL, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXRUISP
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_RUISP, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXRUISS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_RUISS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXSIC
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_SIC, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_TCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTHW
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_THW, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTN
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_TN, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTPWCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_TPWCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTRCU
IF (IOFF > 0) THEN
  ILEV = SELF%YTRCU%ILEV
  CALL FIELD_NEW (SELF%F_TRCU, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTRCV
IF (IOFF > 0) THEN
  ILEV = SELF%YTRCV%ILEV
  CALL FIELD_NEW (SELF%F_TRCV, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTRDU
IF (IOFF > 0) THEN
  ILEV = SELF%YTRDU%ILEV
  CALL FIELD_NEW (SELF%F_TRDU, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTRDV
IF (IOFF > 0) THEN
  ILEV = SELF%YTRDV%ILEV
  CALL FIELD_NEW (SELF%F_TRDV, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTRTU
IF (IOFF > 0) THEN
  ILEV = SELF%YTRTU%ILEV
  CALL FIELD_NEW (SELF%F_TRTU, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTRTV
IF (IOFF > 0) THEN
  ILEV = SELF%YTRTV%ILEV
  CALL FIELD_NEW (SELF%F_TRTV, DATA=SELF%XFUBUF_B (:, IOFF:IOFF+ILEV-1, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXTX
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_TX, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXUCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_UCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXUGST2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_UGST2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXUGST
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_UGST, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVCLS
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VCLS, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVEIN
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VEIN, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVGST2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VGST2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVGST
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VGST, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVISICLD2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VISICLD2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVISICLD
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VISICLD, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVISIHYD2
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VISIHYD2, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXVISIHYD
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_VISIHYD, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXXDIAGH
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_XDIAGH, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF

IOFF = SELF%YXFUPT%MXSNWDE
IF (IOFF > 0) THEN
  CALL FIELD_NEW (SELF%F_SNWDE, DATA=SELF%XFUBUF_B (:, IOFF, :), PERSISTENT=.TRUE.)
ENDIF


IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_INIT', 1, ZHOOK_HANDLE)

END SUBROUTINE TXFU_TYPE_INIT

SUBROUTINE TXFU_TYPE_UPDATE_VIEW (SELF, BLOCK_INDEX)

CLASS (TXFU), INTENT (INOUT) :: SELF
INTEGER (KIND=JPIM), INTENT (IN) :: BLOCK_INDEX

REAL (KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_UPDATE_VIEW', 0, ZHOOK_HANDLE)

IF (ASSOCIATED (SELF%F_RMWINDCALC)) THEN
  SELF%RMWINDCALC => SELF%F_RMWINDCALC%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RMNWINDCALC)) THEN
  SELF%RMNWINDCALC => SELF%F_RMNWINDCALC%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_CAPE)) THEN
  SELF%CAPE => SELF%F_CAPE%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_CLPH)) THEN
  SELF%CLPH => SELF%F_CLPH%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_CLPHMF)) THEN
  SELF%CLPHMF => SELF%F_CLPHMF%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VMAXTH)) THEN
  SELF%VMAXTH => SELF%F_VMAXTH%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_CLWC2)) THEN
  SELF%CLWC2 => SELF%F_CLWC2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_CLWC)) THEN
  SELF%CLWC => SELF%F_CLWC%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_CTOP)) THEN
  SELF%CTOP => SELF%F_CTOP%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_DICQ)) THEN
  SELF%DICQ => SELF%F_DICQ%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_DICS)) THEN
  SELF%DICS => SELF%F_DICS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_DITQ)) THEN
  SELF%DITQ => SELF%F_DITQ%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_DITS)) THEN
  SELF%DITS => SELF%F_DITS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_FCHSP)) THEN
  SELF%FCHSP => SELF%F_FCHSP%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_FEVL)) THEN
  SELF%FEVL => SELF%F_FEVL%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_FEVV)) THEN
  SELF%FEVV => SELF%F_FEVV%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_FLWSP)) THEN
  SELF%FLWSP => SELF%F_FLWSP%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_FONTE)) THEN
  SELF%FONTE => SELF%F_FONTE%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_FTR)) THEN
  SELF%FTR => SELF%F_FTR%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_HUN)) THEN
  SELF%HUN => SELF%F_HUN%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_HUX)) THEN
  SELF%HUX => SELF%F_HUX%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_MOCON)) THEN
  SELF%MOCON => SELF%F_MOCON%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_MRT)) THEN
  SELF%MRT => SELF%F_MRT%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NBBAS)) THEN
  SELF%NBBAS => SELF%F_NBBAS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NBCON)) THEN
  SELF%NBCON => SELF%F_NBCON%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NBHAU)) THEN
  SELF%NBHAU => SELF%F_NBHAU%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NBMOY)) THEN
  SELF%NBMOY => SELF%F_NBMOY%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NEB)) THEN
  SELF%NEB => SELF%F_NEB%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NEBT)) THEN
  SELF%NEBT => SELF%F_NEBT%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NUCLS)) THEN
  SELF%NUCLS => SELF%F_NUCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_NVCLS)) THEN
  SELF%NVCLS => SELF%F_NVCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLCG)) THEN
  SELF%PLCG => SELF%F_PLCG%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLCH)) THEN
  SELF%PLCH => SELF%F_PLCH%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLCL)) THEN
  SELF%PLCL => SELF%F_PLCL%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLCN)) THEN
  SELF%PLCN => SELF%F_PLCN%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLSG)) THEN
  SELF%PLSG => SELF%F_PLSG%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLSH)) THEN
  SELF%PLSH => SELF%F_PLSH%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLSL)) THEN
  SELF%PLSL => SELF%F_PLSL%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PLSN)) THEN
  SELF%PLSN => SELF%F_PLSN%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PTYPE2)) THEN
  SELF%PTYPE2 => SELF%F_PTYPE2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PTYPE)) THEN
  SELF%PTYPE => SELF%F_PTYPE%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PTYPESEV2)) THEN
  SELF%PTYPESEV2 => SELF%F_PTYPESEV2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_PTYPESEV)) THEN
  SELF%PTYPESEV => SELF%F_PTYPESEV%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_QCLS)) THEN
  SELF%QCLS => SELF%F_QCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_QICE)) THEN
  SELF%QICE => SELF%F_QICE%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_QLI)) THEN
  SELF%QLI => SELF%F_QLI%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RHCLS)) THEN
  SELF%RHCLS => SELF%F_RHCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RSO)) THEN
  SELF%RSO => SELF%F_RSO%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RTH)) THEN
  SELF%RTH => SELF%F_RTH%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RUISL)) THEN
  SELF%RUISL => SELF%F_RUISL%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RUISP)) THEN
  SELF%RUISP => SELF%F_RUISP%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_RUISS)) THEN
  SELF%RUISS => SELF%F_RUISS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_SIC)) THEN
  SELF%SIC => SELF%F_SIC%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TCLS)) THEN
  SELF%TCLS => SELF%F_TCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_THW)) THEN
  SELF%THW => SELF%F_THW%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TN)) THEN
  SELF%TN => SELF%F_TN%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TPWCLS)) THEN
  SELF%TPWCLS => SELF%F_TPWCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TRCU)) THEN
  SELF%TRCU => SELF%F_TRCU%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TRCV)) THEN
  SELF%TRCV => SELF%F_TRCV%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TRDU)) THEN
  SELF%TRDU => SELF%F_TRDU%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TRDV)) THEN
  SELF%TRDV => SELF%F_TRDV%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TRTU)) THEN
  SELF%TRTU => SELF%F_TRTU%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TRTV)) THEN
  SELF%TRTV => SELF%F_TRTV%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_TX)) THEN
  SELF%TX => SELF%F_TX%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_UCLS)) THEN
  SELF%UCLS => SELF%F_UCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_UGST2)) THEN
  SELF%UGST2 => SELF%F_UGST2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_UGST)) THEN
  SELF%UGST => SELF%F_UGST%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VCLS)) THEN
  SELF%VCLS => SELF%F_VCLS%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VEIN)) THEN
  SELF%VEIN => SELF%F_VEIN%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VGST2)) THEN
  SELF%VGST2 => SELF%F_VGST2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VGST)) THEN
  SELF%VGST => SELF%F_VGST%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VISICLD2)) THEN
  SELF%VISICLD2 => SELF%F_VISICLD2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VISICLD)) THEN
  SELF%VISICLD => SELF%F_VISICLD%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VISIHYD2)) THEN
  SELF%VISIHYD2 => SELF%F_VISIHYD2%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_VISIHYD)) THEN
  SELF%VISIHYD => SELF%F_VISIHYD%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_XDIAGH)) THEN
  SELF%XDIAGH => SELF%F_XDIAGH%GET_VIEW (BLOCK_INDEX)
ENDIF

IF (ASSOCIATED (SELF%F_SNWDE)) THEN
  SELF%SNWDE => SELF%F_SNWDE%GET_VIEW (BLOCK_INDEX)
ENDIF


IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_UPDATE_VIEW', 1, ZHOOK_HANDLE)

END SUBROUTINE TXFU_TYPE_UPDATE_VIEW

SUBROUTINE TXFU_TYPE_FINAL (SELF)

CLASS (TXFU), INTENT (INOUT) :: SELF

REAL (KIND=JPHOOK) :: ZHOOK_HANDLE

IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_FINAL', 0, ZHOOK_HANDLE)

IF (ASSOCIATED (SELF%F_RMWINDCALC)) THEN
  CALL FIELD_DELETE (SELF%F_RMWINDCALC)
  SELF%F_RMWINDCALC => NULL () 
  SELF%RMWINDCALC => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RMNWINDCALC)) THEN
  CALL FIELD_DELETE (SELF%F_RMNWINDCALC)
  SELF%F_RMNWINDCALC => NULL () 
  SELF%RMNWINDCALC => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_CAPE)) THEN
  CALL FIELD_DELETE (SELF%F_CAPE)
  SELF%F_CAPE => NULL () 
  SELF%CAPE => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_CLPH)) THEN
  CALL FIELD_DELETE (SELF%F_CLPH)
  SELF%F_CLPH => NULL () 
  SELF%CLPH => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_CLPHMF)) THEN
  CALL FIELD_DELETE (SELF%F_CLPHMF)
  SELF%F_CLPHMF => NULL () 
  SELF%CLPHMF => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VMAXTH)) THEN
  CALL FIELD_DELETE (SELF%F_VMAXTH)
  SELF%F_VMAXTH => NULL () 
  SELF%VMAXTH => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_CLWC2)) THEN
  CALL FIELD_DELETE (SELF%F_CLWC2)
  SELF%F_CLWC2 => NULL () 
  SELF%CLWC2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_CLWC)) THEN
  CALL FIELD_DELETE (SELF%F_CLWC)
  SELF%F_CLWC => NULL () 
  SELF%CLWC => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_CTOP)) THEN
  CALL FIELD_DELETE (SELF%F_CTOP)
  SELF%F_CTOP => NULL () 
  SELF%CTOP => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_DICQ)) THEN
  CALL FIELD_DELETE (SELF%F_DICQ)
  SELF%F_DICQ => NULL () 
  SELF%DICQ => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_DICS)) THEN
  CALL FIELD_DELETE (SELF%F_DICS)
  SELF%F_DICS => NULL () 
  SELF%DICS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_DITQ)) THEN
  CALL FIELD_DELETE (SELF%F_DITQ)
  SELF%F_DITQ => NULL () 
  SELF%DITQ => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_DITS)) THEN
  CALL FIELD_DELETE (SELF%F_DITS)
  SELF%F_DITS => NULL () 
  SELF%DITS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_FCHSP)) THEN
  CALL FIELD_DELETE (SELF%F_FCHSP)
  SELF%F_FCHSP => NULL () 
  SELF%FCHSP => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_FEVL)) THEN
  CALL FIELD_DELETE (SELF%F_FEVL)
  SELF%F_FEVL => NULL () 
  SELF%FEVL => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_FEVV)) THEN
  CALL FIELD_DELETE (SELF%F_FEVV)
  SELF%F_FEVV => NULL () 
  SELF%FEVV => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_FLWSP)) THEN
  CALL FIELD_DELETE (SELF%F_FLWSP)
  SELF%F_FLWSP => NULL () 
  SELF%FLWSP => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_FONTE)) THEN
  CALL FIELD_DELETE (SELF%F_FONTE)
  SELF%F_FONTE => NULL () 
  SELF%FONTE => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_FTR)) THEN
  CALL FIELD_DELETE (SELF%F_FTR)
  SELF%F_FTR => NULL () 
  SELF%FTR => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_HUN)) THEN
  CALL FIELD_DELETE (SELF%F_HUN)
  SELF%F_HUN => NULL () 
  SELF%HUN => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_HUX)) THEN
  CALL FIELD_DELETE (SELF%F_HUX)
  SELF%F_HUX => NULL () 
  SELF%HUX => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_MOCON)) THEN
  CALL FIELD_DELETE (SELF%F_MOCON)
  SELF%F_MOCON => NULL () 
  SELF%MOCON => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_MRT)) THEN
  CALL FIELD_DELETE (SELF%F_MRT)
  SELF%F_MRT => NULL () 
  SELF%MRT => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NBBAS)) THEN
  CALL FIELD_DELETE (SELF%F_NBBAS)
  SELF%F_NBBAS => NULL () 
  SELF%NBBAS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NBCON)) THEN
  CALL FIELD_DELETE (SELF%F_NBCON)
  SELF%F_NBCON => NULL () 
  SELF%NBCON => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NBHAU)) THEN
  CALL FIELD_DELETE (SELF%F_NBHAU)
  SELF%F_NBHAU => NULL () 
  SELF%NBHAU => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NBMOY)) THEN
  CALL FIELD_DELETE (SELF%F_NBMOY)
  SELF%F_NBMOY => NULL () 
  SELF%NBMOY => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NEB)) THEN
  CALL FIELD_DELETE (SELF%F_NEB)
  SELF%F_NEB => NULL () 
  SELF%NEB => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NEBT)) THEN
  CALL FIELD_DELETE (SELF%F_NEBT)
  SELF%F_NEBT => NULL () 
  SELF%NEBT => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NUCLS)) THEN
  CALL FIELD_DELETE (SELF%F_NUCLS)
  SELF%F_NUCLS => NULL () 
  SELF%NUCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_NVCLS)) THEN
  CALL FIELD_DELETE (SELF%F_NVCLS)
  SELF%F_NVCLS => NULL () 
  SELF%NVCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLCG)) THEN
  CALL FIELD_DELETE (SELF%F_PLCG)
  SELF%F_PLCG => NULL () 
  SELF%PLCG => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLCH)) THEN
  CALL FIELD_DELETE (SELF%F_PLCH)
  SELF%F_PLCH => NULL () 
  SELF%PLCH => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLCL)) THEN
  CALL FIELD_DELETE (SELF%F_PLCL)
  SELF%F_PLCL => NULL () 
  SELF%PLCL => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLCN)) THEN
  CALL FIELD_DELETE (SELF%F_PLCN)
  SELF%F_PLCN => NULL () 
  SELF%PLCN => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLSG)) THEN
  CALL FIELD_DELETE (SELF%F_PLSG)
  SELF%F_PLSG => NULL () 
  SELF%PLSG => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLSH)) THEN
  CALL FIELD_DELETE (SELF%F_PLSH)
  SELF%F_PLSH => NULL () 
  SELF%PLSH => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLSL)) THEN
  CALL FIELD_DELETE (SELF%F_PLSL)
  SELF%F_PLSL => NULL () 
  SELF%PLSL => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PLSN)) THEN
  CALL FIELD_DELETE (SELF%F_PLSN)
  SELF%F_PLSN => NULL () 
  SELF%PLSN => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PTYPE2)) THEN
  CALL FIELD_DELETE (SELF%F_PTYPE2)
  SELF%F_PTYPE2 => NULL () 
  SELF%PTYPE2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PTYPE)) THEN
  CALL FIELD_DELETE (SELF%F_PTYPE)
  SELF%F_PTYPE => NULL () 
  SELF%PTYPE => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PTYPESEV2)) THEN
  CALL FIELD_DELETE (SELF%F_PTYPESEV2)
  SELF%F_PTYPESEV2 => NULL () 
  SELF%PTYPESEV2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_PTYPESEV)) THEN
  CALL FIELD_DELETE (SELF%F_PTYPESEV)
  SELF%F_PTYPESEV => NULL () 
  SELF%PTYPESEV => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_QCLS)) THEN
  CALL FIELD_DELETE (SELF%F_QCLS)
  SELF%F_QCLS => NULL () 
  SELF%QCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_QICE)) THEN
  CALL FIELD_DELETE (SELF%F_QICE)
  SELF%F_QICE => NULL () 
  SELF%QICE => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_QLI)) THEN
  CALL FIELD_DELETE (SELF%F_QLI)
  SELF%F_QLI => NULL () 
  SELF%QLI => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RHCLS)) THEN
  CALL FIELD_DELETE (SELF%F_RHCLS)
  SELF%F_RHCLS => NULL () 
  SELF%RHCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RSO)) THEN
  CALL FIELD_DELETE (SELF%F_RSO)
  SELF%F_RSO => NULL () 
  SELF%RSO => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RTH)) THEN
  CALL FIELD_DELETE (SELF%F_RTH)
  SELF%F_RTH => NULL () 
  SELF%RTH => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RUISL)) THEN
  CALL FIELD_DELETE (SELF%F_RUISL)
  SELF%F_RUISL => NULL () 
  SELF%RUISL => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RUISP)) THEN
  CALL FIELD_DELETE (SELF%F_RUISP)
  SELF%F_RUISP => NULL () 
  SELF%RUISP => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_RUISS)) THEN
  CALL FIELD_DELETE (SELF%F_RUISS)
  SELF%F_RUISS => NULL () 
  SELF%RUISS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_SIC)) THEN
  CALL FIELD_DELETE (SELF%F_SIC)
  SELF%F_SIC => NULL () 
  SELF%SIC => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TCLS)) THEN
  CALL FIELD_DELETE (SELF%F_TCLS)
  SELF%F_TCLS => NULL () 
  SELF%TCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_THW)) THEN
  CALL FIELD_DELETE (SELF%F_THW)
  SELF%F_THW => NULL () 
  SELF%THW => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TN)) THEN
  CALL FIELD_DELETE (SELF%F_TN)
  SELF%F_TN => NULL () 
  SELF%TN => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TPWCLS)) THEN
  CALL FIELD_DELETE (SELF%F_TPWCLS)
  SELF%F_TPWCLS => NULL () 
  SELF%TPWCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TRCU)) THEN
  CALL FIELD_DELETE (SELF%F_TRCU)
  SELF%F_TRCU => NULL () 
  SELF%TRCU => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TRCV)) THEN
  CALL FIELD_DELETE (SELF%F_TRCV)
  SELF%F_TRCV => NULL () 
  SELF%TRCV => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TRDU)) THEN
  CALL FIELD_DELETE (SELF%F_TRDU)
  SELF%F_TRDU => NULL () 
  SELF%TRDU => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TRDV)) THEN
  CALL FIELD_DELETE (SELF%F_TRDV)
  SELF%F_TRDV => NULL () 
  SELF%TRDV => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TRTU)) THEN
  CALL FIELD_DELETE (SELF%F_TRTU)
  SELF%F_TRTU => NULL () 
  SELF%TRTU => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TRTV)) THEN
  CALL FIELD_DELETE (SELF%F_TRTV)
  SELF%F_TRTV => NULL () 
  SELF%TRTV => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_TX)) THEN
  CALL FIELD_DELETE (SELF%F_TX)
  SELF%F_TX => NULL () 
  SELF%TX => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_UCLS)) THEN
  CALL FIELD_DELETE (SELF%F_UCLS)
  SELF%F_UCLS => NULL () 
  SELF%UCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_UGST2)) THEN
  CALL FIELD_DELETE (SELF%F_UGST2)
  SELF%F_UGST2 => NULL () 
  SELF%UGST2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_UGST)) THEN
  CALL FIELD_DELETE (SELF%F_UGST)
  SELF%F_UGST => NULL () 
  SELF%UGST => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VCLS)) THEN
  CALL FIELD_DELETE (SELF%F_VCLS)
  SELF%F_VCLS => NULL () 
  SELF%VCLS => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VEIN)) THEN
  CALL FIELD_DELETE (SELF%F_VEIN)
  SELF%F_VEIN => NULL () 
  SELF%VEIN => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VGST2)) THEN
  CALL FIELD_DELETE (SELF%F_VGST2)
  SELF%F_VGST2 => NULL () 
  SELF%VGST2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VGST)) THEN
  CALL FIELD_DELETE (SELF%F_VGST)
  SELF%F_VGST => NULL () 
  SELF%VGST => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VISICLD2)) THEN
  CALL FIELD_DELETE (SELF%F_VISICLD2)
  SELF%F_VISICLD2 => NULL () 
  SELF%VISICLD2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VISICLD)) THEN
  CALL FIELD_DELETE (SELF%F_VISICLD)
  SELF%F_VISICLD => NULL () 
  SELF%VISICLD => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VISIHYD2)) THEN
  CALL FIELD_DELETE (SELF%F_VISIHYD2)
  SELF%F_VISIHYD2 => NULL () 
  SELF%VISIHYD2 => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_VISIHYD)) THEN
  CALL FIELD_DELETE (SELF%F_VISIHYD)
  SELF%F_VISIHYD => NULL () 
  SELF%VISIHYD => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_XDIAGH)) THEN
  CALL FIELD_DELETE (SELF%F_XDIAGH)
  SELF%F_XDIAGH => NULL () 
  SELF%XDIAGH => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_SNWDE)) THEN
  CALL FIELD_DELETE (SELF%F_SNWDE)
  SELF%F_SNWDE => NULL () 
  SELF%SNWDE => NULL ()
ENDIF


IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_FINAL', 1, ZHOOK_HANDLE)

END SUBROUTINE TXFU_TYPE_FINAL

SUBROUTINE TXFU_TYPE_RESET (SELF, LDCONFX, LDFSTEP, YDRIP, YDPHY, YDMCC)

USE PARKIND1           , ONLY : JPIM, JPRB
USE YOMHOOK            , ONLY : LHOOK, JPHOOK, DR_HOOK
USE YOMCT1             , ONLY : N1HIS
USE YOMCT0             , ONLY : NFRHIS  ,NHISTS  ,NHISTSMIN
USE YOMCT3             , ONLY : NSTEP
USE YOMRIP             , ONLY : TRIP
USE YOMPHY             , ONLY : TPHY
USE YOMMCC             , ONLY : TMCC

CLASS(TXFU)         ,INTENT(INOUT) :: SELF
LOGICAL             ,INTENT(IN)    :: LDCONFX
LOGICAL             ,INTENT(IN)    :: LDFSTEP
TYPE(TRIP)          ,INTENT(IN)    :: YDRIP
TYPE(TPHY)          ,INTENT(IN)    :: YDPHY
TYPE(TMCC)          ,INTENT(IN)    :: YDMCC

! - IRAZTS : CONTROLS INSTANTANEOUS FLUX RESET
INTEGER(KIND=JPIM) :: IRAZTS(NSTEP/SELF%NFRRAZ:NSTEP/SELF%NFRRAZ)
! - IHISTS : ARRAY CONTAINING TRAJECTORY TIME STEPS
INTEGER(KIND=JPIM), ALLOCATABLE :: IHISTS(:)
INTEGER(KIND=JPIM) :: JJ, IFRGST, IFRGST2, IPERIOD,IFRVISI,IFRVISI2,IFRPRECIP,IFRPRECIP2
LOGICAL :: LLMEAN, LLMLPP

REAL(KIND=JPHOOK)    :: ZHOOK_HANDLE

!     ------------------------------------------------------------------

#include "monio_t.intfb.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_RESET', 0, ZHOOK_HANDLE)



!*    XFU CONTROL UPDATE

IF (.NOT.LDCONFX) THEN

  ! INSTANTANEOUS FLUX RESET
  CALL MONIO_T(NSTEP, YDRIP, IRAZTS(NSTEP:), SELF%N1RAZ, SELF%NFRRAZ, SELF%NRAZTS)
  SELF%LRESET=LDFSTEP.OR.(IRAZTS(NSTEP/SELF%NFRRAZ) == 1.AND.MOD(NSTEP,SELF%NFRRAZ) == 0)

  IF (SELF%LXMWINDCLS) THEN !WE WANT TO COMPUTE MEAN CLS WIND
    IPERIOD=MAX(0,NINT(REAL(SELF%MEANPERIOD,JPRB)/YDRIP%TSTEP)-1)
    ! HISTORY EVENTS FOR ATMOSPHERE
    ALLOCATE(IHISTS(NSTEP/NFRHIS:(NSTEP+1+IPERIOD)/NFRHIS))
    CALL MONIO_T(NSTEP/NFRHIS, YDRIP, IHISTS(NSTEP/NFRHIS:), N1HIS, NFRHIS, NHISTS, KN___TSMIN=NHISTSMIN&
    & )
    !IF WE SAVE HISTORY FILE THIS TIME STEP, WE REINIT MEAN CALCUL
    LLMLPP =IHISTS(NSTEP/NFRHIS) == 1.AND.MOD(NSTEP,NFRHIS) == 0
    IF(YDRIP%NSTART/=0.AND..NOT.YDMCC%LMULTIYR)THEN
      LLMLPP = LLMLPP.AND.NSTEP/=YDRIP%NSTART
    ENDIF
    IF(LLMLPP) THEN
      SELF%NMEANSTEPS=0
    ENDIF
    !IF WE WILL SAVE HISTORY FILE IN THE NEXT MEANPERIOD SECONDS
    LLMEAN=.FALSE.
    DO JJ=0,IPERIOD
      IF(NSTEP+JJ+1<=YDRIP%NSTOP) THEN
        IF(IHISTS((NSTEP+JJ+1)/NFRHIS)==1.AND.MOD(NSTEP+JJ+1,NFRHIS) == 0) THEN
          LLMEAN=.TRUE.
        ENDIF
      ENDIF
    ENDDO
    IF (LLMEAN) THEN
      SELF%NMEANSTEPS=SELF%NMEANSTEPS+1
    ENDIF
    !IF WE RESET FLUXES WE WILL TRUNC THE MEAN PERIOD, SO NMEANSTEPS=1
    IF (SELF%NMEANSTEPS/=0 .AND. SELF%LRESET) THEN
      SELF%NMEANSTEPS=1
    ENDIF
  ENDIF

  !IF WE WANT TO COMPUTE MAX GUST OVER A DEFINED PERIOD (NXGSTPERIOD)
  IF((SELF%LXXGST.OR.SELF%LXXDIAGH) .AND. SELF%NXGSTPERIOD>0) THEN
    !IF WE SAVE HISTORY OR FULLPOS FILE THIS TIME STEP, WE REINIT MAX CALCULATION
    IFRGST=NINT(REAL(SELF%NXGSTPERIOD,JPRB)/YDRIP%TSTEP)
    SELF%LRESET_GST=.FALSE.
    IF(MOD(NSTEP,IFRGST)==0) SELF%LRESET_GST=.TRUE.
  ENDIF

  IF(SELF%LXXGST2.AND.SELF%NXGSTPERIOD2>0) THEN
    !IF WE SAVE HISTORY OR FULLPOS FILE THIS TIME STEP, WE REINIT MAX CALCULATION
    IFRGST2=NINT(REAL(SELF%NXGSTPERIOD2,JPRB)/YDRIP%TSTEP)
    SELF%LRESET_GST2=.FALSE.
    IF(MOD(NSTEP,IFRGST2)==0) SELF%LRESET_GST2=.TRUE.
  ENDIF

  IF(SELF%LXVISI .AND. SELF%NVISIPERIOD>0) THEN
    !IF WE SAVE HISTORY OR FULLPOS FILE THIS TIME STEP, WE REINIT 
    !CALCULATION
    IFRVISI=NINT(REAL(SELF%NVISIPERIOD,JPRB)/YDRIP%TSTEP)
    !WRITE(20,*),'IFRVISI=',IFRVISI,NVISIPERIOD,TSTEP,JSTEP
    SELF%LRESET_VISI=.FALSE.
    IF(MOD(NSTEP,IFRVISI)==0) SELF%LRESET_VISI=.TRUE.

  ENDIF
  IF(SELF%LXVISI2 .AND.SELF%NVISIPERIOD2>0) THEN
    !IF WE SAVE HISTORY OR FULLPOS FILE THIS TIME STEP, WE REINIT MAX
    !CALCULATION
    IFRVISI2=NINT(REAL(SELF%NVISIPERIOD2,JPRB)/YDRIP%TSTEP)
    !WRITE(20,*),'IFRVISI2=',IFRVISI2,NVISIPERIOD2,TSTEP,JSTEP
    SELF%LRESET_VISI2=.FALSE.
    IF(MOD(NSTEP,IFRVISI2)==0) SELF%LRESET_VISI2=.TRUE.
  ENDIF

  !IF WE WANT TO COMPUTE PRECIPS TYPE OVER A DEFINED PERIOD (NDPRECPERIOD)
  IF (YDPHY%LDPRECIPS.AND.YDPHY%NDPRECPERIOD>0) THEN
     !IF WE SAVE HISTORY OR FULLPOS FILE THIS TIME STEP, WE REINIT 
     ! PRECIPS TYPE
     IFRPRECIP=NINT(REAL(YDPHY%NDPRECPERIOD,JPRB)/YDRIP%TSTEP)
     SELF%LRESET_PRECIP=.FALSE.
    IF(MOD(NSTEP,IFRPRECIP)==0) SELF%LRESET_PRECIP=.TRUE.
  ENDIF

  !IF WE WANT TO COMPUTE PRECIPS TYPE OVER A DEFINED PERIOD (NDPRECPERIOD2)
  IF (YDPHY%LDPRECIPS2.AND.YDPHY%NDPRECPERIOD2>0) THEN
     !IF WE SAVE HISTORY OR FULLPOS FILE THIS TIME STEP, WE REINIT 
     ! PRECIPS TYPE
     IFRPRECIP2=NINT(REAL(YDPHY%NDPRECPERIOD2,JPRB)/YDRIP%TSTEP)
     SELF%LRESET_PRECIP2=.FALSE.
    IF(MOD(NSTEP,IFRPRECIP2)==0) SELF%LRESET_PRECIP2=.TRUE.
  ENDIF


ELSE

  SELF%LRESET=.TRUE.
  SELF%LRESET_GST=.TRUE.
  SELF%LRESET_GST2=.TRUE.
  SELF%LRESET_VISI=.TRUE.
  SELF%LRESET_VISI2=.TRUE.
  SELF%LRESET_PRECIP=.TRUE.
  SELF%LRESET_PRECIP2=.TRUE.

ENDIF



IF (LHOOK) CALL DR_HOOK('TXFU_TYPE_RESET', 1, ZHOOK_HANDLE)

END SUBROUTINE TXFU_TYPE_RESET

END MODULE YOMXFU_TYPE
