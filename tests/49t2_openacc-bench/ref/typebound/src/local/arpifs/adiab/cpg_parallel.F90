SUBROUTINE CPG_PARALLEL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_SL1AUX, YDCPG_SL2,&
& YDCPG_MISC, YDCPG_GPAR, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS, YDHGRAD, YDCPG_DDH, YDCPG_DYN0, YDCPG_DYN9&
&, YDMF_PHYS_SURF, YDVARS, YDXFU, YDCFU, YDMODEL, YDFIELDS, YDA_GFLSLP, YDA_SAVTEND, YDCPG_DDH_TND&
&, YDPGTERM, YDA_GFLPC, YDA_GFLPT, YDCPG_SLMISC, YDCPG_SL1, YDA_EXTRA, YDDDH, YDTDDH, YDA_RSAVEDP&
&, YDA_PWRL9, YDPHYSMWAVE, PGPSDT2D, PGFL, PGMVT1, PGFLT1, PTRAJ_PHYS, PTRAJ_SLAG)
USE TYPE_MODEL,ONLY:MODEL
USE FIELDS_MOD,ONLY:FIELDS
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE MF_PHYS_TYPE_MOD,ONLY:MF_PHYS_TYPE
USE CPG_TYPE_MOD,ONLY:CPG_DDH_TYPE, CPG_DYN_TYPE, CPG_GPAR_TYPE&
&, CPG_MISC_TYPE, CPG_PHY_TYPE, CPG_TND_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE, CPG_SL1F_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE MF_PHYS_SURFACE_TYPE_MOD,ONLY:MF_PHYS_SURF_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE YOMXFU,ONLY:TXFU
USE YOMCFU,ONLY:TCFU

USE YOMHOOK,ONLY:DR_HOOK, LHOOK, JPHOOK
USE EINT_MOD,ONLY:SL_STRUCT
USE DDH_MIX,ONLY:CLEANDDH, RESET_DDHFLEX, SETDDH, TYP_DDH
USE YOMTRAJ,ONLY:LTRAJSAVE, LTRAJSLAG, TRAJ_PHYS_TYPE, TRAJ_SLAG_TYPE
USE YOMINI,ONLY:LINITER
USE ALGORITHM_STATE_MOD,ONLY:GET_NUPTRA
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_DDH_TND_TYPE
USE CPG_SLMISC_TYPE_MOD,ONLY:CPG_SLMISC_TYPE
USE FIELD_ARRAY_MODULE
USE INTDYN_MOD,ONLY:TPG_TYPE
USE YOMTDDH,ONLY:TTDDH
USE YOMDGRADIENT_TYPE_MOD,ONLY:GRADIENT_TYPE
USE YOE_PHYS_MWAVE,ONLY:TEPHYSMWAVE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
USE FIELD_ARRAY_UTIL_MODULE
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_TND_TYPE), INTENT (INOUT)::YDCPG_TND
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1AUX
TYPE (CPG_SL2_TYPE), INTENT (INOUT)::YDCPG_SL2
TYPE (CPG_MISC_TYPE), INTENT (INOUT)::YDCPG_MISC
TYPE (CPG_GPAR_TYPE), INTENT (INOUT)::YDCPG_GPAR
TYPE (CPG_PHY_TYPE), INTENT (INOUT)::YDCPG_PHY0
TYPE (CPG_PHY_TYPE), INTENT (INOUT)::YDCPG_PHY9
TYPE (MF_PHYS_TYPE), INTENT (INOUT)::YDMF_PHYS
TYPE (GRADIENT_TYPE), INTENT (INOUT)::YDHGRAD
TYPE (CPG_DDH_TYPE), INTENT (INOUT)::YDCPG_DDH
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN0
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN9
TYPE (MF_PHYS_SURF_TYPE), INTENT (INOUT)::YDMF_PHYS_SURF
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (TXFU), INTENT (INOUT)::YDXFU
TYPE (TCFU), INTENT (INOUT)::YDCFU
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (FIELDS), INTENT (INOUT)::YDFIELDS
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_GFLSLP
TYPE (FIELD_4RB_ARRAY), INTENT (IN)::YDA_SAVTEND
TYPE (CPG_DDH_TND_TYPE), INTENT (INOUT)::YDCPG_DDH_TND
TYPE (TPG_TYPE), INTENT (INOUT)::YDPGTERM
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_GFLPC
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_GFLPT
TYPE (CPG_SLMISC_TYPE), INTENT (INOUT)::YDCPG_SLMISC
TYPE (CPG_SL1F_TYPE), INTENT (INOUT)::YDCPG_SL1
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_EXTRA
TYPE (TYP_DDH), INTENT (INOUT)::YDDDH
TYPE (TTDDH), INTENT (INOUT)::YDTDDH
TYPE (FIELD_4RB_ARRAY), INTENT (INOUT)::YDA_RSAVEDP
TYPE (FIELD_3RB_ARRAY), INTENT (INOUT)::YDA_PWRL9
TYPE (TEPHYSMWAVE), INTENT (INOUT)::YDPHYSMWAVE
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PGPSDT2D (YDGEOMETRY%YRDIM%NPROMA&
&, YDMODEL%YRML_SPPT%YGPSDT (1)%NG2D, YDGEOMETRY%YRDIM%NGPBLKS)
REAL (KIND=JPRB), INTENT (INOUT), OPTIONAL::PGFL (YDCPG_OPTS&
&%KLON, YDCPG_OPTS%KFLEVG, YDMODEL%YRML_GCONF%YGFL%NDIM)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PGMVT1 (YDCPG_OPTS&
&%KLON, YDCPG_OPTS%KFLEVG, YDFIELDS%YRGMV%YT1%NDIM)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PGFLT1 (YDCPG_OPTS&
&%KLON, YDCPG_OPTS%KFLEVG, YDMODEL%YRML_GCONF%YGFL%NDIM1)
TYPE (TRAJ_PHYS_TYPE), INTENT (INOUT), OPTIONAL::PTRAJ_PHYS
TYPE (TRAJ_SLAG_TYPE), INTENT (INOUT), OPTIONAL::PTRAJ_SLAG
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JFLD
INTEGER (KIND=JPIM)::IUPTRA
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "cpg_dia_flu_parallel.intfb.h"
#include "abor1.intfb.h"
#include "cpg_dyn_slg_parallel.intfb.h"
#include "cpg_gp_parallel.intfb.h"
#include "mf_phys_parallel.intfb.h"
#include "cpg_end_sfc_parallel.intfb.h"
#include "cpg_end_map_parallel.intfb.h"
INTEGER (KIND=JPIM) :: JLON
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL (KIND=JPRB), POINTER :: Z_YDCPG_MISC_LSM(:,:)
REAL (KIND=JPRB), POINTER :: Z_YDCPG_MISC_TSOL(:,:)
INTEGER(KIND=JPIM), POINTER :: Z_YDCPG_SLMISC_ISETTLOFF(:,:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSD_VF_PLSM(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDMF_PHYS_SURF_GSP_RR_PT_T0(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDVARS_T_T0(:,:,:)
IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)


IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('UPDATEVIEW','CPG_PARALLEL:ZEROPB2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  CALL YDCPG_SL2%ACDC_HOST ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YDCPG_SL2%UPDATE_VIEW (JBLK)
    CALL YLCPG_BNDS%UPDATE (JBLK)
    
    CALL YDCPG_SL2%SET (YDCPG_OPTS, YLCPG_BNDS, 0._JPRB)
  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ZEROPB2')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPMETHOD','CPG_PARALLEL:ZEROPB2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YDCPG_SL2%SET_HOST_PARALLEL (YDCPG_OPTS, YLCPG_BNDS, 0._JPRB)
  
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ZEROPB2')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCMETHOD','CPG_PARALLEL:ZEROPB2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YDCPG_SL2%SET_DEVICE_PARALLEL (YDCPG_OPTS, YLCPG_BNDS, 0._JPRB)
  
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ZEROPB2')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CPG_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROPB2',1,ZHOOK_HANDLE_PARALLEL)
IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CPG_PARALLEL:ISETTLOFF')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_SLMISC_ISETTLOFF => GET_HOST_DATA_RDWR (YDCPG_SLMISC%F_ISETTLOFF)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)
    
    Z_YDCPG_SLMISC_ISETTLOFF (:,:, JBLK)=0_JPIM
  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ISETTLOFF')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    Z_YDCPG_SLMISC_ISETTLOFF => GET_HOST_DATA_RDWR (YDCPG_SLMISC%F_ISETTLOFF)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_SLMISC_ISETTLOFF => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','CPG_PARALLEL:ISETTLOFF')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_SLMISC_ISETTLOFF => GET_HOST_DATA_RDWR (YDCPG_SLMISC%F_ISETTLOFF)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  !$OMP PARALLEL DO PRIVATE (JBLK, JLON, YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

    

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      
      Z_YDCPG_SLMISC_ISETTLOFF (JLON,:, JBLK)=0_JPIM
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ISETTLOFF')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    Z_YDCPG_SLMISC_ISETTLOFF => GET_HOST_DATA_RDWR (YDCPG_SLMISC%F_ISETTLOFF)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_SLMISC_ISETTLOFF => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CPG_PARALLEL:ISETTLOFF')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_SLMISC_ISETTLOFF => GET_DEVICE_DATA_RDWR (YDCPG_SLMISC%F_ISETTLOFF)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (YDCPG_OPTS, YFXTRAN_ACDC_STACK, Z_YDCPG_SLMISC_ISETTLOFF) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      
      Z_YDCPG_SLMISC_ISETTLOFF (JLON,:, JBLK)=0_JPIM
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ISETTLOFF')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    Z_YDCPG_SLMISC_ISETTLOFF => GET_HOST_DATA_RDWR (YDCPG_SLMISC%F_ISETTLOFF)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_SLMISC_ISETTLOFF => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CPG_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ISETTLOFF',1,ZHOOK_HANDLE_PARALLEL)

IF (YDMODEL%YRML_LBC%LTENC) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF

CALL CPG_GP_PARALLEL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_GPAR, YDCPG_DYN0&
&, YDCPG_DYN9, YDHGRAD, YDMF_PHYS_SURF, YDVARS, YDMODEL, YDCPG_SL2, YDPGTERM, YDDDH)

IF (YDMODEL%YRML_DIAG%YRLDDH%LRSLDDH.AND.YDMODEL%YRML_DYN%YRDYNA%LSLAG) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (YDMODEL%YRML_DIAG%YRLDDH%LSDDH) THEN
  
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (YDCPG_OPTS%LUSEPB1) THEN
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1',0,ZHOOK_HANDLE_PARALLEL)

  IF (FXTRAN_ACDC_LPARALLELMETHOD ('UPDATEVIEW','CPG_PARALLEL:ZEROSL1')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    CALL YDCPG_SL1AUX%ACDC_HOST ()
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YLCPG_BNDS%INIT (YDCPG_OPTS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      CALL YDCPG_SL1AUX%UPDATE_VIEW (JBLK)
      CALL YLCPG_BNDS%UPDATE (JBLK)
      
      CALL YDCPG_SL1AUX%SET (YDCPG_OPTS, YLCPG_BNDS, 0._JPRB)
    ENDDO

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ZEROSL1')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPMETHOD','CPG_PARALLEL:ZEROSL1')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YDCPG_SL1AUX%SET_HOST_PARALLEL (YDCPG_OPTS, YLCPG_BNDS, 0._JPRB)
    
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ZEROSL1')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCMETHOD','CPG_PARALLEL:ZEROSL1')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YDCPG_SL1AUX%SET_DEVICE_PARALLEL (YDCPG_OPTS, YLCPG_BNDS, 0._JPRB)
    
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:ZEROSL1')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSE
      CALL ABOR1 ('CPG_PARALLEL: NOT METHOD WAS FOUND')
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:ZEROSL1',1,ZHOOK_HANDLE_PARALLEL)
ENDIF


IF (YDCPG_OPTS%LSLPHY.AND.((YDMODEL%YRML_DYN%YRDYNA%LPC_FULL.AND.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER&
  &==YDMODEL%YRML_DYN%YRDYN%NSITER)).OR.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LPC_FULL))) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (YDMODEL%YRML_PHY_EC%YRECUCONVCA%LCUCONV_CA) THEN
  
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL%YRML_PHY_MF%YRSIMPHL%LSIMPH) THEN
  CALL MF_PHYS_PARALLEL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC, YDCPG_GPAR&
  &, YDCPG_PHY0, YDCPG_PHY9, YDMF_PHYS, YDHGRAD, YDCPG_DYN0, YDCPG_DYN9, YDMF_PHYS_SURF&
  &, YDCPG_SL1AUX, YDCPG_SL2, YDVARS, YDXFU, YDCFU, YDMODEL, YDFIELDS, YDPHYSMWAVE&
  &, YDA_GFLPT, PGPSDT2D, PGFL, PGMVT1, PGFLT1, PTRAJ_PHYS, YDDDH)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0) THEN

  IF ((YDCPG_OPTS%NSTEP>=0).AND.YDMODEL%YRML_DIAG%YRLDDH%LSDDH&
    &.AND.(.NOT.LINITER).AND.(.NOT.YDCPG_OPTS%LCONFX)) THEN
    
    
    CALL ABOR1 ("ERROR: WRONG SETTINGS")
    
  ENDIF

  CALL CPG_DIA_FLU_PARALLEL (YDCPG_BNDS, YDCPG_OPTS, YDCPG_MISC, YDMF_PHYS&
  &%OUT, YDCPG_DYN0, YDMF_PHYS_SURF, YDVARS, YDCFU, YDXFU, YDMODEL)
  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LSLDIA.AND.(YDMODEL%YRML_DYN%YRDYN&
  &%NCURRENT_ITER==YDMODEL%YRML_DYN%YRDYN%NSITER)) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF

IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CPG_PARALLEL:LSMTSOL')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_MISC_LSM => GET_HOST_DATA_RDWR (YDCPG_MISC%F_LSM)
  Z_YDCPG_MISC_TSOL => GET_HOST_DATA_RDWR (YDCPG_MISC%F_TSOL)
  Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VF%F_LSM)
  Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSP_RR%F_T_T0)
  Z_YDVARS_T_T0 => GET_HOST_DATA_RDONLY (YDVARS%T%FT0)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    IF (YDCPG_OPTS%YRSURF_OPTS%YSD_VF%YLSM%LSET) THEN
      Z_YDCPG_MISC_LSM (:, JBLK)=Z_YDMF_PHYS_SURF_GSD_VF_PLSM (:, JBLK)
    ELSE
      Z_YDCPG_MISC_LSM (:, JBLK)=0.0_JPRB
    ENDIF


    IF (YDCPG_OPTS%YRSURF_OPTS%YSP_RR%YT%LSET) THEN
      Z_YDCPG_MISC_TSOL (:, JBLK)=Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 (:, JBLK)
    ELSE
      Z_YDCPG_MISC_TSOL (:, JBLK)=Z_YDVARS_T_T0 (:, YDGEOMETRY%YRDIMV%NFLEVG, JBLK)
    ENDIF

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:LSMTSOL')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    Z_YDCPG_MISC_LSM => GET_HOST_DATA_RDWR (YDCPG_MISC%F_LSM)
    Z_YDCPG_MISC_TSOL => GET_HOST_DATA_RDWR (YDCPG_MISC%F_TSOL)
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VF%F_LSM)
    Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSP_RR%F_T_T0)
    Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_MISC_LSM => NULL ()
  Z_YDCPG_MISC_TSOL => NULL ()
  Z_YDMF_PHYS_SURF_GSD_VF_PLSM => NULL ()
  Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => NULL ()
  Z_YDVARS_T_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','CPG_PARALLEL:LSMTSOL')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_MISC_LSM => GET_HOST_DATA_RDWR (YDCPG_MISC%F_LSM)
  Z_YDCPG_MISC_TSOL => GET_HOST_DATA_RDWR (YDCPG_MISC%F_TSOL)
  Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VF%F_LSM)
  Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => GET_HOST_DATA_RDONLY (YDMF_PHYS_SURF%GSP_RR%F_T_T0)
  Z_YDVARS_T_T0 => GET_HOST_DATA_RDONLY (YDVARS%T%FT0)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  !$OMP PARALLEL DO PRIVATE (JBLK, JLON, YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

    

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      IF (YDCPG_OPTS%YRSURF_OPTS%YSD_VF%YLSM%LSET) THEN
        Z_YDCPG_MISC_LSM (JLON, JBLK)=Z_YDMF_PHYS_SURF_GSD_VF_PLSM (JLON, JBLK)
      ELSE
        Z_YDCPG_MISC_LSM (JLON, JBLK)=0.0_JPRB
      ENDIF


      IF (YDCPG_OPTS%YRSURF_OPTS%YSP_RR%YT%LSET) THEN
        Z_YDCPG_MISC_TSOL (JLON, JBLK)=Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 (JLON, JBLK)
      ELSE
        Z_YDCPG_MISC_TSOL (JLON, JBLK)=Z_YDVARS_T_T0 (JLON, YDGEOMETRY%YRDIMV%NFLEVG, JBLK)
      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:LSMTSOL')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    Z_YDCPG_MISC_LSM => GET_HOST_DATA_RDWR (YDCPG_MISC%F_LSM)
    Z_YDCPG_MISC_TSOL => GET_HOST_DATA_RDWR (YDCPG_MISC%F_TSOL)
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VF%F_LSM)
    Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSP_RR%F_T_T0)
    Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_MISC_LSM => NULL ()
  Z_YDCPG_MISC_TSOL => NULL ()
  Z_YDMF_PHYS_SURF_GSD_VF_PLSM => NULL ()
  Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => NULL ()
  Z_YDVARS_T_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CPG_PARALLEL:LSMTSOL')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_MISC_LSM => GET_DEVICE_DATA_RDWR (YDCPG_MISC%F_LSM)
  Z_YDCPG_MISC_TSOL => GET_DEVICE_DATA_RDWR (YDCPG_MISC%F_TSOL)
  Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSD_VF%F_LSM)
  Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => GET_DEVICE_DATA_RDONLY (YDMF_PHYS_SURF%GSP_RR%F_T_T0)
  Z_YDVARS_T_T0 => GET_DEVICE_DATA_RDONLY (YDVARS%T%FT0)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (YDCPG_OPTS, YDGEOMETRY, YFXTRAN_ACDC_STACK, Z_YDCPG_MISC_LSM, &
    !$ACC&         Z_YDCPG_MISC_TSOL, Z_YDMF_PHYS_SURF_GSD_VF_PLSM, Z_YDMF_PHYS_SURF_GSP_RR_PT_T0, &
    !$ACC&         Z_YDVARS_T_T0) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      IF (YDCPG_OPTS%YRSURF_OPTS%YSD_VF%YLSM%LSET) THEN
        Z_YDCPG_MISC_LSM (JLON, JBLK)=Z_YDMF_PHYS_SURF_GSD_VF_PLSM (JLON, JBLK)
      ELSE
        Z_YDCPG_MISC_LSM (JLON, JBLK)=0.0_JPRB
      ENDIF


      IF (YDCPG_OPTS%YRSURF_OPTS%YSP_RR%YT%LSET) THEN
        Z_YDCPG_MISC_TSOL (JLON, JBLK)=Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 (JLON, JBLK)
      ELSE
        Z_YDCPG_MISC_TSOL (JLON, JBLK)=Z_YDVARS_T_T0 (JLON, YDGEOMETRY%YRDIMV%NFLEVG, JBLK)
      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:LSMTSOL')) THEN
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    Z_YDCPG_MISC_LSM => GET_HOST_DATA_RDWR (YDCPG_MISC%F_LSM)
    Z_YDCPG_MISC_TSOL => GET_HOST_DATA_RDWR (YDCPG_MISC%F_TSOL)
    Z_YDMF_PHYS_SURF_GSD_VF_PLSM => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSD_VF%F_LSM)
    Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => GET_HOST_DATA_RDWR (YDMF_PHYS_SURF%GSP_RR%F_T_T0)
    Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  Z_YDCPG_MISC_LSM => NULL ()
  Z_YDCPG_MISC_TSOL => NULL ()
  Z_YDMF_PHYS_SURF_GSD_VF_PLSM => NULL ()
  Z_YDMF_PHYS_SURF_GSP_RR_PT_T0 => NULL ()
  Z_YDVARS_T_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CPG_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:LSMTSOL',1,ZHOOK_HANDLE_PARALLEL)

IF (YDMODEL%YRML_DYN%YRDYNA%LSLAG) THEN
  CALL CPG_DYN_SLG_PARALLEL (YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDCPG_TND, YDCPG_MISC, YDCPG_DYN0, YDCPG_DYN9&
  &, YDVARS, YDCPG_SL1AUX, YDCPG_SL2, YDMODEL, YDCPG_SLMISC, YDCPG_DDH_TND%YSI, YDA_PWRL9)
ELSE
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (LTRAJSAVE.AND.LTRAJSLAG) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (YDCPG_OPTS%LUSEPB1) THEN
  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1',0,ZHOOK_HANDLE_PARALLEL)

  IF (FXTRAN_ACDC_LPARALLELMETHOD ('UPDATEVIEW','CPG_PARALLEL:SHUFFLESL1')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    CALL YDCPG_SL1AUX%ACDC_HOST ()
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YLCPG_BNDS%INIT (YDCPG_OPTS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      CALL YDCPG_SL1AUX%UPDATE_VIEW (JBLK)
      CALL YLCPG_BNDS%UPDATE (JBLK)
      
      CALL YDCPG_SL1AUX%SHUFFLE (YDMODEL%YRML_DYN%YRSL, YDCPG_OPTS, YLCPG_BNDS, YDCPG_SL1)
    ENDDO

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:SHUFFLESL1')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPMETHOD','CPG_PARALLEL:SHUFFLESL1')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YDCPG_SL1AUX%SHUFFLE_HOST_PARALLEL (YDMODEL%YRML_DYN%YRSL, YDCPG_OPTS, YLCPG_BNDS, YDCPG_SL1)
    
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:SHUFFLESL1')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCMETHOD','CPG_PARALLEL:SHUFFLESL1')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YDCPG_SL1AUX%SHUFFLE_DEVICE_PARALLEL (YDMODEL%YRML_DYN%YRSL, YDCPG_OPTS, YLCPG_BNDS, YDCPG_SL1)
    
    
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPG_PARALLEL:SHUFFLESL1')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSE
      CALL ABOR1 ('CPG_PARALLEL: NOT METHOD WAS FOUND')
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL:SHUFFLESL1',1,ZHOOK_HANDLE_PARALLEL)
ENDIF

IUPTRA=GET_NUPTRA ()
CALL CPG_END_SFC_PARALLEL (YDMODEL, YDCPG_OPTS, YDCPG_BNDS, YDMF_PHYS_SURF, IUPTRA)

IF (YDMODEL%YRML_PHY_MF%YRSIMPHL%LTRAJPS) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF

CALL CPG_END_MAP_PARALLEL (YDGEOMETRY, YDMODEL, YDVARS, YDCPG_BNDS, YDCPG_OPTS)

IF (YDMODEL%YRML_LBC%LTENC) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF





CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CPG_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE CPG_PARALLEL
