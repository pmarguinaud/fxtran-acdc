
SUBROUTINE ACNTCLS_OPENACC (YDPHY, YDPHY0, YDCST, KIDIA, KFDIA, KLON, KLEV, PAPRS, PAPRSF&
&, PCP, PQ, PT, PU, PV, PCD, PCDN, PCDMR, PCDNMR, PCDNH, PCH, PCPS, PDPHI, PDPHIT, PDPHIV&
&, PQS, PSTAB, PTS, PQCLS, PRHCLS, PTCLS, PUCLS, PVCLS, PUCLN, PVCLN, PZPCLS, YDSTACK)
!$ACC ROUTINE (ACNTCLS_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMPHY,ONLY:TPHY
USE YOMCST,ONLY:TCST
USE YOMPHY0,ONLY:TPHY0
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY0), INTENT (IN)::YDPHY0
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCD (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCDN (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCDMR (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCDNMR (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCDNH (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCH (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCPS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDPHI (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDPHIT (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDPHIV (KLON)
REAL (KIND=JPRB), INTENT (IN)::PQS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PSTAB (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PQCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRHCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PTCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PUCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PUCLN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVCLN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PZPCLS (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::ZRU
REAL (KIND=JPRB)::ZRS
REAL (KIND=JPRB)::ZLOGU
REAL (KIND=JPRB)::ZLOGS
REAL (KIND=JPRB)::ZIV
REAL (KIND=JPRB)::ZEW
REAL (KIND=JPRB)::ZDELTA
REAL (KIND=JPRB)::ZCPVMD
REAL (KIND=JPRB)::ZCORU
REAL (KIND=JPRB)::ZCORS
REAL (KIND=JPRB)::ZBNH
REAL (KIND=JPRB)::ZBN
REAL (KIND=JPRB)::ZBH
REAL (KIND=JPRB)::ZBD

#include "fcttrm.func.h"

JLON = KIDIA



ZCPVMD=YDCST%RCPV-YDCST%RCPD

ZBN=YDPHY0%VKARMN/SQRT (PCDN (JLON))
ZBNH=YDPHY0%VKARMN*SQRT (PCDNMR (JLON))/PCDNH (JLON)
ZBD=YDPHY0%VKARMN/SQRT (PCD (JLON))
ZBH=YDPHY0%VKARMN*SQRT (PCDMR (JLON))/PCH (JLON)
ZRU=PDPHIV (JLON)/PDPHI (JLON)
ZRS=PDPHIT (JLON)/PDPHI (JLON)
ZLOGU=LOG (1.0_JPRB+ZRU*(EXP (ZBN)-1.0_JPRB))
ZLOGS=LOG (1.0_JPRB+ZRS*(EXP (ZBNH)-1.0_JPRB))
ZCORU=PSTAB (JLON)*ZRU*(ZBN-ZBD)+(1.0_JPRB-PSTAB (JLON))*LOG&
& (1.0_JPRB+ZRU*(EXP (MAX (0.0_JPRB, ZBN-ZBD))-1.0_JPRB))
ZCORS=PSTAB (JLON)*ZRS*(ZBNH-ZBH)+(1.0_JPRB-PSTAB (JLON))*LOG&
& (1.0_JPRB+ZRS*(EXP (MAX (0.0_JPRB, ZBNH-ZBH))-1.0_JPRB))
ZIV=MAX (0.0_JPRB, MIN (1.0_JPRB,(ZLOGU-ZCORU)/ZBD))
PUCLS (JLON)=PU (JLON, KLEV)*ZIV
PVCLS (JLON)=PV (JLON, KLEV)*ZIV
ZIV=MAX (0.0_JPRB, ZLOGU/ZBD)
PUCLN (JLON)=PU (JLON, KLEV)*ZIV
PVCLN (JLON)=PV (JLON, KLEV)*ZIV
ZIV=MAX (0.0_JPRB, MIN (1.0_JPRB,(ZLOGS-ZCORS)/ZBH))

IF (YDPHY%LBLVAR) THEN
  PQCLS (JLON)=PQ (JLON, KLEV)
  PTCLS (JLON)=PT (JLON, KLEV)
ELSE
  PQCLS (JLON)=PQS (JLON)+ZIV*(PQ (JLON, KLEV)-PQS (JLON))
  PTCLS (JLON)=(PCPS (JLON)*PTS (JLON)+ZIV*(PCP (JLON, KLEV)*PT (JLON, KLEV)-PCPS (JLON&
  &)*PTS (JLON)+PDPHI (JLON))-PDPHIT (JLON))/(YDCST%RCPD+ZCPVMD*PQCLS (JLON))
ENDIF


IF (YDPHY%LNEIGE) THEN
  ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PTCLS (JLON)))
ELSE
  ZDELTA=0.0_JPRB
ENDIF

PZPCLS (JLON)=PAPRS (JLON, KLEV)+ZRS*(PAPRSF (JLON, KLEV)-PAPRS (JLON, KLEV))
ZEW=FOEW (PTCLS (JLON), ZDELTA)
PRHCLS (JLON)=(PZPCLS (JLON)*PQCLS (JLON)*(YDCST%RETV+1&
&.0_JPRB))/(ZEW*(1.0_JPRB+YDCST%RETV*PQCLS (JLON)))



END SUBROUTINE ACNTCLS_OPENACC
