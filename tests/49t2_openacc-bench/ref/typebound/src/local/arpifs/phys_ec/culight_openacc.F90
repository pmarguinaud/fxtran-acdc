SUBROUTINE CULIGHT_OPENACC (PPLDARE, PPLRG, YDTHF, YDCST, YDEPHY, YGFL, YDECUMF&
&, KIDIA, KFDIA, KLON, KLEV, PGAW, PGELAT, PAP, PAPH, PAPHI, PAPHIF, LDLAND, PT&
&, PLU, PMFU, PCAPE, PFPLCL, PFPLCN, PQPFROZ, LDCUM, KCBOT, KCTOP, LDLINOX, PLIGH_TOT&
&, PLIGH_CTG, PCTOPH, PPRECMX, PICE, PCDEPTH, PWMFU, PCHARGE, YDSTACK)
!$ACC ROUTINE (CULIGHT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOEPHY,ONLY:TEPHY
USE YOM_YGFL,ONLY:TYPE_GFLD
USE YOECUMF,ONLY:TECUMF
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TEPHY), INTENT (IN)::YDEPHY
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
TYPE (TECUMF), INTENT (IN)::YDECUMF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGELAT (KLON)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFPLCL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLCN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQPFROZ (KLON, KLEV)
LOGICAL, INTENT (IN)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDLAND (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
LOGICAL, INTENT (OUT)::LDLINOX (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLIGH_TOT (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLIGH_CTG (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCTOPH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PPRECMX (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PICE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCDEPTH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMFU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCHARGE (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK

INTEGER (KIND=JPIM)::IFREEZ15
INTEGER (KIND=JPIM)::IFREEZ25
INTEGER (KIND=JPIM)::IFREEZ
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ILEVBOTG
INTEGER (KIND=JPIM)::ILEVTOPG
REAL (KIND=JPRB)::ZBASHG
REAL (KIND=JPRB)::ZGEO2KM
REAL (KIND=JPRB)::ZAREA_REF
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZDEPTH
REAL (KIND=JPRB)::Z1G
REAL (KIND=JPRB)::ZPCTG
REAL (KIND=JPRB)::ZAREA 
REAL (KIND=JPRB)::ZCBASEH 
REAL (KIND=JPRB)::ZPREC_CV 
REAL (KIND=JPRB)::ZCDEPTH 
REAL (KIND=JPRB)::ZHBMAX
REAL (KIND=JPRB)::ZCOLDDPT
REAL (KIND=JPRB)::ZPFROZEN
REAL (KIND=JPRB)::ZBETA
REAL (KIND=JPRB)::ZQSNOW
REAL (KIND=JPRB)::ZQGRAUP

#include "fcttre.func.h"

JL = KIDIA



ZHBMAX=1.8_JPRB
Z1G=1.0_JPRB/YDCST%RG
ZGEO2KM=0.001_JPRB*Z1G
PLIGH_TOT (JL)=0.0_JPRB
PLIGH_CTG (JL)=0.0_JPRB
PCTOPH (JL)=-99.0_JPRB
PPRECMX (JL)=0.0_JPRB
PICE (JL)=0.0_JPRB
PCDEPTH (JL)=0.0_JPRB
PWMFU (JL)=-99.0_JPRB
ZCDEPTH =0.0_JPRB
PCHARGE (JL)=0.0_JPRB
ZPREC_CV =0.0_JPRB
ZCBASEH =-99.0_JPRB
LDLINOX (JL)=.FALSE.
ZAREA =1.0E-6_JPRB*4.0_JPRB*YDCST%RPI*YDCST%RA*YDCST%RA*PGAW (JL)
ZAREA_REF=(20015.1_JPRB/90.0_JPRB)*(17333.6_JPRB/72.0_JPRB)

IF (YGFL%NCHEM/=0.AND.YDEPHY%NLIMODE/=4) THEN
  CALL FXTRAN_ACDC_ABORT ('CULIGHT: NCHEM /= 0 .and. NLIMODE /= 4 NOT SUPPORTED')
ENDIF



IF (LDCUM (JL).AND.KCTOP (JL)>=1.AND.KCTOP (JL)<=KLEV) THEN
  ZBASHG=(PAPHIF (JL, KCBOT (JL))-PAPHIF (JL, KLEV))*ZGEO2KM
  PPRECMX (JL)=MAXVAL (PFPLCL (JL, KCTOP (JL):KCBOT (JL))+PFPLCN (JL, KCTOP (JL):KCBOT (JL)))

  IF (ZBASHG<(4.0_JPRB/PPLRG).AND.PPRECMX (JL)>1.E-10_JPRB) THEN
    LDLINOX (JL)=.TRUE.
    IFREEZ=-1
    IFREEZ25=-1
    IFREEZ15=-1

    DO JK=KLEV, 1,-1

      IF (PT (JL, JK)<=YDCST%RTT.AND.IFREEZ==-1)  THEN
        IFREEZ=JK
      ENDIF


      IF (PT (JL, JK)<=YDCST%RTT-25.0_JPRB.AND.IFREEZ25==-1)  THEN
        IFREEZ25=JK
      ENDIF


      IF (PT (JL, JK)<=YDCST%RTT-15.0_JPRB.AND.IFREEZ15==-1)  THEN
        IFREEZ15=JK
      ENDIF

    ENDDO

    PCTOPH (JL)=MAX ((PAPHI (JL, KCTOP (JL))-PAPHI (JL, KCBOT (JL)))*ZGEO2KM, 0.0_JPRB)
    PCDEPTH (JL)=MAX ((PAPHI (JL, KCTOP (JL))-PAPHI (JL, IFREEZ))*ZGEO2KM, 0.0_JPRB)
    PCDEPTH (JL)=MIN (PCDEPTH (JL), PCTOPH (JL))

    IF (YDEPHY%NLIMODE<=3.OR.YDEPHY%NLIMODE==7) THEN
      PWMFU (JL)=0.0_JPRB
      ZDEPTH=0.0_JPRB

      DO JK=KCTOP (JL), KCBOT (JL)

        IF (PMFU (JL, JK)>0.0_JPRB) THEN
          ZRHO=PAP (JL, JK)/(YDCST%RD*PT (JL, JK))
          ZDEPTH=ZDEPTH+(PAPHI (JL, JK-1)-PAPHI (JL, JK))
          PWMFU (JL)=PWMFU (JL)+PMFU (JL, JK)*(PAPHI (JL, JK-1)-PAPHI (JL, JK))/ZRHO
        ENDIF

      ENDDO


      IF (ZDEPTH>0.0_JPRB) THEN
        PWMFU (JL)=PWMFU (JL)/ZDEPTH
      ELSE
        PWMFU (JL)=-99.0_JPRB
      ENDIF

    ENDIF


    IF (YDEPHY%NLIMODE<=3) THEN

      DO JK=1, KLEV
        PICE (JL)=PICE (JL)+MAX (0.0_JPRB, PLU (JL, JK)*(1.0_JPRB-FOEALFCU&
        & (PT (JL, JK))))*(PAPH (JL, JK)-PAPH (JL, JK-1))*Z1G
      ENDDO

    ENDIF


    IF (YDEPHY%NLIMODE==6) THEN
      ILEVTOPG=MAX (IFREEZ25, KCTOP (JL))
      ILEVBOTG=MIN (IFREEZ, KCBOT (JL))
      ZCBASEH =MAX (0.0_JPRB,(PAPHI (JL, KCBOT (JL))-PAPHI (JL, KLEV))*ZGEO2KM)
      ZCDEPTH =MAX (0.0_JPRB,(PAPHI (JL, KCTOP (JL))-PAPHI (JL, KCBOT (JL)))*ZGEO2KM)

      IF (LDLAND (JL)) THEN
        ZBETA=0.70_JPRB
      ELSE
        ZBETA=0.45_JPRB
      ENDIF


      DO JK=ILEVTOPG, ILEVBOTG

        IF (YDECUMF%LMFPEN) THEN
          ZRHO=PAP (JL, JK)/(YDCST%RD*PT (JL, JK))
          ZPFROZEN=MAX (0.0_JPRB, PFPLCN (JL, JK))
          ZQGRAUP=ZBETA*ZPFROZEN/(ZRHO*3.0_JPRB)
          ZQSNOW=(1.0_JPRB-ZBETA)*ZPFROZEN/(ZRHO*0.5_JPRB)
        ELSE
          ZQGRAUP=ZBETA*PQPFROZ (JL, JK)
          ZQSNOW=(1.0_JPRB-ZBETA)*PQPFROZ (JL, JK)
        ENDIF

        PCHARGE (JL)=PCHARGE (JL)+ZQGRAUP*(MAX (0.0_JPRB, PLU (JL&
        &, JK))+ZQSNOW)*(PAPH (JL, JK)-PAPH (JL, JK-1))*Z1G
      ENDDO

    ENDIF


    IF (YDEPHY%NLIMODE==8) THEN
      ZPREC_CV =MIN ((PFPLCL (JL, KLEV)+PFPLCN (JL, KLEV))*86400.0_JPRB, 90.0_JPRB)
    ENDIF


    IF (YDEPHY%NLIMODE==1) THEN

      IF (PCDEPTH (JL)>1.0_JPRB.AND.(PCTOPH (JL)-PCDEPTH (JL))>0.5_JPRB.AND.PWMFU (JL)>0.0_JPRB) THEN

        IF (LDLAND (JL)) THEN
          PLIGH_TOT (JL)=3.1E-01_JPRB*PICE (JL)*PWMFU (JL)*PCDEPTH (JL)
        ELSE
          PLIGH_TOT (JL)=1.3E-02_JPRB*PICE (JL)*PWMFU (JL)*PCDEPTH (JL)
        ENDIF

      ENDIF

    ELSEIF (YDEPHY%NLIMODE==2) THEN

      IF (PCDEPTH (JL)>1.0_JPRB.AND.(PCTOPH (JL)-PCDEPTH (JL))>0.7_JPRB&
        &.AND.PCTOPH (JL)>5.0_JPRB.AND.PWMFU (JL)>0.05_JPRB) THEN

        IF (LDLAND (JL)) THEN
          PLIGH_TOT (JL)=6.5E-01_JPRB*PICE (JL)*PWMFU (JL)*PCDEPTH (JL)
        ELSE
          PLIGH_TOT (JL)=8.0E-02_JPRB*PICE (JL)*PWMFU (JL)*PCDEPTH (JL)
        ENDIF

      ENDIF

    ELSEIF (YDEPHY%NLIMODE==3) THEN

      IF (PCDEPTH (JL)>1.0_JPRB.AND.(PCTOPH (JL)-PCDEPTH (JL))>0.7_JPRB&
        &.AND.PCTOPH (JL)>5.0_JPRB.AND.PWMFU (JL)>0.05_JPRB) THEN

        IF (LDLAND (JL)) THEN
          PLIGH_TOT (JL)=4.5E-03_JPRB*(PICE (JL)*PCDEPTH (JL))**2.0_JPRB*PWMFU (JL)**0.5_JPRB
        ELSE
          PLIGH_TOT (JL)=6.6E-04_JPRB*(PICE (JL)*PCDEPTH (JL))**2.0_JPRB*PWMFU (JL)**0.5_JPRB
        ENDIF

      ENDIF

    ELSEIF (YDEPHY%NLIMODE==4) THEN

      IF (PCTOPH (JL)>5.0_JPRB.AND.IFREEZ25>0) THEN

        IF (LDLAND (JL)) THEN
          PLIGH_TOT (JL)=5.0_JPRB*4.0E6_JPRB*PFPLCL (JL, KLEV)*1.0E-9_JPRB*YDCST%RDAYI
        ELSE
          PLIGH_TOT (JL)=0.1_JPRB*(5.0_JPRB*4.0E6_JPRB*PFPLCL (JL, KLEV)*1.0E-9_JPRB*YDCST%RDAYI)
        ENDIF

      ENDIF

    ELSEIF (YDEPHY%NLIMODE==5) THEN

      IF (IFREEZ>0) THEN

        IF (LDLAND (JL)) THEN
          PLIGH_TOT (JL)=3.44E-5_JPRB*PCTOPH (JL)**4.9_JPRB*(24.0_JPRB*60.0_JPRB/ZAREA )
        ELSE
          PLIGH_TOT (JL)=6.4E-4_JPRB*PCTOPH (JL)**1.73_JPRB*(24.0_JPRB*60.0_JPRB/ZAREA )
        ENDIF

      ENDIF

    ELSEIF (YDEPHY%NLIMODE==6) THEN

      IF (ZCDEPTH >4.0_JPRB.AND.PCAPE (JL)>175._JPRB.AND.ZCBASEH >0.1_JPRB&
        &.AND.KCTOP (JL)<IFREEZ15.AND.PCDEPTH (JL)>1.0_JPRB) THEN
        PLIGH_TOT (JL)=36.0_JPRB*MIN (1.0_JPRB,(SQRT (ZAREA )/30.0_JPRB)**0.15_JPRB&
        &)*PCHARGE (JL)*SQRT (PCAPE (JL))*MIN (ZCBASEH , ZHBMAX)**2
      ENDIF

    ELSEIF (YDEPHY%NLIMODE==7) THEN

      IF (PWMFU (JL)>0.0_JPRB) THEN
        PLIGH_TOT (JL)=1.54E-5_JPRB*(PWMFU (JL)*SQRT (PCTOPH &
        &(JL)*1000.0_JPRB))**4.9_JPRB*(1440.0_JPRB/ZAREA )
      ENDIF

    ELSEIF (YDEPHY%NLIMODE==8) THEN

      IF (ZPREC_CV >7.0_JPRB) THEN

        IF (LDLAND (JL)) THEN
          PLIGH_CTG (JL)=3.75E-2_JPRB-4.76E-2_JPRB*ZPREC_CV +5.41E-3_JPRB*ZPREC_CV&
          & **2+3.21E-4_JPRB*ZPREC_CV **3-2.93E-6_JPRB*ZPREC_CV **4
        ELSE
          PLIGH_CTG (JL)=5.23E-2_JPRB-4.80E-2_JPRB*ZPREC_CV +5.45E-3_JPRB*ZPREC_CV&
          & **2+3.68E-5_JPRB*ZPREC_CV **3-2.42E-7_JPRB*ZPREC_CV **4
        ENDIF

        PLIGH_CTG (JL)=MAX (PLIGH_CTG (JL), 0.0_JPRB)
        PLIGH_CTG (JL)=PLIGH_CTG (JL)*(1440.0_JPRB/ZAREA_REF)
        ZCOLDDPT=MAX (PCDEPTH (JL), 5.5_JPRB)

        IF (ZCOLDDPT<14.0_JPRB) THEN
          ZPCTG=1.0_JPRB/(0.021_JPRB*(ZCOLDDPT**4)-0.648_JPRB*(ZCOLDDPT*&
          &*3)+7.49_JPRB*(ZCOLDDPT**2)-36.54_JPRB*ZCOLDDPT+64.09_JPRB)
          ZPCTG=MAX (ZPCTG, 0.0_JPRB)
        ELSE
          ZPCTG=0.02_JPRB
        ENDIF

        PLIGH_TOT (JL)=PLIGH_CTG (JL)/ZPCTG
      ENDIF

    ENDIF


    IF (YDEPHY%NLIMODE/=8) THEN

      IF (PCDEPTH (JL)>5.5_JPRB.AND.PCDEPTH (JL)<14.0_JPRB) THEN
        ZPCTG=1.0_JPRB/(0.021_JPRB*(PCDEPTH (JL)**4.0_JPRB)-0.648_JPRB*(PCDEPTH (JL)**3.0_JPRB&
        &)+7.49_JPRB*(PCDEPTH (JL)**2.0_JPRB)-36.54_JPRB*PCDEPTH (JL)+64.09_JPRB)
        PLIGH_CTG (JL)=ZPCTG*PLIGH_TOT (JL)
      ELSE
        PLIGH_CTG (JL)=PLIGH_TOT (JL)
      ENDIF

    ENDIF

  ENDIF

ENDIF




END SUBROUTINE CULIGHT_OPENACC
