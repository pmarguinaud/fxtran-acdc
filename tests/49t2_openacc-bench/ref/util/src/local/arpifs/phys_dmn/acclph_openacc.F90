
SUBROUTINE ACCLPH_OPENACC (YDCST, YDPHY0, YDPHY2, KIDIA, KFDIA, KLON, KTDIA, KLEV, PTHETAV&
&, PAPHI, PAPHIF, PU, PV, PTHETAVS, KCLPH, PCLPH, PVEIN, PUGST, PVGST, YDSTACK)
!$ACC ROUTINE (ACCLPH_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMPHY0,ONLY:TPHY0
USE YOMPHY2,ONLY:TPHY2
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY0), INTENT (IN)::YDPHY0
TYPE (TPHY2), INTENT (IN)::YDPHY2
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
REAL (KIND=JPRB), INTENT (IN)::PTHETAV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTHETAVS (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCLPH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCLPH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVEIN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PUGST (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVGST (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZTHETAVS, (KLON, KLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZV, (KLON, KLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZU, (KLON, KLEV+1))
REAL (KIND=JPRB)::ZLCH_PREV 
fxtran_acdc_temp (REAL (KIND=JPRB), ZPHI, (KLON, KLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTHETAV, (KLON, KLEV+1))
REAL (KIND=JPRB)::ZX_PREV 
REAL (KIND=JPRB)::ZINT 
REAL (KIND=JPRB)::ZCLPV 
REAL (KIND=JPRB)::ZCLPU 
REAL (KIND=JPRB)::ZVITM 
INTEGER (KIND=JPIM)::INDI
INTEGER (KIND=JPIM)::IC 
INTEGER (KIND=JPIM)::IBIN
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::ZLOG2
REAL (KIND=JPRB)::ZVAL_LCH
REAL (KIND=JPRB)::ZLCH
REAL (KIND=JPRB)::ZBIN
REAL (KIND=JPRB)::ZARG2
REAL (KIND=JPRB)::ZARG1
REAL (KIND=JPRB)::ZDELTA
REAL (KIND=JPRB)::ZBIG
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZPSI
REAL (KIND=JPRB)::ZX
REAL (KIND=JPRB)::ZPBLHK1


YLSTACK = YDSTACK



IF (KIND (ZTHETAVS) == 8) THEN
    fxtran_acdc_alloc8 (ZTHETAVS)
ELSEIF (KIND (ZTHETAVS) == 4) THEN
    fxtran_acdc_alloc4 (ZTHETAVS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZV) == 8) THEN
    fxtran_acdc_alloc8 (ZV)
ELSEIF (KIND (ZV) == 4) THEN
    fxtran_acdc_alloc4 (ZV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZU) == 8) THEN
    fxtran_acdc_alloc8 (ZU)
ELSEIF (KIND (ZU) == 4) THEN
    fxtran_acdc_alloc4 (ZU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPHI) == 8) THEN
    fxtran_acdc_alloc8 (ZPHI)
ELSEIF (KIND (ZPHI) == 4) THEN
    fxtran_acdc_alloc4 (ZPHI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHETAV) == 8) THEN
    fxtran_acdc_alloc8 (ZTHETAV)
ELSEIF (KIND (ZTHETAV) == 4) THEN
    fxtran_acdc_alloc4 (ZTHETAV)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZPBLHK1=YDPHY0%GPBLHK0/YDPHY0%GPBLHRA
ZEPS=0.001_JPRB
ZBIG=30._JPRB
ZLOG2=LOG (2.0_JPRB)
ZARG1=-YDPHY0%GPBLHK0/ZPBLHK1
ZVAL_LCH=MAX (LOG (COSH (MIN (ABS (ZARG1), ZBIG))), ABS (ZARG1)-ZLOG2)

PCLPH (JLON)=0.0_JPRB
PVEIN (JLON)=0.0_JPRB
ZCLPU =0.0_JPRB
ZCLPV =0.0_JPRB
ZVITM =SQRT (PU (JLON, KLEV)**2+PV (JLON, KLEV)**2)
KCLPH (JLON)=KLEV
ZINT =0.0_JPRB
ZX_PREV =0.0_JPRB
ZLCH_PREV =ZVAL_LCH
ZTHETAV (JLON, KLEV+1)=MAX (PTHETAVS (JLON), PTHETAV (JLON, KLEV))
ZTHETAVS (JLON, KLEV+1)=ZTHETAV (JLON, KLEV+1)
ZPHI (JLON, KLEV+1)=PAPHI (JLON, KLEV)
ZU (JLON, KLEV+1)=0.0_JPRB
ZV (JLON, KLEV+1)=0.0_JPRB


DO JLEV=KTDIA, KLEV
  
  ZTHETAV (JLON, JLEV)=PTHETAV (JLON, JLEV)
  ZPHI (JLON, JLEV)=PAPHIF (JLON, JLEV)
  ZU (JLON, JLEV)=PU (JLON, JLEV)
  ZV (JLON, JLEV)=PV (JLON, JLEV)
  
ENDDO


DO JLEV=KLEV, KTDIA,-1
  
  ZTHETAVS (JLON, JLEV)=ZTHETAVS (JLON, JLEV+1)+ZTHETAV (JLON, JLEV)-ZTHETAV (JLON, JLEV+1)-0&
  &.5_JPRB*(ZTHETAV (JLON, JLEV)+ZTHETAV (JLON, JLEV+1))*((ZU (JLON, JLEV)-ZU (JLON, JLEV+1)&
  &)**2+(ZV (JLON, JLEV)-ZV (JLON, JLEV+1))**2)/(ZPHI (JLON, JLEV)-ZPHI (JLON, JLEV+1))
  
ENDDO


DO JLEV=KLEV, KTDIA,-1
  
  ZINT =ZINT +(ZPHI (JLON, JLEV)-ZPHI (JLON, JLEV+1))*0.5_JPRB&
  &*(ZTHETAVS (JLON, JLEV)+ZTHETAVS (JLON, JLEV+1))
  ZX=ZTHETAVS (JLON, JLEV)-ZINT /(ZPHI (JLON, JLEV)-ZPHI (JLON, KLEV+1))
  ZDELTA=ZX-ZX_PREV 
  ZBIN=MAX (0.0_JPRB, SIGN (1.0_JPRB, ABS (ZDELTA)-ZEPS))
  ZDELTA=ZBIN*ZDELTA+(1.0_JPRB-ZBIN)*ZEPS*SIGN (1.0_JPRB, ZDELTA)
  ZX=ZX_PREV +ZDELTA
  ZARG2=(ZX-YDPHY0%GPBLHK0)/ZPBLHK1
  ZLCH=MAX (LOG (COSH (MIN (ABS (ZARG2), ZBIG))), ABS (ZARG2)-ZLOG2)
  ZPSI=0.5_JPRB*(1.0_JPRB-ZPBLHK1/ZDELTA*(ZLCH-ZLCH_PREV ))
  PCLPH (JLON)=PCLPH (JLON)+(ZPHI (JLON, JLEV)-ZPHI (JLON, JLEV+1))*ZPSI
  ZX_PREV =ZX
  ZLCH_PREV =ZLCH
  
ENDDO


PCLPH (JLON)=MAX (PCLPH (JLON), PAPHIF (JLON, KLEV)-PAPHI (JLON, KLEV))


DO JLEV=KLEV, KTDIA,-1
  
  ZPSI=MAX (0.0_JPRB, MIN (1.0_JPRB,(PCLPH (JLON)+PAPHI (JLON, KLEV)&
  &-ZPHI (JLON, JLEV+1))/(ZPHI (JLON, JLEV)-ZPHI (JLON, JLEV+1))))
  ZCLPU =ZPSI*PU (JLON, JLEV)+(1.0_JPRB-ZPSI)*ZCLPU 
  ZCLPV =ZPSI*PV (JLON, JLEV)+(1.0_JPRB-ZPSI)*ZCLPV 
  IBIN=NINT (ZPSI)
  KCLPH (JLON)=IBIN*JLEV+(1-IBIN)*KCLPH (JLON)
  
ENDDO

IC =1

DO JLEV=KLEV-1, KTDIA,-1
  
  INDI=INT (MAX (0.0_JPRB, SIGN (1.0_JPRB, PCLPH (JLON)+PAPHI (JLON, KLEV)-ZPHI (JLON, JLEV+1))))
  ZVITM =ZVITM +INDI*SQRT (PU (JLON, JLEV)**2+PV (JLON, JLEV)**2)
  IC =IC +INDI
  
ENDDO


PVEIN (JLON)=PCLPH (JLON)*(ZVITM /FLOAT (IC ))/YDCST%RG


IF (.NOT.YDPHY2%LRAFTUR) THEN
  PUGST (JLON)=ZCLPU 
  PVGST (JLON)=ZCLPV 
ENDIF


PCLPH (JLON)=PCLPH (JLON)/YDCST%RG



END SUBROUTINE ACCLPH_OPENACC
