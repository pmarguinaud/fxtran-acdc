SUBROUTINE CUCTRACER_OPENACC (YDCST, YDCUMFS, YDECUMF2, YDECUMF, KIDIA, KFDIA, KLON&
&, KLEV, KTRAC, KCTOP, KDTOP, KTYPE, LDCUM, LDDRAF, PTSPHY, PAPH, PAP, PMFU, PMFD,&
& PMFUO, PMFDO, PUDRATE, PDDRATE, PDMFUP, PDMFDP, PCEN, PTENC, PSCAV, YDSTACK)
!$ACC ROUTINE (CUCTRACER_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOECUMF,ONLY:TECUMF
USE YOECUMF2,ONLY:TECUMF2
USE YOMCUMFS,ONLY:TCUMFS
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TCUMFS), INTENT (IN)::YDCUMFS
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TECUMF2), INTENT (IN)::YDECUMF2
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KDTOP (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE (KLON)
LOGICAL, INTENT (IN)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDDRAF (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFUO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFDO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUDRATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDDRATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDMFUP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDMFDP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCEN (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (KLON, KLEV, KTRAC)
INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IM
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZADVW 
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZTSPHY
REAL (KIND=JPRB)::ZPOSI
REAL (KIND=JPRB)::ZERATE
REAL (KIND=JPRB)::ZIMP
REAL (KIND=JPRB)::ZMFA
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZRMFSOLCT
REAL (KIND=JPRB)::ZRMFCMIN
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFC, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTENC, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCD, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCU, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCEN, (KLON, KLEV, KTRAC))
fxtran_acdc_temp (REAL (KIND=JPRB), ZR1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDP, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLCUMBAS, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLCUMASK, (KLON, KLEV))

#include "cubidiag.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZMFC) == 8) THEN
    fxtran_acdc_alloc8 (ZMFC)
ELSEIF (KIND (ZMFC) == 4) THEN
    fxtran_acdc_alloc4 (ZMFC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTENC) == 8) THEN
    fxtran_acdc_alloc8 (ZTENC)
ELSEIF (KIND (ZTENC) == 4) THEN
    fxtran_acdc_alloc4 (ZTENC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCD) == 8) THEN
    fxtran_acdc_alloc8 (ZCD)
ELSEIF (KIND (ZCD) == 4) THEN
    fxtran_acdc_alloc4 (ZCD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCU) == 8) THEN
    fxtran_acdc_alloc8 (ZCU)
ELSEIF (KIND (ZCU) == 4) THEN
    fxtran_acdc_alloc4 (ZCU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCEN) == 8) THEN
    fxtran_acdc_alloc8 (ZCEN)
ELSEIF (KIND (ZCEN) == 4) THEN
    fxtran_acdc_alloc4 (ZCEN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR1) == 8) THEN
    fxtran_acdc_alloc8 (ZR1)
ELSEIF (KIND (ZR1) == 4) THEN
    fxtran_acdc_alloc4 (ZR1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB) == 8) THEN
    fxtran_acdc_alloc8 (ZB)
ELSEIF (KIND (ZB) == 4) THEN
    fxtran_acdc_alloc4 (ZB)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDP) == 8) THEN
    fxtran_acdc_alloc8 (ZDP)
ELSEIF (KIND (ZDP) == 4) THEN
    fxtran_acdc_alloc4 (ZDP)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMBAS) == 8) THEN
    fxtran_acdc_alloc8 (LLCUMBAS)
ELSEIF (KIND (LLCUMBAS) == 4) THEN
    fxtran_acdc_alloc4 (LLCUMBAS)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMASK) == 8) THEN
    fxtran_acdc_alloc8 (LLCUMASK)
ELSEIF (KIND (LLCUMASK) == 4) THEN
    fxtran_acdc_alloc4 (LLCUMASK)
ELSE
    STOP 1
ENDIF


JL = KIDIA





IF (YDCUMFS%LECUMFS) THEN
  ZRMFSOLCT=YDECUMF2%RMFSOLCT2
  ZRMFCMIN=YDECUMF2%RMFCMIN2
ELSE
  ZRMFSOLCT=YDECUMF%RMFSOLCT
  ZRMFCMIN=YDECUMF%RMFCMIN
ENDIF

ZIMP=1.0_JPRB-ZRMFSOLCT
ZTSPHY=1.0_JPRB/PTSPHY

ZADVW =0.0_JPRB

IF (KTYPE (JL)==1)  THEN
  ZADVW =YDECUMF%RMFADVW
ENDIF



DO JK=2, KLEV
  
  LLCUMASK (JL, JK)=.FALSE.

  IF (LDCUM (JL)) THEN
    ZDP (JL, JK)=YDCST%RG/(PAPH (JL, JK+1)-PAPH (JL, JK))

    IF (JK>=KCTOP (JL)-1) THEN
      LLCUMASK (JL, JK)=.TRUE.
    ENDIF

  ENDIF

  
ENDDO


DO JN=1, KTRAC

  DO JK=2, KLEV
    IK=JK-1
    
    ZCEN (JL, JK, JN)=PCEN (JL, JK, JN)
    ZCD (JL, JK, JN)=PCEN (JL, IK, JN)
    ZCU (JL, JK, JN)=PCEN (JL, IK, JN)
    ZMFC (JL, JK, JN)=0.0_JPRB
    ZTENC (JL, JK, JN)=0.0_JPRB
  
  ENDDO

  
  ZCU (JL, KLEV, JN)=PCEN (JL, KLEV, JN)

  

  DO JK=KLEV-1, 3,-1
    IK=JK+1

    

    IF (LLCUMASK (JL, JK)) THEN
      ZERATE=PMFU (JL, JK)-PMFU (JL, IK)+PUDRATE (JL, JK)
      ZMFA=1.0_JPRB/MAX (ZRMFCMIN, PMFU (JL, JK))

      IF (JK>=KCTOP (JL)) THEN
        ZCU (JL, JK, JN)=(PMFU (JL, IK)*ZCU (JL, IK, JN)+ZERATE*PCEN (JL, JK, JN)&
        &-(PUDRATE (JL, JK)+PDMFUP (JL, JK)*PSCAV (JN))*ZCU (JL, IK, JN))*ZMFA
      ENDIF

    ENDIF

  
  ENDDO


  DO JK=3, KLEV
    IK=JK-1

    

    IF (LDDRAF (JL).AND.JK==KDTOP (JL)) THEN
      ZCD (JL, JK, JN)=0.1_JPRB*ZCU (JL, JK, JN)+0.9_JPRB*PCEN (JL, IK, JN)
    ELSEIF (LDDRAF (JL).AND.JK>KDTOP (JL)) THEN
      ZERATE=-PMFD (JL, JK)+PMFD (JL, IK)+PDDRATE (JL, JK)
      ZMFA=1._JPRB/MIN (-ZRMFCMIN, PMFD (JL, JK))
      ZCD (JL, JK, JN)=(PMFD (JL, IK)*ZCD (JL, IK, JN)-ZERATE*PCEN (JL, IK, JN)&
      &+(PDDRATE (JL, JK)+PDMFDP (JL, JK)*PSCAV (JN))*ZCD (JL, IK, JN))*ZMFA
    ENDIF

  
  ENDDO

  JK=KLEV
  IK=JK-1

  

  IF (LDDRAF (JL)) THEN
    ZPOSI=-ZDP (JL, JK)*(PMFU (JL, JK)*ZCU (JL, JK, JN)+PMFD (JL, JK)*ZCD&
    & (JL, JK, JN)-(PMFU (JL, JK)+PMFD (JL, JK))*PCEN (JL, IK, JN))

    IF (PCEN (JL, JK, JN)+ZPOSI*PTSPHY<0.0_JPRB) THEN
      ZMFA=1._JPRB/MIN (-ZRMFCMIN, PMFD (JL, JK))
      ZCD (JL, JK, JN)=((PMFU (JL, JK)+PMFD (JL, JK))*PCEN (JL, IK, JN)-PMFU (JL&
      &, JK)*ZCU (JL, JK, JN)+PCEN (JL, JK, JN)/(PTSPHY*ZDP (JL, JK)))*ZMFA
    ENDIF

  ENDIF

  
ENDDO


DO JN=1, KTRAC

  DO JK=2, KLEV
    IK=JK-1

    

    IF (LLCUMASK (JL, JK)) THEN
      ZMFA=PMFU (JL, JK)+PMFD (JL, JK)
      ZMFC (JL, JK, JN)=PMFU (JL, JK)*ZCU (JL, JK, JN)+PMFD (JL&
      &, JK)*ZCD (JL, JK, JN)-ZIMP*ZMFA*ZCEN (JL, IK, JN)
    ENDIF

  
  ENDDO


  DO JK=2, KLEV-1
    IK=JK+1

    

    IF (LLCUMASK (JL, JK)) THEN
      ZTENC (JL, JK, JN)=ZDP (JL, JK)*(ZMFC (JL, IK, JN)-ZMFC (JL, JK, JN))
    ENDIF

  
  ENDDO

  JK=KLEV

  

  IF (LDCUM (JL)) THEN
    ZTENC (JL, JK, JN)=-ZDP (JL, JK)*ZMFC (JL, JK, JN)
  ENDIF

  
ENDDO


IF (ZRMFSOLCT==0.0_JPRB) THEN

  DO JN=1, KTRAC

    DO JK=2, KLEV

      

      IF (LLCUMASK (JL, JK)) THEN
        PTENC (JL, JK, JN)=PTENC (JL, JK, JN)+ZTENC (JL, JK, JN)
      ENDIF

    
    ENDDO

  ENDDO

ELSE
  LLCUMBAS (JL,:)=.FALSE.
  ZB (JL,:)=1._JPRB

  DO JN=1, KTRAC

    DO JK=2, KLEV
      IK=JK+1
      IM=JK-1
      
      LLCUMBAS (JL, JK)=LLCUMASK (JL, JK)

      IF (LLCUMBAS (JL, JK)) THEN
        ZZP=ZRMFSOLCT*ZDP (JL, JK)*PTSPHY
        ZMFC (JL, JK, JN)=-ZZP*(PMFU (JL, JK)+PMFD (JL, JK))

        IF (JK<KLEV) THEN
          ZB (JL, JK)=1.0_JPRB+ZZP*(PMFU (JL, IK)+PMFD (JL, IK))
        ELSE
          ZB (JL, JK)=1.0_JPRB
        ENDIF

        ZZP=YDCST%RG*(PMFUO (JL, JK)+YDECUMF%RMFADVWDD*PMFDO (JL&
        &, JK))/(PAP (JL, JK)-PAP (JL, IM))*PTSPHY*ZADVW 
        ZC=ZZP*(PCEN (JL, IM, JN)-PCEN (JL, JK, JN))
        ZTENC (JL, JK, JN)=ZTENC (JL, JK, JN)*PTSPHY+PCEN (JL, JK, JN)-ZC
      ENDIF

    
    ENDDO

    CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP, LLCUMBAS&
    &, ZMFC (:,:, JN), ZB, ZTENC (:,:, JN), ZR1, YDSTACK=YLSTACK)

    DO JK=2, KLEV

      

      IF (LLCUMBAS (JL, JK)) THEN
        PTENC (JL, JK, JN)=PTENC (JL, JK, JN)+(ZR1 (JL, JK)-PCEN (JL, JK, JN))*ZTSPHY
      ENDIF

    
    ENDDO

  ENDDO

ENDIF



END SUBROUTINE CUCTRACER_OPENACC
