
SUBROUTINE SHALLOW_MF_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KRR, KRRL, KRRI, KSV, ONOMIXLG&
&, KSV_LGBEG, KSV_LGEND, PTSTEP, PDZZ, PZZ, PRHODJ, PRHODREF, PPABSM, PEXNM, PSFTH, PSFRV, PTHM&
&, PRM, PUM, PVM, PTKEM, PSVM, PDUDT_MF, PDVDT_MF, PDTHLDT_MF, PDRTDT_MF, PDSVDT_MF, PSIGMF,&
& PRC_MF, PRI_MF, PCF_MF, PFLXZTHVMF, PFLXZTHMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, PTHL_UP, PRT_UP&
&, PRV_UP, PRC_UP, PRI_UP, PU_UP, PV_UP, PTHV_UP, PW_UP, PFRAC_UP, PEMF, PDETR, PENTR, KKLCL&
&, KKETL, KKCTL, PDX, PDY, PRSVS, PSVMIN, BUCONF, TBUDGETS, KBUDGETS, YDSTACK)
!$ACC ROUTINE (SHALLOW_MF_OPENACC) SEQ
USE MODE_SHUMAN_PHY,ONLY:MXM_PHY, MYM_PHY

USE MODD_BUDGET,ONLY:TBUDGETCONF_T, TBUDGETDATA, NBUDGET_U&
&, NBUDGET_V, NBUDGET_TH, NBUDGET_RV, NBUDGET_SV1
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_NEB_N,ONLY:NEB_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODD_TURB_N,ONLY:TURB_T
USE MODD_CTURB,ONLY:CSTURB_T
USE MODD_PARAMETERS,ONLY:JPSVMAX
USE MODE_BUDGET_PHY,ONLY:BUDGET_STORE_ADD_PHY
USE MODE_COMPUTE_MF_CLOUD,ONLY:COMPUTE_MF_CLOUD
USE MODE_COMPUTE_MF_CLOUD_OPENACC,ONLY:COMPUTE_MF_CLOUD_OPENACC
USE MODE_COMPUTE_UPDRAFT,ONLY:COMPUTE_UPDRAFT
USE MODE_COMPUTE_UPDRAFT_OPENACC,ONLY:COMPUTE_UPDRAFT_OPENACC
USE MODE_COMPUTE_UPDRAFT_RAHA,ONLY:COMPUTE_UPDRAFT_RAHA
USE MODE_COMPUTE_UPDRAFT_RAHA_OPENACC,ONLY:COMPUTE_UPDRAFT_RAHA_OPENACC
USE MODE_COMPUTE_UPDRAFT_RHCJ10,ONLY:COMPUTE_UPDRAFT_RHCJ10
USE MODE_COMPUTE_UPDRAFT_RHCJ10_OPENACC,ONLY:COMPUTE_UPDRAFT_RHCJ10_OPENACC
USE MODE_MF_TURB,ONLY:MF_TURB
USE MODE_MF_TURB_OPENACC,ONLY:MF_TURB_OPENACC
USE MODE_MF_TURB_EXPL,ONLY:MF_TURB_EXPL
USE MODE_MF_TURB_EXPL_OPENACC,ONLY:MF_TURB_EXPL_OPENACC
USE MODE_MSG,ONLY:PRINT_MSG, NVERB_FATAL
USE MODE_THL_RT_FROM_TH_R_MF,ONLY:THL_RT_FROM_TH_R_MF
USE MODE_THL_RT_FROM_TH_R_MF_OPENACC,ONLY:THL_RT_FROM_TH_R_MF_OPENACC
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (NEB_T), INTENT (IN)::NEBN
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
TYPE (TURB_T), INTENT (IN)::TURBN
TYPE (CSTURB_T), INTENT (IN)::CSTURB
INTEGER, INTENT (IN)::KRR
INTEGER, INTENT (IN)::KRRL
INTEGER, INTENT (IN)::KRRI
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PTSTEP
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PPABSM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEXNM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSFRV(D%NIJT)
REAL, INTENT (IN)::PSFTH(D%NIJT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRM(D%NIJT, D%NKT, KRR)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PDUDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDVDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDTHLDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDRTDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDSVDT_MF(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PCF_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRI_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRC_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSIGMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZRMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZUMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZVMF(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRI_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PW_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDETR(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PENTR(D%NIJT, D%NKT)
INTEGER, INTENT (OUT)::KKCTL(D%NIJT)
INTEGER, INTENT (OUT)::KKETL(D%NIJT)
INTEGER, INTENT (OUT)::KKLCL(D%NIJT)
REAL, INTENT (IN)::PDY
REAL, INTENT (IN)::PDX
REAL, INTENT (IN), OPTIONAL::PRSVS(D%NIJT, D%NKT, KSV)
REAL, INTENT (IN), OPTIONAL::PSVMIN(JPSVMAX)
TYPE (TBUDGETCONF_T), INTENT (IN), OPTIONAL::BUCONF
TYPE (TBUDGETDATA), INTENT (INOUT), OPTIONAL::TBUDGETS(KBUDGETS)
INTEGER, INTENT (IN)::KBUDGETS
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL, ZBUO_INTEG, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZEMF_O_RHODREF, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZWORK2, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZWORK, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHVM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRTM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHLM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZFRAC_ICE, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZWK, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZFLXZSVMF, (D%NIJT, D%NKT, KSV))
fxtran_acdc_temp (REAL, ZSV_UP, (D%NIJT, D%NKT, KSV))
fxtran_acdc_temp (REAL, ZDEPTH, (D%NIJT))
fxtran_acdc_temp (REAL, ZFRAC_ICE_UP, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRSAT_UP, (D%NIJT, D%NKT))
LOGICAL::GENTR_DETR
fxtran_acdc_temp (INTEGER, IERR, (D%NIJT, D%NKT))
INTEGER::JSV
INTEGER::JK
INTEGER::JI
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT


YLSTACK = YDSTACK



IF (KIND (ZBUO_INTEG) == 8) THEN
    fxtran_acdc_alloc8 (ZBUO_INTEG)
ELSEIF (KIND (ZBUO_INTEG) == 4) THEN
    fxtran_acdc_alloc4 (ZBUO_INTEG)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEMF_O_RHODREF) == 8) THEN
    fxtran_acdc_alloc8 (ZEMF_O_RHODREF)
ELSEIF (KIND (ZEMF_O_RHODREF) == 4) THEN
    fxtran_acdc_alloc4 (ZEMF_O_RHODREF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK2) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK2)
ELSEIF (KIND (ZWORK2) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWORK) == 8) THEN
    fxtran_acdc_alloc8 (ZWORK)
ELSEIF (KIND (ZWORK) == 4) THEN
    fxtran_acdc_alloc4 (ZWORK)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHVM) == 8) THEN
    fxtran_acdc_alloc8 (ZTHVM)
ELSEIF (KIND (ZTHVM) == 4) THEN
    fxtran_acdc_alloc4 (ZTHVM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRTM) == 8) THEN
    fxtran_acdc_alloc8 (ZRTM)
ELSEIF (KIND (ZRTM) == 4) THEN
    fxtran_acdc_alloc4 (ZRTM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHLM) == 8) THEN
    fxtran_acdc_alloc8 (ZTHLM)
ELSEIF (KIND (ZTHLM) == 4) THEN
    fxtran_acdc_alloc4 (ZTHLM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRAC_ICE) == 8) THEN
    fxtran_acdc_alloc8 (ZFRAC_ICE)
ELSEIF (KIND (ZFRAC_ICE) == 4) THEN
    fxtran_acdc_alloc4 (ZFRAC_ICE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZWK) == 8) THEN
    fxtran_acdc_alloc8 (ZWK)
ELSEIF (KIND (ZWK) == 4) THEN
    fxtran_acdc_alloc4 (ZWK)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLXZSVMF) == 8) THEN
    fxtran_acdc_alloc8 (ZFLXZSVMF)
ELSEIF (KIND (ZFLXZSVMF) == 4) THEN
    fxtran_acdc_alloc4 (ZFLXZSVMF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZSV_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZSV_UP)
ELSEIF (KIND (ZSV_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZSV_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEPTH) == 8) THEN
    fxtran_acdc_alloc8 (ZDEPTH)
ELSEIF (KIND (ZDEPTH) == 4) THEN
    fxtran_acdc_alloc4 (ZDEPTH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRAC_ICE_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZFRAC_ICE_UP)
ELSEIF (KIND (ZFRAC_ICE_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZFRAC_ICE_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRSAT_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZRSAT_UP)
ELSEIF (KIND (ZRSAT_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZRSAT_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (IERR) == 8) THEN
    fxtran_acdc_alloc8 (IERR)
ELSEIF (KIND (IERR) == 4) THEN
    fxtran_acdc_alloc4 (IERR)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT

IF (PARAMMF%CMF_UPDRAFT=='EDKF'.OR.PARAMMF%CMF_UPDRAFT=='RHCJ') THEN
  PENTR(JI,:)=1.E20
  PDETR(JI,:)=1.E20
  PEMF(JI,:)=1.E20
  ZBUO_INTEG(JI,:)=1.E20
ENDIF

ZFRAC_ICE (JI,:)=0.

IF (KRR.GE.4) THEN

  DO JK=1, IKT

    

    IF (PRM (JI, JK, 2)+PRM (JI, JK, 4)>1.E-20) THEN
      ZFRAC_ICE (JI, JK)=PRM (JI, JK, 4)/(PRM (JI, JK, 2)+PRM (JI, JK, 4))
    ENDIF

  
  ENDDO

ENDIF


DO JK=1, IKT
  
  ZWK (JI, JK)=PTHM (JI, JK)*PEXNM (JI, JK)
  
ENDDO


DO JK = 1, D%NKT
  
  
  
  IERR (JI,JK)=0

  

  SELECTCASE (NEBN%CFRAC_ICE_SHALLOW_MF)
  CASE ('T')
    ZFRAC_ICE (JI,JK)=MAX (0., MIN (1.,((NEBN%XTMAXMIX-ZWK (JI,JK))/(NEBN%XTMAXMIX-NEBN%XTMINMIX))))
  CASE ('O')
    ZFRAC_ICE (JI,JK)=MAX (0., MIN (1.,((CST%XTT-ZWK (JI,JK))/40.)))
  CASE ('N')
    ZFRAC_ICE (JI,JK)=0.
  CASE ('S')
    ZFRAC_ICE (JI,JK)=MAX (0., MIN (1., ZFRAC_ICE (JI,JK)))
  CASE DEFAULT
    
    IERR (JI,JK)=1
  
  ENDSELECT

  
  
  
ENDDO

CALL THL_RT_FROM_TH_R_MF_OPENACC (D, CST, KRR, KRRL, KRRI&
&, PTHM, PRM, PEXNM, ZTHLM, ZRTM, YDSTACK=YLSTACK)

DO JK=1, IKT
  
  ZTHVM (JI, JK)=PTHM (JI, JK)*((1.+CST%XRV/CST%XRD*PRM (JI, JK, 1))/(1.+ZRTM (JI, JK)))
  
ENDDO


IF (PARAMMF%CMF_UPDRAFT=='EDKF') THEN
  GENTR_DETR=.TRUE.
  CALL COMPUTE_UPDRAFT_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KSV, GENTR_DETR, ONOMIXLG&
  &, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM, PTKEM, PTHM&
  &, PRM (:,:, 1), ZTHLM, ZRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP, PTHV_UP,&
  & PW_UP, PU_UP, PV_UP, ZSV_UP, PFRAC_UP, ZFRAC_ICE_UP, ZRSAT_UP, PEMF, PDETR, PENTR, ZBUO_INTEG&
  &, KKLCL, KKETL, KKCTL, ZDEPTH, PDX, PDY, YDSTACK=YLSTACK)
ELSEIF (PARAMMF%CMF_UPDRAFT=='RHCJ') THEN
  GENTR_DETR=.TRUE.
  CALL COMPUTE_UPDRAFT_RHCJ10_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KSV, GENTR_DETR&
  &, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM&
  &, PTKEM, PTHM, PRM (:,:, 1), ZTHLM, ZRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP&
  &, PTHV_UP, PW_UP, PU_UP, PV_UP, ZSV_UP, PFRAC_UP, ZFRAC_ICE_UP, ZRSAT_UP, PEMF, PDETR&
  &, PENTR, ZBUO_INTEG, KKLCL, KKETL, KKCTL, ZDEPTH, YDSTACK=YLSTACK)
ELSEIF (PARAMMF%CMF_UPDRAFT=='RAHA') THEN
  CALL COMPUTE_UPDRAFT_RAHA_OPENACC (D, CST, NEBN, PARAMMF, KSV, GENTR_DETR, ONOMIXLG&
  &, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM, PTKEM&
  &, PEXNM, PTHM, PRM (:,:, 1), ZTHLM, ZRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP&
  &, PTHV_UP, PW_UP, PU_UP, PV_UP, ZSV_UP, PFRAC_UP, ZFRAC_ICE_UP, ZRSAT_UP, PEMF, PDETR&
  &, PENTR, ZBUO_INTEG, KKLCL, KKETL, KKCTL, ZDEPTH, YDSTACK=YLSTACK)
ELSEIF (PARAMMF%CMF_UPDRAFT=='DUAL') THEN
ELSE
  CALL FXTRAN_ACDC_ABORT ('no updraft model for EDKF: CMF_UPDRAFT='//PARAMMF%CMF_UPDRAFT)
ENDIF

CALL COMPUTE_MF_CLOUD_OPENACC (D, CST, TURBN, PARAMMF, NEBN%LSTATNW, KRR, KRRL,&
& KRRI, ZFRAC_ICE, PRC_UP, PRI_UP, PEMF, PTHL_UP, PRT_UP, PFRAC_UP, PTHV_UP, ZFRAC_ICE_UP&
&, ZRSAT_UP, PEXNM, ZTHLM, ZRTM, PTHM, ZTHVM, PRM, PDZZ, PZZ, KKLCL, PPABSM, PRHODREF&
&, PRC_MF, PRI_MF, PCF_MF, PSIGMF, ZDEPTH, YDSTACK=YLSTACK)

DO JK=1, IKT
  
  ZEMF_O_RHODREF (JI, JK)=PEMF (JI, JK)/PRHODREF (JI, JK)
  
ENDDO


IF (PARAMMF%XIMPL_MF>1.E-10) THEN
  CALL MF_TURB_OPENACC (D, KSV, PARAMMF%LMIXUV, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PARAMMF%XIMPL_MF&
  &, PTSTEP, PDZZ, PRHODJ, ZTHLM, ZTHVM, ZRTM, PUM, PVM, PSVM, PDTHLDT_MF, PDRTDT_MF, PDUDT_MF&
  &, PDVDT_MF, PDSVDT_MF, ZEMF_O_RHODREF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP, ZSV_UP, PFLXZTHMF&
  &, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, ZFLXZSVMF, YDSTACK=YLSTACK)
ELSE
  CALL MF_TURB_EXPL_OPENACC (D, PARAMMF, PRHODJ, ZTHLM, ZTHVM, ZRTM, PUM, PVM, PDTHLDT_MF&
  &, PDRTDT_MF, PDUDT_MF, PDVDT_MF, ZEMF_O_RHODREF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP&
  &, PFLXZTHMF, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, YDSTACK=YLSTACK)
ENDIF


IF (PARAMMF%CMF_UPDRAFT=='DUAL') THEN
  PFLXZTHVMF(JI,:)=0.
ENDIF


IF (PRESENT (BUCONF)) THEN
  
  
  
  
  
ENDIF





END SUBROUTINE SHALLOW_MF_OPENACC
