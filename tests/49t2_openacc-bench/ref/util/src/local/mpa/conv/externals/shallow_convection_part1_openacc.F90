
SUBROUTINE SHALLOW_CONVECTION_PART1_OPENACC (CVPEXT, CVP_SHAL, CST, D, NSV, CONVPAR, KBDIA, KTDIA&
&, KICE, OSETTADJ, PTADJS, PPABST, PZZ, PTKECLS, PTT, PRVT, PRCT, PRIT, PWT, PTTEN, PRVTEN, PRCTEN&
&, PRITEN, KCLTOP, KCLBAS, PUMF, OCH1CONV, KCH1, PCH1, PCH1TEN, PTHT, PSTHV, PSTHES, KSDPL, KSPBL&
&, KSLCL, PSTHLCL, PSTLCL, PSRVLCL, PSWLCL, PSZLCL, PSTHVELCL, OTRIG1, YDSTACK)
!$ACC ROUTINE (SHALLOW_CONVECTION_PART1_OPENACC) SEQ
USE PARKIND1,ONLY:JPRB

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_CONVPAR,ONLY:CONVPAR_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_NSV,ONLY:NSV_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (NSV_T), INTENT (IN)::NSV
TYPE (CONVPAR_T), INTENT (IN)::CONVPAR
INTEGER, INTENT (IN)::KBDIA
INTEGER, INTENT (IN)::KTDIA
INTEGER, INTENT (IN)::KICE
LOGICAL, INTENT (IN)::OSETTADJ
REAL, INTENT (IN)::PTADJS
REAL, INTENT (IN)::PPABST (D%NIT, D%NKT)
REAL, INTENT (IN)::PZZ (D%NIT, D%NKT)
REAL, INTENT (IN)::PTKECLS (D%NIT)
REAL, INTENT (IN)::PTT (D%NIT, D%NKT)
REAL, INTENT (IN)::PRVT (D%NIT, D%NKT)
REAL, INTENT (IN)::PRCT (D%NIT, D%NKT)
REAL, INTENT (IN)::PRIT (D%NIT, D%NKT)
REAL, INTENT (IN)::PWT (D%NIT, D%NKT)
REAL, INTENT (INOUT)::PTTEN (D%NIT, D%NKT)
REAL, INTENT (INOUT)::PRVTEN (D%NIT, D%NKT)
REAL, INTENT (INOUT)::PRCTEN (D%NIT, D%NKT)
REAL, INTENT (INOUT)::PRITEN (D%NIT, D%NKT)
INTEGER, INTENT (INOUT)::KCLTOP (D%NIT)
INTEGER, INTENT (INOUT)::KCLBAS (D%NIT)
REAL, INTENT (INOUT)::PUMF (D%NIT, D%NKT)
LOGICAL, INTENT (IN)::OCH1CONV
INTEGER, INTENT (IN)::KCH1
REAL, INTENT (IN)::PCH1 (D%NIT, D%NKT, KCH1)
REAL, INTENT (INOUT)::PCH1TEN (D%NIT, D%NKT, KCH1)
REAL, INTENT (OUT)::PTHT (D%NIT, D%NKT)
REAL, INTENT (OUT)::PSTHV (D%NIT, D%NKT)
REAL, INTENT (OUT)::PSTHES (D%NIT, D%NKT)
INTEGER, INTENT (OUT)::KSDPL (D%NIT)
INTEGER, INTENT (OUT)::KSPBL (D%NIT)
INTEGER, INTENT (OUT)::KSLCL (D%NIT)
REAL, INTENT (OUT)::PSTHLCL (D%NIT)
REAL, INTENT (OUT)::PSTLCL (D%NIT)
REAL, INTENT (OUT)::PSRVLCL (D%NIT)
REAL, INTENT (OUT)::PSWLCL (D%NIT)
REAL, INTENT (OUT)::PSZLCL (D%NIT)
REAL, INTENT (OUT)::PSTHVELCL (D%NIT)
LOGICAL, INTENT (OUT)::OTRIG1 (D%NIT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER::IKE
INTEGER::IKB
INTEGER::JI
INTEGER::JK
INTEGER::ICONV
REAL::ZEPSA
REAL::ZEPS
REAL::ZRDOCP
REAL::ZES

#include "convect_trigger_shal_openacc.h"

YLSTACK = YDSTACK



JI = D%NIB


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
PTTEN (JI,:)=0.
PRVTEN (JI,:)=0.
PRCTEN (JI,:)=0.
PRITEN (JI,:)=0.
PUMF (JI,:)=0.
KCLTOP (JI)=0
KCLBAS (JI)=0

ZEPS=CST%XRD/CST%XRV
ZEPSA=CST%XRV/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
PTHT (JI,:)=300.
PSTHV (JI,:)=300.
PSTHES (JI,:)=400.

DO JK=IKB, IKE

  

  IF (PPABST (JI, JK)>40.E2) THEN
    PTHT (JI, JK)=PTT (JI, JK)*(CST%XP00/PPABST (JI, JK))**ZRDOCP
    PSTHV (JI, JK)=PTHT (JI, JK)*(1.+ZEPSA*PRVT (JI, JK))/(1.+PRVT (JI, JK)+PRCT (JI, JK)+PRIT (JI, JK))
    ZES=EXP (CST%XALPW-CST%XBETAW/PTT (JI, JK)-CST%XGAMW*LOG (PTT (JI, JK)))
    ZES=MIN (1., ZEPS*ZES/(PPABST (JI, JK)-ZES))
    PSTHES (JI, JK)=PTT (JI, JK)*(PTHT (JI, JK)/PTT (JI, JK))**(1.-0.28&
    &*ZES)*EXP ((3374.6525/PTT (JI, JK)-2.5403)*ZES*(1.+0.81*ZES))
  ENDIF

  
ENDDO

KSLCL (JI)=MAX (IKB, 2)
KSDPL (JI)=IKB
KSPBL (JI)=IKB
CALL CONVECT_TRIGGER_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPABST, PTHT&
&, PSTHV, PSTHES, PRVT, PWT, PZZ, PTKECLS, PSTHLCL, PSTLCL, PSRVLCL, PSWLCL&
&, PSZLCL, PSTHVELCL, KSLCL, KSDPL, KSPBL, OTRIG1, YDSTACK=YLSTACK)

END SUBROUTINE
