SUBROUTINE ROTUV_OPENACC (KFLEV, KPROMA, KST, KEND, PU,&
& PV, PP, PQ, PRU, PRV, LDIR, LDADD, LDSUB, YDSTACK)
!$ACC ROUTINE (ROTUV_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
LOGICAL, INTENT (IN)::LDIR
LOGICAL, OPTIONAL, INTENT (IN)::LDSUB
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
LOGICAL, OPTIONAL, INTENT (IN)::LDADD
REAL (KIND=JPRB), INTENT (IN)::PU (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PRU (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PRV (KPROMA, KFLEV)
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
LOGICAL::LLADD
REAL (KIND=JPRB)::ZV
REAL (KIND=JPRB)::ZU
REAL (KIND=JPRB)::ZA

#include "rotate.func.h"

JROF = KST


ZA=1
LLADD=.FALSE.

IF (PRESENT (LDADD))  THEN
  LLADD=LDADD
ENDIF


IF (PRESENT (LDSUB)) THEN
  LLADD=LLADD.OR.LDSUB

  IF (LDSUB)  THEN
    ZA=-1
  ENDIF

ENDIF


IF (LDIR) THEN

  IF (LLADD) THEN

    DO JLEV=1, KFLEV
      
      ZU=ZA*PU (JROF, JLEV)
      ZV=ZA*PV (JROF, JLEV)
      PRU (JROF, JLEV)=FROTUADD (PRU (JROF, JLEV), ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
      PRV (JROF, JLEV)=FROTVADD (PRV (JROF, JLEV), ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      ZU=PU (JROF, JLEV)
      ZV=PV (JROF, JLEV)
      PRU (JROF, JLEV)=FROTU (ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
      PRV (JROF, JLEV)=FROTV (ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
    
    ENDDO

  ENDIF

ELSE

  IF (LLADD) THEN

    DO JLEV=1, KFLEV
      
      ZU=ZA*PU (JROF, JLEV)
      ZV=ZA*PV (JROF, JLEV)
      PRU (JROF, JLEV)=FUNROTUADD (PRU (JROF, JLEV), ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
      PRV (JROF, JLEV)=FUNROTVADD (PRV (JROF, JLEV), ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      ZU=PU (JROF, JLEV)
      ZV=PV (JROF, JLEV)
      PRU (JROF, JLEV)=FUNROTU (ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
      PRV (JROF, JLEV)=FUNROTV (ZU, ZV, PP (JROF, JLEV), PQ (JROF, JLEV))
    
    ENDDO

  ENDIF

ENDIF


END SUBROUTINE ROTUV_OPENACC
