SUBROUTINE CUDUDV_OPENACC (YDCST, YDECUMF, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA,&
& KLON, KLEV, KTOPM2, KTYPE, KCBOT, KCTOP, LDCUM, PTSPHY, PAPH, PAP, PUEN, PVEN, PMFU&
&, PMFD, PMFUO, PMFDO, PUU, PUD, PVU, PVD, PGP2DSPP, PTENU, PTENV, YDSTACK)
!$ACC ROUTINE (CUDUDV_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOECUMF,ONLY:TECUMF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE YOMPERTPAR,ONLY:TPERTPAR
USE SPP_GEN_MOD,ONLY:SPP_PERT
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TPERTPAR), INTENT (IN)::YDPERTPAR
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KTOPM2
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
LOGICAL, INTENT (IN)::LDCUM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFUO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFDO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZADVW 
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDV, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUV, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFDU, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMFUU, (KLON, KLEV))
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IM
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IPCUDVS
INTEGER (KIND=JPIM)::IPCUDUS
INTEGER (KIND=JPIM)::IPCUDV
INTEGER (KIND=JPIM)::IPCUDU
INTEGER (KIND=JPIM)::IPN2
INTEGER (KIND=JPIM)::IPN1
TYPE (SPP_PERT)::PN2
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZV
REAL (KIND=JPRB)::ZU
REAL (KIND=JPRB)::ZTSPHY
REAL (KIND=JPRB)::ZIMP
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZLIMN2
REAL (KIND=JPRB)::ZMDV
REAL (KIND=JPRB)::ZMDU
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZN2
REAL (KIND=JPRB)::ZXV_MAG
REAL (KIND=JPRB)::ZXU_MAG
REAL (KIND=JPRB)::ZXV
REAL (KIND=JPRB)::ZXU
REAL (KIND=JPRB)::ZRDV
REAL (KIND=JPRB)::ZRDU
fxtran_acdc_temp (REAL (KIND=JPRB), ZDP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDVDT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDUDT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZR2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZR1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB, (KLON, KLEV))
fxtran_acdc_temp (LOGICAL, LLCUMBAS, (KLON, KLEV))
LOGICAL::LLPPAR_CUDUV
LOGICAL::LLPERT_CUDUDVS
LOGICAL::LLPERT_CUDUDV

#include "cubidiag.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZMFDV) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDV)
ELSEIF (KIND (ZMFDV) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUV) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUV)
ELSEIF (KIND (ZMFUV) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDU) == 8) THEN
    fxtran_acdc_alloc8 (ZMFDU)
ELSEIF (KIND (ZMFDU) == 4) THEN
    fxtran_acdc_alloc4 (ZMFDU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUU) == 8) THEN
    fxtran_acdc_alloc8 (ZMFUU)
ELSEIF (KIND (ZMFUU) == 4) THEN
    fxtran_acdc_alloc4 (ZMFUU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDP) == 8) THEN
    fxtran_acdc_alloc8 (ZDP)
ELSEIF (KIND (ZDP) == 4) THEN
    fxtran_acdc_alloc4 (ZDP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDVDT) == 8) THEN
    fxtran_acdc_alloc8 (ZDVDT)
ELSEIF (KIND (ZDVDT) == 4) THEN
    fxtran_acdc_alloc4 (ZDVDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDUDT) == 8) THEN
    fxtran_acdc_alloc8 (ZDUDT)
ELSEIF (KIND (ZDUDT) == 4) THEN
    fxtran_acdc_alloc4 (ZDUDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR2) == 8) THEN
    fxtran_acdc_alloc8 (ZR2)
ELSEIF (KIND (ZR2) == 4) THEN
    fxtran_acdc_alloc4 (ZR2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR1) == 8) THEN
    fxtran_acdc_alloc8 (ZR1)
ELSEIF (KIND (ZR1) == 4) THEN
    fxtran_acdc_alloc4 (ZR1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB) == 8) THEN
    fxtran_acdc_alloc8 (ZB)
ELSEIF (KIND (ZB) == 4) THEN
    fxtran_acdc_alloc4 (ZB)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMBAS) == 8) THEN
    fxtran_acdc_alloc8 (LLCUMBAS)
ELSEIF (KIND (LLCUMBAS) == 4) THEN
    fxtran_acdc_alloc4 (LLCUMBAS)
ELSE
    STOP 1
ENDIF


JL = KIDIA



ZIMP=1.0_JPRB-YDECUMF%RMFSOLUV
ZTSPHY=1.0_JPRB/PTSPHY
LLPPAR_CUDUV=.FALSE.
LLPERT_CUDUDV=.FALSE.
LLPERT_CUDUDVS=.FALSE.

ZADVW =0.0_JPRB

IF (KTYPE (JL)==1)  THEN
  ZADVW =YDECUMF%RMFADVW
ENDIF



DO JK=1, KLEV

  

  IF (LDCUM (JL)) THEN
    ZDP (JL, JK)=YDCST%RG/(PAPH (JL, JK+1)-PAPH (JL, JK))
  ENDIF

  
ENDDO


DO JK=KTOPM2, KLEV
  IK=JK-1

  

  IF (LDCUM (JL)) THEN
    ZMFUU (JL, JK)=PMFU (JL, JK)*(PUU (JL, JK)-ZIMP*PUEN (JL, IK))
    ZMFUV (JL, JK)=PMFU (JL, JK)*(PVU (JL, JK)-ZIMP*PVEN (JL, IK))
    ZMFDU (JL, JK)=PMFD (JL, JK)*(PUD (JL, JK)-ZIMP*PUEN (JL, IK))
    ZMFDV (JL, JK)=PMFD (JL, JK)*(PVD (JL, JK)-ZIMP*PVEN (JL, IK))
  ENDIF

  
ENDDO


IF (YDECUMF%RMFSOLUV==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    

    IF (LDCUM (JL).AND.JK>KCBOT (JL)) THEN
      IKB=KCBOT (JL)
      ZZP=((PAPH (JL, KLEV+1)-PAPH (JL, JK))/(PAPH (JL, KLEV+1)-PAPH (JL, IKB)))

      IF (KTYPE (JL)==3) THEN
        ZZP=ZZP*ZZP
      ENDIF

      ZMFUU (JL, JK)=ZMFUU (JL, IKB)*ZZP
      ZMFUV (JL, JK)=ZMFUV (JL, IKB)*ZZP
      ZMFDU (JL, JK)=ZMFDU (JL, IKB)*ZZP
      ZMFDV (JL, JK)=ZMFDV (JL, IKB)*ZZP
    ENDIF

  
  ENDDO

ENDIF


DO JK=KTOPM2, KLEV

  IF (JK<KLEV) THEN
    IK=JK+1

    

    IF (LDCUM (JL)) THEN
      ZDUDT (JL, JK)=ZDP (JL, JK)*(ZMFUU (JL, IK)-ZMFUU (JL, JK)+ZMFDU (JL, IK)-ZMFDU (JL, JK))
      ZDVDT (JL, JK)=ZDP (JL, JK)*(ZMFUV (JL, IK)-ZMFUV (JL, JK)+ZMFDV (JL, IK)-ZMFDV (JL, JK))
    ENDIF

  
  ELSE

    

    IF (LDCUM (JL)) THEN
      ZDUDT (JL, JK)=-ZDP (JL, JK)*(ZMFUU (JL, JK)+ZMFDU (JL, JK))
      ZDVDT (JL, JK)=-ZDP (JL, JK)*(ZMFUV (JL, JK)+ZMFDV (JL, JK))
    ENDIF

  
  ENDIF

ENDDO


IF (YDECUMF%RMFSOLUV==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    

    IF (LDCUM (JL)) THEN
      PTENU (JL, JK)=PTENU (JL, JK)+ZDUDT (JL, JK)
      PTENV (JL, JK)=PTENV (JL, JK)+ZDVDT (JL, JK)
    ENDIF

  
  ENDDO

ELSE
  LLCUMBAS (JL,:)=.FALSE.
  ZB (JL,:)=1.0_JPRB
  ZMFUU (JL,:)=0.0_JPRB

  DO JK=KTOPM2, KLEV
    IK=JK+1
    IM=JK-1
    
    LLCUMBAS (JL, JK)=LDCUM (JL).AND.JK>=KCTOP (JL)-1

    IF (LLCUMBAS (JL, JK)) THEN
      ZZP=YDECUMF%RMFSOLUV*ZDP (JL, JK)*PTSPHY
      ZMFUU (JL, JK)=-ZZP*(PMFU (JL, JK)+PMFD (JL, JK))

      IF (JK<KLEV) THEN
        ZB (JL, JK)=1.0_JPRB+ZZP*(PMFU (JL, IK)+PMFD (JL, IK))
      ELSE
        ZB (JL, JK)=1.0_JPRB
      ENDIF

      ZZP=YDCST%RG*(PMFUO (JL, JK)+YDECUMF%RMFADVWDD*PMFDO (JL&
      &, JK))/(PAP (JL, JK)-PAP (JL, IM))*PTSPHY*ZADVW 
      ZU=ZZP*(PUEN (JL, IM)-PUEN (JL, JK))
      ZV=ZZP*(PVEN (JL, IM)-PVEN (JL, JK))
      ZDUDT (JL, JK)=(ZDUDT (JL, JK)+PTENU (JL, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PUEN (JL, JK)-ZU
      ZDVDT (JL, JK)=(ZDVDT (JL, JK)+PTENV (JL, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PVEN (JL, JK)-ZV
    ENDIF

  
  ENDDO

  CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP&
  &, LLCUMBAS, ZMFUU, ZB, ZDUDT, ZR1, YDSTACK=YLSTACK)
  CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP&
  &, LLCUMBAS, ZMFUU, ZB, ZDVDT, ZR2, YDSTACK=YLSTACK)
  LLPPAR_CUDUV=YDPERTPAR%LPERTPAR.AND.YDPERTPAR%LPERT_CUDUV
  
  LLPERT_CUDUDV=.FALSE.
  LLPERT_CUDUDVS=.FALSE.

  

  IF (LLPERT_CUDUDV.OR.LLPERT_CUDUDVS.OR.LLPPAR_CUDUV) THEN
    ZMDU=1.0_JPRB
    ZMDV=1.0_JPRB
    ZLIMN2=9.0_JPRB*PN1%SDEV**2

    

    IF ((KTYPE (JL)==1.AND.(LLPERT_CUDUDV.OR.LLPPAR_CUDUV)).OR.(KTYPE&
      & (JL)==2.AND.(LLPERT_CUDUDVS.OR.LLPPAR_CUDUV))) THEN

      IF (KTYPE (JL)==1) THEN

        IF (.NOT.LLPPAR_CUDUV) THEN
          ZXU=PGP2DSPP (JL, IPCUDU)
          ZXV=PGP2DSPP (JL, IPCUDV)
          ZXU_MAG=PN1%XMAG (1)
          ZXV_MAG=PN1%XMAG (2)
        ELSE
          ZXU=YDPERTPAR%CUDU_MOD
          ZXV=YDPERTPAR%CUDV_MOD
        ENDIF

      ENDIF


      IF (KTYPE (JL)==2) THEN

        IF (.NOT.LLPPAR_CUDUV) THEN
          ZXU=PGP2DSPP (JL, IPCUDUS)
          ZXV=PGP2DSPP (JL, IPCUDVS)
          ZXU_MAG=PN2%XMAG (1)
          ZXV_MAG=PN2%XMAG (2)
        ELSE
          ZXU=YDPERTPAR%CUDU_MOD
          ZXV=YDPERTPAR%CUDV_MOD
        ENDIF

      ENDIF

      ZN2=ZXU**2+ZXV**2

      IF (ZN2>ZLIMN2) THEN
        ZFAC=SQRT (ZLIMN2/ZN2)
        ZXU=ZFAC*ZXU
        ZXV=ZFAC*ZXV
      ENDIF


      IF (.NOT.LLPPAR_CUDUV) THEN
        ZRDU =ZMDU+ZXU_MAG*ZXU
        ZRDV =ZMDV+ZXV_MAG*ZXV
      ELSE
        ZRDU =ZMDU+ZXU
        ZRDV =ZMDV+ZXV
      ENDIF

    ELSE
      ZRDU =ZMDU
      ZRDV =ZMDV
    ENDIF

  
  ENDIF


  DO JK=KTOPM2, KLEV

    

    IF (LLCUMBAS (JL, JK)) THEN

      IF ((LLPERT_CUDUDV).OR.(LLPPAR_CUDUV)) THEN
        PTENU (JL, JK)=PTENU (JL, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS)+ZRDU *(ZR1 (JL, JK)-PUEN (JL, JK))*ZTSPHY
        PTENV (JL, JK)=PTENV (JL, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS)+ZRDV *(ZR2 (JL, JK)-PVEN (JL, JK))*ZTSPHY
      ELSE
        PTENU (JL, JK)=PTENU (JL, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS)+(ZR1 (JL, JK)-PUEN (JL, JK))*ZTSPHY
        PTENV (JL, JK)=PTENV (JL, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS)+(ZR2 (JL, JK)-PVEN (JL, JK))*ZTSPHY
      ENDIF

    ENDIF

  
  ENDDO

ENDIF



END SUBROUTINE CUDUDV_OPENACC
