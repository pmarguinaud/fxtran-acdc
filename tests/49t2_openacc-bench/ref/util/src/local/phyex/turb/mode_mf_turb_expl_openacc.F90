
MODULE MODE_MF_TURB_EXPL_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE MF_TURB_EXPL_OPENACC (D, PARAMMF, PRHODJ, PTHLM, PTHVM, PRTM, PUM&
&, PVM, PTHLDT, PRTDT, PUDT, PVDT, PEMF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP&
&, PFLXZTHLMF, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, YDSTACK)
!$ACC ROUTINE (MF_TURB_EXPL_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T

USE MODI_SHUMAN_MF,ONLY:MZM_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZM_MF_OPENACC
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHLDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRTDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PUDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PVDT(D%NIJT, D%NKT)
REAL, INTENT (IN)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZVMF(D%NIJT, D%NKT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL, INTENT (OUT)::PFLXZUMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZRMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHLMF(D%NIJT, D%NKT)
fxtran_acdc_temp (REAL, ZTHSM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHS_UP, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZFLXZTHSMF, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZQTDT, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHSDT, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZQTM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZQT_UP, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRTM_F, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHLM_F, (D%NIJT, D%NKT))
INTEGER::JI
INTEGER::JK
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKB
INTEGER::IKT


YLSTACK = YDSTACK



IF (KIND (ZTHSM) == 8) THEN
    fxtran_acdc_alloc8 (ZTHSM)
ELSEIF (KIND (ZTHSM) == 4) THEN
    fxtran_acdc_alloc4 (ZTHSM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHS_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZTHS_UP)
ELSEIF (KIND (ZTHS_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZTHS_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLXZTHSMF) == 8) THEN
    fxtran_acdc_alloc8 (ZFLXZTHSMF)
ELSEIF (KIND (ZFLXZTHSMF) == 4) THEN
    fxtran_acdc_alloc4 (ZFLXZTHSMF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQTDT) == 8) THEN
    fxtran_acdc_alloc8 (ZQTDT)
ELSEIF (KIND (ZQTDT) == 4) THEN
    fxtran_acdc_alloc4 (ZQTDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHSDT) == 8) THEN
    fxtran_acdc_alloc8 (ZTHSDT)
ELSEIF (KIND (ZTHSDT) == 4) THEN
    fxtran_acdc_alloc4 (ZTHSDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQTM) == 8) THEN
    fxtran_acdc_alloc8 (ZQTM)
ELSEIF (KIND (ZQTM) == 4) THEN
    fxtran_acdc_alloc4 (ZQTM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQT_UP) == 8) THEN
    fxtran_acdc_alloc8 (ZQT_UP)
ELSEIF (KIND (ZQT_UP) == 4) THEN
    fxtran_acdc_alloc4 (ZQT_UP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRTM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZRTM_F)
ELSEIF (KIND (ZRTM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZRTM_F)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHLM_F) == 8) THEN
    fxtran_acdc_alloc8 (ZTHLM_F)
ELSEIF (KIND (ZTHLM_F) == 4) THEN
    fxtran_acdc_alloc4 (ZTHLM_F)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKE=D%NKE
IKL=D%NKL
PFLXZRMF(JI,:)=0.
PFLXZTHVMF(JI,:)=0.
PFLXZTHLMF(JI,:)=0.
PFLXZUMF(JI,:)=0.
PFLXZVMF(JI,:)=0.
PTHLDT(JI,:)=0.
PRTDT(JI,:)=0.
PUDT(JI,:)=0.
PVDT(JI,:)=0.
CALL MZM_MF_OPENACC (D, PRTM (:,:), ZRTM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTHLM (:,:), ZTHLM_F (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  ZQTM (JI, JK)=ZRTM_F (JI, JK)/(1.+ZRTM_F (JI, JK))
  ZQT_UP (JI, JK)=PRT_UP (JI, JK)/(1.+PRT_UP (JI, JK))
  ZTHS_UP (JI, JK)=PTHL_UP (JI, JK)*(1.+PARAMMF%XLAMBDA_MF*ZQT_UP (JI, JK))
  ZTHSM (JI, JK)=ZTHLM_F (JI, JK)*(1.+PARAMMF%XLAMBDA_MF*ZQTM (JI, JK))
  
ENDDO

CALL MZM_MF_OPENACC (D, PTHLM (:,:), PFLXZTHLMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), PFLXZRMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTHVM (:,:), PFLXZTHVMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT
  
  PFLXZTHLMF (JI, JK)=PEMF (JI, JK)*(PTHL_UP (JI, JK)-PFLXZTHLMF (JI, JK))
  PFLXZRMF (JI, JK)=PEMF (JI, JK)*(PRT_UP (JI, JK)-PFLXZRMF (JI, JK))
  PFLXZTHVMF (JI, JK)=PEMF (JI, JK)*(PTHV_UP (JI, JK)-PFLXZTHVMF (JI, JK))
  ZFLXZTHSMF (JI, JK)=PEMF (JI, JK)*(ZTHS_UP (JI, JK)-ZTHSM (JI, JK))
  
ENDDO


IF (PARAMMF%LMIXUV) THEN
  CALL MZM_MF_OPENACC (D, PUM (:,:), PFLXZUMF (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PVM (:,:), PFLXZVMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT
    
    PFLXZUMF (JI, JK)=PEMF (JI, JK)*(PU_UP (JI, JK)-PFLXZUMF (JI, JK))
    PFLXZVMF (JI, JK)=PEMF (JI, JK)*(PV_UP (JI, JK)-PFLXZVMF (JI, JK))
  
  ENDDO

ELSE
  PFLXZUMF (JI,:)=0.
  PFLXZVMF (JI,:)=0.
ENDIF


DO JK=IKB, IKE-IKL, IKL
  
  PRTDT (JI, JK)=(PFLXZRMF (JI, JK)-PFLXZRMF (JI, JK+IKL))/PRHODJ (JI, JK)
  ZQTDT (JI, JK)=PRTDT (JI, JK)/(1.+ZRTM_F (JI, JK)*ZRTM_F (JI, JK))
  ZTHSDT (JI, JK)=(ZFLXZTHSMF (JI, JK)-ZFLXZTHSMF (JI, JK+IKL))/PRHODJ (JI, JK)
  PTHLDT (JI, JK)=ZTHSDT (JI, JK)/(1.+PARAMMF%XLAMBDA_MF*ZQTM (JI&
  &, JK))-ZTHLM_F (JI, JK)*PARAMMF%XLAMBDA_MF*ZQTDT (JI, JK)
  
ENDDO


IF (PARAMMF%LMIXUV) THEN

  DO JK=IKB, IKE-IKL, IKL
    
    PUDT (JI, JK)=(PFLXZUMF (JI, JK)-PFLXZUMF (JI, JK+IKL))/PRHODJ (JI, JK)
    PVDT (JI, JK)=(PFLXZVMF (JI, JK)-PFLXZVMF (JI, JK+IKL))/PRHODJ (JI, JK)
  
  ENDDO

ENDIF


END SUBROUTINE MF_TURB_EXPL_OPENACC

ENDMODULE MODE_MF_TURB_EXPL_OPENACC
