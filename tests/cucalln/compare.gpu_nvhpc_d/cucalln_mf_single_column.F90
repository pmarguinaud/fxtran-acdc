SUBROUTINE CUCALLN_MF_SINGLE_COLUMN (PPLDARE, PPLRG, KSTEP, YDTHF, YDCST, YDERAD, YDML_PHY_SLIN&
&, YDML_PHY_EC, YGFL, KIDIA, KFDIA, KLON, KSMAX, KLEV, PDX, KSPPN2D, LDLAND, LDSLPHY, PTSPHY,&
& PVDIFTS, PTM1, PQM1, PUM1, PVM1, PLITOT, PVERVEL, PQHFL, PAHFS, PAPHM1, PAP, PAPH, PGEO, PGEOH&
&, PGAW, PCUCONVCA, PGP2DSPP, PTENT, PTENQ, PTENU, PTENV, PARPRC, KTOPC, KBASEC, KTYPE, KCBOT&
&, KCTOP, KBOTSC, LDCUM, LDSC, LDSHCV, PLCRIT_AER, PLU, PLUDE, PLUDELI, PSNDE, PMFU, PMFD, PDIFCQ&
&, PDIFCS, PFHPCL, PFHPCN, PFPLCL, PFPLCN, PLRAIN, PRSUD, PSTRCU, PSTRCV, PFCQLF, PFCQIF, PMFUDE_RATE&
&, PMFDDE_RATE, PCAPE, PWMEAN, PDISS, KTRAC, PCM1, PTENC, PSCAV, YDSTACK)
!$acc routine (CUCALLN_MF_SINGLE_COLUMN) seq
USE MODEL_PHYSICS_ECMWF_MOD,ONLY:MODEL_PHYSICS_ECMWF_TYPE
USE MODEL_PHYSICS_SIMPLINEAR_MOD,ONLY:MODEL_PHYSICS_SIMPLINEAR_TYPE
USE YOERAD,ONLY:TERAD
USE YOM_YGFL,ONLY:TYPE_GFLD
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE STACK_MOD
#include "stack.h"

IMPLICIT NONE

REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
INTEGER (KIND=JPIM), INTENT (IN)::KSTEP
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TERAD), INTENT (IN)::YDERAD
TYPE (MODEL_PHYSICS_ECMWF_TYPE), INTENT (IN)::YDML_PHY_EC
TYPE (MODEL_PHYSICS_SIMPLINEAR_TYPE), INTENT (IN)::YDML_PHY_SLIN
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KSMAX
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KSPPN2D
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
LOGICAL, INTENT (IN)::LDLAND (KLON)
LOGICAL, INTENT (IN)::LDSLPHY
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PVDIFTS
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCM1 (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAPHM1 (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (INOUT)::PTENT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCUCONVCA (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, KSPPN2D)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
TYPE(STACK) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (IN)::PDX (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (OUT)::PARPRC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTOPC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBASEC (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (KLON)
LOGICAL, INTENT (OUT)::LDCUM (KLON)
LOGICAL, INTENT (OUT)::LDSC (KLON)
LOGICAL, INTENT (IN)::LDSHCV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 4)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDIFCQ (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PDIFCS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFHPCL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFHPCN (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFPLCL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFPLCN (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSUD (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PSTRCU (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PSTRCV (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFCQLF (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFCQIF (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (KLON, KLEV)

temp (REAL (KIND=JPRB), ZRAIN, (KLON))
temp (REAL (KIND=JPRB), ZQSAT, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZQU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZTU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZVP1, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZUP1, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZQP1, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZTP1, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZCP1, (KLON, KLEV, KTRAC))

temp (REAL (KIND=JPRB), ZENTHS, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZENTHD, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZUEA, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZVEA, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZTEA, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZQEA, (KLON, KLEV))

REAL (KIND=JPRB)::ZCONDFLN 
REAL (KIND=JPRB)::ZCONDFLL 

INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IFLAG

REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZGDPH
REAL (KIND=JPRB)::ZCP
LOGICAL::LLTDKMF

#include "cuccdia_single_column.intfb.h"
#include "cumastrn_single_column.intfb.h"
#include "satur_single_column.intfb.h"
#include "fcttre.func.h"
#include "fcttrm.func.h"

YLSTACK = YDSTACK

alloc (ZRAIN)
alloc (ZQSAT)
alloc (ZQU)
alloc (ZTU)
alloc (ZVP1)
alloc (ZUP1)
alloc (ZQP1)
alloc (ZTP1)
alloc (ZCP1)
alloc (ZENTHS)
alloc (ZENTHD)
alloc (ZUEA)
alloc (ZVEA)
alloc (ZTEA)
alloc (ZQEA)



JLON = KIDIA



DO JK=1, KLEV
  
  ZQEA (JLON, JK)=PTENQ (JLON, JK)
  ZTEA (JLON, JK)=PTENT (JLON, JK)
  ZVEA (JLON, JK)=PTENV (JLON, JK)
  ZUEA (JLON, JK)=PTENU (JLON, JK)
  ZENTHD (JLON, JK)=0.0_JPRB
  ZENTHS (JLON, JK)=0.0_JPRB
  
ENDDO


DO JK=1, KLEV+1
  
  PFPLCL (JLON, JK)=0.0_JPRB
  PFPLCN (JLON, JK)=0.0_JPRB
  
ENDDO

ZEPS=1.0E-10_JPRB

DO JK=1, KLEV
  
  ZUP1 (JLON, JK)=PUM1 (JLON, JK)+PTENU (JLON, JK)*PTSPHY
  ZVP1 (JLON, JK)=PVM1 (JLON, JK)+PTENV (JLON, JK)*PTSPHY
  ZTP1 (JLON, JK)=PTM1 (JLON, JK)+PTENT (JLON, JK)*PTSPHY
  ZQP1 (JLON, JK)=PQM1 (JLON, JK)+PTENQ (JLON, JK)*PTSPHY
  ZQSAT (JLON, JK)=ZQP1 (JLON, JK)

  IF (ZQSAT (JLON, JK)<=0.0_JPRB)  THEN
      ZQSAT (JLON, JK)=ZEPS
  ENDIF

  
ENDDO


IF (LDSLPHY) THEN

  IF (KTRAC>0.AND.YDML_PHY_EC%YREPHY%LMFTRAC) THEN

    DO JN=1, KTRAC

      DO JK=1, KLEV
        
        ZCP1 (JLON, JK, JN)=PCM1 (JLON, JK, JN)
      
      ENDDO

    ENDDO

  ENDIF

ELSE

  IF (KTRAC>0.AND.YDML_PHY_EC%YREPHY%LMFTRAC) THEN

    DO JN=1, KTRAC

      DO JK=1, KLEV
        
        ZCP1 (JLON, JK, JN)=PCM1 (JLON, JK, JN)+PTENC (JLON, JK, JN)*PTSPHY
      
      ENDDO

    ENDDO

  ENDIF

ENDIF

IFLAG=1
CALL SATUR_SINGLE_COLUMN (YDTHF, YDCST, KIDIA, KFDIA, KLON, YDML_PHY_EC%YRECUMF%NJKT2&
&, KLEV, YDML_PHY_SLIN%YREPHLI%LPHYLIN, PAP, ZTP1, ZQSAT, IFLAG, YDSTACK=YLSTACK)

ZRAIN (JLON)=0.0_JPRB

LLTDKMF=.TRUE.
CALL CUMASTRN_SINGLE_COLUMN (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN, YDML_PHY_EC, YGFL, KIDIA&
&, KFDIA, KLON, KLEV, PDX, LLTDKMF, KSPPN2D, LDLAND, PTSPHY, ZTP1, ZQP1, ZUP1, ZVP1, PLITOT, PVERVEL&
&, ZQSAT, PQHFL, PAHFS, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA, PGP2DSPP, PTENT, PTENQ, PTENU&
&, PTENV, LDCUM, KTYPE, KCBOT, KCTOP, KBOTSC, LDSC, LDSHCV, PLCRIT_AER, ZTU, ZQU, PLU, PLUDE,&
& PLUDELI, PSNDE, ZENTHD, PFPLCL, PFPLCN, ZRAIN, PLRAIN, PRSUD, PMFU, PMFD, PMFUDE_RATE, PMFDDE_RATE&
&, PCAPE, PWMEAN, PDISS, KTRAC, ZCP1, PTENC, PSCAV, YDSTACK=YLSTACK)
CALL CUCCDIA_SINGLE_COLUMN (YDERAD, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YREPHY, KIDIA, KFDIA, KLON, KLEV&
&, KSTEP, KCBOT, KCTOP, LDCUM, ZQU, PLU, PMFU, ZRAIN, PARPRC, KTOPC, KBASEC, YDSTACK=YLSTACK)

PDIFCQ (JLON, 1)=0.0_JPRB
PDIFCS (JLON, 1)=0.0_JPRB
PSTRCU (JLON, 1)=0.0_JPRB
PSTRCV (JLON, 1)=0.0_JPRB
PFCQLF (JLON, 1)=0.0_JPRB
PFCQIF (JLON, 1)=0.0_JPRB
PFHPCL (JLON, 1)=0.0_JPRB
PFHPCN (JLON, 1)=0.0_JPRB
PDIFCS (JLON, 1)=0.0_JPRB
PDIFCQ (JLON, 1)=0.0_JPRB
ZCONDFLL =0.0_JPRB
ZCONDFLN =0.0_JPRB


DO JK=1, KLEV
  
  ZGDPH=-YDCST%RG/(PAPHM1 (JLON, JK+1)-PAPHM1 (JLON, JK))
  ZCP=YDCST%RCPD*(1+YDTHF%RVTMP2*ZQP1 (JLON, JK))
  PDIFCS (JLON, JK+1)=(PTENT (JLON, JK)-ZTEA (JLON, JK))/ZGDPH*ZCP+PDIFCS (JLON, JK)
  PSTRCU (JLON, JK+1)=(PTENU (JLON, JK)-ZUEA (JLON, JK))/ZGDPH+PSTRCU (JLON, JK)
  PSTRCV (JLON, JK+1)=(PTENV (JLON, JK)-ZVEA (JLON, JK))/ZGDPH+PSTRCV (JLON, JK)
  PDIFCQ (JLON, JK+1)=(PTENQ (JLON, JK)-ZQEA (JLON, JK))/ZGDPH+PDIFCQ (JLON, JK)
  
ENDDO


DO JK=1, KLEV
  
  PFHPCL (JLON, JK+1)=-PFPLCL (JLON, JK+1)*YDCST%RLVTT
  PFHPCN (JLON, JK+1)=-PFPLCN (JLON, JK+1)*YDCST%RLSTT
  ZCONDFLL =ZCONDFLL +PLUDELI (JLON, JK, 1)
  ZCONDFLN =ZCONDFLN +PLUDELI (JLON, JK, 2)
  PDIFCS (JLON, JK+1)=PDIFCS (JLON, JK+1)-PFHPCL (JLON, JK+1)-PFHPCN&
  & (JLON, JK+1)+YDCST%RLVTT*ZCONDFLL +YDCST%RLSTT*ZCONDFLN 
  PDIFCQ (JLON, JK+1)=PDIFCQ (JLON, JK+1)-PFPLCL (JLON, JK+1)-PFPLCN (JLON, JK+1)-ZCONDFLL -ZCONDFLN 
  PFCQLF (JLON, JK+1)=ZCONDFLL 
  PFCQIF (JLON, JK+1)=ZCONDFLN 
  
ENDDO



ENDSUBROUTINE CUCALLN_MF_SINGLE_COLUMN

