SUBROUTINE ACPROD_OPENACC (YDCST, KIDIA, KFDIA, KLON, KLEV, PR, PCP, PT, PQ, PU&
&, PV, PAPRSF, PAPHIF, PDIFCQ, PDIFCS, PSTRCU, PSTRCV, PPRODTH, YDSTACK)
!$ACC ROUTINE (ACPROD_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDIFCQ (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDIFCS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PSTRCU (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PSTRCV (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PPRODTH (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZTH 
REAL (KIND=JPRB)::ZQH 
REAL (KIND=JPRB)::ZCPH 
fxtran_acdc_temp (REAL (KIND=JPRB), ZRHOF, (KLON, KLEV))
REAL (KIND=JPRB)::ZEXNERH 
fxtran_acdc_temp (REAL (KIND=JPRB), ZEXNERF, (KLON, KLEV))
REAL (KIND=JPRB)::ZRHOH 
REAL (KIND=JPRB)::ZTHETAH 
REAL (KIND=JPRB)::ZWPTHEPV 
REAL (KIND=JPRB)::ZWPQP 
REAL (KIND=JPRB)::ZWPTP 
REAL (KIND=JPRB)::ZPRODDYN 
REAL (KIND=JPRB)::ZDVODPHI 
REAL (KIND=JPRB)::ZDUODPHI 


YLSTACK = YDSTACK



IF (KIND (ZRHOF) == 8) THEN
    fxtran_acdc_alloc8 (ZRHOF)
ELSEIF (KIND (ZRHOF) == 4) THEN
    fxtran_acdc_alloc4 (ZRHOF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEXNERF) == 8) THEN
    fxtran_acdc_alloc8 (ZEXNERF)
ELSEIF (KIND (ZEXNERF) == 4) THEN
    fxtran_acdc_alloc4 (ZEXNERF)
ELSE
    STOP 1
ENDIF


JLON = KIDIA





DO JLEV=1, KLEV
  
  ZEXNERF (JLON, JLEV)=(YDCST%RATM/PAPRSF (JLON, JLEV))**YDCST%RKAPPA
  ZRHOF (JLON, JLEV)=PAPRSF (JLON, JLEV)/(PT (JLON, JLEV)*PR (JLON, JLEV))
  
ENDDO


DO JLEV=1, KLEV-1
  
  ZEXNERH =0.5_JPRB*(ZEXNERF (JLON, JLEV)+ZEXNERF (JLON, JLEV+1))
  ZRHOH =0.5_JPRB*(ZRHOF (JLON, JLEV)+ZRHOF (JLON, JLEV+1))
  ZCPH =0.5_JPRB*(PCP (JLON, JLEV)+PCP (JLON, JLEV+1))
  ZQH =0.5_JPRB*(PQ (JLON, JLEV)+PQ (JLON, JLEV+1))
  ZTH =0.5_JPRB*(PT (JLON, JLEV)+PT (JLON, JLEV+1))
  ZTHETAH =ZEXNERH *ZTH 
  ZWPTP =PDIFCS (JLON, JLEV)/ZRHOH /ZCPH 
  ZWPQP =PDIFCQ (JLON, JLEV)/ZRHOH 
  ZDUODPHI =(PU (JLON, JLEV)-PU (JLON, JLEV+1))/(PAPHIF (JLON, JLEV)-PAPHIF (JLON, JLEV+1))
  ZDVODPHI =(PV (JLON, JLEV)-PV (JLON, JLEV+1))/(PAPHIF (JLON, JLEV)-PAPHIF (JLON, JLEV+1))
  ZPRODDYN =-YDCST%RG*(PSTRCU (JLON, JLEV)*ZDUODPHI +PSTRCV (JLON, JLEV)*ZDVODPHI )/ZRHOH 
  ZWPTHEPV =ZEXNERH *((1._JPRB+0.608_JPRB*ZQH )*ZWPTP +0.608_JPRB*ZTH *ZWPQP )
  PPRODTH (JLON, JLEV)=PPRODTH (JLON, JLEV)+(YDCST%RG/ZTHETAH )*ZWPTHEPV +ZPRODDYN 
  
ENDDO



END SUBROUTINE ACPROD_OPENACC
