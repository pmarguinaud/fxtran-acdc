
SUBROUTINE CUASCN_PARALLEL (YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF, YDSPP_CONFIG, YGFL, YDCPG_OPTS&
&, YDCPG_BNDS, KLON, KLEV, LDTDKMF, PTSPHY, YD_PTENH, YD_PQENH, YD_PUEN, YD_PVEN, YD_PTEN, YD_PQEN,&
& YD_PQSEN, YD_PLITOT, YD_PGEO, YD_PGEOH, YD_PAP, YD_PAPH, YD_PVERVEL, YD_PWUBASE, YD_PGP2DSPP, YD_LDLAND&
&, YD_LDCUM, YD_KTYPE, YD_KLAB, YD_LSCVFLAG, YD_PTU, YD_PQU, YD_PLU, YD_PLRAIN, YD_PMFU, YD_PMFUB, YD_PLGLAC&
&, YD_PMFUS, YD_PMFUQ, YD_PMFUL, YD_PLUDE, YD_PLUDELI, YD_PDMFUP, YD_PLCRIT_AER, YD_PDMFEN, YD_KCBOT&
&, YD_KCTOP, YD_KCTOP0, YD_KDPL, YD_PMFUDE_RATE, YD_PKINEU, YD_PWU, YD_PWMEAN)

USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
USE YOECLDP,ONLY:TECLDP
USE YOM_YGFL,ONLY:TYPE_GFLD
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE CPG_OPTS_TYPE_MOD, ONLY : CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
TYPE (CPG_OPTS_TYPE), INTENT (IN) :: YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN) :: YDCPG_BNDS
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
CLASS (FIELD_3RB), POINTER :: YD_PLCRIT_AER
REAL (KIND=JPRB), POINTER::PLCRIT_AER (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTENH
REAL (KIND=JPRB), POINTER::PTENH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQENH
REAL (KIND=JPRB), POINTER::PQENH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PUEN
REAL (KIND=JPRB), POINTER::PUEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PVEN
REAL (KIND=JPRB), POINTER::PVEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTEN
REAL (KIND=JPRB), POINTER::PTEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQEN
REAL (KIND=JPRB), POINTER::PQEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQSEN
REAL (KIND=JPRB), POINTER::PQSEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PLITOT
REAL (KIND=JPRB), POINTER::PLITOT (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PGEO
REAL (KIND=JPRB), POINTER::PGEO (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PGEOH
REAL (KIND=JPRB), POINTER::PGEOH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PAP
REAL (KIND=JPRB), POINTER::PAP (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PAPH
REAL (KIND=JPRB), POINTER::PAPH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PVERVEL
REAL (KIND=JPRB), POINTER::PVERVEL (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PWUBASE
REAL (KIND=JPRB), POINTER::PWUBASE (:,:)
CLASS (FIELD_3RB), POINTER :: YD_PGP2DSPP
REAL (KIND=JPRB), POINTER::PGP2DSPP (:,:,:)
CLASS (FIELD_2LM), POINTER :: YD_LDLAND
LOGICAL, POINTER::LDLAND (:,:)
CLASS (FIELD_2LM), POINTER :: YD_LDCUM
LOGICAL, POINTER::LDCUM (:,:)
LOGICAL, INTENT (IN)::LDTDKMF
CLASS (FIELD_2LM), POINTER :: YD_LSCVFLAG
LOGICAL, POINTER::LSCVFLAG (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KTYPE
INTEGER (KIND=JPIM), POINTER::KTYPE (:,:)
CLASS (FIELD_3IM), POINTER :: YD_KLAB
INTEGER (KIND=JPIM), POINTER::KLAB (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTU
REAL (KIND=JPRB), POINTER::PTU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQU
REAL (KIND=JPRB), POINTER::PQU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PLU
REAL (KIND=JPRB), POINTER::PLU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PLRAIN
REAL (KIND=JPRB), POINTER::PLRAIN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PMFU
REAL (KIND=JPRB), POINTER::PMFU (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PMFUB
REAL (KIND=JPRB), POINTER::PMFUB (:,:)
CLASS (FIELD_3RB), POINTER :: YD_PLGLAC
REAL (KIND=JPRB), POINTER::PLGLAC (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PMFUS
REAL (KIND=JPRB), POINTER::PMFUS (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PMFUQ
REAL (KIND=JPRB), POINTER::PMFUQ (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PMFUL
REAL (KIND=JPRB), POINTER::PMFUL (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PLUDE
REAL (KIND=JPRB), POINTER::PLUDE (:,:,:)
CLASS (FIELD_4RB), POINTER :: YD_PLUDELI
REAL (KIND=JPRB), POINTER::PLUDELI (:,:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PDMFUP
REAL (KIND=JPRB), POINTER::PDMFUP (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PDMFEN
REAL (KIND=JPRB), POINTER::PDMFEN (:,:,:)
CLASS (FIELD_2IM), POINTER :: YD_KCBOT
INTEGER (KIND=JPIM), POINTER::KCBOT (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KCTOP
INTEGER (KIND=JPIM), POINTER::KCTOP (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KCTOP0
INTEGER (KIND=JPIM), POINTER::KCTOP0 (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KDPL
INTEGER (KIND=JPIM), POINTER::KDPL (:,:)
CLASS (FIELD_3RB), POINTER :: YD_PMFUDE_RATE
REAL (KIND=JPRB), POINTER::PMFUDE_RATE (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PKINEU
REAL (KIND=JPRB), POINTER::PKINEU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PWU
REAL (KIND=JPRB), POINTER::PWU (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PWMEAN
REAL (KIND=JPRB), POINTER::PWMEAN (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZLUOLD
REAL (KIND=JPRB), POINTER::ZLUOLD (:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZBUO
REAL (KIND=JPRB), POINTER::ZBUO (:,:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZPRECIP
REAL (KIND=JPRB), POINTER::ZPRECIP (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZQOLD
REAL (KIND=JPRB), POINTER::ZQOLD (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZDMFDE
REAL (KIND=JPRB), POINTER::ZDMFDE (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZDMFEN
REAL (KIND=JPRB), POINTER::ZDMFEN (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZDPMEAN
REAL (KIND=JPRB), POINTER::ZDPMEAN (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZPH
REAL (KIND=JPRB), POINTER::ZPH (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZOENTR
REAL (KIND=JPRB), POINTER::ZOENTR (:,:)
LOGICAL::LLO3
CLASS (FIELD_2LM), POINTER :: YL_LLO1
LOGICAL, POINTER::LLO1 (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLFLAGUV
LOGICAL, POINTER::LLFLAGUV (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLFLAG
LOGICAL, POINTER::LLFLAG (:,:)
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM) :: JLON
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JLL
REAL (KIND=JPRB)::ZGLAC
REAL (KIND=JPRB)::ZOCUDET
REAL (KIND=JPRB)::ZZCO
REAL (KIND=JPRB)::ZVW
REAL (KIND=JPRB)::ZVV
REAL (KIND=JPRB)::ZVI
REAL (KIND=JPRB)::ZSEEN
REAL (KIND=JPRB)::ZSCDE
REAL (KIND=JPRB)::ZROLD
REAL (KIND=JPRB)::ZRNEW
REAL (KIND=JPRB)::ZQUDE
REAL (KIND=JPRB)::ZQEEN
REAL (KIND=JPRB)::ZPRCON
REAL (KIND=JPRB)::ZPRCDGW
REAL (KIND=JPRB)::ZOEALFAP
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZMFUSK
REAL (KIND=JPRB)::ZMFUQK
REAL (KIND=JPRB)::ZMFUN
REAL (KIND=JPRB)::ZMFULK
REAL (KIND=JPRB)::ZMFTEST
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZLNEW
REAL (KIND=JPRB)::ZLEEN
REAL (KIND=JPRB)::ZLCRIT
REAL (KIND=JPRB)::ZKEDKE
REAL (KIND=JPRB)::ZINT
REAL (KIND=JPRB)::ZFACBUO
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZDT
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZDNOPRC
REAL (KIND=JPRB)::ZDKEN
REAL (KIND=JPRB)::ZDKBUO
REAL (KIND=JPRB)::ZDFI
REAL (KIND=JPRB)::ZD
REAL (KIND=JPRB)::ZCONS2
REAL (KIND=JPRB)::ZCBF
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZBUOC
REAL (KIND=JPRB)::ZBE
REAL (KIND=JPRB)::ZBC
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::Z_CWIFRAC
REAL (KIND=JPRB)::Z_CWDRAG
REAL (KIND=JPRB)::Z_CPRC2
REAL (KIND=JPRB)::Z_CLDMAX
REAL (KIND=JPRB)::ZXPRCDGW
REAL (KIND=JPRB)::ZXENTSHALP
REAL (KIND=JPRB)::ZXENTRORG
LOGICAL::LLPERT_RPRCON
LOGICAL::LLPERT_ENTSHALP
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::IPRPRCON
INTEGER (KIND=JPIM)::IPENTSHALP
INTEGER (KIND=JPIM)::IPENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN1RPRCON
TYPE (SPP_PERT)::PN1ENTSHALP
TYPE (SPP_PERT)::PN1ENTRORG
REAL (KIND=JPRB)::ZXE
REAL (KIND=JPRB)::ZXS
REAL (KIND=JPRB)::ZCHANGE
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
CLASS (FIELD_2LM), POINTER :: YL_LLKLAB
LOGICAL, POINTER::LLKLAB (:,:)
#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ000
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
CLASS (FIELD_2LM), POINTER :: YL_LLFLAG_CUADJTQ000
LOGICAL, POINTER::LLFLAG_CUADJTQ000 (:,:)
#include "abor1.intfb.h"
#include "cuadjtq.func.h"
REAL (KIND=JPRB)::ZOEALFA_CUADJTQ001
CLASS (FIELD_2LM), POINTER :: YL_LLFLAG_CUADJTQ001
LOGICAL, POINTER::LLFLAG_CUADJTQ001 (:,:)
REAL (KIND=JPRB)::ZORCPD_CUBASMCN
REAL (KIND=JPRB)::ZRG_CUBASMCN
REAL (KIND=JPRB)::ZZZMB
LOGICAL::LLO1_CUENTR
LOGICAL::LLPERT_DETRPEN
INTEGER (KIND=JPIM)::IPDETRPEN
INTEGER (KIND=JPIM)::IPN_CUENTR
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZXDETRPEN
REAL (KIND=JPRB)::ZRG_CUENTR
REAL (KIND=JPRB)::ZMF
CLASS (FIELD_2RB), POINTER :: YL_ZENTR
REAL (KIND=JPRB), POINTER::ZENTR (:,:)
REAL (KIND=JPRB)::ZDZ
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL', 0, ZHOOK_HANDLE)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
CALL FIELD_NEW (YL_ZQOLD, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZPRECIP, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZPH, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZOENTR, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZLUOLD, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZENTR, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZDPMEAN, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZDMFEN, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZDMFDE, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZBUO, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLO1, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLKLAB, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLFLAG_CUADJTQ001, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLFLAG_CUADJTQ000, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLFLAGUV, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLFLAG, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)

ZCONS2=YDECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZRG=1.0_JPRB/YDCST%RG
ZORCPD=1.0_JPRB/YDCST%RCPD
ZFACBUO=0.5_JPRB/(1.5)
ZPRCDGW=YDECUMF%RPRCON/YDCST%RG
ZDNOPRC=3.E-4_JPRB
Z_CLDMAX=5.E-3_JPRB
Z_CWIFRAC=0.5_JPRB
Z_CPRC2=0.5_JPRB
Z_CWDRAG=(3._JPRB/8._JPRB)*0.506_JPRB/0.2_JPRB

IF (YDECUMF%LMFGLAC) THEN
  ZGLAC=1.0_JPRB
ELSE
  ZGLAC=0.0_JPRB
ENDIF

LLO3=.FALSE.
IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUASCN_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_HOST_DATA_RDWR (YD_KCBOT)
  KTYPE => GET_HOST_DATA_RDWR (YD_KTYPE)
  LDCUM => GET_HOST_DATA_RDONLY (YD_LDCUM)
  LLKLAB => GET_HOST_DATA_RDWR (YL_LLKLAB)
  LSCVFLAG => GET_HOST_DATA_RDWR (YD_LSCVFLAG)
  PMFUB => GET_HOST_DATA_RDWR (YD_PMFUB)
  PQU => GET_HOST_DATA_RDWR (YD_PQU)
  PWMEAN => GET_HOST_DATA_RDWR (YD_PWMEAN)
  ZDPMEAN => GET_HOST_DATA_RDWR (YL_ZDPMEAN)
  ZLUOLD => GET_HOST_DATA_RDWR (YL_ZLUOLD)
  ZOENTR => GET_HOST_DATA_RDWR (YL_ZOENTR)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JLON, LLPERT_ENTRORG, LLPERT_ENTSHALP, LLPERT_RPRCON) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
      ZLUOLD (JLON, JBLK)=0.0_JPRB

      IF (.NOT.LDCUM (JLON, JBLK)) THEN
        KCBOT (JLON, JBLK)=-1
        PMFUB (JLON, JBLK)=0.0_JPRB
        PQU (JLON, KLEV, JBLK)=0.0_JPRB
        KTYPE (JLON, JBLK)=0
      ENDIF

      PWMEAN (JLON, JBLK)=0.0_JPRB
      ZDPMEAN (JLON, JBLK)=0.0_JPRB
      ZOENTR (JLON, JBLK)=0.0_JPRB
      LSCVFLAG (JLON, JBLK)=.FALSE.

      IF (KTYPE (JLON, JBLK)>1.AND.YDECUMF%LSCVLIQ)  THEN
        LSCVFLAG (JLON, JBLK)=.TRUE.
      ENDIF

    ENDDO

    
    LLPERT_ENTRORG=.FALSE.
    LLPERT_ENTSHALP=.FALSE.
    LLPERT_RPRCON=.FALSE.

    

    DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
      LLKLAB (JLON, JBLK)=.FALSE.

      IF (.NOT.LDCUM (JLON, JBLK).OR.KTYPE (JLON, JBLK)==3)  THEN
        LLKLAB (JLON, JBLK)=.TRUE.
      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KTYPE => NULL ()
  LDCUM => NULL ()
  LLKLAB => NULL ()
  LSCVFLAG => NULL ()
  PMFUB => NULL ()
  PQU => NULL ()
  PWMEAN => NULL ()
  ZDPMEAN => NULL ()
  ZLUOLD => NULL ()
  ZOENTR => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUASCN_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_DEVICE_DATA_RDWR (YD_KCBOT)
  KTYPE => GET_DEVICE_DATA_RDWR (YD_KTYPE)
  LDCUM => GET_DEVICE_DATA_RDONLY (YD_LDCUM)
  LLKLAB => GET_DEVICE_DATA_RDWR (YL_LLKLAB)
  LSCVFLAG => GET_DEVICE_DATA_RDWR (YD_LSCVFLAG)
  PMFUB => GET_DEVICE_DATA_RDWR (YD_PMFUB)
  PQU => GET_DEVICE_DATA_RDWR (YD_PQU)
  PWMEAN => GET_DEVICE_DATA_RDWR (YD_PWMEAN)
  ZDPMEAN => GET_DEVICE_DATA_RDWR (YL_ZDPMEAN)
  ZLUOLD => GET_DEVICE_DATA_RDWR (YL_ZLUOLD)
  ZOENTR => GET_DEVICE_DATA_RDWR (YL_ZOENTR)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (KCBOT, KTYPE, LDCUM, LLKLAB, LSCVFLAG, PMFUB, PQU, PWMEAN, YFXTRAN_ACDC_STACK, &
    !$ACC&         ZDPMEAN, ZLUOLD, ZOENTR) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLON, LLPERT_ENTRORG, LLPERT_ENTSHALP, LLPERT_RPRCON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      
      
      ZLUOLD (JLON, JBLK)=0.0_JPRB

      IF (.NOT.LDCUM (JLON, JBLK)) THEN
        KCBOT (JLON, JBLK)=-1
        PMFUB (JLON, JBLK)=0.0_JPRB
        PQU (JLON, KLEV, JBLK)=0.0_JPRB
        KTYPE (JLON, JBLK)=0
      ENDIF

      PWMEAN (JLON, JBLK)=0.0_JPRB
      ZDPMEAN (JLON, JBLK)=0.0_JPRB
      ZOENTR (JLON, JBLK)=0.0_JPRB
      LSCVFLAG (JLON, JBLK)=.FALSE.

      IF (KTYPE (JLON, JBLK)>1.AND.YDECUMF%LSCVLIQ)  THEN
        LSCVFLAG (JLON, JBLK)=.TRUE.
      ENDIF

      
      
      LLPERT_ENTRORG=.FALSE.
      LLPERT_ENTSHALP=.FALSE.
      LLPERT_RPRCON=.FALSE.
      
      
      LLKLAB (JLON, JBLK)=.FALSE.

      IF (.NOT.LDCUM (JLON, JBLK).OR.KTYPE (JLON, JBLK)==3)  THEN
        LLKLAB (JLON, JBLK)=.TRUE.
      ENDIF

    
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KTYPE => NULL ()
  LDCUM => NULL ()
  LLKLAB => NULL ()
  LSCVFLAG => NULL ()
  PMFUB => NULL ()
  PQU => NULL ()
  PWMEAN => NULL ()
  ZDPMEAN => NULL ()
  ZLUOLD => NULL ()
  ZOENTR => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUASCN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:0',1,ZHOOK_HANDLE_PARALLEL)
IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUASCN_PARALLEL:1')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_HOST_DATA_RDONLY (YD_KCBOT)
  KCTOP => GET_HOST_DATA_RDWR (YD_KCTOP)
  KCTOP0 => GET_HOST_DATA_RDWR (YD_KCTOP0)
  KLAB => GET_HOST_DATA_RDWR (YD_KLAB)
  KTYPE => GET_HOST_DATA_RDONLY (YD_KTYPE)
  LDCUM => GET_HOST_DATA_RDWR (YD_LDCUM)
  LLKLAB => GET_HOST_DATA_RDONLY (YL_LLKLAB)
  PAPH => GET_HOST_DATA_RDONLY (YD_PAPH)
  PDMFEN => GET_HOST_DATA_RDWR (YD_PDMFEN)
  PDMFUP => GET_HOST_DATA_RDWR (YD_PDMFUP)
  PGEOH => GET_HOST_DATA_RDONLY (YD_PGEOH)
  PKINEU => GET_HOST_DATA_RDWR (YD_PKINEU)
  PLGLAC => GET_HOST_DATA_RDWR (YD_PLGLAC)
  PLRAIN => GET_HOST_DATA_RDWR (YD_PLRAIN)
  PLU => GET_HOST_DATA_RDWR (YD_PLU)
  PLUDE => GET_HOST_DATA_RDWR (YD_PLUDE)
  PLUDELI => GET_HOST_DATA_RDWR (YD_PLUDELI)
  PMFU => GET_HOST_DATA_RDWR (YD_PMFU)
  PMFUB => GET_HOST_DATA_RDONLY (YD_PMFUB)
  PMFUDE_RATE => GET_HOST_DATA_RDWR (YD_PMFUDE_RATE)
  PMFUL => GET_HOST_DATA_RDWR (YD_PMFUL)
  PMFUQ => GET_HOST_DATA_RDWR (YD_PMFUQ)
  PMFUS => GET_HOST_DATA_RDWR (YD_PMFUS)
  PQU => GET_HOST_DATA_RDONLY (YD_PQU)
  PTU => GET_HOST_DATA_RDONLY (YD_PTU)
  PWU => GET_HOST_DATA_RDWR (YD_PWU)
  PWUBASE => GET_HOST_DATA_RDONLY (YD_PWUBASE)
  ZBUO => GET_HOST_DATA_RDWR (YL_ZBUO)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (IKB, JBLK, JK, JLON) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JK=1, KLEV

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

        IF (JK/=KCBOT (JLON, JBLK)) THEN
          PLU (JLON, JK, JBLK)=0.0_JPRB
        ENDIF

        PKINEU (JLON, JK, JBLK)=0.0_JPRB
      ENDDO


      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        PMFU (JLON, JK, JBLK)=0.0_JPRB
        PMFUS (JLON, JK, JBLK)=0.0_JPRB
        PMFUQ (JLON, JK, JBLK)=0.0_JPRB
        PMFUL (JLON, JK, JBLK)=0.0_JPRB
        PWU (JLON, JK, JBLK)=0.0_JPRB
      ENDDO


      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        PLUDE (JLON, JK, JBLK)=0.0_JPRB
        PLUDELI (JLON, JK, 1, JBLK)=0.0_JPRB
        PLUDELI (JLON, JK, 2, JBLK)=0.0_JPRB
        PLGLAC (JLON, JK, JBLK)=0.0_JPRB
        PDMFUP (JLON, JK, JBLK)=0.0_JPRB
        PLRAIN (JLON, JK, JBLK)=0.0_JPRB
      ENDDO


      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        ZBUO (JLON, JK, JBLK)=0.0_JPRB

        IF (LLKLAB (JLON, JBLK))  THEN
          KLAB (JLON, JK, JBLK)=0
        ENDIF


        IF (.NOT.LDCUM (JLON, JBLK).AND.PAPH (JLON, JK, JBLK)<4.E4_JPRB)  THEN
          KCTOP0 (JLON, JBLK)=JK
        ENDIF

        PDMFEN (JLON, JK, JBLK)=0.0_JPRB
        PMFUDE_RATE (JLON, JK, JBLK)=0.0_JPRB
      ENDDO

    ENDDO


    DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

      IF (KTYPE (JLON, JBLK)==3)  THEN
        LDCUM (JLON, JBLK)=.FALSE.
      ENDIF

    ENDDO


    DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
      KCTOP (JLON, JBLK)=KCBOT (JLON, JBLK)

      IF (LDCUM (JLON, JBLK)) THEN
        IKB=KCBOT (JLON, JBLK)
        PKINEU (JLON, IKB, JBLK)=0.5*PWUBASE (JLON, JBLK)**2
        PMFU (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)
        PMFUS (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)*(YDCST%RCPD&
        &*PTU (JLON, IKB, JBLK)+PGEOH (JLON, IKB, JBLK))
        PMFUQ (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)*PQU (JLON, IKB, JBLK)
        PMFUL (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)*PLU (JLON, IKB, JBLK)
      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KCTOP => NULL ()
  KCTOP0 => NULL ()
  KLAB => NULL ()
  KTYPE => NULL ()
  LDCUM => NULL ()
  LLKLAB => NULL ()
  PAPH => NULL ()
  PDMFEN => NULL ()
  PDMFUP => NULL ()
  PGEOH => NULL ()
  PKINEU => NULL ()
  PLGLAC => NULL ()
  PLRAIN => NULL ()
  PLU => NULL ()
  PLUDE => NULL ()
  PLUDELI => NULL ()
  PMFU => NULL ()
  PMFUB => NULL ()
  PMFUDE_RATE => NULL ()
  PMFUL => NULL ()
  PMFUQ => NULL ()
  PMFUS => NULL ()
  PQU => NULL ()
  PTU => NULL ()
  PWU => NULL ()
  PWUBASE => NULL ()
  ZBUO => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUASCN_PARALLEL:1')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_DEVICE_DATA_RDONLY (YD_KCBOT)
  KCTOP => GET_DEVICE_DATA_RDWR (YD_KCTOP)
  KCTOP0 => GET_DEVICE_DATA_RDWR (YD_KCTOP0)
  KLAB => GET_DEVICE_DATA_RDWR (YD_KLAB)
  KTYPE => GET_DEVICE_DATA_RDONLY (YD_KTYPE)
  LDCUM => GET_DEVICE_DATA_RDWR (YD_LDCUM)
  LLKLAB => GET_DEVICE_DATA_RDONLY (YL_LLKLAB)
  PAPH => GET_DEVICE_DATA_RDONLY (YD_PAPH)
  PDMFEN => GET_DEVICE_DATA_RDWR (YD_PDMFEN)
  PDMFUP => GET_DEVICE_DATA_RDWR (YD_PDMFUP)
  PGEOH => GET_DEVICE_DATA_RDONLY (YD_PGEOH)
  PKINEU => GET_DEVICE_DATA_RDWR (YD_PKINEU)
  PLGLAC => GET_DEVICE_DATA_RDWR (YD_PLGLAC)
  PLRAIN => GET_DEVICE_DATA_RDWR (YD_PLRAIN)
  PLU => GET_DEVICE_DATA_RDWR (YD_PLU)
  PLUDE => GET_DEVICE_DATA_RDWR (YD_PLUDE)
  PLUDELI => GET_DEVICE_DATA_RDWR (YD_PLUDELI)
  PMFU => GET_DEVICE_DATA_RDWR (YD_PMFU)
  PMFUB => GET_DEVICE_DATA_RDONLY (YD_PMFUB)
  PMFUDE_RATE => GET_DEVICE_DATA_RDWR (YD_PMFUDE_RATE)
  PMFUL => GET_DEVICE_DATA_RDWR (YD_PMFUL)
  PMFUQ => GET_DEVICE_DATA_RDWR (YD_PMFUQ)
  PMFUS => GET_DEVICE_DATA_RDWR (YD_PMFUS)
  PQU => GET_DEVICE_DATA_RDONLY (YD_PQU)
  PTU => GET_DEVICE_DATA_RDONLY (YD_PTU)
  PWU => GET_DEVICE_DATA_RDWR (YD_PWU)
  PWUBASE => GET_DEVICE_DATA_RDONLY (YD_PWUBASE)
  ZBUO => GET_DEVICE_DATA_RDWR (YL_ZBUO)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (KCBOT, KCTOP, KCTOP0, KLAB, KTYPE, LDCUM, LLKLAB, PAPH, PDMFEN, PDMFUP, &
    !$ACC&         PGEOH, PKINEU, PLGLAC, PLRAIN, PLU, PLUDE, PLUDELI, PMFU, PMFUB, PMFUDE_RATE, &
    !$ACC&         PMFUL, PMFUQ, PMFUS, PQU, PTU, PWU, PWUBASE, YFXTRAN_ACDC_STACK, ZBUO) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (IKB, JK, JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      DO JK=1, KLEV

        

        IF (JK/=KCBOT (JLON, JBLK)) THEN
          PLU (JLON, JK, JBLK)=0.0_JPRB
        ENDIF

        PKINEU (JLON, JK, JBLK)=0.0_JPRB
        
        
        PMFU (JLON, JK, JBLK)=0.0_JPRB
        PMFUS (JLON, JK, JBLK)=0.0_JPRB
        PMFUQ (JLON, JK, JBLK)=0.0_JPRB
        PMFUL (JLON, JK, JBLK)=0.0_JPRB
        PWU (JLON, JK, JBLK)=0.0_JPRB
        
        
        PLUDE (JLON, JK, JBLK)=0.0_JPRB
        PLUDELI (JLON, JK, 1, JBLK)=0.0_JPRB
        PLUDELI (JLON, JK, 2, JBLK)=0.0_JPRB
        PLGLAC (JLON, JK, JBLK)=0.0_JPRB
        PDMFUP (JLON, JK, JBLK)=0.0_JPRB
        PLRAIN (JLON, JK, JBLK)=0.0_JPRB
        
        
        ZBUO (JLON, JK, JBLK)=0.0_JPRB

        IF (LLKLAB (JLON, JBLK))  THEN
          KLAB (JLON, JK, JBLK)=0
        ENDIF


        IF (.NOT.LDCUM (JLON, JBLK).AND.PAPH (JLON, JK, JBLK)<4.E4_JPRB)  THEN
          KCTOP0 (JLON, JBLK)=JK
        ENDIF

        PDMFEN (JLON, JK, JBLK)=0.0_JPRB
        PMFUDE_RATE (JLON, JK, JBLK)=0.0_JPRB
      
      ENDDO


      

      IF (KTYPE (JLON, JBLK)==3)  THEN
        LDCUM (JLON, JBLK)=.FALSE.
      ENDIF

      
      
      KCTOP (JLON, JBLK)=KCBOT (JLON, JBLK)

      IF (LDCUM (JLON, JBLK)) THEN
        IKB=KCBOT (JLON, JBLK)
        PKINEU (JLON, IKB, JBLK)=0.5*PWUBASE (JLON, JBLK)**2
        PMFU (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)
        PMFUS (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)*(YDCST%RCPD&
        &*PTU (JLON, IKB, JBLK)+PGEOH (JLON, IKB, JBLK))
        PMFUQ (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)*PQU (JLON, IKB, JBLK)
        PMFUL (JLON, IKB, JBLK)=PMFUB (JLON, JBLK)*PLU (JLON, IKB, JBLK)
      ENDIF

    
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KCTOP => NULL ()
  KCTOP0 => NULL ()
  KLAB => NULL ()
  KTYPE => NULL ()
  LDCUM => NULL ()
  LLKLAB => NULL ()
  PAPH => NULL ()
  PDMFEN => NULL ()
  PDMFUP => NULL ()
  PGEOH => NULL ()
  PKINEU => NULL ()
  PLGLAC => NULL ()
  PLRAIN => NULL ()
  PLU => NULL ()
  PLUDE => NULL ()
  PLUDELI => NULL ()
  PMFU => NULL ()
  PMFUB => NULL ()
  PMFUDE_RATE => NULL ()
  PMFUL => NULL ()
  PMFUQ => NULL ()
  PMFUS => NULL ()
  PQU => NULL ()
  PTU => NULL ()
  PWU => NULL ()
  PWUBASE => NULL ()
  ZBUO => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUASCN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:1',1,ZHOOK_HANDLE_PARALLEL)
IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUASCN_PARALLEL:2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_HOST_DATA_RDWR (YD_KCBOT)
  KCTOP => GET_HOST_DATA_RDWR (YD_KCTOP)
  KDPL => GET_HOST_DATA_RDONLY (YD_KDPL)
  KLAB => GET_HOST_DATA_RDWR (YD_KLAB)
  KTYPE => GET_HOST_DATA_RDWR (YD_KTYPE)
  LDCUM => GET_HOST_DATA_RDWR (YD_LDCUM)
  LLFLAG => GET_HOST_DATA_RDWR (YL_LLFLAG)
  LLFLAGUV => GET_HOST_DATA_RDWR (YL_LLFLAGUV)
  LLFLAG_CUADJTQ000 => GET_HOST_DATA_RDWR (YL_LLFLAG_CUADJTQ000)
  LLFLAG_CUADJTQ001 => GET_HOST_DATA_RDWR (YL_LLFLAG_CUADJTQ001)
  LLO1 => GET_HOST_DATA_RDWR (YL_LLO1)
  LSCVFLAG => GET_HOST_DATA_RDONLY (YD_LSCVFLAG)
  PAP => GET_HOST_DATA_RDONLY (YD_PAP)
  PAPH => GET_HOST_DATA_RDONLY (YD_PAPH)
  PDMFEN => GET_HOST_DATA_RDWR (YD_PDMFEN)
  PDMFUP => GET_HOST_DATA_RDWR (YD_PDMFUP)
  PGEO => GET_HOST_DATA_RDONLY (YD_PGEO)
  PGEOH => GET_HOST_DATA_RDONLY (YD_PGEOH)
  PKINEU => GET_HOST_DATA_RDWR (YD_PKINEU)
  PLCRIT_AER => GET_HOST_DATA_RDONLY (YD_PLCRIT_AER)
  PLGLAC => GET_HOST_DATA_RDWR (YD_PLGLAC)
  PLITOT => GET_HOST_DATA_RDONLY (YD_PLITOT)
  PLRAIN => GET_HOST_DATA_RDWR (YD_PLRAIN)
  PLU => GET_HOST_DATA_RDWR (YD_PLU)
  PLUDE => GET_HOST_DATA_RDWR (YD_PLUDE)
  PLUDELI => GET_HOST_DATA_RDWR (YD_PLUDELI)
  PMFU => GET_HOST_DATA_RDWR (YD_PMFU)
  PMFUB => GET_HOST_DATA_RDWR (YD_PMFUB)
  PMFUDE_RATE => GET_HOST_DATA_RDWR (YD_PMFUDE_RATE)
  PMFUL => GET_HOST_DATA_RDWR (YD_PMFUL)
  PMFUQ => GET_HOST_DATA_RDWR (YD_PMFUQ)
  PMFUS => GET_HOST_DATA_RDWR (YD_PMFUS)
  PQEN => GET_HOST_DATA_RDONLY (YD_PQEN)
  PQENH => GET_HOST_DATA_RDWR (YD_PQENH)
  PQSEN => GET_HOST_DATA_RDONLY (YD_PQSEN)
  PQU => GET_HOST_DATA_RDWR (YD_PQU)
  PTEN => GET_HOST_DATA_RDONLY (YD_PTEN)
  PTENH => GET_HOST_DATA_RDWR (YD_PTENH)
  PTU => GET_HOST_DATA_RDWR (YD_PTU)
  PVERVEL => GET_HOST_DATA_RDONLY (YD_PVERVEL)
  PWMEAN => GET_HOST_DATA_RDWR (YD_PWMEAN)
  PWU => GET_HOST_DATA_RDWR (YD_PWU)
  ZBUO => GET_HOST_DATA_RDWR (YL_ZBUO)
  ZDMFDE => GET_HOST_DATA_RDWR (YL_ZDMFDE)
  ZDMFEN => GET_HOST_DATA_RDWR (YL_ZDMFEN)
  ZDPMEAN => GET_HOST_DATA_RDWR (YL_ZDPMEAN)
  ZENTR => GET_HOST_DATA_RDWR (YL_ZENTR)
  ZLUOLD => GET_HOST_DATA_RDWR (YL_ZLUOLD)
  ZOENTR => GET_HOST_DATA_RDWR (YL_ZOENTR)
  ZPH => GET_HOST_DATA_RDWR (YL_ZPH)
  ZPRECIP => GET_HOST_DATA_RDWR (YL_ZPRECIP)
  ZQOLD => GET_HOST_DATA_RDWR (YL_ZQOLD)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (IK, IKB, IS, JBLK, JK, JLON, LLO1_CUENTR, LLO3, LLPERT_DETRPEN, Z1S, Z2S, ZALFAW, ZBC, ZBE, ZBUOC, ZC, ZCBF, ZCHANGE, ZCOND, ZCOND1, ZCOR, ZD, ZDFI, ZDKBUO, ZDKEN, ZDT, ZDZ, ZF, ZFAC, ZFOEEWI, ZFOEEWL, ZI, ZINT, ZKEDKE, ZL, ZLCRIT, ZLEEN, ZLNEW, ZMF, ZMFMAX, ZMFTEST, ZMFULK, ZMFUN, ZMFUQK, ZMFUSK, ZOCUDET, ZOEALFA, ZOEALFAP, ZOEALFA_CUADJTQ001, ZORCPD_CUBASMCN, ZPRCON, ZQEEN, ZQMAX, ZQP, ZQSAT, ZQUDE, ZRG_CUBASMCN, ZRG_CUENTR, ZRNEW, ZROLD, ZSCDE, ZSEEN, ZTARG, ZVI, ZVV, ZVW, ZXDETRPEN, ZXE, ZXENTRORG, ZXENTSHALP, ZXPRCDGW, ZXS, ZZCO, ZZZMB) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JK=KLEV-1, 3,-1
      IK=JK
      
      
      ZRG_CUBASMCN=1.0_JPRB/YDCST%RG
      ZORCPD_CUBASMCN=1.0_JPRB/YDCST%RCPD

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

        IF (.NOT.LDCUM (JLON, JBLK).AND.KLAB (JLON, IK+1, JBLK)==0) THEN

          IF (YDECUMF%LMFMID.AND.IK>YDECUMF%NJKT7.AND.PQEN (JLON&
            &, IK, JBLK)>0.80_JPRB*PQSEN (JLON, IK, JBLK)) THEN
            PTU (JLON, IK+1, JBLK)=(YDCST%RCPD*PTEN (JLON, IK, JBLK)+PGEO &
            &(JLON, IK, JBLK)-PGEOH (JLON, IK+1, JBLK))*ZORCPD_CUBASMCN
            PQU (JLON, IK+1, JBLK)=PQEN (JLON, IK, JBLK)
            PLU (JLON, IK+1, JBLK)=0.0_JPRB
            ZZZMB=MAX (1.E-6_JPRB,-PVERVEL (JLON, IK, JBLK)*ZRG_CUBASMCN)
            ZZZMB=MIN (ZZZMB, YDECUMF%RMFLIA)
            PMFUB (JLON, JBLK)=ZZZMB
            PMFU (JLON, IK+1, JBLK)=PMFUB (JLON, JBLK)
            PMFUS (JLON, IK+1, JBLK)=PMFUB (JLON, JBLK)*(YDCST%RCPD&
            &*PTU (JLON, IK+1, JBLK)+PGEOH (JLON, IK+1, JBLK))
            PMFUQ (JLON, IK+1, JBLK)=PMFUB (JLON, JBLK)*PQU (JLON, IK+1, JBLK)
            PMFUL (JLON, IK+1, JBLK)=0.0_JPRB
            PDMFUP (JLON, IK+1, JBLK)=0.0_JPRB
            PLRAIN (JLON, IK+1, JBLK)=0.0_JPRB
            KCBOT (JLON, JBLK)=IK
            KLAB (JLON, IK+1, JBLK)=1
            KTYPE (JLON, JBLK)=3
          ENDIF

        ENDIF

      ENDDO

      
      
      
      IS=0

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        LLFLAG (JLON, JBLK)=.FALSE.
        ZPRECIP (JLON, JBLK)=0.0_JPRB
        LLO1 (JLON, JBLK)=.FALSE.
        IS=IS+KLAB (JLON, JK+1, JBLK)

        IF (KLAB (JLON, JK+1, JBLK)==0)  THEN
          KLAB (JLON, JK, JBLK)=0
        ENDIF


        IF ((LDCUM (JLON, JBLK).AND.KLAB (JLON, JK+1, JBLK)==2).OR.(KTYPE&
          & (JLON, JBLK)==3.AND.KLAB (JLON, JK+1, JBLK)==1)) THEN
          LLFLAG (JLON, JBLK)=.TRUE.
        ENDIF


        IF (KLAB (JLON, JK+1, JBLK)>0) THEN
          LLFLAGUV (JLON, JBLK)=.TRUE.
        ELSE
          LLFLAGUV (JLON, JBLK)=.FALSE.
        ENDIF

        ZPH (JLON, JBLK)=PAPH (JLON, JK, JBLK)

        IF (KTYPE (JLON, JBLK)==3.AND.JK==KCBOT (JLON, JBLK)) THEN
          ZMFMAX=(PAPH (JLON, JK, JBLK)-PAPH (JLON, JK-1, JBLK))*ZCONS2

          IF (PMFUB (JLON, JBLK)>ZMFMAX) THEN
            ZFAC=ZMFMAX/PMFUB (JLON, JBLK)
            PMFU (JLON, JK+1, JBLK)=PMFU (JLON, JK+1, JBLK)*ZFAC
            PMFUS (JLON, JK+1, JBLK)=PMFUS (JLON, JK+1, JBLK)*ZFAC
            PMFUQ (JLON, JK+1, JBLK)=PMFUQ (JLON, JK+1, JBLK)*ZFAC
            PMFUB (JLON, JBLK)=ZMFMAX
          ENDIF

        ENDIF

      ENDDO


      IF (IS>0)  THEN
        LLO3=.TRUE.
      ENDIF

      IK=JK

      

      

      IF (LLO3) THEN
        ZRG_CUENTR=1.0_JPRB/YDCST%RG
        
        LLPERT_DETRPEN=.FALSE.

        

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          ZDMFEN (JLON, JBLK)=0.0_JPRB
          ZDMFDE (JLON, JBLK)=0.0_JPRB
          ZENTR (JLON, JBLK)=0.0
        ENDDO


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LDCUM (JLON, JBLK)) THEN
            ZDZ=(PGEOH (JLON, IK, JBLK)-PGEOH (JLON, IK+1, JBLK))*ZRG_CUENTR
            ZMF=PMFU (JLON, IK+1, JBLK)*ZDZ
            LLO1_CUENTR=IK<KCBOT (JLON, JBLK)

            IF (LLO1_CUENTR) THEN
              
              ZXDETRPEN=YDECUMF%DETRPEN
              
              ZDMFEN (JLON, JBLK)=ZENTR (JLON, JBLK)*ZMF
              ZDMFDE (JLON, JBLK)=ZXDETRPEN*ZMF
            ENDIF

          ENDIF

        ENDDO

      ENDIF


      

      

      

      IF (LLO3) THEN

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          ZQOLD (JLON, JBLK)=0.0_JPRB
        ENDDO


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LLFLAG (JLON, JBLK)) THEN
            ZDMFDE (JLON, JBLK)=MIN (ZDMFDE (JLON, JBLK), 0.75_JPRB*PMFU (JLON, JK+1, JBLK))

            IF (JK==KCBOT (JLON, JBLK)) THEN
              
              ZXENTRORG=YDECUMF%ENTRORG
              
              ZOENTR (JLON, JBLK)=-ZXENTRORG*(MIN (1.0_JPRB, PQEN (JLON, JK, JBLK)/PQSEN (JLON, JK&
              &, JBLK))-YDECUMF%ENTR_RH)*(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZRG
              ZOENTR (JLON, JBLK)=MIN (0.4_JPRB, ZOENTR (JLON, JBLK))*PMFU (JLON, JK+1, JBLK)
            ENDIF


            IF (JK<KCBOT (JLON, JBLK)) THEN
              ZMFMAX=(PAPH (JLON, JK, JBLK)-PAPH (JLON, JK-1, JBLK))*ZCONS2
              ZXS=MAX (PMFU (JLON, JK+1, JBLK)-ZMFMAX, 0.0_JPRB)
              PWMEAN (JLON, JBLK)=PWMEAN (JLON, JBLK)+PKINEU (JLON, JK+1&
              &, JBLK)*(PAP (JLON, JK+1, JBLK)-PAP (JLON, JK, JBLK))
              ZDPMEAN (JLON, JBLK)=ZDPMEAN (JLON, JBLK)+PAP (JLON, JK+1, JBLK)-PAP (JLON, JK, JBLK)
              ZDMFEN (JLON, JBLK)=ZOENTR (JLON, JBLK)

              IF (KTYPE (JLON, JBLK)>=2) THEN
                
                ZXENTSHALP=YDECUMF%ENTSHALP
                
                ZDMFEN (JLON, JBLK)=ZXENTSHALP*ZDMFEN (JLON, JBLK)
                ZDMFDE (JLON, JBLK)=ZDMFEN (JLON, JBLK)
              ENDIF

              ZDMFDE (JLON, JBLK)=ZDMFDE (JLON, JBLK)*(1.6_JPRB-MIN (1.0_JPRB&
              &, PQEN (JLON, JK, JBLK)/PQSEN (JLON, JK, JBLK)))
              ZMFTEST=PMFU (JLON, JK+1, JBLK)+ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
              ZCHANGE=MAX (ZMFTEST-ZMFMAX, 0.0_JPRB)
              ZXE=MAX (ZCHANGE-ZXS, 0.0_JPRB)
              ZDMFEN (JLON, JBLK)=ZDMFEN (JLON, JBLK)-ZXE
              ZCHANGE=ZCHANGE-ZXE
              ZDMFDE (JLON, JBLK)=ZDMFDE (JLON, JBLK)+ZCHANGE
            ENDIF

            PDMFEN (JLON, JK, JBLK)=ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
            PMFU (JLON, JK, JBLK)=PMFU (JLON, JK+1, JBLK)+ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
            ZQEEN=PQENH (JLON, JK+1, JBLK)*ZDMFEN (JLON, JBLK)
            ZSEEN=(YDCST%RCPD*PTENH (JLON, JK+1, JBLK)+PGEOH (JLON, JK+1, JBLK))*ZDMFEN (JLON, JBLK)

            IF (PLITOT (JLON, JK, JBLK)>YDECLDP%RLMIN) THEN
              ZLEEN=PLITOT (JLON, JK, JBLK)*ZDMFEN (JLON, JBLK)
            ELSE
              ZLEEN=0.0_JPRB
            ENDIF

            ZSCDE=(YDCST%RCPD*PTU (JLON, JK+1, JBLK)+PGEOH (JLON, JK+1, JBLK))*ZDMFDE (JLON, JBLK)
            ZQUDE=PQU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
            PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
            ZMFUSK=PMFUS (JLON, JK+1, JBLK)+ZSEEN-ZSCDE
            ZMFUQK=PMFUQ (JLON, JK+1, JBLK)+ZQEEN-ZQUDE
            ZMFULK=PMFUL (JLON, JK+1, JBLK)+ZLEEN-PLUDE (JLON, JK, JBLK)
            ZFAC=1.0_JPRB/MAX (YDECUMF%RMFCMIN, PMFU (JLON, JK, JBLK))
            PLU (JLON, JK, JBLK)=ZMFULK*ZFAC
            PQU (JLON, JK, JBLK)=ZMFUQK*ZFAC
            PTU (JLON, JK, JBLK)=(ZMFUSK*ZFAC-PGEOH (JLON, JK, JBLK))*ZORCPD
            PTU (JLON, JK, JBLK)=MAX (100._JPRB, PTU (JLON, JK, JBLK))
            PTU (JLON, JK, JBLK)=MIN (400._JPRB, PTU (JLON, JK, JBLK))
            ZQOLD (JLON, JBLK)=PQU (JLON, JK, JBLK)
            PLRAIN (JLON, JK, JBLK)=PLRAIN (JLON, JK+1, JBLK)*MAX (0.0_JPRB&
            &, PMFU (JLON, JK+1, JBLK)-ZDMFDE (JLON, JBLK))*ZFAC
            ZLUOLD (JLON, JBLK)=PLU (JLON, JK, JBLK)
          ENDIF

        ENDDO


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (JK>KDPL (JLON, JBLK)) THEN
            PTU (JLON, JK, JBLK)=PTENH (JLON, JK, JBLK)
            PQU (JLON, JK, JBLK)=PQENH (JLON, JK, JBLK)
            PLU (JLON, JK, JBLK)=0.0_JPRB
            ZLUOLD (JLON, JBLK)=PLU (JLON, JK, JBLK)
          ENDIF

        ENDDO

        IK=JK

        IF (YDECUMF%LSCVLIQ) THEN
          
          
          ZQMAX=0.5_JPRB

          IF (.NOT.YDEPHLI%LPHYLIN) THEN
            
            LLFLAG_CUADJTQ000 (:, JBLK)=LLFLAG (:, JBLK)
            
            
            LLFLAG_CUADJTQ000 (:, JBLK)=LLFLAG_CUADJTQ000 (:, JBLK).AND..NOT.LSCVFLAG (:, JBLK)

            

            

            DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

              IF (LLFLAG_CUADJTQ000 (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=MIN (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
                ZCOND=MAX (ZCOND, 0.0_JPRB)
                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND1=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

                IF (ZCOND==0.0_JPRB)  THEN
                  ZCOND1=0.0_JPRB
                ENDIF

                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND1
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            ENDDO


            

            DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

              IF (LLFLAG (JLON, JBLK).AND.LSCVFLAG (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZL)
                ZQSAT=ZQSAT*ZQP
                ZQSAT=MIN (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=YDTHF%R5ALVCP*ZL**2
                ZCOND=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
                ZCOND=MAX (ZCOND, 0.0_JPRB)
                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+YDTHF%RALVDCP*ZCOND
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZL)
                ZQSAT=ZQSAT*ZQP
                ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=YDTHF%R5ALVCP*ZL**2
                ZCOND1=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

                IF (ZCOND==0.0_JPRB)  THEN
                  ZCOND1=0.0_JPRB
                ENDIF

                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+YDTHF%RALVDCP*ZCOND1
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            ENDDO

          
          
          
          
          
          
          
          ELSE
          
          
          
          
          ENDIF

        
        
        
        ELSE
          
          
          ZQMAX=0.5_JPRB

          IF (.NOT.YDEPHLI%LPHYLIN) THEN
            
            LLFLAG_CUADJTQ001 (:, JBLK)=LLFLAG (:, JBLK)

            

            DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

              IF (LLFLAG_CUADJTQ001 (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=MIN (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
                ZCOND=MAX (ZCOND, 0.0_JPRB)
                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND1=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

                IF (ZCOND==0.0_JPRB)  THEN
                  ZCOND1=0.0_JPRB
                ENDIF

                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND1
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            ENDDO

          
          
          
          
          
          
          
          ELSE

            

            DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

              IF (LLFLAG (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZTARG=PTU (JLON, IK, JBLK)
                ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
                Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                ZQSAT=ZQSAT*ZCOR
                Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                ZCOND=(PQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
                ZCOND=MAX (ZCOND, 0.0_JPRB)

                IF (ZCOND/=0.0_JPRB) THEN
                  PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+(ZOEALFA_CUADJTQ001*YDTHF&
                  &%RALVDCP+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND
                  PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                  ZTARG=PTU (JLON, IK, JBLK)
                  ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                  ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                  ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                  ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
                  Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                  ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                  ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                  ZQSAT=ZQSAT*ZCOR
                  Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                  &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                  ZCOND1=(PQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
                  PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+(ZOEALFA_CUADJTQ001*YDTHF&
                  &%RALVDCP+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND1
                  PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
                ENDIF

              ENDIF

            ENDDO

          
          
          
          
          ENDIF

        
        
        
        ENDIF


        IF (YDEPHLI%LPHYLIN) THEN

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLFLAG (JLON, JBLK)) THEN

              IF (PQU (JLON, JK, JBLK)/=ZQOLD (JLON, JBLK)) THEN
                ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JLON, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
                ZOEALFAP=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU&
                & (JLON, JK+1, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
                PLGLAC (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)*((1.0_JPRB-ZOEALFA)-(1.0_JPRB-ZOEALFAP))
                ZFAC=0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JLON, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB)
                PLGLAC (JLON, JK, JBLK)=PLGLAC (JLON, JK, JBLK)+ZFAC*PDMFUP (JLON, JK+1, JBLK)/MAX (YDECUMF%RMFCMIN&
                &, PMFU (JLON, JK+1, JBLK))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JLON, JK, JBLK)))*ZGLAC
                PTU (JLON, JK, JBLK)=PTU (JLON, JK, JBLK)+YDTHF%RALFDCP*PLGLAC (JLON, JK, JBLK)
              ENDIF

            ENDIF

          ENDDO

        ELSE

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLFLAG (JLON, JBLK)) THEN

              IF (PQU (JLON, JK, JBLK)/=ZQOLD (JLON, JBLK)) THEN
                PLGLAC (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)*((1.0_JPRB-FOEALFCU (PTU&
                & (JLON, JK, JBLK)))-(1.0_JPRB-FOEALFCU (PTU (JLON, JK+1, JBLK))))

                IF (LSCVFLAG (JLON, JBLK))  THEN
                  PLGLAC (JLON, JK, JBLK)=0.0_JPRB
                ENDIF

                ZFAC=FOEALFCU (PTEN (JLON, JK, JBLK))
                PLGLAC (JLON, JK, JBLK)=PLGLAC (JLON, JK, JBLK)+ZFAC*PDMFUP (JLON, JK+1, JBLK)/MAX (YDECUMF%RMFCMIN&
                &, PMFU (JLON, JK+1, JBLK))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JLON, JK, JBLK)))*ZGLAC
                PTU (JLON, JK, JBLK)=PTU (JLON, JK, JBLK)+YDTHF%RALFDCP*PLGLAC (JLON, JK, JBLK)
              ENDIF

            ENDIF

          ENDDO

        ENDIF


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LLFLAG (JLON, JBLK)) THEN

            IF (PQU (JLON, JK, JBLK)/=ZQOLD (JLON, JBLK)) THEN
              KLAB (JLON, JK, JBLK)=2
              PLU (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)+ZQOLD (JLON, JBLK)-PQU (JLON, JK, JBLK)
              ZBC=PTU (JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQU (JLON, JK,&
              & JBLK)-PLU (JLON, JK+1, JBLK)-PLRAIN (JLON, JK+1, JBLK))
              ZBE=PTENH (JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JLON, JK, JBLK))
              ZBUO (JLON, JK, JBLK)=ZBC-ZBE

              IF (KTYPE (JLON, JBLK)==3.AND.KLAB (JLON, JK+1, JBLK)==1) THEN

                IF (ZBUO (JLON, JK, JBLK)>-0.5_JPRB) THEN
                  LDCUM (JLON, JBLK)=.TRUE.
                  KCTOP (JLON, JBLK)=JK
                  PKINEU (JLON, JK, JBLK)=0.5_JPRB
                ELSE
                  KLAB (JLON, JK, JBLK)=0
                  PMFU (JLON, JK, JBLK)=0.0_JPRB
                  PLUDE (JLON, JK, JBLK)=0.0_JPRB
                  PLU (JLON, JK, JBLK)=0.0_JPRB
                ENDIF

              ENDIF


              IF (KLAB (JLON, JK+1, JBLK)==2) THEN

                IF (ZBUO (JLON, JK, JBLK)<-0.1_JPRB) THEN
                  PTENH (JLON, JK, JBLK)=0.5_JPRB*(PTEN (JLON, JK, JBLK)+PTEN (JLON, JK-1, JBLK))
                  PQENH (JLON, JK, JBLK)=0.5_JPRB*(PQEN (JLON, JK, JBLK)+PQEN (JLON, JK-1, JBLK))
                  ZBUO (JLON, JK, JBLK)=ZBC-PTENH (JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JLON, JK, JBLK))
                ENDIF

                ZBUOC=0.5*(ZBUO (JLON, JK, JBLK)+ZBUO (JLON, JK+1, JBLK))/(PTENH &
                &(JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JLON, JK, JBLK)))
                ZDKBUO=(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZFACBUO*ZBUOC

                IF (ZDMFEN (JLON, JBLK)>0.0_JPRB) THEN
                  ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFEN (JLON, JBLK)/MAX (YDECUMF%RMFCMIN, PMFU (JLON, JK+1, JBLK)))
                ELSE
                  ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFDE (JLON, JBLK)/MAX (YDECUMF%RMFCMIN, PMFU (JLON, JK+1, JBLK)))
                ENDIF


                IF (LDTDKMF) THEN
                  PKINEU (JLON, JK, JBLK)=(PKINEU (JLON, JK+1, JBLK)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN)
                  ZBUOC=ZBUO (JLON, JK, JBLK)
                ELSE
                  PKINEU (JLON, JK, JBLK)=MAX (-1.E3_JPRB,(PKINEU (JLON, JK+1, JBLK)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN))
                ENDIF


                IF (ZBUOC<0.0_JPRB) THEN
                  ZKEDKE=PKINEU (JLON, JK, JBLK)/MAX (1.E-3_JPRB, PKINEU (JLON, JK+1, JBLK))
                  ZKEDKE=MAX (0.0_JPRB, MIN (1.0_JPRB, ZKEDKE))
                  ZOCUDET=(1.6_JPRB-MIN (1.0_JPRB, PQEN (JLON, JK, JBLK)/PQSEN (JLON, JK, JBLK)))
                  ZMFUN=ZOCUDET*SQRT (ZKEDKE)
                  ZDMFDE (JLON, JBLK)=MAX (ZDMFDE (JLON, JBLK), PMFU (JLON, JK+1, JBLK)*(1.0_JPRB-ZMFUN))
                  PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
                  PMFU (JLON, JK, JBLK)=PMFU (JLON, JK+1, JBLK)+ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
                ENDIF


                IF (ZBUO (JLON, JK, JBLK)>-0.2_JPRB) THEN
                  IKB=KCBOT (JLON, JBLK)
                  
                  ZXENTRORG=YDECUMF%ENTRORG
                  
                  ZOENTR (JLON, JBLK)=ZXENTRORG*(0.3_JPRB-(MIN (1.0_JPRB, PQEN (JLON, JK-1, JBLK)/PQSEN&
                  & (JLON, JK-1, JBLK))-YDECUMF%ENTR_RH))*(PGEOH (JLON, JK-1, JBLK)-PGEOH (JLON, JK, JBLK&
                  &))*ZRG*MIN (1.0_JPRB, PQSEN (JLON, JK, JBLK)/PQSEN (JLON, IKB, JBLK))**3
                  ZOENTR (JLON, JBLK)=MIN (0.4_JPRB, ZOENTR (JLON, JBLK))*PMFU (JLON, JK, JBLK)
                ELSE
                  ZOENTR (JLON, JBLK)=0.0_JPRB
                ENDIF


                IF (JK>KDPL (JLON, JBLK)) THEN
                  PMFU (JLON, JK, JBLK)=PMFU (JLON, JK+1, JBLK)
                  PKINEU (JLON, JK, JBLK)=0.5_JPRB
                ENDIF


                IF (PKINEU (JLON, JK, JBLK)>0.0_JPRB.AND.PMFU (JLON, JK, JBLK)>0.0_JPRB.AND.(ZBUO&
                  & (JLON, JK, JBLK)>-2._JPRB.OR.(PTEN (JLON, JK-1, JBLK)-PTEN (JLON, JK, JBLK))/&
                  &(ZRG*(PGEO (JLON, JK-1, JBLK)-PGEO (JLON, JK, JBLK)))<-3.E-3_JPRB)) THEN
                  KCTOP (JLON, JBLK)=JK
                  LLO1 (JLON, JBLK)=.TRUE.
                ELSE
                  KLAB (JLON, JK, JBLK)=0
                  PMFU (JLON, JK, JBLK)=0.0_JPRB
                  PKINEU (JLON, JK, JBLK)=0.0_JPRB
                  ZDMFDE (JLON, JBLK)=PMFU (JLON, JK+1, JBLK)
                  PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
                ENDIF


                IF (PMFU (JLON, JK+1, JBLK)>0.0_JPRB) THEN
                  PMFUDE_RATE (JLON, JK, JBLK)=ZDMFDE (JLON, JBLK)
                ENDIF

              ENDIF

            ELSEIF (KTYPE (JLON, JBLK)==2.AND.PQU (JLON, JK, JBLK)==ZQOLD (JLON, JBLK)) THEN
              KLAB (JLON, JK, JBLK)=0
              PMFU (JLON, JK, JBLK)=0.0_JPRB
              PKINEU (JLON, JK, JBLK)=0.0_JPRB
              ZDMFDE (JLON, JBLK)=PMFU (JLON, JK+1, JBLK)
              PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
              PMFUDE_RATE (JLON, JK, JBLK)=ZDMFDE (JLON, JBLK)
            ENDIF

          ENDIF

        ENDDO


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LLO1 (JLON, JBLK)) THEN

            IF (PLU (JLON, JK, JBLK)>ZDNOPRC) THEN
              PWU (JLON, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.5_JPRB, PKINEU (JLON, JK+1, JBLK))))

              IF (LDTDKMF) THEN
                ZZCO=FOEALFCU (PTU (JLON, JK, JBLK))*1.3_JPRB+(1.0_JPRB-FOEALFCU (PTU (JLON, JK, JBLK)))
              ELSE
                ZZCO=1.0_JPRB+0.3_JPRB*FOEALFCU (PTU (JLON, JK, JBLK))
              ENDIF

              
              ZXPRCDGW=ZPRCDGW
              
              ZPRCON=ZXPRCDGW/(0.75_JPRB*PWU (JLON, JK, JBLK))*ZZCO
              ZDT=MIN (YDTHF%RTBERCU-YDTHF%RTICECU, MAX (YDTHF%RTBERCU-PTU (JLON, JK, JBLK), 0.0_JPRB))
              ZCBF=1+Z_CPRC2*SQRT (ZDT)
              ZZCO=ZPRCON*ZCBF

              IF (YGFL%NACTAERO>0) THEN

                IF (YDECLDP%LAERLIQAUTOCP) THEN
                  ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))
                  ZLCRIT=ZALFAW*PLCRIT_AER (JLON, JK, JBLK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
                ELSEIF (YDECLDP%LAERLIQAUTOCPB) THEN
                  ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))
                  ZLCRIT=ZALFAW*PLCRIT_AER (JLON, KCBOT (JLON, JBLK), JBLK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
                ELSE
                  ZLCRIT=ZDNOPRC/ZCBF
                ENDIF

              ELSE
                ZLCRIT=ZDNOPRC/ZCBF
              ENDIF

              ZDFI=PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK)
              ZC=(PLU (JLON, JK, JBLK)-ZLUOLD (JLON, JBLK))
              ZD=ZZCO*(1.0_JPRB-EXP (-(PLU (JLON, JK, JBLK)/ZLCRIT)**2))*ZDFI
              ZINT=EXP (-ZD)
              ZLNEW=ZLUOLD (JLON, JBLK)*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
              ZLNEW=MAX (0.0_JPRB, MIN (PLU (JLON, JK, JBLK), ZLNEW))
              ZLNEW=MIN (Z_CLDMAX, ZLNEW)
              ZPRECIP (JLON, JBLK)=MAX (0.0_JPRB, ZLUOLD (JLON, JBLK)+ZC-ZLNEW)
              PDMFUP (JLON, JK, JBLK)=ZPRECIP (JLON, JBLK)*PMFU (JLON, JK, JBLK)
              PLRAIN (JLON, JK, JBLK)=PLRAIN (JLON, JK, JBLK)+ZPRECIP (JLON, JBLK)
              PLU (JLON, JK, JBLK)=ZLNEW
            ENDIF

          ENDIF

        ENDDO


        IF (YDEPHLI%LPHYLIN) THEN

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLO1 (JLON, JBLK)) THEN

              IF (PLRAIN (JLON, JK, JBLK)>0.0_JPRB) THEN
                ZVW=21.18_JPRB*PLRAIN (JLON, JK, JBLK)**0.2_JPRB
                ZVI=Z_CWIFRAC*ZVW
                ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JLON, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
                ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
                ZROLD=PLRAIN (JLON, JK, JBLK)-ZPRECIP (JLON, JBLK)
                ZC=ZPRECIP (JLON, JBLK)
                PWU (JLON, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JLON, JK, JBLK))))
                ZD=ZVV/PWU (JLON, JK, JBLK)
                ZINT=EXP (-ZD)
                ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
                ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JLON, JK, JBLK), ZRNEW))
                PLRAIN (JLON, JK, JBLK)=ZRNEW
              ENDIF

            ENDIF

          ENDDO

        ELSE

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLO1 (JLON, JBLK)) THEN

              IF (PLRAIN (JLON, JK, JBLK)>0.0_JPRB) THEN
                ZVW=21.18_JPRB*PLRAIN (JLON, JK, JBLK)**0.2_JPRB
                ZVI=Z_CWIFRAC*ZVW
                ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))

                IF (LSCVFLAG (JLON, JBLK))  THEN
                  ZALFAW=1.0_JPRB
                ENDIF

                ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
                ZROLD=PLRAIN (JLON, JK, JBLK)-ZPRECIP (JLON, JBLK)
                ZC=ZPRECIP (JLON, JBLK)
                PWU (JLON, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JLON, JK, JBLK))))
                ZD=ZVV/PWU (JLON, JK, JBLK)
                ZINT=EXP (-ZD)
                ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
                ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JLON, JK, JBLK), ZRNEW))
                PLRAIN (JLON, JK, JBLK)=ZRNEW
              ENDIF

            ENDIF

          ENDDO

        ENDIF


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LLFLAG (JLON, JBLK)) THEN
            PMFUL (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)*PMFU (JLON, JK, JBLK)
            PMFUS (JLON, JK, JBLK)=(YDCST%RCPD*PTU (JLON, JK, JBLK&
            &)+PGEOH (JLON, JK, JBLK))*PMFU (JLON, JK, JBLK)
            PMFUQ (JLON, JK, JBLK)=PQU (JLON, JK, JBLK)*PMFU (JLON, JK, JBLK)
            ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))

            IF (LSCVFLAG (JLON, JBLK))  THEN
              ZALFAW=1.0_JPRB
            ENDIF

            PLUDELI (JLON, JK, 1, JBLK)=ZALFAW*PLUDE (JLON, JK, JBLK)
            PLUDELI (JLON, JK, 2, JBLK)=(1.0_JPRB-ZALFAW)*PLUDE (JLON, JK, JBLK)
          ENDIF

        ENDDO

      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KCTOP => NULL ()
  KDPL => NULL ()
  KLAB => NULL ()
  KTYPE => NULL ()
  LDCUM => NULL ()
  LLFLAG => NULL ()
  LLFLAGUV => NULL ()
  LLFLAG_CUADJTQ000 => NULL ()
  LLFLAG_CUADJTQ001 => NULL ()
  LLO1 => NULL ()
  LSCVFLAG => NULL ()
  PAP => NULL ()
  PAPH => NULL ()
  PDMFEN => NULL ()
  PDMFUP => NULL ()
  PGEO => NULL ()
  PGEOH => NULL ()
  PKINEU => NULL ()
  PLCRIT_AER => NULL ()
  PLGLAC => NULL ()
  PLITOT => NULL ()
  PLRAIN => NULL ()
  PLU => NULL ()
  PLUDE => NULL ()
  PLUDELI => NULL ()
  PMFU => NULL ()
  PMFUB => NULL ()
  PMFUDE_RATE => NULL ()
  PMFUL => NULL ()
  PMFUQ => NULL ()
  PMFUS => NULL ()
  PQEN => NULL ()
  PQENH => NULL ()
  PQSEN => NULL ()
  PQU => NULL ()
  PTEN => NULL ()
  PTENH => NULL ()
  PTU => NULL ()
  PVERVEL => NULL ()
  PWMEAN => NULL ()
  PWU => NULL ()
  ZBUO => NULL ()
  ZDMFDE => NULL ()
  ZDMFEN => NULL ()
  ZDPMEAN => NULL ()
  ZENTR => NULL ()
  ZLUOLD => NULL ()
  ZOENTR => NULL ()
  ZPH => NULL ()
  ZPRECIP => NULL ()
  ZQOLD => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUASCN_PARALLEL:2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_DEVICE_DATA_RDWR (YD_KCBOT)
  KCTOP => GET_DEVICE_DATA_RDWR (YD_KCTOP)
  KDPL => GET_DEVICE_DATA_RDONLY (YD_KDPL)
  KLAB => GET_DEVICE_DATA_RDWR (YD_KLAB)
  KTYPE => GET_DEVICE_DATA_RDWR (YD_KTYPE)
  LDCUM => GET_DEVICE_DATA_RDWR (YD_LDCUM)
  LLFLAG => GET_DEVICE_DATA_RDWR (YL_LLFLAG)
  LLFLAGUV => GET_DEVICE_DATA_RDWR (YL_LLFLAGUV)
  LLFLAG_CUADJTQ000 => GET_DEVICE_DATA_RDWR (YL_LLFLAG_CUADJTQ000)
  LLFLAG_CUADJTQ001 => GET_DEVICE_DATA_RDWR (YL_LLFLAG_CUADJTQ001)
  LLO1 => GET_DEVICE_DATA_RDWR (YL_LLO1)
  LSCVFLAG => GET_DEVICE_DATA_RDONLY (YD_LSCVFLAG)
  PAP => GET_DEVICE_DATA_RDONLY (YD_PAP)
  PAPH => GET_DEVICE_DATA_RDONLY (YD_PAPH)
  PDMFEN => GET_DEVICE_DATA_RDWR (YD_PDMFEN)
  PDMFUP => GET_DEVICE_DATA_RDWR (YD_PDMFUP)
  PGEO => GET_DEVICE_DATA_RDONLY (YD_PGEO)
  PGEOH => GET_DEVICE_DATA_RDONLY (YD_PGEOH)
  PKINEU => GET_DEVICE_DATA_RDWR (YD_PKINEU)
  PLCRIT_AER => GET_DEVICE_DATA_RDONLY (YD_PLCRIT_AER)
  PLGLAC => GET_DEVICE_DATA_RDWR (YD_PLGLAC)
  PLITOT => GET_DEVICE_DATA_RDONLY (YD_PLITOT)
  PLRAIN => GET_DEVICE_DATA_RDWR (YD_PLRAIN)
  PLU => GET_DEVICE_DATA_RDWR (YD_PLU)
  PLUDE => GET_DEVICE_DATA_RDWR (YD_PLUDE)
  PLUDELI => GET_DEVICE_DATA_RDWR (YD_PLUDELI)
  PMFU => GET_DEVICE_DATA_RDWR (YD_PMFU)
  PMFUB => GET_DEVICE_DATA_RDWR (YD_PMFUB)
  PMFUDE_RATE => GET_DEVICE_DATA_RDWR (YD_PMFUDE_RATE)
  PMFUL => GET_DEVICE_DATA_RDWR (YD_PMFUL)
  PMFUQ => GET_DEVICE_DATA_RDWR (YD_PMFUQ)
  PMFUS => GET_DEVICE_DATA_RDWR (YD_PMFUS)
  PQEN => GET_DEVICE_DATA_RDONLY (YD_PQEN)
  PQENH => GET_DEVICE_DATA_RDWR (YD_PQENH)
  PQSEN => GET_DEVICE_DATA_RDONLY (YD_PQSEN)
  PQU => GET_DEVICE_DATA_RDWR (YD_PQU)
  PTEN => GET_DEVICE_DATA_RDONLY (YD_PTEN)
  PTENH => GET_DEVICE_DATA_RDWR (YD_PTENH)
  PTU => GET_DEVICE_DATA_RDWR (YD_PTU)
  PVERVEL => GET_DEVICE_DATA_RDONLY (YD_PVERVEL)
  PWMEAN => GET_DEVICE_DATA_RDWR (YD_PWMEAN)
  PWU => GET_DEVICE_DATA_RDWR (YD_PWU)
  ZBUO => GET_DEVICE_DATA_RDWR (YL_ZBUO)
  ZDMFDE => GET_DEVICE_DATA_RDWR (YL_ZDMFDE)
  ZDMFEN => GET_DEVICE_DATA_RDWR (YL_ZDMFEN)
  ZDPMEAN => GET_DEVICE_DATA_RDWR (YL_ZDPMEAN)
  ZENTR => GET_DEVICE_DATA_RDWR (YL_ZENTR)
  ZLUOLD => GET_DEVICE_DATA_RDWR (YL_ZLUOLD)
  ZOENTR => GET_DEVICE_DATA_RDWR (YL_ZOENTR)
  ZPH => GET_DEVICE_DATA_RDWR (YL_ZPH)
  ZPRECIP => GET_DEVICE_DATA_RDWR (YL_ZPRECIP)
  ZQOLD => GET_DEVICE_DATA_RDWR (YL_ZQOLD)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (KCBOT, KCTOP, KDPL, KLAB, KTYPE, LDCUM, LLFLAG, LLFLAGUV, LLFLAG_CUADJTQ000, &
    !$ACC&         LLFLAG_CUADJTQ001, LLO1, LSCVFLAG, PAP, PAPH, PDMFEN, PDMFUP, PGEO, &
    !$ACC&         PGEOH, PKINEU, PLCRIT_AER, PLGLAC, PLITOT, PLRAIN, PLU, PLUDE, PLUDELI, &
    !$ACC&         PMFU, PMFUB, PMFUDE_RATE, PMFUL, PMFUQ, PMFUS, PQEN, PQENH, PQSEN, PQU, &
    !$ACC&         PTEN, PTENH, PTU, PVERVEL, PWMEAN, PWU, YFXTRAN_ACDC_STACK, ZBUO, ZDMFDE, &
    !$ACC&         ZDMFEN, ZDPMEAN, ZENTR, ZLUOLD, ZOENTR, ZPH, ZPRECIP, ZQOLD) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (IK, IKB, IS, JK, JLON, LLO1_CUENTR, LLO3, LLPERT_DETRPEN, YLCPG_BNDS, &
    !$ACC&         Z1S, Z2S, ZALFAW, ZBC, ZBE, ZBUOC, ZC, ZCBF, ZCHANGE, ZCOND, ZCOND1, ZCOR, &
    !$ACC&         ZD, ZDFI, ZDKBUO, ZDKEN, ZDT, ZDZ, ZF, ZFAC, ZFOEEWI, ZFOEEWL, ZI, ZINT, ZKEDKE, &
    !$ACC&         ZL, ZLCRIT, ZLEEN, ZLNEW, ZMF, ZMFMAX, ZMFTEST, ZMFULK, ZMFUN, ZMFUQK, &
    !$ACC&         ZMFUSK, ZOCUDET, ZOEALFA, ZOEALFAP, ZOEALFA_CUADJTQ001, ZORCPD_CUBASMCN, &
    !$ACC&         ZPRCON, ZQEEN, ZQMAX, ZQP, ZQSAT, ZQUDE, ZRG_CUBASMCN, ZRG_CUENTR, &
    !$ACC&         ZRNEW, ZROLD, ZSCDE, ZSEEN, ZTARG, ZVI, ZVV, ZVW, ZXDETRPEN, ZXE, ZXENTRORG, &
    !$ACC&         ZXENTSHALP, ZXPRCDGW, ZXS, ZZCO, ZZZMB) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      DO JK=KLEV-1, 3,-1
        IK=JK
        
        
        ZRG_CUBASMCN=1.0_JPRB/YDCST%RG
        ZORCPD_CUBASMCN=1.0_JPRB/YDCST%RCPD

        

        IF (.NOT.LDCUM (JLON, JBLK).AND.KLAB (JLON, IK+1, JBLK)==0) THEN

          IF (YDECUMF%LMFMID.AND.IK>YDECUMF%NJKT7.AND.PQEN (JLON&
            &, IK, JBLK)>0.80_JPRB*PQSEN (JLON, IK, JBLK)) THEN
            PTU (JLON, IK+1, JBLK)=(YDCST%RCPD*PTEN (JLON, IK, JBLK)+PGEO &
            &(JLON, IK, JBLK)-PGEOH (JLON, IK+1, JBLK))*ZORCPD_CUBASMCN
            PQU (JLON, IK+1, JBLK)=PQEN (JLON, IK, JBLK)
            PLU (JLON, IK+1, JBLK)=0.0_JPRB
            ZZZMB=MAX (1.E-6_JPRB,-PVERVEL (JLON, IK, JBLK)*ZRG_CUBASMCN)
            ZZZMB=MIN (ZZZMB, YDECUMF%RMFLIA)
            PMFUB (JLON, JBLK)=ZZZMB
            PMFU (JLON, IK+1, JBLK)=PMFUB (JLON, JBLK)
            PMFUS (JLON, IK+1, JBLK)=PMFUB (JLON, JBLK)*(YDCST%RCPD&
            &*PTU (JLON, IK+1, JBLK)+PGEOH (JLON, IK+1, JBLK))
            PMFUQ (JLON, IK+1, JBLK)=PMFUB (JLON, JBLK)*PQU (JLON, IK+1, JBLK)
            PMFUL (JLON, IK+1, JBLK)=0.0_JPRB
            PDMFUP (JLON, IK+1, JBLK)=0.0_JPRB
            PLRAIN (JLON, IK+1, JBLK)=0.0_JPRB
            KCBOT (JLON, JBLK)=IK
            KLAB (JLON, IK+1, JBLK)=1
            KTYPE (JLON, JBLK)=3
          ENDIF

        ENDIF

        
        
        
        
        IS=0
        
        LLFLAG (JLON, JBLK)=.FALSE.
        ZPRECIP (JLON, JBLK)=0.0_JPRB
        LLO1 (JLON, JBLK)=.FALSE.
        IS=IS+KLAB (JLON, JK+1, JBLK)

        IF (KLAB (JLON, JK+1, JBLK)==0)  THEN
          KLAB (JLON, JK, JBLK)=0
        ENDIF


        IF ((LDCUM (JLON, JBLK).AND.KLAB (JLON, JK+1, JBLK)==2).OR.(KTYPE&
          & (JLON, JBLK)==3.AND.KLAB (JLON, JK+1, JBLK)==1)) THEN
          LLFLAG (JLON, JBLK)=.TRUE.
        ENDIF


        IF (KLAB (JLON, JK+1, JBLK)>0) THEN
          LLFLAGUV (JLON, JBLK)=.TRUE.
        ELSE
          LLFLAGUV (JLON, JBLK)=.FALSE.
        ENDIF

        ZPH (JLON, JBLK)=PAPH (JLON, JK, JBLK)

        IF (KTYPE (JLON, JBLK)==3.AND.JK==KCBOT (JLON, JBLK)) THEN
          ZMFMAX=(PAPH (JLON, JK, JBLK)-PAPH (JLON, JK-1, JBLK))*ZCONS2

          IF (PMFUB (JLON, JBLK)>ZMFMAX) THEN
            ZFAC=ZMFMAX/PMFUB (JLON, JBLK)
            PMFU (JLON, JK+1, JBLK)=PMFU (JLON, JK+1, JBLK)*ZFAC
            PMFUS (JLON, JK+1, JBLK)=PMFUS (JLON, JK+1, JBLK)*ZFAC
            PMFUQ (JLON, JK+1, JBLK)=PMFUQ (JLON, JK+1, JBLK)*ZFAC
            PMFUB (JLON, JBLK)=ZMFMAX
          ENDIF

        ENDIF


        

        IF (IS>0)  THEN
          LLO3=.TRUE.
        ENDIF

        IK=JK

        

        

        IF (LLO3) THEN
          ZRG_CUENTR=1.0_JPRB/YDCST%RG
          
          LLPERT_DETRPEN=.FALSE.
          
          
          ZDMFEN (JLON, JBLK)=0.0_JPRB
          ZDMFDE (JLON, JBLK)=0.0_JPRB
          ZENTR (JLON, JBLK)=0.0

          

          

          IF (LDCUM (JLON, JBLK)) THEN
            ZDZ=(PGEOH (JLON, IK, JBLK)-PGEOH (JLON, IK+1, JBLK))*ZRG_CUENTR
            ZMF=PMFU (JLON, IK+1, JBLK)*ZDZ
            LLO1_CUENTR=IK<KCBOT (JLON, JBLK)

            IF (LLO1_CUENTR) THEN
              
              ZXDETRPEN=YDECUMF%DETRPEN
              
              ZDMFEN (JLON, JBLK)=ZENTR (JLON, JBLK)*ZMF
              ZDMFDE (JLON, JBLK)=ZXDETRPEN*ZMF
            ENDIF

          ENDIF

        
        ENDIF


        

        

        

        IF (LLO3) THEN
          
          ZQOLD (JLON, JBLK)=0.0_JPRB

          

          

          IF (LLFLAG (JLON, JBLK)) THEN
            ZDMFDE (JLON, JBLK)=MIN (ZDMFDE (JLON, JBLK), 0.75_JPRB*PMFU (JLON, JK+1, JBLK))

            IF (JK==KCBOT (JLON, JBLK)) THEN
              
              ZXENTRORG=YDECUMF%ENTRORG
              
              ZOENTR (JLON, JBLK)=-ZXENTRORG*(MIN (1.0_JPRB, PQEN (JLON, JK, JBLK)/PQSEN (JLON, JK&
              &, JBLK))-YDECUMF%ENTR_RH)*(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZRG
              ZOENTR (JLON, JBLK)=MIN (0.4_JPRB, ZOENTR (JLON, JBLK))*PMFU (JLON, JK+1, JBLK)
            ENDIF


            IF (JK<KCBOT (JLON, JBLK)) THEN
              ZMFMAX=(PAPH (JLON, JK, JBLK)-PAPH (JLON, JK-1, JBLK))*ZCONS2
              ZXS=MAX (PMFU (JLON, JK+1, JBLK)-ZMFMAX, 0.0_JPRB)
              PWMEAN (JLON, JBLK)=PWMEAN (JLON, JBLK)+PKINEU (JLON, JK+1&
              &, JBLK)*(PAP (JLON, JK+1, JBLK)-PAP (JLON, JK, JBLK))
              ZDPMEAN (JLON, JBLK)=ZDPMEAN (JLON, JBLK)+PAP (JLON, JK+1, JBLK)-PAP (JLON, JK, JBLK)
              ZDMFEN (JLON, JBLK)=ZOENTR (JLON, JBLK)

              IF (KTYPE (JLON, JBLK)>=2) THEN
                
                ZXENTSHALP=YDECUMF%ENTSHALP
                
                ZDMFEN (JLON, JBLK)=ZXENTSHALP*ZDMFEN (JLON, JBLK)
                ZDMFDE (JLON, JBLK)=ZDMFEN (JLON, JBLK)
              ENDIF

              ZDMFDE (JLON, JBLK)=ZDMFDE (JLON, JBLK)*(1.6_JPRB-MIN (1.0_JPRB&
              &, PQEN (JLON, JK, JBLK)/PQSEN (JLON, JK, JBLK)))
              ZMFTEST=PMFU (JLON, JK+1, JBLK)+ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
              ZCHANGE=MAX (ZMFTEST-ZMFMAX, 0.0_JPRB)
              ZXE=MAX (ZCHANGE-ZXS, 0.0_JPRB)
              ZDMFEN (JLON, JBLK)=ZDMFEN (JLON, JBLK)-ZXE
              ZCHANGE=ZCHANGE-ZXE
              ZDMFDE (JLON, JBLK)=ZDMFDE (JLON, JBLK)+ZCHANGE
            ENDIF

            PDMFEN (JLON, JK, JBLK)=ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
            PMFU (JLON, JK, JBLK)=PMFU (JLON, JK+1, JBLK)+ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
            ZQEEN=PQENH (JLON, JK+1, JBLK)*ZDMFEN (JLON, JBLK)
            ZSEEN=(YDCST%RCPD*PTENH (JLON, JK+1, JBLK)+PGEOH (JLON, JK+1, JBLK))*ZDMFEN (JLON, JBLK)

            IF (PLITOT (JLON, JK, JBLK)>YDECLDP%RLMIN) THEN
              ZLEEN=PLITOT (JLON, JK, JBLK)*ZDMFEN (JLON, JBLK)
            ELSE
              ZLEEN=0.0_JPRB
            ENDIF

            ZSCDE=(YDCST%RCPD*PTU (JLON, JK+1, JBLK)+PGEOH (JLON, JK+1, JBLK))*ZDMFDE (JLON, JBLK)
            ZQUDE=PQU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
            PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
            ZMFUSK=PMFUS (JLON, JK+1, JBLK)+ZSEEN-ZSCDE
            ZMFUQK=PMFUQ (JLON, JK+1, JBLK)+ZQEEN-ZQUDE
            ZMFULK=PMFUL (JLON, JK+1, JBLK)+ZLEEN-PLUDE (JLON, JK, JBLK)
            ZFAC=1.0_JPRB/MAX (YDECUMF%RMFCMIN, PMFU (JLON, JK, JBLK))
            PLU (JLON, JK, JBLK)=ZMFULK*ZFAC
            PQU (JLON, JK, JBLK)=ZMFUQK*ZFAC
            PTU (JLON, JK, JBLK)=(ZMFUSK*ZFAC-PGEOH (JLON, JK, JBLK))*ZORCPD
            PTU (JLON, JK, JBLK)=MAX (100._JPRB, PTU (JLON, JK, JBLK))
            PTU (JLON, JK, JBLK)=MIN (400._JPRB, PTU (JLON, JK, JBLK))
            ZQOLD (JLON, JBLK)=PQU (JLON, JK, JBLK)
            PLRAIN (JLON, JK, JBLK)=PLRAIN (JLON, JK+1, JBLK)*MAX (0.0_JPRB&
            &, PMFU (JLON, JK+1, JBLK)-ZDMFDE (JLON, JBLK))*ZFAC
            ZLUOLD (JLON, JBLK)=PLU (JLON, JK, JBLK)
          ENDIF


          

          

          IF (JK>KDPL (JLON, JBLK)) THEN
            PTU (JLON, JK, JBLK)=PTENH (JLON, JK, JBLK)
            PQU (JLON, JK, JBLK)=PQENH (JLON, JK, JBLK)
            PLU (JLON, JK, JBLK)=0.0_JPRB
            ZLUOLD (JLON, JBLK)=PLU (JLON, JK, JBLK)
          ENDIF

          
          IK=JK

          IF (YDECUMF%LSCVLIQ) THEN
            
            
            ZQMAX=0.5_JPRB

            IF (.NOT.YDEPHLI%LPHYLIN) THEN
              
              LLFLAG_CUADJTQ000 (JLON, JBLK)=LLFLAG (JLON, JBLK)
              
              
              LLFLAG_CUADJTQ000 (JLON, JBLK)=LLFLAG_CUADJTQ000 (JLON, JBLK).AND..NOT.LSCVFLAG (JLON, JBLK)

              

              

              

              IF (LLFLAG_CUADJTQ000 (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=MIN (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
                ZCOND=MAX (ZCOND, 0.0_JPRB)
                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND1=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

                IF (ZCOND==0.0_JPRB)  THEN
                  ZCOND1=0.0_JPRB
                ENDIF

                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND1
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
              ENDIF


              

              

              

              IF (LLFLAG (JLON, JBLK).AND.LSCVFLAG (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZL)
                ZQSAT=ZQSAT*ZQP
                ZQSAT=MIN (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=YDTHF%R5ALVCP*ZL**2
                ZCOND=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
                ZCOND=MAX (ZCOND, 0.0_JPRB)
                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+YDTHF%RALVDCP*ZCOND
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZQSAT=YDTHF%R2ES*EXP (YDTHF%R3LES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZL)
                ZQSAT=ZQSAT*ZQP
                ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=YDTHF%R5ALVCP*ZL**2
                ZCOND1=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

                IF (ZCOND==0.0_JPRB)  THEN
                  ZCOND1=0.0_JPRB
                ENDIF

                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+YDTHF%RALVDCP*ZCOND1
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            
            
            
            
            
            
            
            
            ELSE
            
            
            
            
            ENDIF

          
          
          
          ELSE
            
            
            ZQMAX=0.5_JPRB

            IF (.NOT.YDEPHLI%LPHYLIN) THEN
              
              LLFLAG_CUADJTQ001 (JLON, JBLK)=LLFLAG (JLON, JBLK)

              

              

              IF (LLFLAG_CUADJTQ001 (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=MIN (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)
                ZCOND=MAX (ZCOND, 0.0_JPRB)
                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                ZL=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4LES)
                ZI=1.0_JPRB/(PTU (JLON, IK, JBLK)-YDTHF%R4IES)
                ZQSAT=YDTHF%R2ES*(FOEALFCU (PTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(PTU&
                & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (PTU (JLON, IK, JBLK&
                &)))*EXP (YDTHF%R3IES*(PTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
                ZQSAT=ZQSAT*ZQP
                ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
                ZCOR=1.0_JPRB-YDCST%RETV*ZQSAT
                ZF=FOEALFCU (PTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
                &-FOEALFCU (PTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
                ZCOND1=(PQU (JLON, IK, JBLK)*ZCOR**2-ZQSAT*ZCOR)/(ZCOR**2+ZQSAT*ZF)

                IF (ZCOND==0.0_JPRB)  THEN
                  ZCOND1=0.0_JPRB
                ENDIF

                PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+FOELDCPMCU (PTU (JLON, IK, JBLK))*ZCOND1
                PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            
            
            
            
            
            
            
            
            ELSE

              

              

              IF (LLFLAG (JLON, JBLK)) THEN
                ZQP=1.0_JPRB/ZPH (JLON, JBLK)
                ZTARG=PTU (JLON, IK, JBLK)
                ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
                Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                ZQSAT=ZQSAT*ZCOR
                Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                ZCOND=(PQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
                ZCOND=MAX (ZCOND, 0.0_JPRB)

                IF (ZCOND/=0.0_JPRB) THEN
                  PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+(ZOEALFA_CUADJTQ001*YDTHF&
                  &%RALVDCP+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND
                  PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND
                  ZTARG=PTU (JLON, IK, JBLK)
                  ZOEALFA_CUADJTQ001=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                  ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                  ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                  ZQSAT=ZQP*(ZOEALFA_CUADJTQ001*ZFOEEWL+(1.0_JPRB-ZOEALFA_CUADJTQ001)*ZFOEEWI)
                  Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                  ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                  ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                  ZQSAT=ZQSAT*ZCOR
                  Z2S=ZOEALFA_CUADJTQ001*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                  &-ZOEALFA_CUADJTQ001)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                  ZCOND1=(PQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*Z2S)
                  PTU (JLON, IK, JBLK)=PTU (JLON, IK, JBLK)+(ZOEALFA_CUADJTQ001*YDTHF&
                  &%RALVDCP+(1.0_JPRB-ZOEALFA_CUADJTQ001)*YDTHF%RALSDCP)*ZCOND1
                  PQU (JLON, IK, JBLK)=PQU (JLON, IK, JBLK)-ZCOND1
                ENDIF

              ENDIF

            
            
            
            
            
            ENDIF

          
          
          
          ENDIF


          IF (YDEPHLI%LPHYLIN) THEN

            

            IF (LLFLAG (JLON, JBLK)) THEN

              IF (PQU (JLON, JK, JBLK)/=ZQOLD (JLON, JBLK)) THEN
                ZOEALFA=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JLON, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
                ZOEALFAP=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU&
                & (JLON, JK+1, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
                PLGLAC (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)*((1.0_JPRB-ZOEALFA)-(1.0_JPRB-ZOEALFAP))
                ZFAC=0.545_JPRB*(TANH (0.17_JPRB*(PTEN (JLON, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB)
                PLGLAC (JLON, JK, JBLK)=PLGLAC (JLON, JK, JBLK)+ZFAC*PDMFUP (JLON, JK+1, JBLK)/MAX (YDECUMF%RMFCMIN&
                &, PMFU (JLON, JK+1, JBLK))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JLON, JK, JBLK)))*ZGLAC
                PTU (JLON, JK, JBLK)=PTU (JLON, JK, JBLK)+YDTHF%RALFDCP*PLGLAC (JLON, JK, JBLK)
              ENDIF

            ENDIF

          
          ELSE

            

            IF (LLFLAG (JLON, JBLK)) THEN

              IF (PQU (JLON, JK, JBLK)/=ZQOLD (JLON, JBLK)) THEN
                PLGLAC (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)*((1.0_JPRB-FOEALFCU (PTU&
                & (JLON, JK, JBLK)))-(1.0_JPRB-FOEALFCU (PTU (JLON, JK+1, JBLK))))

                IF (LSCVFLAG (JLON, JBLK))  THEN
                  PLGLAC (JLON, JK, JBLK)=0.0_JPRB
                ENDIF

                ZFAC=FOEALFCU (PTEN (JLON, JK, JBLK))
                PLGLAC (JLON, JK, JBLK)=PLGLAC (JLON, JK, JBLK)+ZFAC*PDMFUP (JLON, JK+1, JBLK)/MAX (YDECUMF%RMFCMIN&
                &, PMFU (JLON, JK+1, JBLK))*(0.5_JPRB+SIGN (0.5_JPRB, YDCST%RTT-PTEN (JLON, JK, JBLK)))*ZGLAC
                PTU (JLON, JK, JBLK)=PTU (JLON, JK, JBLK)+YDTHF%RALFDCP*PLGLAC (JLON, JK, JBLK)
              ENDIF

            ENDIF

          
          ENDIF


          

          IF (LLFLAG (JLON, JBLK)) THEN

            IF (PQU (JLON, JK, JBLK)/=ZQOLD (JLON, JBLK)) THEN
              KLAB (JLON, JK, JBLK)=2
              PLU (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)+ZQOLD (JLON, JBLK)-PQU (JLON, JK, JBLK)
              ZBC=PTU (JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQU (JLON, JK,&
              & JBLK)-PLU (JLON, JK+1, JBLK)-PLRAIN (JLON, JK+1, JBLK))
              ZBE=PTENH (JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JLON, JK, JBLK))
              ZBUO (JLON, JK, JBLK)=ZBC-ZBE

              IF (KTYPE (JLON, JBLK)==3.AND.KLAB (JLON, JK+1, JBLK)==1) THEN

                IF (ZBUO (JLON, JK, JBLK)>-0.5_JPRB) THEN
                  LDCUM (JLON, JBLK)=.TRUE.
                  KCTOP (JLON, JBLK)=JK
                  PKINEU (JLON, JK, JBLK)=0.5_JPRB
                ELSE
                  KLAB (JLON, JK, JBLK)=0
                  PMFU (JLON, JK, JBLK)=0.0_JPRB
                  PLUDE (JLON, JK, JBLK)=0.0_JPRB
                  PLU (JLON, JK, JBLK)=0.0_JPRB
                ENDIF

              ENDIF


              IF (KLAB (JLON, JK+1, JBLK)==2) THEN

                IF (ZBUO (JLON, JK, JBLK)<-0.1_JPRB) THEN
                  PTENH (JLON, JK, JBLK)=0.5_JPRB*(PTEN (JLON, JK, JBLK)+PTEN (JLON, JK-1, JBLK))
                  PQENH (JLON, JK, JBLK)=0.5_JPRB*(PQEN (JLON, JK, JBLK)+PQEN (JLON, JK-1, JBLK))
                  ZBUO (JLON, JK, JBLK)=ZBC-PTENH (JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JLON, JK, JBLK))
                ENDIF

                ZBUOC=0.5*(ZBUO (JLON, JK, JBLK)+ZBUO (JLON, JK+1, JBLK))/(PTENH &
                &(JLON, JK, JBLK)*(1.0_JPRB+YDCST%RETV*PQENH (JLON, JK, JBLK)))
                ZDKBUO=(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZFACBUO*ZBUOC

                IF (ZDMFEN (JLON, JBLK)>0.0_JPRB) THEN
                  ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFEN (JLON, JBLK)/MAX (YDECUMF%RMFCMIN, PMFU (JLON, JK+1, JBLK)))
                ELSE
                  ZDKEN=MIN (1.0_JPRB,(1+Z_CWDRAG)*ZDMFDE (JLON, JBLK)/MAX (YDECUMF%RMFCMIN, PMFU (JLON, JK+1, JBLK)))
                ENDIF


                IF (LDTDKMF) THEN
                  PKINEU (JLON, JK, JBLK)=(PKINEU (JLON, JK+1, JBLK)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN)
                  ZBUOC=ZBUO (JLON, JK, JBLK)
                ELSE
                  PKINEU (JLON, JK, JBLK)=MAX (-1.E3_JPRB,(PKINEU (JLON, JK+1, JBLK)*(1-ZDKEN)+ZDKBUO)/(1+ZDKEN))
                ENDIF


                IF (ZBUOC<0.0_JPRB) THEN
                  ZKEDKE=PKINEU (JLON, JK, JBLK)/MAX (1.E-3_JPRB, PKINEU (JLON, JK+1, JBLK))
                  ZKEDKE=MAX (0.0_JPRB, MIN (1.0_JPRB, ZKEDKE))
                  ZOCUDET=(1.6_JPRB-MIN (1.0_JPRB, PQEN (JLON, JK, JBLK)/PQSEN (JLON, JK, JBLK)))
                  ZMFUN=ZOCUDET*SQRT (ZKEDKE)
                  ZDMFDE (JLON, JBLK)=MAX (ZDMFDE (JLON, JBLK), PMFU (JLON, JK+1, JBLK)*(1.0_JPRB-ZMFUN))
                  PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
                  PMFU (JLON, JK, JBLK)=PMFU (JLON, JK+1, JBLK)+ZDMFEN (JLON, JBLK)-ZDMFDE (JLON, JBLK)
                ENDIF


                IF (ZBUO (JLON, JK, JBLK)>-0.2_JPRB) THEN
                  IKB=KCBOT (JLON, JBLK)
                  
                  ZXENTRORG=YDECUMF%ENTRORG
                  
                  ZOENTR (JLON, JBLK)=ZXENTRORG*(0.3_JPRB-(MIN (1.0_JPRB, PQEN (JLON, JK-1, JBLK)/PQSEN&
                  & (JLON, JK-1, JBLK))-YDECUMF%ENTR_RH))*(PGEOH (JLON, JK-1, JBLK)-PGEOH (JLON, JK, JBLK&
                  &))*ZRG*MIN (1.0_JPRB, PQSEN (JLON, JK, JBLK)/PQSEN (JLON, IKB, JBLK))**3
                  ZOENTR (JLON, JBLK)=MIN (0.4_JPRB, ZOENTR (JLON, JBLK))*PMFU (JLON, JK, JBLK)
                ELSE
                  ZOENTR (JLON, JBLK)=0.0_JPRB
                ENDIF


                IF (JK>KDPL (JLON, JBLK)) THEN
                  PMFU (JLON, JK, JBLK)=PMFU (JLON, JK+1, JBLK)
                  PKINEU (JLON, JK, JBLK)=0.5_JPRB
                ENDIF


                IF (PKINEU (JLON, JK, JBLK)>0.0_JPRB.AND.PMFU (JLON, JK, JBLK)>0.0_JPRB.AND.(ZBUO&
                  & (JLON, JK, JBLK)>-2._JPRB.OR.(PTEN (JLON, JK-1, JBLK)-PTEN (JLON, JK, JBLK))/&
                  &(ZRG*(PGEO (JLON, JK-1, JBLK)-PGEO (JLON, JK, JBLK)))<-3.E-3_JPRB)) THEN
                  KCTOP (JLON, JBLK)=JK
                  LLO1 (JLON, JBLK)=.TRUE.
                ELSE
                  KLAB (JLON, JK, JBLK)=0
                  PMFU (JLON, JK, JBLK)=0.0_JPRB
                  PKINEU (JLON, JK, JBLK)=0.0_JPRB
                  ZDMFDE (JLON, JBLK)=PMFU (JLON, JK+1, JBLK)
                  PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
                ENDIF


                IF (PMFU (JLON, JK+1, JBLK)>0.0_JPRB) THEN
                  PMFUDE_RATE (JLON, JK, JBLK)=ZDMFDE (JLON, JBLK)
                ENDIF

              ENDIF

            ELSEIF (KTYPE (JLON, JBLK)==2.AND.PQU (JLON, JK, JBLK)==ZQOLD (JLON, JBLK)) THEN
              KLAB (JLON, JK, JBLK)=0
              PMFU (JLON, JK, JBLK)=0.0_JPRB
              PKINEU (JLON, JK, JBLK)=0.0_JPRB
              ZDMFDE (JLON, JBLK)=PMFU (JLON, JK+1, JBLK)
              PLUDE (JLON, JK, JBLK)=PLU (JLON, JK+1, JBLK)*ZDMFDE (JLON, JBLK)
              PMFUDE_RATE (JLON, JK, JBLK)=ZDMFDE (JLON, JBLK)
            ENDIF

          ENDIF


          

          

          IF (LLO1 (JLON, JBLK)) THEN

            IF (PLU (JLON, JK, JBLK)>ZDNOPRC) THEN
              PWU (JLON, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.5_JPRB, PKINEU (JLON, JK+1, JBLK))))

              IF (LDTDKMF) THEN
                ZZCO=FOEALFCU (PTU (JLON, JK, JBLK))*1.3_JPRB+(1.0_JPRB-FOEALFCU (PTU (JLON, JK, JBLK)))
              ELSE
                ZZCO=1.0_JPRB+0.3_JPRB*FOEALFCU (PTU (JLON, JK, JBLK))
              ENDIF

              
              ZXPRCDGW=ZPRCDGW
              
              ZPRCON=ZXPRCDGW/(0.75_JPRB*PWU (JLON, JK, JBLK))*ZZCO
              ZDT=MIN (YDTHF%RTBERCU-YDTHF%RTICECU, MAX (YDTHF%RTBERCU-PTU (JLON, JK, JBLK), 0.0_JPRB))
              ZCBF=1+Z_CPRC2*SQRT (ZDT)
              ZZCO=ZPRCON*ZCBF

              IF (YGFL%NACTAERO>0) THEN

                IF (YDECLDP%LAERLIQAUTOCP) THEN
                  ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))
                  ZLCRIT=ZALFAW*PLCRIT_AER (JLON, JK, JBLK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
                ELSEIF (YDECLDP%LAERLIQAUTOCPB) THEN
                  ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))
                  ZLCRIT=ZALFAW*PLCRIT_AER (JLON, KCBOT (JLON, JBLK), JBLK)+(1.0_JPRB-ZALFAW)*ZDNOPRC
                ELSE
                  ZLCRIT=ZDNOPRC/ZCBF
                ENDIF

              ELSE
                ZLCRIT=ZDNOPRC/ZCBF
              ENDIF

              ZDFI=PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK)
              ZC=(PLU (JLON, JK, JBLK)-ZLUOLD (JLON, JBLK))
              ZD=ZZCO*(1.0_JPRB-EXP (-(PLU (JLON, JK, JBLK)/ZLCRIT)**2))*ZDFI
              ZINT=EXP (-ZD)
              ZLNEW=ZLUOLD (JLON, JBLK)*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
              ZLNEW=MAX (0.0_JPRB, MIN (PLU (JLON, JK, JBLK), ZLNEW))
              ZLNEW=MIN (Z_CLDMAX, ZLNEW)
              ZPRECIP (JLON, JBLK)=MAX (0.0_JPRB, ZLUOLD (JLON, JBLK)+ZC-ZLNEW)
              PDMFUP (JLON, JK, JBLK)=ZPRECIP (JLON, JBLK)*PMFU (JLON, JK, JBLK)
              PLRAIN (JLON, JK, JBLK)=PLRAIN (JLON, JK, JBLK)+ZPRECIP (JLON, JBLK)
              PLU (JLON, JK, JBLK)=ZLNEW
            ENDIF

          ENDIF


          

          IF (YDEPHLI%LPHYLIN) THEN

            

            IF (LLO1 (JLON, JBLK)) THEN

              IF (PLRAIN (JLON, JK, JBLK)>0.0_JPRB) THEN
                ZVW=21.18_JPRB*PLRAIN (JLON, JK, JBLK)**0.2_JPRB
                ZVI=Z_CWIFRAC*ZVW
                ZALFAW=MIN (1.0_JPRB, 0.545_JPRB*(TANH (0.17_JPRB*(PTU (JLON, JK, JBLK)-YDEPHLI%RLPTRC))+1.0_JPRB))
                ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
                ZROLD=PLRAIN (JLON, JK, JBLK)-ZPRECIP (JLON, JBLK)
                ZC=ZPRECIP (JLON, JBLK)
                PWU (JLON, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JLON, JK, JBLK))))
                ZD=ZVV/PWU (JLON, JK, JBLK)
                ZINT=EXP (-ZD)
                ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
                ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JLON, JK, JBLK), ZRNEW))
                PLRAIN (JLON, JK, JBLK)=ZRNEW
              ENDIF

            ENDIF

          
          ELSE

            

            IF (LLO1 (JLON, JBLK)) THEN

              IF (PLRAIN (JLON, JK, JBLK)>0.0_JPRB) THEN
                ZVW=21.18_JPRB*PLRAIN (JLON, JK, JBLK)**0.2_JPRB
                ZVI=Z_CWIFRAC*ZVW
                ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))

                IF (LSCVFLAG (JLON, JBLK))  THEN
                  ZALFAW=1.0_JPRB
                ENDIF

                ZVV=ZALFAW*ZVW+(1.0_JPRB-ZALFAW)*ZVI
                ZROLD=PLRAIN (JLON, JK, JBLK)-ZPRECIP (JLON, JBLK)
                ZC=ZPRECIP (JLON, JBLK)
                PWU (JLON, JK, JBLK)=MIN (15._JPRB, SQRT (2.0_JPRB*MAX (0.1_JPRB, PKINEU (JLON, JK, JBLK))))
                ZD=ZVV/PWU (JLON, JK, JBLK)
                ZINT=EXP (-ZD)
                ZRNEW=ZROLD*ZINT+ZC/ZD*(1.0_JPRB-ZINT)
                ZRNEW=MAX (0.0_JPRB, MIN (PLRAIN (JLON, JK, JBLK), ZRNEW))
                PLRAIN (JLON, JK, JBLK)=ZRNEW
              ENDIF

            ENDIF

          
          ENDIF


          

          IF (LLFLAG (JLON, JBLK)) THEN
            PMFUL (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)*PMFU (JLON, JK, JBLK)
            PMFUS (JLON, JK, JBLK)=(YDCST%RCPD*PTU (JLON, JK, JBLK&
            &)+PGEOH (JLON, JK, JBLK))*PMFU (JLON, JK, JBLK)
            PMFUQ (JLON, JK, JBLK)=PQU (JLON, JK, JBLK)*PMFU (JLON, JK, JBLK)
            ZALFAW=FOEALFCU (PTU (JLON, JK, JBLK))

            IF (LSCVFLAG (JLON, JBLK))  THEN
              ZALFAW=1.0_JPRB
            ENDIF

            PLUDELI (JLON, JK, 1, JBLK)=ZALFAW*PLUDE (JLON, JK, JBLK)
            PLUDELI (JLON, JK, 2, JBLK)=(1.0_JPRB-ZALFAW)*PLUDE (JLON, JK, JBLK)
          ENDIF

        
        ENDIF

      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KCTOP => NULL ()
  KDPL => NULL ()
  KLAB => NULL ()
  KTYPE => NULL ()
  LDCUM => NULL ()
  LLFLAG => NULL ()
  LLFLAGUV => NULL ()
  LLFLAG_CUADJTQ000 => NULL ()
  LLFLAG_CUADJTQ001 => NULL ()
  LLO1 => NULL ()
  LSCVFLAG => NULL ()
  PAP => NULL ()
  PAPH => NULL ()
  PDMFEN => NULL ()
  PDMFUP => NULL ()
  PGEO => NULL ()
  PGEOH => NULL ()
  PKINEU => NULL ()
  PLCRIT_AER => NULL ()
  PLGLAC => NULL ()
  PLITOT => NULL ()
  PLRAIN => NULL ()
  PLU => NULL ()
  PLUDE => NULL ()
  PLUDELI => NULL ()
  PMFU => NULL ()
  PMFUB => NULL ()
  PMFUDE_RATE => NULL ()
  PMFUL => NULL ()
  PMFUQ => NULL ()
  PMFUS => NULL ()
  PQEN => NULL ()
  PQENH => NULL ()
  PQSEN => NULL ()
  PQU => NULL ()
  PTEN => NULL ()
  PTENH => NULL ()
  PTU => NULL ()
  PVERVEL => NULL ()
  PWMEAN => NULL ()
  PWU => NULL ()
  ZBUO => NULL ()
  ZDMFDE => NULL ()
  ZDMFEN => NULL ()
  ZDPMEAN => NULL ()
  ZENTR => NULL ()
  ZLUOLD => NULL ()
  ZOENTR => NULL ()
  ZPH => NULL ()
  ZPRECIP => NULL ()
  ZQOLD => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUASCN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:2',1,ZHOOK_HANDLE_PARALLEL)
IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUASCN_PARALLEL:3')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_HOST_DATA_RDWR (YD_KCBOT)
  KCTOP => GET_HOST_DATA_RDONLY (YD_KCTOP)
  LDCUM => GET_HOST_DATA_RDWR (YD_LDCUM)
  PWMEAN => GET_HOST_DATA_RDWR (YD_PWMEAN)
  ZDPMEAN => GET_HOST_DATA_RDONLY (YL_ZDPMEAN)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JLON) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

      IF (KCTOP (JLON, JBLK)==-1)  THEN
        LDCUM (JLON, JBLK)=.FALSE.
      ENDIF

      KCBOT (JLON, JBLK)=MAX (KCBOT (JLON, JBLK), KCTOP (JLON, JBLK))

      IF (LDCUM (JLON, JBLK)) THEN
        PWMEAN (JLON, JBLK)=MAX (1.E-2_JPRB, PWMEAN (JLON, JBLK)/MAX (1.0_JPRB, ZDPMEAN (JLON, JBLK)))
        PWMEAN (JLON, JBLK)=SQRT (2.0_JPRB*PWMEAN (JLON, JBLK))
      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KCTOP => NULL ()
  LDCUM => NULL ()
  PWMEAN => NULL ()
  ZDPMEAN => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUASCN_PARALLEL:3')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => GET_DEVICE_DATA_RDWR (YD_KCBOT)
  KCTOP => GET_DEVICE_DATA_RDONLY (YD_KCTOP)
  LDCUM => GET_DEVICE_DATA_RDWR (YD_LDCUM)
  PWMEAN => GET_DEVICE_DATA_RDWR (YD_PWMEAN)
  ZDPMEAN => GET_DEVICE_DATA_RDONLY (YL_ZDPMEAN)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (KCBOT, KCTOP, LDCUM, PWMEAN, YFXTRAN_ACDC_STACK, ZDPMEAN) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      

      IF (KCTOP (JLON, JBLK)==-1)  THEN
        LDCUM (JLON, JBLK)=.FALSE.
      ENDIF

      KCBOT (JLON, JBLK)=MAX (KCBOT (JLON, JBLK), KCTOP (JLON, JBLK))

      IF (LDCUM (JLON, JBLK)) THEN
        PWMEAN (JLON, JBLK)=MAX (1.E-2_JPRB, PWMEAN (JLON, JBLK)/MAX (1.0_JPRB, ZDPMEAN (JLON, JBLK)))
        PWMEAN (JLON, JBLK)=SQRT (2.0_JPRB*PWMEAN (JLON, JBLK))
      ENDIF

    
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KCBOT => NULL ()
  KCTOP => NULL ()
  LDCUM => NULL ()
  PWMEAN => NULL ()
  ZDPMEAN => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUASCN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL:3',1,ZHOOK_HANDLE_PARALLEL)

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (ASSOCIATED (YL_LLFLAG)) CALL FIELD_DELETE (YL_LLFLAG)
IF (ASSOCIATED (YL_LLFLAGUV)) CALL FIELD_DELETE (YL_LLFLAGUV)
IF (ASSOCIATED (YL_LLFLAG_CUADJTQ000)) CALL FIELD_DELETE (YL_LLFLAG_CUADJTQ000)
IF (ASSOCIATED (YL_LLFLAG_CUADJTQ001)) CALL FIELD_DELETE (YL_LLFLAG_CUADJTQ001)
IF (ASSOCIATED (YL_LLKLAB)) CALL FIELD_DELETE (YL_LLKLAB)
IF (ASSOCIATED (YL_LLO1)) CALL FIELD_DELETE (YL_LLO1)
IF (ASSOCIATED (YL_ZBUO)) CALL FIELD_DELETE (YL_ZBUO)
IF (ASSOCIATED (YL_ZDMFDE)) CALL FIELD_DELETE (YL_ZDMFDE)
IF (ASSOCIATED (YL_ZDMFEN)) CALL FIELD_DELETE (YL_ZDMFEN)
IF (ASSOCIATED (YL_ZDPMEAN)) CALL FIELD_DELETE (YL_ZDPMEAN)
IF (ASSOCIATED (YL_ZENTR)) CALL FIELD_DELETE (YL_ZENTR)
IF (ASSOCIATED (YL_ZLUOLD)) CALL FIELD_DELETE (YL_ZLUOLD)
IF (ASSOCIATED (YL_ZOENTR)) CALL FIELD_DELETE (YL_ZOENTR)
IF (ASSOCIATED (YL_ZPH)) CALL FIELD_DELETE (YL_ZPH)
IF (ASSOCIATED (YL_ZPRECIP)) CALL FIELD_DELETE (YL_ZPRECIP)
IF (ASSOCIATED (YL_ZQOLD)) CALL FIELD_DELETE (YL_ZQOLD)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CUASCN_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE CUASCN_PARALLEL
