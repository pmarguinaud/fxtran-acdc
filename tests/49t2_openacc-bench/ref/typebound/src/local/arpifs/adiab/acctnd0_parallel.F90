SUBROUTINE ACCTND0_PARALLEL (YDCST, LDT1, YDCPG_OPTS, YDCPG_BNDS, PRCP, YD_PACC, YD_PTND)

USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE YOMCST,ONLY:TCST
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
LOGICAL, INTENT (IN)::LDT1
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
REAL (KIND=JPRB), INTENT (IN)::PRCP
CLASS (FIELD_3RB), POINTER :: YD_PACC
REAL (KIND=JPRB), POINTER::PACC (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTND
REAL (KIND=JPRB), POINTER::PTND (:,:,:)
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
#include "abor1.intfb.h"
IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)

IF (LDT1) THEN
  IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC',0,ZHOOK_HANDLE_PARALLEL)

  IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','ACCTND0_PARALLEL:PACC')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PACC => GET_HOST_DATA_RDWR (YD_PACC)
    PTND => GET_HOST_DATA_RDONLY (YD_PTND)
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
    !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JLON) FIRSTPRIVATE (YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      CALL YLCPG_BNDS%UPDATE (JBLK)

      

      DO JLEV=1, YDCPG_OPTS%KFLEVG

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          PACC (JLON, JLEV, JBLK)=PACC (JLON, JLEV, JBLK)+(PRCP-YDCST%RCPD)*PTND (JLON, JLEV, JBLK)
        ENDDO

      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('ACCTND0_PARALLEL:PACC')) THEN
      IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PACC => GET_HOST_DATA_RDWR (YD_PACC)
      PTND => GET_HOST_DATA_RDWR (YD_PTND)
      IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PACC => NULL ()
    PTND => NULL ()
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','ACCTND0_PARALLEL:PACC')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PACC => GET_HOST_DATA_RDWR (YD_PACC)
    PTND => GET_HOST_DATA_RDONLY (YD_PTND)
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JLON, YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

      

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON

        

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PACC (JLON, JLEV, JBLK)=PACC (JLON, JLEV, JBLK)+(PRCP-YDCST%RCPD)*PTND (JLON, JLEV, JBLK)
        
        ENDDO

      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('ACCTND0_PARALLEL:PACC')) THEN
      IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PACC => GET_HOST_DATA_RDWR (YD_PACC)
      PTND => GET_HOST_DATA_RDWR (YD_PTND)
      IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PACC => NULL ()
    PTND => NULL ()
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','ACCTND0_PARALLEL:PACC')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PACC => GET_DEVICE_DATA_RDWR (YD_PACC)
    PTND => GET_DEVICE_DATA_RDONLY (YD_PTND)
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    
      !$ACC PARALLEL LOOP GANG &
      !$ACC&PRESENT (PACC, PTND, YDCPG_OPTS, YDCST, YFXTRAN_ACDC_STACK) &
      !$ACC&PRIVATE (JBLK) &
      !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
      
      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      
      
      
      !$ACC LOOP VECTOR &
      !$ACC&PRIVATE (JLEV, JLON, YLCPG_BNDS) 

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON

        

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PACC (JLON, JLEV, JBLK)=PACC (JLON, JLEV, JBLK)+(PRCP-YDCST%RCPD)*PTND (JLON, JLEV, JBLK)
        
        ENDDO

      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('ACCTND0_PARALLEL:PACC')) THEN
      IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PACC => GET_HOST_DATA_RDWR (YD_PACC)
      PTND => GET_HOST_DATA_RDWR (YD_PTND)
      IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PACC => NULL ()
    PTND => NULL ()
    IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSE
      CALL ABOR1 ('ACCTND0_PARALLEL: NOT METHOD WAS FOUND')
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL:PACC',1,ZHOOK_HANDLE_PARALLEL)
ENDIF


CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('ACCTND0_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE ACCTND0_PARALLEL
