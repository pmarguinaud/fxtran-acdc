SUBROUTINE GPGW_OPENACC (YDGEOMETRY, LDNHDYN, KFLEV, KPROMA, KST, KEND, LDGWF, LDGDWI, POROGL, POROGM&
&, PLNPR, PALPH, PUS, PVS, PRT, PDVER, PGWH, PGWF, LDVFE, PRNHPPI, PTAUD_NL, PGDW, YDSTACK)
!$ACC ROUTINE (GPGW_OPENACC) SEQ
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
LOGICAL, INTENT (IN)::LDNHDYN
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
LOGICAL, INTENT (IN)::LDGDWI
LOGICAL, INTENT (IN)::LDGWF
REAL (KIND=JPRB), INTENT (IN)::POROGL (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::POROGM (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PUS (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PVS (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PRT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDVER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), TARGET::PGWH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PGWF (KPROMA, KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LDVFE
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PRNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PTAUD_NL
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PGDW (KPROMA, KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
fxtran_acdc_temp (REAL (KIND=JPRB), ZGDW0, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZIN, (KPROMA, 0:KFLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGDW, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRNHPPI, (KPROMA, KFLEV))
REAL (KIND=JPRB)::ZNHPPI
LOGICAL::LLVFE


#include "verdisint_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZGDW0) == 8) THEN
    fxtran_acdc_alloc8 (ZGDW0)
ELSEIF (KIND (ZGDW0) == 4) THEN
    fxtran_acdc_alloc4 (ZGDW0)
ELSE
    STOP 1
ENDIF


IF (KIND (ZIN) == 8) THEN
    fxtran_acdc_alloc8 (ZIN)
ELSEIF (KIND (ZIN) == 4) THEN
    fxtran_acdc_alloc4 (ZIN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRNHPPI) == 8) THEN
    fxtran_acdc_alloc8 (ZRNHPPI)
ELSEIF (KIND (ZRNHPPI) == 4) THEN
    fxtran_acdc_alloc4 (ZRNHPPI)
ELSE
    STOP 1
ENDIF


JROF = KST



IF (PRESENT (LDVFE)) THEN
  LLVFE=LDVFE
ELSE
  LLVFE=YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE.AND.(YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_GW&
  &.OR..NOT.LDNHDYN).AND.(.NOT.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE)
ENDIF


IF (LLVFE.AND.PRESENT (PGDW)) THEN
  fxtran_acdc_assoc (ZGDW, PGDW)
ELSE
  fxtran_acdc_assoc (ZGDW, ZGDW0)
ENDIF

PGWH (JROF, KFLEV)=PUS (JROF)*POROGL (JROF)+PVS (JROF)*POROGM (JROF)

IF (LDGDWI) THEN

  DO JLEV=1, KFLEV
    
    ZGDW (JROF, JLEV)=PDVER (JROF, JLEV)
  
  ENDDO

ELSEIF (PRESENT (PRNHPPI)) THEN

  IF (PRESENT (PTAUD_NL)) THEN

    DO JLEV=1, KFLEV
      
      ZNHPPI=1.0_JPRB+PTAUD_NL*(1.0_JPRB/PRNHPPI (JROF, JLEV)-1.0_JPRB)
      ZRNHPPI (JROF, JLEV)=1.0_JPRB/ZNHPPI
    
    ENDDO

  ELSE
    ZRNHPPI (JROF, 1:KFLEV)=PRNHPPI (JROF, 1:KFLEV)
  ENDIF


  DO JLEV=1, KFLEV
    
    ZGDW (JROF, JLEV)=PDVER (JROF, JLEV)*PRT (JROF, JLEV)*PLNPR (JROF, JLEV)*PRNHPPI (JROF, JLEV)
  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    ZGDW (JROF, JLEV)=PDVER (JROF, JLEV)*PRT (JROF, JLEV)*PLNPR (JROF, JLEV)
  
  ENDDO

ENDIF


IF (LLVFE) THEN

  DO JLEV=1, KFLEV
    ZIN (JROF, JLEV)=-ZGDW (JROF, JLEV)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
  ENDDO


  IF (LDGDWI) THEN
    ZIN (JROF, 0)=ZGDW (JROF, 1)
    ZIN (JROF, KFLEV+1)=ZGDW (JROF, KFLEV)
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'ITOP','00&
    &', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), KLOUT=KFLEV, YDSTACK=YLSTACK)
  ELSEIF (LDNHDYN) THEN
    ZIN (JROF, 0)=ZGDW (JROF, 1)
    ZIN (JROF, KFLEV+1)=ZGDW (JROF, KFLEV)
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'INGW','00&
    &', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), KLOUT=KFLEV, YDSTACK=YLSTACK)
  ELSE
    ZIN (JROF, 0)=0.0_JPRB
    ZIN (JROF, KFLEV+1)=0.0_JPRB
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'IBOT&
    &','11', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), YDSTACK=YLSTACK)
  ENDIF

ELSE

  IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE) THEN

    DO JLEV=KFLEV, 1,-1
      
      PGWH (JROF, JLEV-1)=PGWH (JROF, JLEV)+(ZGDW (JROF, JLEV&
      &)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV))
    
    ENDDO


    IF (LDGWF) THEN

      IF (LDGDWI)  THEN
        CALL FXTRAN_ACDC_ABORT (' GPGW: compute "Gw" at full levels: case not coded')
      ENDIF


      DO JLEV=1, KFLEV
        
        ZIN (JROF, JLEV)=-ZGDW (JROF, JLEV)*(YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO&
        & (JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV))
      
      ENDDO

      ZIN (JROF, 0)=0.0_JPRB
      ZIN (JROF, KFLEV+1)=0.0_JPRB
      CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'IBOT&
      &','11', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), YDSTACK=YLSTACK)
    ENDIF

  ELSE

    DO JLEV=KFLEV, 1,-1
      
      PGWH (JROF, JLEV-1)=PGWH (JROF, JLEV)+ZGDW (JROF, JLEV)
    
    ENDDO


    IF (LDGWF) THEN

      IF (LDGDWI)  THEN
        CALL FXTRAN_ACDC_ABORT (' GPGW: compute "Gw" at full levels: case not coded')
      ENDIF


      IF (PRESENT (PRNHPPI)) THEN

        DO JLEV=1, KFLEV
          
          PGWF (JROF, JLEV)=PGWH (JROF, JLEV)+PDVER (JROF, JLEV)*PRT&
          & (JROF, JLEV)*PALPH (JROF, JLEV)*ZRNHPPI (JROF, JLEV)
        
        ENDDO

      ELSE

        DO JLEV=1, KFLEV
          
          PGWF (JROF, JLEV)=PGWH (JROF, JLEV)+PDVER (JROF, JLEV)*PRT (JROF, JLEV)*PALPH (JROF, JLEV)
        
        ENDDO

      ENDIF

    ENDIF

  ENDIF

ENDIF


END SUBROUTINE GPGW_OPENACC
