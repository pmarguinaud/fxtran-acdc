SUBROUTINE LATTEX_DNT_OPENACC (KSTEP, YDGEOMETRY, YDLDDH, YDRIP, YDDYN, YDDYNA, KST, KEND&
&, LDSETTLS, KXLAG, PESGP, PESGM, PXT0, PXT9, PMOY1X, PMIXNL, PXSI, PXNLT9, PXT1, PXL0&
&, PXL9, PXLF9, PCXNLT9, PSIDDHXT1, PSIDDHXT9, PSIDDHXL0, PXLF0, LDNESC, YDSTACK)
!$ACC ROUTINE (LATTEX_DNT_OPENACC) SEQ
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMDYNA,ONLY:TDYNA
USE YOMDYN,ONLY:TDYN
USE YOMRIP,ONLY:TRIP
USE YOMLDDH,ONLY:TLDDH
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


INTEGER (KIND=JPIM), INTENT (IN)::KSTEP
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TLDDH), INTENT (IN)::YDLDDH
TYPE (TRIP), INTENT (IN)::YDRIP
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
LOGICAL, INTENT (IN)::LDSETTLS
INTEGER (KIND=JPIM), INTENT (IN)::KXLAG
REAL (KIND=JPRB), INTENT (IN)::PESGP
REAL (KIND=JPRB), INTENT (IN)::PESGM
REAL (KIND=JPRB), INTENT (IN)::PXT0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PXT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMOY1X (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMIXNL (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXSI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXNLT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXL0 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (INOUT)::PXL9 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (INOUT)::PXLF9 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (INOUT)::PCXNLT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSIDDHXT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSIDDHXT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSIDDHXL0 (YDGEOMETRY%YRDIM&
&%NPROMA, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (OUT)::PXLF0 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
LOGICAL, INTENT (IN), OPTIONAL::LDNESC
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZXNLT1 
REAL (KIND=JPRB)::ZXNLT0 
REAL (KIND=JPRB)::ZXIGP
REAL (KIND=JPRB)::ZXIDT9
REAL (KIND=JPRB)::ZXIDT0
REAL (KIND=JPRB)::ZMIXNL
REAL (KIND=JPRB)::ZSETTLS
REAL (KIND=JPRB)::ZNESC
LOGICAL::LLNESC
LOGICAL::LLCT


JROF = KST







IF (PRESENT (LDNESC)) THEN
  LLNESC=LDNESC
ELSE
  LLNESC=YDDYNA%LNESC
ENDIF

LLCT=(YDDYNA%LPC_FULL.AND.YDDYN%NCURRENT_ITER>0)
ZXIDT0=1.0_JPRB+YDDYN%XIDT
ZXIDT9=1.0_JPRB+YDDYN%XIDT
ZXIGP=1.0_JPRB+YDDYN%XIDT

IF (.NOT.LLCT) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    ZXNLT0 =PMOY1X (JROF, JLEV)+ZXIDT0*PXSI (JROF, JLEV)

    

    IF ((KXLAG==2).AND.(YDDYN%NSPLTHOI/=0)) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN
        
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT0 (JROF, JLEV)
        PXLF9 (JROF, JLEV)=PXLF9 (JROF, JLEV)+PESGM*PMOY1X (JROF, JLEV)
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
      
      ELSEIF (LDSETTLS) THEN
        
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT0 (JROF, JLEV)
        ZNESC=PESGM*PMOY1X (JROF, JLEV)
        ZSETTLS=PESGM*PMOY1X (JROF, JLEV)+(ZXNLT0 -PXNLT9 (JROF, JLEV))
        ZMIXNL=PMIXNL (JROF, JLEV)
        PXLF9 (JROF, JLEV)=PXLF9 (JROF, JLEV)+ZMIXNL*ZSETTLS+(1.0_JPRB-ZMIXNL)*ZNESC
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
      
      ELSE
        
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT0 (JROF, JLEV)
        PXLF9 (JROF, JLEV)=PXLF9 (JROF, JLEV)+PESGM*PMOY1X (JROF&
        &, JLEV)+0.5_JPRB*PESGM*(ZXNLT0 -PXNLT9 (JROF, JLEV))
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*(1.5_JPRB*ZXNLT0 -0.5_JPRB*PXNLT9 (JROF, JLEV))
      
      ENDIF

    ELSEIF ((KXLAG==2).AND.(YDDYN%NSPLTHOI==0)) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN
        
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT0 (JROF, JLEV)+PESGM*PMOY1X (JROF, JLEV)
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
      
      ELSEIF (LDSETTLS) THEN
        
        ZNESC=PXT0 (JROF, JLEV)+PESGM*PMOY1X (JROF, JLEV)
        ZSETTLS=PXT0 (JROF, JLEV)+PESGM*PMOY1X (JROF, JLEV)+(ZXNLT0 -PXNLT9 (JROF, JLEV))
        ZMIXNL=PMIXNL (JROF, JLEV)
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+ZMIXNL*ZSETTLS+(1.0_JPRB-ZMIXNL)*ZNESC
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
      
      ELSE
        
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT0 (JROF, JLEV)+PESGM*PMOY1X&
        & (JROF, JLEV)+0.5_JPRB*PESGM*(ZXNLT0 -PXNLT9 (JROF, JLEV))
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*(1.5_JPRB*ZXNLT0 -0.5_JPRB*PXNLT9 (JROF, JLEV))
      
      ENDIF

    ELSEIF (KXLAG>=3) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN
        
        PXL0 (JROF, JLEV)=PXL0 (JROF, JLEV)+PESGM*PMOY1X (JROF, JLEV)
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
      
      ELSEIF (LDSETTLS) THEN

        IF (YDDYNA%LPC_CHEAP) THEN
          
          ZNESC=PESGM*PMOY1X (JROF, JLEV)
          ZSETTLS=ZXNLT0 -PXNLT9 (JROF, JLEV)
          ZMIXNL=PMIXNL (JROF, JLEV)
          PXL0 (JROF, JLEV)=PXL0 (JROF, JLEV)+ZNESC
          PXLF0 (JROF, JLEV)=ZMIXNL*ZSETTLS
          PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
        
        ELSE
          
          ZNESC=PESGM*PMOY1X (JROF, JLEV)
          ZSETTLS=ZXNLT0 -PXNLT9 (JROF, JLEV)
          ZMIXNL=PMIXNL (JROF, JLEV)
          PXL0 (JROF, JLEV)=PXL0 (JROF, JLEV)+ZNESC+ZMIXNL*ZSETTLS
          PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT0 
        
        ENDIF

      ELSE
        
        PXL0 (JROF, JLEV)=PXL0 (JROF, JLEV)+PESGM*PMOY1X (JROF,&
        & JLEV)+0.5_JPRB*PESGM*(ZXNLT0 -PXNLT9 (JROF, JLEV))
        PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*(1.5_JPRB*ZXNLT0 -0.5_JPRB*PXNLT9 (JROF, JLEV))
      
      ENDIF

      
      PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT0 (JROF, JLEV)
    
    ENDIF


    IF (YDDYNA%LPC_FULL) THEN
      PCXNLT9 (JROF, JLEV)=PMOY1X (JROF, JLEV)
    ENDIF


    IF (.NOT.LLNESC) THEN
      
      PXNLT9 (JROF, JLEV)=PMOY1X (JROF, JLEV)+ZXIDT9*PXSI (JROF, JLEV)
    
    ENDIF

  ENDDO

ELSE

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
    
    ZXNLT1 =PMOY1X (JROF, JLEV)+ZXIDT9*PXSI (JROF, JLEV)

    

    IF (KXLAG==2) THEN

      IF (.NOT.YDDYNA%LPC_CHEAP) THEN

        IF (YDDYN%NSPLTHOI/=0) THEN
          
          PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT9 (JROF, JLEV)
          PXLF9 (JROF, JLEV)=PXLF9 (JROF, JLEV)+PESGM*PCXNLT9 (JROF, JLEV)
        
        ELSE
          
          PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT9 (JROF, JLEV)+PESGM*PCXNLT9 (JROF, JLEV)
        
        ENDIF

      ENDIF

      
      PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT1 
    
    ELSEIF (KXLAG>=3) THEN

      IF (.NOT.YDDYNA%LPC_CHEAP) THEN
        
        PXL0 (JROF, JLEV)=PXL0 (JROF, JLEV)+PESGM*PCXNLT9 (JROF, JLEV)
        PXL9 (JROF, JLEV)=PXL9 (JROF, JLEV)+PXT9 (JROF, JLEV)
      
      ENDIF

      
      PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)+PESGP*ZXNLT1 
    
    ENDIF

  ENDDO

ENDIF


DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

  IF (YDDYN%XIDT>0.0_JPRB) THEN
    
    PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)-ZXIGP*PXSI (JROF, JLEV)
    PXSI (JROF, JLEV)=ZXIGP*PXSI (JROF, JLEV)
  
  ELSE
    
    PXT1 (JROF, JLEV)=PXT1 (JROF, JLEV)-PESGP*PXSI (JROF, JLEV)
    PXSI (JROF, JLEV)=PESGP*PXSI (JROF, JLEV)
  
  ENDIF

ENDDO


IF (YDLDDH%LRSIDDH) THEN

  IF (.NOT.LLCT) THEN

    IF (KXLAG>=3) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          PSIDDHXT1 (JROF, JLEV)=PSIDDHXT1 (JROF, JLEV)+PESGP*ZXIDT0*PXSI (JROF, JLEV)
        
        ENDDO

      ELSEIF (LDSETTLS) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          PSIDDHXL0 (JROF, JLEV)=PSIDDHXL0 (JROF, JLEV)+(ZXIDT0*PXSI (JROF, JLEV)-PSIDDHXT9 (JROF, JLEV))
          PSIDDHXT1 (JROF, JLEV)=PSIDDHXT1 (JROF, JLEV)+PESGP*ZXIDT0*PXSI (JROF, JLEV)
        
        ENDDO

      ELSE

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
          
          PSIDDHXL0 (JROF, JLEV)=PSIDDHXL0 (JROF, JLEV)+0.5_JPRB*PESGM&
          &*(ZXIDT0*PXSI (JROF, JLEV)-PSIDDHXT9 (JROF, JLEV))
          PSIDDHXT1 (JROF, JLEV)=PSIDDHXT1 (JROF, JLEV)+PESGP*(1.5_JPRB&
          &*ZXIDT0*PXSI (JROF, JLEV)-0.5_JPRB*PSIDDHXT9 (JROF, JLEV))
        
        ENDDO

      ENDIF

    ENDIF


    IF (.NOT.LLNESC) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        PSIDDHXT9 (JROF, JLEV)=ZXIDT9*PXSI (JROF, JLEV)
      
      ENDDO

    ENDIF

  ELSE

    IF (KXLAG>=3) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        PSIDDHXT1 (JROF, JLEV)=PSIDDHXT1 (JROF, JLEV)+PESGP*ZXIDT9*PXSI (JROF, JLEV)
      
      ENDDO

    ENDIF

  ENDIF

ENDIF




END SUBROUTINE LATTEX_DNT_OPENACC
