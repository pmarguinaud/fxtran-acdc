SUBROUTINE ACEVOLET_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIAT, KTDIAN&
&, KLEV, PAPHI, PAPHIF, PAPRS, PAPRSF, PDELP, PECT, PKUROV, PR, PT, PU, PV, PUSLE&
&, PPRODTH, PKCLS, PECTCLS, PECT1, PPRDY, PDIFF, PDISS, YDSTACK)
!$ACC ROUTINE (ACEVOLET_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIAT
INTEGER (KIND=JPIM), INTENT (IN)::KTDIAN
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PKUROV (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUSLE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PPRODTH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PKCLS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PECTCLS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PECT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PECT1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PPRDY (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDIFF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZANKP1 
REAL (KIND=JPRB)::ZCOR 
fxtran_acdc_temp (REAL (KIND=JPRB), ZGKEF, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDET, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZGKU, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZE, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA, (KLON, KLEV))
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZDPHI2
REAL (KIND=JPRB)::ZZGKEF
REAL (KIND=JPRB)::ZZDIS
REAL (KIND=JPRB)::ZY
REAL (KIND=JPRB)::ZX
REAL (KIND=JPRB)::ZUSGDT
REAL (KIND=JPRB)::ZRTI
REAL (KIND=JPRB)::ZRHOF
REAL (KIND=JPRB)::ZMDP
REAL (KIND=JPRB)::ZGSDP
REAL (KIND=JPRB)::ZDPHISRO
REAL (KIND=JPRB)::ZDPHI
REAL (KIND=JPRB)::ZD3
REAL (KIND=JPRB)::ZD2
REAL (KIND=JPRB)::ZD1
REAL (KIND=JPRB)::ZD
REAL (KIND=JPRB)::ZCIS
REAL (KIND=JPRB)::ZB
REAL (KIND=JPRB)::ZEPS


YLSTACK = YDSTACK



IF (KIND (ZGKEF) == 8) THEN
    fxtran_acdc_alloc8 (ZGKEF)
ELSEIF (KIND (ZGKEF) == 4) THEN
    fxtran_acdc_alloc4 (ZGKEF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDET) == 8) THEN
    fxtran_acdc_alloc8 (ZDET)
ELSEIF (KIND (ZDET) == 4) THEN
    fxtran_acdc_alloc4 (ZDET)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGKU) == 8) THEN
    fxtran_acdc_alloc8 (ZGKU)
ELSEIF (KIND (ZGKU) == 4) THEN
    fxtran_acdc_alloc4 (ZGKU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPA) == 8) THEN
    fxtran_acdc_alloc8 (ZPA)
ELSEIF (KIND (ZPA) == 4) THEN
    fxtran_acdc_alloc4 (ZPA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZE) == 8) THEN
    fxtran_acdc_alloc8 (ZE)
ELSEIF (KIND (ZE) == 4) THEN
    fxtran_acdc_alloc4 (ZE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA) == 8) THEN
    fxtran_acdc_alloc8 (ZA)
ELSEIF (KIND (ZA) == 4) THEN
    fxtran_acdc_alloc4 (ZA)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPS=1.E-14
ZUSGDT=1.0_JPRB/(YDCST%RG*YDML_PHY_MF%YRPHY2%TSPHY)

DO JLEV=KTDIAN, KLEV-1
  
  ZDPHI=PAPHIF (JLON, JLEV)-PAPHIF (JLON, JLEV+1)
  ZRTI=0.5_JPRB*(PR (JLON, JLEV)*PT (JLON, JLEV)+PR (JLON, JLEV+1)*PT (JLON, JLEV+1))
  ZDPHISRO=ZDPHI*ZRTI/PAPRS (JLON, JLEV)
  ZGKU (JLON, JLEV)=PKUROV (JLON, JLEV)*ZDPHISRO
  
ENDDO

PPRDY (JLON,:)=0.0_JPRB
PDIFF (JLON,:)=0.0_JPRB
PDISS (JLON,:)=0.0_JPRB

ZA (JLON, KTDIAN)=0.0_JPRB
ZA (JLON, KTDIAN+1)=0.0_JPRB
ZE (JLON, KTDIAN)=0.0_JPRB
ZPA (JLON, KTDIAN)=0.0_JPRB


DO JLEV=KTDIAN+1, KLEV-1
  
  ZGKEF (JLON, JLEV)=YDML_PHY_MF%YRPHY0%ALPHAE*(ZGKU (JLON, JLEV)+ZGKU (JLON, JLEV-1))/2.0_JPRB
  
ENDDO


DO JLEV=KTDIAN+1, KLEV-1
  
  ZDPHI=PAPHI (JLON, JLEV-1)-PAPHI (JLON, JLEV)
  ZRHOF=PAPRSF (JLON, JLEV)/(PR (JLON, JLEV)*PT (JLON, JLEV))
  ZA (JLON, JLEV+1)=ZGKEF (JLON, JLEV)*ZRHOF/ZDPHI
  ZPA (JLON, JLEV)=ZA (JLON, JLEV+1)
  
ENDDO


DO JLEV=KTDIAN, KLEV-2
  
  ZMDP=PAPRSF (JLON, JLEV)-PAPRSF (JLON, JLEV+1)
  ZDPHI2=(PAPHIF (JLON, JLEV)-PAPHIF (JLON, JLEV+1))**2
  ZGSDP=YDCST%RG/ZMDP
  ZX=ZMDP*ZUSGDT
  ZZDIS=PUSLE (JLON, JLEV)*SQRT (PECT (JLON, JLEV))*ZMDP
  ZB=ZX-ZA (JLON, JLEV+1)-ZA (JLON, JLEV+2)+YDML_PHY_MF%YRPHY0%ADISI*ZZDIS
  ZY=1.0_JPRB/(ZB+ZA (JLON, JLEV+1)*ZE (JLON, JLEV))
  ZE (JLON, JLEV+1)=-ZA (JLON, JLEV+2)*ZY
  ZCIS=(PU (JLON, JLEV+1)-PU (JLON, JLEV))**2+(PV (JLON, JLEV+1)-PV (JLON, JLEV))**2
  ZD1=PECT (JLON, JLEV)*(ZX-YDML_PHY_MF%YRPHY0%ADISE*ZZDIS)
  ZD2=ZGKU (JLON, JLEV)*ZCIS*ZMDP/ZDPHI2
  ZD3=PPRODTH (JLON, JLEV)/ZGSDP
  ZD=ZD1+ZD2+ZD3
  ZA (JLON, JLEV+1)=(ZD-ZA (JLON, JLEV+1)*ZA (JLON, JLEV))*ZY
  PPRDY (JLON, JLEV)=ZD2*ZGSDP
  PDISS (JLON, JLEV)=-ZZDIS*ZGSDP
  
ENDDO


ZDPHI=PAPHI (JLON, KLEV-1)-PAPHI (JLON, KLEV)
ZDPHI2=(PAPHIF (JLON, KLEV-1)-PAPHIF (JLON, KLEV))**2
ZRHOF=PAPRSF (JLON, KLEV)/(PR (JLON, KLEV)*PT (JLON, KLEV))
ZZGKEF=YDML_PHY_MF%YRPHY0%ALPHAE*PKCLS (JLON)
ZANKP1 =ZZGKEF*ZRHOF/ZDPHI
ZMDP=PAPRSF (JLON, KLEV-1)-PAPRSF (JLON, KLEV)
ZGSDP=YDCST%RG/ZMDP
ZX=ZMDP*ZUSGDT
ZZDIS=PUSLE (JLON, KLEV-1)*SQRT (PECT (JLON, KLEV-1))*ZMDP
ZB=ZX-ZA (JLON, KLEV)-ZANKP1 +YDML_PHY_MF%YRPHY0%ADISI*ZZDIS
ZY=1.0_JPRB/(ZB+ZA (JLON, KLEV)*ZE (JLON, KLEV-1))
ZCIS=(PU (JLON, KLEV)-PU (JLON, KLEV-1))**2+(PV (JLON, KLEV)-PV (JLON, KLEV-1))**2
ZD1=PECT (JLON, KLEV-1)*(ZX-YDML_PHY_MF%YRPHY0%ADISE*ZZDIS)
ZD2=ZGKU (JLON, KLEV-1)*ZCIS*ZMDP/ZDPHI2
ZD3=PPRODTH (JLON, KLEV-1)/ZGSDP
ZD=ZD1+ZD2+ZD3-ZANKP1 *PECTCLS (JLON)
ZA (JLON, KLEV)=(ZD-ZA (JLON, KLEV)*ZA (JLON, KLEV-1))*ZY
PPRDY (JLON, KLEV-1)=ZD2*ZGSDP
PDISS (JLON, KLEV-1)=-ZZDIS*ZGSDP*(YDML_PHY_MF%YRPHY0%ADISI*ZA&
& (JLON, KLEV)+YDML_PHY_MF%YRPHY0%ADISE*PECT (JLON, KLEV-1))


DO JLEV=KLEV-2, KTDIAN,-1
  
  ZA (JLON, JLEV+1)=ZE (JLON, JLEV+1)*ZA (JLON, JLEV+2)+ZA (JLON, JLEV+1)
  PDISS (JLON, JLEV)=PDISS (JLON, JLEV)*(YDML_PHY_MF%YRPHY0%ADISI*ZA&
  & (JLON, JLEV+1)+YDML_PHY_MF%YRPHY0%ADISE*PECT (JLON, JLEV))
  
ENDDO


ZGSDP=YDCST%RG/(PAPRSF (JLON, KLEV-1)-PAPRSF (JLON, KLEV))
PDIFF (JLON, KLEV-1)=(ZPA (JLON, KLEV-1)*(ZA (JLON, KLEV)-ZA (JLON&
&, KLEV-1))-ZANKP1 *(PECTCLS (JLON)-ZA (JLON, KLEV)))*ZGSDP


DO JLEV=KLEV-2, KTDIAN,-1
  
  ZGSDP=YDCST%RG/(PAPRSF (JLON, JLEV)-PAPRSF (JLON, JLEV+1))
  PDIFF (JLON, JLEV)=(ZPA (JLON, JLEV)*(ZA (JLON, JLEV+1)-ZA (JLON, JLEV&
  &))-ZPA (JLON, JLEV+1)*(ZA (JLON, JLEV+2)-ZA (JLON, JLEV+1)))*ZGSDP
  
ENDDO


DO JLEV=KTDIAT, KTDIAN-1
  
  ZDET (JLON, JLEV)=0.0_JPRB
  PECT1 (JLON, JLEV)=PECT (JLON, JLEV)
  
ENDDO


DO JLEV=KTDIAN, KLEV-1
  
  ZDET (JLON, JLEV)=MIN ((YDML_PHY_MF%YRPHY0%ECTMAX-PECT (JLON, JLEV))/YDML_PHY_MF%YRPHY2&
  &%TSPHY, MAX ((YDML_PHY_MF%YRPHY0%ECTMIN-PECT (JLON, JLEV))/YDML_PHY_MF%YRPHY2%TSPHY,&
  & PDIFF (JLON, JLEV)+PDISS (JLON, JLEV)+PPRDY (JLON, JLEV)+PPRODTH (JLON, JLEV)))
  PECT1 (JLON, JLEV)=PECT (JLON, JLEV)+YDML_PHY_MF%YRPHY2%TSPHY*ZDET (JLON, JLEV)
  
ENDDO


IF (YDML_PHY_MF%YRPHY%LECTREP) THEN
  
  ZDET (JLON, KLEV)=(MIN (YDML_PHY_MF%YRPHY0%ECTMAX, MAX (YDML_PHY_MF%YRPHY0%ECTMIN&
  &, PECT1 (JLON, KLEV-1)))-PECT (JLON, KLEV))/YDML_PHY_MF%YRPHY2%TSPHY
  
ELSE
  
  ZDET (JLON, KLEV)=(MIN (YDML_PHY_MF%YRPHY0%ECTMAX, MAX (YDML_PHY_MF%YRPHY0&
  &%ECTMIN, PECTCLS (JLON)))-PECT (JLON, KLEV))/YDML_PHY_MF%YRPHY2%TSPHY
  
ENDIF


PECT1 (JLON, KLEV)=PECT (JLON, KLEV)+YDML_PHY_MF%YRPHY2%TSPHY*ZDET (JLON, KLEV)
ZCOR =ZDET (JLON, KLEV)/(SIGN (1._JPRB, ZDET (JLON, KLEV-1))*MAX (ZEPS, ABS (ZDET (JLON, KLEV-1))))
ZCOR =MAX (1.0_JPRB, ZCOR )
PDIFF (JLON, KLEV)=PDIFF (JLON, KLEV-1)*ZCOR 
PDISS (JLON, KLEV)=PDISS (JLON, KLEV-1)*ZCOR 
PPRDY (JLON, KLEV)=PPRDY (JLON, KLEV-1)*ZCOR 
PPRODTH (JLON, KLEV)=PPRODTH (JLON, KLEV-1)*ZCOR 



END SUBROUTINE ACEVOLET_OPENACC
