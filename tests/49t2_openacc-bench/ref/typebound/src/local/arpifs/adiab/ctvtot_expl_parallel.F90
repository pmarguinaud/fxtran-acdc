SUBROUTINE CTVTOT_EXPL_PARALLEL (YDCST, YDGEOMETRY, YDVARS, YDCPG_OPTS, YDCPG_BNDS)
USE GEOMETRY_MOD,ONLY:GEOMETRY

USE YOMHOOK,ONLY:DR_HOOK, JPHOOK, LHOOK
USE YOMCST,ONLY:TCST
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
#include "gprcp_expl_parallel.intfb.h"
#include "abor1.intfb.h"
CLASS (FIELD_3RB), POINTER :: YL_ZR
REAL (KIND=JPRB), POINTER::ZR (:,:,:)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL(KIND=JPRB), POINTER :: Z_YDVARS_T_T0(:,:,:)
IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
CALL FIELD_NEW (YL_ZR, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)


CALL GPRCP_EXPL_PARALLEL (YDCST, YDCPG_BNDS, YDCPG_OPTS, YDVARS=YDVARS, YD_PR=YL_ZR)
IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CTVTOT_EXPL_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ZR => GET_HOST_DATA_RDONLY (YL_ZR)
  Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JROF) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

      DO JROF=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        Z_YDVARS_T_T0 (JROF, JLEV, JBLK)=YDCST%RD*Z_YDVARS_T_T0 (JROF, JLEV, JBLK)/ZR (JROF, JLEV, JBLK)
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CTVTOT_EXPL_PARALLEL:0')) THEN
    IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    ZR => GET_HOST_DATA_RDWR (YL_ZR)
    Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
    IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ZR => NULL ()
  Z_YDVARS_T_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','CTVTOT_EXPL_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ZR => GET_HOST_DATA_RDONLY (YL_ZR)
  Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JROF, YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

    

    

    DO JROF = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JROF
      YLCPG_BNDS%KFDIA = JROF

      

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        Z_YDVARS_T_T0 (JROF, JLEV, JBLK)=YDCST%RD*Z_YDVARS_T_T0 (JROF, JLEV, JBLK)/ZR (JROF, JLEV, JBLK)
      
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CTVTOT_EXPL_PARALLEL:0')) THEN
    IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    ZR => GET_HOST_DATA_RDWR (YL_ZR)
    Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
    IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ZR => NULL ()
  Z_YDVARS_T_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CTVTOT_EXPL_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ZR => GET_DEVICE_DATA_RDONLY (YL_ZR)
  Z_YDVARS_T_T0 => GET_DEVICE_DATA_RDWR (YDVARS%T%FT0)
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (YDCPG_OPTS, YDCST, YDGEOMETRY, YFXTRAN_ACDC_STACK, ZR, Z_YDVARS_T_T0) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLEV, JROF, YLCPG_BNDS) 

    

    DO JROF = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JROF
      YLCPG_BNDS%KFDIA = JROF

      

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG
        
        Z_YDVARS_T_T0 (JROF, JLEV, JBLK)=YDCST%RD*Z_YDVARS_T_T0 (JROF, JLEV, JBLK)/ZR (JROF, JLEV, JBLK)
      
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('CTVTOT_EXPL_PARALLEL:0')) THEN
    IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    ZR => GET_HOST_DATA_RDWR (YL_ZR)
    Z_YDVARS_T_T0 => GET_HOST_DATA_RDWR (YDVARS%T%FT0)
    IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ZR => NULL ()
  Z_YDVARS_T_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CTVTOT_EXPL_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL:0',1,ZHOOK_HANDLE_PARALLEL)



CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (ASSOCIATED (YL_ZR)) CALL FIELD_DELETE (YL_ZR)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CTVTOT_EXPL_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE CTVTOT_EXPL_PARALLEL
