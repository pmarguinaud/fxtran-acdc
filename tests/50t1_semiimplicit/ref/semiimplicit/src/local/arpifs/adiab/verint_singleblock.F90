SUBROUTINE VERINT_SINGLEBLOCK (KPROMA, KST, KEND, KLEVIN, KLEVOUT&
&, PINTE, PIN, POUT, KTYPE, KCHUNK, POUTS, PINS, LDACC)
USE PARKIND1,ONLY:JPRD, JPIM, JPRB
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMLUN,ONLY:NULERR
USE OML_MOD,ONLY:OML_IN_PARALLEL
USE FXTRAN_ACDC_GEMM_MOD,ONLY:FXTRAN_ACDC_GEMM
USE FXTRAN_ACDC_GEMM_MOD_SINGLEBLOCK, ONLY : FXTRAN_ACDC_GEMM_SINGLEBLOCK
USE FXTRAN_ACDC_STACK_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


#ifdef FXTRAN_ACDC
#endif
INTEGER (KIND=JPIM), INTENT (IN)::KCHUNK
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KLEVOUT
INTEGER (KIND=JPIM), INTENT (IN)::KLEVIN
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
REAL (KIND=JPRD), INTENT (IN)::PINTE (KLEVOUT, KLEVIN)
REAL (KIND=JPRB), INTENT (IN), TARGET::PIN (KPROMA, KLEVIN)
REAL (KIND=JPRB), INTENT (OUT), TARGET::POUT (KPROMA, KLEVOUT-1)
REAL (KIND=JPRD), INTENT (IN), OPTIONAL, TARGET::POUTS (KPROMA)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PINS (KPROMA)
LOGICAL, INTENT (IN) :: LDACC
INTEGER (KIND=JPIM)::JLEVIN
INTEGER (KIND=JPIM)::JLEVOUT
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLEN
LOGICAL, PARAMETER::LLDOUBLE=JPRB==JPRD
LOGICAL, PARAMETER::LLVERINT_ON_CPU=.TRUE.
REAL (KIND=JPRD), POINTER::ZIN (:,:)
REAL (KIND=JPRD), POINTER::ZOUT (:,:)
REAL (KIND=JPRD), TARGET::ZIN0 (KPROMA, MERGE (KLEVIN, 0,.NOT.LLDOUBLE))
REAL (KIND=JPRD), TARGET::ZOUT0 (KPROMA, MERGE (KLEVOUT-1, 0,.NOT.LLDOUBLE))
LOGICAL::LLOML_IN_PARALLEL
LOGICAL::LLFXTRAN_ACDC_GEMM
#include "abor1.intfb.h"
REAL (KIND=JPHOOK)::ZHOOK_HANDLE_XGEMM
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
TYPE (FXTRAN_ACDC_STACK) :: YLSTACK

!$ACC DATA &
!$ACC&CREATE (ZIN0, ZOUT0) &
!$ACC&IF (LDACC) &
!$ACC&PRESENT (PIN, PINS, POUT, POUTS) 

IF (LHOOK) CALL DR_HOOK ('VERINT_SINGLEBLOCK', 0, ZHOOK_HANDLE)

LLOML_IN_PARALLEL=.TRUE.


IF (LLDOUBLE) THEN
#ifndef PARKIND1_SINGLE
  ZOUT=>POUT
  ZIN=>PIN
#endif
ELSE
  ZIN=>ZIN0
  ZOUT=>ZOUT0
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRESENT (ZIN) &
  !$ACC&PRIVATE (JLEV, JROF) 

  

  DO JROF = KST, KEND

    DO JLEV=1, KLEVIN
      
      ZIN (JROF, JLEV)=REAL (PIN (JROF, JLEV), KIND=JPRD)
    
    ENDDO

  ENDDO

ENDIF

LLFXTRAN_ACDC_GEMM=.FALSE.
#ifdef FXTRAN_ACDC
CALL FXTRAN_ACDC_GEMM_SINGLEBLOCK (KST, KEND,'N','T', KPROMA, KLEVOUT-1, KLEVIN, 1.0_JPRD,&
& ZIN, KPROMA, PINTE, KLEVOUT, 0.0_JPRD, ZOUT, KPROMA, LLFXTRAN_ACDC_GEMM, LDACC=LDACC)
#endif

IF (.NOT.LLFXTRAN_ACDC_GEMM) THEN
  CALL ABOR1 ('NOT SUPPORTED')
ENDIF


IF (KTYPE==1) THEN

  IF (PRESENT (PINS)) THEN
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRESENT (ZOUT) &
    !$ACC&PRIVATE (JLEV, JROF) 

    

    DO JROF = KST, KEND

      DO JLEV=1, KLEVOUT-1

        

        IF (.NOT.LLDOUBLE) THEN
          POUT (JROF, JLEV)=REAL (ZOUT (JROF, JLEV)-POUTS (JROF), JPRB)+PINS (JROF)
        ELSE
          POUT (JROF, JLEV)=ZOUT (JROF, JLEV)-POUTS (JROF)+PINS (JROF)
        ENDIF

      
      ENDDO

    ENDDO

  ELSE
    
    !$ACC PARALLEL LOOP GANG VECTOR &
    !$ACC&IF (LDACC) &
    !$ACC&PRESENT (ZOUT) &
    !$ACC&PRIVATE (JLEV, JROF) 

    

    DO JROF = KST, KEND

      DO JLEV=1, KLEVOUT-1
        
        POUT (JROF, JLEV)=ZOUT (JROF, JLEV)-POUTS (JROF)
      
      ENDDO

    ENDDO

  ENDIF

ELSEIF (KTYPE/=0) THEN
  WRITE (NULERR,*)' INVALID KTYPE IN VERINT =', KTYPE
  CALL ABOR1 (' VERINT: ABOR1 CALLED')
ELSEIF (PRESENT (PINS)) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRESENT (ZOUT) &
  !$ACC&PRIVATE (JLEV, JROF) 

  

  DO JROF = KST, KEND

    DO JLEV=1, KLEVOUT-1
      
      POUT (JROF, JLEV)=ZOUT (JROF, JLEV)+PINS (JROF)
    
    ENDDO

  ENDDO

ELSEIF (.NOT.LLDOUBLE) THEN
  
  !$ACC PARALLEL LOOP GANG VECTOR &
  !$ACC&IF (LDACC) &
  !$ACC&PRESENT (ZOUT) &
  !$ACC&PRIVATE (JLEV, JROF) 

  

  DO JROF = KST, KEND

    DO JLEV=1, KLEVOUT-1
      
      POUT (JROF, JLEV)=REAL (ZOUT (JROF, JLEV), KIND=JPRB)
    
    ENDDO

  ENDDO

ENDIF

IF (LHOOK) CALL DR_HOOK ('VERINT_SINGLEBLOCK', 1, ZHOOK_HANDLE)
!$ACC END DATA

END SUBROUTINE VERINT_SINGLEBLOCK
