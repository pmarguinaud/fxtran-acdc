SUBROUTINE GPMPFC_EXPL_PART2_PARALLEL (YDVARS, YDCPG_OPTS, YDCPG_BNDS, YD_PGM)

USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK
USE MODEL_GENERAL_CONF_MOD,ONLY:MODEL_GENERAL_CONF_TYPE
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
CLASS (FIELD_2RB), POINTER :: YD_PGM
REAL (KIND=JPRB), POINTER::PGM (:,:)
INTEGER (KIND=JPIM)::JFLD
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL(KIND=JPRB), POINTER :: Z_YDVARS_GFL_PTR_DL(:,:,:)
REAL(KIND=JPRB), POINTER :: Z_YDVARS_GFL_PTR_DM(:,:,:)
#include "abor1.intfb.h"
IF (LHOOK) CALL DR_HOOK ("GPMPFC_EXPL_PART2_PARALLEL", 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)

DO JFLD=1, SIZE (YDVARS%GFL_PTR)

  IF (YDVARS%GFL_PTR (JFLD)%YCOMP%LCDERS) THEN
    IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0',0,ZHOOK_HANDLE_PARALLEL)

    IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','GPMPFC_EXPL_PART2_PARALLEL:0')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      PGM => GET_HOST_DATA_RDONLY (YD_PGM)
      Z_YDVARS_GFL_PTR_DL => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDL)
      Z_YDVARS_GFL_PTR_DM => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDM)
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
      !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JROF) FIRSTPRIVATE (YLCPG_BNDS)

      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
        CALL YLCPG_BNDS%UPDATE (JBLK)

        

        DO JLEV=1, YDCPG_OPTS%KFLEVG

          DO JROF=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
            Z_YDVARS_GFL_PTR_DM  (JROF, JLEV, JBLK)=Z_YDVARS_GFL_PTR_DM  (JROF, JLEV, JBLK)*PGM (JROF, JBLK)
            Z_YDVARS_GFL_PTR_DL  (JROF, JLEV, JBLK)=Z_YDVARS_GFL_PTR_DL  (JROF, JLEV, JBLK)*PGM (JROF, JBLK)
          ENDDO

        ENDDO

      ENDDO

      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('GPMPFC_EXPL_PART2_PARALLEL:0')) THEN
        IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        PGM => GET_HOST_DATA_RDWR (YD_PGM)
        Z_YDVARS_GFL_PTR_DL => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDL)
        Z_YDVARS_GFL_PTR_DM => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDM)
        IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      PGM => NULL ()
      Z_YDVARS_GFL_PTR_DL => NULL ()
      Z_YDVARS_GFL_PTR_DM => NULL ()
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','GPMPFC_EXPL_PART2_PARALLEL:0')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      PGM => GET_HOST_DATA_RDONLY (YD_PGM)
      Z_YDVARS_GFL_PTR_DL => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDL)
      Z_YDVARS_GFL_PTR_DM => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDM)
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JROF, YLCPG_BNDS)

      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

        

        

        DO JROF = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
          YLCPG_BNDS%KIDIA = JROF
          YLCPG_BNDS%KFDIA = JROF

          

          DO JLEV=1, YDCPG_OPTS%KFLEVG
            
            Z_YDVARS_GFL_PTR_DM  (JROF, JLEV, JBLK)=Z_YDVARS_GFL_PTR_DM  (JROF, JLEV, JBLK)*PGM (JROF, JBLK)
            Z_YDVARS_GFL_PTR_DL  (JROF, JLEV, JBLK)=Z_YDVARS_GFL_PTR_DL  (JROF, JLEV, JBLK)*PGM (JROF, JBLK)
          
          ENDDO

        ENDDO

      ENDDO

      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('GPMPFC_EXPL_PART2_PARALLEL:0')) THEN
        IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        PGM => GET_HOST_DATA_RDWR (YD_PGM)
        Z_YDVARS_GFL_PTR_DL => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDL)
        Z_YDVARS_GFL_PTR_DM => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDM)
        IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      PGM => NULL ()
      Z_YDVARS_GFL_PTR_DL => NULL ()
      Z_YDVARS_GFL_PTR_DM => NULL ()
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','GPMPFC_EXPL_PART2_PARALLEL:0')) THEN
      
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
      PGM => GET_DEVICE_DATA_RDONLY (YD_PGM)
      Z_YDVARS_GFL_PTR_DL => GET_DEVICE_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDL)
      Z_YDVARS_GFL_PTR_DM => GET_DEVICE_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDM)
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
      
      
        !$ACC PARALLEL LOOP GANG &
        !$ACC&PRESENT (PGM, YDCPG_OPTS, YFXTRAN_ACDC_STACK, Z_YDVARS_GFL_PTR_DL, Z_YDVARS_GFL_PTR_DM) &
        !$ACC&PRIVATE (JBLK) &
        !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
        
        DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
        
        
        
        !$ACC LOOP VECTOR &
        !$ACC&PRIVATE (JLEV, JROF, YLCPG_BNDS) 

        

        DO JROF = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
          YLCPG_BNDS%KIDIA = JROF
          YLCPG_BNDS%KFDIA = JROF

          

          DO JLEV=1, YDCPG_OPTS%KFLEVG
            
            Z_YDVARS_GFL_PTR_DM  (JROF, JLEV, JBLK)=Z_YDVARS_GFL_PTR_DM  (JROF, JLEV, JBLK)*PGM (JROF, JBLK)
            Z_YDVARS_GFL_PTR_DL  (JROF, JLEV, JBLK)=Z_YDVARS_GFL_PTR_DL  (JROF, JLEV, JBLK)*PGM (JROF, JBLK)
          
          ENDDO

        ENDDO

      ENDDO

      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

      IF (FXTRAN_ACDC_LSYNCHOST ('GPMPFC_EXPL_PART2_PARALLEL:0')) THEN
        IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
        PGM => GET_HOST_DATA_RDWR (YD_PGM)
        Z_YDVARS_GFL_PTR_DL => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDL)
        Z_YDVARS_GFL_PTR_DM => GET_HOST_DATA_RDWR (YDVARS%GFL_PTR (JFLD)%FDM)
        IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
        
        
      ENDIF

      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
      PGM => NULL ()
      Z_YDVARS_GFL_PTR_DL => NULL ()
      Z_YDVARS_GFL_PTR_DM => NULL ()
      IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ELSE
        CALL ABOR1 ('GPMPFC_EXPL_PART2_PARALLEL: NOT METHOD WAS FOUND')
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('GPMPFC_EXPL_PART2_PARALLEL:0',1,ZHOOK_HANDLE_PARALLEL)
  ENDIF

ENDDO


CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ("GPMPFC_EXPL_PART2_PARALLEL", 1, ZHOOK_HANDLE)
END SUBROUTINE GPMPFC_EXPL_PART2_PARALLEL
