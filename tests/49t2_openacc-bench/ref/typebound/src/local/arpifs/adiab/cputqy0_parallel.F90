SUBROUTINE CPUTQY0_PARALLEL (LDT1, YDCPG_BNDS, YDCPG_OPTS, YDCPG_DIMS_VAR, PDT, YD_PVAR, YD_PTND)
USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK

USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_DIM_VAR_TYPE, CPG_OPTS_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


LOGICAL, INTENT (IN)::LDT1
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_DIM_VAR_TYPE), INTENT (IN)::YDCPG_DIMS_VAR
REAL (KIND=JPRB), INTENT (IN)::PDT
CLASS (FIELD_3RB), POINTER :: YD_PVAR
REAL (KIND=JPRB), POINTER::PVAR (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTND
REAL (KIND=JPRB), POINTER::PTND (:,:,:)
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
#include "abor1.intfb.h"
IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)

IF (LDT1) THEN
  IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR',0,ZHOOK_HANDLE_PARALLEL)

  IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CPUTQY0_PARALLEL:PVAR')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PTND => GET_HOST_DATA_RDONLY (YD_PTND)
    PVAR => GET_HOST_DATA_RDWR (YD_PVAR)
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
    !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JLON) FIRSTPRIVATE (YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      CALL YLCPG_BNDS%UPDATE (JBLK)

      

      DO JLEV=1, YDCPG_OPTS%KFLEVG

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          PVAR (JLON, JLEV, JBLK)=PVAR (JLON, JLEV, JBLK)+PDT*PTND (JLON, JLEV, JBLK)
        ENDDO

      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPUTQY0_PARALLEL:PVAR')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PTND => GET_HOST_DATA_RDWR (YD_PTND)
      PVAR => GET_HOST_DATA_RDWR (YD_PVAR)
      IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PTND => NULL ()
    PVAR => NULL ()
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','CPUTQY0_PARALLEL:PVAR')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PTND => GET_HOST_DATA_RDONLY (YD_PTND)
    PVAR => GET_HOST_DATA_RDWR (YD_PVAR)
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    !$OMP PARALLEL DO PRIVATE (JBLK, JLEV, JLON, YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

      

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON

        

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PVAR (JLON, JLEV, JBLK)=PVAR (JLON, JLEV, JBLK)+PDT*PTND (JLON, JLEV, JBLK)
        
        ENDDO

      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPUTQY0_PARALLEL:PVAR')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PTND => GET_HOST_DATA_RDWR (YD_PTND)
      PVAR => GET_HOST_DATA_RDWR (YD_PVAR)
      IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PTND => NULL ()
    PVAR => NULL ()
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CPUTQY0_PARALLEL:PVAR')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    PTND => GET_DEVICE_DATA_RDONLY (YD_PTND)
    PVAR => GET_DEVICE_DATA_RDWR (YD_PVAR)
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    
      !$ACC PARALLEL LOOP GANG &
      !$ACC&PRESENT (PTND, PVAR, YDCPG_OPTS, YFXTRAN_ACDC_STACK) &
      !$ACC&PRIVATE (JBLK) &
      !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
      
      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      
      
      
      !$ACC LOOP VECTOR &
      !$ACC&PRIVATE (JLEV, JLON, YLCPG_BNDS) 

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON

        

        DO JLEV=1, YDCPG_OPTS%KFLEVG
          
          PVAR (JLON, JLEV, JBLK)=PVAR (JLON, JLEV, JBLK)+PDT*PTND (JLON, JLEV, JBLK)
        
        ENDDO

      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('CPUTQY0_PARALLEL:PVAR')) THEN
      IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      PTND => GET_HOST_DATA_RDWR (YD_PTND)
      PVAR => GET_HOST_DATA_RDWR (YD_PVAR)
      IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    PTND => NULL ()
    PVAR => NULL ()
    IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSE
      CALL ABOR1 ('CPUTQY0_PARALLEL: NOT METHOD WAS FOUND')
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL:PVAR',1,ZHOOK_HANDLE_PARALLEL)
ENDIF


CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CPUTQY0_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE CPUTQY0_PARALLEL
