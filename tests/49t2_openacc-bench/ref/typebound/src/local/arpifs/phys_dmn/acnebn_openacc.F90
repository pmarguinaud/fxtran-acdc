
SUBROUTINE ACNEBN_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA, KLEV, PAPHIF&
&, PCP, PQ, PQL, PQI, PQSAT, PT, PFPLC, PDELP, PRDELP, PAPRSF, PUNEBH, PNEBS, PQLIS, PQLI_CVP&
&, PNEB_CVPP, PQLI_CVPP, PAIPCMT, PNEB, PNEBC, PQICE, PQLI, YDSTA, YDSTACK)
!$ACC ROUTINE (ACNEBN_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB, JPRD

USE YOMCST,ONLY:TCST
USE YOMSTA,ONLY:TSTA
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSAT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLC (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PRDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUNEBH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEBS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLIS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI_CVP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB_CVPP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI_CVPP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAIPCMT (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PNEB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PNEBC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQICE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQLI (KLON, KLEV)
TYPE (TSTA), INTENT (IN)::YDSTA
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZPHIREL1 
REAL (KIND=JPRB)::ZSUM 
fxtran_acdc_temp (REAL (KIND=JPRB), ZFACQSC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZSUSXC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZSNEBC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZINQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTGRAD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSAT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSSTPP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZSDELP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZS, (KLON, KLEV))
INTEGER (KIND=JPIM)::ILEVTES 
INTEGER (KIND=JPIM)::ILEVREF 
INTEGER (KIND=JPIM)::ILEVSIG
INTEGER (KIND=JPIM)::ILEVX
INTEGER (KIND=JPIM)::ILEV
INTEGER (KIND=JPIM)::JLEV2
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZQLIS
REAL (KIND=JPRB)::ZNEB_NON_PCMT
REAL (KIND=JPRB)::ZNEBC_NON_PCMT
REAL (KIND=JPRB)::ZBIN
REAL (KIND=JPRB)::ZEXPR
REAL (KIND=JPRB)::ZRHLIMPR
REAL (KIND=JPRB)::ZRHLIM
REAL (KIND=JPRB)::ZRHEXP
REAL (KIND=JPRB)::ZRH
REAL (KIND=JPRB)::ZARGLI
REAL (KIND=JPRB)::ZEPS2
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZQTOT
REAL (KIND=JPRB)::ZTAUX
REAL (KIND=JPRB)::ZBETA
REAL (KIND=JPRB)::ZALPH
REAL (KIND=JPRB)::ZARG2
REAL (KIND=JPRB)::ZARG1
REAL (KIND=JPRB)::ZQICR
REAL (KIND=JPRB)::ZQCR
REAL (KIND=JPRB)::ZICE
REAL (KIND=JPRB)::ZPHIREL2
REAL (KIND=JPRB)::ZPHIRSQ
REAL (KIND=JPRB)::ZESP
REAL (KIND=JPRB)::ZEW
REAL (KIND=JPRB)::ZTFROID
REAL (KIND=JPRB)::ZSSUSS
REAL (KIND=JPRB)::ZEPSQC
REAL (KIND=JPRB)::ZFRAC
REAL (KIND=JPRB)::ZMASK2
REAL (KIND=JPRB)::ZMASK1
REAL (KIND=JPRB)::ZD3
REAL (KIND=JPRB)::ZDSN
REAL (KIND=JPRB)::ZEPSDS
REAL (KIND=JPRB)::ZDELTAP
REAL (KIND=JPRB)::ZPLS
REAL (KIND=JPRB)::ZNEBS
REAL (KIND=JPRB)::ZEPSNEB
REAL (KIND=JPRB)::ZDELTA
LOGICAL::LLSTRAT
LOGICAL::LLSC

#include "acnebxrs_openacc.intfb.h"
#include "fcttrm.func.h"
#include "fctdoi.func.h"

YLSTACK = YDSTACK



IF (KIND (ZFACQSC) == 8) THEN
    fxtran_acdc_alloc8 (ZFACQSC)
ELSEIF (KIND (ZFACQSC) == 4) THEN
    fxtran_acdc_alloc4 (ZFACQSC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZSUSXC) == 8) THEN
    fxtran_acdc_alloc8 (ZSUSXC)
ELSEIF (KIND (ZSUSXC) == 4) THEN
    fxtran_acdc_alloc4 (ZSUSXC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZSNEBC) == 8) THEN
    fxtran_acdc_alloc8 (ZSNEBC)
ELSEIF (KIND (ZSNEBC) == 4) THEN
    fxtran_acdc_alloc4 (ZSNEBC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZINQ) == 8) THEN
    fxtran_acdc_alloc8 (ZINQ)
ELSEIF (KIND (ZINQ) == 4) THEN
    fxtran_acdc_alloc4 (ZINQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTGRAD) == 8) THEN
    fxtran_acdc_alloc8 (ZTGRAD)
ELSEIF (KIND (ZTGRAD) == 4) THEN
    fxtran_acdc_alloc4 (ZTGRAD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSAT) == 8) THEN
    fxtran_acdc_alloc8 (ZQSAT)
ELSEIF (KIND (ZQSAT) == 4) THEN
    fxtran_acdc_alloc4 (ZQSAT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSS) == 8) THEN
    fxtran_acdc_alloc8 (ZQSS)
ELSEIF (KIND (ZQSS) == 4) THEN
    fxtran_acdc_alloc4 (ZQSS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSC) == 8) THEN
    fxtran_acdc_alloc8 (ZQSC)
ELSEIF (KIND (ZQSC) == 4) THEN
    fxtran_acdc_alloc4 (ZQSC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQS) == 8) THEN
    fxtran_acdc_alloc8 (ZQS)
ELSEIF (KIND (ZQS) == 4) THEN
    fxtran_acdc_alloc4 (ZQS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSSTPP) == 8) THEN
    fxtran_acdc_alloc8 (ZQSSTPP)
ELSEIF (KIND (ZQSSTPP) == 4) THEN
    fxtran_acdc_alloc4 (ZQSSTPP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZSDELP) == 8) THEN
    fxtran_acdc_alloc8 (ZSDELP)
ELSEIF (KIND (ZSDELP) == 4) THEN
    fxtran_acdc_alloc4 (ZSDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZS) == 8) THEN
    fxtran_acdc_alloc8 (ZS)
ELSEIF (KIND (ZS) == 4) THEN
    fxtran_acdc_alloc4 (ZS)
ELSE
    STOP 1
ENDIF


JLON = KIDIA





IF (JPRB==JPRD) THEN
  ZEPSNEB=1.E-10_JPRB
ELSE
  ZEPSNEB=1.E-06_JPRB
ENDIF

ZEPSQC=1.E-10_JPRB
ZEPSDS=1._JPRB
ZTAUX=3600._JPRB
LLSC=YDML_PHY_MF%YRPHY0%QSSC/=0.0_JPRB
LLSTRAT=YDML_PHY_MF%YRPHY0%RPHI0/=0.0_JPRB
ZQSAT (JLON,:)=PQSAT (JLON,:)
ZPHIRSQ=SQRT (MAX (ZEPSNEB, YDML_PHY_MF%YRPHY0%RPHIR))
ZEPS1=1.E-6_JPRB
ZEPS2=1.E-10_JPRB
ZARGLI=125._JPRB**(1.0_JPRB/YDML_PHY_MF%YRPHY0%QXRTGH)

IF (YDML_PHY_MF%YRPHY0%QSNEBC>=0.0_JPRB) THEN

  DO JLEV=KTDIA, KLEV
    
    ZSNEBC (JLON, JLEV)=YDML_PHY_MF%YRPHY0%QSNEBC
    ZSUSXC (JLON, JLEV)=YDML_PHY_MF%YRPHY0%QSUSXC
    ZFACQSC (JLON, JLEV)=YDML_PHY_MF%YRPHY2%TSPHY/YDML_PHY_MF%YRPHY0%QSUSXC
  
  ENDDO

ELSE
  ZARG1=2.0_JPRB*YDML_PHY_MF%YRPHY0%RQICVMAX*(1.0_JPRB-0.999_JPRB)/(YDML_PHY_MF&
  &%YRPHY0%RQICVMAX-YDML_PHY_MF%YRPHY0%RQICVMIN)-1.0_JPRB
  ZARG2=2.0_JPRB*(YDML_PHY_MF%YRPHY0%RQICVMAX-1.5_JPRB*YDML_PHY_MF%YRPHY0%RQICVMIN&
  &)/(YDML_PHY_MF%YRPHY0%RQICVMAX-YDML_PHY_MF%YRPHY0%RQICVMIN)-1.0_JPRB
  ZARG1=0.5_JPRB*LOG (ABS ((1.0_JPRB+ZARG1)/(1.0_JPRB-ZARG1)))
  ZARG2=0.5_JPRB*LOG (ABS ((1.0_JPRB+ZARG2)/(1.0_JPRB-ZARG2)))
  ZALPH=(ZARG1-ZARG2)/(YDML_PHY_MF%YRPHY0%RQICRT2-YDML_PHY_MF%YRPHY0%RQICRT1)
  ZBETA=ZARG1-YDML_PHY_MF%YRPHY0%RQICRT2*ZALPH

  DO JLEV=KTDIA, KLEV
    
    ZICE=FONICE (PT (JLON, JLEV), YDML_PHY_MF%YRPHY0%RDTFAC)
    ZQICR=YDML_PHY_MF%YRPHY0%RQICVMAX-(YDML_PHY_MF%YRPHY0%RQICVMAX-YDML_PHY_MF%YRPHY0&
    &%RQICVMIN)*0.5_JPRB*(1.0_JPRB+TANH (ZALPH*(PT (JLON, JLEV)-YDCST%RTT)+ZBETA))
    ZQCR=YDML_PHY_MF%YRPHY0%RQLCV*(1.0_JPRB-ZICE)+ZQICR*ZICE
    ZSNEBC (JLON, JLEV)=1.0_JPRB/ZQCR
    ZSUSXC (JLON, JLEV)=YDML_PHY_MF%YRPHY0%SXNBCO*ZQCR
    ZFACQSC (JLON, JLEV)=ZTAUX/PQSAT (JLON, JLEV)
  
  ENDDO

ENDIF


IF (.NOT.(YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY&
  &%LPROCLD).AND.(.NOT.YDML_PHY_MF%YRPHY%LNEB_FP)) THEN

  DO JLEV=KTDIA, KLEV
    
    ZS (JLON, JLEV)=PCP (JLON, JLEV)*PT (JLON, JLEV)+PAPHIF (JLON, JLEV)
    ZQSSTPP (JLON, JLEV)=0.0_JPRB
    ZSDELP (JLON, JLEV)=0.0_JPRB
  
  ENDDO


  IF (LLSTRAT) THEN

    DO JLEV=KTDIA+1, KLEV
      
      ZTGRAD (JLON, JLEV)=MAX (ZEPSNEB,(PT (JLON, JLEV)-PT (JLON, JLEV-1))*YDML_PHY_MF&
      &%YRPHY0%RPHI0/(PAPHIF (JLON, JLEV)-PAPHIF (JLON, JLEV-1)))
      ZINQ (JLON, JLEV)=1.0_JPRB/ZTGRAD (JLON, JLEV)
    
    ENDDO


    DO JLEV=KLEV, KTDIA+2,-1
      ZSUM =0.0_JPRB
      ZPHIREL1 =0.0_JPRB

      DO ILEV=JLEV, KTDIA+1,-1
        
        ZPHIREL2=MIN (SQRT (PAPHIF (JLON, ILEV-1)-PAPHIF (JLON, JLEV)), ZPHIRSQ)
        ZSUM =ZSUM +ZINQ (JLON, ILEV)*(ZPHIREL2-ZPHIREL1 )
        ZPHIREL1 =ZPHIREL2
      
      ENDDO

      
      ZTGRAD (JLON, JLEV)=ZPHIRSQ/ZSUM 
    
    ENDDO


    DO JLEV=KTDIA+1, KLEV
      
      ZTFROID=PT (JLON, JLEV)-ZTGRAD (JLON, JLEV)

      IF (YDML_PHY_MF%YRPHY%LNEIGE) THEN
        ZDELTA=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-ZTFROID))
      ELSE
        ZDELTA=0.0_JPRB
      ENDIF

      ZEW=FOEW (ZTFROID, ZDELTA)
      ZESP=ZEW/PAPRSF (JLON, JLEV)
      ZQSAT (JLON, JLEV)=FOQS (ZESP)
    
    ENDDO

  ENDIF

  
  ILEVTES =KLEV
  
  ILEVX=KLEV

  DO JLEV=KLEV, KTDIA,-1

    IF (LLSC) THEN
      ILEV=ILEVX
    ELSE
      ILEV=JLEV
    ENDIF

    ILEVX=JLEV

    

    IF (LLSC) THEN
      ILEVREF =ILEVTES 
    ELSE
      ILEVREF =JLEV
    ENDIF

    ILEVTES =JLEV

    

    DO JLEV2=JLEV, ILEV
      
      ZDSN=(ZS (JLON, JLEV)-ZS (JLON, JLEV2))/MAX (ZEPSDS, YDML_PHY_MF%YRPHY0%QSSC)
      ZD3=1.0_JPRB+ZDSN*ZDSN*(2.0_JPRB*ZDSN-3._JPRB)
      ZMASK1=MAX (0.0_JPRB, SIGN (1.0_JPRB, 0.0_JPRB-ZDSN))
      ZMASK2=MAX (0.0_JPRB, SIGN (1.0_JPRB, 1.0_JPRB-ZDSN))
      ZFRAC=ZMASK1+(1.0_JPRB-ZMASK1)*ZMASK2*ZD3
      ZFRAC=ZFRAC*REAL (MAX (0, MIN (1, ILEVREF -JLEV2+1)), JPRB)
      ZDELTAP=ZFRAC*PDELP (JLON, JLEV2)
      ILEVSIG=JLEV2*NINT (MAX (0.0_JPRB,-SIGN (1.0_JPRB, 0.0_JPRB-ZFRAC)))
      ILEVX=MAX (ILEVX, ILEVSIG)
      ILEVTES =MAX (ILEVTES , ILEVSIG)

      IF (YDML_PHY_MF%YRPHY%L3MT.OR.YDML_PHY_MF%YRPHY%LSTRAPRO) THEN
        ZQTOT=PQ (JLON, JLEV2)+PQL (JLON, JLEV2)+PQI (JLON, JLEV2)
      ELSE
        ZQTOT=PQ (JLON, JLEV2)
      ENDIF

      ZQSSTPP (JLON, JLEV)=ZQSSTPP (JLON, JLEV)+MAX (0.0_JPRB, ZQTOT-(YDML_PHY_MF%YRPHY0%RHUC (JLEV)+YDML_PHY_MF&
      &%YRPHY0%HUCREDRA)/(1.0_JPRB+YDML_PHY_MF%YRPHY0%HUCREDRA)*ZQSAT (JLON, JLEV))*ZDELTAP
      ZSDELP (JLON, JLEV)=ZSDELP (JLON, JLEV)+ZDELTAP
    
    ENDDO

    
    ZSSUSS=YDML_PHY_MF%YRPHY0%QSSUSS/SQRT (1.0_JPRB+(YDML_PHY_MF&
    &%YRPHY0%RQSMOD (JLEV)*PQSAT (JLON, JLEV))**2)
    ZQSS (JLON, JLEV)=ZSSUSS*ZQSSTPP (JLON, JLEV)/ZSDELP (JLON, JLEV)
    ZQSS (JLON, JLEV)=YDML_PHY_MF%YRPHY0%QSUSXS*(1.0_JPRB-EXP&
    & (-ZQSS (JLON, JLEV)/YDML_PHY_MF%YRPHY0%QSUSXS))
  
  ENDDO

ELSE

  DO JLEV=KTDIA, KLEV
    
    ZQSS (JLON, JLEV)=PQLIS (JLON, JLEV)+PQLI_CVPP (JLON, JLEV)
  
  ENDDO

ENDIF


IF (YDML_PHY_MF%YRPHY%L3MT.AND.YDML_PHY_MF%YRPHY0%QXRAL<=0._JPRB) THEN

  DO JLEV=KTDIA, KLEV
    
    PNEBC (JLON, JLEV)=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, PUNEBH (JLON, JLEV)))
    ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
    PNEB (JLON, JLEV)=ZNEBS+(1.0_JPRB-ZNEBS)*PNEBC (JLON, JLEV)
    PNEB (JLON, JLEV)=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, PNEB (JLON, JLEV)))
    ZPLS=FONICE (PT (JLON, JLEV), YDML_PHY_MF%YRPHY0%RDTFAC)
    PQLI (JLON, JLEV)=ZQSS (JLON, JLEV)*(1.0_JPRB-ZPLS)
    PQICE (JLON, JLEV)=ZQSS (JLON, JLEV)*ZPLS
  
  ENDDO

ELSE

  DO JLEV=KTDIA, KLEV

    

    IF (YDML_PHY_MF%YRPHY%L3MT) THEN

      IF (YDML_PHY_MF%YRPHY%LQXRTGH) THEN
        ZRH=MIN (ZARGLI, MAX (ZEPS1, PQ (JLON, JLEV)/PQSAT (JLON, JLEV)))
        ZRHEXP=EXP (-2.0_JPRB*ZRH**YDML_PHY_MF%YRPHY0%QXRTGH)
        ZRH=((1.0_JPRB-ZRHEXP)/(1.0_JPRB+ZRHEXP))**(1.0_JPRB/YDML_PHY_MF%YRPHY0%QXRTGH)
        ZBIN=0.0_JPRB
      ELSE
        ZRH=MIN (YDML_PHY_MF%YRPHY0%QXRHX, PQ (JLON, JLEV)/PQSAT (JLON, JLEV))
        ZBIN=MAX (0.0_JPRB, SIGN (1.0_JPRB, ZRH-1.0_JPRB))
      ENDIF

      ZRHLIM=MAX (ZEPS1, MIN (1.0_JPRB-ZEPS1, ZRH))
      ZRHLIMPR=SQRT (SQRT (ZRHLIM))
      ZEXPR=SQRT ((1.0_JPRB-ZRHLIM)*PQSAT (JLON, JLEV))*(1.0_JPRB/YDML_PHY_MF%YRPHY0%QXRAL)
      ZQSC (JLON, JLEV)=-ZEXPR*LOG (MAX (ZEPS2, 1.0_JPRB-PUNEBH (JLON, JLEV)/ZRHLIMPR))
      ZQS (JLON, JLEV)=ZQSS (JLON, JLEV)+ZQSC (JLON, JLEV)
      PNEB (JLON, JLEV)=ZRHLIMPR*(1.0_JPRB-EXP (-(ZQS (JLON, JLEV)/ZEXPR)))
      PNEB (JLON, JLEV)=MAX (ZEPS1, MIN (1.0_JPRB-ZEPS1, ZBIN+(1.0_JPRB-ZBIN)*PNEB (JLON, JLEV)))
      PNEBC (JLON, JLEV)=ZQSC (JLON, JLEV)/MAX (ZEPSQC, ZQS (JLON, JLEV))*PNEB (JLON, JLEV)
    ELSE

      IF (YDML_PHY_MF%YRPHY%LNCVPGY) THEN
        ZQSC (JLON, JLEV)=PQLI_CVP (JLON, JLEV)
      ELSE
        ZQSC (JLON, JLEV)=MAX (0.0_JPRB, PFPLC (JLON, JLEV)-PFPLC (JLON, JLEV&
        &-1))*PRDELP (JLON, JLEV)*YDCST%RG*YDML_PHY_MF%YRPHY0%QSSUSC
        ZQSC (JLON, JLEV)=ZSUSXC (JLON, JLEV)*(1.0_JPRB-EXP (-ZQSC (JLON, JLEV)*ZFACQSC (JLON, JLEV)))
      ENDIF


      IF (YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY%LPROCLD.AND.YDML_PHY_MF%YRPHY%LRNUMX) THEN
        ZQS (JLON, JLEV)=MAX (ZQSS (JLON, JLEV), ZQSC (JLON, JLEV))
      ELSE
        ZQS (JLON, JLEV)=ZQSS (JLON, JLEV)+ZQSC (JLON, JLEV)
      ENDIF

    ENDIF


    IF (YDML_PHY_MF%YRPHY%LNEIGE) THEN
      ZPLS=FONICE (PT (JLON, JLEV), YDML_PHY_MF%YRPHY0%RDTFAC)
      PQLI (JLON, JLEV)=ZQS (JLON, JLEV)*(1.0_JPRB-ZPLS)
      PQICE (JLON, JLEV)=ZQS (JLON, JLEV)*ZPLS
    ELSE
      PQLI (JLON, JLEV)=ZQS (JLON, JLEV)
      PQICE (JLON, JLEV)=0.0_JPRB
    ENDIF

  
  ENDDO


  IF (YDML_PHY_MF%YRPHY%LNEBNXR.AND.(.NOT.YDML_PHY_MF%YRPHY%LGPCMT)) THEN

    IF (.NOT.YDML_PHY_MF%YRPHY%L3MT) THEN
      CALL ACNEBXRS_OPENACC (YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY0, KIDIA,&
      & KFDIA, KLON, KTDIA, KLEV, PQ, ZQS, PQSAT, PNEB, YDSTACK=YLSTACK)

      DO JLEV=KTDIA, KLEV
        
        PNEBC (JLON, JLEV)=ZQSC (JLON, JLEV)/MAX (ZEPSQC, ZQS (JLON, JLEV))*PNEB (JLON, JLEV)
      
      ENDDO

    ENDIF

  ELSEIF (YDML_PHY_MF%YRPHY%LGPCMT.AND.YDML_PHY_MF%YRPHY%LRNUMX) THEN

    DO JLEV=KTDIA, KLEV
      
      PNEB (JLON, JLEV)=MAX (PNEBS (JLON, JLEV), PNEBC (JLON, JLEV))
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      ZNEBC_NON_PCMT=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, ZSNEBC (JLON, JLEV)*ZQSC (JLON, JLEV)))
      ZNEB_NON_PCMT=MAX (ZNEBS, ZNEBC_NON_PCMT)
      PNEB (JLON, JLEV)=PAIPCMT (JLON)*PNEB (JLON, JLEV)+(1._JPRB-PAIPCMT (JLON))*ZNEB_NON_PCMT
      PNEBC (JLON, JLEV)=PAIPCMT (JLON)*PNEBC (JLON, JLEV)+(1._JPRB-PAIPCMT (JLON))*ZNEBC_NON_PCMT
    
    ENDDO

  ELSEIF (YDML_PHY_MF%YRPHY%LGPCMT.AND.(.NOT.YDML_PHY_MF%YRPHY%LRNUMX)) THEN

    DO JLEV=KTDIA, KLEV
      
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      PNEB (JLON, JLEV)=ZNEBS+(1.0_JPRB-ZNEBS)*PNEBC (JLON, JLEV)
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      ZNEBC_NON_PCMT=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, ZSNEBC (JLON, JLEV)*ZQSC (JLON, JLEV)))
      ZNEB_NON_PCMT=ZNEBS+(1.0_JPRB-ZNEBS)*PNEBC (JLON, JLEV)
      PNEB (JLON, JLEV)=PAIPCMT (JLON)*PNEB (JLON, JLEV)+(1._JPRB-PAIPCMT (JLON))*ZNEB_NON_PCMT
      PNEBC (JLON, JLEV)=PAIPCMT (JLON)*PNEBC (JLON, JLEV)+(1._JPRB-PAIPCMT (JLON))*ZNEBC_NON_PCMT
    
    ENDDO

  ELSEIF (YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY%LPROCLD.AND.(&
    &.NOT.YDML_PHY_MF%YRPHY%LNCVPGY).AND.YDML_PHY_MF%YRPHY%LRNUMX) THEN

    DO JLEV=KTDIA, KLEV
      
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      PNEBC (JLON, JLEV)=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, ZSNEBC (JLON, JLEV)*ZQSC (JLON, JLEV)))
      PNEB (JLON, JLEV)=MAX (ZNEBS, PNEBC (JLON, JLEV))
    
    ENDDO

  ELSEIF (YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY%LPROCLD.AND.(.NOT&
    &.YDML_PHY_MF%YRPHY%LNCVPGY).AND.(.NOT.YDML_PHY_MF%YRPHY%LRNUMX)) THEN

    DO JLEV=KTDIA, KLEV
      
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      PNEBC (JLON, JLEV)=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, ZSNEBC (JLON, JLEV)*ZQSC (JLON, JLEV)))
      PNEB (JLON, JLEV)=ZNEBS+(1.0_JPRB-ZNEBS)*PNEBC (JLON, JLEV)
    
    ENDDO

  ELSEIF (YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY%LPROCLD.AND&
    &.YDML_PHY_MF%YRPHY%LNCVPGY.AND.YDML_PHY_MF%YRPHY%LRNUMX) THEN

    DO JLEV=KTDIA, KLEV
      
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      PNEB (JLON, JLEV)=MAX (ZNEBS, PNEBC (JLON, JLEV))
    
    ENDDO

  ELSEIF (YDML_PHY_MF%YRPHY%LCONDWT.AND.YDML_PHY_MF%YRPHY%LPROCLD.AND.YDML_PHY_MF&
    &%YRPHY%LNCVPGY.AND.(.NOT.YDML_PHY_MF%YRPHY%LRNUMX)) THEN

    DO JLEV=KTDIA, KLEV
      
      ZNEBS=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
      PNEB (JLON, JLEV)=ZNEBS+(1.0_JPRB-ZNEBS)*PNEBC (JLON, JLEV)
    
    ENDDO

  ELSE

    DO JLEV=KTDIA, KLEV
      
      ZNEBS=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, YDML_PHY_MF%YRPHY0&
      &%QSNEBS*SQRT (ZQSS (JLON, JLEV)/PQSAT (JLON, JLEV))))
      PNEBC (JLON, JLEV)=MAX (ZEPSNEB, MIN (1.0_JPRB-ZEPSNEB, ZSNEBC (JLON, JLEV)*ZQSC (JLON, JLEV)))
      PNEB (JLON, JLEV)=ZNEBS+(1.0_JPRB-ZNEBS)*PNEBC (JLON, JLEV)
    
    ENDDO

  ENDIF

ENDIF



END SUBROUTINE ACNEBN_OPENACC
