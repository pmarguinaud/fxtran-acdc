
SUBROUTINE LAITRI_WENO_OPENACC (YDDYN, KSLB1, KPROMA, KST, KEND, KFLEV&
&, KFLDN, KFLDX, KQM, CDTYPE, PDLAT, PCLA, PDLO, PCLO, KL0, KNOWENO, PCW&
&, PVINTW, PXSL, PXF, PALPHA, PRDETAR, LDQM3DCONS, LDADD, YDSTACK)
!$ACC ROUTINE (LAITRI_WENO_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPIB

USE YOMDYN,ONLY:TDYN
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TDYN), INTENT (IN)::YDDYN
INTEGER (KIND=JPIM), INTENT (IN)::KSLB1
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KFLDN
INTEGER (KIND=JPIM), INTENT (IN)::KFLDX
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KQM
CHARACTER (LEN=*), INTENT (IN)::CDTYPE
REAL (KIND=JPRB), INTENT (IN)::PDLAT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PCLA (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (IN)::PDLO (KPROMA, KFLEV, 0:3)
REAL (KIND=JPRB), INTENT (IN)::PCLO (KPROMA, KFLEV, 3, 2)
INTEGER (KIND=JPIM), INTENT (IN)::KL0 (KPROMA, KFLEV, 0:3)
INTEGER (KIND=JPIM), INTENT (IN)::KNOWENO (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PCW (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (IN)::PVINTW (KPROMA, KFLEV, 9)
REAL (KIND=JPRB), INTENT (IN)::PXSL (KSLB1*(KFLDX-KFLDN+1))
REAL (KIND=JPRB), INTENT (INOUT)::PXF (KPROMA, KFLEV)
REAL (KIND=JPRB), OPTIONAL, INTENT (IN)::PALPHA
REAL (KIND=JPRB), OPTIONAL, INTENT (IN)::PRDETAR (KFLEV)
LOGICAL, OPTIONAL, INTENT (IN)::LDADD
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
LOGICAL, OPTIONAL, INTENT (IN)::LDQM3DCONS
INTEGER (KIND=JPIB)::IV4L2
INTEGER (KIND=JPIB)::IV4L1
INTEGER (KIND=JPIB)::IV3L3
INTEGER (KIND=JPIB)::IV3L2
INTEGER (KIND=JPIB)::IV3L1
INTEGER (KIND=JPIB)::IV3L0
INTEGER (KIND=JPIB)::IV2L3
INTEGER (KIND=JPIB)::IV2L2
INTEGER (KIND=JPIB)::IV2L1
INTEGER (KIND=JPIB)::IV2L0
INTEGER (KIND=JPIB)::IV1L3
INTEGER (KIND=JPIB)::IV1L2
INTEGER (KIND=JPIB)::IV1L1
INTEGER (KIND=JPIB)::IV1L0
INTEGER (KIND=JPIB)::IV0L3
INTEGER (KIND=JPIB)::IV0L2
INTEGER (KIND=JPIB)::IV0L1
INTEGER (KIND=JPIB)::IV0L0
INTEGER (KIND=JPIB)::IV9L2
INTEGER (KIND=JPIB)::IV9L1
INTEGER (KIND=JPIM)::ISHIFT2
INTEGER (KIND=JPIM)::ISHIFT1
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::INX
INTEGER (KIND=JPIM)::IQM
INTEGER (KIND=JPIM)::J0
INTEGER (KIND=JPIM)::JJ
LOGICAL::LLADD
LOGICAL::LQM0
LOGICAL::LQMV
LOGICAL::LQMH
REAL (KIND=JPRB)::ZZF122
REAL (KIND=JPRB)::ZZF121
REAL (KIND=JPRB)::ZZF112
REAL (KIND=JPRB)::ZZF111
REAL (KIND=JPRB)::ZZF222
REAL (KIND=JPRB)::ZZF221
REAL (KIND=JPRB)::ZZF212
REAL (KIND=JPRB)::ZZF211
REAL (KIND=JPRB)::ZZF123
REAL (KIND=JPRB)::ZZF120
REAL (KIND=JPRB)::ZZF113
REAL (KIND=JPRB)::ZZF110
REAL (KIND=JPRB)::ZZF223
REAL (KIND=JPRB)::ZZF220
REAL (KIND=JPRB)::ZZF213
REAL (KIND=JPRB)::ZZF210
REAL (KIND=JPRB)::ZZ31
REAL (KIND=JPRB)::ZZ21
REAL (KIND=JPRB)::ZZ11
REAL (KIND=JPRB)::ZZ01
REAL (KIND=JPRB)::ZZ30
REAL (KIND=JPRB)::ZZ20
REAL (KIND=JPRB)::ZZ10
REAL (KIND=JPRB)::ZZ00
REAL (KIND=JPRB)::ZZ29
REAL (KIND=JPRB)::ZZ19
REAL (KIND=JPRB)::ZZ24
REAL (KIND=JPRB)::ZZ14
REAL (KIND=JPRB)::ZZ33
REAL (KIND=JPRB)::ZZ23
REAL (KIND=JPRB)::ZZ13
REAL (KIND=JPRB)::ZZ03
REAL (KIND=JPRB)::ZZ32
REAL (KIND=JPRB)::ZZ22
REAL (KIND=JPRB)::ZZ12
REAL (KIND=JPRB)::ZZ02
REAL (KIND=JPRB)::ZMAX
REAL (KIND=JPRB)::ZMIN
REAL (KIND=JPRB)::Z24
REAL (KIND=JPRB)::Z14
REAL (KIND=JPRB)::Z29
REAL (KIND=JPRB)::Z19
REAL (KIND=JPRB)::Z (0:5)
fxtran_acdc_temp (REAL (KIND=JPRB), ZXF, (KPROMA, KFLEV))
REAL (KIND=JPRB)::Z31
REAL (KIND=JPRB)::Z22
REAL (KIND=JPRB)::Z21
REAL (KIND=JPRB)::Z20
REAL (KIND=JPRB)::Z12
REAL (KIND=JPRB)::Z11
REAL (KIND=JPRB)::Z10
REAL (KIND=JPRB)::Z01
REAL (KIND=JPRB)::ZX
REAL (KIND=JPRB)::ZF (8)
REAL (KIND=JPRB)::ZSURPL 
REAL (KIND=JPRB)::ZALPHA
REAL (KIND=JPRB)::ZRVETA
REAL (KIND=JPRB)::ZZ
REAL (KIND=JPRB)::ZEPS_MAX
REAL (KIND=JPRB)::ZSW
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZWW (1:3)
REAL (KIND=JPRB)::ZBETA (1:3)
REAL (KIND=JPRB)::ZFX (1:3)
#include "interp.func.h"
#include "lainterpol.func.h"



YLSTACK = YDSTACK



IF (KIND (ZXF) == 8) THEN
    fxtran_acdc_alloc8 (ZXF)
ELSEIF (KIND (ZXF) == 4) THEN
    fxtran_acdc_alloc4 (ZXF)
ELSE
    STOP 1
ENDIF


JROF = KST



LLADD=.FALSE.

IF (PRESENT (LDADD))  THEN
  LLADD=LDADD
ENDIF


IF (KQM==-1) THEN
  LQMH=.FALSE.
  LQMV=.FALSE.
  LQM0=.FALSE.
ELSE
  IQM=ABS (KQM)
  LQMH=IQM==1.OR.IQM==2
  LQMV=IQM==2.OR.IQM==3
  LQM0=IQM>=4
ENDIF

ZEPS=1.E-6_JPRB
ZEPS_MAX=100._JPRB*EPSILON (ZEPS)

IF (KQM==-1) THEN

  IF (.NOT.PRESENT (PRDETAR))  THEN
    CALL FXTRAN_ACDC_ABORT (' LAITRI_WENO : MISSING ARGUMENT PRDETAR')
  ENDIF


  IF (.NOT.PRESENT (LDQM3DCONS))  THEN
    CALL FXTRAN_ACDC_ABORT (' LAITRI_WENO : MISSING ARGUMENT LDQM3DCONS')
  ENDIF

  ZSURPL =0.0_JPRB
ENDIF

IV9L1=1-KSLB1
IV9L2=2-KSLB1
IV0L0=0
IV0L1=1
IV0L2=2
IV0L3=3
IV1L0=KSLB1
IV1L1=1+KSLB1
IV1L2=2+KSLB1
IV1L3=3+KSLB1
IV2L0=IV1L0+KSLB1
IV2L1=IV1L1+KSLB1
IV2L2=IV1L2+KSLB1
IV2L3=IV1L3+KSLB1
IV3L0=IV2L0+KSLB1
IV3L1=IV2L1+KSLB1
IV3L2=IV2L2+KSLB1
IV3L3=IV2L3+KSLB1
IV4L1=IV3L1+KSLB1
IV4L2=IV3L2+KSLB1
INX=KSLB1*(KFLDX-KFLDN+1)

IF (CDTYPE=='SCALAR') THEN

  DO JLEV=1, KFLEV

    IF (PRESENT (PALPHA)) THEN
      ZALPHA=PALPHA
    ELSE
      ZALPHA=YDDYN%RALPHA
    ENDIF


    IF (JLEV<=YDDYN%NLEV_ZALPHA) THEN
      ZALPHA=MAX (ZALPHA, YDDYN%RALPHA_TOP)
    ENDIF

    
    Z01=PXSL (IV0L0+KL0 (JROF, JLEV, 0)+1)
    Z01=FDWEIGHT (PDLO (JROF, JLEV, 0), Z01, PXSL (IV0L0+KL0 (JROF, JLEV, 0)+2))
    Z10=PXSL (IV0L0+KL0 (JROF, JLEV, 1))
    Z11=PXSL (IV0L0+KL0 (JROF, JLEV, 1)+1)
    Z12=PXSL (IV0L0+KL0 (JROF, JLEV, 1)+2)
    Z10=FCWEIGHT (PCLO (JROF, JLEV, 1, 1), PCLO (JROF, JLEV, 2, 1), PCLO (JROF&
    &, JLEV, 3, 1), Z10, Z11, Z12, PXSL (IV0L0+KL0 (JROF, JLEV, 1)+3))
    Z20=PXSL (IV0L0+KL0 (JROF, JLEV, 2))
    Z21=PXSL (IV0L0+KL0 (JROF, JLEV, 2)+1)
    Z22=PXSL (IV0L0+KL0 (JROF, JLEV, 2)+2)
    Z20=FCWEIGHT (PCLO (JROF, JLEV, 1, 2), PCLO (JROF, JLEV, 2, 2), PCLO (JROF&
    &, JLEV, 3, 2), Z20, Z21, Z22, PXSL (IV0L0+KL0 (JROF, JLEV, 2)+3))
    Z31=PXSL (IV0L0+KL0 (JROF, JLEV, 3)+1)
    Z31=FDWEIGHT (PDLO (JROF, JLEV, 3), Z31, PXSL (IV0L0+KL0 (JROF, JLEV, 3)+2))
    Z (1)=FCWEIGHT (PCLA (JROF, JLEV, 1), PCLA (JROF, JLEV&
    &, 2), PCLA (JROF, JLEV, 3), Z01, Z10, Z20, Z31)
    Z01=PXSL (IV3L0+KL0 (JROF, JLEV, 0)+1)
    Z01=FDWEIGHT (PDLO (JROF, JLEV, 0), Z01, PXSL (IV3L0+KL0 (JROF, JLEV, 0)+2))
    Z10=PXSL (IV3L0+KL0 (JROF, JLEV, 1))
    Z11=PXSL (IV3L0+KL0 (JROF, JLEV, 1)+1)
    Z12=PXSL (IV3L0+KL0 (JROF, JLEV, 1)+2)
    Z10=FCWEIGHT (PCLO (JROF, JLEV, 1, 1), PCLO (JROF, JLEV, 2, 1), PCLO (JROF&
    &, JLEV, 3, 1), Z10, Z11, Z12, PXSL (IV3L0+KL0 (JROF, JLEV, 1)+3))
    Z20=PXSL (IV3L0+KL0 (JROF, JLEV, 2))
    Z21=PXSL (IV3L0+KL0 (JROF, JLEV, 2)+1)
    Z22=PXSL (IV3L0+KL0 (JROF, JLEV, 2)+2)
    Z20=FCWEIGHT (PCLO (JROF, JLEV, 1, 2), PCLO (JROF, JLEV, 2, 2), PCLO (JROF&
    &, JLEV, 3, 2), Z20, Z21, Z22, PXSL (IV3L0+KL0 (JROF, JLEV, 2)+3))
    Z31=PXSL (IV3L0+KL0 (JROF, JLEV, 3)+1)
    Z31=FDWEIGHT (PDLO (JROF, JLEV, 3), Z31, PXSL (IV3L0+KL0 (JROF, JLEV, 3)+2))
    Z (4)=FCWEIGHT (PCLA (JROF, JLEV, 1), PCLA (JROF, JLEV&
    &, 2), PCLA (JROF, JLEV, 3), Z01, Z10, Z20, Z31)
    
    
    Z01=PXSL (IV1L0+KL0 (JROF, JLEV, 0)+1)
    Z01=FDWEIGHT (PDLO (JROF, JLEV, 0), Z01, PXSL (IV1L0+KL0 (JROF, JLEV, 0)+2))
    Z10=PXSL (IV1L0+KL0 (JROF, JLEV, 1))
    Z11=PXSL (IV1L0+KL0 (JROF, JLEV, 1)+1)
    Z12=PXSL (IV1L0+KL0 (JROF, JLEV, 1)+2)
    Z10=FCWEIGHT (PCLO (JROF, JLEV, 1, 1), PCLO (JROF, JLEV, 2, 1), PCLO (JROF&
    &, JLEV, 3, 1), Z10, Z11, Z12, PXSL (IV1L0+KL0 (JROF, JLEV, 1)+3))
    Z20=PXSL (IV1L0+KL0 (JROF, JLEV, 2))
    Z21=PXSL (IV1L0+KL0 (JROF, JLEV, 2)+1)
    Z22=PXSL (IV1L0+KL0 (JROF, JLEV, 2)+2)
    Z20=FCWEIGHT (PCLO (JROF, JLEV, 1, 2), PCLO (JROF, JLEV, 2, 2), PCLO (JROF&
    &, JLEV, 3, 2), Z20, Z21, Z22, PXSL (IV1L0+KL0 (JROF, JLEV, 2)+3))

    IF (LQMH) THEN
      Z10=FCLIPHIGH (Z10, Z11, Z12)
      Z10=FCLIPLOW (Z10, Z11, Z12)
      Z20=FCLIPHIGH (Z20, Z21, Z22)
      Z20=FCLIPLOW (Z20, Z21, Z22)
    ENDIF

    Z31=PXSL (IV1L0+KL0 (JROF, JLEV, 3)+1)
    Z31=FDWEIGHT (PDLO (JROF, JLEV, 3), Z31, PXSL (IV1L0+KL0 (JROF, JLEV, 3)+2))
    Z (2)=FCWEIGHT (PCLA (JROF, JLEV, 1), PCLA (JROF, JLEV&
    &, 2), PCLA (JROF, JLEV, 3), Z01, Z10, Z20, Z31)

    IF (LQMH) THEN
      ZZ=FCLIPHIGH (Z (2), Z10, Z20)
      Z (2)=FCLIPLOW (ZZ, Z10, Z20)
    ENDIF

    Z01=PXSL (IV2L0+KL0 (JROF, JLEV, 0)+1)
    Z01=FDWEIGHT (PDLO (JROF, JLEV, 0), Z01, PXSL (IV2L0+KL0 (JROF, JLEV, 0)+2))
    Z10=PXSL (IV2L0+KL0 (JROF, JLEV, 1))
    Z11=PXSL (IV2L0+KL0 (JROF, JLEV, 1)+1)
    Z12=PXSL (IV2L0+KL0 (JROF, JLEV, 1)+2)
    Z10=FCWEIGHT (PCLO (JROF, JLEV, 1, 1), PCLO (JROF, JLEV, 2, 1), PCLO (JROF&
    &, JLEV, 3, 1), Z10, Z11, Z12, PXSL (IV2L0+KL0 (JROF, JLEV, 1)+3))
    Z20=PXSL (IV2L0+KL0 (JROF, JLEV, 2))
    Z21=PXSL (IV2L0+KL0 (JROF, JLEV, 2)+1)
    Z22=PXSL (IV2L0+KL0 (JROF, JLEV, 2)+2)
    Z20=FCWEIGHT (PCLO (JROF, JLEV, 1, 2), PCLO (JROF, JLEV, 2, 2), PCLO (JROF&
    &, JLEV, 3, 2), Z20, Z21, Z22, PXSL (IV2L0+KL0 (JROF, JLEV, 2)+3))

    IF (LQMH) THEN
      Z10=FCLIPHIGH (Z10, Z11, Z12)
      Z10=FCLIPLOW (Z10, Z11, Z12)
      Z20=FCLIPHIGH (Z20, Z21, Z22)
      Z20=FCLIPLOW (Z20, Z21, Z22)
    ENDIF

    Z31=PXSL (IV2L0+KL0 (JROF, JLEV, 3)+1)
    Z31=FDWEIGHT (PDLO (JROF, JLEV, 3), Z31, PXSL (IV2L0+KL0 (JROF, JLEV, 3)+2))
    Z (3)=FCWEIGHT (PCLA (JROF, JLEV, 1), PCLA (JROF, JLEV&
    &, 2), PCLA (JROF, JLEV, 3), Z01, Z10, Z20, Z31)

    IF (LQMH) THEN
      ZZ=FCLIPHIGH (Z (3), Z10, Z20)
      Z (3)=FCLIPLOW (ZZ, Z10, Z20)
    ENDIF

    
    
    ISHIFT1=MAX (0, KNOWENO (JROF, JLEV))*KSLB1
    Z19=PXSL (KL0 (JROF, JLEV, 1)+IV9L1+ISHIFT1)
    Z19=FDWEIGHT (PDLO (JROF, JLEV, 1), Z19, PXSL (KL0 (JROF, JLEV, 1)+IV9L2+ISHIFT1))
    Z29=PXSL (KL0 (JROF, JLEV, 2)+IV9L1+ISHIFT1)
    Z29=FDWEIGHT (PDLO (JROF, JLEV, 2), Z29, PXSL (KL0 (JROF, JLEV, 2)+IV9L2+ISHIFT1))
    Z (0)=FDWEIGHT (PDLAT (JROF, JLEV), Z19, Z29)
    ISHIFT2=MIN (0, KNOWENO (JROF, JLEV))*KSLB1
    Z14=PXSL (KL0 (JROF, JLEV, 1)+IV4L1+ISHIFT2)
    Z14=FDWEIGHT (PDLO (JROF, JLEV, 1), Z14, PXSL (KL0 (JROF, JLEV, 1)+IV4L2+ISHIFT2))
    Z24=PXSL (KL0 (JROF, JLEV, 2)+IV4L1+ISHIFT2)
    Z24=FDWEIGHT (PDLO (JROF, JLEV, 2), Z24, PXSL (KL0 (JROF, JLEV, 2)+IV4L2+ISHIFT2))
    Z (5)=FDWEIGHT (PDLAT (JROF, JLEV), Z14, Z24)

    

    

    IF (YDDYN%LWENOBC.OR.(KNOWENO (JROF, JLEV)==0)) THEN

      DO JJ=1, 3

        SELECTCASE (JJ)
        CASE (1)
          J0=1
        CASE (2)
          J0=2+MIN (0, KNOWENO (JROF, JLEV))
        CASE (3)
          J0=MAX (0, KNOWENO (JROF, JLEV))
        ENDSELECT

        ZFX (JJ)=Z (J0)+PVINTW (JROF, JLEV, 1+3*(JJ-1))*(Z (J0+1)-Z (J0))+PVINTW (JROF, JLEV&
        &, 2+3*(JJ-1))*(Z (J0+2)-Z (J0))+PVINTW (JROF, JLEV, 3+3*(JJ-1))*(Z (J0+3)-Z (J0))
        ZBETA (JJ)=YDDYN%RBETAK(JJ, 1)*Z (J0+3)*Z (J0+3)+YDDYN%RBETAK(JJ, 2)*Z (J0+2)*Z (J0+2)+YDDYN%RBETAK&
        &(JJ, 3)*Z (J0+1)*Z (J0+1)+YDDYN%RBETAK(JJ, 4)*Z (J0)*Z (J0)+YDDYN%RBETAK(JJ, 5)*Z (J0+3)*Z (J0+2&
        &)+YDDYN%RBETAK(JJ, 6)*Z (J0+3)*Z (J0+1)+YDDYN%RBETAK(JJ, 7)*Z (J0+3)*Z (J0)+YDDYN%RBETAK(JJ, 8)*Z&
        & (J0+2)*Z (J0+1)+YDDYN%RBETAK(JJ, 9)*Z (J0+2)*Z (J0)+YDDYN%RBETAK(JJ, 10)*Z (J0+1)*Z (J0)
        ZWW (JJ)=(ZBETA (JJ)+ZEPS)**ZALPHA
        ZWW (JJ)=SIGN (MAX (ABS (ZWW (JJ)), ZEPS_MAX), ZWW (JJ))
        ZWW (JJ)=PCW (JROF, JLEV, JJ)/ZWW (JJ)
      ENDDO

      ZSW=ZWW (1)+ZWW (2)+ZWW (3)
      ZWW (1)=ZWW (1)/ZSW
      ZWW (2)=ZWW (2)/ZSW
      ZXF (JROF, JLEV)=ZWW (1)*(ZFX (1)-ZFX (3))+ZWW (2)*(ZFX (2)-ZFX (3))+ZFX (3)
    ELSE
      ZXF (JROF, JLEV)=FCWEIGHT (PVINTW (JROF, JLEV, 1), PVINTW (JROF, JLEV&
      &, 2), PVINTW (JROF, JLEV, 3), Z (1), Z (2), Z (3), Z (4))
    ENDIF


    

    IF (LQMV) THEN
      
      ZXF (JROF, JLEV)=FCLIPHIGH (ZXF (JROF, JLEV), Z (2), Z (3))
      ZXF (JROF, JLEV)=FCLIPLOW (ZXF (JROF, JLEV), Z (2), Z (3))
    
    ENDIF

  ENDDO

ELSEIF (CDTYPE=='VECTOR') THEN

  DO JLEV=1, KFLEV

    IF (PRESENT (PALPHA)) THEN
      ZALPHA=PALPHA
    ELSE
      ZALPHA=YDDYN%RALPHA
    ENDIF


    IF (JLEV<=YDDYN%NLEV_ZALPHA) THEN
      ZALPHA=MAX (ZALPHA, YDDYN%RALPHA_TOP)
    ENDIF

    
    ISHIFT1=MAX (0, KNOWENO (JROF, JLEV))*KSLB1
    ZZ19=PXSL (KL0 (JROF, JLEV, 1)+IV9L1+ISHIFT1)+PDLO (JROF, JLEV, 1)*(PXSL (KL0&
    & (JROF, JLEV, 1)+IV9L2+ISHIFT1)-PXSL (KL0 (JROF, JLEV, 1)+IV9L1+ISHIFT1))
    ZZ29=PXSL (KL0 (JROF, JLEV, 2)+IV9L1+ISHIFT1)+PDLO (JROF, JLEV, 2)*(PXSL (KL0&
    & (JROF, JLEV, 2)+IV9L2+ISHIFT1)-PXSL (KL0 (JROF, JLEV, 2)+IV9L1+ISHIFT1))
    ZZ00=PXSL (KL0 (JROF, JLEV, 0)+IV0L1)+PDLO (JROF, JLEV, 0)*(PXSL &
    &(KL0 (JROF, JLEV, 0)+IV0L2)-PXSL (KL0 (JROF, JLEV, 0)+IV0L1))
    ZZF110=PXSL (KL0 (JROF, JLEV, 1)+IV0L1)
    ZZF210=PXSL (KL0 (JROF, JLEV, 1)+IV0L2)
    ZZ10=PXSL (KL0 (JROF, JLEV, 1)+IV0L0)+PCLO (JROF, JLEV, 1, 1)*(ZZF110-PXSL (KL0 (JROF, JLEV&
    &, 1)+IV0L0))+PCLO (JROF, JLEV, 2, 1)*(ZZF210-PXSL (KL0 (JROF, JLEV, 1)+IV0L0))+PCLO (JROF&
    &, JLEV, 3, 1)*(PXSL (KL0 (JROF, JLEV, 1)+IV0L3)-PXSL (KL0 (JROF, JLEV, 1)+IV0L0))
    ZZF120=PXSL (KL0 (JROF, JLEV, 2)+IV0L1)
    ZZF220=PXSL (KL0 (JROF, JLEV, 2)+IV0L2)
    ZZ20=PXSL (KL0 (JROF, JLEV, 2)+IV0L0)+PCLO (JROF, JLEV, 1, 2)*(ZZF120-PXSL (KL0 (JROF, JLEV&
    &, 2)+IV0L0))+PCLO (JROF, JLEV, 2, 2)*(ZZF220-PXSL (KL0 (JROF, JLEV, 2)+IV0L0))+PCLO (JROF&
    &, JLEV, 3, 2)*(PXSL (KL0 (JROF, JLEV, 2)+IV0L3)-PXSL (KL0 (JROF, JLEV, 2)+IV0L0))
    ZZ30=PXSL (KL0 (JROF, JLEV, 3)+IV0L1)+PDLO (JROF, JLEV, 3)*(PXSL &
    &(KL0 (JROF, JLEV, 3)+IV0L2)-PXSL (KL0 (JROF, JLEV, 3)+IV0L1))
    ZZ01=PXSL (KL0 (JROF, JLEV, 0)+IV1L1)+PDLO (JROF, JLEV, 0)*(PXSL &
    &(KL0 (JROF, JLEV, 0)+IV1L2)-PXSL (KL0 (JROF, JLEV, 0)+IV1L1))
    ZZF111=PXSL (KL0 (JROF, JLEV, 1)+IV1L1)
    ZZF211=PXSL (KL0 (JROF, JLEV, 1)+IV1L2)
    ZZ11=PXSL (KL0 (JROF, JLEV, 1)+IV1L0)+PCLO (JROF, JLEV, 1, 1)*(ZZF111-PXSL (KL0 (JROF, JLEV&
    &, 1)+IV1L0))+PCLO (JROF, JLEV, 2, 1)*(ZZF211-PXSL (KL0 (JROF, JLEV, 1)+IV1L0))+PCLO (JROF&
    &, JLEV, 3, 1)*(PXSL (KL0 (JROF, JLEV, 1)+IV1L3)-PXSL (KL0 (JROF, JLEV, 1)+IV1L0))
    ZZF121=PXSL (KL0 (JROF, JLEV, 2)+IV1L1)
    ZZF221=PXSL (KL0 (JROF, JLEV, 2)+IV1L2)
    ZZ21=PXSL (KL0 (JROF, JLEV, 2)+IV1L0)+PCLO (JROF, JLEV, 1, 2)*(ZZF121-PXSL (KL0 (JROF, JLEV&
    &, 2)+IV1L0))+PCLO (JROF, JLEV, 2, 2)*(ZZF221-PXSL (KL0 (JROF, JLEV, 2)+IV1L0))+PCLO (JROF&
    &, JLEV, 3, 2)*(PXSL (KL0 (JROF, JLEV, 2)+IV1L3)-PXSL (KL0 (JROF, JLEV, 2)+IV1L0))
    ZZ31=PXSL (KL0 (JROF, JLEV, 3)+IV1L1)+PDLO (JROF, JLEV, 3)*(PXSL &
    &(KL0 (JROF, JLEV, 3)+IV1L2)-PXSL (KL0 (JROF, JLEV, 3)+IV1L1))
    ZZ02=PXSL (KL0 (JROF, JLEV, 0)+IV2L1)+PDLO (JROF, JLEV, 0)*(PXSL &
    &(KL0 (JROF, JLEV, 0)+IV2L2)-PXSL (KL0 (JROF, JLEV, 0)+IV2L1))
    ZZF112=PXSL (KL0 (JROF, JLEV, 1)+IV2L1)
    ZZF212=PXSL (KL0 (JROF, JLEV, 1)+IV2L2)
    ZZ12=PXSL (KL0 (JROF, JLEV, 1)+IV2L0)+PCLO (JROF, JLEV, 1, 1)*(ZZF112-PXSL (KL0 (JROF, JLEV&
    &, 1)+IV2L0))+PCLO (JROF, JLEV, 2, 1)*(ZZF212-PXSL (KL0 (JROF, JLEV, 1)+IV2L0))+PCLO (JROF&
    &, JLEV, 3, 1)*(PXSL (KL0 (JROF, JLEV, 1)+IV2L3)-PXSL (KL0 (JROF, JLEV, 1)+IV2L0))
    ZZF122=PXSL (KL0 (JROF, JLEV, 2)+IV2L1)
    ZZF222=PXSL (KL0 (JROF, JLEV, 2)+IV2L2)
    ZZ22=PXSL (KL0 (JROF, JLEV, 2)+IV2L0)+PCLO (JROF, JLEV, 1, 2)*(ZZF122-PXSL (KL0 (JROF, JLEV&
    &, 2)+IV2L0))+PCLO (JROF, JLEV, 2, 2)*(ZZF222-PXSL (KL0 (JROF, JLEV, 2)+IV2L0))+PCLO (JROF&
    &, JLEV, 3, 2)*(PXSL (KL0 (JROF, JLEV, 2)+IV2L3)-PXSL (KL0 (JROF, JLEV, 2)+IV2L0))
    ZZ32=PXSL (KL0 (JROF, JLEV, 3)+IV2L1)+PDLO (JROF, JLEV, 3)*(PXSL &
    &(KL0 (JROF, JLEV, 3)+IV2L2)-PXSL (KL0 (JROF, JLEV, 3)+IV2L1))
    ZZ03=PXSL (KL0 (JROF, JLEV, 0)+IV3L1)+PDLO (JROF, JLEV, 0)*(PXSL &
    &(KL0 (JROF, JLEV, 0)+IV3L2)-PXSL (KL0 (JROF, JLEV, 0)+IV3L1))
    ZZF113=PXSL (KL0 (JROF, JLEV, 1)+IV3L1)
    ZZF213=PXSL (KL0 (JROF, JLEV, 1)+IV3L2)
    ZZ13=PXSL (KL0 (JROF, JLEV, 1)+IV3L0)+PCLO (JROF, JLEV, 1, 1)*(ZZF113-PXSL (KL0 (JROF, JLEV&
    &, 1)+IV3L0))+PCLO (JROF, JLEV, 2, 1)*(ZZF213-PXSL (KL0 (JROF, JLEV, 1)+IV3L0))+PCLO (JROF&
    &, JLEV, 3, 1)*(PXSL (KL0 (JROF, JLEV, 1)+IV3L3)-PXSL (KL0 (JROF, JLEV, 1)+IV3L0))
    ZZF123=PXSL (KL0 (JROF, JLEV, 2)+IV3L1)
    ZZF223=PXSL (KL0 (JROF, JLEV, 2)+IV3L2)
    ZZ23=PXSL (KL0 (JROF, JLEV, 2)+IV3L0)+PCLO (JROF, JLEV, 1, 2)*(ZZF123-PXSL (KL0 (JROF, JLEV&
    &, 2)+IV3L0))+PCLO (JROF, JLEV, 2, 2)*(ZZF223-PXSL (KL0 (JROF, JLEV, 2)+IV3L0))+PCLO (JROF&
    &, JLEV, 3, 2)*(PXSL (KL0 (JROF, JLEV, 2)+IV3L3)-PXSL (KL0 (JROF, JLEV, 2)+IV3L0))
    ZZ33=PXSL (KL0 (JROF, JLEV, 3)+IV3L1)+PDLO (JROF, JLEV, 3)*(PXSL &
    &(KL0 (JROF, JLEV, 3)+IV3L2)-PXSL (KL0 (JROF, JLEV, 3)+IV3L1))
    ISHIFT2=MIN (0, KNOWENO (JROF, JLEV))*KSLB1
    ZZ14=PXSL (KL0 (JROF, JLEV, 1)+IV4L1+ISHIFT2)+PDLO (JROF, JLEV, 1)*(PXSL (KL0&
    & (JROF, JLEV, 1)+IV4L2+ISHIFT2)-PXSL (KL0 (JROF, JLEV, 1)+IV4L1+ISHIFT2))
    ZZ24=PXSL (KL0 (JROF, JLEV, 2)+IV4L1+ISHIFT2)+PDLO (JROF, JLEV, 2)*(PXSL (KL0&
    & (JROF, JLEV, 2)+IV4L2+ISHIFT2)-PXSL (KL0 (JROF, JLEV, 2)+IV4L1+ISHIFT2))

    IF (LQMH) THEN
      ZMIN=FMINJ (ZZF111, ZZF211)
      ZMAX=FMAXJ (ZZF111, ZZF211)
      ZZ11=FMAXJ (ZMIN, FMINJ (ZMAX, ZZ11))
      ZMIN=FMINJ (ZZF121, ZZF221)
      ZMAX=FMAXJ (ZZF121, ZZF221)
      ZZ21=FMAXJ (ZMIN, FMINJ (ZMAX, ZZ21))
      ZMIN=FMINJ (ZZF112, ZZF212)
      ZMAX=FMAXJ (ZZF112, ZZF212)
      ZZ12=FMAXJ (ZMIN, FMINJ (ZMAX, ZZ12))
      ZMIN=FMINJ (ZZF122, ZZF222)
      ZMAX=FMAXJ (ZZF122, ZZF222)
      ZZ22=FMAXJ (ZMIN, FMINJ (ZMAX, ZZ22))
    ENDIF

    Z (0)=ZZ19+PDLAT (JROF, JLEV)*(ZZ29-ZZ19)
    Z (1)=ZZ00+PCLA (JROF, JLEV, 1)*(ZZ10-ZZ00)+PCLA (JROF, JLEV&
    &, 2)*(ZZ20-ZZ00)+PCLA (JROF, JLEV, 3)*(ZZ30-ZZ00)
    Z (2)=ZZ01+PCLA (JROF, JLEV, 1)*(ZZ11-ZZ01)+PCLA (JROF, JLEV&
    &, 2)*(ZZ21-ZZ01)+PCLA (JROF, JLEV, 3)*(ZZ31-ZZ01)
    Z (3)=ZZ02+PCLA (JROF, JLEV, 1)*(ZZ12-ZZ02)+PCLA (JROF, JLEV&
    &, 2)*(ZZ22-ZZ02)+PCLA (JROF, JLEV, 3)*(ZZ32-ZZ02)
    Z (4)=ZZ03+PCLA (JROF, JLEV, 1)*(ZZ13-ZZ03)+PCLA (JROF, JLEV&
    &, 2)*(ZZ23-ZZ03)+PCLA (JROF, JLEV, 3)*(ZZ33-ZZ03)
    Z (5)=ZZ14+PDLAT (JROF, JLEV)*(ZZ24-ZZ14)

    IF (LQMH) THEN
      ZMIN=FMINJ (ZZ11, ZZ21)
      ZMAX=FMAXJ (ZZ11, ZZ21)
      Z (2)=FMAXJ (ZMIN, FMINJ (ZMAX, Z (2)))
      ZMIN=FMINJ (ZZ12, ZZ22)
      ZMAX=FMAXJ (ZZ12, ZZ22)
      Z (3)=FMAXJ (ZMIN, FMINJ (ZMAX, Z (3)))
    ENDIF

    
    
    ZFX (1)=Z (1)+PVINTW (JROF, JLEV, 1)*(Z (2)-Z (1))+PVINTW (JROF,&
    & JLEV, 2)*(Z (3)-Z (1))+PVINTW (JROF, JLEV, 3)*(Z (4)-Z (1))

    IF (YDDYN%LWENOBC.OR.(KNOWENO (JROF, JLEV)==0)) THEN
      ZBETA (1)=YDDYN%RBETAK(1, 1)*Z (4)*Z (4)+YDDYN%RBETAK(1, 2)*Z (3)*Z (3)+YDDYN%RBETAK&
      &(1, 3)*Z (2)*Z (2)+YDDYN%RBETAK(1, 4)*Z (1)*Z (1)+YDDYN%RBETAK(1, 5)*Z (4)*Z (3)+YDDYN&
      &%RBETAK(1, 6)*Z (4)*Z (2)+YDDYN%RBETAK(1, 7)*Z (4)*Z (1)+YDDYN%RBETAK(1, 8)*Z (3)&
      &*Z (2)+YDDYN%RBETAK(1, 9)*Z (3)*Z (1)+YDDYN%RBETAK(1, 10)*Z (2)*Z (1)
      ZWW (1)=(ZBETA (1)+ZEPS)**ZALPHA
      ZWW (1)=SIGN (MAX (ABS (ZWW (1)), ZEPS_MAX), ZWW (1))
      ZWW (1)=PCW (JROF, JLEV, 1)/ZWW (1)
      J0=2+MIN (0, KNOWENO (JROF, JLEV))
      ZFX (2)=Z (J0)+PVINTW (JROF, JLEV, 4)*(Z (J0+1)-Z (J0))+PVINTW (JROF, JLEV&
      &, 5)*(Z (J0+2)-Z (J0))+PVINTW (JROF, JLEV, 6)*(Z (J0+3)-Z (J0))
      ZBETA (2)=YDDYN%RBETAK(2, 1)*Z (J0+3)*Z (J0+3)+YDDYN%RBETAK(2, 2)*Z (J0+2)*Z (J0+2)+YDDYN%RBETAK&
      &(2, 3)*Z (J0+1)*Z (J0+1)+YDDYN%RBETAK(2, 4)*Z (J0)*Z (J0)+YDDYN%RBETAK(2, 5)*Z (J0+3)*Z (J0+2&
      &)+YDDYN%RBETAK(2, 6)*Z (J0+3)*Z (J0+1)+YDDYN%RBETAK(2, 7)*Z (J0+3)*Z (J0)+YDDYN%RBETAK(2, 8)*Z&
      & (J0+2)*Z (J0+1)+YDDYN%RBETAK(2, 9)*Z (J0+2)*Z (J0)+YDDYN%RBETAK(2, 10)*Z (J0+1)*Z (J0)
      ZWW (2)=(ZBETA (2)+ZEPS)**ZALPHA
      ZWW (2)=SIGN (MAX (ABS (ZWW (2)), ZEPS_MAX), ZWW (2))
      ZWW (2)=PCW (JROF, JLEV, 2)/ZWW (2)
      J0=MAX (0, KNOWENO (JROF, JLEV))
      ZFX (3)=Z (J0)+PVINTW (JROF, JLEV, 7)*(Z (J0+1)-Z (J0))+PVINTW (JROF, JLEV&
      &, 8)*(Z (J0+2)-Z (J0))+PVINTW (JROF, JLEV, 9)*(Z (J0+3)-Z (J0))
      ZBETA (3)=YDDYN%RBETAK(3, 1)*Z (J0+3)*Z (J0+3)+YDDYN%RBETAK(3, 2)*Z (J0+2)*Z (J0+2)+YDDYN%RBETAK&
      &(3, 3)*Z (J0+1)*Z (J0+1)+YDDYN%RBETAK(3, 4)*Z (J0)*Z (J0)+YDDYN%RBETAK(3, 5)*Z (J0+3)*Z (J0+2&
      &)+YDDYN%RBETAK(3, 6)*Z (J0+3)*Z (J0+1)+YDDYN%RBETAK(3, 7)*Z (J0+3)*Z (J0)+YDDYN%RBETAK(3, 8)*Z&
      & (J0+2)*Z (J0+1)+YDDYN%RBETAK(3, 9)*Z (J0+2)*Z (J0)+YDDYN%RBETAK(3, 10)*Z (J0+1)*Z (J0)
      ZWW (3)=(ZBETA (3)+ZEPS)**ZALPHA
      ZWW (3)=SIGN (MAX (ABS (ZWW (3)), ZEPS_MAX), ZWW (3))
      ZWW (3)=PCW (JROF, JLEV, 3)/ZWW (3)
      ZSW=ZWW (1)+ZWW (2)+ZWW (3)
      ZWW (1)=ZWW (1)/ZSW
      ZWW (2)=ZWW (2)/ZSW
      ZXF (JROF, JLEV)=ZWW (1)*(ZFX (1)-ZFX (3))+ZWW (2)*(ZFX (2)-ZFX (3))+ZFX (3)
    ELSE
      ZXF (JROF, JLEV)=ZFX (1)
    ENDIF


    

    IF (LQMV) THEN
      
      ZMIN=MIN (Z (2), Z (3))
      ZMAX=MAX (Z (2), Z (3))
      ZXF (JROF, JLEV)=MAX (ZMIN, MIN (ZMAX, ZXF (JROF, JLEV)))
    
    ENDIF

  ENDDO

ELSE
  CALL FXTRAN_ACDC_ABORT ('LAITRI_WENO: UNEXPECTED CDTYPE')
ENDIF


IF (KQM==-1) THEN

  DO JLEV=1, KFLEV

    IF (JLEV==1) THEN
      ZRVETA=1.0_JPRB
    ELSE
      ZRVETA=PRDETAR (JLEV)
    ENDIF

    
    ZF (1)=PXSL (KL0 (JROF, JLEV, 1)+IV1L1)
    ZF (2)=PXSL (KL0 (JROF, JLEV, 1)+IV1L2)
    ZF (3)=PXSL (KL0 (JROF, JLEV, 2)+IV1L1)
    ZF (4)=PXSL (KL0 (JROF, JLEV, 2)+IV1L2)
    ZF (5)=PXSL (KL0 (JROF, JLEV, 1)+IV2L1)
    ZF (6)=PXSL (KL0 (JROF, JLEV, 1)+IV2L2)
    ZF (7)=PXSL (KL0 (JROF, JLEV, 2)+IV2L1)
    ZF (8)=PXSL (KL0 (JROF, JLEV, 2)+IV2L2)
    ZMIN=MINVAL (ZF (1:8))
    ZMAX=MAXVAL (ZF (1:8))

    IF (LDQM3DCONS) THEN
      ZX=ZXF (JROF, JLEV)+ZSURPL 
      ZXF (JROF, JLEV)=MAX (ZMIN, MIN (ZMAX, ZX))
      ZSURPL =(ZX-ZXF (JROF, JLEV))*ZRVETA
    ELSE
      ZXF (JROF, JLEV)=MAX (ZMIN, MIN (ZMAX, ZXF (JROF, JLEV)))
    ENDIF


    

    IF (LLADD) THEN
      
      PXF (JROF, JLEV)=PXF (JROF, JLEV)+ZXF (JROF, JLEV)
    
    ELSE
      
      PXF (JROF, JLEV)=ZXF (JROF, JLEV)
    
    ENDIF

  ENDDO

ELSEIF (LLADD.AND.LQM0) THEN

  DO JLEV=1, KFLEV
    
    PXF (JROF, JLEV)=PXF (JROF, JLEV)+MAX (ZXF (JROF, JLEV), 0._JPRB)
  
  ENDDO

ELSEIF (LQM0) THEN

  DO JLEV=1, KFLEV
    
    PXF (JROF, JLEV)=MAX (ZXF (JROF, JLEV), 0._JPRB)
  
  ENDDO

ELSEIF (LLADD) THEN

  DO JLEV=1, KFLEV
    
    PXF (JROF, JLEV)=PXF (JROF, JLEV)+ZXF (JROF, JLEV)
  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    PXF (JROF, JLEV)=ZXF (JROF, JLEV)
  
  ENDDO

ENDIF



END SUBROUTINE LAITRI_WENO_OPENACC
