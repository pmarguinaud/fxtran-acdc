SUBROUTINE GPHPRE_EXPL_VERTFE0_OPENACC (YDCVER, TOPPRES, YDCST, KPROMA&
&, KFLEV, KST, KEND, YDVAB, PRESH, PRESF, LHSET, LDELP, LALPHA, LRTGR&
&, LRPP, PDELP, PLNPR, PRDELP, PALPH, PRTGR, PRPRE, PRPP, YDSTACK)
!$ACC ROUTINE (GPHPRE_EXPL_VERTFE0_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMVERT,ONLY:TVAB
USE YOMCVER,ONLY:TCVER
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCVER), INTENT (IN)::YDCVER
REAL (KIND=JPRB), INTENT (IN)::TOPPRES
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
TYPE (TVAB), INTENT (IN)::YDVAB
REAL (KIND=JPRB), INTENT (INOUT)::PRESH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRESF (KPROMA, KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LRPP
LOGICAL, INTENT (IN), OPTIONAL::LRTGR
LOGICAL, INTENT (IN), OPTIONAL::LALPHA
LOGICAL, INTENT (IN), OPTIONAL::LDELP
LOGICAL, INTENT (IN), OPTIONAL::LHSET
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPP (KPROMA, KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRTGR (KPROMA, KFLEV)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IFIRST
LOGICAL::LLXYB
LOGICAL::LTEST
LOGICAL::LLRPP
LOGICAL::LLRTGR
LOGICAL::LLALPHA
LOGICAL::LLDELP
REAL (KIND=JPRB)::ZPRE 
REAL (KIND=JPRB)::ZCOUNT 
REAL (KIND=JPRB)::ZSUM
fxtran_acdc_temp (REAL (KIND=JPRB), ZZALPH, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZRDELP, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZLNPR, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZDELP, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZRPP, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZRPRE, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZZRTGR, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRPP, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRPRE, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRTGR, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZALPH, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRDELP, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZLNPR, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDELP, (KPROMA, KFLEV))


YLSTACK = YDSTACK



IF (KIND (ZZALPH) == 8) THEN
    fxtran_acdc_alloc8 (ZZALPH)
ELSEIF (KIND (ZZALPH) == 4) THEN
    fxtran_acdc_alloc4 (ZZALPH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRDELP) == 8) THEN
    fxtran_acdc_alloc8 (ZZRDELP)
ELSEIF (KIND (ZZRDELP) == 4) THEN
    fxtran_acdc_alloc4 (ZZRDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZLNPR) == 8) THEN
    fxtran_acdc_alloc8 (ZZLNPR)
ELSEIF (KIND (ZZLNPR) == 4) THEN
    fxtran_acdc_alloc4 (ZZLNPR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZDELP) == 8) THEN
    fxtran_acdc_alloc8 (ZZDELP)
ELSEIF (KIND (ZZDELP) == 4) THEN
    fxtran_acdc_alloc4 (ZZDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRPP) == 8) THEN
    fxtran_acdc_alloc8 (ZZRPP)
ELSEIF (KIND (ZZRPP) == 4) THEN
    fxtran_acdc_alloc4 (ZZRPP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRPRE) == 8) THEN
    fxtran_acdc_alloc8 (ZZRPRE)
ELSEIF (KIND (ZZRPRE) == 4) THEN
    fxtran_acdc_alloc4 (ZZRPRE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRTGR) == 8) THEN
    fxtran_acdc_alloc8 (ZZRTGR)
ELSEIF (KIND (ZZRTGR) == 4) THEN
    fxtran_acdc_alloc4 (ZZRTGR)
ELSE
    STOP 1
ENDIF


JROF = KST


LLXYB=(PRESENT (PDELP).AND.PRESENT (PLNPR).AND.PRESENT (PRDELP).AND.PRESENT&
& (PALPH).AND.PRESENT (PRTGR).AND.PRESENT (PRPRE).AND.PRESENT (PRPP))

IF (LLXYB) THEN
  LLDELP=.TRUE.

  IF (PRESENT (LDELP))  THEN
    LLDELP=LDELP
  ENDIF

  LLALPHA=.TRUE.

  IF (PRESENT (LALPHA))  THEN
    LLALPHA=LALPHA
  ENDIF

  LLRTGR=.TRUE.

  IF (PRESENT (LRTGR))  THEN
    LLRTGR=LRTGR
  ENDIF

  LLRPP=.TRUE.

  IF (PRESENT (LRPP))  THEN
    LLRPP=LRPP
  ENDIF


  IF (PRESENT (PRESF))  THEN
    LLALPHA=LLALPHA.OR.YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2.OR..NOT.YDCVER%LAPRXPK
  ENDIF

  fxtran_acdc_assoc (ZDELP, PDELP)
  fxtran_acdc_assoc (ZLNPR, PLNPR)
  fxtran_acdc_assoc (ZRDELP, PRDELP)
  fxtran_acdc_assoc (ZALPH, PALPH)
  fxtran_acdc_assoc (ZRTGR, PRTGR)
  fxtran_acdc_assoc (ZRPRE, PRPRE)
  fxtran_acdc_assoc (ZRPP, PRPP)
ELSE
  LLDELP=.FALSE.
  LLRTGR=.FALSE.
  LLRPP=.FALSE.
  LLALPHA=PRESENT (PRESF).AND.(YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2.OR..NOT.YDCVER%LAPRXPK)

  IF (LLALPHA) THEN
    fxtran_acdc_assoc (ZDELP, ZZDELP)
    fxtran_acdc_assoc (ZLNPR, ZZLNPR)
    fxtran_acdc_assoc (ZRDELP, ZZRDELP)
    fxtran_acdc_assoc (ZALPH, ZZALPH)
    fxtran_acdc_assoc (ZRTGR, ZZRTGR)
    fxtran_acdc_assoc (ZRPRE, ZZRPRE)
    fxtran_acdc_assoc (ZRPP, ZZRPP)
  ENDIF

ENDIF


IF (LLXYB.OR.LLALPHA) THEN
  ZPRE =YDVAB%VAH (0)+YDVAB%VBH (0)*PRESH (JROF, KFLEV)
  ZCOUNT =0._JPRB

  

  IF (ZPRE <=TOPPRES) THEN
    ZCOUNT =ZCOUNT +1
  ENDIF

  
  ZSUM=ZCOUNT

  IF (ZSUM>0._JPRB) THEN
    IFIRST=2
  ELSE
    IFIRST=1
  ENDIF


  IF (YDCVER%NDLNPR==0) THEN

    IF (IFIRST==2) THEN
      ZLNPR (JROF, 1)=LOG (PRESH (JROF, 1)/TOPPRES)

      IF (LLDELP.OR.LLRTGR) THEN
        
        ZDELP (JROF, 1)=PRESH (JROF, 1)-PRESH (JROF, 0)
        ZRDELP (JROF, 1)=1._JPRB/ZDELP (JROF, 1)
      
      ENDIF


      IF (LLALPHA)  THEN
        ZALPH (JROF, 1)=YDCVER%RHYDR0
      ENDIF


      IF (LLRTGR) THEN
        
        ZRTGR (JROF, 1)=ZRDELP (JROF, 1)*YDVAB%VDELB (1)
      
      ENDIF


      IF (LLRPP) THEN
        
        ZRPRE (JROF, 1)=1._JPRB/PRESH (JROF, 1)
        ZRPP (JROF, 1)=1._JPRB/(PRESH (JROF, 1)*TOPPRES)
      
      ENDIF

    ENDIF

    ZPRE =1._JPRB/PRESH (JROF, IFIRST-1)

    DO JL=IFIRST, KFLEV
      ZLNPR (JROF, JL)=LOG (PRESH (JROF, JL)*ZPRE )

      IF (LLDELP.OR.LLALPHA.OR.LLRTGR) THEN
        
        ZDELP (JROF, JL)=PRESH (JROF, JL)-PRESH (JROF, JL-1)
        ZRDELP (JROF, JL)=1._JPRB/ZDELP (JROF, JL)
      
      ENDIF


      IF (LLALPHA) THEN
        
        ZALPH (JROF, JL)=1._JPRB-PRESH (JROF, JL-1)*ZRDELP (JROF, JL)*ZLNPR (JROF, JL)
      
      ENDIF


      IF (LLRTGR) THEN
        
        ZRTGR (JROF, JL)=ZRDELP (JROF, JL)*(YDVAB%VDELB (JL)+YDVAB&
        &%VC (JL)*ZLNPR (JROF, JL)*ZRDELP (JROF, JL))
      
      ENDIF


      IF (LLRPP) THEN
        
        ZRPRE (JROF, JL)=1._JPRB/PRESH (JROF, JL)
        ZRPP (JROF, JL)=ZRPRE (JROF, JL)*ZPRE 
        ZPRE =ZRPRE (JROF, JL)
      
      ELSE
        ZPRE =1._JPRB/PRESH (JROF, JL)
      ENDIF

    ENDDO

  ELSEIF (YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2) THEN
    LTEST=LLDELP.OR.LLALPHA.OR.LLRTGR

    DO JL=IFIRST, KFLEV

      IF (LTEST) THEN
        
        ZDELP (JROF, JL)=PRESH (JROF, JL)-PRESH (JROF, JL-1)
        ZRDELP (JROF, JL)=1._JPRB/ZDELP (JROF, JL)
        ZRPP (JROF, JL)=1._JPRB/(PRESH (JROF, JL)*PRESH (JROF, JL-1))
        ZLNPR (JROF, JL)=ZDELP (JROF, JL)*SQRT (ZRPP (JROF, JL))
      
      ELSE
        
        ZLNPR (JROF, JL)=(PRESH (JROF, JL)-PRESH (JROF, JL-1))/SQRT (PRESH (JROF, JL)*PRESH (JROF, JL-1))
      
      ENDIF


      IF (LLALPHA) THEN
        
        ZALPH (JROF, JL)=1._JPRB-PRESH (JROF, JL-1)*ZRDELP (JROF, JL)*ZLNPR (JROF, JL)
      
      ENDIF


      IF (LLRTGR) THEN
        
        ZRTGR (JROF, JL)=ZRDELP (JROF, JL)*(YDVAB%VDELB (JL)+YDVAB&
        &%VC (JL)*ZLNPR (JROF, JL)*ZRDELP (JROF, JL))
      
      ENDIF


      IF (LLRPP)  THEN
        ZRPRE (JROF, JL)=1._JPRB/PRESH (JROF, JL)
      ENDIF

    ENDDO


    IF (IFIRST==2) THEN
      
      ZDELP (JROF, 1)=PRESH (JROF, 1)
      ZRDELP (JROF, 1)=1._JPRB/ZDELP (JROF, 1)

      

      IF (YDCVER%NDLNPR==1) THEN
        ZLNPR (JROF, 1)=2._JPRB+YDCST%RCVD/YDCST%RD
      ELSE
        
        ZLNPR (JROF, 1)=1._JPRB+ZLNPR (JROF, 2)*(ZDELP (JROF, 1)/ZDELP&
        & (JROF, 2))*SQRT (PRESH (JROF, 2)/PRESH (JROF, 1))
      
      ENDIF


      IF (LLALPHA)  THEN
        ZALPH (JROF, 1)=1._JPRB
      ENDIF


      IF (LLRTGR) THEN
        
        ZRTGR (JROF, 1)=ZRDELP (JROF, 1)*YDVAB%VDELB (1)
      
      ENDIF


      IF (LLRPP) THEN
        
        ZRPRE (JROF, 1)=1._JPRB/PRESH (JROF, 1)
        ZRPP (JROF, 1)=(ZLNPR (JROF, 1)*ZRDELP (JROF, 1))**2
      
      ENDIF

    ENDIF

  ENDIF

ENDIF


IF (PRESENT (PRESF)) THEN

  IF (YDCVER%NDLNPR==0) THEN

    IF (YDCVER%LAPRXPK) THEN

      DO JL=1, KFLEV
        PRESF (JROF, JL)=(PRESH (JROF, JL-1)+PRESH (JROF, JL))*0.5_JPRB
      ENDDO

    ELSE

      DO JL=1, KFLEV
        
        PRESF (JROF, JL)=EXP (-ZALPH (JROF, JL))*PRESH (JROF, JL)
      
      ENDDO

    ENDIF

  ELSEIF (YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2) THEN

    DO JL=IFIRST, KFLEV
      
      PRESF (JROF, JL)=(1._JPRB-ZALPH (JROF, JL))*PRESH (JROF, JL)
    
    ENDDO


    IF (IFIRST==2) THEN
      
      PRESF (JROF, 1)=PRESH (JROF, 1)/ZLNPR (JROF, 1)
    
    ENDIF

  ENDIF

ENDIF


END SUBROUTINE
