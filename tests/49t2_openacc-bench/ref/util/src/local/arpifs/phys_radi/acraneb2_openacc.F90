
SUBROUTINE ACRANEB2_OPENACC (YDCST, YDERDI, YDRIP, YDML_PHY_MF, LDCONFX, KIDIA, KFDIA, KLON, KTDIA, KLEV&
&, KJN, KSTEP, KNFRRC, PAPRS, PAPRSF, PCP, PR, PDELP, PNEB, PQ, PQCO2, PQICE, PQLI, PQO3, PT, PALB, PALBDIR&
&, PEMIS, PGELAM, PGEMU, PMU0, PMU0LU, PTS, PDECRD, PCLCT, PGDEOSI, PGUEOSI, PGMU0, PGMU0_MIN, PGMU0_MAX&
&, PGDEOTI, PGDEOTI2, PGUEOTI, PGUEOTI2, PGEOLT, PGEOXT, PGRPROX, PGMIXP, PGFLUXC, PGRSURF, PSDUR, PFRSO&
&, PFRTH, PFRSOC, PFRTHC, PFRSODIFS, PFRSODIRS, PFRSOLU, PFRTHDS, PDAER, YDSTACK)
!$ACC ROUTINE (ACRANEB2_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMRIP,ONLY:TRIP
USE YOERDI,ONLY:TERDI
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TERDI), INTENT (IN)::YDERDI
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
TYPE (TRIP), INTENT (IN)::YDRIP
LOGICAL, INTENT (IN)::LDCONFX
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KJN
INTEGER (KIND=JPIM), INTENT (IN)::KSTEP
INTEGER (KIND=JPIM), INTENT (IN)::KNFRRC
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQCO2 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQICE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQO3 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PALB (KLON)
REAL (KIND=JPRB), INTENT (IN)::PALBDIR (KLON)
REAL (KIND=JPRB), INTENT (IN)::PEMIS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGELAM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGEMU (KLON)
REAL (KIND=JPRB), INTENT (IN)::PMU0 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PMU0LU (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDECRD (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCLCT (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PGDEOSI (KLON, 0:KLEV, 2)
REAL (KIND=JPRB), INTENT (INOUT)::PGUEOSI (KLON, 0:KLEV, 2)
REAL (KIND=JPRB), INTENT (INOUT)::PGMU0 (KLON, 0:YDML_PHY_MF%YRPHY%NSORAYFR-1)
REAL (KIND=JPRB), INTENT (INOUT)::PGMU0_MIN (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PGMU0_MAX (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PGDEOTI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGDEOTI2 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGUEOTI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGUEOTI2 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGEOLT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGEOXT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGRPROX (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGMIXP (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGFLUXC (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PGRSURF (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PSDUR (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRSO (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFRTH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOC (KLON, 0:1)
REAL (KIND=JPRB), INTENT (OUT)::PFRTHC (KLON, 0:1)
REAL (KIND=JPRB), INTENT (OUT)::PFRSODIFS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRSODIRS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOLU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRTHDS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDAER (KLON, KLEV, 6)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZBB, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB4, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB3, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB2, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB1, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZNEBC, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZB1C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA5N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA4N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA3N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA2N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA1NUN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA1N, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA5C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA4C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA3C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA2C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA1CUN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZA1C, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQLI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQICE, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDAMP, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRSURF, (KLON))
REAL (KIND=JPRB)::ZWEIGHT 
fxtran_acdc_temp (REAL (KIND=JPRB), ZDM0I_MAX, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDM0I_MIN, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDM0I, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMU0I, (KLON))
REAL (KIND=JPRB)::ZMU00 
REAL (KIND=JPRB)::ZMU0 
REAL (KIND=JPRB)::ZII0 
REAL (KIND=JPRB)::ZNMXH 
REAL (KIND=JPRB)::ZNMXB 
REAL (KIND=JPRB)::ZNMNH 
REAL (KIND=JPRB)::ZNMNB 
REAL (KIND=JPRB)::ZFLUXE 
REAL (KIND=JPRB)::ZSILON 
REAL (KIND=JPRB)::ZCOLON 
REAL (KIND=JPRB)::ZCOLAT 
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRSODIRT, (KLON))
REAL (KIND=JPRB)::ZTAUCUN 
REAL (KIND=JPRB)::ZTAUC 
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRSODIRS_UN, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRSODIRS_TRUE, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRSODIRS_CUN, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFRSODIRS_C, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCLCT, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTAU, (KLON, 0:KLEV, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTAUL, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTAUD, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZMIXP, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRPROX, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFLUXC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFLUXR, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFLUXL, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFLUXD, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPNER1, (KLON, KLEV, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZPNER0, (KLON, KLEV, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2TA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1TA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO4SA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO3SA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2SA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1SA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSADIR, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSA, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUSI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUSN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSIDIR, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSNUN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOSN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1SI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1SN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2SI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2SN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUSBN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUSBI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUSAN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUSAI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEODTN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEODTI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEODSN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEODSI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOATN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOATI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOASN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOASI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2TN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO2TI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1TN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEO1TI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZBSFTN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZBSFTI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZBSFSN, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZBSFSI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOTI, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOXT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZEOLT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOTI2, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOTI, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOTI2, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOTI, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOSI, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOSI, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOSA, (KLON, 0:KLEV))
INTEGER (KIND=JPIM)::IIDIA 
INTEGER (KIND=JPIM)::IFDIA 
INTEGER (KIND=JPIM)::ISTEP
INTEGER (KIND=JPIM)::ICALT
INTEGER (KIND=JPIM)::ICALS
INTEGER (KIND=JPIM)::ILEV
INTEGER (KIND=JPIM)::IAUCR
INTEGER (KIND=JPIM)::JSTEP
INTEGER (KIND=JPIM)::JN
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV2
INTEGER (KIND=JPIM)::JLEV1
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JAE
LOGICAL::LLNUMX
LOGICAL::LLIDIA
LOGICAL::LLFDIA
LOGICAL::LLAUTO
REAL (KIND=JPRB)::ZZEO2SA
REAL (KIND=JPRB)::ZZEO2TA
REAL (KIND=JPRB)::ZUSA
REAL (KIND=JPRB)::ZUNSCALE
REAL (KIND=JPRB)::ZTSTEP
REAL (KIND=JPRB)::ZSIGMA
REAL (KIND=JPRB)::ZSECUR
REAL (KIND=JPRB)::ZEPSNEB
REAL (KIND=JPRB)::ZSOLLEV
REAL (KIND=JPRB)::ZIEART
REAL (KIND=JPRB)::ZEPSAL
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZSIDT
REAL (KIND=JPRB)::ZCODT
REAL (KIND=JPRB)::ZSIVSR
REAL (KIND=JPRB)::ZCOVSR_NEW
REAL (KIND=JPRB)::ZCOVSR
REAL (KIND=JPRB)::ZCNEB
REAL (KIND=JPRB)::ZCLOV
REAL (KIND=JPRB)::ZW
REAL (KIND=JPRB)::ZDEBL
REAL (KIND=JPRB)::ZEARRT
REAL (KIND=JPRB)::ZTRLI
REAL (KIND=JPRB)::ZARGLI

#include "ac_cloud_model2_openacc.intfb.h"
#include "acraneb_transs_openacc.intfb.h"
#include "acraneb_transt_openacc.intfb.h"
#include "acraneb_coefs_openacc.intfb.h"
#include "acraneb_solvs_openacc.intfb.h"
#include "acraneb_solvt_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZBB) == 8) THEN
    fxtran_acdc_alloc8 (ZBB)
ELSEIF (KIND (ZBB) == 4) THEN
    fxtran_acdc_alloc4 (ZBB)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB4) == 8) THEN
    fxtran_acdc_alloc8 (ZB4)
ELSEIF (KIND (ZB4) == 4) THEN
    fxtran_acdc_alloc4 (ZB4)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB3) == 8) THEN
    fxtran_acdc_alloc8 (ZB3)
ELSEIF (KIND (ZB3) == 4) THEN
    fxtran_acdc_alloc4 (ZB3)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB2) == 8) THEN
    fxtran_acdc_alloc8 (ZB2)
ELSEIF (KIND (ZB2) == 4) THEN
    fxtran_acdc_alloc4 (ZB2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB1) == 8) THEN
    fxtran_acdc_alloc8 (ZB1)
ELSEIF (KIND (ZB1) == 4) THEN
    fxtran_acdc_alloc4 (ZB1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZNEBC) == 8) THEN
    fxtran_acdc_alloc8 (ZNEBC)
ELSEIF (KIND (ZNEBC) == 4) THEN
    fxtran_acdc_alloc4 (ZNEBC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB1C) == 8) THEN
    fxtran_acdc_alloc8 (ZB1C)
ELSEIF (KIND (ZB1C) == 4) THEN
    fxtran_acdc_alloc4 (ZB1C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA5N) == 8) THEN
    fxtran_acdc_alloc8 (ZA5N)
ELSEIF (KIND (ZA5N) == 4) THEN
    fxtran_acdc_alloc4 (ZA5N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA4N) == 8) THEN
    fxtran_acdc_alloc8 (ZA4N)
ELSEIF (KIND (ZA4N) == 4) THEN
    fxtran_acdc_alloc4 (ZA4N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA3N) == 8) THEN
    fxtran_acdc_alloc8 (ZA3N)
ELSEIF (KIND (ZA3N) == 4) THEN
    fxtran_acdc_alloc4 (ZA3N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA2N) == 8) THEN
    fxtran_acdc_alloc8 (ZA2N)
ELSEIF (KIND (ZA2N) == 4) THEN
    fxtran_acdc_alloc4 (ZA2N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA1NUN) == 8) THEN
    fxtran_acdc_alloc8 (ZA1NUN)
ELSEIF (KIND (ZA1NUN) == 4) THEN
    fxtran_acdc_alloc4 (ZA1NUN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA1N) == 8) THEN
    fxtran_acdc_alloc8 (ZA1N)
ELSEIF (KIND (ZA1N) == 4) THEN
    fxtran_acdc_alloc4 (ZA1N)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA5C) == 8) THEN
    fxtran_acdc_alloc8 (ZA5C)
ELSEIF (KIND (ZA5C) == 4) THEN
    fxtran_acdc_alloc4 (ZA5C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA4C) == 8) THEN
    fxtran_acdc_alloc8 (ZA4C)
ELSEIF (KIND (ZA4C) == 4) THEN
    fxtran_acdc_alloc4 (ZA4C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA3C) == 8) THEN
    fxtran_acdc_alloc8 (ZA3C)
ELSEIF (KIND (ZA3C) == 4) THEN
    fxtran_acdc_alloc4 (ZA3C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA2C) == 8) THEN
    fxtran_acdc_alloc8 (ZA2C)
ELSEIF (KIND (ZA2C) == 4) THEN
    fxtran_acdc_alloc4 (ZA2C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA1CUN) == 8) THEN
    fxtran_acdc_alloc8 (ZA1CUN)
ELSEIF (KIND (ZA1CUN) == 4) THEN
    fxtran_acdc_alloc4 (ZA1CUN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA1C) == 8) THEN
    fxtran_acdc_alloc8 (ZA1C)
ELSEIF (KIND (ZA1C) == 4) THEN
    fxtran_acdc_alloc4 (ZA1C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQLI) == 8) THEN
    fxtran_acdc_alloc8 (ZQLI)
ELSEIF (KIND (ZQLI) == 4) THEN
    fxtran_acdc_alloc4 (ZQLI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQICE) == 8) THEN
    fxtran_acdc_alloc8 (ZQICE)
ELSEIF (KIND (ZQICE) == 4) THEN
    fxtran_acdc_alloc4 (ZQICE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDAMP) == 8) THEN
    fxtran_acdc_alloc8 (ZDAMP)
ELSEIF (KIND (ZDAMP) == 4) THEN
    fxtran_acdc_alloc4 (ZDAMP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRSURF) == 8) THEN
    fxtran_acdc_alloc8 (ZRSURF)
ELSEIF (KIND (ZRSURF) == 4) THEN
    fxtran_acdc_alloc4 (ZRSURF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDM0I_MAX) == 8) THEN
    fxtran_acdc_alloc8 (ZDM0I_MAX)
ELSEIF (KIND (ZDM0I_MAX) == 4) THEN
    fxtran_acdc_alloc4 (ZDM0I_MAX)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDM0I_MIN) == 8) THEN
    fxtran_acdc_alloc8 (ZDM0I_MIN)
ELSEIF (KIND (ZDM0I_MIN) == 4) THEN
    fxtran_acdc_alloc4 (ZDM0I_MIN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDM0I) == 8) THEN
    fxtran_acdc_alloc8 (ZDM0I)
ELSEIF (KIND (ZDM0I) == 4) THEN
    fxtran_acdc_alloc4 (ZDM0I)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMU0I) == 8) THEN
    fxtran_acdc_alloc8 (ZMU0I)
ELSEIF (KIND (ZMU0I) == 4) THEN
    fxtran_acdc_alloc4 (ZMU0I)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRSODIRT) == 8) THEN
    fxtran_acdc_alloc8 (ZFRSODIRT)
ELSEIF (KIND (ZFRSODIRT) == 4) THEN
    fxtran_acdc_alloc4 (ZFRSODIRT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRSODIRS_UN) == 8) THEN
    fxtran_acdc_alloc8 (ZFRSODIRS_UN)
ELSEIF (KIND (ZFRSODIRS_UN) == 4) THEN
    fxtran_acdc_alloc4 (ZFRSODIRS_UN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRSODIRS_TRUE) == 8) THEN
    fxtran_acdc_alloc8 (ZFRSODIRS_TRUE)
ELSEIF (KIND (ZFRSODIRS_TRUE) == 4) THEN
    fxtran_acdc_alloc4 (ZFRSODIRS_TRUE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRSODIRS_CUN) == 8) THEN
    fxtran_acdc_alloc8 (ZFRSODIRS_CUN)
ELSEIF (KIND (ZFRSODIRS_CUN) == 4) THEN
    fxtran_acdc_alloc4 (ZFRSODIRS_CUN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRSODIRS_C) == 8) THEN
    fxtran_acdc_alloc8 (ZFRSODIRS_C)
ELSEIF (KIND (ZFRSODIRS_C) == 4) THEN
    fxtran_acdc_alloc4 (ZFRSODIRS_C)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCLCT) == 8) THEN
    fxtran_acdc_alloc8 (ZCLCT)
ELSEIF (KIND (ZCLCT) == 4) THEN
    fxtran_acdc_alloc4 (ZCLCT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTAU) == 8) THEN
    fxtran_acdc_alloc8 (ZTAU)
ELSEIF (KIND (ZTAU) == 4) THEN
    fxtran_acdc_alloc4 (ZTAU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTAUL) == 8) THEN
    fxtran_acdc_alloc8 (ZTAUL)
ELSEIF (KIND (ZTAUL) == 4) THEN
    fxtran_acdc_alloc4 (ZTAUL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTAUD) == 8) THEN
    fxtran_acdc_alloc8 (ZTAUD)
ELSEIF (KIND (ZTAUD) == 4) THEN
    fxtran_acdc_alloc4 (ZTAUD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMIXP) == 8) THEN
    fxtran_acdc_alloc8 (ZMIXP)
ELSEIF (KIND (ZMIXP) == 4) THEN
    fxtran_acdc_alloc4 (ZMIXP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRPROX) == 8) THEN
    fxtran_acdc_alloc8 (ZRPROX)
ELSEIF (KIND (ZRPROX) == 4) THEN
    fxtran_acdc_alloc4 (ZRPROX)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLUXC) == 8) THEN
    fxtran_acdc_alloc8 (ZFLUXC)
ELSEIF (KIND (ZFLUXC) == 4) THEN
    fxtran_acdc_alloc4 (ZFLUXC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLUXR) == 8) THEN
    fxtran_acdc_alloc8 (ZFLUXR)
ELSEIF (KIND (ZFLUXR) == 4) THEN
    fxtran_acdc_alloc4 (ZFLUXR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLUXL) == 8) THEN
    fxtran_acdc_alloc8 (ZFLUXL)
ELSEIF (KIND (ZFLUXL) == 4) THEN
    fxtran_acdc_alloc4 (ZFLUXL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLUXD) == 8) THEN
    fxtran_acdc_alloc8 (ZFLUXD)
ELSEIF (KIND (ZFLUXD) == 4) THEN
    fxtran_acdc_alloc4 (ZFLUXD)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPNER1) == 8) THEN
    fxtran_acdc_alloc8 (ZPNER1)
ELSEIF (KIND (ZPNER1) == 4) THEN
    fxtran_acdc_alloc4 (ZPNER1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZPNER0) == 8) THEN
    fxtran_acdc_alloc8 (ZPNER0)
ELSEIF (KIND (ZPNER0) == 4) THEN
    fxtran_acdc_alloc4 (ZPNER0)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2TA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2TA)
ELSEIF (KIND (ZEO2TA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2TA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1TA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1TA)
ELSEIF (KIND (ZEO1TA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1TA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO4SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO4SA)
ELSEIF (KIND (ZEO4SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO4SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO3SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO3SA)
ELSEIF (KIND (ZEO3SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO3SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2SA)
ELSEIF (KIND (ZEO2SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1SA) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1SA)
ELSEIF (KIND (ZEO1SA) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1SA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSADIR) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSADIR)
ELSEIF (KIND (ZEOSADIR) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSADIR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSA) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSA)
ELSEIF (KIND (ZEOSA) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSA)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUSI) == 8) THEN
    fxtran_acdc_alloc8 (ZUSI)
ELSEIF (KIND (ZUSI) == 4) THEN
    fxtran_acdc_alloc4 (ZUSI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUSN) == 8) THEN
    fxtran_acdc_alloc8 (ZUSN)
ELSEIF (KIND (ZUSN) == 4) THEN
    fxtran_acdc_alloc4 (ZUSN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSIDIR) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSIDIR)
ELSEIF (KIND (ZEOSIDIR) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSIDIR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSI) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSI)
ELSEIF (KIND (ZEOSI) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSNUN) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSNUN)
ELSEIF (KIND (ZEOSNUN) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSNUN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOSN) == 8) THEN
    fxtran_acdc_alloc8 (ZEOSN)
ELSEIF (KIND (ZEOSN) == 4) THEN
    fxtran_acdc_alloc4 (ZEOSN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1SI) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1SI)
ELSEIF (KIND (ZEO1SI) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1SI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1SN) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1SN)
ELSEIF (KIND (ZEO1SN) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1SN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2SI) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2SI)
ELSEIF (KIND (ZEO2SI) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2SI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2SN) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2SN)
ELSEIF (KIND (ZEO2SN) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2SN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUSBN) == 8) THEN
    fxtran_acdc_alloc8 (ZUSBN)
ELSEIF (KIND (ZUSBN) == 4) THEN
    fxtran_acdc_alloc4 (ZUSBN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUSBI) == 8) THEN
    fxtran_acdc_alloc8 (ZUSBI)
ELSEIF (KIND (ZUSBI) == 4) THEN
    fxtran_acdc_alloc4 (ZUSBI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUSAN) == 8) THEN
    fxtran_acdc_alloc8 (ZUSAN)
ELSEIF (KIND (ZUSAN) == 4) THEN
    fxtran_acdc_alloc4 (ZUSAN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUSAI) == 8) THEN
    fxtran_acdc_alloc8 (ZUSAI)
ELSEIF (KIND (ZUSAI) == 4) THEN
    fxtran_acdc_alloc4 (ZUSAI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEODTN) == 8) THEN
    fxtran_acdc_alloc8 (ZEODTN)
ELSEIF (KIND (ZEODTN) == 4) THEN
    fxtran_acdc_alloc4 (ZEODTN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEODTI) == 8) THEN
    fxtran_acdc_alloc8 (ZEODTI)
ELSEIF (KIND (ZEODTI) == 4) THEN
    fxtran_acdc_alloc4 (ZEODTI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEODSN) == 8) THEN
    fxtran_acdc_alloc8 (ZEODSN)
ELSEIF (KIND (ZEODSN) == 4) THEN
    fxtran_acdc_alloc4 (ZEODSN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEODSI) == 8) THEN
    fxtran_acdc_alloc8 (ZEODSI)
ELSEIF (KIND (ZEODSI) == 4) THEN
    fxtran_acdc_alloc4 (ZEODSI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOATN) == 8) THEN
    fxtran_acdc_alloc8 (ZEOATN)
ELSEIF (KIND (ZEOATN) == 4) THEN
    fxtran_acdc_alloc4 (ZEOATN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOATI) == 8) THEN
    fxtran_acdc_alloc8 (ZEOATI)
ELSEIF (KIND (ZEOATI) == 4) THEN
    fxtran_acdc_alloc4 (ZEOATI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOASN) == 8) THEN
    fxtran_acdc_alloc8 (ZEOASN)
ELSEIF (KIND (ZEOASN) == 4) THEN
    fxtran_acdc_alloc4 (ZEOASN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOASI) == 8) THEN
    fxtran_acdc_alloc8 (ZEOASI)
ELSEIF (KIND (ZEOASI) == 4) THEN
    fxtran_acdc_alloc4 (ZEOASI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2TN) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2TN)
ELSEIF (KIND (ZEO2TN) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2TN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO2TI) == 8) THEN
    fxtran_acdc_alloc8 (ZEO2TI)
ELSEIF (KIND (ZEO2TI) == 4) THEN
    fxtran_acdc_alloc4 (ZEO2TI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1TN) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1TN)
ELSEIF (KIND (ZEO1TN) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1TN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEO1TI) == 8) THEN
    fxtran_acdc_alloc8 (ZEO1TI)
ELSEIF (KIND (ZEO1TI) == 4) THEN
    fxtran_acdc_alloc4 (ZEO1TI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBSFTN) == 8) THEN
    fxtran_acdc_alloc8 (ZBSFTN)
ELSEIF (KIND (ZBSFTN) == 4) THEN
    fxtran_acdc_alloc4 (ZBSFTN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBSFTI) == 8) THEN
    fxtran_acdc_alloc8 (ZBSFTI)
ELSEIF (KIND (ZBSFTI) == 4) THEN
    fxtran_acdc_alloc4 (ZBSFTI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBSFSN) == 8) THEN
    fxtran_acdc_alloc8 (ZBSFSN)
ELSEIF (KIND (ZBSFSN) == 4) THEN
    fxtran_acdc_alloc4 (ZBSFSN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZBSFSI) == 8) THEN
    fxtran_acdc_alloc8 (ZBSFSI)
ELSEIF (KIND (ZBSFSI) == 4) THEN
    fxtran_acdc_alloc4 (ZBSFSI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOTI) == 8) THEN
    fxtran_acdc_alloc8 (ZEOTI)
ELSEIF (KIND (ZEOTI) == 4) THEN
    fxtran_acdc_alloc4 (ZEOTI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOXT) == 8) THEN
    fxtran_acdc_alloc8 (ZEOXT)
ELSEIF (KIND (ZEOXT) == 4) THEN
    fxtran_acdc_alloc4 (ZEOXT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEOLT) == 8) THEN
    fxtran_acdc_alloc8 (ZEOLT)
ELSEIF (KIND (ZEOLT) == 4) THEN
    fxtran_acdc_alloc4 (ZEOLT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOTI2) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOTI2)
ELSEIF (KIND (ZUEOTI2) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOTI2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOTI) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOTI)
ELSEIF (KIND (ZUEOTI) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOTI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOTI2) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOTI2)
ELSEIF (KIND (ZDEOTI2) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOTI2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOTI) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOTI)
ELSEIF (KIND (ZDEOTI) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOTI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOSI) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOSI)
ELSEIF (KIND (ZUEOSI) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOSI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOSI) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOSI)
ELSEIF (KIND (ZDEOSI) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOSI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOSA) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOSA)
ELSEIF (KIND (ZDEOSA) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOSA)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPSNEB=1.E-12_JPRB
ZSECUR=4._JPRB*YDCST%RSIGMA*YDCST%RG*YDML_PHY_MF%YRPHY2%TSPHY
ZEPS1=1.E-03_JPRB
ZEPSAL=1.E-04_JPRB
ZARGLI=-250._JPRB
ZTRLI=EXP (ZARGLI)

IF (LDCONFX) THEN
  ZTSTEP=0._JPRB
ELSE
  ZTSTEP=YDML_PHY_MF%YRPHY2%TSPHY
ENDIF


IF (YDML_PHY_MF%YRPHY%NSORAYFR==1) THEN
  ICALS=0
ELSEIF (MOD (KSTEP, YDML_PHY_MF%YRPHY%NSORAYFR)==0) THEN

  IF (KSTEP==YDRIP%NSTOP) THEN
    ICALS=0
  ELSE
    ICALS=1
  ENDIF

ELSE
  ICALS=2
ENDIF

ICALT=0

IF (MOD (KSTEP, YDML_PHY_MF%YRPHY%NTHRAYFR)==0) THEN
  ICALT=1
  LLAUTO=.FALSE.
ENDIF


IF (YDML_PHY_MF%YRPHY%NRAUTOEV>0) THEN

  IF (MOD (KSTEP, YDML_PHY_MF%YRPHY%NTHRAYFR*YDML_PHY_MF%YRPHY%NRAUTOEV&
    &)==0.AND.(KSTEP<YDRIP%NSTOP.OR.YDRIP%NSTOP==0)) THEN
    ICALT=2
    LLAUTO=.TRUE.
  ENDIF

ENDIF


DO JLEV=KTDIA, KLEV
  
  ZQICE (JLON, JLEV)=PQICE (JLON, JLEV)/MAX (ZEPSNEB, PNEB (JLON, JLEV))
  ZQLI (JLON, JLEV)=PQLI (JLON, JLEV)/MAX (ZEPSNEB, PNEB (JLON, JLEV))
  
ENDDO

ZEO2TA(JLON,:)=0._JPRB
ZEO2SA(JLON,:)=0._JPRB
ZEO1TA(JLON,:)=0._JPRB
ZEO1SA(JLON,:)=0._JPRB
ZEOSA(JLON,:)=0._JPRB
ZEOSADIR(JLON,:)=0._JPRB

DO JAE=1, 6
  ZUNSCALE=4._JPRB*YDML_PHY_MF%YRPHY3%USAA(JAE)/(3._JPRB+4._JPRB*YDML_PHY_MF%YRPHY3%USAA(JAE))
  ZUNSCALE=1._JPRB/(1._JPRB-ZUNSCALE*ZUNSCALE)

  DO JLEV=KTDIA, KLEV
    
    ZZEO2TA=2._JPRB*YDML_PHY_MF%YRPHY3%BSFTA(JAE)*YDML_PHY_MF%YRPHY3%EODTA(JAE)*PDAER (JLON, JLEV, JAE)
    ZZEO2SA=2._JPRB*YDML_PHY_MF%YRPHY3%BSFSA(JAE)*YDML_PHY_MF%YRPHY3%EODSA(JAE)*PDAER (JLON, JLEV, JAE)
    ZEO2TA (JLON, JLEV)=ZEO2TA (JLON, JLEV)+ZZEO2TA
    ZEO2SA (JLON, JLEV)=ZEO2SA (JLON, JLEV)+ZZEO2SA
    ZEO1TA (JLON, JLEV)=ZEO1TA (JLON, JLEV)+ZZEO2TA+2._JPRB*YDML_PHY_MF&
    &%YRPHY3%EOATA(JAE)*PDAER (JLON, JLEV, JAE)
    ZEO1SA (JLON, JLEV)=ZEO1SA (JLON, JLEV)+ZZEO2SA+2._JPRB*YDML_PHY_MF&
    &%YRPHY3%EOASA(JAE)*PDAER (JLON, JLEV, JAE)
    ZEOSA (JLON, JLEV)=ZEOSA (JLON, JLEV)+(YDML_PHY_MF%YRPHY3%EODSA&
    &(JAE)+YDML_PHY_MF%YRPHY3%EOASA(JAE))*PDAER (JLON, JLEV, JAE)
    ZEOSADIR (JLON, JLEV)=ZEOSADIR (JLON, JLEV)+(YDML_PHY_MF%YRPHY3%EODSA(JAE&
    &)*ZUNSCALE+YDML_PHY_MF%YRPHY3%EOASA(JAE))*PDAER (JLON, JLEV, JAE)
  
  ENDDO

ENDDO


IF (ICALS==1) THEN
  
  PGMU0_MIN (JLON)=1._JPRB
  PGMU0_MAX (JLON)=0._JPRB
  ZCOLON =COS (PGELAM (JLON))
  ZSILON =SIN (PGELAM (JLON))
  ZCOLAT =SQRT (1.0_JPRB-PGEMU (JLON)**2)
  
  ZCOVSR=YDRIP%RCOVSR
  ZSIVSR=YDRIP%RSIVSR
  ZCODT=COS (2._JPRB*YDCST%RPI*YDML_PHY_MF%YRPHY2%TSPHY/YDCST%RDAY)
  ZSIDT=SIN (2._JPRB*YDCST%RPI*YDML_PHY_MF%YRPHY2%TSPHY/YDCST%RDAY)

  DO JSTEP=0, MIN (YDML_PHY_MF%YRPHY%NSORAYFR-1, YDRIP%NSTOP-KSTEP)
    
    PGMU0 (JLON, JSTEP)=MAX (YDRIP%RSIDEC*PGEMU (JLON)-YDRIP%RCODEC*ZCOVSR&
    &*ZCOLAT *ZCOLON +YDRIP%RCODEC*ZSIVSR*ZCOLAT *ZSILON , 0.0_JPRB)
    PGMU0_MIN (JLON)=MIN (PGMU0_MIN (JLON), PGMU0 (JLON, JSTEP))
    PGMU0_MAX (JLON)=MAX (PGMU0_MAX (JLON), PGMU0 (JLON, JSTEP))
    
    ZCOVSR_NEW=ZCOVSR*ZCODT-ZSIVSR*ZSIDT
    ZSIVSR=ZSIVSR*ZCODT+ZCOVSR*ZSIDT
    ZCOVSR=ZCOVSR_NEW
  ENDDO

ENDIF


IF (YDML_PHY_MF%YRPHY%LRAYLU) THEN
  
  ZSOLLEV=0.5_JPRB*(1._JPRB-SIGN (1._JPRB, 0._JPRB-PMU0 (JLON)))
  ZMU0 =ZSOLLEV*PMU0 (JLON)+(1._JPRB-ZSOLLEV)*PMU0LU (JLON)
  ZII0 =ZSOLLEV*YDML_PHY_MF%YRPHY3%RII0+(1._JPRB-ZSOLLEV)*YDRIP%RIP0LU
  
ELSEIF (ICALS==0) THEN
  
  ZMU0 =PMU0 (JLON)
  ZII0 =YDML_PHY_MF%YRPHY3%RII0
  
ELSE
  ISTEP=MOD (KSTEP, YDML_PHY_MF%YRPHY%NSORAYFR)
  
  ZMU0 =PGMU0 (JLON, ISTEP)
  ZII0 =YDML_PHY_MF%YRPHY3%RII0
  
ENDIF

ZEARRT=YDML_PHY_MF%YRPHY3%EARRT*(YDML_PHY_MF%YRPHY3%EARRT+2._JPRB)
ZIEART=1._JPRB/YDML_PHY_MF%YRPHY3%EARRT

ZDM0I (JLON)=0.5_JPRB*(SQRT (ZMU0 *ZMU0 +ZEARRT)-ZMU0 )*ZIEART


IF (.NOT.YDML_PHY_MF%YRPHY%LRAYPL.OR.(YDML_PHY_MF%YRPHY&
  &%NPHYREP/=0.AND.YDML_PHY_MF%YRPHY%NPHYREP/=-4)) THEN
  IAUCR=1
  
  
ELSE

  IF (ICALS==0) THEN
    
    ZMU00 =ZMU0 
  
  ELSE
    
    ZMU00 =PGMU0_MAX (JLON)
  
  ENDIF

  IAUCR=0
  LLIDIA=ZMU00 >0._JPRB
  LLFDIA=.FALSE.

  IF (LLIDIA) THEN
    IAUCR=1
  
  ENDIF

  
  LLFDIA=ZMU00 >0._JPRB

  IF (LLFDIA.NEQV.LLIDIA) THEN

    IF (LLFDIA) THEN
      IAUCR=IAUCR+1
    
    ELSE
    
    ENDIF

    LLIDIA=LLFDIA
  ENDIF


  

  IF (LLFDIA) THEN
  
  ENDIF

ENDIF


IF (ICALS>0) THEN
  
  ZDM0I_MIN (JLON)=0.5_JPRB*(SQRT (PGMU0_MAX (JLON)*PGMU0_MAX&
  & (JLON)+ZEARRT)-PGMU0_MAX (JLON))*ZIEART-ZEPS1
  ZDM0I_MAX (JLON)=0.5_JPRB*(SQRT (PGMU0_MIN (JLON)*PGMU0_MIN&
  & (JLON)+ZEARRT)-PGMU0_MIN (JLON))*ZIEART+ZEPS1
  
ENDIF


IF (ICALS==0) THEN
  CALL ACRANEB_TRANSS_OPENACC (YDCST, YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY3, KIDIA&
  &, KFDIA, KLON, KTDIA, KLEV, KLON, KIDIA, KFDIA, IAUCR, PAPRS, PAPRSF, PDELP&
  &, PR, PT, PQ, PQCO2, PQO3, ZDM0I, ZDEOSI, ZUEOSI, YDSTACK=YLSTACK)
ELSEIF (ICALS==1) THEN
  CALL ACRANEB_TRANSS_OPENACC (YDCST, YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY3, KIDIA&
  &, KFDIA, KLON, KTDIA, KLEV, KLON, KIDIA, KFDIA, IAUCR, PAPRS, PAPRSF, PDELP,&
  & PR, PT, PQ, PQCO2, PQO3, ZDM0I_MIN, ZDEOSI, ZUEOSI, YDSTACK=YLSTACK)

  DO JLEV=KTDIA-1, KLEV
    
    PGDEOSI (JLON, JLEV, 1)=LOG (MAX (ZDEOSI (JLON, JLEV), ZTRLI))
    PGUEOSI (JLON, JLEV, 1)=LOG (MAX (ZUEOSI (JLON, JLEV), ZTRLI))
  
  ENDDO

  CALL ACRANEB_TRANSS_OPENACC (YDCST, YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY3, KIDIA&
  &, KFDIA, KLON, KTDIA, KLEV, KLON, KIDIA, KFDIA, IAUCR, PAPRS, PAPRSF, PDELP,&
  & PR, PT, PQ, PQCO2, PQO3, ZDM0I_MAX, ZDEOSI, ZUEOSI, YDSTACK=YLSTACK)

  DO JLEV=KTDIA-1, KLEV
    
    PGDEOSI (JLON, JLEV, 2)=LOG (MAX (ZDEOSI (JLON, JLEV), ZTRLI))
    PGUEOSI (JLON, JLEV, 2)=LOG (MAX (ZUEOSI (JLON, JLEV), ZTRLI))
  
  ENDDO

ENDIF


IF (ICALS>0) THEN
  
  ZWEIGHT =LOG (ZDM0I (JLON)/ZDM0I_MIN (JLON))/LOG (ZDM0I_MAX (JLON)/ZDM0I_MIN (JLON))

  

  DO JLEV=KTDIA-1, KLEV
    
    ZDEOSI (JLON, JLEV)=EXP (PGDEOSI (JLON, JLEV, 1)+ZWEIGHT&
    & *(PGDEOSI (JLON, JLEV, 2)-PGDEOSI (JLON, JLEV, 1)))
    ZUEOSI (JLON, JLEV)=EXP (PGUEOSI (JLON, JLEV, 1)+ZWEIGHT&
    & *(PGUEOSI (JLON, JLEV, 2)-PGUEOSI (JLON, JLEV, 1)))
  
  ENDDO

ENDIF


IF (ICALT>0) THEN
  CALL ACRANEB_TRANST_OPENACC (YDCST, YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY3, KIDIA, KFDIA, KLON&
  &, KTDIA, KLEV, LLAUTO, PAPRS, PAPRSF, PDELP, PR, PT, PTS, PQ, PQCO2, PQO3, ZDEOTI, ZDEOTI2&
  &, ZUEOTI, ZUEOTI2, ZEOLT, ZEOXT, ZPNER0, ZPNER1, ZRPROX, ZRSURF, YDSTACK=YLSTACK)

  IF (YDML_PHY_MF%YRPHY%NTHRAYFR/=1) THEN
    
    PGRSURF (JLON)=ZRSURF (JLON)

    

    DO JLEV=KTDIA, KLEV
      
      PGEOXT (JLON, JLEV)=ZEOXT (JLON, JLEV)

      

      IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
        
        PGEOLT (JLON, JLEV)=ZEOLT (JLON, JLEV)
      
      ENDIF

    ENDDO


    DO JLEV=KTDIA-1, KLEV
      
      PGDEOTI (JLON, JLEV)=ZDEOTI (JLON, JLEV)
      PGDEOTI2 (JLON, JLEV)=ZDEOTI2 (JLON, JLEV)
      PGUEOTI (JLON, JLEV)=ZUEOTI (JLON, JLEV)
      PGUEOTI2 (JLON, JLEV)=ZUEOTI2 (JLON, JLEV)

      

      IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
        
        PGRPROX (JLON, JLEV)=ZRPROX (JLON, JLEV)
      
      ENDIF

    ENDDO

  ENDIF

ELSE
  
  ZRSURF (JLON)=PGRSURF (JLON)

  

  DO JLEV=KTDIA, KLEV
    
    ZEOXT (JLON, JLEV)=PGEOXT (JLON, JLEV)

    

    IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
      
      ZEOLT (JLON, JLEV)=PGEOLT (JLON, JLEV)
    
    ENDIF

  ENDDO


  DO JLEV=KTDIA-1, KLEV
    
    ZDEOTI (JLON, JLEV)=PGDEOTI (JLON, JLEV)
    ZDEOTI2 (JLON, JLEV)=PGDEOTI2 (JLON, JLEV)
    ZUEOTI (JLON, JLEV)=PGUEOTI (JLON, JLEV)
    ZUEOTI2 (JLON, JLEV)=PGUEOTI2 (JLON, JLEV)

    

    IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
      
      ZRPROX (JLON, JLEV)=PGRPROX (JLON, JLEV)
    
    ENDIF

  ENDDO

ENDIF


DO JLEV=KTDIA-1, KLEV
  
  ZEOTI (JLON, JLEV)=MIN (ZUEOTI (JLON, JLEV), ZDEOTI (JLON, JLEV))
  
ENDDO


ZDEOSA (JLON, KTDIA-1)=ZDM0I (JLON)*ZDEOSI (JLON, KTDIA-1)


DO JLEV=KTDIA, KLEV
  
  ZDEOSA (JLON, JLEV)=ZDEOSA (JLON, JLEV-1)+ZDM0I (JLON)*ZDEOSI (JLON, JLEV)
  
ENDDO

CALL AC_CLOUD_MODEL2_OPENACC (YDCST, YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY3, KIDIA, KFDIA&
&, KLON, KTDIA, KLEV, KLON, KIDIA, KFDIA, IAUCR, PDELP, PNEB, ZQICE, ZQLI, PR, PAPRSF, PT&
&, ZDEOSA, ZBSFSI, ZBSFSN, ZBSFTI, ZBSFTN, ZEOASI, ZEOASN, ZEOATI, ZEOATN, ZEODSI, ZEODSN&
&, ZEODTI, ZEODTN, ZEOSIDIR, ZEOSNUN, ZUSAI, ZUSAN, ZUSBI, ZUSBN, YDSTACK=YLSTACK)

DO JLEV=KTDIA, KLEV
  
  ZEO2TI (JLON, JLEV)=2._JPRB*ZBSFTI (JLON, JLEV)*ZEODTI (JLON, JLEV)
  ZEO2TN (JLON, JLEV)=2._JPRB*ZBSFTN (JLON, JLEV)*ZEODTN (JLON, JLEV)
  ZEO1TI (JLON, JLEV)=ZEO2TI (JLON, JLEV)+2._JPRB*ZEOATI (JLON, JLEV)
  ZEO1TN (JLON, JLEV)=ZEO2TN (JLON, JLEV)+2._JPRB*ZEOATN (JLON, JLEV)
  
ENDDO


IF (YDML_PHY_MF%YRPHY%LRNUMX) THEN
  
  ZB1 (JLON, KTDIA)=1._JPRB-PNEB (JLON, KTDIA)
  ZB3 (JLON, KTDIA)=1._JPRB
  ZNMXB =MAX (PNEB (JLON, KTDIA), PNEB (JLON, KTDIA+1))
  ZNMNB =MIN (PNEB (JLON, KTDIA), PNEB (JLON, KTDIA+1))
  ZB1 (JLON, KTDIA+1)=(1._JPRB-ZNMXB )/(1._JPRB-PNEB (JLON, KTDIA))
  ZB3 (JLON, KTDIA+1)=ZNMNB /PNEB (JLON, KTDIA)

  

  DO JLEV=KTDIA+1, KLEV-1
    
    ZNMXH =ZNMXB 
    ZNMNH =ZNMNB 
    
    
    ZNMXB =MAX (PNEB (JLON, JLEV), PNEB (JLON, JLEV+1))
    ZNMNB =MIN (PNEB (JLON, JLEV), PNEB (JLON, JLEV+1))
    ZB1 (JLON, JLEV+1)=(1._JPRB-ZNMXB )*(1._JPRB/(1._JPRB-PNEB (JLON, JLEV)))
    ZB2 (JLON, JLEV-1)=(1._JPRB-ZNMXH )*(1._JPRB/(1._JPRB-PNEB (JLON, JLEV)))
    ZB3 (JLON, JLEV+1)=ZNMNB *(1._JPRB/PNEB (JLON, JLEV))
    ZB4 (JLON, JLEV-1)=ZNMNH *(1._JPRB/PNEB (JLON, JLEV))
  
  ENDDO

  
  ZNMXH =ZNMXB 
  ZNMNH =ZNMNB 
  ZB2 (JLON, KLEV-1)=(1._JPRB-ZNMXH )/(1._JPRB-PNEB (JLON, KLEV))
  ZB4 (JLON, KLEV-1)=ZNMNH /PNEB (JLON, KLEV)
  ZB2 (JLON, KLEV)=1._JPRB
  ZB4 (JLON, KLEV)=1._JPRB

  

  IF (YDML_PHY_MF%YRPHY%LRNUEXP) THEN

    DO JLEV=KTDIA+1, KLEV
      
      ZCLOV=EXP ((PAPRSF (JLON, JLEV-1)-PAPRSF (JLON, JLEV))/PDECRD (JLON))
      ZCNEB=1._JPRB-PNEB (JLON, JLEV)
      ZB1 (JLON, JLEV)=ZCNEB+ZCLOV*(ZB1 (JLON, JLEV)-ZCNEB)
      ZB3 (JLON, JLEV)=PNEB (JLON, JLEV)+ZCLOV*(ZB3 (JLON, JLEV)-PNEB (JLON, JLEV))
    
    ENDDO


    DO JLEV=KTDIA, KLEV-1
      
      ZCLOV=EXP ((PAPRSF (JLON, JLEV)-PAPRSF (JLON, JLEV+1))/PDECRD (JLON))
      ZCNEB=1._JPRB-PNEB (JLON, JLEV)
      ZB2 (JLON, JLEV)=ZCNEB+ZCLOV*(ZB2 (JLON, JLEV)-ZCNEB)
      ZB4 (JLON, JLEV)=PNEB (JLON, JLEV)+ZCLOV*(ZB4 (JLON, JLEV)-PNEB (JLON, JLEV))
    
    ENDDO

  ENDIF

ELSE

  DO JLEV=KTDIA, KLEV
    
    ZB1 (JLON, JLEV)=1._JPRB-PNEB (JLON, JLEV)
  
  ENDDO

ENDIF


DO JLEV=KTDIA, KLEV
  
  ZBB (JLON, JLEV-1)=YDCST%RSIGMA*(PT (JLON, JLEV)*PT (JLON, JLEV))*(PT (JLON, JLEV)*PT (JLON, JLEV))
  ZDAMP (JLON, JLEV)=ZSECUR*PT (JLON, JLEV)*(PT (JLON, JLEV)&
  &*PT (JLON, JLEV))/(PDELP (JLON, JLEV)*PCP (JLON, JLEV))
  
ENDDO


ZBB (JLON, KLEV)=YDCST%RSIGMA*(PTS (JLON)*PTS (JLON))*(PTS (JLON)*PTS (JLON))


IF ((YDML_PHY_MF%YRPHY%NRAUTOEV==0.AND.ICALT==1).OR.ICALT==2) THEN

  DO JLEV=KTDIA, KLEV
    
    ZTAUD (JLON, JLEV)=EXP (MAX (-ZEOTI (JLON, JLEV), ZARGLI))
    ZTAUL (JLON, JLEV)=EXP (MAX (-ZEOXT (JLON, JLEV), ZARGLI))
  
  ENDDO


  DO JLEV1=KTDIA-1, KLEV
    
    ZTAU (JLON, JLEV1, JLEV1)=1._JPRB

    

    DO JLEV2=JLEV1+1, KLEV
      
      ZTAU (JLON, JLEV1, JLEV2)=ZTAU (JLON, JLEV1, JLEV2-1)*ZTAUD (JLON, JLEV2)
    
    ENDDO

  ENDDO

  ZFLUXD (JLON,:)=0._JPRB

  DO JLEV1=KTDIA, KLEV

    IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
      ILEV=JLEV1+2
    ELSE
      ILEV=JLEV1+1
    ENDIF


    DO JLEV2=ILEV, KLEV
      
      ZFLUXE =(ZBB (JLON, JLEV2-1)-ZBB (JLON, JLEV1-1))*(ZTAU (JLON, JLEV1, JLEV2)-ZTAU (JLON&
      &, JLEV1-1, JLEV2)-ZTAU (JLON, JLEV1, JLEV2-1)+ZTAU (JLON, JLEV1-1, JLEV2-1))

      

      DO JLEV=JLEV1, JLEV2-1
        
        ZFLUXD (JLON, JLEV)=ZFLUXD (JLON, JLEV)+ZFLUXE 
      
      ENDDO

    ENDDO

  ENDDO


  DO JLEV1=KTDIA-1, KLEV
    
    ZTAU (JLON, JLEV1, JLEV1)=1._JPRB

    

    DO JLEV2=JLEV1+1, KLEV
      
      ZTAU (JLON, JLEV1, JLEV2)=ZTAU (JLON, JLEV1, JLEV2-1)*ZTAUL (JLON, JLEV2)
    
    ENDDO

  ENDDO

  ZFLUXL (JLON,:)=0._JPRB

  DO JLEV1=KTDIA, KLEV

    IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
      ILEV=JLEV1+2
    ELSE
      ILEV=JLEV1+1
    ENDIF


    DO JLEV2=ILEV, KLEV
      
      ZFLUXE =(ZBB (JLON, JLEV2-1)-ZBB (JLON, JLEV1-1))*(ZTAU (JLON, JLEV1, JLEV2)-ZTAU (JLON&
      &, JLEV1-1, JLEV2)-ZTAU (JLON, JLEV1, JLEV2-1)+ZTAU (JLON, JLEV1-1, JLEV2-1))

      

      DO JLEV=JLEV1, JLEV2-1
        
        ZFLUXL (JLON, JLEV)=ZFLUXL (JLON, JLEV)+ZFLUXE 
      
      ENDDO

    ENDDO

  ENDDO

ENDIF


IF (YDML_PHY_MF%YRPHY%NRAUTOEV==0.AND.ICALT==1) THEN
  
  ZFLUXR (JLON, KTDIA-1)=0._JPRB
  ZFLUXR (JLON, KLEV)=0._JPRB

  

  DO JLEV=KTDIA, KLEV-1
    
    ZSIGMA=PAPRS (JLON, JLEV)/PAPRS (JLON, KLEV)
    ZFLUXR (JLON, JLEV)=(YDML_PHY_MF%YRPHY3%FSM_AA(0)+ZSIGMA*(YDML_PHY_MF%YRPHY3%FSM_AA(1)+ZSIGMA&
    &*YDML_PHY_MF%YRPHY3%FSM_AA(2)))*ZFLUXD (JLON, JLEV)+(YDML_PHY_MF%YRPHY3%FSM_BB(0)+ZSIGMA*(YDML_PHY_MF&
    &%YRPHY3%FSM_BB(1)+ZSIGMA*YDML_PHY_MF%YRPHY3%FSM_BB(2)))*ZFLUXL (JLON, JLEV)
  
  ENDDO

ELSEIF (ICALT==2) THEN
  ZFLUXR (JLON,:)=0._JPRB

  DO JLEV1=KTDIA, KLEV

    IF (YDML_PHY_MF%YRPHY%LRPROX) THEN
      ILEV=JLEV1+2
    ELSE
      ILEV=JLEV1+1
    ENDIF


    DO JLEV2=ILEV, KLEV
      
      ZFLUXE =(ZBB (JLON, JLEV2-1)-ZBB (JLON, JLEV1-1))*ZPNER0 (JLON, JLEV1, JLEV2)+4._JPRB*(PT&
      & (JLON, JLEV2)/YDML_PHY_MF%YRPHY3%RTL-1._JPRB)*ZBB (JLON, JLEV2-1)*(ZPNER1 (JLON, JLEV1,&
      & JLEV2)-ZPNER0 (JLON, JLEV1, JLEV2))-4._JPRB*(PT (JLON, JLEV1)/YDML_PHY_MF%YRPHY3%RTL-1._JPRB&
      &)*ZBB (JLON, JLEV1-1)*(ZPNER1 (JLON, JLEV1, JLEV2)-ZPNER0 (JLON, JLEV1, JLEV2))

      

      DO JLEV=JLEV1, JLEV2-1
        
        ZFLUXR (JLON, JLEV)=ZFLUXR (JLON, JLEV)+ZFLUXE 
      
      ENDDO

    ENDDO

  ENDDO

ENDIF


IF ((YDML_PHY_MF%YRPHY%NRAUTOEV==0.AND.ICALT==1).OR.ICALT==2) THEN

  DO JLEV=KTDIA-1, KLEV
    
    ZDEBL=ZFLUXL (JLON, JLEV)-ZFLUXD (JLON, JLEV)
    ZW=YDML_PHY_MF%YRPHY3%RMIXD*YDML_PHY_MF%YRPHY3%RMIXD/(YDML_PHY_MF&
    &%YRPHY3%RMIXD*YDML_PHY_MF%YRPHY3%RMIXD+ZDEBL*ZDEBL)
    ZMIXP (JLON, JLEV)=MAX (0._JPRB, MIN (1._JPRB,((1._JPRB-ZW)*ZFLUXR (JLON, JLEV&
    &)+ZW*(ZFLUXD (JLON, JLEV)+YDML_PHY_MF%YRPHY3%RMIXP0*(ZFLUXL (JLON, JLEV)-ZFLUXD&
    & (JLON, JLEV)))-ZFLUXD (JLON, JLEV))/SIGN (MAX (ABS (ZFLUXL (JLON, JLEV)-ZFLUXD&
    & (JLON, JLEV)), ZEPS1), ZFLUXL (JLON, JLEV)-ZFLUXD (JLON, JLEV))))
    ZFLUXC (JLON, JLEV)=ZFLUXR (JLON, JLEV)-(ZFLUXD (JLON, JLEV)+ZMIXP&
    & (JLON, JLEV)*(ZFLUXL (JLON, JLEV)-ZFLUXD (JLON, JLEV)))
  
  ENDDO

ENDIF


IF (YDML_PHY_MF%YRPHY%NTHRAYFR/=1.OR.YDML_PHY_MF%YRPHY%NRAUTOEV>1) THEN

  IF ((YDML_PHY_MF%YRPHY%NRAUTOEV==0.AND.ICALT==1).OR.ICALT==2) THEN

    DO JLEV=KTDIA-1, KLEV
      
      PGMIXP (JLON, JLEV)=ZMIXP (JLON, JLEV)
      PGFLUXC (JLON, JLEV)=ZFLUXC (JLON, JLEV)
    
    ENDDO

  ELSE

    DO JLEV=KTDIA-1, KLEV
      
      ZMIXP (JLON, JLEV)=PGMIXP (JLON, JLEV)
      ZFLUXC (JLON, JLEV)=PGFLUXC (JLON, JLEV)
    
    ENDDO

  ENDIF

ENDIF


IF (KNFRRC/=0) THEN

  IF (MOD (KSTEP, KNFRRC)==0) THEN
    LLNUMX=.FALSE.
    ZNEBC (JLON,:)=0._JPRB
    ZB1C (JLON,:)=1._JPRB
    CALL ACRANEB_SOLVT_OPENACC (YDML_PHY_MF%YRPHY, LLNUMX, KIDIA, KFDIA, KLON, KTDIA&
    &, KLEV, ZQICE, ZQLI, ZNEBC, ZB1C, ZB2, ZB3, ZB4, PDELP, ZBB, ZDEOTI, ZDEOTI2, ZUEOTI&
    &, ZUEOTI2, ZEOLT, ZEOXT, ZRPROX, ZMIXP, ZFLUXC, ZEO1TI, ZEO2TI, ZEO1TN, ZEO2TN,&
    & ZEO1TA, ZEO2TA, ZDAMP, PEMIS, ZRSURF, PFRTH, PFRTHDS, YDSTACK=YLSTACK)
    
    PFRTHC (JLON, 0)=PFRTH (JLON, KTDIA-1)
    PFRTHC (JLON, 1)=PFRTH (JLON, KLEV)
  
  ENDIF

ENDIF

CALL ACRANEB_SOLVT_OPENACC (YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY%LRNUMX, KIDIA, KFDIA&
&, KLON, KTDIA, KLEV, ZQICE, ZQLI, PNEB, ZB1, ZB2, ZB3, ZB4, PDELP, ZBB, ZDEOTI, ZDEOTI2&
&, ZUEOTI, ZUEOTI2, ZEOLT, ZEOXT, ZRPROX, ZMIXP, ZFLUXC, ZEO1TI, ZEO2TI, ZEO1TN, ZEO2TN&
&, ZEO1TA, ZEO2TA, ZDAMP, PEMIS, ZRSURF, PFRTH, PFRTHDS, YDSTACK=YLSTACK)

ZMU0I (JLON)=2._JPRB*ZDM0I (JLON)

ZEO3SA(JLON,:)=0._JPRB
ZEO4SA(JLON,:)=0._JPRB

DO JAE=1, 6

  DO JLEV=KTDIA, KLEV
    
    ZUSA=(0.5_JPRB+YDML_PHY_MF%YRPHY3%USAA(JAE)*ZMU0 )/(1._JPRB+YDML_PHY_MF%YRPHY3%USBA*ZMU0 )
    ZEO3SA (JLON, JLEV)=ZEO3SA (JLON, JLEV)+YDML_PHY_MF%YRPHY3%EODSA(JAE)*PDAER (JLON, JLEV, JAE)*ZUSA
    ZEO4SA (JLON, JLEV)=ZEO4SA (JLON, JLEV)+YDML_PHY_MF%YRPHY3&
    &%EODSA(JAE)*PDAER (JLON, JLEV, JAE)*(1._JPRB-ZUSA)
  
  ENDDO

ENDDO


DO JLEV=KTDIA, KLEV
  
  ZEO2SN (JLON, JLEV)=2._JPRB*ZBSFSN (JLON, JLEV)*ZEODSN (JLON, JLEV)
  ZEO2SI (JLON, JLEV)=2._JPRB*ZBSFSI (JLON, JLEV)*ZEODSI (JLON, JLEV)
  ZEO1SN (JLON, JLEV)=ZEO2SN (JLON, JLEV)+2._JPRB*ZEOASN (JLON, JLEV)
  ZEO1SI (JLON, JLEV)=ZEO2SI (JLON, JLEV)+2._JPRB*ZEOASI (JLON, JLEV)
  ZEOSN (JLON, JLEV)=ZEODSN (JLON, JLEV)+ZEOASN (JLON, JLEV)
  ZEOSI (JLON, JLEV)=ZEODSI (JLON, JLEV)+ZEOASI (JLON, JLEV)
  ZUSN (JLON, JLEV)=(0.5_JPRB+ZUSAN (JLON, JLEV)*ZMU0 )/(1._JPRB+ZUSBN (JLON, JLEV)*ZMU0 )
  ZUSI (JLON, JLEV)=(0.5_JPRB+ZUSAI (JLON, JLEV)*ZMU0 )/(1._JPRB+ZUSBI (JLON, JLEV)*ZMU0 )
  
ENDDO

CALL ACRANEB_COEFS_OPENACC (YDML_PHY_MF%YRPHY3, KLON, KTDIA, KLEV, KLON, KIDIA, KFDIA, IAUCR, PAPRSF&
&, PDELP, ZQICE, ZQLI, ZDEOSI, ZEODSI, ZEODSN, ZEOSI, ZEOSIDIR, ZEOSN, ZEOSNUN, ZEO1SI, ZEO1SN, ZEO2SI&
&, ZEO2SN, ZUEOSI, ZUSI, ZUSN, ZEOSA, ZEOSADIR, ZEO1SA, ZEO2SA, ZEO3SA, ZEO4SA, ZMU0I, ZA1C, ZA1CUN&
&, ZA2C, ZA3C, ZA4C, ZA5C, ZA1N, ZA1NUN, ZA2N, ZA3N, ZA4N, ZA5N, YDSTACK=YLSTACK)
ZTAUC =1._JPRB
ZTAUCUN =1._JPRB

DO JLEV=KTDIA, KLEV
  
  ZTAUC =ZTAUC *ZA1C (JLON, JLEV)
  ZTAUCUN =ZTAUCUN *ZA1CUN (JLON, JLEV)
  
ENDDO


ZFRSODIRT (JLON)=0._JPRB
ZFRSODIRS_C (JLON)=0._JPRB
ZFRSODIRS_CUN (JLON)=0._JPRB


ZFRSODIRT (JLON)=ZII0 *ZMU0 *EXP (MAX (-0.5_JPRB*ZMU0I (JLON)*ZDEOSI (JLON, KTDIA-1), ZARGLI))
ZFRSODIRS_C (JLON)=ZFRSODIRT (JLON)*ZTAUC 
ZFRSODIRS_CUN (JLON)=ZFRSODIRT (JLON)*ZTAUCUN 


IF (KNFRRC/=0) THEN

  IF (MOD (KSTEP, KNFRRC)==0) THEN
    LLNUMX=.FALSE.
    ZCLCT (JLON)=0._JPRB
    ZNEBC (JLON,:)=0._JPRB
    ZB1C (JLON,:)=1._JPRB
    CALL ACRANEB_SOLVS_OPENACC (YDML_PHY_MF%YRPHY, LLNUMX, KLON, KTDIA, KLEV, KLON, KIDIA, KFDIA&
    &, IAUCR, PALB, PALBDIR, ZCLCT, ZFRSODIRT, ZFRSODIRS_C, ZFRSODIRS_CUN, ZNEBC, ZB1C, ZB2&
    &, ZB3, ZB4, ZA1C, ZA1CUN, ZA2C, ZA3C, ZA4C, ZA5C, ZA1N, ZA1NUN, ZA2N, ZA3N, ZA4N, ZA5N&
    &, PFRSO, PFRSODIFS, PFRSODIRS, ZFRSODIRS_UN, ZFRSODIRS_TRUE, YDSTACK=YLSTACK)
    
    PFRSOC (JLON, 0)=PFRSO (JLON, KTDIA-1)
    PFRSOC (JLON, 1)=PFRSO (JLON, KLEV)
  
  ENDIF

ENDIF

CALL ACRANEB_SOLVS_OPENACC (YDML_PHY_MF%YRPHY, YDML_PHY_MF%YRPHY%LRNUMX, KLON, KTDIA, KLEV,&
& KLON, KIDIA, KFDIA, IAUCR, PALB, PALBDIR, PCLCT, ZFRSODIRT, ZFRSODIRS_C, ZFRSODIRS_CUN, PNEB&
&, ZB1, ZB2, ZB3, ZB4, ZA1C, ZA1CUN, ZA2C, ZA3C, ZA4C, ZA5C, ZA1N, ZA1NUN, ZA2N, ZA3N, ZA4N&
&, ZA5N, PFRSO, PFRSODIFS, PFRSODIRS, ZFRSODIRS_UN, ZFRSODIRS_TRUE, YDSTACK=YLSTACK)


IF (ZFRSODIRS_C (JLON)>YDERDI%RSUNDUR*PMU0 (JLON)) THEN
  PSDUR (JLON)=PSDUR (JLON)+(1._JPRB-PCLCT (JLON))*ZTSTEP
ENDIF


IF (ZFRSODIRS_UN (JLON)-(1._JPRB-PCLCT (JLON))*ZFRSODIRS_CUN&
  & (JLON)>YDERDI%RSUNDUR*PMU0 (JLON)*PCLCT (JLON)) THEN
  PSDUR (JLON)=PSDUR (JLON)+PCLCT (JLON)*ZTSTEP
ENDIF



IF (YDML_PHY_MF%YRPHY%LRAYLU) THEN
  
  PFRSOLU (JLON)=1._JPRB/(MAX (ZEPSAL, 1._JPRB-PALB (JLON)))*PFRSO (JLON&
  &, KLEV)*0.5_JPRB*(1._JPRB+SIGN (1._JPRB, 0._JPRB-PMU0 (JLON)))
  
ELSE
  
  PFRSOLU (JLON)=0._JPRB
  
ENDIF



END SUBROUTINE ACRANEB2_OPENACC
