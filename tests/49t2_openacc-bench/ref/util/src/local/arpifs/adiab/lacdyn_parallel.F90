SUBROUTINE LACDYN_PARALLEL (YDCST, YDGEOMETRY, YDVARS, YDCPG_SL1, YDCPG_SL2, YDCPG_BNDS, YDCPG_OPTS&
&, YDCPG_TND, YDCPG_DYN0, YDCPG_DYN9, YDMODEL, YDCPG_SLMISC, YDCPG_TNDSI_DDH, YDA_PWRL9)
USE TYPE_MODEL,ONLY:MODEL
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE CPG_TYPE_MOD,ONLY:CPG_DYN_TYPE, CPG_TND_TYPE
USE CPG_SL1_TYPE_MOD,ONLY:CPG_SL1B_TYPE
USE CPG_SL2_TYPE_MOD,ONLY:CPG_SL2_TYPE

USE YOMHOOK,ONLY:DR_HOOK, JPHOOK, LHOOK
USE FIELD_VARIABLES_MOD,ONLY:FIELD_VARIABLES
USE YOMCST,ONLY:TCST
USE CPG_DDH_TND_TYPE_MOD,ONLY:CPG_TNDSI_DDH_TYPE
USE CPG_SLMISC_TYPE_MOD,ONLY:CPG_SLMISC_TYPE
USE FIELD_ARRAY_MODULE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_ARRAY_COPY_MOD
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (FIELD_VARIABLES), INTENT (INOUT)::YDVARS
TYPE (CPG_SL1B_TYPE), INTENT (INOUT)::YDCPG_SL1
TYPE (CPG_SL2_TYPE), INTENT (INOUT)::YDCPG_SL2
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
TYPE (CPG_TND_TYPE), INTENT (INOUT)::YDCPG_TND
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN0
TYPE (CPG_DYN_TYPE), INTENT (INOUT)::YDCPG_DYN9
TYPE (MODEL), INTENT (IN)::YDMODEL
TYPE (CPG_SLMISC_TYPE), INTENT (INOUT)::YDCPG_SLMISC
TYPE (CPG_TNDSI_DDH_TYPE), INTENT (INOUT)::YDCPG_TNDSI_DDH
TYPE (FIELD_3RB_ARRAY), INTENT (INOUT)::YDA_PWRL9
REAL (KIND=JPRB)::ZDTS2
REAL (KIND=JPRB)::ZBT
CLASS (FIELD_2RB), POINTER :: YL_ZREDIV
REAL (KIND=JPRB), POINTER::ZREDIV (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZBDT
REAL (KIND=JPRB), POINTER::ZBDT (:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZGAGT0M
REAL (KIND=JPRB), POINTER::ZGAGT0M (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZGAGT0L
REAL (KIND=JPRB), POINTER::ZGAGT0L (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZGAGT9M
REAL (KIND=JPRB), POINTER::ZGAGT9M (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZGAGT9L
REAL (KIND=JPRB), POINTER::ZGAGT9L (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZLPD9
REAL (KIND=JPRB), POINTER::ZLPD9 (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZLPD0
REAL (KIND=JPRB), POINTER::ZLPD0 (:,:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZSDIV9
REAL (KIND=JPRB), POINTER::ZSDIV9 (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZSDIV0
REAL (KIND=JPRB), POINTER::ZSDIV0 (:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZSPDS9
REAL (KIND=JPRB), POINTER::ZSPDS9 (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZSPDS0
REAL (KIND=JPRB), POINTER::ZSPDS0 (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZTOD9
REAL (KIND=JPRB), POINTER::ZTOD9 (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZTOD0
REAL (KIND=JPRB), POINTER::ZTOD0 (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZMIXNL
REAL (KIND=JPRB), POINTER::ZMIXNL (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZALPHA
REAL (KIND=JPRB), POINTER::ZALPHA (:,:,:)
LOGICAL::LLGWADV
LOGICAL::LL2TLFF1
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "lassie_parallel.intfb.h"
#include "abor1.intfb.h"
#include "lasure.intfb.h"
#include "lasure_openacc.intfb.h"
#include "lattes_parallel.intfb.h"
#include "lattex_parallel.intfb.h"
#include "lavabo_parallel.intfb.h"
#include "lavent_parallel.intfb.h"
INTEGER (KIND=JPIM) :: JLON
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
REAL(KIND=JPRB), POINTER :: Z_YDVARS_GEOMETRY_GMAPPA_T0(:,:)
REAL(KIND=JPRB), POINTER :: Z_YDVARS_GEOMETRY_GM_T0(:,:)
IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL', 0, ZHOOK_HANDLE)

CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "BEGIN")


IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
CALL FIELD_NEW (YL_ZTOD9, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZTOD0, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZSPDS9, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZSPDS0, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZSDIV9, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZSDIV0, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZREDIV, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZMIXNL, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZLPD9, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZLPD0, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMNH, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZGAGT9M, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZGAGT9L, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZGAGT0M, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZGAGT0L, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZBDT, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZALPHA, UBOUNDS=[YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG&
&, YDCPG_OPTS%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)



ZDTS2=0.5_JPRB*YDCPG_OPTS%ZDT
ZBT=ZDTS2*YDCPG_OPTS%ZBETADT
LL2TLFF1=YDMODEL%YRML_DYN%YRDYN%L2TLFF.AND.(YDMODEL%YRML_PHY_MF%YRPHY%LMPHYS.OR.YDMODEL&
&%YRML_PHY_EC%YREPHY%LEPHYS).AND.(.NOT.YDMODEL%YRML_PHY_EC%YREPHY%LAGPHY)
IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','LACDYN_PARALLEL:LASURE')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ZBDT => GET_HOST_DATA_RDWR (YL_ZBDT)
  ZREDIV => GET_HOST_DATA_RDWR (YL_ZREDIV)
  Z_YDVARS_GEOMETRY_GMAPPA_T0 => GET_HOST_DATA_RDONLY (YDVARS%GEOMETRY%GMAPPA%FT0)
  Z_YDVARS_GEOMETRY_GM_T0 => GET_HOST_DATA_RDONLY (YDVARS%GEOMETRY%GM%FT0)
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)
    
    CALL LASURE (YDGEOMETRY, YDMODEL%YRML_PHY_EC%YREPHY, YDMODEL%YRML_DYN%YRDYN, YDMODEL%YRML_DYN&
    &%YREDYN, YDMODEL%YRML_PHY_MF%YRPHY, YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA, Z_YDVARS_GEOMETRY_GMAPPA_T0&
    &(:, JBLK), Z_YDVARS_GEOMETRY_GM_T0(:, JBLK), ZBT, ZBDT(:, JBLK), ZREDIV(:, JBLK))
  ENDDO

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('LACDYN_PARALLEL:LASURE')) THEN
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    ZBDT => GET_HOST_DATA_RDWR (YL_ZBDT)
    ZREDIV => GET_HOST_DATA_RDWR (YL_ZREDIV)
    Z_YDVARS_GEOMETRY_GMAPPA_T0 => GET_HOST_DATA_RDWR (YDVARS%GEOMETRY%GMAPPA%FT0)
    Z_YDVARS_GEOMETRY_GM_T0 => GET_HOST_DATA_RDWR (YDVARS%GEOMETRY%GM%FT0)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ZBDT => NULL ()
  ZREDIV => NULL ()
  Z_YDVARS_GEOMETRY_GMAPPA_T0 => NULL ()
  Z_YDVARS_GEOMETRY_GM_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','LACDYN_PARALLEL:LASURE')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ZBDT => GET_HOST_DATA_RDWR (YL_ZBDT)
  ZREDIV => GET_HOST_DATA_RDWR (YL_ZREDIV)
  Z_YDVARS_GEOMETRY_GMAPPA_T0 => GET_HOST_DATA_RDONLY (YDVARS%GEOMETRY%GMAPPA%FT0)
  Z_YDVARS_GEOMETRY_GM_T0 => GET_HOST_DATA_RDONLY (YDVARS%GEOMETRY%GM%FT0)
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  !$OMP PARALLEL DO PRIVATE (JBLK, JLON, YLCPG_BNDS, YLSTACK)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

    

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      
      CALL LASURE_OPENACC (YDGEOMETRY, YDMODEL%YRML_PHY_EC%YREPHY, YDMODEL%YRML_DYN%YRDYN, YDMODEL%YRML_DYN&
      &%YREDYN, YDMODEL%YRML_PHY_MF%YRPHY, YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA, Z_YDVARS_GEOMETRY_GMAPPA_T0(&
      &:, JBLK), Z_YDVARS_GEOMETRY_GM_T0(:, JBLK), ZBT, ZBDT(:, JBLK), ZREDIV(:, JBLK),YDSTACK=YLSTACK)
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('LACDYN_PARALLEL:LASURE')) THEN
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    ZBDT => GET_HOST_DATA_RDWR (YL_ZBDT)
    ZREDIV => GET_HOST_DATA_RDWR (YL_ZREDIV)
    Z_YDVARS_GEOMETRY_GMAPPA_T0 => GET_HOST_DATA_RDWR (YDVARS%GEOMETRY%GMAPPA%FT0)
    Z_YDVARS_GEOMETRY_GM_T0 => GET_HOST_DATA_RDWR (YDVARS%GEOMETRY%GM%FT0)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ZBDT => NULL ()
  ZREDIV => NULL ()
  Z_YDVARS_GEOMETRY_GMAPPA_T0 => NULL ()
  Z_YDVARS_GEOMETRY_GM_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','LACDYN_PARALLEL:LASURE')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ZBDT => GET_DEVICE_DATA_RDWR (YL_ZBDT)
  ZREDIV => GET_DEVICE_DATA_RDWR (YL_ZREDIV)
  Z_YDVARS_GEOMETRY_GMAPPA_T0 => GET_DEVICE_DATA_RDONLY (YDVARS%GEOMETRY%GMAPPA%FT0)
  Z_YDVARS_GEOMETRY_GM_T0 => GET_DEVICE_DATA_RDONLY (YDVARS%GEOMETRY%GM%FT0)
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (YDCPG_OPTS, YDGEOMETRY, YDMODEL, YFXTRAN_ACDC_STACK, ZBDT, ZREDIV, &
    !$ACC&         Z_YDVARS_GEOMETRY_GMAPPA_T0, Z_YDVARS_GEOMETRY_GM_T0) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLON, YLCPG_BNDS, YLSTACK) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      YLSTACK%L8 = fxtran_acdc_stack_l8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      YLSTACK%U8 = fxtran_acdc_stack_u8 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      YLSTACK%L4 = fxtran_acdc_stack_l4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      YLSTACK%U4 = fxtran_acdc_stack_u4 (YFXTRAN_ACDC_STACK, (JBLK-YDCPG_OPTS%JBLKMIN)+1, YDCPG_OPTS%KGPBLKS)
      
      CALL LASURE_OPENACC (YDGEOMETRY, YDMODEL%YRML_PHY_EC%YREPHY, YDMODEL%YRML_DYN%YRDYN, YDMODEL%YRML_DYN&
      &%YREDYN, YDMODEL%YRML_PHY_MF%YRPHY, YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA, Z_YDVARS_GEOMETRY_GMAPPA_T0(&
      &:, JBLK), Z_YDVARS_GEOMETRY_GM_T0(:, JBLK), ZBT, ZBDT(:, JBLK), ZREDIV(:, JBLK),YDSTACK=YLSTACK)
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

  IF (FXTRAN_ACDC_LSYNCHOST ('LACDYN_PARALLEL:LASURE')) THEN
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
    ZBDT => GET_HOST_DATA_RDWR (YL_ZBDT)
    ZREDIV => GET_HOST_DATA_RDWR (YL_ZREDIV)
    Z_YDVARS_GEOMETRY_GMAPPA_T0 => GET_HOST_DATA_RDWR (YDVARS%GEOMETRY%GMAPPA%FT0)
    Z_YDVARS_GEOMETRY_GM_T0 => GET_HOST_DATA_RDWR (YDVARS%GEOMETRY%GM%FT0)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ZBDT => NULL ()
  ZREDIV => NULL ()
  Z_YDVARS_GEOMETRY_GMAPPA_T0 => NULL ()
  Z_YDVARS_GEOMETRY_GM_T0 => NULL ()
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('LACDYN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:LASURE',1,ZHOOK_HANDLE_PARALLEL)

IF (YDMODEL%YRML_DYN%YRDYNA%LNHEE.OR.YDMODEL%YRML_DYN%YRDYNA%LNHHY) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ELSEIF (YDMODEL%YRML_DYN%YRDYNA%LNHQE) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ELSE
  CALL LASSIE_PARALLEL (YDMODEL%YRCST, YDGEOMETRY, YDVARS, YDCPG_BNDS, YDCPG_OPTS, YDMODEL&
  &%YRML_DYN%YRDYN, YDMODEL%YRML_DYN%YRDYNA, YDVARS%GEOMETRY%RCORI%FT0, YL_ZSDIV0, YL_ZSDIV9&
  &, YL_ZTOD0, YL_ZTOD9, YL_ZGAGT0L, YL_ZGAGT0M, YL_ZGAGT9L, YL_ZGAGT9M)
ENDIF


IF ((YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0).OR.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0.AND&
  &.YDMODEL%YRML_DYN%YRDYNA%LPC_FULL.AND.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP))) THEN
  CALL LAVENT_PARALLEL (YDCST, YDGEOMETRY, YDCPG_OPTS, YDCPG_BNDS, YDVARS, YDCPG_TND, YDCPG_SL1, YDCPG_SL2&
  &, YDMODEL%YRML_GCONF%YRRIP, YDMODEL%YRML_DYN, YDMODEL%YRML_PHY_MF%YRPARAR, YDCPG_SLMISC%F_ISETTLOFF&
  &, LL2TLFF1, ZDTS2, YDCPG_DYN0%XYB%F_RDELP, YDCPG_DYN0%CTY%F_EVEL, YDA_PWRL9%F_P, YL_ZALPHA)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LMIXETTLS) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ELSE
  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL',0,ZHOOK_HANDLE_PARALLEL)

  IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','LACDYN_PARALLEL:ZMIXNL')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    ZMIXNL => GET_HOST_DATA_RDWR (YL_ZMIXNL)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
    !$OMP PARALLEL DO PRIVATE (JBLK) FIRSTPRIVATE (YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      CALL YLCPG_BNDS%UPDATE (JBLK)
      
      ZMIXNL (:,:, JBLK)=1.0_JPRB
    ENDDO

    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('LACDYN_PARALLEL:ZMIXNL')) THEN
      IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      ZMIXNL => GET_HOST_DATA_RDWR (YL_ZMIXNL)
      IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    ZMIXNL => NULL ()
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMPSINGLECOLUMN','LACDYN_PARALLEL:ZMIXNL')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    ZMIXNL => GET_HOST_DATA_RDWR (YL_ZMIXNL)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    !$OMP PARALLEL DO PRIVATE (JBLK, JLON, YLCPG_BNDS)

    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX

      

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON
        
        ZMIXNL (JLON,:, JBLK)=1.0_JPRB
      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('LACDYN_PARALLEL:ZMIXNL')) THEN
      IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      ZMIXNL => GET_HOST_DATA_RDWR (YL_ZMIXNL)
      IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    ZMIXNL => NULL ()
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','LACDYN_PARALLEL:ZMIXNL')) THEN
    
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
    ZMIXNL => GET_DEVICE_DATA_RDWR (YL_ZMIXNL)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
    
    
      !$ACC PARALLEL LOOP GANG &
      !$ACC&PRESENT (YDCPG_OPTS, YFXTRAN_ACDC_STACK, ZMIXNL) &
      !$ACC&PRIVATE (JBLK) &
      !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
      
      DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
      
      
      
      !$ACC LOOP VECTOR &
      !$ACC&PRIVATE (JLON, YLCPG_BNDS) 

      

      DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
        YLCPG_BNDS%KIDIA = JLON
        YLCPG_BNDS%KFDIA = JLON
        
        ZMIXNL (JLON,:, JBLK)=1.0_JPRB
      ENDDO

    ENDDO

    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)

    IF (FXTRAN_ACDC_LSYNCHOST ('LACDYN_PARALLEL:ZMIXNL')) THEN
      IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:SYNCHOST',0,ZHOOK_HANDLE_FIELD_API)
      ZMIXNL => GET_HOST_DATA_RDWR (YL_ZMIXNL)
      IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:SYNCHOST',1,ZHOOK_HANDLE_FIELD_API)
      
      
    ENDIF

    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
    ZMIXNL => NULL ()
    IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
    
    
  ELSE
      CALL ABOR1 ('LACDYN_PARALLEL: NOT METHOD WAS FOUND')
  ENDIF

  IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL:ZMIXNL',1,ZHOOK_HANDLE_PARALLEL)
ENDIF

CALL LATTEX_PARALLEL (YDMODEL%YRCST, YDGEOMETRY, YDVARS, YDCPG_TND, YDCPG_SL1, YDCPG_SL2, YDCPG_BNDS&
&, YDCPG_OPTS, YDMODEL%YRML_DIAG%YRLDDH, YDMODEL%YRML_DIAG%YRMDDH, YDMODEL%YRML_GCONF, YDMODEL&
&%YRML_DYN, ZDTS2, ZBT, YL_ZBDT, YDMODEL%YRML_DYN%YRDYN%RESGP, YDMODEL%YRML_DYN%YRDYN%RESGM&
&, YDCPG_DYN0%F_OROGL, YDCPG_DYN0%F_OROGM, YDCPG_DYN0%F_PHIF, YL_ZGAGT0L, YL_ZGAGT0M, YL_ZTOD0&
&, YL_ZSPDS0, YL_ZLPD0, YL_ZGAGT9L, YL_ZGAGT9M, YL_ZTOD9, YL_ZSPDS9, YL_ZLPD9, YDCPG_DYN0%XYB&
&%F_RDELP, YDCPG_DYN0%CTY%F_EVEL, YDCPG_DYN0%F_NHX, YDCPG_DYN0%F_GWT, YDCPG_DYN0%F_GWFT, YDCPG_DYN9&
&%F_NHX, YDCPG_DYN9%F_GWT, YL_ZMIXNL, YDCPG_TNDSI_DDH)

IF (YDMODEL%YRML_DYN%YRDYNA%LNHDYN.AND.YDMODEL%YRML_DYN%YRDYNA&
  &%LRDBBC.AND.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LGWADV)) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF

CALL LATTES_PARALLEL (YDCST, YDGEOMETRY, YDCPG_BNDS, YDCPG_OPTS, YDVARS, YDCPG_SL1, YDCPG_SL2&
&, YDMODEL%YRML_GCONF%YRRIP, YDMODEL%YRML_DYN, ZDTS2, YL_ZBDT, YDMODEL%YRML_DYN%YRDYN&
&%RESGP, YDMODEL%YRML_DYN%YRDYN%RESGM, YDCPG_DYN0%F_OROGL, YDCPG_DYN0%F_OROGM, YL_ZSDIV0&
&, YL_ZSDIV9, YDCPG_DYN0%CTY%F_PSDVBC, YDCPG_DYN0%F_PRE, YL_ZMIXNL)

IF (YDMODEL%YRML_DYN%YRDYNA%LSLHD) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LCOMAD) THEN
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF


IF ((YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER==0).OR.(YDMODEL%YRML_DYN%YRDYN%NCURRENT_ITER>0.AND&
  &.YDMODEL%YRML_DYN%YRDYNA%LPC_FULL.AND.(.NOT.YDMODEL%YRML_DYN%YRDYNA%LPC_CHEAP))) THEN
  CALL LAVABO_PARALLEL (YDGEOMETRY, YDMODEL, YDCPG_BNDS, YDCPG_OPTS, YDCPG_SL1, LL2TLFF1)
ENDIF


IF (YDMODEL%YRML_DYN%YRDYNA%LGWADV) THEN
  
  
  
  
  CALL ABOR1 ("ERROR: WRONG SETTINGS")
  
ENDIF





CALL FXTRAN_ACDC_GPUMEMSTAT (__FILE__, __LINE__, "END")

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (ASSOCIATED (YL_ZALPHA)) CALL FIELD_DELETE (YL_ZALPHA)
IF (ASSOCIATED (YL_ZBDT)) CALL FIELD_DELETE (YL_ZBDT)
IF (ASSOCIATED (YL_ZGAGT0L)) CALL FIELD_DELETE (YL_ZGAGT0L)
IF (ASSOCIATED (YL_ZGAGT0M)) CALL FIELD_DELETE (YL_ZGAGT0M)
IF (ASSOCIATED (YL_ZGAGT9L)) CALL FIELD_DELETE (YL_ZGAGT9L)
IF (ASSOCIATED (YL_ZGAGT9M)) CALL FIELD_DELETE (YL_ZGAGT9M)
IF (ASSOCIATED (YL_ZLPD0)) CALL FIELD_DELETE (YL_ZLPD0)
IF (ASSOCIATED (YL_ZLPD9)) CALL FIELD_DELETE (YL_ZLPD9)
IF (ASSOCIATED (YL_ZMIXNL)) CALL FIELD_DELETE (YL_ZMIXNL)
IF (ASSOCIATED (YL_ZREDIV)) CALL FIELD_DELETE (YL_ZREDIV)
IF (ASSOCIATED (YL_ZSDIV0)) CALL FIELD_DELETE (YL_ZSDIV0)
IF (ASSOCIATED (YL_ZSDIV9)) CALL FIELD_DELETE (YL_ZSDIV9)
IF (ASSOCIATED (YL_ZSPDS0)) CALL FIELD_DELETE (YL_ZSPDS0)
IF (ASSOCIATED (YL_ZSPDS9)) CALL FIELD_DELETE (YL_ZSPDS9)
IF (ASSOCIATED (YL_ZTOD0)) CALL FIELD_DELETE (YL_ZTOD0)
IF (ASSOCIATED (YL_ZTOD9)) CALL FIELD_DELETE (YL_ZTOD9)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('LACDYN_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE LACDYN_PARALLEL
