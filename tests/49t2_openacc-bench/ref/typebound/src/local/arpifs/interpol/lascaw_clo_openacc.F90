SUBROUTINE LASCAW_CLO_OPENACC (YDDYNA, KFLEV, KPROMA, KST, KEND, LDT, PSLHDKMIN&
&, PDLO, PDLOMAD, PKAPPA, PCLO, PCLOMAD, PCLOSLD, YDSTACK)
!$ACC ROUTINE (LASCAW_CLO_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMDYNA,ONLY:TDYNA
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
LOGICAL, INTENT (IN)::LDT (4)
REAL (KIND=JPRB), INTENT (IN)::PSLHDKMIN
REAL (KIND=JPRB), INTENT (IN)::PDLO (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDLOMAD (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PKAPPA (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCLO (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (OUT)::PCLOMAD (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (OUT)::PCLOSLD (KPROMA, KFLEV, 3)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
#include "lascaw_clo.func.h"
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JROF
REAL (KIND=JPRB)::ZWL3
REAL (KIND=JPRB)::ZWL2
REAL (KIND=JPRB)::ZWL1
REAL (KIND=JPRB)::ZWDS3
REAL (KIND=JPRB)::ZWDS2
REAL (KIND=JPRB)::ZWDS1
REAL (KIND=JPRB)::ZWD3
REAL (KIND=JPRB)::ZWD2
REAL (KIND=JPRB)::ZWD1
REAL (KIND=JPRB)::ZWH3
REAL (KIND=JPRB)::ZWH2
REAL (KIND=JPRB)::ZWH1
REAL (KIND=JPRB)::ZKAP
REAL (KIND=JPRB)::ZSLHDKMIN
REAL (KIND=JPRB)::ZSIGN
REAL (KIND=JPRB)::Z1M2EPSH
LOGICAL::LLSLHD_OLD
LOGICAL::LLSLHDQUAD
LOGICAL::LLSLHD


JROF = KST


LLSLHD=LDT (1)
LLSLHDQUAD=LDT (2)
LLSLHD_OLD=LDT (3)

IF (LLSLHDQUAD.OR.LLSLHD) THEN
  Z1M2EPSH=1.0_JPRB-2.0_JPRB*YDDYNA%SLHDEPSH

  DO JLEV=1, KFLEV
    
    PD12=F12 (PDLO (JROF, JLEV))
    ZWH1=FLAG1 (PDLO (JROF, JLEV), PD12)
    ZWH2=FLAG2 (PDLO (JROF, JLEV), PD12)
    ZWH3=FLAG3 (PDLO (JROF, JLEV))

    IF (LLSLHD) THEN

      IF (LLSLHDQUAD) THEN
        ZWL1=FQUAD1 (PDLO (JROF, JLEV))-ZWH1
        ZWL2=FQUAD2 (PDLO (JROF, JLEV))-ZWH2
        ZWL3=FQUAD3 (PDLO (JROF, JLEV))-ZWH3
      ELSE
        ZWL1=1.0_JPRB-PDLO (JROF, JLEV)-ZWH1
        ZWL2=PDLO (JROF, JLEV)-ZWH2
        ZWL3=-ZWH3
      ENDIF

      ZWD1=ZWH1+YDDYNA%SLHDKMAX*ZWL1
      ZWD2=ZWH2+YDDYNA%SLHDKMAX*ZWL2
      ZWD3=ZWH3+YDDYNA%SLHDKMAX*ZWL3
      ZWDS1=Z1M2EPSH*ZWD1+YDDYNA%SLHDEPSH*ZWD2
      ZWDS2=YDDYNA%SLHDEPSH*ZWD1+Z1M2EPSH*ZWD2
      ZWDS3=YDDYNA%SLHDEPSH*ZWD2+ZWD3

      IF (PKAPPA (JROF, JLEV)<0._JPRB) THEN
        ZSLHDKMIN=YDDYNA%SLHDKREF
        ZKAP=-PKAPPA (JROF, JLEV)
      ELSE
        ZSLHDKMIN=PSLHDKMIN
        ZKAP=PKAPPA (JROF, JLEV)
      ENDIF

      ZWH1=ZWH1+ZSLHDKMIN*ZWL1
      ZWH2=ZWH2+ZSLHDKMIN*ZWL2
      ZWH3=ZWH3+ZSLHDKMIN*ZWL3
      PCLO (JROF, JLEV, 1)=ZWH1
      PCLO (JROF, JLEV, 2)=ZWH2
      PCLO (JROF, JLEV, 3)=ZWH3
      PCLOSLD (JROF, JLEV, 1)=ZWH1+ZKAP*(ZWDS1-ZWH1)
      PCLOSLD (JROF, JLEV, 2)=ZWH2+ZKAP*(ZWDS2-ZWH2)
      PCLOSLD (JROF, JLEV, 3)=ZWH3+ZKAP*(ZWDS3-ZWH3)
    ELSE
      ZWL1=FQUAD1 (PDLO (JROF, JLEV))
      ZWL2=FQUAD2 (PDLO (JROF, JLEV))
      ZWL3=FQUAD3 (PDLO (JROF, JLEV))
      ZWH1=ZWH1+PSLHDKMIN*(ZWL1-ZWH1)
      ZWH2=ZWH2+PSLHDKMIN*(ZWL2-ZWH2)
      ZWH3=ZWH3+PSLHDKMIN*(ZWL3-ZWH3)
      PCLO (JROF, JLEV, 1)=ZWH1
      PCLO (JROF, JLEV, 2)=ZWH2
      PCLO (JROF, JLEV, 3)=ZWH3
      PCLOSLD (JROF, JLEV, 1)=ZWH1
      PCLOSLD (JROF, JLEV, 2)=ZWH2
      PCLOSLD (JROF, JLEV, 3)=ZWH3
    ENDIF

  
  ENDDO

ELSE

  DO JLEV=1, KFLEV
    
    PD12=F12 (PDLO (JROF, JLEV))
    ZWH1=FLAG1 (PDLO (JROF, JLEV), PD12)
    ZWH2=FLAG2 (PDLO (JROF, JLEV), PD12)
    ZWH3=FLAG3 (PDLO (JROF, JLEV))
    PCLO (JROF, JLEV, 1)=ZWH1
    PCLO (JROF, JLEV, 2)=ZWH2
    PCLO (JROF, JLEV, 3)=ZWH3
    PCLOSLD (JROF, JLEV, 1)=ZWH1
    PCLOSLD (JROF, JLEV, 2)=ZWH2
    PCLOSLD (JROF, JLEV, 3)=ZWH3
  
  ENDDO

ENDIF


DO JLEV=1, KFLEV
  
  PD12=F12 (PDLOMAD (JROF, JLEV))
  PCLOMAD (JROF, JLEV, 1)=FLAG1 (PDLOMAD (JROF, JLEV), PD12)
  PCLOMAD (JROF, JLEV, 2)=FLAG2 (PDLOMAD (JROF, JLEV), PD12)
  PCLOMAD (JROF, JLEV, 3)=FLAG3 (PDLOMAD (JROF, JLEV))
  
ENDDO


END SUBROUTINE LASCAW_CLO_OPENACC
