SUBROUTINE CUBASEN_PARALLEL (PPLDARE, PPLRG, YDTHF, YDCST, YDEPHLI, YDECLDP, YDECUMF&
&, YDSPP_CONFIG, YDCPG_OPTS, YDCPG_BNDS, KLON, KLEV, KINDEX, LDMIXS, LDTDKMF, YD_PTENH&
&, YD_PQENH, YD_PGEOH, YD_PAPH, YD_PQHFL, YD_PAHFS, YD_PGP2DSPP, YD_PKMFL, YD_PTEN&
&, YD_PQEN, YD_PQSEN, YD_PGEO, YD_PTU, YD_PQU, YD_PLU, YD_PWU2H, YD_PWUBASE, YD_KLAB&
&, YD_LDCUM, YD_LDSC, YD_KCBOT, YD_KBOTSC, YD_KCTOP, YD_KDPL, YD_PCAPE)
USE YOEPHLI,ONLY:TEPHLI

USE YOMHOOK,ONLY:LHOOK, DR_HOOK, JPHOOK
USE YOMCST,ONLY:TCST
USE PARPHY,ONLY:RKAP
USE YOECUMF,ONLY:TECUMF
USE YOECLDP,ONLY:TECLDP
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE SPP_GEN_MOD,ONLY:SPP_PERT
USE CPG_OPTS_TYPE_MOD, ONLY : CPG_OPTS_TYPE, CPG_BNDS_TYPE
USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_ACCESS_MODULE
USE FXTRAN_ACDC_PARALLELMETHOD_MOD
USE FXTRAN_ACDC_STACK_MOD
USE PARKIND1
USE FXTRAN_ACDC_GPUMEM_MOD
#include "fxtran_acdc_stack.h"

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TECLDP), INTENT (IN)::YDECLDP
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
TYPE (CPG_OPTS_TYPE), INTENT (IN) :: YDCPG_OPTS
TYPE (CPG_BNDS_TYPE), INTENT (IN) :: YDCPG_BNDS
INTEGER (KIND=JPIM), INTENT (IN)::KINDEX
LOGICAL, INTENT (IN)::LDMIXS
LOGICAL, INTENT (IN)::LDTDKMF
CLASS (FIELD_3RB), POINTER :: YD_PTENH
REAL (KIND=JPRB), POINTER::PTENH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQENH
REAL (KIND=JPRB), POINTER::PQENH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PGEOH
REAL (KIND=JPRB), POINTER::PGEOH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PAPH
REAL (KIND=JPRB), POINTER::PAPH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQHFL
REAL (KIND=JPRB), POINTER::PQHFL (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PAHFS
REAL (KIND=JPRB), POINTER::PAHFS (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PGP2DSPP
REAL (KIND=JPRB), POINTER::PGP2DSPP (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PKMFL
REAL (KIND=JPRB), POINTER::PKMFL (:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTEN
REAL (KIND=JPRB), POINTER::PTEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQEN
REAL (KIND=JPRB), POINTER::PQEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQSEN
REAL (KIND=JPRB), POINTER::PQSEN (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PGEO
REAL (KIND=JPRB), POINTER::PGEO (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PTU
REAL (KIND=JPRB), POINTER::PTU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PQU
REAL (KIND=JPRB), POINTER::PQU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PLU
REAL (KIND=JPRB), POINTER::PLU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YD_PWU2H
REAL (KIND=JPRB), POINTER::PWU2H (:,:,:)
CLASS (FIELD_2RB), POINTER :: YD_PWUBASE
REAL (KIND=JPRB), POINTER::PWUBASE (:,:)
CLASS (FIELD_3IM), POINTER :: YD_KLAB
INTEGER (KIND=JPIM), POINTER::KLAB (:,:,:)
CLASS (FIELD_2LM), POINTER :: YD_LDCUM
LOGICAL, POINTER::LDCUM (:,:)
CLASS (FIELD_2LM), POINTER :: YD_LDSC
LOGICAL, POINTER::LDSC (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KCBOT
INTEGER (KIND=JPIM), POINTER::KCBOT (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KBOTSC
INTEGER (KIND=JPIM), POINTER::KBOTSC (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KCTOP
INTEGER (KIND=JPIM), POINTER::KCTOP (:,:)
CLASS (FIELD_2IM), POINTER :: YD_KDPL
INTEGER (KIND=JPIM), POINTER::KDPL (:,:)
CLASS (FIELD_2RB), POINTER :: YD_PCAPE
REAL (KIND=JPRB), POINTER::PCAPE (:,:)
CLASS (FIELD_2IM), POINTER :: YL_IDPL
INTEGER (KIND=JPIM), POINTER::IDPL (:,:)
CLASS (FIELD_3IM), POINTER :: YL_ILAB
INTEGER (KIND=JPIM), POINTER::ILAB (:,:,:)
CLASS (FIELD_2IM), POINTER :: YL_IBOTSC
INTEGER (KIND=JPIM), POINTER::IBOTSC (:,:)
CLASS (FIELD_2IM), POINTER :: YL_ICBOT
INTEGER (KIND=JPIM), POINTER::ICBOT (:,:)
CLASS (FIELD_2IM), POINTER :: YL_ICTOP
INTEGER (KIND=JPIM), POINTER::ICTOP (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLFIRST
LOGICAL, POINTER::LLFIRST (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLDSC
LOGICAL, POINTER::LLDSC (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLDCUM
LOGICAL, POINTER::LLDCUM (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLDEEP
LOGICAL, POINTER::LLDEEP (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLGO_ON
LOGICAL, POINTER::LLGO_ON (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LL_LDBASE
LOGICAL, POINTER::LL_LDBASE (:,:)
CLASS (FIELD_2LM), POINTER :: YL_LLRESETJL
LOGICAL, POINTER::LLRESETJL (:,:)
LOGICAL::LLRESET
LOGICAL::LLPERT_ENTSTPC1
LOGICAL::LLPERT_ENTRORG
INTEGER (KIND=JPIM)::JKB
INTEGER (KIND=JPIM)::JKT
INTEGER (KIND=JPIM)::JKT2
INTEGER (KIND=JPIM)::JKT1
INTEGER (KIND=JPIM)::JKK
INTEGER (KIND=JPIM) :: JLON
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IS
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IPENTSTPC1
INTEGER (KIND=JPIM)::IPENTRORG
CLASS (FIELD_3RB), POINTER :: YL_ZWU2H
REAL (KIND=JPRB), POINTER::ZWU2H (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZBUOH
REAL (KIND=JPRB), POINTER::ZBUOH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZSUH
REAL (KIND=JPRB), POINTER::ZSUH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZQENH
REAL (KIND=JPRB), POINTER::ZQENH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZSENH
REAL (KIND=JPRB), POINTER::ZSENH (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZS
REAL (KIND=JPRB), POINTER::ZS (:,:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZPH
REAL (KIND=JPRB), POINTER::ZPH (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZQOLD
REAL (KIND=JPRB), POINTER::ZQOLD (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZMIX
REAL (KIND=JPRB), POINTER::ZMIX (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZCBASE
REAL (KIND=JPRB), POINTER::ZCBASE (:,:)
CLASS (FIELD_2RB), POINTER :: YL_ZDZ
REAL (KIND=JPRB), POINTER::ZDZ (:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZTU
REAL (KIND=JPRB), POINTER::ZTU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZQU
REAL (KIND=JPRB), POINTER::ZQU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZLU
REAL (KIND=JPRB), POINTER::ZLU (:,:,:)
CLASS (FIELD_3RB), POINTER :: YL_ZCAPE
REAL (KIND=JPRB), POINTER::ZCAPE (:,:,:)
REAL (KIND=JPRB)::ZBUOF
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZKHVFL
REAL (KIND=JPRB)::ZWS
REAL (KIND=JPRB)::ZUST
REAL (KIND=JPRB)::ZQEXC
CLASS (FIELD_2RB), POINTER :: YL_ZQEX
REAL (KIND=JPRB), POINTER::ZQEX (:,:)
REAL (KIND=JPRB)::ZTEXC
CLASS (FIELD_2RB), POINTER :: YL_ZTEX
REAL (KIND=JPRB), POINTER::ZTEX (:,:)
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZTVENH
REAL (KIND=JPRB)::ZTVUH
REAL (KIND=JPRB)::ZLGLAC
REAL (KIND=JPRB)::ZBW
REAL (KIND=JPRB)::ZAW
REAL (KIND=JPRB)::ZQF
REAL (KIND=JPRB)::ZSF
REAL (KIND=JPRB)::ZPDIFFBOT
REAL (KIND=JPRB)::ZPDIFFTOP
REAL (KIND=JPRB)::ZDP
REAL (KIND=JPRB)::ZDTDP
REAL (KIND=JPRB)::ZDQSDT
REAL (KIND=JPRB)::ZESDP
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZFACI
REAL (KIND=JPRB)::ZFACW
REAL (KIND=JPRB)::ZALFAW
REAL (KIND=JPRB)::ZDQ
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZQSU
REAL (KIND=JPRB)::ZWORK2
REAL (KIND=JPRB)::ZWORK1
REAL (KIND=JPRB)::ZTMP
REAL (KIND=JPRB)::ZRG
REAL (KIND=JPRB)::ZRCPD
REAL (KIND=JPRB)::ZXENTSTPC1
REAL (KIND=JPRB)::ZXENTRORG
INTEGER (KIND=JPIM)::IPN
TYPE (SPP_PERT)::PN2
TYPE (SPP_PERT)::PN1
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
#include "fcttre.func.h"
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR_CUADJTQ
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
CLASS (FIELD_2LM), POINTER :: YL_LLFLAG
LOGICAL, POINTER::LLFLAG (:,:)
#include "abor1.intfb.h"
#include "cuadjtq.func.h"
INTEGER(KIND=JPIM) :: JBLK
TYPE(CPG_BNDS_TYPE) :: YLCPG_BNDS
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_FIELD_API
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_PARALLEL
REAL(KIND=JPHOOK) :: ZHOOK_HANDLE_COMPUTE
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLOFFSET
IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL', 0, ZHOOK_HANDLE)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
CALL FIELD_NEW (YL_ZWU2H, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZTU, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZTEX, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZSUH, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZSENH, UBOUNDS=[YDCPG_OPTS%KLON, KLEV+1, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZS, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZQU, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZQOLD, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZQEX, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZQENH, UBOUNDS=[YDCPG_OPTS%KLON, KLEV+1, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZPH, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZMIX, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZLU, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZDZ, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZCBASE, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZCAPE, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ZBUOH, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LL_LDBASE, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLRESETJL, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS&
&%JBLKMAX], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLGO_ON, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLFLAG, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLFIRST, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLDSC, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLDEEP, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_LLDCUM, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ILAB, UBOUNDS=[YDCPG_OPTS%KLON, KLEV, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, 1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_IDPL, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ICTOP, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_ICBOT, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
CALL FIELD_NEW (YL_IBOTSC, UBOUNDS=[YDCPG_OPTS%KLON, YDCPG_OPTS%JBLKMAX&
&], LBOUNDS=[1, YDCPG_OPTS%JBLKMIN], PERSISTENT=.TRUE.)
IF (LHOOK) CALL DR_HOOK ('CREATE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)

ZAW=1.0_JPRB
ZBW=1.0_JPRB
IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUBASEN_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KDPL => GET_HOST_DATA_RDWR (YD_KDPL)
  LLFIRST => GET_HOST_DATA_RDWR (YL_LLFIRST)
  LLGO_ON => GET_HOST_DATA_RDWR (YL_LLGO_ON)
  PWUBASE => GET_HOST_DATA_RDWR (YD_PWUBASE)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JLON) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
      PWUBASE (JLON, JBLK)=0.0_JPRB
      LLGO_ON (JLON, JBLK)=.TRUE.
      LLFIRST (JLON, JBLK)=.TRUE.
      KDPL (JLON, JBLK)=KLEV
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KDPL => NULL ()
  LLFIRST => NULL ()
  LLGO_ON => NULL ()
  PWUBASE => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUBASEN_PARALLEL:0')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  KDPL => GET_DEVICE_DATA_RDWR (YD_KDPL)
  LLFIRST => GET_DEVICE_DATA_RDWR (YL_LLFIRST)
  LLGO_ON => GET_DEVICE_DATA_RDWR (YL_LLGO_ON)
  PWUBASE => GET_DEVICE_DATA_RDWR (YD_PWUBASE)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (KDPL, LLFIRST, LLGO_ON, PWUBASE, YFXTRAN_ACDC_STACK) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      
      
      PWUBASE (JLON, JBLK)=0.0_JPRB
      LLGO_ON (JLON, JBLK)=.TRUE.
      LLFIRST (JLON, JBLK)=.TRUE.
      KDPL (JLON, JBLK)=KLEV
    
    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  KDPL => NULL ()
  LLFIRST => NULL ()
  LLGO_ON => NULL ()
  PWUBASE => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUBASEN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:0',1,ZHOOK_HANDLE_PARALLEL)
JKT1=KINDEX
JKT2=YDECUMF%NJKT2
ZRG=1.0_JPRB/YDCST%RG
ZRCPD=1.0_JPRB/YDCST%RCPD
IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUBASEN_PARALLEL:1')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ILAB => GET_HOST_DATA_RDWR (YL_ILAB)
  KLAB => GET_HOST_DATA_RDONLY (YD_KLAB)
  PGEO => GET_HOST_DATA_RDONLY (YD_PGEO)
  PGEOH => GET_HOST_DATA_RDONLY (YD_PGEOH)
  PLU => GET_HOST_DATA_RDONLY (YD_PLU)
  PQENH => GET_HOST_DATA_RDONLY (YD_PQENH)
  PQU => GET_HOST_DATA_RDONLY (YD_PQU)
  PTEN => GET_HOST_DATA_RDONLY (YD_PTEN)
  PTENH => GET_HOST_DATA_RDONLY (YD_PTENH)
  PTU => GET_HOST_DATA_RDONLY (YD_PTU)
  PWU2H => GET_HOST_DATA_RDWR (YD_PWU2H)
  ZCAPE => GET_HOST_DATA_RDWR (YL_ZCAPE)
  ZLU => GET_HOST_DATA_RDWR (YL_ZLU)
  ZQENH => GET_HOST_DATA_RDWR (YL_ZQENH)
  ZQU => GET_HOST_DATA_RDWR (YL_ZQU)
  ZS => GET_HOST_DATA_RDWR (YL_ZS)
  ZSENH => GET_HOST_DATA_RDWR (YL_ZSENH)
  ZTU => GET_HOST_DATA_RDWR (YL_ZTU)
  ZWU2H => GET_HOST_DATA_RDWR (YL_ZWU2H)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JK, JLON, LLPERT_ENTRORG, LLPERT_ENTSTPC1) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JK=1, KLEV

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        ZTU (JLON, JK, JBLK)=PTU (JLON, JK, JBLK)
        ZQU (JLON, JK, JBLK)=PQU (JLON, JK, JBLK)
        ZLU (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)
        ILAB (JLON, JK, JBLK)=KLAB (JLON, JK, JBLK)
        ZCAPE (JLON, JK, JBLK)=0.0_JPRB
      ENDDO

    ENDDO

    
    LLPERT_ENTSTPC1=.FALSE.
    LLPERT_ENTRORG=.FALSE.

    

    DO JK=1, KLEV

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        PWU2H (JLON, JK, JBLK)=0.0_JPRB
        ZWU2H (JLON, JK, JBLK)=0.0_JPRB
        ZS (JLON, JK, JBLK)=YDCST%RCPD*PTEN (JLON, JK, JBLK)+PGEO (JLON, JK, JBLK)
        ZQENH (JLON, JK, JBLK)=PQENH (JLON, JK, JBLK)
        ZSENH (JLON, JK, JBLK)=YDCST%RCPD*PTENH (JLON, JK, JBLK)+PGEOH (JLON, JK, JBLK)
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ILAB => NULL ()
  KLAB => NULL ()
  PGEO => NULL ()
  PGEOH => NULL ()
  PLU => NULL ()
  PQENH => NULL ()
  PQU => NULL ()
  PTEN => NULL ()
  PTENH => NULL ()
  PTU => NULL ()
  PWU2H => NULL ()
  ZCAPE => NULL ()
  ZLU => NULL ()
  ZQENH => NULL ()
  ZQU => NULL ()
  ZS => NULL ()
  ZSENH => NULL ()
  ZTU => NULL ()
  ZWU2H => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUBASEN_PARALLEL:1')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  ILAB => GET_DEVICE_DATA_RDWR (YL_ILAB)
  KLAB => GET_DEVICE_DATA_RDONLY (YD_KLAB)
  PGEO => GET_DEVICE_DATA_RDONLY (YD_PGEO)
  PGEOH => GET_DEVICE_DATA_RDONLY (YD_PGEOH)
  PLU => GET_DEVICE_DATA_RDONLY (YD_PLU)
  PQENH => GET_DEVICE_DATA_RDONLY (YD_PQENH)
  PQU => GET_DEVICE_DATA_RDONLY (YD_PQU)
  PTEN => GET_DEVICE_DATA_RDONLY (YD_PTEN)
  PTENH => GET_DEVICE_DATA_RDONLY (YD_PTENH)
  PTU => GET_DEVICE_DATA_RDONLY (YD_PTU)
  PWU2H => GET_DEVICE_DATA_RDWR (YD_PWU2H)
  ZCAPE => GET_DEVICE_DATA_RDWR (YL_ZCAPE)
  ZLU => GET_DEVICE_DATA_RDWR (YL_ZLU)
  ZQENH => GET_DEVICE_DATA_RDWR (YL_ZQENH)
  ZQU => GET_DEVICE_DATA_RDWR (YL_ZQU)
  ZS => GET_DEVICE_DATA_RDWR (YL_ZS)
  ZSENH => GET_DEVICE_DATA_RDWR (YL_ZSENH)
  ZTU => GET_DEVICE_DATA_RDWR (YL_ZTU)
  ZWU2H => GET_DEVICE_DATA_RDWR (YL_ZWU2H)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (ILAB, KLAB, PGEO, PGEOH, PLU, PQENH, PQU, PTEN, PTENH, PTU, PWU2H, YFXTRAN_ACDC_STACK, &
    !$ACC&         ZCAPE, ZLU, ZQENH, ZQU, ZS, ZSENH, ZTU, ZWU2H) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JK, JLON, LLPERT_ENTRORG, LLPERT_ENTSTPC1, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      DO JK=1, KLEV
        
        ZTU (JLON, JK, JBLK)=PTU (JLON, JK, JBLK)
        ZQU (JLON, JK, JBLK)=PQU (JLON, JK, JBLK)
        ZLU (JLON, JK, JBLK)=PLU (JLON, JK, JBLK)
        ILAB (JLON, JK, JBLK)=KLAB (JLON, JK, JBLK)
        ZCAPE (JLON, JK, JBLK)=0.0_JPRB
      
      ENDDO

      
      LLPERT_ENTSTPC1=.FALSE.
      LLPERT_ENTRORG=.FALSE.

      

      DO JK=1, KLEV
        
        PWU2H (JLON, JK, JBLK)=0.0_JPRB
        ZWU2H (JLON, JK, JBLK)=0.0_JPRB
        ZS (JLON, JK, JBLK)=YDCST%RCPD*PTEN (JLON, JK, JBLK)+PGEO (JLON, JK, JBLK)
        ZQENH (JLON, JK, JBLK)=PQENH (JLON, JK, JBLK)
        ZSENH (JLON, JK, JBLK)=YDCST%RCPD*PTENH (JLON, JK, JBLK)+PGEOH (JLON, JK, JBLK)
      
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  ILAB => NULL ()
  KLAB => NULL ()
  PGEO => NULL ()
  PGEOH => NULL ()
  PLU => NULL ()
  PQENH => NULL ()
  PQU => NULL ()
  PTEN => NULL ()
  PTENH => NULL ()
  PTU => NULL ()
  PWU2H => NULL ()
  ZCAPE => NULL ()
  ZLU => NULL ()
  ZQENH => NULL ()
  ZQU => NULL ()
  ZS => NULL ()
  ZSENH => NULL ()
  ZTU => NULL ()
  ZWU2H => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUBASEN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:1',1,ZHOOK_HANDLE_PARALLEL)
IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUBASEN_PARALLEL:2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  IBOTSC => GET_HOST_DATA_RDWR (YL_IBOTSC)
  ICBOT => GET_HOST_DATA_RDWR (YL_ICBOT)
  ICTOP => GET_HOST_DATA_RDWR (YL_ICTOP)
  IDPL => GET_HOST_DATA_RDWR (YL_IDPL)
  ILAB => GET_HOST_DATA_RDWR (YL_ILAB)
  KBOTSC => GET_HOST_DATA_RDWR (YD_KBOTSC)
  KCBOT => GET_HOST_DATA_RDWR (YD_KCBOT)
  KCTOP => GET_HOST_DATA_RDWR (YD_KCTOP)
  KDPL => GET_HOST_DATA_RDWR (YD_KDPL)
  KLAB => GET_HOST_DATA_RDWR (YD_KLAB)
  LDCUM => GET_HOST_DATA_RDWR (YD_LDCUM)
  LDSC => GET_HOST_DATA_RDWR (YD_LDSC)
  LLDCUM => GET_HOST_DATA_RDWR (YL_LLDCUM)
  LLDEEP => GET_HOST_DATA_RDWR (YL_LLDEEP)
  LLDSC => GET_HOST_DATA_RDWR (YL_LLDSC)
  LLFIRST => GET_HOST_DATA_RDWR (YL_LLFIRST)
  LLFLAG => GET_HOST_DATA_RDWR (YL_LLFLAG)
  LLGO_ON => GET_HOST_DATA_RDWR (YL_LLGO_ON)
  LLRESETJL => GET_HOST_DATA_RDWR (YL_LLRESETJL)
  LL_LDBASE => GET_HOST_DATA_RDWR (YL_LL_LDBASE)
  PAHFS => GET_HOST_DATA_RDONLY (YD_PAHFS)
  PAPH => GET_HOST_DATA_RDONLY (YD_PAPH)
  PGEO => GET_HOST_DATA_RDONLY (YD_PGEO)
  PGEOH => GET_HOST_DATA_RDONLY (YD_PGEOH)
  PKMFL => GET_HOST_DATA_RDONLY (YD_PKMFL)
  PLU => GET_HOST_DATA_RDWR (YD_PLU)
  PQEN => GET_HOST_DATA_RDONLY (YD_PQEN)
  PQENH => GET_HOST_DATA_RDONLY (YD_PQENH)
  PQHFL => GET_HOST_DATA_RDONLY (YD_PQHFL)
  PQSEN => GET_HOST_DATA_RDONLY (YD_PQSEN)
  PQU => GET_HOST_DATA_RDWR (YD_PQU)
  PTEN => GET_HOST_DATA_RDONLY (YD_PTEN)
  PTENH => GET_HOST_DATA_RDONLY (YD_PTENH)
  PTU => GET_HOST_DATA_RDWR (YD_PTU)
  PWU2H => GET_HOST_DATA_RDWR (YD_PWU2H)
  PWUBASE => GET_HOST_DATA_RDWR (YD_PWUBASE)
  ZBUOH => GET_HOST_DATA_RDWR (YL_ZBUOH)
  ZCAPE => GET_HOST_DATA_RDWR (YL_ZCAPE)
  ZCBASE => GET_HOST_DATA_RDWR (YL_ZCBASE)
  ZDZ => GET_HOST_DATA_RDWR (YL_ZDZ)
  ZLU => GET_HOST_DATA_RDWR (YL_ZLU)
  ZMIX => GET_HOST_DATA_RDWR (YL_ZMIX)
  ZPH => GET_HOST_DATA_RDWR (YL_ZPH)
  ZQENH => GET_HOST_DATA_RDONLY (YL_ZQENH)
  ZQEX => GET_HOST_DATA_RDWR (YL_ZQEX)
  ZQOLD => GET_HOST_DATA_RDWR (YL_ZQOLD)
  ZQU => GET_HOST_DATA_RDWR (YL_ZQU)
  ZSENH => GET_HOST_DATA_RDONLY (YL_ZSENH)
  ZSUH => GET_HOST_DATA_RDWR (YL_ZSUH)
  ZTEX => GET_HOST_DATA_RDWR (YL_ZTEX)
  ZTU => GET_HOST_DATA_RDWR (YL_ZTU)
  ZWU2H => GET_HOST_DATA_RDWR (YL_ZWU2H)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (IK, IS, JBLK, JK, JKB, JKK, JKT, JLON, LLRESET, Z1S, Z2S, ZALFAW, ZBUOF, ZCOND, ZCOND1, ZCOR, ZCOR_CUADJTQ, ZDP, ZDQ, ZDQSDT, ZDTDP, ZEPS, ZESDP, ZF, ZFAC, ZFACI, ZFACW, ZFOEEWI, ZFOEEWL, ZI, ZKHVFL, ZL, ZLGLAC, ZOEALFA, ZPDIFFBOT, ZPDIFFTOP, ZQEXC, ZQF, ZQMAX, ZQP, ZQSAT, ZQSU, ZRHO, ZSF, ZTARG, ZTEXC, ZTMP, ZTVENH, ZTVUH, ZUST, ZWORK1, ZWORK2, ZWS, ZXENTRORG, ZXENTSTPC1) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)

    

    DO JKK=KLEV, JKT1,-1
      IS=0

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

        IF (LLGO_ON (JLON, JBLK)) THEN
          IS=IS+1
          IDPL (JLON, JBLK)=JKK
          ICBOT (JLON, JBLK)=JKK
          IBOTSC (JLON, JBLK)=KLEV-1
          ICTOP (JLON, JBLK)=KLEV-1
          LLDCUM (JLON, JBLK)=.FALSE.
          LLDSC (JLON, JBLK)=.FALSE.
          LL_LDBASE (JLON, JBLK)=.FALSE.
        ENDIF

      ENDDO


      IF (IS/=0) THEN

        IF (JKK==KLEV) THEN
          ZTEXC=0.2_JPRB
          ZQEXC=1.E-4_JPRB

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLGO_ON (JLON, JBLK)) THEN
              ZRHO=PAPH (JLON, JKK+1, JBLK)/(YDCST%RD*(PTEN (JLON, JKK,&
              & JBLK)*(1.0_JPRB+YDCST%RETV*PQEN (JLON, JKK, JBLK))))
              ZKHVFL=(PAHFS (JLON, JKK+1, JBLK)*ZRCPD+YDCST%RETV*PTEN (JLON,&
              & JKK, JBLK)*PQHFL (JLON, JKK+1, JBLK))/(ZRHO*PPLRG*PPLDARE)
              ZUST=MAX (SQRT (PKMFL (JLON, JBLK)), 0.1_JPRB)
              ZWS=ZUST**3._JPRB-1.5_JPRB*RKAP*ZKHVFL*(PGEOH (JLON, KLEV, JBLK&
              &)-PGEOH (JLON, KLEV+1, JBLK))/PTEN (JLON, KLEV, JBLK)
              ZTEX (JLON, JBLK)=0.0_JPRB
              ZQEX (JLON, JBLK)=0.0_JPRB

              IF (ZKHVFL<0.0_JPRB) THEN
                ZWS=1.2_JPRB*ZWS**.3333_JPRB
                ILAB (JLON, JKK, JBLK)=1
                ZTEX (JLON, JBLK)=MAX (-1.5_JPRB*PAHFS (JLON, JKK+1, JBLK&
                &)/(ZRHO*ZWS*YDCST%RCPD*PPLRG*PPLDARE), ZTEXC)
                ZQEX (JLON, JBLK)=MAX (-1.5_JPRB*PQHFL (JLON, JKK+1, JBLK)/(ZRHO*ZWS*PPLRG*PPLDARE), ZQEXC)
                ZQU (JLON, JKK, JBLK)=ZQENH (JLON, JKK, JBLK)+ZQEX (JLON, JBLK)
                ZSUH (JLON, JKK, JBLK)=ZSENH (JLON, JKK, JBLK)+YDCST%RCPD*ZTEX (JLON, JBLK)
                ZTU (JLON, JKK, JBLK)=(ZSENH (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD+ZTEX (JLON, JBLK)
                ZLU (JLON, JKK, JBLK)=0.0_JPRB
                ZWU2H (JLON, JKK, JBLK)=ZWS**2+0.1_JPRB
                PWU2H (JLON, JKK, JBLK)=ZWU2H (JLON, JKK, JBLK)
                ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JLON, JKK, JBLK))*(ZSENH&
                & (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD
                ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JLON, JKK, JBLK))*ZTU (JLON, JKK, JBLK)
                ZBUOH (JLON, JKK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
              ELSE
                LLGO_ON (JLON, JBLK)=.FALSE.
              ENDIF

            ENDIF

          ENDDO

        ELSE

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLGO_ON (JLON, JBLK)) THEN
              ZRHO=PAPH (JLON, JKK+1, JBLK)/(YDCST%RD*(PTEN (JLON, JKK&
              &, JBLK)*(1.+YDCST%RETV*PQEN (JLON, JKK, JBLK))))
              ILAB (JLON, JKK, JBLK)=1
              ZTEXC=0.2_JPRB
              ZQEXC=1.E-4_JPRB

              IF (JKK==KLEV-1) THEN
                ZTEXC=MAX (ZTEXC, ZTEX (JLON, JBLK))
                ZQEXC=MAX (ZQEXC, ZQEX (JLON, JBLK))

                IF (LDTDKMF) THEN
                  ZTEXC=MIN (ZTEXC, 3.0_JPRB)
                  ZQEXC=MIN (ZQEXC, 2.E-3_JPRB)
                ELSE
                  ZTEXC=MIN (ZTEXC, 1.0_JPRB)
                  ZQEXC=MIN (ZQEXC, 5.E-4_JPRB)
                ENDIF

              ENDIF

              ZQU (JLON, JKK, JBLK)=ZQENH (JLON, JKK, JBLK)+ZQEXC
              ZSUH (JLON, JKK, JBLK)=ZSENH (JLON, JKK, JBLK)+YDCST%RCPD*ZTEXC
              ZTU (JLON, JKK, JBLK)=(ZSENH (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD+ZTEXC
              ZLU (JLON, JKK, JBLK)=0.0_JPRB

              IF (PAPH (JLON, KLEV+1, JBLK)-PAPH (JLON, JKK-1, JBLK)<60.E2_JPRB) THEN
                ZQU (JLON, JKK, JBLK)=0.0_JPRB
                ZSUH (JLON, JKK, JBLK)=0.0_JPRB
                ZWORK1=0.0_JPRB

                DO JK=JKK+1, JKK-1,-1

                  IF (ZWORK1<50.E2_JPRB) THEN
                    ZWORK2=PAPH (JLON, JK, JBLK)-PAPH (JLON, JK-1, JBLK)
                    ZWORK1=ZWORK1+ZWORK2
                    ZQU (JLON, JKK, JBLK)=ZQU (JLON, JKK, JBLK)+ZQENH (JLON, JK, JBLK)*ZWORK2
                    ZSUH (JLON, JKK, JBLK)=ZSUH (JLON, JKK, JBLK)+ZSENH (JLON, JK, JBLK)*ZWORK2
                  ENDIF

                ENDDO

                ZQU (JLON, JKK, JBLK)=ZQU (JLON, JKK, JBLK)/ZWORK1+ZQEXC
                ZSUH (JLON, JKK, JBLK)=ZSUH (JLON, JKK, JBLK)/ZWORK1+YDCST%RCPD*ZTEXC
                ZTU (JLON, JKK, JBLK)=(ZSUH (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD+ZTEXC
              ENDIF

              ZWU2H (JLON, JKK, JBLK)=1.0_JPRB
              ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JLON, JKK, JBLK))*(ZSENH&
              & (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD
              ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JLON, JKK, JBLK))*ZTU (JLON, JKK, JBLK)
              ZBUOH (JLON, JKK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
            ENDIF

          ENDDO

        ENDIF

      ENDIF


      DO JK=JKK-1, JKT2,-1
        IS=0

        IF (JKK==KLEV.OR.KINDEX==KLEV-1) THEN

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
            
            ZXENTSTPC1=YDECUMF%ENTSTPC1

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              IS=IS+1
              ZDZ (JLON, JBLK)=(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZRG

              IF (LDTDKMF) THEN
                ZEPS=ZXENTSTPC1/((PGEOH (JLON, JK, JBLK)-PGEOH (JLON, KLEV+1, JBLK))*ZRG*PPLRG)+YDECUMF%ENTSTPC2
              ELSE
                ZEPS=ZXENTSTPC1/((PGEO (JLON, JK, JBLK)-PGEOH (JLON, KLEV+1, JBLK))*ZRG*PPLRG)+YDECUMF%ENTSTPC2

                IF (LDMIXS.AND.KINDEX==KLEV.AND.ZLU (JLON, JK+1, JBLK)>0.0_JPRB)  THEN
                  ZEPS=ZEPS*YDECUMF%ENTSTPC3
                ENDIF

              ENDIF

              ZMIX (JLON, JBLK)=0.5_JPRB*ZDZ (JLON, JBLK)*PPLRG*ZEPS

              IF (.NOT.LDTDKMF)  THEN
                ZMIX (JLON, JBLK)=MIN (1.0_JPRB, ZMIX (JLON, JBLK))
              ENDIF

              ZQF=(PQENH (JLON, JK+1, JBLK)+PQENH (JLON, JK, JBLK))*0.5_JPRB
              ZSF=(ZSENH (JLON, JK+1, JBLK)+ZSENH (JLON, JK, JBLK))*0.5_JPRB
              ZTMP=1.0_JPRB/(1.0_JPRB+ZMIX (JLON, JBLK))
              ZQU (JLON, JK, JBLK)=(ZQU (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX&
              & (JLON, JBLK))+2.0_JPRB*ZMIX (JLON, JBLK)*ZQF)*ZTMP
              ZSUH (JLON, JK, JBLK)=(ZSUH (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX&
              & (JLON, JBLK))+2.0_JPRB*ZMIX (JLON, JBLK)*ZSF)*ZTMP
              ZQOLD (JLON, JBLK)=ZQU (JLON, JK, JBLK)
              ZTU (JLON, JK, JBLK)=(ZSUH (JLON, JK, JBLK)-PGEOH (JLON, JK, JBLK))*ZRCPD
              ZPH (JLON, JBLK)=PAPH (JLON, JK, JBLK)
            ENDIF

          ENDDO

        ELSE
          ZXENTRORG=YDECUMF%ENTRORG

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLGO_ON (JLON, JBLK)) THEN
              
              ZDZ (JLON, JBLK)=(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZRG
              ZMIX (JLON, JBLK)=YDECUMF%ENTRTEST*ZXENTRORG*ZDZ (JLON, JBLK)*MIN &
              &(1.0_JPRB,(PQSEN (JLON, JK, JBLK)/PQSEN (JLON, KLEV, JBLK))**3)
            ENDIF

          ENDDO


          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLGO_ON (JLON, JBLK)) THEN
              IS=IS+1
              ZMIX (JLON, JBLK)=MIN (1.0_JPRB, ZMIX (JLON, JBLK))
              ZQF=(PQENH (JLON, JK+1, JBLK)+PQENH (JLON, JK, JBLK))*0.5_JPRB
              ZSF=(ZSENH (JLON, JK+1, JBLK)+ZSENH (JLON, JK, JBLK))*0.5_JPRB
              ZQU (JLON, JK, JBLK)=ZQU (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX (JLON, JBLK))+ZQF*ZMIX (JLON, JBLK)
              ZSUH (JLON, JK, JBLK)=ZSUH (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX (JLON, JBLK))+ZSF*ZMIX (JLON, JBLK)
              ZQOLD (JLON, JBLK)=ZQU (JLON, JK, JBLK)
              ZTU (JLON, JK, JBLK)=(ZSUH (JLON, JK, JBLK)-PGEOH (JLON, JK, JBLK))*ZRCPD
              ZPH (JLON, JBLK)=PAPH (JLON, JK, JBLK)
            ENDIF

          ENDDO

        ENDIF


        IF (IS==0)  THEN
          EXIT
        ENDIF

        IK=JK
        
        
        ZQMAX=0.5_JPRB

        IF (.NOT.YDEPHLI%LPHYLIN) THEN
          
          LLFLAG (:, JBLK)=LLGO_ON (:, JBLK)

          

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLFLAG (JLON, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JLON, JBLK)
              ZL=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(ZTU&
              & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (ZTU (JLON, IK, JBLK&
              &)))*EXP (YDTHF%R3IES*(ZTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=MIN (0.5_JPRB, ZQSAT)
              ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (ZTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (ZTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND=(ZQU (JLON, IK, JBLK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)
              ZCOND=MAX (ZCOND, 0.0_JPRB)
              ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+FOELDCPMCU (ZTU (JLON, IK, JBLK))*ZCOND
              ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND
              ZL=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(ZTU&
              & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (ZTU (JLON, IK, JBLK&
              &)))*EXP (YDTHF%R3IES*(ZTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
              ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (ZTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (ZTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND1=(ZQU (JLON, IK, JBLK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)

              IF (ZCOND==0.0_JPRB)  THEN
                ZCOND1=0.0_JPRB
              ENDIF

              ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+FOELDCPMCU (ZTU (JLON, IK, JBLK))*ZCOND1
              ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND1
            ENDIF

          ENDDO

        
        
        
        
        
        
        
        ELSE

          

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

            IF (LLGO_ON (JLON, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JLON, JBLK)
              ZTARG=ZTU (JLON, IK, JBLK)
              ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
              ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
              ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
              ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
              Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
              ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
              ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
              ZQSAT=ZQSAT*ZCOR_CUADJTQ
              Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
              &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
              ZCOND=(ZQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
              ZCOND=MAX (ZCOND, 0.0_JPRB)

              IF (ZCOND/=0.0_JPRB) THEN
                ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+(ZOEALFA*YDTHF&
                &%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
                ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND
                ZTARG=ZTU (JLON, IK, JBLK)
                ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
                Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                ZQSAT=ZQSAT*ZCOR_CUADJTQ
                Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                ZCOND1=(ZQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
                ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+(ZOEALFA*YDTHF&
                &%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
                ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            ENDIF

          ENDDO

        
        
        
        
        ENDIF


        

        

        

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LLGO_ON (JLON, JBLK)) THEN
            ZDQ=MAX (ZQOLD (JLON, JBLK)-ZQU (JLON, JK, JBLK), 0.0_JPRB)
            ZLU (JLON, JK, JBLK)=ZLU (JLON, JK+1, JBLK)+ZDQ
            ZLGLAC=ZDQ*((1.0_JPRB-FOEALFCU (ZTU (JLON, JK, JBLK)))-(1.0_JPRB-FOEALFCU (ZTU (JLON, JK+1, JBLK))))
            ZLU (JLON, JK, JBLK)=0.5_JPRB*ZLU (JLON, JK, JBLK)
            ZTU (JLON, JK, JBLK)=ZTU (JLON, JK, JBLK)+YDTHF%RALFDCP*ZLGLAC
            ZSUH (JLON, JK, JBLK)=YDCST%RCPD*ZTU (JLON, JK, JBLK)+PGEOH (JLON, JK, JBLK)
            ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JLON, JK, JBLK)-ZLU (JLON&
            &, JK, JBLK))*ZTU (JLON, JK, JBLK)+YDTHF%RALFDCP*ZLGLAC
            ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JLON, JK, JBLK))*(ZSENH&
            & (JLON, JK, JBLK)-PGEOH (JLON, JK, JBLK))*ZRCPD
            ZBUOH (JLON, JK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
            ZBUOF=(ZBUOH (JLON, JK, JBLK)+ZBUOH (JLON, JK+1, JBLK))*0.5_JPRB
            ZTMP=1.0_JPRB/(1.0_JPRB+2.0_JPRB*ZBW*ZMIX (JLON, JBLK))
            ZWU2H (JLON, JK, JBLK)=(ZWU2H (JLON, JK+1, JBLK)*(1.0_JPRB-2.0_JPRB*ZBW&
            &*ZMIX (JLON, JBLK))+2.0_JPRB*ZAW*ZBUOF*ZDZ (JLON, JBLK))*ZTMP

            IF (JKK==KLEV) THEN
              PWU2H (JLON, JK, JBLK)=ZWU2H (JLON, JK, JBLK)
            ENDIF

            ZCAPE (JLON, JKK, JBLK)=ZCAPE (JLON, JKK, JBLK)+MAX (0.0_JPRB, ZBUOF*ZDZ (JLON, JBLK))

            IF (ZLU (JLON, JK, JBLK)>0.0_JPRB.AND.ILAB (JLON, JK+1, JBLK)==1) THEN
              IK=JK+1
              ZQSU=FOEEWM (ZTU (JLON, IK, JBLK))/PAPH (JLON, IK, JBLK)
              ZESDP=ZQSU
              ZQSU=MIN (0.5_JPRB, ZQSU)
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSU)
              ZQSU=ZQSU*ZCOR
              ZDQ=MIN (0._JPRB, ZQU (JLON, IK, JBLK)-ZQSU)
              ZALFAW=FOEALFA (ZTU (JLON, IK, JBLK))
              ZFACW=YDTHF%R5LES/((ZTU (JLON, IK, JBLK)-YDTHF%R4LES)**2)
              ZFACI=YDTHF%R5IES/((ZTU (JLON, IK, JBLK)-YDTHF%R4IES)**2)
              ZFAC=ZALFAW*ZFACW+(1.-ZALFAW)*ZFACI
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZESDP)
              ZDQSDT=ZFAC*ZCOR*ZQSU
              ZDTDP=YDCST%RD*ZTU (JLON, IK, JBLK)/(YDCST%RCPD*PAPH (JLON, IK, JBLK))
              ZDP=ZDQ/(ZDQSDT*ZDTDP)
              ZCBASE (JLON, JBLK)=PAPH (JLON, IK, JBLK)+ZDP
              ZPDIFFTOP=ZCBASE (JLON, JBLK)-PAPH (JLON, JK, JBLK)
              ZPDIFFBOT=PAPH (JLON, JK+1, JBLK)-ZCBASE (JLON, JBLK)

              IF (ZPDIFFTOP>ZPDIFFBOT.AND.ZWU2H (JLON, JK+1, JBLK)>0.0_JPRB) THEN
                JKB=MIN (KLEV-1, JK+1)
                ILAB (JLON, JKB, JBLK)=2
                ILAB (JLON, JK, JBLK)=2
                LL_LDBASE (JLON, JBLK)=.TRUE.
                LLDSC (JLON, JBLK)=.TRUE.
                IBOTSC (JLON, JBLK)=JKB
                ICBOT (JLON, JBLK)=JKB
                ZLU (JLON, JK+1, JBLK)=YDECLDP%RLMIN
              ELSEIF (ZPDIFFTOP<=ZPDIFFBOT.AND.ZWU2H (JLON, JK, JBLK)>0.0_JPRB) THEN
                ILAB (JLON, JK, JBLK)=2
                LL_LDBASE (JLON, JBLK)=.TRUE.
                LLDSC (JLON, JBLK)=.TRUE.
                IBOTSC (JLON, JBLK)=JK
                ICBOT (JLON, JBLK)=JK
              ENDIF

            ENDIF


            IF (ZWU2H (JLON, JK, JBLK)<0.0_JPRB) THEN
              LLGO_ON (JLON, JBLK)=.FALSE.

              IF (ZLU (JLON, JK+1, JBLK)>0.0_JPRB) THEN
                ICTOP (JLON, JBLK)=JK
                LLDCUM (JLON, JBLK)=.TRUE.
              ELSE
                LLDCUM (JLON, JBLK)=.FALSE.
              ENDIF

            ELSE

              IF (ZLU (JLON, JK, JBLK)>0.0_JPRB) THEN
                ILAB (JLON, JK, JBLK)=2
              ELSE
                ILAB (JLON, JK, JBLK)=1
              ENDIF

            ENDIF

          ENDIF

        ENDDO

      ENDDO


      IF (JKK==KLEV.OR.(JKK==KLEV-1.AND.KINDEX==KLEV-1)) THEN

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
          LDSC (JLON, JBLK)=LLDSC (JLON, JBLK)

          IF (LDSC (JLON, JBLK)) THEN
            KBOTSC (JLON, JBLK)=IBOTSC (JLON, JBLK)
          ELSE
            KBOTSC (JLON, JBLK)=-1
          ENDIF

          JKT=ICTOP (JLON, JBLK)
          JKB=ICBOT (JLON, JBLK)
          LLDEEP (JLON, JBLK)=PAPH (JLON, JKB, JBLK)-PAPH (JLON, JKT, JBLK)>YDECUMF%RDEPTHS

          IF (LLDEEP (JLON, JBLK).AND.KINDEX<KLEV-1)  THEN
            LLDCUM (JLON, JBLK)=.FALSE.
          ENDIF

          LLDEEP (JLON, JBLK)=.FALSE.
          LLGO_ON (JLON, JBLK)=.NOT.LLDEEP (JLON, JBLK)

          IF (KINDEX==KLEV-1)  THEN
            LLGO_ON (JLON, JBLK)=.NOT.LLDCUM (JLON, JBLK)
          ENDIF


          IF (LLDCUM (JLON, JBLK)) THEN
            KCBOT (JLON, JBLK)=ICBOT (JLON, JBLK)
            KCTOP (JLON, JBLK)=ICTOP (JLON, JBLK)
            KDPL (JLON, JBLK)=IDPL (JLON, JBLK)
            LDCUM (JLON, JBLK)=LLDCUM (JLON, JBLK)
            PWUBASE (JLON, JBLK)=SQRT (MAX (ZWU2H (JLON, JKB, JBLK), 0.0_JPRB))
          ELSE
            KCTOP (JLON, JBLK)=-1
            KCBOT (JLON, JBLK)=-1
            KDPL (JLON, JBLK)=KLEV-1
            LDCUM (JLON, JBLK)=.FALSE.
            PWUBASE (JLON, JBLK)=0.0_JPRB
          ENDIF

        ENDDO


        DO JK=KLEV, 1,-1

          DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
            JKT=ICTOP (JLON, JBLK)

            IF (JK>=JKT.OR.(KINDEX>=KLEV-1.AND.JKK==KLEV)) THEN
              KLAB (JLON, JK, JBLK)=ILAB (JLON, JK, JBLK)
              PTU (JLON, JK, JBLK)=ZTU (JLON, JK, JBLK)
              PQU (JLON, JK, JBLK)=ZQU (JLON, JK, JBLK)
              PLU (JLON, JK, JBLK)=ZLU (JLON, JK, JBLK)
            ENDIF

          ENDDO

        ENDDO

      ENDIF


      IF (JKK<KLEV) THEN
        LLRESET=.FALSE.

        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (.NOT.LLDEEP (JLON, JBLK)) THEN
            JKT=ICTOP (JLON, JBLK)
            JKB=ICBOT (JLON, JBLK)
            LLDEEP (JLON, JBLK)=PAPH (JLON, JKB, JBLK)-PAPH (JLON, JKT, JBLK)>=YDECUMF%RDEPTHS
          ENDIF

          LLRESETJL (JLON, JBLK)=LLDEEP (JLON, JBLK).AND.LLFIRST (JLON, JBLK)
          LLRESET=LLRESET.OR.LLRESETJL (JLON, JBLK)
        ENDDO


        IF (LLRESET) THEN

          DO JK=KLEV, 1,-1

            DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

              IF (LLRESETJL (JLON, JBLK)) THEN
                JKT=ICTOP (JLON, JBLK)
                JKB=IDPL (JLON, JBLK)

                IF (JK<=JKB.AND.JK>=JKT) THEN
                  KLAB (JLON, JK, JBLK)=ILAB (JLON, JK, JBLK)
                  PTU (JLON, JK, JBLK)=ZTU (JLON, JK, JBLK)
                  PQU (JLON, JK, JBLK)=ZQU (JLON, JK, JBLK)
                  PLU (JLON, JK, JBLK)=ZLU (JLON, JK, JBLK)
                ELSE
                  KLAB (JLON, JK, JBLK)=1
                  PTU (JLON, JK, JBLK)=PTENH (JLON, JK, JBLK)
                  PQU (JLON, JK, JBLK)=PQENH (JLON, JK, JBLK)
                  PLU (JLON, JK, JBLK)=0.0_JPRB
                ENDIF


                IF (JK<JKT)  THEN
                  KLAB (JLON, JK, JBLK)=0
                ENDIF

              ENDIF

            ENDDO

          ENDDO

        ENDIF


        DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA

          IF (LLDEEP (JLON, JBLK).AND.LLFIRST (JLON, JBLK)) THEN
            KDPL (JLON, JBLK)=IDPL (JLON, JBLK)
            KCTOP (JLON, JBLK)=ICTOP (JLON, JBLK)
            KCBOT (JLON, JBLK)=ICBOT (JLON, JBLK)
            LDCUM (JLON, JBLK)=LLDCUM (JLON, JBLK)
            LDSC (JLON, JBLK)=.FALSE.
            KBOTSC (JLON, JBLK)=-1
            JKB=KCBOT (JLON, JBLK)
            PWUBASE (JLON, JBLK)=SQRT (MAX (ZWU2H (JLON, JKB, JBLK), 0.0_JPRB))
            LLFIRST (JLON, JBLK)=.FALSE.
          ENDIF

          LLGO_ON (JLON, JBLK)=.NOT.LLDEEP (JLON, JBLK)
        ENDDO

      ENDIF

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  IBOTSC => NULL ()
  ICBOT => NULL ()
  ICTOP => NULL ()
  IDPL => NULL ()
  ILAB => NULL ()
  KBOTSC => NULL ()
  KCBOT => NULL ()
  KCTOP => NULL ()
  KDPL => NULL ()
  KLAB => NULL ()
  LDCUM => NULL ()
  LDSC => NULL ()
  LLDCUM => NULL ()
  LLDEEP => NULL ()
  LLDSC => NULL ()
  LLFIRST => NULL ()
  LLFLAG => NULL ()
  LLGO_ON => NULL ()
  LLRESETJL => NULL ()
  LL_LDBASE => NULL ()
  PAHFS => NULL ()
  PAPH => NULL ()
  PGEO => NULL ()
  PGEOH => NULL ()
  PKMFL => NULL ()
  PLU => NULL ()
  PQEN => NULL ()
  PQENH => NULL ()
  PQHFL => NULL ()
  PQSEN => NULL ()
  PQU => NULL ()
  PTEN => NULL ()
  PTENH => NULL ()
  PTU => NULL ()
  PWU2H => NULL ()
  PWUBASE => NULL ()
  ZBUOH => NULL ()
  ZCAPE => NULL ()
  ZCBASE => NULL ()
  ZDZ => NULL ()
  ZLU => NULL ()
  ZMIX => NULL ()
  ZPH => NULL ()
  ZQENH => NULL ()
  ZQEX => NULL ()
  ZQOLD => NULL ()
  ZQU => NULL ()
  ZSENH => NULL ()
  ZSUH => NULL ()
  ZTEX => NULL ()
  ZTU => NULL ()
  ZWU2H => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUBASEN_PARALLEL:2')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  IBOTSC => GET_DEVICE_DATA_RDWR (YL_IBOTSC)
  ICBOT => GET_DEVICE_DATA_RDWR (YL_ICBOT)
  ICTOP => GET_DEVICE_DATA_RDWR (YL_ICTOP)
  IDPL => GET_DEVICE_DATA_RDWR (YL_IDPL)
  ILAB => GET_DEVICE_DATA_RDWR (YL_ILAB)
  KBOTSC => GET_DEVICE_DATA_RDWR (YD_KBOTSC)
  KCBOT => GET_DEVICE_DATA_RDWR (YD_KCBOT)
  KCTOP => GET_DEVICE_DATA_RDWR (YD_KCTOP)
  KDPL => GET_DEVICE_DATA_RDWR (YD_KDPL)
  KLAB => GET_DEVICE_DATA_RDWR (YD_KLAB)
  LDCUM => GET_DEVICE_DATA_RDWR (YD_LDCUM)
  LDSC => GET_DEVICE_DATA_RDWR (YD_LDSC)
  LLDCUM => GET_DEVICE_DATA_RDWR (YL_LLDCUM)
  LLDEEP => GET_DEVICE_DATA_RDWR (YL_LLDEEP)
  LLDSC => GET_DEVICE_DATA_RDWR (YL_LLDSC)
  LLFIRST => GET_DEVICE_DATA_RDWR (YL_LLFIRST)
  LLFLAG => GET_DEVICE_DATA_RDWR (YL_LLFLAG)
  LLGO_ON => GET_DEVICE_DATA_RDWR (YL_LLGO_ON)
  LLRESETJL => GET_DEVICE_DATA_RDWR (YL_LLRESETJL)
  LL_LDBASE => GET_DEVICE_DATA_RDWR (YL_LL_LDBASE)
  PAHFS => GET_DEVICE_DATA_RDONLY (YD_PAHFS)
  PAPH => GET_DEVICE_DATA_RDONLY (YD_PAPH)
  PGEO => GET_DEVICE_DATA_RDONLY (YD_PGEO)
  PGEOH => GET_DEVICE_DATA_RDONLY (YD_PGEOH)
  PKMFL => GET_DEVICE_DATA_RDONLY (YD_PKMFL)
  PLU => GET_DEVICE_DATA_RDWR (YD_PLU)
  PQEN => GET_DEVICE_DATA_RDONLY (YD_PQEN)
  PQENH => GET_DEVICE_DATA_RDONLY (YD_PQENH)
  PQHFL => GET_DEVICE_DATA_RDONLY (YD_PQHFL)
  PQSEN => GET_DEVICE_DATA_RDONLY (YD_PQSEN)
  PQU => GET_DEVICE_DATA_RDWR (YD_PQU)
  PTEN => GET_DEVICE_DATA_RDONLY (YD_PTEN)
  PTENH => GET_DEVICE_DATA_RDONLY (YD_PTENH)
  PTU => GET_DEVICE_DATA_RDWR (YD_PTU)
  PWU2H => GET_DEVICE_DATA_RDWR (YD_PWU2H)
  PWUBASE => GET_DEVICE_DATA_RDWR (YD_PWUBASE)
  ZBUOH => GET_DEVICE_DATA_RDWR (YL_ZBUOH)
  ZCAPE => GET_DEVICE_DATA_RDWR (YL_ZCAPE)
  ZCBASE => GET_DEVICE_DATA_RDWR (YL_ZCBASE)
  ZDZ => GET_DEVICE_DATA_RDWR (YL_ZDZ)
  ZLU => GET_DEVICE_DATA_RDWR (YL_ZLU)
  ZMIX => GET_DEVICE_DATA_RDWR (YL_ZMIX)
  ZPH => GET_DEVICE_DATA_RDWR (YL_ZPH)
  ZQENH => GET_DEVICE_DATA_RDONLY (YL_ZQENH)
  ZQEX => GET_DEVICE_DATA_RDWR (YL_ZQEX)
  ZQOLD => GET_DEVICE_DATA_RDWR (YL_ZQOLD)
  ZQU => GET_DEVICE_DATA_RDWR (YL_ZQU)
  ZSENH => GET_DEVICE_DATA_RDONLY (YL_ZSENH)
  ZSUH => GET_DEVICE_DATA_RDWR (YL_ZSUH)
  ZTEX => GET_DEVICE_DATA_RDWR (YL_ZTEX)
  ZTU => GET_DEVICE_DATA_RDWR (YL_ZTU)
  ZWU2H => GET_DEVICE_DATA_RDWR (YL_ZWU2H)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (IBOTSC, ICBOT, ICTOP, IDPL, ILAB, KBOTSC, KCBOT, KCTOP, KDPL, KLAB, LDCUM, &
    !$ACC&         LDSC, LLDCUM, LLDEEP, LLDSC, LLFIRST, LLFLAG, LLGO_ON, LLRESETJL, LL_LDBASE, &
    !$ACC&         PAHFS, PAPH, PGEO, PGEOH, PKMFL, PLU, PQEN, PQENH, PQHFL, PQSEN, PQU, PTEN, &
    !$ACC&         PTENH, PTU, PWU2H, PWUBASE, YFXTRAN_ACDC_STACK, ZBUOH, ZCAPE, ZCBASE, &
    !$ACC&         ZDZ, ZLU, ZMIX, ZPH, ZQENH, ZQEX, ZQOLD, ZQU, ZSENH, ZSUH, ZTEX, ZTU, ZWU2H) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (IK, IS, JK, JKB, JKK, JKT, JLON, LLRESET, YLCPG_BNDS, Z1S, Z2S, ZALFAW, ZBUOF, &
    !$ACC&         ZCOND, ZCOND1, ZCOR, ZCOR_CUADJTQ, ZDP, ZDQ, ZDQSDT, ZDTDP, ZEPS, ZESDP, &
    !$ACC&         ZF, ZFAC, ZFACI, ZFACW, ZFOEEWI, ZFOEEWL, ZI, ZKHVFL, ZL, ZLGLAC, ZOEALFA, &
    !$ACC&         ZPDIFFBOT, ZPDIFFTOP, ZQEXC, ZQF, ZQMAX, ZQP, ZQSAT, ZQSU, ZRHO, ZSF, ZTARG, &
    !$ACC&         ZTEXC, ZTMP, ZTVENH, ZTVUH, ZUST, ZWORK1, ZWORK2, ZWS, ZXENTRORG, ZXENTSTPC1) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON

      

      DO JKK=KLEV, JKT1,-1
        IS=0

        

        IF (LLGO_ON (JLON, JBLK)) THEN
          IS=IS+1
          IDPL (JLON, JBLK)=JKK
          ICBOT (JLON, JBLK)=JKK
          IBOTSC (JLON, JBLK)=KLEV-1
          ICTOP (JLON, JBLK)=KLEV-1
          LLDCUM (JLON, JBLK)=.FALSE.
          LLDSC (JLON, JBLK)=.FALSE.
          LL_LDBASE (JLON, JBLK)=.FALSE.
        ENDIF


        

        IF (IS/=0) THEN

          IF (JKK==KLEV) THEN
            ZTEXC=0.2_JPRB
            ZQEXC=1.E-4_JPRB

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              ZRHO=PAPH (JLON, JKK+1, JBLK)/(YDCST%RD*(PTEN (JLON, JKK,&
              & JBLK)*(1.0_JPRB+YDCST%RETV*PQEN (JLON, JKK, JBLK))))
              ZKHVFL=(PAHFS (JLON, JKK+1, JBLK)*ZRCPD+YDCST%RETV*PTEN (JLON,&
              & JKK, JBLK)*PQHFL (JLON, JKK+1, JBLK))/(ZRHO*PPLRG*PPLDARE)
              ZUST=MAX (SQRT (PKMFL (JLON, JBLK)), 0.1_JPRB)
              ZWS=ZUST**3._JPRB-1.5_JPRB*RKAP*ZKHVFL*(PGEOH (JLON, KLEV, JBLK&
              &)-PGEOH (JLON, KLEV+1, JBLK))/PTEN (JLON, KLEV, JBLK)
              ZTEX (JLON, JBLK)=0.0_JPRB
              ZQEX (JLON, JBLK)=0.0_JPRB

              IF (ZKHVFL<0.0_JPRB) THEN
                ZWS=1.2_JPRB*ZWS**.3333_JPRB
                ILAB (JLON, JKK, JBLK)=1
                ZTEX (JLON, JBLK)=MAX (-1.5_JPRB*PAHFS (JLON, JKK+1, JBLK&
                &)/(ZRHO*ZWS*YDCST%RCPD*PPLRG*PPLDARE), ZTEXC)
                ZQEX (JLON, JBLK)=MAX (-1.5_JPRB*PQHFL (JLON, JKK+1, JBLK)/(ZRHO*ZWS*PPLRG*PPLDARE), ZQEXC)
                ZQU (JLON, JKK, JBLK)=ZQENH (JLON, JKK, JBLK)+ZQEX (JLON, JBLK)
                ZSUH (JLON, JKK, JBLK)=ZSENH (JLON, JKK, JBLK)+YDCST%RCPD*ZTEX (JLON, JBLK)
                ZTU (JLON, JKK, JBLK)=(ZSENH (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD+ZTEX (JLON, JBLK)
                ZLU (JLON, JKK, JBLK)=0.0_JPRB
                ZWU2H (JLON, JKK, JBLK)=ZWS**2+0.1_JPRB
                PWU2H (JLON, JKK, JBLK)=ZWU2H (JLON, JKK, JBLK)
                ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JLON, JKK, JBLK))*(ZSENH&
                & (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD
                ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JLON, JKK, JBLK))*ZTU (JLON, JKK, JBLK)
                ZBUOH (JLON, JKK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
              ELSE
                LLGO_ON (JLON, JBLK)=.FALSE.
              ENDIF

            ENDIF

          
          ELSE

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              ZRHO=PAPH (JLON, JKK+1, JBLK)/(YDCST%RD*(PTEN (JLON, JKK&
              &, JBLK)*(1.+YDCST%RETV*PQEN (JLON, JKK, JBLK))))
              ILAB (JLON, JKK, JBLK)=1
              ZTEXC=0.2_JPRB
              ZQEXC=1.E-4_JPRB

              IF (JKK==KLEV-1) THEN
                ZTEXC=MAX (ZTEXC, ZTEX (JLON, JBLK))
                ZQEXC=MAX (ZQEXC, ZQEX (JLON, JBLK))

                IF (LDTDKMF) THEN
                  ZTEXC=MIN (ZTEXC, 3.0_JPRB)
                  ZQEXC=MIN (ZQEXC, 2.E-3_JPRB)
                ELSE
                  ZTEXC=MIN (ZTEXC, 1.0_JPRB)
                  ZQEXC=MIN (ZQEXC, 5.E-4_JPRB)
                ENDIF

              ENDIF

              ZQU (JLON, JKK, JBLK)=ZQENH (JLON, JKK, JBLK)+ZQEXC
              ZSUH (JLON, JKK, JBLK)=ZSENH (JLON, JKK, JBLK)+YDCST%RCPD*ZTEXC
              ZTU (JLON, JKK, JBLK)=(ZSENH (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD+ZTEXC
              ZLU (JLON, JKK, JBLK)=0.0_JPRB

              IF (PAPH (JLON, KLEV+1, JBLK)-PAPH (JLON, JKK-1, JBLK)<60.E2_JPRB) THEN
                ZQU (JLON, JKK, JBLK)=0.0_JPRB
                ZSUH (JLON, JKK, JBLK)=0.0_JPRB
                ZWORK1=0.0_JPRB

                DO JK=JKK+1, JKK-1,-1

                  IF (ZWORK1<50.E2_JPRB) THEN
                    ZWORK2=PAPH (JLON, JK, JBLK)-PAPH (JLON, JK-1, JBLK)
                    ZWORK1=ZWORK1+ZWORK2
                    ZQU (JLON, JKK, JBLK)=ZQU (JLON, JKK, JBLK)+ZQENH (JLON, JK, JBLK)*ZWORK2
                    ZSUH (JLON, JKK, JBLK)=ZSUH (JLON, JKK, JBLK)+ZSENH (JLON, JK, JBLK)*ZWORK2
                  ENDIF

                ENDDO

                ZQU (JLON, JKK, JBLK)=ZQU (JLON, JKK, JBLK)/ZWORK1+ZQEXC
                ZSUH (JLON, JKK, JBLK)=ZSUH (JLON, JKK, JBLK)/ZWORK1+YDCST%RCPD*ZTEXC
                ZTU (JLON, JKK, JBLK)=(ZSUH (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD+ZTEXC
              ENDIF

              ZWU2H (JLON, JKK, JBLK)=1.0_JPRB
              ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JLON, JKK, JBLK))*(ZSENH&
              & (JLON, JKK, JBLK)-PGEOH (JLON, JKK, JBLK))*ZRCPD
              ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JLON, JKK, JBLK))*ZTU (JLON, JKK, JBLK)
              ZBUOH (JLON, JKK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
            ENDIF

          
          ENDIF

        ENDIF


        DO JK=JKK-1, JKT2,-1
          IS=0

          IF (JKK==KLEV.OR.KINDEX==KLEV-1) THEN
            
            
            ZXENTSTPC1=YDECUMF%ENTSTPC1

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              IS=IS+1
              ZDZ (JLON, JBLK)=(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZRG

              IF (LDTDKMF) THEN
                ZEPS=ZXENTSTPC1/((PGEOH (JLON, JK, JBLK)-PGEOH (JLON, KLEV+1, JBLK))*ZRG*PPLRG)+YDECUMF%ENTSTPC2
              ELSE
                ZEPS=ZXENTSTPC1/((PGEO (JLON, JK, JBLK)-PGEOH (JLON, KLEV+1, JBLK))*ZRG*PPLRG)+YDECUMF%ENTSTPC2

                IF (LDMIXS.AND.KINDEX==KLEV.AND.ZLU (JLON, JK+1, JBLK)>0.0_JPRB)  THEN
                  ZEPS=ZEPS*YDECUMF%ENTSTPC3
                ENDIF

              ENDIF

              ZMIX (JLON, JBLK)=0.5_JPRB*ZDZ (JLON, JBLK)*PPLRG*ZEPS

              IF (.NOT.LDTDKMF)  THEN
                ZMIX (JLON, JBLK)=MIN (1.0_JPRB, ZMIX (JLON, JBLK))
              ENDIF

              ZQF=(PQENH (JLON, JK+1, JBLK)+PQENH (JLON, JK, JBLK))*0.5_JPRB
              ZSF=(ZSENH (JLON, JK+1, JBLK)+ZSENH (JLON, JK, JBLK))*0.5_JPRB
              ZTMP=1.0_JPRB/(1.0_JPRB+ZMIX (JLON, JBLK))
              ZQU (JLON, JK, JBLK)=(ZQU (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX&
              & (JLON, JBLK))+2.0_JPRB*ZMIX (JLON, JBLK)*ZQF)*ZTMP
              ZSUH (JLON, JK, JBLK)=(ZSUH (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX&
              & (JLON, JBLK))+2.0_JPRB*ZMIX (JLON, JBLK)*ZSF)*ZTMP
              ZQOLD (JLON, JBLK)=ZQU (JLON, JK, JBLK)
              ZTU (JLON, JK, JBLK)=(ZSUH (JLON, JK, JBLK)-PGEOH (JLON, JK, JBLK))*ZRCPD
              ZPH (JLON, JBLK)=PAPH (JLON, JK, JBLK)
            ENDIF

          
          ELSE
            ZXENTRORG=YDECUMF%ENTRORG

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              
              ZDZ (JLON, JBLK)=(PGEOH (JLON, JK, JBLK)-PGEOH (JLON, JK+1, JBLK))*ZRG
              ZMIX (JLON, JBLK)=YDECUMF%ENTRTEST*ZXENTRORG*ZDZ (JLON, JBLK)*MIN &
              &(1.0_JPRB,(PQSEN (JLON, JK, JBLK)/PQSEN (JLON, KLEV, JBLK))**3)
            ENDIF


            

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              IS=IS+1
              ZMIX (JLON, JBLK)=MIN (1.0_JPRB, ZMIX (JLON, JBLK))
              ZQF=(PQENH (JLON, JK+1, JBLK)+PQENH (JLON, JK, JBLK))*0.5_JPRB
              ZSF=(ZSENH (JLON, JK+1, JBLK)+ZSENH (JLON, JK, JBLK))*0.5_JPRB
              ZQU (JLON, JK, JBLK)=ZQU (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX (JLON, JBLK))+ZQF*ZMIX (JLON, JBLK)
              ZSUH (JLON, JK, JBLK)=ZSUH (JLON, JK+1, JBLK)*(1.0_JPRB-ZMIX (JLON, JBLK))+ZSF*ZMIX (JLON, JBLK)
              ZQOLD (JLON, JBLK)=ZQU (JLON, JK, JBLK)
              ZTU (JLON, JK, JBLK)=(ZSUH (JLON, JK, JBLK)-PGEOH (JLON, JK, JBLK))*ZRCPD
              ZPH (JLON, JBLK)=PAPH (JLON, JK, JBLK)
            ENDIF

          
          ENDIF


          IF (IS==0)  THEN
            EXIT
          ENDIF

          IK=JK
          
          
          ZQMAX=0.5_JPRB

          IF (.NOT.YDEPHLI%LPHYLIN) THEN
            
            LLFLAG (JLON, JBLK)=LLGO_ON (JLON, JBLK)

            

            

            IF (LLFLAG (JLON, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JLON, JBLK)
              ZL=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(ZTU&
              & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (ZTU (JLON, IK, JBLK&
              &)))*EXP (YDTHF%R3IES*(ZTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=MIN (0.5_JPRB, ZQSAT)
              ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (ZTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (ZTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND=(ZQU (JLON, IK, JBLK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)
              ZCOND=MAX (ZCOND, 0.0_JPRB)
              ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+FOELDCPMCU (ZTU (JLON, IK, JBLK))*ZCOND
              ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND
              ZL=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4LES)
              ZI=1.0_JPRB/(ZTU (JLON, IK, JBLK)-YDTHF%R4IES)
              ZQSAT=YDTHF%R2ES*(FOEALFCU (ZTU (JLON, IK, JBLK))*EXP (YDTHF%R3LES*(ZTU&
              & (JLON, IK, JBLK)-YDCST%RTT)*ZL)+(1.0_JPRB-FOEALFCU (ZTU (JLON, IK, JBLK&
              &)))*EXP (YDTHF%R3IES*(ZTU (JLON, IK, JBLK)-YDCST%RTT)*ZI))
              ZQSAT=ZQSAT*ZQP
              ZQSAT=FMINJ (0.5_JPRB, ZQSAT)
              ZCOR_CUADJTQ=1.0_JPRB-YDCST%RETV*ZQSAT
              ZF=FOEALFCU (ZTU (JLON, IK, JBLK))*YDTHF%R5ALVCP*ZL**2+(1.0_JPRB&
              &-FOEALFCU (ZTU (JLON, IK, JBLK)))*YDTHF%R5ALSCP*ZI**2
              ZCOND1=(ZQU (JLON, IK, JBLK)*ZCOR_CUADJTQ**2-ZQSAT*ZCOR_CUADJTQ)/(ZCOR_CUADJTQ**2+ZQSAT*ZF)

              IF (ZCOND==0.0_JPRB)  THEN
                ZCOND1=0.0_JPRB
              ENDIF

              ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+FOELDCPMCU (ZTU (JLON, IK, JBLK))*ZCOND1
              ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND1
            ENDIF

          
          
          
          
          
          
          
          
          ELSE

            

            

            IF (LLGO_ON (JLON, JBLK)) THEN
              ZQP=1.0_JPRB/ZPH (JLON, JBLK)
              ZTARG=ZTU (JLON, IK, JBLK)
              ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
              ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
              ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
              ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
              Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
              ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
              ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
              ZQSAT=ZQSAT*ZCOR_CUADJTQ
              Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
              &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
              ZCOND=(ZQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
              ZCOND=MAX (ZCOND, 0.0_JPRB)

              IF (ZCOND/=0.0_JPRB) THEN
                ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+(ZOEALFA*YDTHF&
                &%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND
                ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND
                ZTARG=ZTU (JLON, IK, JBLK)
                ZOEALFA=0.5_JPRB*(TANH (YDEPHLI%RLPAL1*(ZTARG-YDEPHLI%RLPTRC))+1.0_JPRB)
                ZFOEEWL=YDTHF%R2ES*EXP (YDTHF%R3LES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4LES))
                ZFOEEWI=YDTHF%R2ES*EXP (YDTHF%R3IES*(ZTARG-YDCST%RTT)/(ZTARG-YDTHF%R4IES))
                ZQSAT=ZQP*(ZOEALFA*ZFOEEWL+(1.0_JPRB-ZOEALFA)*ZFOEEWI)
                Z1S=TANH (YDEPHLI%RLPAL2*(ZQSAT-ZQMAX))
                ZQSAT=0.5_JPRB*((1.0_JPRB-Z1S)*ZQSAT+(1.0_JPRB+Z1S)*ZQMAX)
                ZCOR_CUADJTQ=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
                ZQSAT=ZQSAT*ZCOR_CUADJTQ
                Z2S=ZOEALFA*YDTHF%R5ALVCP*(1.0_JPRB/(ZTARG-YDTHF%R4LES)**2)+(1.0_JPRB&
                &-ZOEALFA)*YDTHF%R5ALSCP*(1.0_JPRB/(ZTARG-YDTHF%R4IES)**2)
                ZCOND1=(ZQU (JLON, IK, JBLK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR_CUADJTQ*Z2S)
                ZTU (JLON, IK, JBLK)=ZTU (JLON, IK, JBLK)+(ZOEALFA*YDTHF&
                &%RALVDCP+(1.0_JPRB-ZOEALFA)*YDTHF%RALSDCP)*ZCOND1
                ZQU (JLON, IK, JBLK)=ZQU (JLON, IK, JBLK)-ZCOND1
              ENDIF

            ENDIF

          
          
          
          
          
          ENDIF


          

          

          

          

          IF (LLGO_ON (JLON, JBLK)) THEN
            ZDQ=MAX (ZQOLD (JLON, JBLK)-ZQU (JLON, JK, JBLK), 0.0_JPRB)
            ZLU (JLON, JK, JBLK)=ZLU (JLON, JK+1, JBLK)+ZDQ
            ZLGLAC=ZDQ*((1.0_JPRB-FOEALFCU (ZTU (JLON, JK, JBLK)))-(1.0_JPRB-FOEALFCU (ZTU (JLON, JK+1, JBLK))))
            ZLU (JLON, JK, JBLK)=0.5_JPRB*ZLU (JLON, JK, JBLK)
            ZTU (JLON, JK, JBLK)=ZTU (JLON, JK, JBLK)+YDTHF%RALFDCP*ZLGLAC
            ZSUH (JLON, JK, JBLK)=YDCST%RCPD*ZTU (JLON, JK, JBLK)+PGEOH (JLON, JK, JBLK)
            ZTVUH=(1.0_JPRB+YDCST%RETV*ZQU (JLON, JK, JBLK)-ZLU (JLON&
            &, JK, JBLK))*ZTU (JLON, JK, JBLK)+YDTHF%RALFDCP*ZLGLAC
            ZTVENH=(1.0_JPRB+YDCST%RETV*ZQENH (JLON, JK, JBLK))*(ZSENH&
            & (JLON, JK, JBLK)-PGEOH (JLON, JK, JBLK))*ZRCPD
            ZBUOH (JLON, JK, JBLK)=(ZTVUH-ZTVENH)*YDCST%RG/ZTVENH
            ZBUOF=(ZBUOH (JLON, JK, JBLK)+ZBUOH (JLON, JK+1, JBLK))*0.5_JPRB
            ZTMP=1.0_JPRB/(1.0_JPRB+2.0_JPRB*ZBW*ZMIX (JLON, JBLK))
            ZWU2H (JLON, JK, JBLK)=(ZWU2H (JLON, JK+1, JBLK)*(1.0_JPRB-2.0_JPRB*ZBW&
            &*ZMIX (JLON, JBLK))+2.0_JPRB*ZAW*ZBUOF*ZDZ (JLON, JBLK))*ZTMP

            IF (JKK==KLEV) THEN
              PWU2H (JLON, JK, JBLK)=ZWU2H (JLON, JK, JBLK)
            ENDIF

            ZCAPE (JLON, JKK, JBLK)=ZCAPE (JLON, JKK, JBLK)+MAX (0.0_JPRB, ZBUOF*ZDZ (JLON, JBLK))

            IF (ZLU (JLON, JK, JBLK)>0.0_JPRB.AND.ILAB (JLON, JK+1, JBLK)==1) THEN
              IK=JK+1
              ZQSU=FOEEWM (ZTU (JLON, IK, JBLK))/PAPH (JLON, IK, JBLK)
              ZESDP=ZQSU
              ZQSU=MIN (0.5_JPRB, ZQSU)
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSU)
              ZQSU=ZQSU*ZCOR
              ZDQ=MIN (0._JPRB, ZQU (JLON, IK, JBLK)-ZQSU)
              ZALFAW=FOEALFA (ZTU (JLON, IK, JBLK))
              ZFACW=YDTHF%R5LES/((ZTU (JLON, IK, JBLK)-YDTHF%R4LES)**2)
              ZFACI=YDTHF%R5IES/((ZTU (JLON, IK, JBLK)-YDTHF%R4IES)**2)
              ZFAC=ZALFAW*ZFACW+(1.-ZALFAW)*ZFACI
              ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZESDP)
              ZDQSDT=ZFAC*ZCOR*ZQSU
              ZDTDP=YDCST%RD*ZTU (JLON, IK, JBLK)/(YDCST%RCPD*PAPH (JLON, IK, JBLK))
              ZDP=ZDQ/(ZDQSDT*ZDTDP)
              ZCBASE (JLON, JBLK)=PAPH (JLON, IK, JBLK)+ZDP
              ZPDIFFTOP=ZCBASE (JLON, JBLK)-PAPH (JLON, JK, JBLK)
              ZPDIFFBOT=PAPH (JLON, JK+1, JBLK)-ZCBASE (JLON, JBLK)

              IF (ZPDIFFTOP>ZPDIFFBOT.AND.ZWU2H (JLON, JK+1, JBLK)>0.0_JPRB) THEN
                JKB=MIN (KLEV-1, JK+1)
                ILAB (JLON, JKB, JBLK)=2
                ILAB (JLON, JK, JBLK)=2
                LL_LDBASE (JLON, JBLK)=.TRUE.
                LLDSC (JLON, JBLK)=.TRUE.
                IBOTSC (JLON, JBLK)=JKB
                ICBOT (JLON, JBLK)=JKB
                ZLU (JLON, JK+1, JBLK)=YDECLDP%RLMIN
              ELSEIF (ZPDIFFTOP<=ZPDIFFBOT.AND.ZWU2H (JLON, JK, JBLK)>0.0_JPRB) THEN
                ILAB (JLON, JK, JBLK)=2
                LL_LDBASE (JLON, JBLK)=.TRUE.
                LLDSC (JLON, JBLK)=.TRUE.
                IBOTSC (JLON, JBLK)=JK
                ICBOT (JLON, JBLK)=JK
              ENDIF

            ENDIF


            IF (ZWU2H (JLON, JK, JBLK)<0.0_JPRB) THEN
              LLGO_ON (JLON, JBLK)=.FALSE.

              IF (ZLU (JLON, JK+1, JBLK)>0.0_JPRB) THEN
                ICTOP (JLON, JBLK)=JK
                LLDCUM (JLON, JBLK)=.TRUE.
              ELSE
                LLDCUM (JLON, JBLK)=.FALSE.
              ENDIF

            ELSE

              IF (ZLU (JLON, JK, JBLK)>0.0_JPRB) THEN
                ILAB (JLON, JK, JBLK)=2
              ELSE
                ILAB (JLON, JK, JBLK)=1
              ENDIF

            ENDIF

          ENDIF

        
        ENDDO


        IF (JKK==KLEV.OR.(JKK==KLEV-1.AND.KINDEX==KLEV-1)) THEN
          
          LDSC (JLON, JBLK)=LLDSC (JLON, JBLK)

          IF (LDSC (JLON, JBLK)) THEN
            KBOTSC (JLON, JBLK)=IBOTSC (JLON, JBLK)
          ELSE
            KBOTSC (JLON, JBLK)=-1
          ENDIF

          JKT=ICTOP (JLON, JBLK)
          JKB=ICBOT (JLON, JBLK)
          LLDEEP (JLON, JBLK)=PAPH (JLON, JKB, JBLK)-PAPH (JLON, JKT, JBLK)>YDECUMF%RDEPTHS

          IF (LLDEEP (JLON, JBLK).AND.KINDEX<KLEV-1)  THEN
            LLDCUM (JLON, JBLK)=.FALSE.
          ENDIF

          LLDEEP (JLON, JBLK)=.FALSE.
          LLGO_ON (JLON, JBLK)=.NOT.LLDEEP (JLON, JBLK)

          IF (KINDEX==KLEV-1)  THEN
            LLGO_ON (JLON, JBLK)=.NOT.LLDCUM (JLON, JBLK)
          ENDIF


          IF (LLDCUM (JLON, JBLK)) THEN
            KCBOT (JLON, JBLK)=ICBOT (JLON, JBLK)
            KCTOP (JLON, JBLK)=ICTOP (JLON, JBLK)
            KDPL (JLON, JBLK)=IDPL (JLON, JBLK)
            LDCUM (JLON, JBLK)=LLDCUM (JLON, JBLK)
            PWUBASE (JLON, JBLK)=SQRT (MAX (ZWU2H (JLON, JKB, JBLK), 0.0_JPRB))
          ELSE
            KCTOP (JLON, JBLK)=-1
            KCBOT (JLON, JBLK)=-1
            KDPL (JLON, JBLK)=KLEV-1
            LDCUM (JLON, JBLK)=.FALSE.
            PWUBASE (JLON, JBLK)=0.0_JPRB
          ENDIF


          

          DO JK=KLEV, 1,-1
            
            JKT=ICTOP (JLON, JBLK)

            IF (JK>=JKT.OR.(KINDEX>=KLEV-1.AND.JKK==KLEV)) THEN
              KLAB (JLON, JK, JBLK)=ILAB (JLON, JK, JBLK)
              PTU (JLON, JK, JBLK)=ZTU (JLON, JK, JBLK)
              PQU (JLON, JK, JBLK)=ZQU (JLON, JK, JBLK)
              PLU (JLON, JK, JBLK)=ZLU (JLON, JK, JBLK)
            ENDIF

          
          ENDDO

        ENDIF


        IF (JKK<KLEV) THEN
          LLRESET=.FALSE.

          

          IF (.NOT.LLDEEP (JLON, JBLK)) THEN
            JKT=ICTOP (JLON, JBLK)
            JKB=ICBOT (JLON, JBLK)
            LLDEEP (JLON, JBLK)=PAPH (JLON, JKB, JBLK)-PAPH (JLON, JKT, JBLK)>=YDECUMF%RDEPTHS
          ENDIF

          LLRESETJL (JLON, JBLK)=LLDEEP (JLON, JBLK).AND.LLFIRST (JLON, JBLK)
          LLRESET=LLRESET.OR.LLRESETJL (JLON, JBLK)

          

          IF (LLRESET) THEN

            DO JK=KLEV, 1,-1

              

              IF (LLRESETJL (JLON, JBLK)) THEN
                JKT=ICTOP (JLON, JBLK)
                JKB=IDPL (JLON, JBLK)

                IF (JK<=JKB.AND.JK>=JKT) THEN
                  KLAB (JLON, JK, JBLK)=ILAB (JLON, JK, JBLK)
                  PTU (JLON, JK, JBLK)=ZTU (JLON, JK, JBLK)
                  PQU (JLON, JK, JBLK)=ZQU (JLON, JK, JBLK)
                  PLU (JLON, JK, JBLK)=ZLU (JLON, JK, JBLK)
                ELSE
                  KLAB (JLON, JK, JBLK)=1
                  PTU (JLON, JK, JBLK)=PTENH (JLON, JK, JBLK)
                  PQU (JLON, JK, JBLK)=PQENH (JLON, JK, JBLK)
                  PLU (JLON, JK, JBLK)=0.0_JPRB
                ENDIF


                IF (JK<JKT)  THEN
                  KLAB (JLON, JK, JBLK)=0
                ENDIF

              ENDIF

            
            ENDDO

          ENDIF


          

          IF (LLDEEP (JLON, JBLK).AND.LLFIRST (JLON, JBLK)) THEN
            KDPL (JLON, JBLK)=IDPL (JLON, JBLK)
            KCTOP (JLON, JBLK)=ICTOP (JLON, JBLK)
            KCBOT (JLON, JBLK)=ICBOT (JLON, JBLK)
            LDCUM (JLON, JBLK)=LLDCUM (JLON, JBLK)
            LDSC (JLON, JBLK)=.FALSE.
            KBOTSC (JLON, JBLK)=-1
            JKB=KCBOT (JLON, JBLK)
            PWUBASE (JLON, JBLK)=SQRT (MAX (ZWU2H (JLON, JKB, JBLK), 0.0_JPRB))
            LLFIRST (JLON, JBLK)=.FALSE.
          ENDIF

          LLGO_ON (JLON, JBLK)=.NOT.LLDEEP (JLON, JBLK)
        
        ENDIF

      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  IBOTSC => NULL ()
  ICBOT => NULL ()
  ICTOP => NULL ()
  IDPL => NULL ()
  ILAB => NULL ()
  KBOTSC => NULL ()
  KCBOT => NULL ()
  KCTOP => NULL ()
  KDPL => NULL ()
  KLAB => NULL ()
  LDCUM => NULL ()
  LDSC => NULL ()
  LLDCUM => NULL ()
  LLDEEP => NULL ()
  LLDSC => NULL ()
  LLFIRST => NULL ()
  LLFLAG => NULL ()
  LLGO_ON => NULL ()
  LLRESETJL => NULL ()
  LL_LDBASE => NULL ()
  PAHFS => NULL ()
  PAPH => NULL ()
  PGEO => NULL ()
  PGEOH => NULL ()
  PKMFL => NULL ()
  PLU => NULL ()
  PQEN => NULL ()
  PQENH => NULL ()
  PQHFL => NULL ()
  PQSEN => NULL ()
  PQU => NULL ()
  PTEN => NULL ()
  PTENH => NULL ()
  PTU => NULL ()
  PWU2H => NULL ()
  PWUBASE => NULL ()
  ZBUOH => NULL ()
  ZCAPE => NULL ()
  ZCBASE => NULL ()
  ZDZ => NULL ()
  ZLU => NULL ()
  ZMIX => NULL ()
  ZPH => NULL ()
  ZQENH => NULL ()
  ZQEX => NULL ()
  ZQOLD => NULL ()
  ZQU => NULL ()
  ZSENH => NULL ()
  ZSUH => NULL ()
  ZTEX => NULL ()
  ZTU => NULL ()
  ZWU2H => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUBASEN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:2',1,ZHOOK_HANDLE_PARALLEL)
IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3',0,ZHOOK_HANDLE_PARALLEL)

IF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENMP','CUBASEN_PARALLEL:3')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  PCAPE => GET_HOST_DATA_RDWR (YD_PCAPE)
  ZCAPE => GET_HOST_DATA_RDONLY (YL_ZCAPE)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  CALL YLCPG_BNDS%INIT (YDCPG_OPTS)
  !$OMP PARALLEL DO PRIVATE (JBLK, JK, JLON) FIRSTPRIVATE (YLCPG_BNDS)

  DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    CALL YLCPG_BNDS%UPDATE (JBLK)
    
    PCAPE (:, JBLK)=ZCAPE (:, 1, JBLK)

    DO JK=2, KLEV

      DO JLON=YLCPG_BNDS%KIDIA, YLCPG_BNDS%KFDIA
        PCAPE (JLON, JBLK)=MAX (PCAPE (JLON, JBLK), ZCAPE (JLON, JK, JBLK))
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  PCAPE => NULL ()
  ZCAPE => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSEIF (FXTRAN_ACDC_LPARALLELMETHOD ('OPENACCSINGLECOLUMN','CUBASEN_PARALLEL:3')) THEN
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:GET_DATA',0,ZHOOK_HANDLE_FIELD_API)
  PCAPE => GET_DEVICE_DATA_RDWR (YD_PCAPE)
  ZCAPE => GET_DEVICE_DATA_RDONLY (YL_ZCAPE)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:GET_DATA',1,ZHOOK_HANDLE_FIELD_API)
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:COMPUTE',0,ZHOOK_HANDLE_COMPUTE)
  
  
    !$ACC PARALLEL LOOP GANG &
    !$ACC&PRESENT (PCAPE, YFXTRAN_ACDC_STACK, ZCAPE) &
    !$ACC&PRIVATE (JBLK) &
    !$ACC&VECTOR_LENGTH (YDCPG_OPTS%KLON) 
    
    DO JBLK = YDCPG_OPTS%JBLKMIN, YDCPG_OPTS%JBLKMAX
    
    
    
    !$ACC LOOP VECTOR &
    !$ACC&PRIVATE (JK, JLON, YLCPG_BNDS) 

    

    DO JLON = 1, MIN (YDCPG_OPTS%KLON, YDCPG_OPTS%KGPCOMP - (JBLK - 1) * YDCPG_OPTS%KLON)
      YLCPG_BNDS%KIDIA = JLON
      YLCPG_BNDS%KFDIA = JLON
      
      PCAPE (JLON, JBLK)=ZCAPE (JLON, 1, JBLK)

      DO JK=2, KLEV
        
        PCAPE (JLON, JBLK)=MAX (PCAPE (JLON, JBLK), ZCAPE (JLON, JK, JBLK))
      
      ENDDO

    ENDDO

  ENDDO

  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:COMPUTE',1,ZHOOK_HANDLE_COMPUTE)
  
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:NULLIFY',0,ZHOOK_HANDLE_FIELD_API)
  PCAPE => NULL ()
  ZCAPE => NULL ()
  IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3:NULLIFY',1,ZHOOK_HANDLE_FIELD_API)
  
  
ELSE
    CALL ABOR1 ('CUBASEN_PARALLEL: NOT METHOD WAS FOUND')
ENDIF

IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL:3',1,ZHOOK_HANDLE_PARALLEL)

IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',0,ZHOOK_HANDLE_FIELD_API)
IF (ASSOCIATED (YL_IBOTSC)) CALL FIELD_DELETE (YL_IBOTSC)
IF (ASSOCIATED (YL_ICBOT)) CALL FIELD_DELETE (YL_ICBOT)
IF (ASSOCIATED (YL_ICTOP)) CALL FIELD_DELETE (YL_ICTOP)
IF (ASSOCIATED (YL_IDPL)) CALL FIELD_DELETE (YL_IDPL)
IF (ASSOCIATED (YL_ILAB)) CALL FIELD_DELETE (YL_ILAB)
IF (ASSOCIATED (YL_LLDCUM)) CALL FIELD_DELETE (YL_LLDCUM)
IF (ASSOCIATED (YL_LLDEEP)) CALL FIELD_DELETE (YL_LLDEEP)
IF (ASSOCIATED (YL_LLDSC)) CALL FIELD_DELETE (YL_LLDSC)
IF (ASSOCIATED (YL_LLFIRST)) CALL FIELD_DELETE (YL_LLFIRST)
IF (ASSOCIATED (YL_LLFLAG)) CALL FIELD_DELETE (YL_LLFLAG)
IF (ASSOCIATED (YL_LLGO_ON)) CALL FIELD_DELETE (YL_LLGO_ON)
IF (ASSOCIATED (YL_LLRESETJL)) CALL FIELD_DELETE (YL_LLRESETJL)
IF (ASSOCIATED (YL_LL_LDBASE)) CALL FIELD_DELETE (YL_LL_LDBASE)
IF (ASSOCIATED (YL_ZBUOH)) CALL FIELD_DELETE (YL_ZBUOH)
IF (ASSOCIATED (YL_ZCAPE)) CALL FIELD_DELETE (YL_ZCAPE)
IF (ASSOCIATED (YL_ZCBASE)) CALL FIELD_DELETE (YL_ZCBASE)
IF (ASSOCIATED (YL_ZDZ)) CALL FIELD_DELETE (YL_ZDZ)
IF (ASSOCIATED (YL_ZLU)) CALL FIELD_DELETE (YL_ZLU)
IF (ASSOCIATED (YL_ZMIX)) CALL FIELD_DELETE (YL_ZMIX)
IF (ASSOCIATED (YL_ZPH)) CALL FIELD_DELETE (YL_ZPH)
IF (ASSOCIATED (YL_ZQENH)) CALL FIELD_DELETE (YL_ZQENH)
IF (ASSOCIATED (YL_ZQEX)) CALL FIELD_DELETE (YL_ZQEX)
IF (ASSOCIATED (YL_ZQOLD)) CALL FIELD_DELETE (YL_ZQOLD)
IF (ASSOCIATED (YL_ZQU)) CALL FIELD_DELETE (YL_ZQU)
IF (ASSOCIATED (YL_ZS)) CALL FIELD_DELETE (YL_ZS)
IF (ASSOCIATED (YL_ZSENH)) CALL FIELD_DELETE (YL_ZSENH)
IF (ASSOCIATED (YL_ZSUH)) CALL FIELD_DELETE (YL_ZSUH)
IF (ASSOCIATED (YL_ZTEX)) CALL FIELD_DELETE (YL_ZTEX)
IF (ASSOCIATED (YL_ZTU)) CALL FIELD_DELETE (YL_ZTU)
IF (ASSOCIATED (YL_ZWU2H)) CALL FIELD_DELETE (YL_ZWU2H)
IF (LHOOK) CALL DR_HOOK ('DELETE_TEMPORARIES',1,ZHOOK_HANDLE_FIELD_API)
IF (LHOOK) CALL DR_HOOK ('CUBASEN_PARALLEL', 1, ZHOOK_HANDLE)
END SUBROUTINE CUBASEN_PARALLEL
