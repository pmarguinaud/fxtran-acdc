SUBROUTINE GPXX_OPENACC (YDGEOMETRY, KFLEV, KPROMA, KST, KEND, PHIHL, PHIHM, PHIFL, PHIFM&
&, PLNPR, PRT, PUF, PVF, PUH, PVH, PWF2H, PX, PNHPPI, PTAUX_NL, LDVFE, YDSTACK)
!$ACC ROUTINE (GPXX_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPRD

USE GEOMETRY_MOD,ONLY:GEOMETRY
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
REAL (KIND=JPRB), INTENT (IN)::PHIHL (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PHIHM (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PHIFL (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PHIFM (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PRT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PUF (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PVF (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PUH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PVH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PWF2H (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PX (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PTAUX_NL
LOGICAL, INTENT (IN), OPTIONAL::LDVFE
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
fxtran_acdc_temp (REAL (KIND=JPRB), ZDUF, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDVF, (KPROMA, KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZF, (KPROMA, 0:KFLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUVH, (KPROMA, 0:KFLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZNHPPI, (KPROMA, KFLEV))
LOGICAL::LLVFE

#include "verdisint_openacc.intfb.h"

YLSTACK = YDSTACK



IF (KIND (ZDUF) == 8) THEN
    fxtran_acdc_alloc8 (ZDUF)
ELSEIF (KIND (ZDUF) == 4) THEN
    fxtran_acdc_alloc4 (ZDUF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDVF) == 8) THEN
    fxtran_acdc_alloc8 (ZDVF)
ELSEIF (KIND (ZDVF) == 4) THEN
    fxtran_acdc_alloc4 (ZDVF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZF) == 8) THEN
    fxtran_acdc_alloc8 (ZF)
ELSEIF (KIND (ZF) == 4) THEN
    fxtran_acdc_alloc4 (ZF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUVH) == 8) THEN
    fxtran_acdc_alloc8 (ZUVH)
ELSEIF (KIND (ZUVH) == 4) THEN
    fxtran_acdc_alloc4 (ZUVH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZNHPPI) == 8) THEN
    fxtran_acdc_alloc8 (ZNHPPI)
ELSEIF (KIND (ZNHPPI) == 4) THEN
    fxtran_acdc_alloc4 (ZNHPPI)
ELSE
    STOP 1
ENDIF


JROF = KST



IF (PRESENT (LDVFE)) THEN
  LLVFE=LDVFE
ELSE
  LLVFE=YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE.AND.(.NOT.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE)
ENDIF


IF (PRESENT (PNHPPI)) THEN

  IF (PRESENT (PTAUX_NL)) THEN

    DO JLEV=1, KFLEV
      
      ZNHPPI (JROF, JLEV)=1.0_JPRB+PTAUX_NL*(PNHPPI (JROF, JLEV)-1.0_JPRB)
    
    ENDDO

  ELSE
    ZNHPPI (JROF, 1:KFLEV)=PNHPPI (JROF, 1:KFLEV)
  ENDIF

ENDIF


IF (LLVFE) THEN
  ZF (JROF, 0)=0.0_JPRB
  ZF (JROF, KFLEV+1)=0.0_JPRB
  ZF (JROF, 1:KFLEV)=PUF (JROF, 1:KFLEV)
  CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
  &%YRCVER,'FDER','11', KPROMA, KST, KEND, KFLEV, ZF, ZDUF, YDSTACK=YLSTACK)
  ZF (JROF, 1:KFLEV)=PVF (JROF, 1:KFLEV)
  CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM&
  &%YRCVER,'FDER','11', KPROMA, KST, KEND, KFLEV, ZF, ZDVF, YDSTACK=YLSTACK)

  IF (PRESENT (PNHPPI)) THEN

    DO JLEV=1, KFLEV
      
      PX (JROF, JLEV)=REAL (ZNHPPI (JROF, JLEV), JPRD)/REAL (PRT (JROF, JLEV)*PLNPR (JROF&
      &, JLEV), JPRD)*REAL (PHIFL (JROF, JLEV)*ZDUF (JROF, JLEV)+PHIFM (JROF, JLEV)*ZDVF&
      & (JROF, JLEV), JPRD)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      PX (JROF, JLEV)=1._JPRD/REAL (PRT (JROF, JLEV)*PLNPR (JROF, JLEV), JPRD&
      &)*REAL (PHIFL (JROF, JLEV)*ZDUF (JROF, JLEV)+PHIFM (JROF, JLEV)*ZDVF (JROF&
      &, JLEV), JPRD)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
    
    ENDDO

  ENDIF

ELSEIF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE.OR&
  &.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFD_COMPATIBLE) THEN

  DO JLEV=1, KFLEV-1
    
    ZUVH (JROF, JLEV)=(PUF (JROF, JLEV+1)*PHIFL (JROF, JLEV+1)+PVF (JROF, JLEV+1)*PHIFM (JROF, JLEV&
    &+1)+PWF2H (JROF, JLEV)*(PUF (JROF, JLEV)*PHIFL (JROF, JLEV)-PUF (JROF, JLEV+1)*PHIFL (JROF,&
    & JLEV+1)+PVF (JROF, JLEV)*PHIFM (JROF, JLEV)-PVF (JROF, JLEV+1)*PHIFM (JROF, JLEV+1)))
  
  ENDDO

  
  ZUVH (JROF, 0)=PUF (JROF, 1)*PHIHL (JROF, 0)+PVF (JROF, 1)*PHIHM (JROF, 0)
  ZUVH (JROF, KFLEV)=PUF (JROF, KFLEV)*PHIHL (JROF, KFLEV)+PVF (JROF, KFLEV)*PHIHM (JROF, KFLEV)

  

  IF (PRESENT (PNHPPI)) THEN

    DO JLEV=1, KFLEV
      
      PX (JROF, JLEV)=YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV)*((REAL ((ZUVH (JROF, JLEV&
      &)-ZUVH (JROF, JLEV-1)), JPRD)-PUF (JROF, JLEV)*REAL (PHIHL (JROF, JLEV)-PHIHL (JROF, JLEV&
      &-1), JPRD)-PVF (JROF, JLEV)*REAL (PHIHM (JROF, JLEV)-PHIHM (JROF, JLEV-1), JPRD))*REAL &
      &(PNHPPI (JROF, JLEV), JPRD)/(REAL (PRT (JROF, JLEV)*PLNPR (JROF, JLEV), JPRD)))
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      PX (JROF, JLEV)=YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV)*((REAL (ZUVH (JROF&
      &, JLEV)-ZUVH (JROF, JLEV-1), JPRD)-PUF (JROF, JLEV)*REAL (PHIHL (JROF, JLEV)-PHIHL&
      & (JROF, JLEV-1), JPRD)-PVF (JROF, JLEV)*REAL (PHIHM (JROF, JLEV)-PHIHM (JROF, JLEV&
      &-1), JPRD))/REAL (PRT (JROF, JLEV)*PLNPR (JROF, JLEV), JPRD))
    
    ENDDO

  ENDIF

ELSE

  IF (PRESENT (PNHPPI)) THEN

    DO JLEV=1, KFLEV
      
      PX (JROF, JLEV)=(REAL (PUH (JROF, JLEV)-PUF (JROF, JLEV), JPRD)*PHIHL (JROF, JLEV)+REAL (PVH (JROF&
      &, JLEV)-PVF (JROF, JLEV), JPRD)*PHIHM (JROF, JLEV)+REAL (PUF (JROF, JLEV)-PUH (JROF, JLEV-1),&
      & JPRD)*PHIHL (JROF, JLEV-1)+REAL (PVF (JROF, JLEV)-PVH (JROF, JLEV-1), JPRD)*PHIHM (JROF, JLEV&
      &-1))*REAL (ZNHPPI (JROF, JLEV), JPRD)/REAL (PRT (JROF, JLEV)*PLNPR (JROF, JLEV), JPRD)
    
    ENDDO

  ELSE

    DO JLEV=1, KFLEV
      
      PX (JROF, JLEV)=(REAL (PUH (JROF, JLEV)-PUF (JROF, JLEV), JPRD)*PHIHL (JROF, JLEV)+REAL&
      & (PVH (JROF, JLEV)-PVF (JROF, JLEV), JPRD)*PHIHM (JROF, JLEV)+REAL (PUF (JROF, JLEV)-PUH&
      & (JROF, JLEV-1), JPRD)*PHIHL (JROF, JLEV-1)+REAL (PVF (JROF, JLEV)-PVH (JROF, JLEV-1)&
      &, JPRD)*PHIHM (JROF, JLEV-1))/REAL (PRT (JROF, JLEV)*PLNPR (JROF, JLEV), JPRD)
    
    ENDDO

  ENDIF

ENDIF


END SUBROUTINE GPXX_OPENACC
