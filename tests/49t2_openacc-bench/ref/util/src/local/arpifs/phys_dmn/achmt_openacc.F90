
SUBROUTINE ACHMT_OPENACC (YDCLI, YDPHY, YDPHY0, YDPHY1, YDPHY2, YDCST, KIDIA, KFDIA, KLON&
&, KLEV, LDZ0H, PAPHI, PAPHIF, PAPRS, PAPRSF, PCP, PQ, PR, PT, PU, PV, PFPLSH, PFPLCH, PDPHIT&
&, PDPHIV, PGZ0F, PGZ0HF, PGZ0RLF, PHV, PLSM, PNEIJG, PNEIJV, PSNS, PTS, PVEG0, PWFC, PWS&
&, PWSI, LDCLS, LDHMT, PNBVNO, PMRIPP, PCD, PCDN, PCDROV, PCH, PCHROV, PCPS, PDQSTS, PGWDCS&
&, PGZ0, PGZ0H, PHQ, PHU, PNEIJ, PQCLS, PQS, PQSATS, PRHCLS, PRS, PRTI, PSTAB, PTCLS, PUCLS&
&, PVCLS, PUCLN, PVCLN, PZPCLS, PVEG, PXDROV, PXHROV, PURAF, PVRAF, YDSTACK)
!$ACC ROUTINE (ACHMT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPRD

USE YOMPHY,ONLY:TPHY
USE YOMPHY0,ONLY:TPHY0
USE YOMPHY1,ONLY:TPHY1
USE YOMPHY2,ONLY:TPHY2
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE YOMCST,ONLY:TCST
USE YOMCLI,ONLY:TCLI
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCLI), INTENT (IN)::YDCLI
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY0), INTENT (IN)::YDPHY0
TYPE (TPHY1), INTENT (IN)::YDPHY1
TYPE (TPHY2), INTENT (IN)::YDPHY2
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
LOGICAL, INTENT (IN)::LDZ0H
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLSH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLCH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDPHIT (KLON)
REAL (KIND=JPRB), INTENT (IN)::PDPHIV (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGZ0F (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGZ0HF (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGZ0RLF (KLON)
REAL (KIND=JPRB), INTENT (IN)::PHV (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLSM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PNEIJG (KLON)
REAL (KIND=JPRB), INTENT (IN)::PNEIJV (KLON)
REAL (KIND=JPRB), INTENT (IN)::PSNS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PVEG0 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWFC (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PWSI (KLON)
LOGICAL, INTENT (IN)::LDCLS
LOGICAL, INTENT (IN)::LDHMT
REAL (KIND=JPRB), INTENT (OUT)::PNBVNO (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMRIPP (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PCD (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PCDN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCDROV (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PCH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCHROV (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PCPS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDQSTS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PGWDCS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PGZ0 (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PGZ0H (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PHQ (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PHU (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PNEIJ (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PQCLS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PQS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PQSATS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRHCLS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PRTI (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PSTAB (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PTCLS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PUCLS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PVCLS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PUCLN (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PVCLN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PZPCLS (KLON)
REAL (KIND=JPRB), INTENT (INOUT)::PVEG (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PXDROV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PXHROV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PURAF (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PVRAF (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZCDNMR, (KLON))
fxtran_acdc_temp (REAL (KIND=JPRB), ZCDMR, (KLON))
REAL (KIND=JPRB)::ZSTABV 
REAL (KIND=JPRB)::ZU 
REAL (KIND=JPRB)::ZESP 
fxtran_acdc_temp (REAL (KIND=JPRB), ZDPHI, (KLON))
REAL (KIND=JPRB)::ZDELT 
fxtran_acdc_temp (REAL (KIND=JPRB), ZCDNH, (KLON))
INTEGER (KIND=JPIM)::JLON
LOGICAL::LLAFGD
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDIDMR
REAL (KIND=JPRB)::ZCDIMR
REAL (KIND=JPRB)::ZLOIMR
REAL (KIND=JPRB)::ZRZDMR
REAL (KIND=JPRB)::ZGZ0MR
REAL (KIND=JPRB)::ZGZ0N
REAL (KIND=JPRB)::ZRRCOR
REAL (KIND=JPRB)::ZFP
REAL (KIND=JPRB)::ZDERH
REAL (KIND=JPRB)::ZHS
REAL (KIND=JPRB)::ZSTAH
REAL (KIND=JPRB)::ZIXP
REAL (KIND=JPRB)::ZSTA
REAL (KIND=JPRB)::ZUSURIC
REAL (KIND=JPRB)::ZWS
REAL (KIND=JPRB)::ZWFC
REAL (KIND=JPRB)::ZUZ0CN
REAL (KIND=JPRB)::ZRIOLD
REAL (KIND=JPRB)::ZRIH
REAL (KIND=JPRB)::ZSCRAF
REAL (KIND=JPRB)::ZTAU
REAL (KIND=JPRB)::ZSU
REAL (KIND=JPRB)::ZST
REAL (KIND=JPRB)::ZSDPRIM
REAL (KIND=JPRB)::ZRZH
REAL (KIND=JPRB)::ZRZD
REAL (KIND=JPRB)::ZRVMD
REAL (KIND=JPRB)::ZRI
REAL (KIND=JPRB)::ZPH
REAL (KIND=JPRB)::ZPD
REAL (KIND=JPRB)::ZMULA2
REAL (KIND=JPRB)::ZMU
REAL (KIND=JPRB)::ZLOS
REAL (KIND=JPRB)::ZLOI
REAL (KIND=JPRB)::ZIU
REAL (KIND=JPRB)::ZIT
REAL (KIND=JPRB)::ZGKU
REAL (KIND=JPRB)::ZGKT
REAL (KIND=JPRB)::ZGAMDZ
REAL (KIND=JPRB)::ZGA
REAL (KIND=JPRB)::ZEW
REAL (KIND=JPRB)::ZDS
REAL (KIND=JPRB)::ZDIH
REAL (KIND=JPRB)::ZDID
REAL (KIND=JPRB)::ZDEW
REAL (KIND=JPRB)::ZDENUM
REAL (KIND=JPRB)::ZDELTA1
REAL (KIND=JPRB)::ZCRIT2
REAL (KIND=JPRB)::ZCRIT1
REAL (KIND=JPRB)::ZCPVMD
REAL (KIND=JPRB)::ZCPRIM
REAL (KIND=JPRB)::ZCKH
REAL (KIND=JPRB)::ZCKD
REAL (KIND=JPRB)::ZCIS
REAL (KIND=JPRB)::ZCH0
REAL (KIND=JPRB)::ZCH
REAL (KIND=JPRB)::ZCD0
REAL (KIND=JPRB)::ZCD
REAL (KIND=JPRB)::ZC1
REAL (KIND=JPRB)::ZBPRIM
REAL (KIND=JPRB)::ZBETAP
REAL (KIND=JPRB)::ZBETA
REAL (KIND=JPRB)::ZBE
REAL (KIND=JPRB)::ZB1
REAL (KIND=JPRB)::ZAU
REAL (KIND=JPRB)::ZAT
REAL (KIND=JPRB)::ZAPRIM
REAL (KIND=JPRB)::ZA1
REAL (KIND=JPRB)::Z3BC
REAL (KIND=JPRB)::Z3B
REAL (KIND=JPRB)::Z2B
REAL (KIND=JPRB)::Z0CR

#include "acntcls_openacc.intfb.h"
#include "fcttrm.func.h"
#include "fzh.func.h"

YLSTACK = YDSTACK



IF (KIND (ZCDNMR) == 8) THEN
    fxtran_acdc_alloc8 (ZCDNMR)
ELSEIF (KIND (ZCDNMR) == 4) THEN
    fxtran_acdc_alloc4 (ZCDNMR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCDMR) == 8) THEN
    fxtran_acdc_alloc8 (ZCDMR)
ELSEIF (KIND (ZCDMR) == 4) THEN
    fxtran_acdc_alloc4 (ZCDMR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDPHI) == 8) THEN
    fxtran_acdc_alloc8 (ZDPHI)
ELSEIF (KIND (ZDPHI) == 4) THEN
    fxtran_acdc_alloc4 (ZDPHI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCDNH) == 8) THEN
    fxtran_acdc_alloc8 (ZCDNH)
ELSEIF (KIND (ZCDNH) == 4) THEN
    fxtran_acdc_alloc4 (ZCDNH)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPS=EPSILON (1.0_JPRB)*100.0_JPRB
ZCPVMD=YDCST%RCPV-YDCST%RCPD
ZRVMD=YDCST%RV-YDCST%RD
ZUSURIC=YDPHY0%USURIC*YDPHY0%USURICL
ZGZ0N=YDCST%RG*YDCLI%SZZ0D
Z2B=2.0_JPRB*YDPHY0%EDB
Z3B=3._JPRB*YDPHY0%EDB
Z3BC=3._JPRB*YDPHY0%EDB*YDPHY0%EDC
LLAFGD=YDPHY2%XMULAF/=0.0_JPRB
Z0CR=YDCST%RG*YDPHY1%ALRCN1
ZUZ0CN=1.0_JPRB/(YDCST%RG*YDPHY1%ALRCN2)

ZDPHI (JLON)=PAPHIF (JLON, KLEV)-PAPHI (JLON, KLEV)


IF (YDPHY0%USURID==0.0_JPRB) THEN
  ZIXP=1.0_JPRB
ELSE
  ZIXP=3._JPRB
ENDIF



IF (YDPHY%LNEIGE) THEN

  IF (YDPHY%LSNV) THEN
    PNEIJ (JLON)=PLSM (JLON)*((1.0_JPRB-PVEG0 (JLON))*PNEIJG (JLON)+PVEG0 (JLON)*PNEIJV (JLON))
    PVEG (JLON)=(1.0_JPRB-PNEIJV (JLON))*PVEG0 (JLON)
    PGZ0 (JLON)=SQRT ((1.0_JPRB-PNEIJV (JLON))*PGZ0F (JLON&
    &)**2+PNEIJV (JLON)*(Z0CR**2+PGZ0RLF (JLON)**2))
  ELSE
    PNEIJ (JLON)=PLSM (JLON)*PSNS (JLON)/(PSNS (JLON)+YDPHY1%WCRIN)
    PVEG (JLON)=PVEG0 (JLON)
    PGZ0 (JLON)=PGZ0F (JLON)+(Z0CR-PGZ0F (JLON))*PLSM (JLON)*PSNS (JLON&
    &)/(PSNS (JLON)+YDPHY1%WCRIN*(1.0_JPRB+ZUZ0CN*PGZ0F (JLON)))
  ENDIF

  ZDELT =MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PTS (JLON)))
ELSE
  PNEIJ (JLON)=0.0_JPRB
  PVEG (JLON)=PVEG0 (JLON)
  PGZ0 (JLON)=PGZ0F (JLON)
  ZDELT =0.0_JPRB
ENDIF


IF (LDZ0H) THEN

  IF (YDPHY%LNEIGE) THEN

    IF (YDPHY%LSNV) THEN

      IF (YDPHY%LZ0HSREL) THEN
        PGZ0H (JLON)=SQRT ((1.0_JPRB-PNEIJV (JLON))*PGZ0HF (JLON)**2+PNEIJV (JLON)*Z0CR**2)
      ELSE
        PGZ0H (JLON)=SQRT ((1.0_JPRB-PNEIJV (JLON))*PGZ0HF (JLON)**2+PNEIJV &
        &(JLON)*(Z0CR**2+(PGZ0RLF (JLON)*PGZ0HF (JLON)/PGZ0F (JLON))**2))
      ENDIF

    ELSE

      IF (YDPHY%LZ0HSREL) THEN
        PGZ0H (JLON)=PGZ0HF (JLON)+(Z0CR*YDCLI%STHER-PGZ0HF (JLON))*PLSM (JLON)*PSNS&
        & (JLON)/(PSNS (JLON)+YDPHY1%WCRIN*(1.0_JPRB+ZUZ0CN*PGZ0HF (JLON)))
      ELSE
        PGZ0H (JLON)=PGZ0HF (JLON)+(Z0CR-PGZ0HF (JLON))*PLSM (JLON)*PSNS (JLON&
        &)/(PSNS (JLON)+YDPHY1%WCRIN*(1.0_JPRB+ZUZ0CN*PGZ0HF (JLON)))
      ENDIF

    ENDIF

  ELSE
    PGZ0H (JLON)=PGZ0HF (JLON)
  ENDIF


  IF (YDPHY0%VZIUSTAR0>0) THEN
    PGZ0H (JLON)=PLSM (JLON)*PGZ0H (JLON)+(1.0_JPRB-PLSM (JLON))*PGZ0HF (JLON)
  ELSE
    PGZ0H (JLON)=MIN (PGZ0 (JLON), PLSM (JLON)*PGZ0H (JLON&
    &)+(1.0_JPRB-PLSM (JLON))*PGZ0 (JLON)*YDPHY1%RZHZ0M)
  ENDIF

ELSE
  PGZ0H (JLON)=PGZ0 (JLON)
ENDIF

ZEW=FOEW (PTS (JLON), ZDELT )
ZESP =ZEW/PAPRS (JLON, KLEV)
PQSATS (JLON)=FOQS (ZESP )

IF (YDPHY%LSOLV) THEN
  ZWFC=PWFC (JLON)*YDPHY1%RD1*YDPHY1%GCONV

  IF (YDPHY%LFGEL) THEN
    ZWS=PWS (JLON)+PWSI (JLON)
  ELSE
    ZWS=PWS (JLON)
  ENDIF


  IF (YDPHY%LSNV) THEN
    PHU (JLON)=1.0_JPRB+PLSM (JLON)*(1.0_JPRB-PNEIJG (JLON))*(0.5_JPRB&
    &*(1.0_JPRB-COS (YDCST%RPI*MIN (ZWS/ZWFC, 1.0_JPRB)))-1.0_JPRB)
    PHU (JLON)=MAX (PHU (JLON), MIN (PQ (JLON, KLEV)/PQSATS (JLON), 1.0_JPRB))
    PQS (JLON)=(PVEG (JLON)*PHV (JLON)+PVEG0 (JLON)*PNEIJV (JLON)+(1.0_JPRB-PVEG0 (JLON&
    &))*PHU (JLON))*PQSATS (JLON)+(1.0_JPRB-PHV (JLON))*PVEG (JLON)*PQ (JLON, KLEV)
  ELSE
    PHU (JLON)=1.0_JPRB+PLSM (JLON)*(1.0_JPRB-PNEIJ (JLON))*(0.5_JPRB&
    &*(1.0_JPRB-COS (YDCST%RPI*MIN (ZWS/ZWFC, 1.0_JPRB)))-1.0_JPRB)
    PHU (JLON)=MAX (PHU (JLON), MIN (PQ (JLON, KLEV)/PQSATS (JLON), 1.0_JPRB))
    PQS (JLON)=(PVEG (JLON)*PHV (JLON)+(1.0_JPRB-PVEG (JLON))*PHU (JLON)&
    &)*PQSATS (JLON)+(1.0_JPRB-PHV (JLON))*PVEG (JLON)*PQ (JLON, KLEV)
  ENDIF

ELSE
  PHU (JLON)=1.0_JPRB+PLSM (JLON)*(1.0_JPRB-PNEIJ (JLON))*(0.5_JPRB&
  &*(1.0_JPRB-COS (YDCST%RPI*PWS (JLON)/YDPHY1%WSMX))-1.0_JPRB)
  PHQ (JLON)=(1.0_JPRB-PHU (JLON))*PVEG (JLON)
  ZDEW=MAX (0.0_JPRB, SIGN (1.0_JPRB, PQ (JLON, KLEV)-PQSATS (JLON)))
  PHU (JLON)=PHU (JLON)+ZDEW*PHQ (JLON)
  PHQ (JLON)=PHQ (JLON)-ZDEW*PHQ (JLON)
  PQS (JLON)=PHU (JLON)*PQSATS (JLON)+PHQ (JLON)*PQ (JLON, KLEV)
ENDIF

PCPS (JLON)=YDCST%RCPD+ZCPVMD*PQS (JLON)
PRS (JLON)=YDCST%RD+ZRVMD*PQS (JLON)
ZRZD=1.0_JPRB+ZDPHI (JLON)/PGZ0 (JLON)
PCDN (JLON)=(YDPHY0%VKARMN/LOG (ZRZD))**2
ZRZH=FZH (ZDPHI (JLON), PGZ0H (JLON))

IF (YDPHY%LZ0HSREL.AND.YDPHY%LSNV) THEN
  ZGZ0MR=PLSM (JLON)*SQRT (MAX (ZGZ0N**2, PGZ0 (JLON)**2-PGZ0RLF&
  & (JLON)**2))+(1.0_JPRB-PLSM (JLON))*PGZ0 (JLON)
  ZGZ0MR=MAX (ZGZ0MR, PGZ0H (JLON))
  ZRZDMR=1.0_JPRB+ZDPHI (JLON)/ZGZ0MR
ELSEIF (YDPHY%LZ0HSREL.AND.(.NOT.YDPHY%LSNV)) THEN
  ZGZ0MR=PLSM (JLON)*PGZ0H (JLON)/YDCLI%STHER+(1.0_JPRB-PLSM (JLON))*PGZ0 (JLON)
  ZRZDMR=1.0_JPRB+ZDPHI (JLON)/ZGZ0MR
ELSE
  ZGZ0MR=PGZ0 (JLON)
  ZRZDMR=ZRZD
ENDIF

ZCDNH (JLON)=YDPHY0%VKARMN**2/(LOG (ZRZH)*LOG (ZRZDMR))
ZMU=LOG (ZGZ0MR/PGZ0H (JLON))
ZCD0=(YDPHY1%GCZ0H(0, 1)+ZMU*(YDPHY1%GCZ0H(1, 1)+ZMU*(YDPHY1%GCZ0H&
&(2, 1)+ZMU*YDPHY1%GCZ0H(3, 1))))/(1.5_JPRB*YDPHY0%EDC)
ZPD=(YDPHY1%GCZ0H(0, 2)+ZMU*(YDPHY1%GCZ0H(1, 2)+ZMU*(YDPHY1&
&%GCZ0H(2, 2)+ZMU*YDPHY1%GCZ0H(3, 2))))-0.5_JPRB
ZCH0=(YDPHY1%GCZ0H(0, 3)+ZMU*(YDPHY1%GCZ0H(1, 3)+ZMU*(YDPHY1&
&%GCZ0H(2, 3)+ZMU*YDPHY1%GCZ0H(3, 3))))/YDPHY0%EDC
ZPH=(YDPHY1%GCZ0H(0, 4)+ZMU*(YDPHY1%GCZ0H(1, 4)+ZMU*(YDPHY1&
&%GCZ0H(2, 4)+ZMU*YDPHY1%GCZ0H(3, 4))))-0.5_JPRB
ZCD=ZCD0*ZRZD**ZPD
ZCH=ZCH0*ZRZH**ZPH
ZCIS=PU (JLON, KLEV)**2+PV (JLON, KLEV)**2+(YDPHY0%GCISMIN*ZDPHI (JLON)/YDCST%RG)**2
ZU =SQRT (ZCIS)
PRTI (JLON)=2.0_JPRB/(PR (JLON, KLEV)*PT (JLON, KLEV)&
&+YDCST%RKAPPA*ZDPHI (JLON)+PRS (JLON)*PTS (JLON))
ZSTA=ZDPHI (JLON)*(PR (JLON, KLEV)*PT (JLON, KLEV)+YDCST%RKAPPA&
&*ZDPHI (JLON)-PRS (JLON)*PTS (JLON))*PRTI (JLON)
ZSTABV =ZSTA
ZSTAH=ZSTA/(1.0_JPRB+ZIXP*ZUSURIC*MAX (0.0_JPRB, ZSTA)/ZCIS)**(1.0_JPRB/ZIXP)
ZSTA=ZSTA/(1.0_JPRB+ZUSURIC*MAX (0.0_JPRB, ZSTA)/ZCIS)
PSTAB (JLON)=MAX (0.0_JPRB, SIGN (1.0_JPRB, ZSTA))
ZRI=ZSTA/ZCIS
PMRIPP (JLON, KLEV)=SIGN (MAX (ZEPS, ABS (ZRI)), ZRI)
ZDS=SQRT (ZCIS+YDPHY0%EDD/YDPHY0%EDK*ABS (ZSTA))
ZHS=SQRT (ZCIS+YDPHY0%EDD*YDPHY0%EDK*ABS (ZSTAH))
ZDID=1.0_JPRB/(ZU +ZCD*Z3BC*PCDN (JLON)*SQRT (ABS (ZSTA)*ZRZD))
ZDIH=1.0_JPRB/(ZU +ZCH*Z3BC*ZCDNH (JLON)*SQRT (ABS (ZSTA)*ZRZH))
ZLOS=ZCIS*ZDS/(ZU *ZDS+Z2B*ABS (ZSTA))
ZLOI=ZU -Z2B*ZSTA*ZDID
PCD (JLON)=MAX (1.0E-12_JPRB,(ZLOI+PSTAB (JLON)*(ZLOS-ZLOI))*PCDN (JLON)/ZU )
ZCDNMR (JLON)=(YDPHY0%VKARMN/LOG (ZRZDMR))**2

IF (YDPHY%LZ0HSREL) THEN
  ZCDIMR=ZCD0*ZRZDMR**ZPD
  ZDIDMR=1.0_JPRB/(ZU +ZCDIMR*Z3BC*ZCDNMR (JLON)*SQRT (ABS (ZSTA)*ZRZDMR))
  ZLOIMR=ZU -Z2B*ZSTA*ZDIDMR
  ZCDMR (JLON)=(ZLOIMR+PSTAB (JLON)*(ZLOS-ZLOIMR))*ZCDNMR (JLON)/ZU 
ELSE
  ZCDMR (JLON)=PCD (JLON)
ENDIF

ZLOS=ZCIS**2/(ZU *ZCIS+Z3B*ABS (ZSTAH)*ZHS)
ZLOI=ZU -Z3B*ZSTA*ZDIH
PCH (JLON)=((1._JPRB-PSTAB (JLON))*ZLOI+PSTAB (JLON)*ZLOS)*ZCDNH (JLON)/ZU 
PXDROV (JLON)=1.0_JPRB
PXHROV (JLON)=1.0_JPRB

IF (LLAFGD) THEN
  ZRI=ABS (ZSTA)/ZCIS
  ZRIH=ABS (ZSTAH)/ZCIS
  ZRIOLD=ABS (ZSTABV )/ZCIS
  ZDERH=(1.0_JPRB+(ZIXP-1.0_JPRB)*ZUSURIC*ZRIOLD)/(1.0_JPRB+ZIXP*ZUSURIC*ZRIOLD)
  ZST=-3._JPRB*YDPHY0%EDB*ZRIH*(1.0_JPRB+1.5_JPRB*YDPHY0%EDD*YDPHY0%EDK*ZRIH)/(SQRT (1.0_JPRB+YDPHY0&
  &%EDD*YDPHY0%EDK*ZRIH)+3._JPRB*YDPHY0%EDB*ZRIH*(1.0_JPRB+YDPHY0%EDD*YDPHY0%EDK*ZRIH))*ZDERH
  ZSU=-2.0_JPRB*YDPHY0%EDB*ZRI*(1.0_JPRB+0.5_JPRB*YDPHY0%EDD*ZRI/YDPHY0%EDK&
  &)/((SQRT (1.0_JPRB+YDPHY0%EDD*ZRI/YDPHY0%EDK)+2.0_JPRB*YDPHY0%EDB*ZRI&
  &)*(1.0_JPRB+YDPHY0%EDD*ZRI/YDPHY0%EDK))*(1.0_JPRB-ZRI*ZUSURIC)
  ZCKD=ZCD*Z3BC*PCDN (JLON)*SQRT (ZRZD)
  ZCKH=ZCH*Z3BC*ZCDNH (JLON)*SQRT (ZRZH)
  ZIT=3._JPRB*YDPHY0%EDB*ZRI*(1.0_JPRB+0.5_JPRB*ZCKH*SQRT (ZRI))/((1.0_JPRB&
  &+ZCKH*SQRT (ZRI))*(1.0_JPRB+ZCKH*SQRT (ZRI)+3._JPRB*YDPHY0%EDB*ZRI))
  ZIU=2.0_JPRB*YDPHY0%EDB*ZRI*(1.0_JPRB+0.5_JPRB*ZCKD*SQRT (ZRI))/((1.0_JPRB&
  &+ZCKD*SQRT (ZRI))*(1.0_JPRB+ZCKD*SQRT (ZRI)+2.0_JPRB*YDPHY0%EDB*ZRI))
  ZAT=ZIT+PSTAB (JLON)*(ZST-ZIT)
  ZAU=ZIU+PSTAB (JLON)*(ZSU-ZIU)
  ZBE=3._JPRB+ZAT-2.0_JPRB*ZAU
  ZGA=2.0_JPRB+2.0_JPRB*ZAT-3._JPRB*ZAU

  IF (YDPHY2%XMULAF>0.0_JPRB) THEN
    PXDROV (JLON)=MAX (PXDROV (JLON), YDPHY2%XMULAF)
    PXHROV (JLON)=MAX (PXHROV (JLON), YDPHY2%XMULAF)
  ELSE
    ZGAMDZ=4._JPRB*YDPHY2%TSPHY*(YDCST%RG/ZDPHI (JLON))
    ZGKU=ZGAMDZ*PCD (JLON)*ZU 
    ZGKT=ZGAMDZ*PCH (JLON)*ZU 
    ZMULA2=YDPHY2%XMULAF**2
    ZDENUM=ZGKU*ZGKT
    ZA1=(1.0_JPRB+ZGKU)*(1.0_JPRB+ZGKT)
    ZB1=(1.0_JPRB+ZGKU)*ZGKT*(1.0_JPRB+ZAT)+2.0_JPRB*(1.0_JPRB+ZGKT)*ZGKU*(1.0_JPRB-ZAU)
    ZC1=ZDENUM*ZGA
    ZDELTA1=ZB1**2-4._JPRB*ZA1*ZC1
    ZCRIT1=MAX (SIGN (1.0_JPRB, ZDELTA1), 0.0_JPRB)
    ZTAU=-0.5_JPRB*ZCRIT1*(ZB1+SQRT (ABS (ZDELTA1)))/ZA1
    ZCRIT2=MAX (SIGN (1.0_JPRB, YDPHY2%XMULAF-ZTAU), 0.0_JPRB)
    ZAPRIM=ZMULA2*ZDENUM
    ZBPRIM=ZMULA2*(ZGKU+ZGKT)+YDPHY2%XMULAF*ZDENUM*ZBE
    ZCPRIM=ZMULA2+YDPHY2%XMULAF*(ZGKT*(1.0_JPRB+ZAT)+2.0_JPRB*ZGKU*(1.0_JPRB-ZAU))+ZDENUM*ZGA
    ZSDPRIM=SQRT (ABS (ZBPRIM**2-4._JPRB*ZAPRIM*ZCPRIM))
    ZBETAP=0.5_JPRB*(-ZBPRIM+ZSDPRIM)/MAX (ZAPRIM, 1.0_JPRB-ZCRIT2)
    ZBETA=1.0_JPRB+ZCRIT2*(ZBETAP-1.0_JPRB)
    PXDROV (JLON)=MAX (PXDROV (JLON), ZBETA)
    PXHROV (JLON)=MAX (PXHROV (JLON), ZBETA)
  ENDIF

ENDIF


IF (YDPHY%LRRGUST) THEN
  ZFP=MAX (0.0_JPRB, PFPLSH (JLON, KLEV)+PFPLCH (JLON, KLEV))
  ZRRCOR=SQRT (1.0_JPRB+((((ZFP/(ZFP+YDPHY0%RRSCALE))**YDPHY0&
  &%RRGAMMA)*YDPHY0%UTILGUST)**2)/(PCD (JLON)*ZU **2))
  PCD (JLON)=PCD (JLON)*ZRRCOR
  PCH (JLON)=PCH (JLON)*ZRRCOR
  PCDN (JLON)=PCDN (JLON)*ZRRCOR
  ZCDNH (JLON)=ZCDNH (JLON)*ZRRCOR
  ZCDMR (JLON)=ZCDMR (JLON)*ZRRCOR
ENDIF



IF (LDCLS) THEN
  
  PDQSTS (JLON)=FODQS (PQSATS (JLON), ZESP , FODLEW (PTS (JLON), ZDELT ))
  PCDROV (JLON)=PCD (JLON)*ZU *PAPRS (JLON, KLEV)*PRTI (JLON)
  PCHROV (JLON)=PCH (JLON)*ZU *PAPRS (JLON, KLEV)*PRTI (JLON)
  PNBVNO (JLON, KLEV)=ZSTABV /(PAPRS (JLON, KLEV)*PRTI (JLON)*ZDPHI (JLON))**2
  PGWDCS (JLON)=PAPRS (JLON, KLEV)*PRTI (JLON)
  
ENDIF


IF (LDHMT) THEN
  CALL ACNTCLS_OPENACC (YDPHY, YDPHY0, YDCST, KIDIA, KFDIA, KLON, KLEV, PAPRS, PAPRSF, PCP, PQ&
  &, PT, PU, PV, PCD, PCDN, ZCDMR, ZCDNMR, ZCDNH, PCH, PCPS, ZDPHI, PDPHIT, PDPHIV, PQS, PSTAB&
  &, PTS, PQCLS, PRHCLS, PTCLS, PUCLS, PVCLS, PUCLN, PVCLN, PZPCLS, YDSTACK=YLSTACK)

  IF (YDPHY2%LRAFTUR) THEN
    
    ZSCRAF=(PCD (JLON)*(PU (JLON, KLEV)**2+PV (JLON, KLEV)**2)/(PUCLS (JLON)**2+PVCLS&
    & (JLON)**2+(YDPHY0%GCISMIN*PDPHIV (JLON)/YDCST%RG)**2))/(1.0_JPRB+(LOG (1.0_JPRB&
    &+PDPHIV (JLON)/YDPHY2%GZ0RAF)/LOG (1.0_JPRB+PDPHIV (JLON)/PGZ0 (JLON)))**2)
    ZSCRAF=1.0_JPRB+YDPHY2%FACRAF*SQRT (ZSCRAF)
    PURAF (JLON)=ZSCRAF*PUCLS (JLON)
    PVRAF (JLON)=ZSCRAF*PVCLS (JLON)
  
  ENDIF

ENDIF



END SUBROUTINE ACHMT_OPENACC
