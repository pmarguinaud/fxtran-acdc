
SUBROUTINE CONVECT_CLOSURE_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPRES, PDPRES, PZ, PLMASS&
&, PTHL, PTH, PRW, PRC, PRI, OTRIG1, PTHC, PRWC, PRCC, PRIC, PWSUB, KLCL, KDPL, KPBL, KCTL&
&, PUMF, PUER, PUDR, PUTHL, PURW, PURC, PURI, PCAPE, PTIMEC, KFTSTEPS, YDSTACK)
!$ACC ROUTINE (CONVECT_CLOSURE_SHAL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
INTEGER, INTENT (IN)::KLCL(D%NIT)
INTEGER, INTENT (IN)::KCTL(D%NIT)
INTEGER, INTENT (IN)::KDPL(D%NIT)
INTEGER, INTENT (IN)::KPBL(D%NIT)
REAL, INTENT (INOUT)::PTIMEC(D%NIT)
REAL, INTENT (IN)::PTHL(D%NIT, D%NKT)
REAL, INTENT (IN)::PTH(D%NIT, D%NKT)
REAL, INTENT (IN)::PRW(D%NIT, D%NKT)
REAL, INTENT (IN)::PRC(D%NIT, D%NKT)
REAL, INTENT (IN)::PRI(D%NIT, D%NKT)
LOGICAL, INTENT (IN)::OTRIG1(D%NIT)
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PDPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PLMASS(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PCAPE(D%NIT)
INTEGER, INTENT (OUT)::KFTSTEPS
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL, INTENT (INOUT)::PUMF(D%NIT, D%NKT)
REAL, INTENT (INOUT)::PUER(D%NIT, D%NKT)
REAL, INTENT (INOUT)::PUDR(D%NIT, D%NKT)
REAL, INTENT (IN)::PUTHL(D%NIT, D%NKT)
REAL, INTENT (IN)::PURW(D%NIT, D%NKT)
REAL, INTENT (IN)::PURC(D%NIT, D%NKT)
REAL, INTENT (IN)::PURI(D%NIT, D%NKT)
REAL, INTENT (OUT)::PTHC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRWC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRCC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRIC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PWSUB(D%NIT, D%NKT)
INTEGER::IKE
INTEGER::IKB
INTEGER::IKS
INTEGER::JKMAX
INTEGER::JKP
INTEGER::JK
INTEGER::JI
INTEGER::JITER
INTEGER::JSTEP
REAL::ZRDOCP
REAL::ZCPORD
REAL::ZEPS
fxtran_acdc_temp (REAL, ZTHLC, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZOMG, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUMF, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUER, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZUDR, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZADJ, (D%NIT))
REAL::ZADJMAX
REAL::ZCAPE
REAL::ZTIMEC
fxtran_acdc_temp (REAL, ZTIMC, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZTHLCL, (D%NIT))
fxtran_acdc_temp (REAL, ZRVLCL, (D%NIT))
fxtran_acdc_temp (REAL, ZZLCL, (D%NIT))
fxtran_acdc_temp (REAL, ZTLCL, (D%NIT))
fxtran_acdc_temp (REAL, ZTELCL, (D%NIT))
REAL::ZTHEUL
REAL::ZTHES2
REAL::ZTHES1
fxtran_acdc_temp (REAL, ZRWMFOUT, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZRWMFIN, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZTHMFOUT, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZTHMFIN, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZRIMFOUT, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZRIMFIN, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZRCMFOUT, (D%NIT, D%NKT))
fxtran_acdc_temp (REAL, ZRCMFIN, (D%NIT, D%NKT))
REAL::ZPI
REAL::ZLV
REAL::ZLS
REAL::ZCPH
INTEGER::ITSTEP
INTEGER::ICOUNT
fxtran_acdc_temp (INTEGER, ILCL, (D%NIT))
INTEGER::IWORK1
REAL::ZWORK5
REAL::ZWORK3
REAL::ZWORK2
REAL::ZWORK1
LOGICAL::GWORK3
fxtran_acdc_temp (LOGICAL, GWORK1, (D%NIT))
fxtran_acdc_temp (LOGICAL, GWORK4, (D%NIT, D%NKT))

#include "convect_closure_adjust_shal_openacc.h"
#include "convect_closure_thrvlcl_openacc.h"
REAL::ZT

YLSTACK = YDSTACK



IF (KIND (ZTHLC) == 8) THEN
    fxtran_acdc_alloc8 (ZTHLC)
ELSEIF (KIND (ZTHLC) == 4) THEN
    fxtran_acdc_alloc4 (ZTHLC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZOMG) == 8) THEN
    fxtran_acdc_alloc8 (ZOMG)
ELSEIF (KIND (ZOMG) == 4) THEN
    fxtran_acdc_alloc4 (ZOMG)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUMF) == 8) THEN
    fxtran_acdc_alloc8 (ZUMF)
ELSEIF (KIND (ZUMF) == 4) THEN
    fxtran_acdc_alloc4 (ZUMF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUER) == 8) THEN
    fxtran_acdc_alloc8 (ZUER)
ELSEIF (KIND (ZUER) == 4) THEN
    fxtran_acdc_alloc4 (ZUER)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUDR) == 8) THEN
    fxtran_acdc_alloc8 (ZUDR)
ELSEIF (KIND (ZUDR) == 4) THEN
    fxtran_acdc_alloc4 (ZUDR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZADJ) == 8) THEN
    fxtran_acdc_alloc8 (ZADJ)
ELSEIF (KIND (ZADJ) == 4) THEN
    fxtran_acdc_alloc4 (ZADJ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTIMC) == 8) THEN
    fxtran_acdc_alloc8 (ZTIMC)
ELSEIF (KIND (ZTIMC) == 4) THEN
    fxtran_acdc_alloc4 (ZTIMC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHLCL) == 8) THEN
    fxtran_acdc_alloc8 (ZTHLCL)
ELSEIF (KIND (ZTHLCL) == 4) THEN
    fxtran_acdc_alloc4 (ZTHLCL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRVLCL) == 8) THEN
    fxtran_acdc_alloc8 (ZRVLCL)
ELSEIF (KIND (ZRVLCL) == 4) THEN
    fxtran_acdc_alloc4 (ZRVLCL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZLCL) == 8) THEN
    fxtran_acdc_alloc8 (ZZLCL)
ELSEIF (KIND (ZZLCL) == 4) THEN
    fxtran_acdc_alloc4 (ZZLCL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTLCL) == 8) THEN
    fxtran_acdc_alloc8 (ZTLCL)
ELSEIF (KIND (ZTLCL) == 4) THEN
    fxtran_acdc_alloc4 (ZTLCL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTELCL) == 8) THEN
    fxtran_acdc_alloc8 (ZTELCL)
ELSEIF (KIND (ZTELCL) == 4) THEN
    fxtran_acdc_alloc4 (ZTELCL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRWMFOUT) == 8) THEN
    fxtran_acdc_alloc8 (ZRWMFOUT)
ELSEIF (KIND (ZRWMFOUT) == 4) THEN
    fxtran_acdc_alloc4 (ZRWMFOUT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRWMFIN) == 8) THEN
    fxtran_acdc_alloc8 (ZRWMFIN)
ELSEIF (KIND (ZRWMFIN) == 4) THEN
    fxtran_acdc_alloc4 (ZRWMFIN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHMFOUT) == 8) THEN
    fxtran_acdc_alloc8 (ZTHMFOUT)
ELSEIF (KIND (ZTHMFOUT) == 4) THEN
    fxtran_acdc_alloc4 (ZTHMFOUT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHMFIN) == 8) THEN
    fxtran_acdc_alloc8 (ZTHMFIN)
ELSEIF (KIND (ZTHMFIN) == 4) THEN
    fxtran_acdc_alloc4 (ZTHMFIN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRIMFOUT) == 8) THEN
    fxtran_acdc_alloc8 (ZRIMFOUT)
ELSEIF (KIND (ZRIMFOUT) == 4) THEN
    fxtran_acdc_alloc4 (ZRIMFOUT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRIMFIN) == 8) THEN
    fxtran_acdc_alloc8 (ZRIMFIN)
ELSEIF (KIND (ZRIMFIN) == 4) THEN
    fxtran_acdc_alloc4 (ZRIMFIN)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRCMFOUT) == 8) THEN
    fxtran_acdc_alloc8 (ZRCMFOUT)
ELSEIF (KIND (ZRCMFOUT) == 4) THEN
    fxtran_acdc_alloc4 (ZRCMFOUT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRCMFIN) == 8) THEN
    fxtran_acdc_alloc8 (ZRCMFIN)
ELSEIF (KIND (ZRCMFIN) == 4) THEN
    fxtran_acdc_alloc4 (ZRCMFIN)
ELSE
    STOP 1
ENDIF


IF (KIND (ILCL) == 8) THEN
    fxtran_acdc_alloc8 (ILCL)
ELSEIF (KIND (ILCL) == 4) THEN
    fxtran_acdc_alloc4 (ILCL)
ELSE
    STOP 1
ENDIF


IF (KIND (GWORK1) == 8) THEN
    fxtran_acdc_alloc8 (GWORK1)
ELSEIF (KIND (GWORK1) == 4) THEN
    fxtran_acdc_alloc4 (GWORK1)
ELSE
    STOP 1
ENDIF


IF (KIND (GWORK4) == 8) THEN
    fxtran_acdc_alloc8 (GWORK4)
ELSEIF (KIND (GWORK4) == 4) THEN
    fxtran_acdc_alloc4 (GWORK4)
ELSE
    STOP 1
ENDIF


JI = D%NIB


ZTIMC (JI,:)=0.
ZTHES2 =0.
ZWORK1 =0.
ZWORK2 =0.
ZWORK3 =0.
GWORK1 (JI)=.FALSE.
GWORK3 =.FALSE.
GWORK4 (JI,:)=.FALSE.
ILCL (JI)=KLCL (JI)
ZEPS=CST%XRD/CST%XRV
ZCPORD=CST%XCPD/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
ZADJ (JI)=1.
ZWORK5 =1.


IF (.NOT.OTRIG1 (JI))  THEN
  ZWORK5=0
ENDIF


IKB=1+CVPEXT%JCVEXB
IKS=D%NKT
IKE=D%NKT-CVPEXT%JCVEXT
JKMAX=IKE
ZUMF (JI,:)=PUMF (JI,:)
ZUER (JI,:)=PUER (JI,:)
ZUDR (JI,:)=PUDR (JI,:)
ZOMG (JI,:)=0.
PWSUB (JI,:)=0.
ZADJMAX =1000.
IWORK1 =ILCL (JI)
JKP=IKB

DO JK=JKP, IKE

  

  IF (JK>KDPL (JI)) THEN

    IF (JK<=IWORK1 ) THEN
      ZWORK1 =PLMASS (JI, JK)/((PUER (JI, JK)+1.E-5)*PTIMEC (JI))
      ZADJMAX =MIN (ZADJMAX , ZWORK1 )
    ENDIF

  ENDIF

  
ENDDO

GWORK1 (JI)=OTRIG1 (JI)

DO JK=IKB, IKE
  
  ZTHLC (JI, JK)=PTHL (JI, JK)
  PRWC (JI, JK)=PRW (JI, JK)
  PRCC (JI, JK)=MAX (0., PRC (JI, JK))
  PRIC (JI, JK)=MAX (0., PRI (JI, JK))
  PTHC (JI, JK)=PTH (JI, JK)
  
ENDDO


DO JITER=1, 4
  ZTIMEC =PTIMEC (JI)

  DO JK=1, IKS
    GWORK4 (JI, JK)=GWORK1 (JI)
  ENDDO


  DO JK=IKB, IKE

    

    IF (GWORK4 (JI, JK))  THEN
      PWSUB (JI, JK)=0.
    ENDIF

  
  ENDDO

  ZOMG (JI, 1:D%NKT)=0.

  DO JK=IKB+1, JKMAX
    JKP=MAX (IKB+1, JK-1)

    

    IF (GWORK1 (JI).AND.JK<=KCTL (JI)) THEN
      ZWORK1 =-(PUER (JI, JKP)-PUDR (JI, JKP))/PLMASS (JI, JKP)
      PWSUB (JI, JK)=PWSUB (JI, JKP)-PDPRES (JI, JK-1)*ZWORK1 
      ZWORK1 =CVP_SHAL%XSTABT*PDPRES (JI, JKP)/(ABS (PWSUB (JI, JK))+1.E-10)
      ZTIMEC =MIN (ZTIMEC , ZWORK1 )
      ZOMG (JI, JK)=PWSUB (JI, JK)*CVP_SHAL%XA25/CST%XG
    ENDIF

  
  ENDDO


  DO JK=IKB, IKE

    

    IF (GWORK4 (JI, JK)) THEN
      ZTHLC (JI, JK)=PTHL (JI, JK)
      PRWC (JI, JK)=PRW (JI, JK)
      PRCC (JI, JK)=MAX (0., PRC (JI, JK))
      PRIC (JI, JK)=MAX (0., PRI (JI, JK))
      PTHC (JI, JK)=PTH (JI, JK)
    ENDIF

  
  ENDDO

  
  JK=KCTL (JI)
  ZWORK1 =PUDR (JI, JK)*PDPRES (JI, JK)/(PLMASS (JI, JK)+.1)-PWSUB (JI, JK)

  

  

  IF (GWORK1 (JI).AND.ABS (ZWORK1 )-.01>0.) THEN
    GWORK1 (JI)=.FALSE.
    PTIMEC (JI)=1.E-1
    ZWORK5 =0.
  ENDIF


  

  DO JK=IKB, IKE
    PWSUB (JI, JK)=PWSUB (JI, JK)*ZWORK5 
  ENDDO

  GWORK4 (JI, 1:IKB)=.FALSE.
  GWORK4 (JI, IKE:IKS)=.FALSE.
  
  ITSTEP =INT (PTIMEC (JI)/ZTIMEC )+1
  ZTIMEC =PTIMEC (JI)/REAL (ITSTEP )

  

  DO JK=1, IKS
    ZTIMC (JI, JK)=ZTIMEC 
  ENDDO

  ICOUNT =0
  KFTSTEPS=0
  
  KFTSTEPS=MAX (KFTSTEPS, ITSTEP )

  

  DO JSTEP=1, KFTSTEPS
    
    ICOUNT =ICOUNT +1
    GWORK3 =ITSTEP >=ICOUNT .AND.GWORK1 (JI)

    

    DO JK=1, D%NKT
      ZTHMFIN (JI, JK)=0.
      ZRWMFIN (JI, JK)=0.
      ZRCMFIN (JI, JK)=0.
      ZRIMFIN (JI, JK)=0.
      ZTHMFOUT (JI, JK)=0.
      ZRWMFOUT (JI, JK)=0.
      ZRCMFOUT (JI, JK)=0.
      ZRIMFOUT (JI, JK)=0.
    ENDDO


    DO JK=IKB+1, JKMAX
      
      GWORK4 (JI, JK)=GWORK3 .AND.JK<=KCTL (JI)
      
      JKP=MAX (IKB+1, JK-1)

      

      IF (GWORK3 ) THEN
        ZWORK1 =SIGN (1., ZOMG (JI, JK))
        ZWORK2 =0.5*(1.+ZWORK1 )
        ZWORK1 =0.5*(1.-ZWORK1 )
        ZTHMFIN (JI, JK)=-ZOMG (JI, JK)*ZTHLC (JI, JKP)*ZWORK1 
        ZTHMFOUT (JI, JK)=ZOMG (JI, JK)*ZTHLC (JI, JK)*ZWORK2 
        ZRWMFIN (JI, JK)=-ZOMG (JI, JK)*PRWC (JI, JKP)*ZWORK1 
        ZRWMFOUT (JI, JK)=ZOMG (JI, JK)*PRWC (JI, JK)*ZWORK2 
        ZRCMFIN (JI, JK)=-ZOMG (JI, JK)*PRCC (JI, JKP)*ZWORK1 
        ZRCMFOUT (JI, JK)=ZOMG (JI, JK)*PRCC (JI, JK)*ZWORK2 
        ZRIMFIN (JI, JK)=-ZOMG (JI, JK)*PRIC (JI, JKP)*ZWORK1 
        ZRIMFOUT (JI, JK)=ZOMG (JI, JK)*PRIC (JI, JK)*ZWORK2 
      ENDIF


      

      

      IF (GWORK3 ) THEN
        ZTHMFIN (JI, JKP)=ZTHMFIN (JI, JKP)+ZTHMFOUT (JI, JK)*ZWORK2 
        ZTHMFOUT (JI, JKP)=ZTHMFOUT (JI, JKP)+ZTHMFIN (JI, JK)*ZWORK1 
        ZRWMFIN (JI, JKP)=ZRWMFIN (JI, JKP)+ZRWMFOUT (JI, JK)*ZWORK2 
        ZRWMFOUT (JI, JKP)=ZRWMFOUT (JI, JKP)+ZRWMFIN (JI, JK)*ZWORK1 
        ZRCMFIN (JI, JKP)=ZRCMFIN (JI, JKP)+ZRCMFOUT (JI, JK)*ZWORK2 
        ZRCMFOUT (JI, JKP)=ZRCMFOUT (JI, JKP)+ZRCMFIN (JI, JK)*ZWORK1 
        ZRIMFIN (JI, JKP)=ZRIMFIN (JI, JKP)+ZRIMFOUT (JI, JK)*ZWORK2 
        ZRIMFOUT (JI, JKP)=ZRIMFOUT (JI, JKP)+ZRIMFIN (JI, JK)*ZWORK1 
      ENDIF

    
    ENDDO


    DO JK=IKB, IKE

      

      IF (GWORK4 (JI, JK)) THEN
        ZTHLC (JI, JK)=ZTHLC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZTHMFIN (JI, JK)+PUDR&
        & (JI, JK)*PUTHL (JI, JK)-ZTHMFOUT (JI, JK)-PUER (JI, JK)*PTHL (JI, JK))
        PRWC (JI, JK)=PRWC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZRWMFIN (JI, JK)+PUDR&
        & (JI, JK)*PURW (JI, JK)-ZRWMFOUT (JI, JK)-PUER (JI, JK)*PRW (JI, JK))
        PRCC (JI, JK)=PRCC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZRCMFIN (JI, JK)+PUDR &
        &(JI, JK)*PURC (JI, JK)-ZRCMFOUT (JI, JK)-PUER (JI, JK)*MAX (0., PRC (JI, JK)))
        PRIC (JI, JK)=PRIC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZRIMFIN (JI, JK)+PUDR &
        &(JI, JK)*PURI (JI, JK)-ZRIMFOUT (JI, JK)-PUER (JI, JK)*MAX (0., PRI (JI, JK)))
      ENDIF

    
    ENDDO

  ENDDO


  DO JK=IKB+1, JKMAX

    

    IF (GWORK1 (JI).AND.JK<=KCTL (JI)) THEN
      ZPI =(CST%XP00/PPRES (JI, JK))**ZRDOCP
      ZCPH =CST%XCPD+PRWC (JI, JK)*CST%XCPV
      ZWORK2 =PTH (JI, JK)/ZPI 
      ZLV =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZWORK2 -CST%XTT)
      ZLS =CST%XLVTT+(CST%XCPV-CST%XCI)*(ZWORK2 -CST%XTT)
      ZWORK2 =(ZTHLC (JI, JK)+ZLV *PRCC (JI, JK)+ZLS *PRIC (JI&
      &, JK)-(1.+PRWC (JI, JK))*CST%XG*PZ (JI, JK))/ZCPH 
      ZWORK2 =MAX (180., MIN (340., ZWORK2 ))
      PTHC (JI, JK)=ZWORK2 *ZPI 
    ENDIF

  
  ENDDO

  CALL CONVECT_CLOSURE_THRVLCL_OPENACC (CVPEXT, CST, D, PPRES, PTHC, PRWC, PZ, GWORK1&
  &, ZTHLCL, ZRVLCL, ZZLCL, ZTLCL, ZTELCL, ILCL, KDPL, KPBL, YDSTACK=YLSTACK)
  
  ZTLCL (JI)=MAX (230., MIN (335., ZTLCL (JI)))
  ZTELCL (JI)=MAX (230., MIN (335., ZTELCL (JI)))
  ZTHLCL (JI)=MAX (230., MIN (345., ZTHLCL (JI)))
  ZRVLCL (JI)=MAX (0., MIN (1., ZRVLCL (JI)))
  ZCAPE =0.
  ZPI =MAX (0.95, MIN (1.5, ZTHLCL (JI)/ZTLCL (JI)))
  ZWORK1 =CST%XP00/ZPI **ZCPORD
  
  ZT=MIN (400., MAX (ZTELCL (JI), 10.))
  ZWORK3 =EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*ALOG (ZT))
  ZWORK3 =ZEPS*ZWORK3 /(ZWORK1 -ZWORK3 )
  ZLV =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT-CST%XTT)
  ZLS =CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT-CST%XTT)
  ZCPH =CST%XCPD+CST%XCPV*ZWORK3 
  
  
  ZWORK3 =MIN (.1, MAX (0., ZWORK3 ))
  ZTHEUL =ZTLCL (JI)*ZPI **(1.-0.28*ZRVLCL (JI))*EXP ((3374.6525&
  &/ZTLCL (JI)-2.5403)*ZRVLCL (JI)*(1.+0.81*ZRVLCL (JI)))
  ZTHES1 =ZTELCL (JI)*ZPI **(1.-0.28*ZWORK3 )*EXP ((3374.6525&
  &/ZTELCL (JI)-2.5403)*ZWORK3 *(1.+0.81*ZWORK3 ))

  

  DO JK=IKB, JKMAX
    JKP=JK-1
    
    GWORK3 =JK>=ILCL (JI).AND.JK<=KCTL (JI).AND.GWORK1 (JI)
    ZPI =(CST%XP00/PPRES (JI, JK))**ZRDOCP
    ZWORK2 =PTHC (JI, JK)/ZPI 
    
    ZT=MIN (400., MAX (ZWORK2 , 10.))
    ZWORK3 =EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*ALOG (ZT))
    ZWORK3 =ZEPS*ZWORK3 /(PPRES (JI, JK)-ZWORK3 )
    ZLV =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT-CST%XTT)
    ZLS =CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT-CST%XTT)
    ZCPH =CST%XCPD+CST%XCPV*ZWORK3 

    

    

    

    

    IF (GWORK3 ) THEN
      ZTHES2 =ZWORK2 *ZPI **(1.-0.28*ZWORK3 )*EXP ((3374.6525/ZWORK2 -2.5403)*ZWORK3 *(1.+0.81*ZWORK3 ))

      IF (JK==ILCL (JI)) THEN
        ZWORK3 =PZ (JI, JK)-ZZLCL (JI)
      ELSE
        ZWORK3 =PZ (JI, JK)-PZ (JI, JKP)
      ENDIF

      ZWORK1 =(2.*ZTHEUL )/(ZTHES1 +ZTHES2 )-1.
      ZCAPE =ZCAPE +CST%XG*ZWORK3 *MAX (0., ZWORK1 )
      ZTHES1 =ZTHES2 
    ENDIF

  
  ENDDO


  

  IF (GWORK1 (JI)) THEN
    ZWORK1 =MAX (PCAPE (JI)-ZCAPE , 0.2*PCAPE (JI))
    ZWORK2 =ZCAPE /(PCAPE (JI)+1.E-8)
    GWORK1 (JI)=ZWORK2 >0.2.OR.ZCAPE ==0.
  ENDIF


  

  

  IF (ZCAPE ==0..AND.GWORK1 (JI)) THEN
    ZADJ (JI)=ZADJ (JI)*0.5
  ENDIF


  

  

  IF (ZCAPE /=0..AND.GWORK1 (JI)) THEN
    ZADJ (JI)=ZADJ (JI)*CVP_SHAL%XSTABC*PCAPE (JI)/(ZWORK1 +1.E-8)
  ENDIF

  
  
  ZADJ (JI)=MIN (ZADJ (JI), ZADJMAX )
  
  CALL CONVECT_CLOSURE_ADJUST_SHAL_OPENACC (CVPEXT, D, ZADJ&
  &, PUMF, ZUMF, PUER, ZUER, PUDR, ZUDR, YDSTACK=YLSTACK)
ENDDO


DO JK=IKB, IKE
  
  PRWC (JI, JK)=MAX (0., PRWC (JI, JK)-PRCC (JI, JK)-PRIC (JI, JK))
  
ENDDO





END SUBROUTINE CONVECT_CLOSURE_SHAL_OPENACC
