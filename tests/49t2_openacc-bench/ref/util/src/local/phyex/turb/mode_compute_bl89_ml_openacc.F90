MODULE MODE_COMPUTE_BL89_ML_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_BL89_ML_OPENACC (D, CST, CSTURB, PDZZ2D, PTKEM_DEP&
&, PG_O_THVREF, PVPT, KK, OUPORDN, OFLUX, PSHEAR, PLWORK, YDSTACK)
!$ACC ROUTINE (COMPUTE_BL89_ML_OPENACC) SEQ

USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_CTURB,ONLY:CSTURB_T
USE MODE_MSG
USE MODI_SHUMAN_MF,ONLY:DZM_MF, MZM_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZM_MF_OPENACC
USE MODI_SHUMAN_MF_OPENACC, ONLY : DZM_MF_OPENACC
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (CSTURB_T), INTENT (IN)::CSTURB
REAL, INTENT (IN)::PDZZ2D(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM_DEP(D%NIJT)
REAL, INTENT (IN)::PG_O_THVREF(D%NIJT)
REAL, INTENT (IN)::PVPT(D%NIJT, D%NKT)
INTEGER, INTENT (IN)::KK
LOGICAL, INTENT (IN)::OUPORDN
LOGICAL, INTENT (IN)::OFLUX
REAL, INTENT (OUT)::PLWORK(D%NIJT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL, INTENT (IN)::PSHEAR(D%NIJT, D%NKT)
REAL::ZLWORK2
REAL::ZLWORK1
REAL::ZPOTE
REAL::ZINTE
REAL::ZVPT_DEP
fxtran_acdc_temp (REAL, ZHLVPT, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZDELTVPT, (D%NIJT, D%NKT))
INTEGER::J1D
INTEGER::JKK
INTEGER::JK
INTEGER::JI
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKA
INTEGER::IKB
INTEGER::IKT
REAL::ZTESTM
REAL::ZTEST0
REAL::ZTEST


YLSTACK = YDSTACK



IF (KIND (ZHLVPT) == 8) THEN
    fxtran_acdc_alloc8 (ZHLVPT)
ELSEIF (KIND (ZHLVPT) == 4) THEN
    fxtran_acdc_alloc4 (ZHLVPT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDELTVPT) == 8) THEN
    fxtran_acdc_alloc8 (ZDELTVPT)
ELSEIF (KIND (ZDELTVPT) == 4) THEN
    fxtran_acdc_alloc4 (ZDELTVPT)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKA=D%NKA
IKE=D%NKE
IKL=D%NKL
CALL DZM_MF_OPENACC (D, PVPT (:,:), ZDELTVPT (:,:), YDSTACK=YLSTACK)
ZDELTVPT (JI, IKA)=0.

DO JK=1, IKT

  

  IF (ABS (ZDELTVPT (JI, JK))<CSTURB%XLINF) THEN
    ZDELTVPT (JI, JK)=CSTURB%XLINF
  ENDIF

  
ENDDO

CALL MZM_MF_OPENACC (D, PVPT (:,:), ZHLVPT (:,:), YDSTACK=YLSTACK)

ZDELTVPT (JI, IKB)=PDZZ2D (JI, IKB)*ZDELTVPT (JI, IKB+IKL)/PDZZ2D (JI, IKB+IKL)
ZHLVPT (JI, IKB)=PVPT (JI, IKB)-ZDELTVPT (JI, IKB)*0.5


IF (OUPORDN.EQV..TRUE.) THEN
  
  ZINTE =PTKEM_DEP (JI)
  
  PLWORK(JI)=0.
  ZTESTM=1.

  IF (OFLUX) THEN
    
    ZVPT_DEP =ZHLVPT (JI, KK)

    

    DO J1D=IIJB, IIJE
      ZTEST0=0.5+SIGN (0.5, ZINTE )
      ZPOTE =ZTEST0*(PG_O_THVREF (JI)*(0.5*(ZHLVPT (JI, KK)+PVPT (JI, KK))-ZVPT_DEP )+CSTURB&
      &%XRM17*PSHEAR (JI, KK)*SQRT (ABS (PTKEM_DEP (JI))))*PDZZ2D (JI, KK)*0.5
      ZTEST=0.5+SIGN (0.5, ZINTE -ZPOTE )
      ZLWORK1 =PDZZ2D (JI, KK)*0.5
      ZLWORK2 =(-PG_O_THVREF (JI)*(ZHLVPT (JI, KK)-ZVPT_DEP )-CSTURB%XRM17*PSHEAR (JI, KK)*SQRT&
      & (ABS (PTKEM_DEP (JI)))+SQRT (ABS ((CSTURB%XRM17*PSHEAR (JI, KK)*SQRT (ABS (PTKEM_DEP (JI&
      &)))+PG_O_THVREF (JI)*(ZHLVPT (JI, KK)-ZVPT_DEP ))**2+2.*ZINTE *PG_O_THVREF (JI)*ZDELTVPT&
      & (JI, KK)/PDZZ2D (JI, KK))))/(PG_O_THVREF (JI)*ZDELTVPT (JI, KK)/PDZZ2D (JI, KK))
      PLWORK (JI)=PLWORK (JI)+ZTEST0*(ZTEST*ZLWORK1 +(1-ZTEST)*ZLWORK2 )
      ZINTE =ZINTE -ZPOTE 
    ENDDO

  ELSE
    
    ZVPT_DEP =PVPT (JI, KK)
  
  ENDIF


  DO JKK=KK+IKL, IKE, IKL

    IF (ZTESTM>0.) THEN
      ZTESTM=0

      DO J1D=IIJB, IIJE
        ZTEST0=0.5+SIGN (0.5, ZINTE )
        ZPOTE =ZTEST0*(PG_O_THVREF (JI)*(ZHLVPT (JI, JKK)-ZVPT_DEP )+CSTURB%XRM17&
        &*PSHEAR (JI, JKK)*SQRT (ABS (PTKEM_DEP (JI))))*PDZZ2D (JI, JKK)
        ZTEST=0.5+SIGN (0.5, ZINTE -ZPOTE )
        ZTESTM=ZTESTM+ZTEST0
        ZLWORK1 =PDZZ2D (JI, JKK)
        ZLWORK2 =(-PG_O_THVREF (JI)*(PVPT (JI, JKK-IKL)-ZVPT_DEP )-CSTURB%XRM17*PSHEAR (JI, JKK)*SQRT&
        & (ABS (PTKEM_DEP (JI)))+SQRT (ABS ((CSTURB%XRM17*PSHEAR (JI, JKK)*SQRT (ABS (PTKEM_DEP (JI&
        &)))+PG_O_THVREF (JI)*(PVPT (JI, JKK-IKL)-ZVPT_DEP ))**2+2.*ZINTE *PG_O_THVREF (JI)*ZDELTVPT&
        & (JI, JKK)/PDZZ2D (JI, JKK))))/(PG_O_THVREF (JI)*ZDELTVPT (JI, JKK)/PDZZ2D (JI, JKK))
        PLWORK (JI)=PLWORK (JI)+ZTEST0*(ZTEST*ZLWORK1 +(1-ZTEST)*ZLWORK2 )
        ZINTE =ZINTE -ZPOTE 
      ENDDO

    ENDIF

  ENDDO

ENDIF


IF (OUPORDN.EQV..FALSE.) THEN

  IF (OFLUX)  THEN
    CALL FXTRAN_ACDC_ABORT ('OFLUX option not coded for downward mixing length')
  ENDIF

  
  ZINTE =PTKEM_DEP (JI)
  
  PLWORK(JI)=0.
  ZTESTM=1.

  DO JKK=KK, IKB,-IKL

    IF (ZTESTM>0.) THEN
      ZTESTM=0

      DO J1D=IIJB, IIJE
        ZTEST0=0.5+SIGN (0.5, ZINTE )
        ZPOTE =ZTEST0*(-PG_O_THVREF (JI)*(ZHLVPT (JI, JKK)-PVPT (JI, KK))+CSTURB&
        &%XRM17*PSHEAR (JI, JKK)*SQRT (ABS (PTKEM_DEP (JI))))*PDZZ2D (JI, JKK)
        ZTEST=0.5+SIGN (0.5, ZINTE -ZPOTE )
        ZTESTM=ZTESTM+ZTEST0
        ZLWORK1 =PDZZ2D (JI, JKK)
        ZLWORK2 =(+PG_O_THVREF (JI)*(PVPT (JI, JKK)-PVPT (JI, KK))-CSTURB%XRM17*PSHEAR (JI, JKK)*SQRT&
        & (ABS (PTKEM_DEP (JI)))+SQRT (ABS ((CSTURB%XRM17*PSHEAR (JI, JKK)*SQRT (ABS (PTKEM_DEP (JI&
        &)))-PG_O_THVREF (JI)*(PVPT (JI, JKK)-PVPT (JI, KK)))**2+2.*ZINTE *PG_O_THVREF (JI)*ZDELTVPT&
        & (JI, JKK)/PDZZ2D (JI, JKK))))/(PG_O_THVREF (JI)*ZDELTVPT (JI, JKK)/PDZZ2D (JI, JKK))
        PLWORK (JI)=PLWORK (JI)+ZTEST0*(ZTEST*ZLWORK1 +(1-ZTEST)*ZLWORK2 )
        ZINTE =ZINTE -ZPOTE 
      ENDDO

    ENDIF

  ENDDO

ENDIF


END SUBROUTINE COMPUTE_BL89_ML_OPENACC

ENDMODULE MODE_COMPUTE_BL89_ML_OPENACC
