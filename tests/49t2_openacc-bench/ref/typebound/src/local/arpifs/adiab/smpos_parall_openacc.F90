SUBROUTINE SMPOS_PARALL_OPENACC (YDGEOMETRY, YDMODEL, KST, KEND, PGEMU, PGELAM, PSOLO, YDSTACK)
!$ACC ROUTINE (SMPOS_PARALL_OPENACC) SEQ
USE TYPE_MODEL,ONLY:MODEL
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (MODEL), INTENT (IN)::YDMODEL
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
REAL (KIND=JPRB), INTENT (IN)::PGEMU (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (IN)::PGELAM (YDGEOMETRY%YRDIM%NPROMA)
REAL (KIND=JPRB), INTENT (OUT)::PSOLO (YDGEOMETRY%YRDIM%NPROMA)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::JROF
REAL (KIND=JPRB)::ZX_NOR
REAL (KIND=JPRB)::ZZ_EST
REAL (KIND=JPRB)::ZY_EST
REAL (KIND=JPRB)::ZX_EST
REAL (KIND=JPRB)::ZZ_MC
REAL (KIND=JPRB)::ZY_MC
REAL (KIND=JPRB)::ZX_MC
REAL (KIND=JPRB)::ZCOSPHI
REAL (KIND=JPRB)::ZNORME
REAL (KIND=JPRB)::ZZM
REAL (KIND=JPRB)::ZYM
REAL (KIND=JPRB)::ZXM
REAL (KIND=JPRB)::ZZ_ZEN
REAL (KIND=JPRB)::ZY_ZEN
REAL (KIND=JPRB)::ZX_ZEN
REAL (KIND=JPRB)::ZZ_NOR
REAL (KIND=JPRB)::ZY_NOR
REAL (KIND=JPRB)::ZEPSCL
REAL (KIND=JPRB)::ZCRIT_PART
REAL (KIND=JPRB)::ZCRIT_ANNU
REAL (KIND=JPRB)::ZCRIT_TOTA
REAL (KIND=JPRB)::ZCRIT_NONE
REAL (KIND=JPRB)::ZBINMOINSNEG
REAL (KIND=JPRB)::ZBINMOINSPOS
REAL (KIND=JPRB)::ZBINPLUS
REAL (KIND=JPRB)::ZDEGO_PART
REAL (KIND=JPRB)::ZYO
REAL (KIND=JPRB)::ZTHETAS
REAL (KIND=JPRB)::ZTHETAM
REAL (KIND=JPRB)::ZXO
REAL (KIND=JPRB)::ZDEGO_ANNU
REAL (KIND=JPRB)::ZDEGO_TOTA
REAL (KIND=JPRB)::ZDEGO_NONE
REAL (KIND=JPRB)::ZMOINS
REAL (KIND=JPRB)::ZPLUS
REAL (KIND=JPRB)::ZR
REAL (KIND=JPRB)::ZC
REAL (KIND=JPRB)::ZRADS
REAL (KIND=JPRB)::ZRADM
REAL (KIND=JPRB)::ZCL
REAL (KIND=JPRB)::ZZS
REAL (KIND=JPRB)::ZYS
REAL (KIND=JPRB)::ZXS


JROF = KST




ZEPSCL=1.E-4_JPRB

ZCOSPHI=SQRT (MAX (0._JPRB, 1._JPRB-PGEMU (JROF)**2))
ZX_MC=YDMODEL%YRML_GCONF%YRRIP%RLUNDI*COS (YDMODEL%YRML_GCONF%YRRIP%RDECLU)*COS (YDMODEL%YRCST&
&%RPI-YDMODEL%YRML_GCONF%YRRIP%RTMOLT)-YDMODEL%YRCST%RA*ZCOSPHI*COS (PGELAM (JROF))
ZY_MC=YDMODEL%YRML_GCONF%YRRIP%RLUNDI*COS (YDMODEL%YRML_GCONF%YRRIP%RDECLU)*SIN (YDMODEL%YRCST&
&%RPI-YDMODEL%YRML_GCONF%YRRIP%RTMOLT)-YDMODEL%YRCST%RA*ZCOSPHI*SIN (PGELAM (JROF))
ZZ_MC=YDMODEL%YRML_GCONF%YRRIP%RLUNDI*SIN (YDMODEL%YRML_GCONF&
&%YRRIP%RDECLU)-YDMODEL%YRCST%RA*PGEMU (JROF)
ZX_EST=-SIN (PGELAM (JROF))
ZY_EST=COS (PGELAM (JROF))
ZZ_EST=0._JPRB
ZX_NOR=-PGEMU (JROF)*COS (PGELAM (JROF))
ZY_NOR=-PGEMU (JROF)*SIN (PGELAM (JROF))
ZZ_NOR=ZCOSPHI
ZX_ZEN=ZCOSPHI*COS (PGELAM (JROF))
ZY_ZEN=ZCOSPHI*SIN (PGELAM (JROF))
ZZ_ZEN=PGEMU (JROF)
ZXM=ZX_MC*ZX_EST+ZY_MC*ZY_EST+ZZ_MC*ZZ_EST
ZYM=ZX_MC*ZX_NOR+ZY_MC*ZY_NOR+ZZ_MC*ZZ_NOR
ZZM=ZX_MC*ZX_ZEN+ZY_MC*ZY_ZEN+ZZ_MC*ZZ_ZEN
ZNORME=SQRT (ZXM*ZXM+ZYM*ZYM+ZZM*ZZM)
ZXM=ZXM/ZNORME
ZYM=ZYM/ZNORME
ZZM=ZZM/ZNORME
ZX_MC=YDMODEL%YRML_GCONF%YRRIP%RDEASO*COS (YDMODEL%YRML_GCONF%YRRIP%RDECLI)*COS (YDMODEL%YRCST&
&%RPI-YDMODEL%YRML_GCONF%YRRIP%RWSOVR)-YDMODEL%YRCST%RA*ZCOSPHI*COS (PGELAM (JROF))
ZY_MC=YDMODEL%YRML_GCONF%YRRIP%RDEASO*COS (YDMODEL%YRML_GCONF%YRRIP%RDECLI)*SIN (YDMODEL%YRCST&
&%RPI-YDMODEL%YRML_GCONF%YRRIP%RWSOVR)-YDMODEL%YRCST%RA*ZCOSPHI*SIN (PGELAM (JROF))
ZZ_MC=YDMODEL%YRML_GCONF%YRRIP%RDEASO*SIN (YDMODEL%YRML_GCONF&
&%YRRIP%RDECLI)-YDMODEL%YRCST%RA*PGEMU (JROF)
ZXS=ZX_MC*ZX_EST+ZY_MC*ZY_EST+ZZ_MC*ZZ_EST
ZYS=ZX_MC*ZX_NOR+ZY_MC*ZY_NOR+ZZ_MC*ZZ_NOR
ZZS=ZX_MC*ZX_ZEN+ZY_MC*ZY_ZEN+ZZ_MC*ZZ_ZEN
ZNORME=SQRT (ZXS*ZXS+ZYS*ZYS+ZZS*ZZS)
ZXS=ZXS/ZNORME
ZYS=ZYS/ZNORME
ZZS=ZZS/ZNORME
ZCL=ACOS (MAX (-1._JPRB, MIN (1._JPRB, ZXS*ZXM+ZYS*ZYM+ZZS*ZZM)))
ZRADM=1.7374E6_JPRB/YDMODEL%YRML_GCONF%YRRIP%RLUNDI
ZRADS=6.943E8_JPRB/YDMODEL%YRML_GCONF%YRRIP%RDEASO
ZC=ZCL/ZRADS
ZR=ZRADM/ZRADS
ZPLUS=ZC+ZR
ZMOINS=ZC-ZR
ZDEGO_NONE=0._JPRB
ZDEGO_TOTA=1._JPRB
ZDEGO_ANNU=ZR**2
ZXO=(1._JPRB+ZC**2-ZR**2)/(2._JPRB*MAX (ZEPSCL, ZC))
ZTHETAM=ACOS (MAX (-1._JPRB, MIN (1._JPRB,(ZC-ZXO)/ZR)))
ZTHETAS=ACOS (MAX (-1._JPRB, MIN (1._JPRB, ZXO)))
ZYO=SQRT (MAX (0._JPRB,-(ZMOINS**2-1._JPRB)*(ZPLUS**2-1._JPRB)))/(2._JPRB*MAX (ZEPSCL, ZC))
ZDEGO_PART=(ZTHETAM*ZR**2-(ZC-ZXO)*ZYO+ZTHETAS-ZXO*ZYO)/YDMODEL%YRCST%RPI
ZBINPLUS=MAX (0._JPRB, SIGN (1._JPRB, ZPLUS-1._JPRB))
ZBINMOINSPOS=MAX (0._JPRB, SIGN (1._JPRB, ZMOINS-1._JPRB))
ZBINMOINSNEG=MAX (0._JPRB, SIGN (1._JPRB, ZMOINS+1._JPRB))
ZCRIT_NONE=ZBINPLUS*ZBINMOINSPOS
ZCRIT_TOTA=ZBINPLUS*(1._JPRB-ZBINMOINSNEG)
ZCRIT_ANNU=(1._JPRB-ZBINPLUS)*ZBINMOINSNEG*(1._JPRB-ZBINMOINSPOS)
ZCRIT_PART=ZBINPLUS*ZBINMOINSNEG**(1._JPRB-ZBINMOINSPOS)
PSOLO (JROF)=MAX (0._JPRB, MIN (1._JPRB, ZCRIT_NONE*ZDEGO_NONE+(1._JPRB-ZCRIT_NONE)*(ZCRIT_TOTA*ZDEGO_TOTA&
&+(1._JPRB-ZCRIT_TOTA)*(ZCRIT_ANNU*ZDEGO_ANNU+(1._JPRB-ZCRIT_ANNU)*ZCRIT_PART*ZDEGO_PART))))




END SUBROUTINE SMPOS_PARALL_OPENACC
