
SUBROUTINE CONVECT_CLOSURE_THRVLCL_OPENACC (CVPEXT, CST, D, PPRES, PTH, PRV, PZ&
&, OWORK1, PTHLCL, PRVLCL, PZLCL, PTLCL, PTELCL, KLCL, KDPL, KPBL, YDSTACK)
!$ACC ROUTINE (CONVECT_CLOSURE_THRVLCL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_CST,ONLY:CST_T
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
REAL, INTENT (IN)::PTH(D%NIT, D%NKT)
REAL, INTENT (IN)::PRV(D%NIT, D%NKT)
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
INTEGER, INTENT (IN)::KDPL(D%NIT)
INTEGER, INTENT (IN)::KPBL(D%NIT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
LOGICAL, INTENT (IN)::OWORK1(D%NIT)
REAL, INTENT (OUT)::PTHLCL(D%NIT)
REAL, INTENT (OUT)::PRVLCL(D%NIT)
REAL, INTENT (OUT)::PZLCL(D%NIT)
REAL, INTENT (OUT)::PTLCL(D%NIT)
REAL, INTENT (OUT)::PTELCL(D%NIT)
INTEGER, INTENT (OUT)::KLCL(D%NIT)
INTEGER::JKMAX
INTEGER::JKMIN
INTEGER::JKM
INTEGER::JK
INTEGER::JI
INTEGER::IKE
INTEGER::IKB
REAL::ZEPS
REAL::ZRDOCP
REAL::ZCPORD
REAL::ZPLCL
REAL::ZTMIX
REAL::ZEVMIX
REAL::ZPRESMIX
REAL::ZDPTHMIX
REAL::ZCPH
REAL::ZLV
REAL::ZDP
REAL::ZWORK2
REAL::ZWORK1

REAL::ZT

JI = D%NIB


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
ZEPS=CST%XRD/CST%XRV
ZCPORD=CST%XCPD/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
ZDPTHMIX =0.
ZPRESMIX =0.
PTHLCL (JI)=300.
PTLCL (JI)=300.
PTELCL (JI)=300.
PRVLCL (JI)=0.
PZLCL (JI)=PZ (JI, IKB)
ZTMIX =230.
ZPLCL =1.E4
KLCL (JI)=IKB+1
JKMAX=IKE
JKMIN=IKB

DO JK=IKB+1, JKMAX
  JKM=JK+1

  

  IF (JK>=KDPL (JI).AND.JK<=KPBL (JI)) THEN
    ZWORK1 =PPRES (JI, JK)-PPRES (JI, JKM)
    ZDPTHMIX =ZDPTHMIX +ZWORK1 
    ZPRESMIX =ZPRESMIX +PPRES (JI, JK)*ZWORK1 
    PTHLCL (JI)=PTHLCL (JI)+PTH (JI, JK)*ZWORK1 
    PRVLCL (JI)=PRVLCL (JI)+PRV (JI, JK)*ZWORK1 
  ENDIF

  
ENDDO



IF (OWORK1 (JI)) THEN
  ZPRESMIX =ZPRESMIX /ZDPTHMIX 
  PTHLCL (JI)=PTHLCL (JI)/ZDPTHMIX 
  PRVLCL (JI)=PRVLCL (JI)/ZDPTHMIX 
  ZTMIX =PTHLCL (JI)*(ZPRESMIX /CST%XP00)**ZRDOCP
  ZEVMIX =PRVLCL (JI)*ZPRESMIX /(PRVLCL (JI)+ZEPS)
  ZEVMIX =MAX (1.E-8, ZEVMIX )
  ZWORK1 =ALOG (ZEVMIX /613.3)
  ZWORK1 =(4780.8-32.19*ZWORK1 )/(17.502-ZWORK1 )
  PTLCL (JI)=ZWORK1 -(.212+1.571E-3*(ZWORK1 -CST%XTT)-4.36E-4*(ZTMIX -CST%XTT))*(ZTMIX -ZWORK1 )
  PTLCL (JI)=MIN (PTLCL (JI), ZTMIX )
  ZPLCL =CST%XP00*(PTLCL (JI)/PTHLCL (JI))**ZCPORD
ENDIF



ZPLCL =MIN (2.E5, MAX (10., ZPLCL ))



ZT=MIN (400., MAX (PTLCL (JI), 10.))
ZWORK1 =EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*ALOG (ZT))
ZWORK1 =ZEPS*ZWORK1 /(ZPLCL -ZWORK1 )
ZLV =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT-CST%XTT)
ZWORK2 =CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT-CST%XTT)
ZCPH =CST%XCPD+CST%XCPV*ZWORK1 





IF (OWORK1 (JI)) THEN
  ZWORK2 =ZWORK1 /PTLCL (JI)*(CST%XBETAW/PTLCL (JI)-CST%XGAMW)
  ZWORK2 =(ZWORK1 -PRVLCL (JI))/(1.+ZLV /ZCPH *ZWORK2 )
  PTLCL (JI)=PTLCL (JI)-ZLV /ZCPH *ZWORK2 
ENDIF




ZT=MIN (400., MAX (ZTMIX , 10.))
ZWORK1 =EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*ALOG (ZT))
ZWORK1 =ZEPS*ZWORK1 /(ZPRESMIX -ZWORK1 )
ZLV =CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT-CST%XTT)
ZWORK2 =CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT-CST%XTT)
ZCPH =CST%XCPD+CST%XCPV*ZWORK1 





IF (OWORK1 (JI).AND.PRVLCL (JI)>ZWORK1 ) THEN
  ZWORK2 =ZWORK1 /ZTMIX *(CST%XBETAW/ZTMIX -CST%XGAMW)
  ZWORK2 =(ZWORK1 -PRVLCL (JI))/(1.+ZLV /ZCPH *ZWORK2 )
  PTLCL (JI)=ZTMIX +ZLV /ZCPH *ZWORK2 
  PRVLCL (JI)=PRVLCL (JI)-ZWORK2 
  ZPLCL =ZPRESMIX 
  PTHLCL (JI)=PTLCL (JI)*(CST%XP00/ZPLCL )**ZRDOCP
ENDIF



DO JK=JKMIN, IKE-1

  

  IF (ZPLCL <=PPRES (JI, JK).AND.OWORK1 (JI)) THEN
    KLCL (JI)=JK+1
    PZLCL (JI)=PZ (JI, JK+1)
  ENDIF

  
ENDDO


JK=KLCL (JI)
JKM=JK-1
ZDP =ALOG (ZPLCL /PPRES (JI, JKM))/ALOG (PPRES (JI, JK)/PPRES (JI, JKM))
ZWORK1 =PTH (JI, JK)*(PPRES (JI, JK)/CST%XP00)**ZRDOCP
ZWORK2 =PTH (JI, JKM)*(PPRES (JI, JKM)/CST%XP00)**ZRDOCP
ZWORK1 =ZWORK2 +(ZWORK1 -ZWORK2 )*ZDP 
ZWORK2 =PZ (JI, JKM)+(PZ (JI, JK)-PZ (JI, JKM))*ZDP 



IF (OWORK1 (JI)) THEN
  PTELCL (JI)=ZWORK1 
  PZLCL (JI)=ZWORK2 
ENDIF






END SUBROUTINE CONVECT_CLOSURE_THRVLCL_OPENACC
