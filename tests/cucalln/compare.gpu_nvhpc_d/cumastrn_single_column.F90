SUBROUTINE CUMASTRN_SINGLE_COLUMN (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN, YDML_PHY_EC,&
& YGFL, KIDIA, KFDIA, KLON, KLEV, PDX, LDTDKMF, KSPPN2D, LDLAND, PTSPHY, PTEN, PQEN, PUEN, PVEN&
&, PLITOT, PVERVEL, PQSEN, PQHFL, PAHFS, PAP, PAPH, PGEO, PGEOH, PGAW, PCUCONVCA, PGP2DSPP, PTENT&
&, PTENQ, PTENU, PTENV, LDCUM, KTYPE, KCBOT, KCTOP, KBOTSC, LDSC, LDSHCV, PLCRIT_AER, PTU, PQU&
&, PLU, PLUDE, PLUDELI, PSNDE, PENTH, PMFLXR, PMFLXS, PRAIN, PLRAIN, PRSUD, PMFU, PMFD, PMFUDE_RATE&
&, PMFDDE_RATE, PCAPE, PWMEAN, PDISS, KTRAC, PCEN, PTENC, PSCAV, YDSTACK)
!$acc routine (CUMASTRN_SINGLE_COLUMN) seq
USE MODEL_PHYSICS_ECMWF_MOD,ONLY:MODEL_PHYSICS_ECMWF_TYPE
USE MODEL_PHYSICS_SIMPLINEAR_MOD,ONLY:MODEL_PHYSICS_SIMPLINEAR_TYPE
USE YOM_YGFL,ONLY:TYPE_GFLD
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE SPP_MOD,ONLY:YSPP_CONFIG, YSPP
USE YOMCAPE,ONLY:LMCAPEA
USE STACK_MOD
#include "stack.h"

IMPLICIT NONE

REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_ECMWF_TYPE), INTENT (IN)::YDML_PHY_EC
TYPE (MODEL_PHYSICS_SIMPLINEAR_TYPE), INTENT (IN)::YDML_PHY_SLIN
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KSPPN2D
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTRAC
LOGICAL, INTENT (IN)::LDLAND (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PLCRIT_AER (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLITOT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVERVEL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQHFL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAHFS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCUCONVCA (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, KSPPN2D)
REAL (KIND=JPRB), INTENT (IN)::PCEN (KLON, KLEV, KTRAC)
REAL (KIND=JPRB), INTENT (IN)::PSCAV (KTRAC)
TYPE(STACK) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (IN)::PDX (KLON)
LOGICAL, INTENT (IN)::LDTDKMF
REAL (KIND=JPRB), INTENT (INOUT)::PTENT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENC (KLON, KLEV, KTRAC)
LOGICAL, INTENT (OUT)::LDCUM (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KCTOP (KLON)
INTEGER (KIND=JPIM), INTENT (OUT)::KBOTSC (KLON)
LOGICAL, INTENT (OUT)::LDSC (KLON)
LOGICAL, INTENT (IN)::LDSHCV (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLUDELI (KLON, KLEV, 4)
REAL (KIND=JPRB), INTENT (OUT)::PSNDE (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PENTH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXR (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PMFLXS (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PRAIN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLRAIN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSUD (KLON, KLEV, 2)
REAL (KIND=JPRB), INTENT (OUT)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFUDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PMFDDE_RATE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMEAN (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDISS (KLON, KLEV)

temp (REAL (KIND=JPRB), ZKINED, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZKINEU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZVD, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZUD, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZVU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZUU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZRFL, (KLON))
temp (REAL (KIND=JPRB), ZMFUL, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDMFDP, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDMFUP, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFDQ, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUQ, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFDS, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUS, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZQD, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZTD, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZQSENH, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZQENH, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZTENH, (KLON, KLEV))

REAL (KIND=JPRB)::ZMFCFL 
REAL (KIND=JPRB)::ZFACCA 
REAL (KIND=JPRB)::ZDQCV 
REAL (KIND=JPRB)::ZKHFL 
REAL (KIND=JPRB)::ZKHVFL 
REAL (KIND=JPRB)::ZMFUB1 
temp (REAL (KIND=JPRB), ZMFUB, (KLON))

temp (REAL (KIND=JPRB), ZLGLAC, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDPMEL, (KLON, KLEV))

temp (REAL (KIND=JPRB), ZWUBASE, (KLON))
REAL (KIND=JPRB)::ZDHPBL 

temp (REAL (KIND=JPRB), ZDMFDE, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDMFEN, (KLON, KLEV))

temp (INTEGER (KIND=JPIM), ICTOP0, (KLON))
temp (INTEGER (KIND=JPIM), IDTOP, (KLON))
temp (INTEGER (KIND=JPIM), ILAB, (KLON, KLEV))
temp (INTEGER (KIND=JPIM), IDPL, (KLON))

REAL (KIND=JPRB)::ZCAPDCYCL 
REAL (KIND=JPRB)::ZCAPPBL 
REAL (KIND=JPRB)::ZHEAT 
REAL (KIND=JPRB)::ZCAPE 

temp (LOGICAL, LLDCUM, (KLON))
temp (LOGICAL, LLDDRAF3, (KLON))
temp (LOGICAL, LLDDRAF, (KLON))

LOGICAL::LLMIXS
LOGICAL::LLO2 
LOGICAL::LLO1

INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ITOPM2
INTEGER (KIND=JPIM)::IKD
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IPRTAU

REAL (KIND=JPRB)::ZAK
REAL (KIND=JPRB)::ZBS
REAL (KIND=JPRB)::ZBR
REAL (KIND=JPRB)::ZAS
REAL (KIND=JPRB)::ZAR
REAL (KIND=JPRB)::ZDX
REAL (KIND=JPRB)::ZTAURES
REAL (KIND=JPRB)::ZTDIS
REAL (KIND=JPRB)::ZDVTEN
REAL (KIND=JPRB)::ZDUTEN
REAL (KIND=JPRB)::ZRDOCPD
REAL (KIND=JPRB)::ZORCPD
REAL (KIND=JPRB)::ZDERATE
REAL (KIND=JPRB)::ZERATE
REAL (KIND=JPRB)::ZMFA
REAL (KIND=JPRB)::ZRO
REAL (KIND=JPRB)::ZQUMQE2
REAL (KIND=JPRB)::ZQUMQE
REAL (KIND=JPRB)::ZPBMPT
REAL (KIND=JPRB)::ZMFMAX
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZEPS
REAL (KIND=JPRB)::ZDZ
REAL (KIND=JPRB)::ZDQMIN
REAL (KIND=JPRB)::ZDH2
REAL (KIND=JPRB)::ZDH
REAL (KIND=JPRB)::ZCONS
REAL (KIND=JPRB)::ZCONS2

REAL (KIND=JPRB)::ZTAUPBL 
REAL (KIND=JPRB)::ZTAU 

REAL (KIND=JPRB)::ZMU_TAU
REAL (KIND=JPRB)::ZXTAU 

REAL (KIND=JPRB)::ZSUM22 
REAL (KIND=JPRB)::ZSUM12 
temp (REAL (KIND=JPRB), ZUV2, (KLON, KLEV))
REAL (KIND=JPRB)::ZSCAV (KTRAC)
temp (REAL (KIND=JPRB), ZDMFDPC, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDMFUPC, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZKMFL, (KLON))
REAL (KIND=JPRB)::ZMF_SHAL 
REAL (KIND=JPRB)::ZMFUVB 
REAL (KIND=JPRB)::ZMFUUB 
temp (REAL (KIND=JPRB), ZTENV, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZTENU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFDDR, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUDR, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFDUS, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUUS, (KLON, KLEV))
REAL (KIND=JPRB)::ZMFS 

#include "cuascn_single_column.intfb.h"
#include "cubasen_single_column.intfb.h"
#include "cuddrafn_single_column.intfb.h"
#include "cudlfsn_single_column.intfb.h"
#include "cudtdqn_single_column.intfb.h"
#include "cududv_single_column.intfb.h"
#include "cuflxn_single_column.intfb.h"
#include "cuinin_single_column.intfb.h"
#include "cuctracer_single_column.intfb.h"
#include "fcttre.func.h"

YLSTACK = YDSTACK

alloc (ZKINED)
alloc (ZKINEU)
alloc (ZVD)
alloc (ZUD)
alloc (ZVU)
alloc (ZUU)
alloc (ZRFL)
alloc (ZMFUL)
alloc (ZDMFDP)
alloc (ZDMFUP)
alloc (ZMFDQ)
alloc (ZMFUQ)
alloc (ZMFDS)
alloc (ZMFUS)
alloc (ZQD)
alloc (ZTD)
alloc (ZQSENH)
alloc (ZQENH)
alloc (ZTENH)
alloc (ZMFUB)
alloc (ZLGLAC)
alloc (ZDPMEL)
alloc (ZWUBASE)
alloc (ZDMFDE)
alloc (ZDMFEN)
alloc (ICTOP0)
alloc (IDTOP)
alloc (ILAB)
alloc (IDPL)
alloc (LLDCUM)
alloc (LLDDRAF3)
alloc (LLDDRAF)
alloc (ZUV2)
alloc (ZDMFDPC)
alloc (ZDMFUPC)
alloc (ZKMFL)
alloc (ZTENV)
alloc (ZTENU)
alloc (ZMFDDR)
alloc (ZMFUDR)
alloc (ZMFDUS)
alloc (ZMFUUS)



JLON = KIDIA


ZCONS2=YDML_PHY_EC%YRECUMF%RMFCFL/(YDCST%RG*PTSPHY)
ZCONS=1.0_JPRB/(YDCST%RG*PTSPHY)
ZORCPD=1.0_JPRB/YDCST%RCPD
ZRDOCPD=YDCST%RD*ZORCPD
ZTAU =0.0


PCAPE (JLON)=0.0_JPRB
LDCUM (JLON)=.FALSE.

CALL CUININ_SINGLE_COLUMN (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA&
&, KFDIA, KLON, KLEV, PTEN, PQEN, PQSEN, PUEN, PVEN, PGEO, PAPH, ILAB, ZTENH, ZQENH, ZQSENH&
&, PGEOH, PTU, PQU, ZTD, ZQD, ZUU, ZVU, ZUD, ZVD, PLU, YDSTACK=YLSTACK)
ZKMFL (JLON)=0.0_JPRB
LLMIXS=LDTDKMF
CALL CUBASEN_SINGLE_COLUMN (PPLDARE, PPLRG, YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP&
&, YDML_PHY_EC%YRECUMF, KIDIA, KFDIA, KLON, KLEV, KSPPN2D, YDML_PHY_EC%YRECUMF%NJKT1, LLMIXS, LDTDKMF&
&, ZTENH, ZQENH, PGEOH, PAPH, PQHFL, PAHFS, PGP2DSPP, ZKMFL, PTEN, PQEN, PQSEN, PGEO, PTU, PQU, PLU&
&, ZKINEU, ZWUBASE, ILAB, LDCUM, LDSC, KCBOT, KBOTSC, ICTOP0, IDPL, PCAPE, YDSTACK=YLSTACK)

ZDQCV =0.0_JPRB
ZDHPBL =0.0_JPRB
IDTOP (JLON)=0
ZCAPPBL =0.
ZKHVFL =(-PAHFS (JLON, KLEV+1)*ZORCPD-YDCST%RETV*PTEN &
&(JLON, KLEV)*PQHFL (JLON, KLEV+1))/(PPLRG*PPLDARE)
ZKHFL =(-PAHFS (JLON, KLEV+1)-YDCST%RLVTT*PQHFL (JLON, KLEV+1))/(PPLRG*PPLDARE)


DO JK=YDML_PHY_EC%YRECUMF%NJKT2, KLEV
  
  ZDQCV =ZDQCV +MAX (0.0_JPRB, PTENQ (JLON, JK))*(PAPH (JLON, JK+1)-PAPH (JLON, JK))

  IF (LDCUM (JLON).AND.JK>=KCBOT (JLON)) THEN
    ZDZ=(PAPH (JLON, JK+1)-PAPH (JLON, JK))
    ZDHPBL =ZDHPBL +(YDCST%RLVTT*PTENQ (JLON, JK)+YDCST%RCPD*PTENT (JLON, JK))*ZDZ
    ZCAPPBL =ZCAPPBL +(PTENT (JLON, JK)+YDCST%RETV*PTEN (JLON, JK)*PTENQ (JLON, JK))*ZDZ
  ENDIF

  
ENDDO



IF (LDCUM (JLON)) THEN
  IKB=KCBOT (JLON)
  ITOPM2=ICTOP0 (JLON)
  ZPBMPT=PAPH (JLON, IKB)-PAPH (JLON, ITOPM2)

  IF (ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS) THEN
    KTYPE (JLON)=1
  ELSE
    KTYPE (JLON)=2
  ENDIF

ELSE
  KTYPE (JLON)=0
ENDIF



IF (YDML_PHY_EC%YRECUMF%LMFWSTAR) THEN

  

  IF (LDCUM (JLON)) THEN
    IKB=KCBOT (JLON)
    ZDZ=MAX (0.0_JPRB, MIN (1.5E3_JPRB,(PGEOH (JLON, IKB)-PGEOH (JLON, KLEV+1))/YDCST%RG))
    ZMF_SHAL =0.07_JPRB*(YDCST%RG/PTEN (JLON, KLEV)*ZDZ*MAX (0.0_JPRB, ZKHVFL ))**.3333
    ZMFMAX=(PAPH (JLON, IKB)-PAPH (JLON, IKB-1))*ZCONS2
    ZMF_SHAL =MIN (ZMF_SHAL , ZMFMAX)
  ENDIF

  
ENDIF



IF (LDCUM (JLON)) THEN
  IKB=KCBOT (JLON)
  ZMFMAX=(PAPH (JLON, IKB)-PAPH (JLON, IKB-1))*ZCONS2

  IF (KTYPE (JLON)==1) THEN
    ZMFUB (JLON)=ZMFMAX*0.1_JPRB
  ELSEIF (KTYPE (JLON)==2) THEN
    ZQUMQE=PQU (JLON, IKB)+PLU (JLON, IKB)-ZQENH (JLON, IKB)
    ZDQMIN=MAX (0.01_JPRB*ZQENH (JLON, IKB), 1.E-10_JPRB)
    ZDH=YDCST%RCPD*(PTU (JLON, IKB)-ZTENH (JLON, IKB))+YDCST%RLVTT*ZQUMQE
    ZDH=YDCST%RG*MAX (ZDH, 1.E5_JPRB*ZDQMIN)

    IF (ZDHPBL >0.0_JPRB) THEN
      ZMFUB (JLON)=ZDHPBL /ZDH
      ZMFUB (JLON)=MIN (ZMFUB (JLON), ZMFMAX)
    ELSE
      ZMFUB (JLON)=ZMFMAX*0.1_JPRB
      LDCUM (JLON)=.FALSE.
    ENDIF


    IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
        ZMFUB (JLON)=ZMF_SHAL 
    ENDIF

  ENDIF

ELSE
  ZMFUB (JLON)=0.0_JPRB
ENDIF


CALL CUASCN_SINGLE_COLUMN (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECLDP, YDML_PHY_EC%YRECUMF&
&, YGFL, KIDIA, KFDIA, KLON, KLEV, KSPPN2D, LDTDKMF, PTSPHY, ZTENH, ZQENH, PUEN, PVEN, PTEN, PQEN&
&, PQSEN, PLITOT, PGEO, PGEOH, PAP, PAPH, PVERVEL, ZWUBASE, PGP2DSPP, LDLAND, LDCUM, KTYPE, ILAB,&
& PTU, PQU, PLU, PLRAIN, PMFU, ZMFUB, ZLGLAC, ZMFUS, ZMFUQ, ZMFUL, PLUDE, PLUDELI, ZDMFUP, PLCRIT_AER&
&, ZDMFEN, KCBOT, KCTOP, ICTOP0, IDPL, PMFUDE_RATE, ZKINEU, PWMEAN, YDSTACK=YLSTACK)


IF (LDCUM (JLON)) THEN
  IKB=KCBOT (JLON)
  ITOPM2=KCTOP (JLON)
  ZPBMPT=PAPH (JLON, IKB)-PAPH (JLON, ITOPM2)

  IF (KTYPE (JLON)==1.AND.ZPBMPT<YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
      KTYPE (JLON)=2
  ENDIF


  IF (KTYPE (JLON)==2.AND.ZPBMPT>=YDML_PHY_EC%YRECUMF%RDEPTHS)  THEN
      KTYPE (JLON)=1
  ENDIF

  ICTOP0 (JLON)=KCTOP (JLON)
ENDIF

ZRFL (JLON)=ZDMFUP (JLON, 1)


DO JK=2, KLEV
  
  ZRFL (JLON)=ZRFL (JLON)+ZDMFUP (JLON, JK)
  
ENDDO


DO JK=1, KLEV
  
  PMFD (JLON, JK)=0.0_JPRB
  ZMFDS (JLON, JK)=0.0_JPRB
  ZMFDQ (JLON, JK)=0.0_JPRB
  ZDMFDP (JLON, JK)=0.0_JPRB
  ZDPMEL (JLON, JK)=0.0_JPRB
  
ENDDO


IF (YDML_PHY_EC%YRECUMF%LMFUVDIS) THEN

  DO JK=1, KLEV
    
    ZTENU (JLON, JK)=PTENU (JLON, JK)
    ZTENV (JLON, JK)=PTENV (JLON, JK)
  
  ENDDO

ENDIF


IF (YDML_PHY_EC%YRECUMF%LMFDD) THEN
  CALL CUDLFSN_SINGLE_COLUMN (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA,&
  & KFDIA, KLON, KLEV, KCBOT, KCTOP, LDCUM, ZTENH, ZQENH, PTEN, PQSEN, PGEO, PGEOH, PAPH, PTU,&
  & PQU, ZMFUB, ZRFL, ZTD, ZQD, PMFD, ZMFDS, ZMFDQ, ZDMFDP, IDTOP, LLDDRAF, YDSTACK=YLSTACK)
  CALL CUDDRAFN_SINGLE_COLUMN (YDCST, YDTHF, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF, KIDIA&
  &, KFDIA, KLON, KLEV, LLDDRAF, ZTENH, ZQENH, PQSEN, PGEO, PGEOH, PAPH, ZRFL, ZTD, ZQD, PMFU&
  &, PMFD, ZMFDS, ZMFDQ, ZDMFDP, ZDMFDE, PMFDDE_RATE, ZKINED, YDSTACK=YLSTACK)
ENDIF


ZHEAT =0.0_JPRB
ZCAPE =0.0_JPRB
ZMFUB1 =ZMFUB (JLON)


DO JK=1, KLEV
  
  LLO1=LDCUM (JLON).AND.KTYPE (JLON)==1

  IF (LLO1.AND.JK<=KCBOT (JLON).AND.JK>KCTOP (JLON)) THEN
    ZDZ=(PGEOH (JLON, JK-1)-PGEOH (JLON, JK))

    IF (LDTDKMF) THEN
      ZHEAT =ZHEAT +((PTEN (JLON, JK-1)-PTEN (JLON, JK)+ZDZ*ZORCPD)/ZTENH (JLON, JK)+YDCST%RETV&
      &*(PQEN (JLON, JK-1)-PQEN (JLON, JK)))*(YDCST%RG*(PMFU (JLON, JK)+PMFD (JLON, JK)))
    ELSE
      ZHEAT =ZHEAT +MAX (0.0_JPRB,((PTEN (JLON, JK-1)-PTEN (JLON, JK)+ZDZ*ZORCPD)/ZTENH (JLON, JK)+YDCST&
      &%RETV*(PQEN (JLON, JK-1)-PQEN (JLON, JK)))*(YDCST%RG*(PMFU (JLON, JK)+PMFD (JLON, JK))))
    ENDIF

    ZDZ=(PAPH (JLON, JK)-PAPH (JLON, JK-1))
    ZCAPE =ZCAPE +((PTU (JLON, JK)-ZTENH (JLON, JK))/ZTENH (JLON, JK)+YDCST&
    &%RETV*(PQU (JLON, JK)-ZQENH (JLON, JK))-PLU (JLON, JK))*ZDZ
  ENDIF

  
ENDDO


ZCAPDCYCL =0.0_JPRB
ZTAU =0.0_JPRB

IF (LDTDKMF) THEN
  ZDX=PDX (JLON)
ELSE
  ZDX=2*YDCST%RA*SQRT (YDCST%RPI*PGAW (JLON))
ENDIF

ZDX=MAX (ZDX, 1.E2_JPRB)

IF (LDCUM (JLON).AND.KTYPE (JLON)==1) THEN

  IF (YDML_PHY_EC%YRECUMF%LNEWTAU) THEN
    ZTAURES=YDML_PHY_EC%YRECUMF%RTAULIM*(1._JPRB+YDML_PHY_EC%YRECUMF%RTAUFAC&
    &/((ZDX/1000._JPRB-YDML_PHY_EC%YRECUMF%RXMIN+1._JPRB)**2))
  ELSE
    ZTAURES=1.0_JPRB+1.60_JPRB*ZDX/125.E3_JPRB

    IF (ZDX<8.E3_JPRB) THEN
      ZTAURES=1.0_JPRB+(LOG (10.E3_JPRB/ZDX))**2
    ENDIF

  ENDIF


  IF (ZDX>125.E3_JPRB)  THEN
      ZTAURES=MIN (3.0_JPRB, ZTAURES)
  ENDIF

  IKD=IDPL (JLON)
  IKB=KCBOT (JLON)
  IK=KCTOP (JLON)
  ZTAU =(PGEOH (JLON, IK)-PGEOH (JLON, IKB))/((2.0_JPRB+MIN (15.0_JPRB&
  &, PWMEAN (JLON)))*YDCST%RG)*ZTAURES*YDML_PHY_EC%YRECUMF%RTAUA
  
  ZXTAU =ZTAU 
  
  LLO1=PAPH (JLON, KLEV+1)-PAPH (JLON, IKD)<50.E2_JPRB

  IF (LLO1.AND.LDLAND (JLON).AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==1.0_JPRB) THEN
    ZDZ=MIN (1.E4_JPRB, PGEOH (JLON, IKB)-PGEOH (JLON, KLEV+1))/YDCST%RG
    ZCAPDCYCL =ZXTAU *MAX (0.0_JPRB, ZKHVFL )*YDCST%RCPD/ZDZ
  ENDIF


  IF (LLO1.AND.YDML_PHY_EC%YRECUMF%RCAPDCYCL==2.0_JPRB) THEN

    IF (LDLAND (JLON)) THEN
      ZCAPDCYCL =ZCAPPBL *ZTAU /ZTAURES
    ELSE
      ZDUTEN=2.0_JPRB+SQRT (0.5*(PUEN (JLON, IKB)**2+PVEN (JLON, IKB)**2+PUEN (JLON,&
      & YDML_PHY_EC%YRECUMF%NJKT3)**2+PVEN (JLON, YDML_PHY_EC%YRECUMF%NJKT3)**2))
      ZTAUPBL =MIN (1.E4_JPRB, PGEOH (JLON, IKB)-PGEOH (JLON, KLEV+1))/(YDCST%RG*ZDUTEN)
      ZCAPDCYCL =ZCAPPBL *ZTAUPBL 
    ENDIF

  ENDIF

ELSE
  ZTAU =0.0_JPRB
ENDIF



IF (YDML_PHY_EC%YRECUMF%LMFCUCA) THEN
  
  ZFACCA =MAX (0.3_JPRB, MIN (1.8_JPRB, PCUCONVCA (JLON)))
  
ELSE
  ZFACCA =1.0_JPRB
ENDIF



IF (LDCUM (JLON).AND.KTYPE (JLON)==1) THEN
  IKB=KCBOT (JLON)

  IF (LDTDKMF) THEN
    ZCAPE =MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE , ZCAPE -ZCAPDCYCL )
  ELSE
    ZCAPE =MAX (YDML_PHY_EC%YRECUMF%RMINCAPE*ZCAPE , MIN (2*ZCAPE , ZCAPE -ZCAPDCYCL ))
  ENDIF

  ZCAPE =MIN (ZCAPE , 5000.0_JPRB)
  ZHEAT =MAX (1.E-4_JPRB, ZHEAT )
  ZXTAU =MAX (3.6E3_JPRB/(5.0_JPRB*PPLRG*PPLDARE), MIN (3.0_JPRB*3.6E3_JPRB/(PPLRG*PPLDARE), ZXTAU ))
  ZMFUB1 =(ZCAPE *ZMFUB (JLON))/(ZHEAT *ZXTAU )
  ZMFUB1 =MAX (ZMFUB1 , 0.001_JPRB)*ZFACCA 
  ZMFMAX=(PAPH (JLON, IKB)-PAPH (JLON, IKB-1))*ZCONS2
  ZMFUB1 =MIN (ZMFUB1 , ZMFMAX)
ENDIF





IF (LDCUM (JLON).AND.KTYPE (JLON)>=2) THEN
  IKB=KCBOT (JLON)

  IF (PMFD (JLON, IKB)<0.0_JPRB) THEN
    ZEPS=-PMFD (JLON, IKB)/MAX (ZMFUB (JLON), 1.E-10_JPRB)
  ELSE
    ZEPS=0.0_JPRB
  ENDIF

  ZMFMAX=(PAPH (JLON, IKB)-PAPH (JLON, IKB-1))*ZCONS2

  IF (KTYPE (JLON)==2) THEN

    IF (ZDHPBL >0.0_JPRB) THEN
      ZQUMQE=PQU (JLON, IKB)+PLU (JLON, IKB)-ZEPS*ZQD (JLON, IKB)-(1.0_JPRB-ZEPS)*ZQENH (JLON, IKB)
      ZDH=YDCST%RCPD*(PTU (JLON, IKB)-ZEPS*ZTD (JLON, IKB)-(1&
      &.0_JPRB-ZEPS)*ZTENH (JLON, IKB))+YDCST%RLVTT*ZQUMQE
      ZDH2=YDCST%RCPD*(PTU (JLON, IKB-1)-ZEPS*ZTD (JLON, IKB-1)-&
      &(1.0_JPRB-ZEPS)*ZTENH (JLON, IKB-1))+YDCST%RLVTT*ZQUMQE
      ZDH=0.5_JPRB*(ZDH+ZDH2)
      ZDH=YDCST%RG*MAX (ZDH, 0.1_JPRB*YDCST%RCPD)
      ZMFUB1 =ZDHPBL /ZDH

      IF (.NOT.LDTDKMF) THEN

        IF (ZMFUB1 >0.9_JPRB*ZMFMAX/YDML_PHY_EC%YRECUMF%RMFCFL.AND.ZDH<0.5_JPRB*YDCST%RG*YDCST%RCPD) THEN
          ZDH=0.75_JPRB*YDCST%RCPD*YDCST%RG
          ZMFUB1 =ZDHPBL /ZDH
        ENDIF

      ENDIF

    ELSE
      ZMFUB1 =ZMFUB (JLON)
    ENDIF


    IF (YDML_PHY_EC%YRECUMF%LMFWSTAR)  THEN
        ZMFUB1 =ZMF_SHAL 
    ENDIF

    ZMFUB1 =MIN (ZMFUB1 , ZMFMAX)
  ENDIF


  IF (KTYPE (JLON)==3) THEN

    IF (LDTDKMF) THEN
      ZMFUB1 =MAX (ZMFUB (JLON), ZKHFL /PGEOH (JLON, IKB))*(1.0_JPRB+ZEPS)
    ELSE
      ZMFUB1 =MAX (ZMFUB (JLON), 5*ZKHFL /PGEOH (JLON, IKB))*(1.0_JPRB+ZEPS)
    ENDIF

    ZMFUB1 =MIN (ZMFUB1 , ZMFMAX)
  ENDIF

ENDIF



DO JK=1, KLEV

  

  IF (LLDDRAF (JLON).AND.(KTYPE (JLON)==1.OR.KTYPE (JLON)==2)) THEN
    ZFAC=ZMFUB1 /MAX (ZMFUB (JLON), 1.E-10_JPRB)
    PMFD (JLON, JK)=PMFD (JLON, JK)*ZFAC
    ZMFDS (JLON, JK)=ZMFDS (JLON, JK)*ZFAC
    ZMFDQ (JLON, JK)=ZMFDQ (JLON, JK)*ZFAC
    ZDMFDP (JLON, JK)=ZDMFDP (JLON, JK)*ZFAC
    PMFDDE_RATE (JLON, JK)=PMFDDE_RATE (JLON, JK)*ZFAC
  ENDIF

  
ENDDO



IF (LDCUM (JLON)) THEN
  ZMFS =ZMFUB1 /MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUB (JLON))
ENDIF



DO JK=2, KLEV

  

  IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
    IKB=KCBOT (JLON)

    IF (JK>IKB) THEN
      ZDZ=((PAPH (JLON, KLEV+1)-PAPH (JLON, JK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IKB)))
      PMFU (JLON, JK)=PMFU (JLON, IKB)*ZDZ
    ENDIF

    ZMFMAX=(PAPH (JLON, JK)-PAPH (JLON, JK-1))*ZCONS2

    IF (.NOT.LDTDKMF)  THEN
        ZMFMAX=MIN (ZMFMAX, YDML_PHY_EC%YRECUMF%RMFLIA)
    ENDIF


    IF (PMFU (JLON, JK)*ZMFS >ZMFMAX) THEN
      ZMFS =MIN (ZMFS , ZMFMAX/PMFU (JLON, JK))
      ZMFS =MAX (ZMFS , 1.E-10_JPRB)
    ENDIF

  ENDIF

  
ENDDO


IF (YDML_PHY_EC%YRECUMF%RMFADVW>0.0_JPRB) THEN

  DO JK=2, KLEV-1

    

    IF (KTYPE (JLON)==1.AND.JK>=KCTOP (JLON)-1) THEN
      ZFAC=ZMFS *YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JLON, JK)-PMFU (JLON, JK+1)+YDML_PHY_EC%YRECUMF&
      &%RMFADVWDD*(PMFD (JLON, JK)-PMFD (JLON, JK+1)))/(PAPH (JLON, JK)-PAPH (JLON, JK+1))*PTSPHY

      IF (ABS (ZFAC)>0.98_JPRB)  THEN
          ZMFS =ZMFS /MAX (1.02_JPRB, ABS (ZFAC))
      ENDIF

    ENDIF

  
  ENDDO

  JK=KLEV

  

  IF (KTYPE (JLON)==1) THEN
    ZFAC=ZMFS *YDCST%RG*YDML_PHY_EC%YRECUMF%RMFADVW*(PMFU (JLON, JK)+YDML_PHY_EC%YRECUMF&
    &%RMFADVWDD*PMFD (JLON, JK))/(PAPH (JLON, JK)-PAPH (JLON, JK+1))*PTSPHY

    IF (ABS (ZFAC)>0.98_JPRB)  THEN
        ZMFS =ZMFS /MAX (1.02_JPRB, ABS (ZFAC))
    ENDIF

  ENDIF

  
ENDIF


DO JK=2, KLEV

  

  IF (LDCUM (JLON).AND.JK<=KCBOT (JLON).AND.JK>=KCTOP (JLON)-1) THEN
    PMFU (JLON, JK)=PMFU (JLON, JK)*ZMFS 
    ZMFUS (JLON, JK)=ZMFUS (JLON, JK)*ZMFS 
    ZMFUQ (JLON, JK)=ZMFUQ (JLON, JK)*ZMFS 
    ZMFUL (JLON, JK)=ZMFUL (JLON, JK)*ZMFS 
    ZDMFUP (JLON, JK)=ZDMFUP (JLON, JK)*ZMFS 
    ZDMFEN (JLON, JK)=ZDMFEN (JLON, JK)*ZMFS 
    PLUDE (JLON, JK)=PLUDE (JLON, JK)*ZMFS 
    PLUDELI (JLON, JK, 1)=PLUDELI (JLON, JK, 1)*ZMFS 
    PLUDELI (JLON, JK, 2)=PLUDELI (JLON, JK, 2)*ZMFS 
    PMFUDE_RATE (JLON, JK)=PMFUDE_RATE (JLON, JK)*ZMFS 
  ENDIF

  
ENDDO



IF (KTYPE (JLON)==2.AND.KCBOT (JLON)==KCTOP (JLON).AND.KCBOT (JLON)>=KLEV-1) THEN
  LDCUM (JLON)=.FALSE.
  KTYPE (JLON)=0
ENDIF



LLO2 =.FALSE.

IF ((.NOT.LDSHCV (JLON).AND.KTYPE (JLON)==2)) THEN
  LLO2 =.TRUE.
  LDCUM (JLON)=.FALSE.
ENDIF



IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

  

  IF ((.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.AND.KTYPE (JLON)==2).OR.(&
    &.NOT.YDML_PHY_EC%YRECUMF%LMFPEN.AND.KTYPE (JLON)==1)) THEN
    LLO2 =.TRUE.
    LDCUM (JLON)=.FALSE.
  ENDIF

  
ENDIF



IF (LLDDRAF (JLON).AND.IDTOP (JLON)<=KCTOP (JLON)) THEN
  IDTOP (JLON)=KCTOP (JLON)+1
ENDIF



DO JK=2, KLEV

  

  IF (LLDDRAF (JLON)) THEN

    IF (JK<IDTOP (JLON)) THEN
      PMFD (JLON, JK)=0.0_JPRB
      ZMFDS (JLON, JK)=0.0_JPRB
      ZMFDQ (JLON, JK)=0.0_JPRB
      PMFDDE_RATE (JLON, JK)=0.0_JPRB
      ZDMFDP (JLON, JK)=0.0_JPRB
    ELSEIF (JK==IDTOP (JLON)) THEN
      PMFDDE_RATE (JLON, JK)=0.0_JPRB
    ENDIF

  ENDIF

  
ENDDO

CALL CUFLXN_SINGLE_COLUMN (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_EC%YRECUMF,&
& KIDIA, KFDIA, KLON, KLEV, PTSPHY, PTEN, PQEN, PQSEN, ZTENH, ZQENH, PAPH, PAP, PGEOH&
&, LDLAND, LDCUM, LDTDKMF, KCBOT, KCTOP, IDTOP, ITOPM2, KTYPE, LLDDRAF, PMFU, PMFD, ZMFUS&
&, ZMFDS, ZMFUQ, ZMFDQ, ZMFUL, PLUDE, PLUDELI, PLRAIN, PSNDE, ZDMFUP, ZDMFDP, ZDPMEL&
&, ZLGLAC, PMFLXR, PMFLXS, PRAIN, PMFUDE_RATE, PMFDDE_RATE, YDSTACK=YLSTACK)

DO JK=2, KLEV-1

  

  IF (LLDDRAF (JLON).AND.JK>=IDTOP (JLON)-1) THEN
    ZERATE=-PMFD (JLON, JK)+PMFD (JLON, JK-1)+PMFDDE_RATE (JLON, JK)

    IF (ZERATE<0.0_JPRB) THEN
      PMFDDE_RATE (JLON, JK)=PMFDDE_RATE (JLON, JK)-ZERATE
    ENDIF

  ENDIF


  IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
    ZERATE=PMFU (JLON, JK)-PMFU (JLON, JK+1)+PMFUDE_RATE (JLON, JK)

    IF (ZERATE<0.0_JPRB) THEN
      PMFUDE_RATE (JLON, JK)=PMFUDE_RATE (JLON, JK)-ZERATE
    ENDIF

    ZDMFUP (JLON, JK)=PMFLXR (JLON, JK+1)+PMFLXS (JLON, JK+1)-PMFLXR (JLON, JK)-PMFLXS (JLON, JK)
    ZDMFDP (JLON, JK)=0.0_JPRB
  ENDIF

  
ENDDO



IF (LLDDRAF (JLON)) THEN
  JK=IDTOP (JLON)
  IK=MIN (JK+1, KLEV)

  IF (ZMFDQ (JLON, JK)<0.3_JPRB*ZMFDQ (JLON, IK)) THEN

    IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ==0.0_JPRB) THEN
      ZMFDQ (JLON, JK)=0.3_JPRB*ZMFDQ (JLON, IK)
    ELSE
      PMFD (JLON, JK)=0.3_JPRB*PMFD (JLON, IK)
    ENDIF

  ENDIF

ENDIF



DO JK=2, KLEV

  

  IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1.AND.JK<KCBOT (JLON)) THEN
    ZDZ=PTSPHY*YDCST%RG/(PAPH (JLON, JK+1)-PAPH (JLON, JK))
    ZMFA=ZMFUQ (JLON, JK+1)+ZMFDQ (JLON, JK+1)-ZMFUQ (JLON, JK)-ZMFDQ (JLON&
    &, JK)+ZMFUL (JLON, JK+1)-ZMFUL (JLON, JK)+ZDMFUP (JLON, JK)
    ZMFA=(ZMFA-PLUDE (JLON, JK))*ZDZ

    IF (PQEN (JLON, JK)+ZMFA<0.0_JPRB) THEN
      ZFAC=2.0_JPRB*(PQEN (JLON, JK)+ZMFA)/ZDZ
      PLUDE (JLON, JK)=PLUDE (JLON, JK)+ZFAC
      PLUDELI (JLON, JK, 1)=PLUDELI (JLON, JK, 1)+ZFAC
    ENDIF


    IF (PLUDE (JLON, JK)<0.0_JPRB) THEN
      PLUDE (JLON, JK)=0.0_JPRB
      PLUDELI (JLON, JK, 1)=0.0_JPRB
      PLUDELI (JLON, JK, 2)=0.0_JPRB
    ENDIF

  ENDIF


  IF (.NOT.LDCUM (JLON)) THEN
    PMFUDE_RATE (JLON, JK)=0.0_JPRB
  ENDIF


  IF (PMFD (JLON, JK-1)==0.0_JPRB) THEN
    PMFDDE_RATE (JLON, JK)=0.0_JPRB
  ENDIF

  
ENDDO


IF (YDML_PHY_EC%YRECUMF%RMFSOLTQ>0.0_JPRB) THEN

  DO JK=KLEV, 2,-1

    

    IF (LDCUM (JLON)) THEN

      IF (JK>KCBOT (JLON)) THEN
        ZMFA=1.0_JPRB/MAX (1.E-15_JPRB, PMFU (JLON, JK))
        PQU (JLON, JK)=ZQENH (JLON, JK)+ZMFUQ (JLON, JK)*ZMFA
        PTU (JLON, JK)=ZTENH (JLON, JK)+ZMFUS (JLON, JK)*ZMFA*ZORCPD
        ZMFUS (JLON, JK)=PMFU (JLON, JK)*(YDCST%RCPD*PTU (JLON, JK)+PGEOH (JLON, JK))
        ZMFUQ (JLON, JK)=PMFU (JLON, JK)*PQU (JLON, JK)

        IF (LLDDRAF (JLON)) THEN
          ZMFA=1.0_JPRB/MIN (-1.E-15_JPRB, PMFD (JLON, JK))
          ZQD (JLON, JK)=ZQENH (JLON, JK)+ZMFDQ (JLON, JK)*ZMFA
          ZTD (JLON, JK)=ZTENH (JLON, JK)+ZMFDS (JLON, JK)*ZMFA*ZORCPD
          ZMFDQ (JLON, JK)=PMFD (JLON, JK)*ZQD (JLON, JK)
          ZMFDS (JLON, JK)=PMFD (JLON, JK)*(YDCST%RCPD*ZTD (JLON, JK)+PGEOH (JLON, JK))
        ENDIF

      ELSEIF (JK<=KCBOT (JLON).AND.JK>=KCTOP (JLON)) THEN
        ZMFUS (JLON, JK)=PMFU (JLON, JK)*(YDCST%RCPD*PTU (JLON, JK)+PGEOH (JLON, JK))
        ZMFUQ (JLON, JK)=PMFU (JLON, JK)*PQU (JLON, JK)
        ZMFDS (JLON, JK)=PMFD (JLON, JK)*(YDCST%RCPD*ZTD (JLON, JK)+PGEOH (JLON, JK))
        ZMFDQ (JLON, JK)=PMFD (JLON, JK)*ZQD (JLON, JK)
      ENDIF

    ENDIF

  
  ENDDO

ENDIF

CALL CUDTDQN_SINGLE_COLUMN (YDTHF, YDCST, YDML_PHY_SLIN%YREPHLI, YDML_PHY_SLIN%YRPHNC&
&, YDML_PHY_EC%YRECUMF, YDML_PHY_EC%YREPHY, KIDIA, KFDIA, KLON, KLEV, ITOPM2, KTYPE&
&, KCTOP, IDTOP, LDTDKMF, LDCUM, LLDDRAF, PTSPHY, PAPH, PAP, PGEOH, PGEO, PTEN, ZTENH&
&, PQEN, ZQENH, PQSEN, ZLGLAC, PLUDE, PLUDELI, PSNDE, PMFU, PMFD, ZMFUS, ZMFDS, ZMFUQ&
&, ZMFDQ, ZMFUL, ZDMFUP, ZDPMEL, PTENT, PTENQ, PENTH, YDSTACK=YLSTACK)

IF (YDML_PHY_EC%YRECUMF%LMFDUDV) THEN

  DO JK=KLEV-1, 2,-1
    IK=JK+1

    

    IF (LDCUM (JLON)) THEN

      IF (JK==KCBOT (JLON).AND.KTYPE (JLON)<3) THEN
        IKB=IDPL (JLON)
        ZUU (JLON, JK)=PUEN (JLON, IKB-1)
        ZVU (JLON, JK)=PVEN (JLON, IKB-1)
      ELSEIF (JK==KCBOT (JLON).AND.KTYPE (JLON)==3) THEN
        ZUU (JLON, JK)=PUEN (JLON, JK-1)
        ZVU (JLON, JK)=PVEN (JLON, JK-1)
      ENDIF


      IF (JK<KCBOT (JLON).AND.JK>=KCTOP (JLON)) THEN
        ZFAC=0.0_JPRB

        IF (LDTDKMF.AND.(KTYPE (JLON)==1.OR.KTYPE (JLON)==3))  THEN
            ZFAC=2.0_JPRB
        ENDIF

        ZERATE=PMFU (JLON, JK)-PMFU (JLON, IK)+(1.0_JPRB+ZFAC)*PMFUDE_RATE (JLON, JK)
        ZDERATE=(1.0_JPRB+ZFAC)*PMFUDE_RATE (JLON, JK)
        ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, PMFU (JLON, JK))
        ZUU (JLON, JK)=(ZUU (JLON, IK)*PMFU (JLON, IK)+ZERATE*PUEN (JLON, JK)-ZDERATE*ZUU (JLON, IK))*ZMFA
        ZVU (JLON, JK)=(ZVU (JLON, IK)*PMFU (JLON, IK)+ZERATE*PVEN (JLON, JK)-ZDERATE*ZVU (JLON, IK))*ZMFA
      ENDIF

    ENDIF

  
  ENDDO


  DO JK=3, KLEV
    IK=JK-1

    

    IF (LDCUM (JLON)) THEN

      IF (JK==IDTOP (JLON)) THEN
        ZUD (JLON, JK)=0.5_JPRB*(ZUU (JLON, JK)+PUEN (JLON, IK))
        ZVD (JLON, JK)=0.5_JPRB*(ZVU (JLON, JK)+PVEN (JLON, IK))
      ELSEIF (JK>IDTOP (JLON)) THEN
        ZERATE=-PMFD (JLON, JK)+PMFD (JLON, IK)+PMFDDE_RATE (JLON, JK)
        ZMFA=1.0_JPRB/MIN (-YDML_PHY_EC%YRECUMF%RMFCMIN, PMFD (JLON, JK))
        ZUD (JLON, JK)=(ZUD (JLON, IK)*PMFD (JLON, IK)-ZERATE*PUEN&
        & (JLON, IK)+PMFDDE_RATE (JLON, JK)*ZUD (JLON, IK))*ZMFA
        ZVD (JLON, JK)=(ZVD (JLON, IK)*PMFD (JLON, IK)-ZERATE*PVEN&
        & (JLON, IK)+PMFDDE_RATE (JLON, JK)*ZVD (JLON, IK))*ZMFA
      ENDIF

    ENDIF

  
  ENDDO

  ZMFS =1.0_JPRB

  IF (YDML_PHY_EC%YRECUMF%RMFSOLUV<=1.0_JPRB) THEN

    DO JK=2, KLEV

      

      IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
        ZMFMAX=(PAPH (JLON, JK)-PAPH (JLON, JK-1))*ZCONS

        IF (PMFU (JLON, JK)>ZMFMAX.AND.JK>=KCTOP (JLON))  THEN
            ZMFS =MIN (ZMFS , ZMFMAX/PMFU (JLON, JK))
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF


  DO JK=1, KLEV
    
    ZMFUUS (JLON, JK)=PMFU (JLON, JK)
    ZMFDUS (JLON, JK)=PMFD (JLON, JK)

    IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
      ZMFUUS (JLON, JK)=PMFU (JLON, JK)*ZMFS 
      ZMFDUS (JLON, JK)=PMFD (JLON, JK)*ZMFS 
    ENDIF

  
  ENDDO


  IF (YDML_PHY_EC%YRECUMF%RMFSOLUV>0.0_JPRB) THEN

    

    IF (LDCUM (JLON)) THEN
      JK=KCBOT (JLON)
      IK=JK-1
      ZMFUUB =ZMFUUS (JLON, JK)*(ZUU (JLON, JK)-PUEN (JLON, IK))
      ZMFUVB =ZMFUUS (JLON, JK)*(ZVU (JLON, JK)-PVEN (JLON, IK))
    ENDIF


    

    DO JK=2, KLEV
      IK=JK-1

      

      IF (LDCUM (JLON).AND.JK>KCBOT (JLON)) THEN
        IKB=KCBOT (JLON)
        ZDZ=((PAPH (JLON, KLEV+1)-PAPH (JLON, JK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IKB)))

        IF (KTYPE (JLON)==3) THEN
          ZDZ=ZDZ*ZDZ
        ENDIF

        ZMFA=1.0_JPRB/MAX (YDML_PHY_EC%YRECUMF%RMFCMIN, ZMFUUS (JLON, JK))
        ZUU (JLON, JK)=PUEN (JLON, IK)+ZMFUUB *ZDZ*ZMFA
        ZVU (JLON, JK)=PVEN (JLON, IK)+ZMFUVB *ZDZ*ZMFA
        ZMFDUS (JLON, JK)=ZMFDUS (JLON, IKB)*ZDZ
        ZUD (JLON, JK)=PUEN (JLON, IK)+ZUD (JLON, IKB)-PUEN (JLON, IKB-1)
        ZVD (JLON, JK)=PVEN (JLON, IK)+ZVD (JLON, IKB)-PVEN (JLON, IKB-1)
      ENDIF


      IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)) THEN

        IF (LDTDKMF) THEN
          ZUU (JLON, JK)=ZUU (JLON, JK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZUU (JLON, JK))
          ZVU (JLON, JK)=ZVU (JLON, JK)-YDML_PHY_EC%YRECUMF%RUVPER*SIGN (1.0_JPRB, ZVU (JLON, JK))
        ELSE
          ZUU (JLON, JK)=ZUU (JLON, JK)-MIN (ABS (ZUU (JLON, JK)), YDML_PHY_EC&
          &%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZUU (JLON, JK))
          ZVU (JLON, JK)=ZVU (JLON, JK)-MIN (ABS (ZVU (JLON, JK)), YDML_PHY_EC&
          &%YRECUMF%RUVPER)*SIGN (1.0_JPRB, ZVU (JLON, JK))
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF

  CALL CUDUDV_SINGLE_COLUMN (YDCST, YDML_PHY_EC%YRECUMF, KIDIA, KFDIA, KLON, KLEV, KSPPN2D&
  &, ITOPM2, KTYPE, KCBOT, KCTOP, LDCUM, PTSPHY, PAPH, PAP, PUEN, PVEN, ZMFUUS, ZMFDUS&
  &, PMFU, PMFD, ZUU, ZUD, ZVU, ZVD, PGP2DSPP, PTENU, PTENV, YDSTACK=YLSTACK)

  IF (YDML_PHY_EC%YRECUMF%LMFUVDIS) THEN
    
    ZSUM12 =0.0_JPRB
    ZSUM22 =0.0_JPRB

    

    DO JK=1, KLEV
      
      ZUV2 (JLON, JK)=0.0_JPRB

      IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
        ZDZ=(PAPH (JLON, JK+1)-PAPH (JLON, JK))
        ZDUTEN=PTENU (JLON, JK)-ZTENU (JLON, JK)
        ZDVTEN=PTENV (JLON, JK)-ZTENV (JLON, JK)
        ZUV2 (JLON, JK)=SQRT (ZDUTEN**2+ZDVTEN**2)
        ZSUM22 =ZSUM22 +ZUV2 (JLON, JK)*ZDZ
        ZSUM12 =ZSUM12 -(PUEN (JLON, JK)*ZDUTEN+PVEN (JLON, JK)*ZDVTEN)*ZDZ
      ENDIF

    
    ENDDO


    DO JK=1, KLEV

      

      IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
        ZDZ=(PAPH (JLON, JK+1)-PAPH (JLON, JK))
        ZTDIS=ZORCPD*ZSUM12 *ZUV2 (JLON, JK)/MAX (1.E-15_JPRB, ZSUM22 )
        PTENT (JLON, JK)=PTENT (JLON, JK)+ZTDIS
      ENDIF

    
    ENDDO

  ENDIF

ENDIF


IF (.NOT.YDML_PHY_EC%YRECUMF%LMFSCV.OR..NOT.YDML_PHY_EC%YRECUMF%LMFPEN) THEN

  DO JK=2, KLEV

    

    IF (LLO2 .AND.JK>=KCTOP (JLON)-1) THEN
      PMFUDE_RATE (JLON, JK)=0.0_JPRB
      PMFDDE_RATE (JLON, JK)=0.0_JPRB
    ENDIF

  
  ENDDO


  

  IF (LLO2 ) THEN
    KCTOP (JLON)=KLEV-1
    KCBOT (JLON)=KLEV-1
  ENDIF

  
ENDIF


IF (YDML_PHY_EC%YREPHY%LMFTRAC.AND.KTRAC>0) THEN

  

  IF (LDCUM (JLON).AND.KTYPE (JLON)/=3.AND.KCBOT (JLON)-KCTOP (JLON)>=1) THEN
    LLDCUM (JLON)=.TRUE.
    LLDDRAF3 (JLON)=LLDDRAF (JLON)
  ELSE
    LLDCUM (JLON)=.FALSE.
    LLDDRAF3 (JLON)=.FALSE.
  ENDIF

  
  ZMFS =1.0_JPRB

  IF (YDML_PHY_EC%YRECUMF%RMFSOLCT<=3.0_JPRB) THEN

    DO JK=2, KLEV

      

      IF (LLDCUM (JLON).AND.JK>=KCTOP (JLON)) THEN
        ZMFMAX=(PAPH (JLON, JK)-PAPH (JLON, JK-1))*0.8_JPRB*ZCONS

        IF (PMFU (JLON, JK)>ZMFMAX)  THEN
            ZMFS =MIN (ZMFS , ZMFMAX/PMFU (JLON, JK))
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF


  DO JK=1, KLEV

    

    IF (LLDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
      ZMFUUS (JLON, JK)=PMFU (JLON, JK)*ZMFS 
      ZMFUDR (JLON, JK)=PMFUDE_RATE (JLON, JK)*ZMFS 
      ZDMFUPC (JLON, JK)=(PMFLXR (JLON, JK)+PMFLXS (JLON, JK))*ZMFS 
      IKB=KCBOT (JLON)

      IF (JK>IKB) THEN
        ZDMFUPC (JLON, JK)=ZDMFUPC (JLON, IKB)
      ENDIF

    ELSE
      ZMFUUS (JLON, JK)=0._JPRB
      ZMFUDR (JLON, JK)=0._JPRB
    ENDIF


    IF (LLDDRAF3 (JLON).AND.JK>=IDTOP (JLON)-1) THEN
      ZMFDUS (JLON, JK)=PMFD (JLON, JK)*ZMFS 
      ZMFDDR (JLON, JK)=PMFDDE_RATE (JLON, JK)*ZMFS 
      ZDMFDPC (JLON, JK)=0.0_JPRB
    ELSE
      ZMFDUS (JLON, JK)=0._JPRB
      ZMFDDR (JLON, JK)=0._JPRB
    ENDIF

  
  ENDDO


  IF (YDML_PHY_EC%YRECUMF%LMFSMOOTH) THEN

    DO JK=2, KLEV-1

      

      IF (LLDDRAF3 (JLON).AND.ZMFDUS (JLON, JK)<0.0_JPRB.AND.ZMFDUS (JLON, JK+1)==0.0_JPRB) THEN
        ZERATE=MIN (0._JPRB, ZMFDUS (JLON, JK)-0.5*ZMFDUS (JLON, JK-1))
        ZMFDUS (JLON, JK)=ZMFDUS (JLON, JK)-ZERATE
        ZMFDDR (JLON, JK)=ZMFDDR (JLON, JK)-ZERATE
        ZMFDDR (JLON, JK+1)=-ZMFDUS (JLON, JK)
      ENDIF


      IF (LLDCUM (JLON).AND.JK==KCTOP (JLON)) THEN
        ZERATE=MAX (0.0_JPRB, ZMFUUS (JLON, JK)-0.5_JPRB*ZMFUUS (JLON, JK+1))
        ZMFUUS (JLON, JK)=ZMFUUS (JLON, JK)-ZERATE
        ZMFUDR (JLON, JK)=ZMFUDR (JLON, JK)+ZERATE
        ZMFUDR (JLON, JK-1)=ZMFUUS (JLON, JK)
      ENDIF

    
    ENDDO


    DO JK=KLEV-1, 2,-1

      

      IF (LLDCUM (JLON)) THEN

        IF (ZMFUDR (JLON, JK)==0.0_JPRB.AND.ZMFUDR (JLON, JK-1)>0.0_JPRB) THEN
          ZMFUDR (JLON, JK)=0.5_JPRB*ZMFUDR (JLON, JK-1)
        ENDIF

      ENDIF

    
    ENDDO

  ENDIF


  IF (YDML_PHY_EC%YREPHY%LMFSCAV) THEN
    ZSCAV (:)=PSCAV (:)
  ELSE
    ZSCAV (:)=0.0_JPRB
    ZDMFUPC (JLON,:)=0.0_JPRB
  ENDIF

  CALL CUCTRACER_SINGLE_COLUMN (YDCST, YDML_PHY_SLIN%YRCUMFS, YDML_PHY_SLIN%YRECUMF2, YDML_PHY_EC%YRECUMF&
  &, KIDIA, KFDIA, KLON, KLEV, KTRAC, KCTOP, IDTOP, KTYPE, LLDCUM, LLDDRAF3, PTSPHY, PAPH, PAP, ZMFUUS&
  &, ZMFDUS, PMFU, PMFD, ZMFUDR, ZMFDDR, ZDMFUPC, ZDMFDPC, PCEN, PTENC, ZSCAV, YDSTACK=YLSTACK)
ENDIF

PDISS (JLON, 1)=0.0_JPRB
ZAR=1.0_JPRB/20.89_JPRB
ZAS=1.0_JPRB/29.51_JPRB
ZBR=1.0_JPRB/1.15_JPRB
ZBS=1.0_JPRB/1.10_JPRB
ZAK=1.0_JPRB/5.09E-3_JPRB

DO JK=1, KLEV
  IK=MIN (JK+1, KLEV)
  IKD=MAX (JK-1, 1)
  
  PDISS (JLON, JK)=0.0_JPRB
  PRSUD (JLON, JK, 1)=0.0_JPRB
  PRSUD (JLON, JK, 2)=0.0_JPRB

  IF (LDCUM (JLON).AND.JK>=KCTOP (JLON)-1) THEN
    PLUDELI (JLON, JK, 3)=PMFUDE_RATE (JLON, JK)*(PQU (JLON, IK)-ZQENH (JLON&
    &, IK))+PMFDDE_RATE (JLON, JK)*(ZQD (JLON, IKD)-ZQENH (JLON, IKD))
    PLUDELI (JLON, JK, 4)=PMFUDE_RATE (JLON, JK)*(PTU (JLON, IK)-ZTENH (JLON&
    &, IK))+PMFDDE_RATE (JLON, JK)*(ZTD (JLON, IKD)-ZTENH (JLON, IKD))
    ZRO=YDCST%RG/(PGEOH (JLON, JK)-PGEOH (JLON, JK+1))
    PMFUDE_RATE (JLON, JK)=PMFUDE_RATE (JLON, JK)*ZRO
    PMFDDE_RATE (JLON, JK)=PMFDDE_RATE (JLON, JK)*ZRO
    ZRO=YDCST%RD*PTEN (JLON, JK)*(1.0_JPRB+YDCST%RETV*PQEN (JLON, JK))/PAP (JLON, JK)
    PDISS (JLON, JK)=MIN (PWMEAN (JLON), 17._JPRB)**2*PMFUDE_RATE (JLON, JK)*ZRO*ZTAU 
    PRSUD (JLON, JK, 1)=1.E-3_JPRB*ZRO*(PMFLXR (JLON, JK)*3600._JPRB*ZAR)**ZBR
    PRSUD (JLON, JK, 2)=0.5*1.E-3_JPRB*ZRO*(10.0_JPRB*PMFLXS (JLON, JK)*3600._JPRB*ZAS)**ZBS
  ELSE
    PMFU (JLON, JK)=0.0_JPRB
    PMFD (JLON, JK)=0.0_JPRB
    PLUDE (JLON, JK)=0.0_JPRB
    PLUDELI (JLON, JK, 1)=0.0_JPRB
    PLUDELI (JLON, JK, 2)=0.0_JPRB
    PLUDELI (JLON, JK, 3)=0.0_JPRB
    PLUDELI (JLON, JK, 4)=0.0_JPRB
    PSNDE (JLON, JK, 1)=0.0_JPRB
    PSNDE (JLON, JK, 2)=0.0_JPRB
    PTU (JLON, JK)=PTEN (JLON, JK)
    PQU (JLON, JK)=PQEN (JLON, JK)
    PLU (JLON, JK)=0.0_JPRB
    PENTH (JLON, JK)=0.0_JPRB
    PMFUDE_RATE (JLON, JK)=0.0_JPRB
    PMFDDE_RATE (JLON, JK)=0.0_JPRB
  ENDIF

  
ENDDO



ENDSUBROUTINE CUMASTRN_SINGLE_COLUMN

