
SUBROUTINE ACNEBXRS_OPENACC (YDPHY, YDPHY0, KIDIA, KFDIA&
&, KLON, KTDIA, KLEV, PQ, PQC, PQSAT, PNEB, YDSTACK)
!$ACC ROUTINE (ACNEBXRS_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMPHY,ONLY:TPHY
USE YOMPHY0,ONLY:TPHY0
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY0), INTENT (IN)::YDPHY0
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQC (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSAT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PNEB (KLON, KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZRHEXP
REAL (KIND=JPRB)::ZARGLI
REAL (KIND=JPRB)::ZBIN
REAL (KIND=JPRB)::ZNEB
REAL (KIND=JPRB)::ZRHLIM
REAL (KIND=JPRB)::ZRH
REAL (KIND=JPRB)::ZEPS1


JLON = KIDIA



ZEPS1=1.E-6_JPRB
ZARGLI=125._JPRB**(1.0_JPRB/YDPHY0%QXRTGH)

IF (YDPHY%LQXRTGH) THEN

  DO JLEV=KTDIA, KLEV
    
    ZRH=MIN (ZARGLI, MAX (ZEPS1, PQ (JLON, JLEV)/PQSAT (JLON, JLEV)))
    ZRHEXP=EXP (-2.0_JPRB*ZRH**YDPHY0%QXRTGH)
    ZRH=((1.0_JPRB-ZRHEXP)/(1.0_JPRB+ZRHEXP))**(1.0_JPRB/YDPHY0%QXRTGH)
    ZRHLIM=MAX (ZEPS1, MIN (1.0_JPRB-ZEPS1, ZRH))
    ZNEB=ZRHLIM**YDPHY0%QXRR*(1.0_JPRB-EXP (-YDPHY0%QXRAL*PQC (JLON, JLEV&
    &)/((1.0_JPRB-ZRHLIM)*PQSAT (JLON, JLEV))**YDPHY0%QXRDEL))
    ZBIN=MAX (0.0_JPRB, SIGN (1.0_JPRB, ZRH-1.0_JPRB))
    PNEB (JLON, JLEV)=MAX (ZEPS1, MIN (1.0_JPRB-ZEPS1, ZBIN+(1.0_JPRB-ZBIN)*ZNEB))
  
  ENDDO

ELSE

  DO JLEV=KTDIA, KLEV
    
    ZRH=MIN (YDPHY0%QXRHX, PQ (JLON, JLEV)/PQSAT (JLON, JLEV))
    ZRHLIM=MAX (ZEPS1, MIN (1.0_JPRB-ZEPS1, ZRH))
    ZNEB=ZRHLIM**YDPHY0%QXRR*(1.0_JPRB-EXP (-YDPHY0%QXRAL*PQC (JLON, JLEV&
    &)/((1.0_JPRB-ZRHLIM)*PQSAT (JLON, JLEV))**YDPHY0%QXRDEL))
    ZBIN=MAX (0.0_JPRB, SIGN (1.0_JPRB, ZRH-1.0_JPRB))
    PNEB (JLON, JLEV)=MAX (ZEPS1, MIN (1.0_JPRB-ZEPS1, ZBIN+(1.0_JPRB-ZBIN)*ZNEB))
  
  ENDDO

ENDIF



END SUBROUTINE ACNEBXRS_OPENACC
