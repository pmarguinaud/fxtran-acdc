
SUBROUTINE ACPLUIZ_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA, KLEV, PT, PQ&
&, PQL, PQI, PQR, PQS, PDELP, PAPRSF, PCP, PR, PNEBS, PQCS, PNEB_CVPP, PQLI_CVPP, PQC_DET_PCMT&
&, PTENDH, PTENDQ, LDADJCLD, PAPHI, PTS, PNEIJ, PLSM, PGM, YDSTA, PFCSQL, PFCSQN, PFPLSL&
&, PFPLSN, PFPEVPL, PFPEVPN, PFPFPL, PFPFPN, PSEDIQL, PSEDIQN, YDSTACK)
!$ACC ROUTINE (ACPLUIZ_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMLSFORC,ONLY:LMUSCLFA, NMUSCLFA
USE YOMSTA,ONLY:TSTA
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQL (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQI (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PNEBS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQCS (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PNEB_CVPP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQLI_CVPP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQC_DET_PCMT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENDH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTENDQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PNEIJ (KLON)
REAL (KIND=JPRB), INTENT (IN)::PLSM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGM (KLON)
TYPE (TSTA), INTENT (IN)::YDSTA
LOGICAL, INTENT (IN)::LDADJCLD
REAL (KIND=JPRB), INTENT (INOUT)::PFCSQL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFCSQN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPLSL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPLSN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPEVPL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPEVPN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPFPL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PFPFPN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PSEDIQL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PSEDIQN (KLON, 0:KLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL (KIND=JPRB), ZRHCRI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZRMF, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQSATS, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZT, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZAUTOL, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZAUTOI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQL, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZQI, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZFLUXCOR, (KLON, KLEV))
REAL (KIND=JPRB)::ZEPS1
REAL (KIND=JPRB)::ZIGEL
REAL (KIND=JPRB)::ZGDTI
REAL (KIND=JPRB)::ZGDT
REAL (KIND=JPRB)::ZICE
REAL (KIND=JPRB)::ZDPSGDT
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JLON

#include "acmicro_openacc.intfb.h"
#include "acnebsm_openacc.intfb.h"
#include "advprcs_openacc.intfb.h"
#include "wrscmr.intfb.h"
#include "fctdoi.func.h"

YLSTACK = YDSTACK



IF (KIND (ZRHCRI) == 8) THEN
    fxtran_acdc_alloc8 (ZRHCRI)
ELSEIF (KIND (ZRHCRI) == 4) THEN
    fxtran_acdc_alloc4 (ZRHCRI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRMF) == 8) THEN
    fxtran_acdc_alloc8 (ZRMF)
ELSEIF (KIND (ZRMF) == 4) THEN
    fxtran_acdc_alloc4 (ZRMF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQSATS) == 8) THEN
    fxtran_acdc_alloc8 (ZQSATS)
ELSEIF (KIND (ZQSATS) == 4) THEN
    fxtran_acdc_alloc4 (ZQSATS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZT) == 8) THEN
    fxtran_acdc_alloc8 (ZT)
ELSEIF (KIND (ZT) == 4) THEN
    fxtran_acdc_alloc4 (ZT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQ) == 8) THEN
    fxtran_acdc_alloc8 (ZQ)
ELSEIF (KIND (ZQ) == 4) THEN
    fxtran_acdc_alloc4 (ZQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZAUTOL) == 8) THEN
    fxtran_acdc_alloc8 (ZAUTOL)
ELSEIF (KIND (ZAUTOL) == 4) THEN
    fxtran_acdc_alloc4 (ZAUTOL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZAUTOI) == 8) THEN
    fxtran_acdc_alloc8 (ZAUTOI)
ELSEIF (KIND (ZAUTOI) == 4) THEN
    fxtran_acdc_alloc4 (ZAUTOI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQL) == 8) THEN
    fxtran_acdc_alloc8 (ZQL)
ELSEIF (KIND (ZQL) == 4) THEN
    fxtran_acdc_alloc4 (ZQL)
ELSE
    STOP 1
ENDIF


IF (KIND (ZQI) == 8) THEN
    fxtran_acdc_alloc8 (ZQI)
ELSEIF (KIND (ZQI) == 4) THEN
    fxtran_acdc_alloc4 (ZQI)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFLUXCOR) == 8) THEN
    fxtran_acdc_alloc8 (ZFLUXCOR)
ELSEIF (KIND (ZFLUXCOR) == 4) THEN
    fxtran_acdc_alloc4 (ZFLUXCOR)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZEPS1=1.E-12_JPRB

IF (LDADJCLD) THEN

  DO JLEV=KTDIA, KLEV
    
    ZT (JLON, JLEV)=PT (JLON, JLEV)+YDML_PHY_MF%YRPHY2%TSPHY*PTENDH (JLON, JLEV)/PCP (JLON, JLEV)
    ZQ (JLON, JLEV)=MAX (0.0_JPRB, PQ (JLON, JLEV)+YDML_PHY_MF%YRPHY2%TSPHY*PTENDQ (JLON, JLEV))
  
  ENDDO

  CALL ACNEBSM_OPENACC (YDCST, YDML_PHY_MF%YRPHY0, KIDIA, KFDIA, KLON, KTDIA, KLEV, ZT, ZQ, PQL, PQI&
  &, PAPHI, PAPRSF, PCP, PR, PGM, YDSTA, PQCS, PNEBS, ZRHCRI, ZRMF, ZQSATS, YDSTACK=YLSTACK)
ELSE

  DO JLEV=KTDIA, KLEV
    
    ZT (JLON, JLEV)=PT (JLON, JLEV)
    ZQ (JLON, JLEV)=PQ (JLON, JLEV)
  
  ENDDO

ENDIF



DO JLEV=KTDIA, KLEV
  
  ZICE=FONICE (ZT (JLON, JLEV), YDML_PHY_MF%YRPHY0%RDTFAC)
  PQCS (JLON, JLEV)=PQCS (JLON, JLEV)+PQLI_CVPP (JLON, JLEV)+PQC_DET_PCMT (JLON, JLEV)
  PNEBS (JLON, JLEV)=MIN (1.0_JPRB-ZEPS1, MAX (PNEBS (JLON, JLEV), ZEPS1))
  PNEBS (JLON, JLEV)=MAX (PNEBS (JLON, JLEV), PNEB_CVPP (JLON, JLEV))
  ZQL (JLON, JLEV)=PQCS (JLON, JLEV)*(1.0_JPRB-ZICE)
  ZQI (JLON, JLEV)=PQCS (JLON, JLEV)*ZICE
  
ENDDO



CALL ACMICRO_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA, KLEV, PNEBS&
&, ZT, ZQL, ZQI, PTS, PNEIJ, PLSM, ZAUTOL, ZAUTOI, YDSTACK=YLSTACK)
ZGDT=YDCST%RG*YDML_PHY_MF%YRPHY2%TSPHY
ZGDTI=1.0_JPRB/ZGDT

DO JLEV=KTDIA, KLEV
  
  ZDPSGDT=ZGDTI*PDELP (JLON, JLEV)
  ZIGEL=MAX (0.0_JPRB, SIGN (1.0_JPRB, YDCST%RTT-PT (JLON, JLEV)))
  ZFLUXCOR (JLON, JLEV)=ZIGEL*ZAUTOL (JLON, JLEV)
  ZAUTOL (JLON, JLEV)=ZAUTOL (JLON, JLEV)-ZFLUXCOR (JLON, JLEV)
  ZAUTOI (JLON, JLEV)=ZAUTOI (JLON, JLEV)+ZFLUXCOR (JLON, JLEV)
  ZQL (JLON, JLEV)=ZQL (JLON, JLEV)-ZFLUXCOR (JLON, JLEV)*YDML_PHY_MF%YRPHY2%TSPHY
  ZQI (JLON, JLEV)=ZQI (JLON, JLEV)+ZFLUXCOR (JLON, JLEV)*YDML_PHY_MF%YRPHY2%TSPHY
  PFCSQL (JLON, JLEV)=PFCSQL (JLON, JLEV-1)+(ZQL (JLON, JLEV)-PQL (JLON, JLEV))*ZDPSGDT
  PFCSQN (JLON, JLEV)=PFCSQN (JLON, JLEV-1)+(ZQI (JLON, JLEV)-PQI (JLON, JLEV))*ZDPSGDT
  
ENDDO

CALL ADVPRCS_OPENACC (YDCST, YDML_PHY_MF, KIDIA, KFDIA, KLON, KTDIA, KLEV, ZT, ZQ,&
& ZQL, ZQI, ZAUTOL, ZAUTOI, PQR, PQS, PNEBS, PCP, PR, PAPHI, PAPRSF, PDELP, PFPLSL&
&, PFPLSN, PFPEVPL, PFPEVPN, PFPFPL, PFPFPN, PSEDIQL, PSEDIQN, YDSTACK=YLSTACK)


END SUBROUTINE ACPLUIZ_OPENACC
