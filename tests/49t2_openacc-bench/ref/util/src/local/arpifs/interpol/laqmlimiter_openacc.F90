SUBROUTINE LAQMLIMITER_OPENACC (PRDETAR, LDQM3DCONS, KSLB1, KPROMA&
&, KST, KEND, KFLEV, KFLDN, KFLDX, KL0, PXSL, PXF, YDSTACK)
!$ACC ROUTINE (LAQMLIMITER_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB, JPIB

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


REAL (KIND=JPRB), INTENT (IN)::PRDETAR (KFLEV)
LOGICAL, INTENT (IN)::LDQM3DCONS
INTEGER (KIND=JPIM), INTENT (IN)::KSLB1
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KFLDN
INTEGER (KIND=JPIM), INTENT (IN)::KFLDX
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KL0 (KPROMA, KFLEV, 0:3)
REAL (KIND=JPRB), INTENT (IN)::PXSL (KSLB1*(KFLDX-KFLDN+1))
REAL (KIND=JPRB), INTENT (INOUT)::PXF (KPROMA, KFLEV)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIB)::IV2L2
INTEGER (KIND=JPIB)::IV2L1
INTEGER (KIND=JPIB)::IV1L2
INTEGER (KIND=JPIB)::IV1L1
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZRVETA
REAL (KIND=JPRB)::ZF122
REAL (KIND=JPRB)::ZF121
REAL (KIND=JPRB)::ZF112
REAL (KIND=JPRB)::ZF111
REAL (KIND=JPRB)::ZF222
REAL (KIND=JPRB)::ZF221
REAL (KIND=JPRB)::ZF212
REAL (KIND=JPRB)::ZF211
REAL (KIND=JPRB)::ZXF
REAL (KIND=JPRB)::ZMAX
REAL (KIND=JPRB)::ZMIN
REAL (KIND=JPRB)::ZSURPL 


JROF = KST


IV1L1=1+KSLB1
IV1L2=2+KSLB1
IV2L1=IV1L1+KSLB1
IV2L2=IV1L2+KSLB1
ZSURPL =0.0_JPRB

DO JLEV=1, KFLEV

  IF (JLEV==1) THEN
    ZRVETA=1.0_JPRB
  ELSE
    ZRVETA=PRDETAR (JLEV)
  ENDIF

  
  ZF111=PXSL (KL0 (JROF, JLEV, 1)+IV1L1)
  ZF211=PXSL (KL0 (JROF, JLEV, 1)+IV1L2)
  ZF121=PXSL (KL0 (JROF, JLEV, 2)+IV1L1)
  ZF221=PXSL (KL0 (JROF, JLEV, 2)+IV1L2)
  ZF112=PXSL (KL0 (JROF, JLEV, 1)+IV2L1)
  ZF212=PXSL (KL0 (JROF, JLEV, 1)+IV2L2)
  ZF122=PXSL (KL0 (JROF, JLEV, 2)+IV2L1)
  ZF222=PXSL (KL0 (JROF, JLEV, 2)+IV2L2)
  ZMIN=MIN (ZF111, ZF211, ZF121, ZF221, ZF112, ZF212, ZF122, ZF222)
  ZMAX=MAX (ZF111, ZF211, ZF121, ZF221, ZF112, ZF212, ZF122, ZF222)
  ZXF=PXF (JROF, JLEV)

  IF (LDQM3DCONS)  THEN
    ZXF=ZXF+ZSURPL 
  ENDIF

  PXF (JROF, JLEV)=MAX (ZMIN, MIN (ZMAX, ZXF))

  IF (LDQM3DCONS)  THEN
    ZSURPL =(ZXF-PXF (JROF, JLEV))*ZRVETA
  ENDIF

  
ENDDO


END SUBROUTINE LAQMLIMITER_OPENACC
