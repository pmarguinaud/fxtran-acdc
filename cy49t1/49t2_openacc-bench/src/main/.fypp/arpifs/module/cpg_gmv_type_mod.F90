MODULE CPG_GMV_TYPE_MOD

!$ACDC methods --methods-list=host,wipe,copy --skip-components cpg --field-api --field-api-class cpg


USE FIELD_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_REGISTRY_MOD
USE PARKIND1, ONLY : JPRB, JPIM, JPIB
USE TYPE_GMVS, ONLY : TYPE_GP

IMPLICIT NONE

TYPE CPG_GMV_3D_TYPE
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: P (:, :) => NULL ()
  CLASS (FIELD_3RB), POINTER :: F_P => NULL ()
END TYPE CPG_GMV_3D_TYPE

TYPE CPG_GMV_TYPE
  LOGICAL :: LOWNED = .FALSE.
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: ZVIEW (:,:,:) => NULL ()
  REAL (KIND=JPRB), POINTER, CONTIGUOUS :: ZDATA (:,:,:,:) => NULL ()
  CLASS (FIELD_4RB), POINTER :: F_DATA => NULL ()
  TYPE (CPG_GMV_3D_TYPE) :: U
  TYPE (CPG_GMV_3D_TYPE) :: V
  TYPE (CPG_GMV_3D_TYPE) :: T
  TYPE (CPG_GMV_3D_TYPE) :: SPD
  TYPE (CPG_GMV_3D_TYPE) :: SVD
  TYPE (CPG_GMV_3D_TYPE) :: NHX
  TYPE (CPG_GMV_3D_TYPE), ALLOCATABLE :: GMV (:)
CONTAINS
  PROCEDURE :: INIT => CPG_GMV_TYPE_INIT
  PROCEDURE :: UPDATE_VIEW => CPG_GMV_TYPE_UPDATE_VIEW
  PROCEDURE :: FINAL => CPG_GMV_TYPE_FINAL
END TYPE CPG_GMV_TYPE


REAL (KIND=JPRB), TARGET, SAVE:: ZDUM2(1,1), ZDUM3(1,1,1)

CONTAINS

SUBROUTINE CPG_GMV_TYPE_INIT (SELF, REGISTRY, NLEV, &
                        & YDTYPE_GP, PERSISTENT, PTYPE_GP, &
                        & KBLKMIN, KBLKMAX)

USE TYPE_GMVS, ONLY : TYPE_GP
USE OML_MOD, ONLY: OML_MAX_THREADS

USE FIELD_DEFAULTS_MODULE

CLASS (CPG_GMV_TYPE)                          :: SELF
TYPE (FIELD_REGISTRY),              INTENT (INOUT) :: REGISTRY
INTEGER (KIND=JPIM),                INTENT (IN)    :: NLEV
TYPE (TYPE_GP),                     INTENT (IN)    :: YDTYPE_GP
LOGICAL, OPTIONAL,                  INTENT (IN)    :: PERSISTENT
REAL (KIND=JPRB), OPTIONAL, TARGET, INTENT (IN)    :: PTYPE_GP (:, :, :, :)
INTEGER (KIND=JPIM), OPTIONAL,      INTENT (IN)    :: KBLKMIN, KBLKMAX

LOGICAL :: LLPERSISTENT
INTEGER (KIND=JPIM) :: ICOUNT
INTEGER (KIND=JPIM) :: IBLKMIN, IBLKMAX
LOGICAL :: LLINITIALIZED
LOGICAL :: LLSYNC_ON_FINAL

IBLKMIN = 1
IF (PRESENT (KBLKMIN)) IBLKMIN = KBLKMIN
IBLKMAX = REGISTRY%GEOM%YRDIM%NGPBLKS
IF (PRESENT (KBLKMAX)) IBLKMAX = KBLKMAX

LLPERSISTENT = .FALSE.
IF (PRESENT (PERSISTENT)) LLPERSISTENT = PERSISTENT

LLINITIALIZED = .FALSE.

IF (PRESENT (PTYPE_GP)) THEN
  SELF%ZDATA => PTYPE_GP
  SELF%LOWNED = .FALSE.
  LLPERSISTENT = .TRUE.
  LLINITIALIZED = .TRUE.
ELSEIF (LLPERSISTENT) THEN
  ALLOCATE (SELF%ZDATA (REGISTRY%GEOM%YRDIM%NPROMA, NLEV, YDTYPE_GP%NDIM, IBLKMIN:IBLKMAX))
  IF (USE_INIT_DEBUG_VALUE) THEN
    SELF%ZDATA = INIT_DEBUG_VALUE_JPRB
    LLINITIALIZED = .TRUE.
  ENDIF
  SELF%LOWNED = .TRUE.
ELSE
  ALLOCATE (SELF%ZDATA (REGISTRY%GEOM%YRDIM%NPROMA, NLEV, YDTYPE_GP%NDIM, OML_MAX_THREADS ()))
  IF (USE_INIT_DEBUG_VALUE) THEN
    SELF%ZDATA = INIT_DEBUG_VALUE_JPRB
    LLINITIALIZED = .TRUE.
  ENDIF
  SELF%LOWNED = .TRUE.
ENDIF

CALL FIELD_NEW (SELF%F_DATA, DATA=SELF%ZDATA, PERSISTENT=LLPERSISTENT, LBOUNDS=[1, 1, 1, IBLKMIN])

LLSYNC_ON_FINAL = .NOT. SELF%LOWNED

ICOUNT = 0

IF (YDTYPE_GP%MU > 0) THEN
  ICOUNT = ICOUNT + 1
  CALL FIELD_NEW (SELF%U%F_P, DATA=SELF%ZDATA (:, :, YDTYPE_GP%MU, :), PERSISTENT=LLPERSISTENT, &
                & INITIALIZED=LLINITIALIZED, SYNC_ON_FINAL=LLSYNC_ON_FINAL, LBOUNDS=[1, 1, IBLKMIN])
ENDIF
IF (YDTYPE_GP%MV > 0) THEN
  ICOUNT = ICOUNT + 1
  CALL FIELD_NEW (SELF%V%F_P, DATA=SELF%ZDATA (:, :, YDTYPE_GP%MV, :), PERSISTENT=LLPERSISTENT, &
                & INITIALIZED=LLINITIALIZED, SYNC_ON_FINAL=LLSYNC_ON_FINAL, LBOUNDS=[1, 1, IBLKMIN])
ENDIF
IF (YDTYPE_GP%MT > 0) THEN
  ICOUNT = ICOUNT + 1
  CALL FIELD_NEW (SELF%T%F_P, DATA=SELF%ZDATA (:, :, YDTYPE_GP%MT, :), PERSISTENT=LLPERSISTENT, &
                & INITIALIZED=LLINITIALIZED, SYNC_ON_FINAL=LLSYNC_ON_FINAL, LBOUNDS=[1, 1, IBLKMIN])
ENDIF
IF (YDTYPE_GP%MSPD > 0) THEN
  ICOUNT = ICOUNT + 1
  CALL FIELD_NEW (SELF%SPD%F_P, DATA=SELF%ZDATA (:, :, YDTYPE_GP%MSPD, :), PERSISTENT=LLPERSISTENT, &
                & INITIALIZED=LLINITIALIZED, SYNC_ON_FINAL=LLSYNC_ON_FINAL, LBOUNDS=[1, 1, IBLKMIN])
ENDIF
IF (YDTYPE_GP%MSVD > 0) THEN
  ICOUNT = ICOUNT + 1
  CALL FIELD_NEW (SELF%SVD%F_P, DATA=SELF%ZDATA (:, :, YDTYPE_GP%MSVD, :), PERSISTENT=LLPERSISTENT, &
                & INITIALIZED=LLINITIALIZED, SYNC_ON_FINAL=LLSYNC_ON_FINAL, LBOUNDS=[1, 1, IBLKMIN])
ENDIF
IF (YDTYPE_GP%MNHX > 0) THEN
  ICOUNT = ICOUNT + 1
  CALL FIELD_NEW (SELF%NHX%F_P, DATA=SELF%ZDATA (:, :, YDTYPE_GP%MNHX, :), PERSISTENT=LLPERSISTENT, &
                & INITIALIZED=LLINITIALIZED, SYNC_ON_FINAL=LLSYNC_ON_FINAL, LBOUNDS=[1, 1, IBLKMIN])
ENDIF

ALLOCATE (SELF%GMV (ICOUNT))

ICOUNT = 0

IF (YDTYPE_GP%MU > 0) THEN
  ICOUNT = ICOUNT + 1
  SELF%GMV (ICOUNT)%F_P => SELF%U%F_P
ENDIF
IF (YDTYPE_GP%MV > 0) THEN
  ICOUNT = ICOUNT + 1
  SELF%GMV (ICOUNT)%F_P => SELF%V%F_P
ENDIF
IF (YDTYPE_GP%MT > 0) THEN
  ICOUNT = ICOUNT + 1
  SELF%GMV (ICOUNT)%F_P => SELF%T%F_P
ENDIF
IF (YDTYPE_GP%MSPD > 0) THEN
  ICOUNT = ICOUNT + 1
  SELF%GMV (ICOUNT)%F_P => SELF%SPD%F_P
ENDIF
IF (YDTYPE_GP%MSVD > 0) THEN
  ICOUNT = ICOUNT + 1
  SELF%GMV (ICOUNT)%F_P => SELF%SVD%F_P
ENDIF
IF (YDTYPE_GP%MNHX > 0) THEN
  ICOUNT = ICOUNT + 1
  SELF%GMV (ICOUNT)%F_P => SELF%NHX%F_P
ENDIF


END SUBROUTINE CPG_GMV_TYPE_INIT

SUBROUTINE CPG_GMV_TYPE_UPDATE_VIEW (SELF, BLOCK_INDEX)

CLASS (CPG_GMV_TYPE)         :: SELF
INTEGER(KIND=JPIM), INTENT (IN)   :: BLOCK_INDEX
INTEGER(KIND=JPIM) :: JFLD

IF (ASSOCIATED (SELF%F_DATA)) THEN

  SELF%ZVIEW => SELF%F_DATA%GET_VIEW (BLOCK_INDEX)

  IF (ASSOCIATED (SELF%U%F_P)) THEN
    IF ((.NOT. SELF%U%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%U%P))) THEN
      SELF%U%P  => SELF%U%F_P%GET_VIEW (BLOCK_INDEX)
    ENDIF
  ELSEIF (.NOT. ASSOCIATED (SELF%U%F_P)) THEN
    SELF%U%P  => ZDUM2
  ENDIF
  IF (ASSOCIATED (SELF%V%F_P)) THEN
    IF ((.NOT. SELF%V%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%V%P))) THEN
      SELF%V%P  => SELF%V%F_P%GET_VIEW (BLOCK_INDEX)
    ENDIF
  ELSEIF (.NOT. ASSOCIATED (SELF%V%F_P)) THEN
    SELF%V%P  => ZDUM2
  ENDIF
  IF (ASSOCIATED (SELF%T%F_P)) THEN
    IF ((.NOT. SELF%T%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%T%P))) THEN
      SELF%T%P  => SELF%T%F_P%GET_VIEW (BLOCK_INDEX)
    ENDIF
  ELSEIF (.NOT. ASSOCIATED (SELF%T%F_P)) THEN
    SELF%T%P  => ZDUM2
  ENDIF
  IF (ASSOCIATED (SELF%SPD%F_P)) THEN
    IF ((.NOT. SELF%SPD%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%SPD%P))) THEN
      SELF%SPD%P  => SELF%SPD%F_P%GET_VIEW (BLOCK_INDEX)
    ENDIF
  ELSEIF (.NOT. ASSOCIATED (SELF%SPD%F_P)) THEN
    SELF%SPD%P  => ZDUM2
  ENDIF
  IF (ASSOCIATED (SELF%SVD%F_P)) THEN
    IF ((.NOT. SELF%SVD%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%SVD%P))) THEN
      SELF%SVD%P  => SELF%SVD%F_P%GET_VIEW (BLOCK_INDEX)
    ENDIF
  ELSEIF (.NOT. ASSOCIATED (SELF%SVD%F_P)) THEN
    SELF%SVD%P  => ZDUM2
  ENDIF
  IF (ASSOCIATED (SELF%NHX%F_P)) THEN
    IF ((.NOT. SELF%NHX%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%NHX%P))) THEN
      SELF%NHX%P  => SELF%NHX%F_P%GET_VIEW (BLOCK_INDEX)
    ENDIF
  ELSEIF (.NOT. ASSOCIATED (SELF%NHX%F_P)) THEN
    SELF%NHX%P  => ZDUM2
  ENDIF

  DO JFLD = 1, SIZE (SELF%GMV)
    IF (ASSOCIATED (SELF%GMV (JFLD)%F_P)) THEN
      IF ((.NOT. SELF%GMV (JFLD)%F_P%THREAD_BUFFER) .OR. (.NOT. ASSOCIATED (SELF%GMV (JFLD)%P))) THEN
        SELF%GMV (JFLD)%P  => SELF%GMV (JFLD)%F_P%GET_VIEW (BLOCK_INDEX)
      ENDIF
    ELSEIF (.NOT. ASSOCIATED (SELF%GMV (JFLD)%F_P)) THEN
      SELF%GMV (JFLD)%P  => ZDUM2
    ENDIF
  ENDDO

ELSE

  SELF%ZVIEW => ZDUM3

  IF (.NOT. ASSOCIATED (SELF%U%P)) SELF%U%P  => ZDUM2
  IF (.NOT. ASSOCIATED (SELF%V%P)) SELF%V%P  => ZDUM2
  IF (.NOT. ASSOCIATED (SELF%T%P)) SELF%T%P  => ZDUM2
  IF (.NOT. ASSOCIATED (SELF%SPD%P)) SELF%SPD%P  => ZDUM2
  IF (.NOT. ASSOCIATED (SELF%SVD%P)) SELF%SVD%P  => ZDUM2
  IF (.NOT. ASSOCIATED (SELF%NHX%P)) SELF%NHX%P  => ZDUM2

ENDIF

END SUBROUTINE CPG_GMV_TYPE_UPDATE_VIEW

SUBROUTINE CPG_GMV_TYPE_FINAL (SELF)
CLASS (CPG_GMV_TYPE)          :: SELF

DEALLOCATE (SELF%GMV)

IF (ASSOCIATED (SELF%NHX%F_P)) THEN
  CALL FIELD_DELETE (SELF%NHX%F_P) 
  SELF%NHX%F_P => NULL ()
  SELF%NHX%P => NULL ()
ENDIF
IF (ASSOCIATED (SELF%SVD%F_P)) THEN
  CALL FIELD_DELETE (SELF%SVD%F_P) 
  SELF%SVD%F_P => NULL ()
  SELF%SVD%P => NULL ()
ENDIF
IF (ASSOCIATED (SELF%SPD%F_P)) THEN
  CALL FIELD_DELETE (SELF%SPD%F_P) 
  SELF%SPD%F_P => NULL ()
  SELF%SPD%P => NULL ()
ENDIF
IF (ASSOCIATED (SELF%T%F_P)) THEN
  CALL FIELD_DELETE (SELF%T%F_P) 
  SELF%T%F_P => NULL ()
  SELF%T%P => NULL ()
ENDIF
IF (ASSOCIATED (SELF%V%F_P)) THEN
  CALL FIELD_DELETE (SELF%V%F_P) 
  SELF%V%F_P => NULL ()
  SELF%V%P => NULL ()
ENDIF
IF (ASSOCIATED (SELF%U%F_P)) THEN
  CALL FIELD_DELETE (SELF%U%F_P) 
  SELF%U%F_P => NULL ()
  SELF%U%P => NULL ()
ENDIF

IF (ASSOCIATED (SELF%F_DATA)) CALL FIELD_DELETE (SELF%F_DATA)
SELF%F_DATA => NULL ()

IF (SELF%LOWNED) THEN
  DEALLOCATE (SELF%ZDATA)
ENDIF

SELF%ZDATA => NULL ()
SELF%ZVIEW => NULL ()

END SUBROUTINE CPG_GMV_TYPE_FINAL

END MODULE CPG_GMV_TYPE_MOD

