
MODULE MODE_COMPUTE_MF_CLOUD_BIGAUS_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_MF_CLOUD_BIGAUS_OPENACC (D, CST, PARAMMF, PEMF, PDEPTH, PRT_UP, PTHV_UP, PFRAC_ICE_UP&
&, PRSAT_UP, PRTM, PTHM, PTHVM, PDZZ, PZZ, PRHODREF, PRC_MF, PRI_MF, PCF_MF, YDSTACK)
!$ACC ROUTINE (COMPUTE_MF_CLOUD_BIGAUS_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODI_SHUMAN_MF,ONLY:MZF_MF, GZ_M_W_MF
USE MODI_SHUMAN_MF_OPENACC, ONLY : MZF_MF_OPENACC
USE MODI_SHUMAN_MF_OPENACC, ONLY : GZ_M_W_MF_OPENACC

#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDEPTH(D%NIJT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRSAT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PFRAC_ICE_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRI_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRC_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PCF_MF(D%NIJT, D%NKT)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
fxtran_acdc_temp (REAL, ZSIGMF, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZALPHA_UP_M, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZGRAD_Z_RT, (D%NIJT, D%NKT))
REAL::ZOMEGA_UP_M
fxtran_acdc_temp (REAL, ZW1, (D%NIJT, D%NKT))
INTEGER::JK
INTEGER::JI
fxtran_acdc_temp (REAL, ZFRAC_ICE_UP_M, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRT_UP_M, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZRSAT_UP_M, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZTHV_UP_M, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZEMF_M, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZCOND, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZGAM, (D%NIJT, D%NKT))
fxtran_acdc_temp (REAL, ZA, (D%NIJT, D%NKT))
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKU
INTEGER::IKA
INTEGER::IKB
INTEGER::IKT


YLSTACK = YDSTACK



IF (KIND (ZSIGMF) == 8) THEN
    fxtran_acdc_alloc8 (ZSIGMF)
ELSEIF (KIND (ZSIGMF) == 4) THEN
    fxtran_acdc_alloc4 (ZSIGMF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZALPHA_UP_M) == 8) THEN
    fxtran_acdc_alloc8 (ZALPHA_UP_M)
ELSEIF (KIND (ZALPHA_UP_M) == 4) THEN
    fxtran_acdc_alloc4 (ZALPHA_UP_M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGRAD_Z_RT) == 8) THEN
    fxtran_acdc_alloc8 (ZGRAD_Z_RT)
ELSEIF (KIND (ZGRAD_Z_RT) == 4) THEN
    fxtran_acdc_alloc4 (ZGRAD_Z_RT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZW1) == 8) THEN
    fxtran_acdc_alloc8 (ZW1)
ELSEIF (KIND (ZW1) == 4) THEN
    fxtran_acdc_alloc4 (ZW1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZFRAC_ICE_UP_M) == 8) THEN
    fxtran_acdc_alloc8 (ZFRAC_ICE_UP_M)
ELSEIF (KIND (ZFRAC_ICE_UP_M) == 4) THEN
    fxtran_acdc_alloc4 (ZFRAC_ICE_UP_M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRT_UP_M) == 8) THEN
    fxtran_acdc_alloc8 (ZRT_UP_M)
ELSEIF (KIND (ZRT_UP_M) == 4) THEN
    fxtran_acdc_alloc4 (ZRT_UP_M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZRSAT_UP_M) == 8) THEN
    fxtran_acdc_alloc8 (ZRSAT_UP_M)
ELSEIF (KIND (ZRSAT_UP_M) == 4) THEN
    fxtran_acdc_alloc4 (ZRSAT_UP_M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTHV_UP_M) == 8) THEN
    fxtran_acdc_alloc8 (ZTHV_UP_M)
ELSEIF (KIND (ZTHV_UP_M) == 4) THEN
    fxtran_acdc_alloc4 (ZTHV_UP_M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZEMF_M) == 8) THEN
    fxtran_acdc_alloc8 (ZEMF_M)
ELSEIF (KIND (ZEMF_M) == 4) THEN
    fxtran_acdc_alloc4 (ZEMF_M)
ELSE
    STOP 1
ENDIF


IF (KIND (ZCOND) == 8) THEN
    fxtran_acdc_alloc8 (ZCOND)
ELSEIF (KIND (ZCOND) == 4) THEN
    fxtran_acdc_alloc4 (ZCOND)
ELSE
    STOP 1
ENDIF


IF (KIND (ZGAM) == 8) THEN
    fxtran_acdc_alloc8 (ZGAM)
ELSEIF (KIND (ZGAM) == 4) THEN
    fxtran_acdc_alloc4 (ZGAM)
ELSE
    STOP 1
ENDIF


IF (KIND (ZA) == 8) THEN
    fxtran_acdc_alloc8 (ZA)
ELSEIF (KIND (ZA) == 4) THEN
    fxtran_acdc_alloc4 (ZA)
ELSE
    STOP 1
ENDIF


JI = D%NIB


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKA=D%NKA
IKU=D%NKU
IKE=D%NKE
IKL=D%NKL
CALL GZ_M_W_MF_OPENACC (D, PRTM (:,:), PDZZ (:,:), ZW1 (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, ZW1 (:,:), ZGRAD_Z_RT (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PTHV_UP (:,:), ZTHV_UP_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PRSAT_UP (:,:), ZRSAT_UP_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PRT_UP (:,:), ZRT_UP_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PEMF (:,:), ZEMF_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PFRAC_ICE_UP (:,:), ZFRAC_ICE_UP_M (:,:), YDSTACK=YLSTACK)
ZOMEGA_UP_M =0.

DO JK=IKB, IKE-IKL, IKL
  
  ZOMEGA_UP_M =ZOMEGA_UP_M +ZEMF_M (JI, JK)*(ZTHV_UP_M (JI, JK)-PTHVM (JI, JK&
  &))*(PZZ (JI, JK+IKL)-PZZ (JI, JK))/(PTHM (JI, JK)*PRHODREF (JI, JK))
  
ENDDO


ZOMEGA_UP_M =MAX (ZOMEGA_UP_M , 1.E-20)
ZOMEGA_UP_M =(CST%XG*ZOMEGA_UP_M )**(1./3.)


DO JK=IKA, IKU, IKL
  
  ZALPHA_UP_M (JI, JK)=ZEMF_M (JI, JK)/(PARAMMF%XALPHA_MF*PRHODREF (JI, JK)*ZOMEGA_UP_M )
  ZALPHA_UP_M (JI, JK)=MAX (0., MIN (ZALPHA_UP_M (JI, JK), 1.))
  
ENDDO


DO JK=IKA, IKU, IKL
  
  ZSIGMF (JI, JK)=ZEMF_M (JI, JK)*(ZRT_UP_M (JI, JK)-PRTM (JI, JK))*PDEPTH (JI&
  &)*ZGRAD_Z_RT (JI, JK)/(PARAMMF%XSIGMA_MF*ZOMEGA_UP_M *PRHODREF (JI, JK))
  
ENDDO


DO JK=1, IKT
  
  ZSIGMF (JI, JK)=SQRT (MAX (ABS (ZSIGMF (JI, JK)), 1.E-40))
  
ENDDO


DO JK=1, IKT
  
  ZA (JI, JK)=(ZRSAT_UP_M (JI, JK)-ZRT_UP_M (JI, JK))/(SQRT (2.)*ZSIGMF (JI, JK))
  ZGAM (JI, JK)=1-SIGN (1., ZA (JI, JK))*SQRT (1-EXP (-4*ZA (JI, JK)**2/CST%XPI))
  PCF_MF (JI, JK)=MAX (0., MIN (1., 0.5*ZGAM (JI, JK)*ZALPHA_UP_M (JI, JK)))
  ZCOND (JI, JK)=(EXP (-ZA (JI, JK)**2)-ZA (JI, JK)*SQRT (CST%XPI)*ZGAM&
  & (JI, JK))*ZSIGMF (JI, JK)/SQRT (2.*CST%XPI)*ZALPHA_UP_M (JI, JK)
  ZCOND (JI, JK)=MAX (ZCOND (JI, JK), 0.)
  PRC_MF (JI, JK)=(1.-ZFRAC_ICE_UP_M (JI, JK))*ZCOND (JI, JK)
  PRI_MF (JI, JK)=(ZFRAC_ICE_UP_M (JI, JK))*ZCOND (JI, JK)
  
ENDDO


END SUBROUTINE COMPUTE_MF_CLOUD_BIGAUS_OPENACC

ENDMODULE MODE_COMPUTE_MF_CLOUD_BIGAUS_OPENACC
