
SUBROUTINE ACRANEB_TRANST_OPENACC (YDCST, YDPHY, YDPHY3, KIDIA, KFDIA, KLON, KTDIA&
&, KLEV, LDAUTO, PAPRS, PAPRSF, PDELP, PR, PT, PTS, PQ, PQCO2, PQO3, PDEOTI, PDEOTI2&
&, PUEOTI, PUEOTI2, PEOLT, PEOXT, PPNER0, PPNER1, PRPROX, PRSURF, YDSTACK)
!$ACC ROUTINE (ACRANEB_TRANST_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMPHY,ONLY:TPHY
USE YOMPHY3,ONLY:TPHY3
#include "fxtran_acdc_stack.h"
USE FXTRAN_ACDC_STACK_MOD
USE FXTRAN_ACDC_ABORT_MOD

IMPLICIT NONE


TYPE (TCST), INTENT (IN)::YDCST
TYPE (TPHY), INTENT (IN)::YDPHY
TYPE (TPHY3), INTENT (IN)::YDPHY3
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KTDIA
LOGICAL, INTENT (IN)::LDAUTO
REAL (KIND=JPRB), INTENT (IN)::PAPRS (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPRSF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PDELP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PR (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PQ (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQCO2 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQO3 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDEOTI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PDEOTI2 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUEOTI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUEOTI2 (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOLT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PEOXT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PPNER0 (KLON, KLEV, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PPNER1 (KLON, KLEV, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRPROX (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PRSURF (KLON)
TYPE(FXTRAN_ACDC_STACK), INTENT (IN) :: YDSTACK
TYPE(FXTRAN_ACDC_STACK) :: YLSTACK
REAL (KIND=JPRB)::ZTT
REAL (KIND=JPRB)::ZTCORR
REAL (KIND=JPRB)::ZTRLI
REAL (KIND=JPRB)::ZEPSU
REAL (KIND=JPRB)::ZEPSP
REAL (KIND=JPRB)::ZEPSD
REAL (KIND=JPRB)::ZARGLI
REAL (KIND=JPRB)::ZB
REAL (KIND=JPRB)::ZA
REAL (KIND=JPRB)::ZVOISIM
REAL (KIND=JPRB)::ZMD
REAL (KIND=JPRB)::ZIZV0
REAL (KIND=JPRB)::ZIBV0
REAL (KIND=JPRB)::ZGAMV
REAL (KIND=JPRB)::ZEPSV
REAL (KIND=JPRB)::ZT_RHOZ0V (3)
REAL (KIND=JPRB)::ZDELP 
REAL (KIND=JPRB)::ZEOTO 
REAL (KIND=JPRB)::ZNSOR 
REAL (KIND=JPRB)::ZP 
REAL (KIND=JPRB)::ZDU (4)
REAL (KIND=JPRB)::ZC_U (3)
REAL (KIND=JPRB)::ZC_PU (3)
REAL (KIND=JPRB)::ZC_TU (3)
REAL (KIND=JPRB)::ZC_UW (3)
REAL (KIND=JPRB)::ZC_US (3)
REAL (KIND=JPRB)::ZC_US_IRHOV (3)
REAL (KIND=JPRB)::ZC_UC 
REAL (KIND=JPRB)::ZT_U (3)
REAL (KIND=JPRB)::ZT_PU (3)
REAL (KIND=JPRB)::ZT_TU (3)
REAL (KIND=JPRB)::ZT_UW (3)
REAL (KIND=JPRB)::ZT_US (3)
REAL (KIND=JPRB)::ZT_US_IRHOV (3)
REAL (KIND=JPRB)::ZT_UC 
fxtran_acdc_temp (REAL (KIND=JPRB), ZQ, (KLON, KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZIRHOV, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOTA0, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOTA1, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEOTA2, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOTA0, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOTA1, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZUEOTA2, (KLON, 0:KLEV+1))
fxtran_acdc_temp (REAL (KIND=JPRB), ZC_FW, (KLON, 0:KLEV, 3))
fxtran_acdc_temp (REAL (KIND=JPRB), ZC_FS, (KLON, 0:KLEV, 3))
fxtran_acdc_temp (REAL (KIND=JPRB), ZC_FC, (KLON, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZT_FW, (KLON, 0:KLEV, 3))
fxtran_acdc_temp (REAL (KIND=JPRB), ZT_FS, (KLON, 0:KLEV, 3))
fxtran_acdc_temp (REAL (KIND=JPRB), ZT_FC, (KLON, 0:KLEV))
REAL (KIND=JPRB)::ZDEL0 
REAL (KIND=JPRB)::ZDEL1 
fxtran_acdc_temp (REAL (KIND=JPRB), ZDEL1D, (KLON, KLEV-1))
REAL (KIND=JPRB)::ZTAU 
REAL (KIND=JPRB)::ZTAU0A 
REAL (KIND=JPRB)::ZTAU1A 
REAL (KIND=JPRB)::ZTAU0B 
REAL (KIND=JPRB)::ZTAU1B 
fxtran_acdc_temp (REAL (KIND=JPRB), ZTAU0, (KLON, 0:KLEV, 0:KLEV))
fxtran_acdc_temp (REAL (KIND=JPRB), ZTAU1, (KLON, 0:KLEV, 0:KLEV))
INTEGER (KIND=JPIM)::ILEV
INTEGER (KIND=JPIM)::JLON
INTEGER (KIND=JPIM)::JLEV2
INTEGER (KIND=JPIM)::JLEV1
INTEGER (KIND=JPIM)::JLEV
INTEGER (KIND=JPIM)::JG

INTEGER (KIND=JPIM)::JO
REAL (KIND=JPRB)::ZVOIGT
REAL (KIND=JPRB)::ZVOIEMP
REAL (KIND=JPRB)::ZAFVOI
REAL (KIND=JPRB)::ZA2B
REAL (KIND=JPRB)::Z4BU
REAL (KIND=JPRB)::ZT_AVG
REAL (KIND=JPRB)::ZP_AVG
REAL (KIND=JPRB)::ZLOG
REAL (KIND=JPRB)::ZAUX
REAL (KIND=JPRB)::ZDELTA (3)
REAL (KIND=JPRB)::ZAT (3)
REAL (KIND=JPRB)::ZAR (3)
REAL (KIND=JPRB)::ZCOEF (3)
REAL (KIND=JPRB)::ZTAUT (3)
REAL (KIND=JPRB)::ZAC (3)
REAL (KIND=JPRB)::ZTAUC (3)

YLSTACK = YDSTACK



IF (KIND (ZQ) == 8) THEN
    fxtran_acdc_alloc8 (ZQ)
ELSEIF (KIND (ZQ) == 4) THEN
    fxtran_acdc_alloc4 (ZQ)
ELSE
    STOP 1
ENDIF


IF (KIND (ZIRHOV) == 8) THEN
    fxtran_acdc_alloc8 (ZIRHOV)
ELSEIF (KIND (ZIRHOV) == 4) THEN
    fxtran_acdc_alloc4 (ZIRHOV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOTA0) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOTA0)
ELSEIF (KIND (ZDEOTA0) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOTA0)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOTA1) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOTA1)
ELSEIF (KIND (ZDEOTA1) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOTA1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEOTA2) == 8) THEN
    fxtran_acdc_alloc8 (ZDEOTA2)
ELSEIF (KIND (ZDEOTA2) == 4) THEN
    fxtran_acdc_alloc4 (ZDEOTA2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOTA0) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOTA0)
ELSEIF (KIND (ZUEOTA0) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOTA0)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOTA1) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOTA1)
ELSEIF (KIND (ZUEOTA1) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOTA1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZUEOTA2) == 8) THEN
    fxtran_acdc_alloc8 (ZUEOTA2)
ELSEIF (KIND (ZUEOTA2) == 4) THEN
    fxtran_acdc_alloc4 (ZUEOTA2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZC_FW) == 8) THEN
    fxtran_acdc_alloc8 (ZC_FW)
ELSEIF (KIND (ZC_FW) == 4) THEN
    fxtran_acdc_alloc4 (ZC_FW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZC_FS) == 8) THEN
    fxtran_acdc_alloc8 (ZC_FS)
ELSEIF (KIND (ZC_FS) == 4) THEN
    fxtran_acdc_alloc4 (ZC_FS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZC_FC) == 8) THEN
    fxtran_acdc_alloc8 (ZC_FC)
ELSEIF (KIND (ZC_FC) == 4) THEN
    fxtran_acdc_alloc4 (ZC_FC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZT_FW) == 8) THEN
    fxtran_acdc_alloc8 (ZT_FW)
ELSEIF (KIND (ZT_FW) == 4) THEN
    fxtran_acdc_alloc4 (ZT_FW)
ELSE
    STOP 1
ENDIF


IF (KIND (ZT_FS) == 8) THEN
    fxtran_acdc_alloc8 (ZT_FS)
ELSEIF (KIND (ZT_FS) == 4) THEN
    fxtran_acdc_alloc4 (ZT_FS)
ELSE
    STOP 1
ENDIF


IF (KIND (ZT_FC) == 8) THEN
    fxtran_acdc_alloc8 (ZT_FC)
ELSEIF (KIND (ZT_FC) == 4) THEN
    fxtran_acdc_alloc4 (ZT_FC)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDEL1D) == 8) THEN
    fxtran_acdc_alloc8 (ZDEL1D)
ELSEIF (KIND (ZDEL1D) == 4) THEN
    fxtran_acdc_alloc4 (ZDEL1D)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTAU0) == 8) THEN
    fxtran_acdc_alloc8 (ZTAU0)
ELSEIF (KIND (ZTAU0) == 4) THEN
    fxtran_acdc_alloc4 (ZTAU0)
ELSE
    STOP 1
ENDIF


IF (KIND (ZTAU1) == 8) THEN
    fxtran_acdc_alloc8 (ZTAU1)
ELSEIF (KIND (ZTAU1) == 4) THEN
    fxtran_acdc_alloc4 (ZTAU1)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZARGLI=-250._JPRB
ZTRLI=EXP (ZARGLI)
ZEPSP=1.E-03_JPRB
ZEPSD=1.E-20_JPRB
ZEPSU=ZTRLI
ZT_RHOZ0V (1)=0.031_JPRB
ZT_RHOZ0V (2)=0.013_JPRB
ZT_RHOZ0V (3)=0.012_JPRB
ZGAMV=0.36_JPRB
ZEPSV=0.014_JPRB
ZIBV0=1._JPRB/0.74_JPRB
ZIZV0=1._JPRB/0.0027_JPRB
ZVOISIM=1.21_JPRB
ZMD=0.5_JPRB*EXP (0.5_JPRB)

DO JLEV=KTDIA, KLEV
  
  ZQ (JLON, JLEV)=MAX (0._JPRB, MIN (1._JPRB, PQ (JLON, JLEV)))
  
ENDDO


ZDELP =MAX (ZEPSP, PAPRS (JLON, KTDIA-1))
ZP =0.5_JPRB*ZDELP 


ZNSOR =2._JPRB*MAX (ZEPSP, PAPRS (JLON, 0))*PQO3 (JLON, 0)


DO JLEV=1, KTDIA-1
  
  ZNSOR =ZNSOR +2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)
  
ENDDO


ZIRHOV (JLON, KTDIA-1)=(PR (JLON, KTDIA)*PT (JLON, KTDIA))/ZP 


DO JLEV=KTDIA, KLEV
  
  ZIRHOV (JLON, JLEV)=(PR (JLON, JLEV)*PT (JLON, JLEV))/PAPRSF (JLON, JLEV)
  
ENDDO


DO JG=1, 3
  
  ZA=YDPHY3%FGTC_A(JG, 0)*(1._JPRB+YDPHY3%FGTC_A(JG, 1)*PT (JLON&
  &, KTDIA))/(1._JPRB+YDPHY3%FGTC_A(JG, 2)*PT (JLON, KTDIA))
  ZB=YDPHY3%FGTC_B(JG, 0)*(1._JPRB+YDPHY3%FGTC_B(JG, 1)*PT (JLON&
  &, KTDIA))/(1._JPRB+YDPHY3%FGTC_B(JG, 2)*PT (JLON, KTDIA))
  ZC_FW (JLON, KTDIA-1, JG)=ZA
  ZC_FS (JLON, KTDIA-1, JG)=(ZA*ZA/MAX (ZB, ZEPSU))*ZP 
  ZA=YDPHY3%FGTT_A(JG, 0)*(1._JPRB+YDPHY3%FGTT_A(JG, 1)*PT (JLON&
  &, KTDIA))/(1._JPRB+YDPHY3%FGTT_A(JG, 2)*PT (JLON, KTDIA))
  ZB=YDPHY3%FGTT_B(JG, 0)*(1._JPRB+YDPHY3%FGTT_B(JG, 1)*PT (JLON&
  &, KTDIA))/(1._JPRB+YDPHY3%FGTT_B(JG, 2)*PT (JLON, KTDIA))
  ZT_FW (JLON, KTDIA-1, JG)=ZA
  ZT_FS (JLON, KTDIA-1, JG)=(ZA*ZA/MAX (ZB, ZEPSU))*ZP 

  

  DO JLEV=KTDIA, KLEV
    
    ZA=YDPHY3%FGTC_A(JG, 0)*(1._JPRB+YDPHY3%FGTC_A(JG, 1)*PT (JLON&
    &, JLEV))/(1._JPRB+YDPHY3%FGTC_A(JG, 2)*PT (JLON, JLEV))
    ZB=YDPHY3%FGTC_B(JG, 0)*(1._JPRB+YDPHY3%FGTC_B(JG, 1)*PT (JLON&
    &, JLEV))/(1._JPRB+YDPHY3%FGTC_B(JG, 2)*PT (JLON, JLEV))
    ZC_FW (JLON, JLEV, JG)=ZA
    ZC_FS (JLON, JLEV, JG)=(ZA*ZA/MAX (ZB, ZEPSU))*PAPRSF (JLON, JLEV)
    ZA=YDPHY3%FGTT_A(JG, 0)*(1._JPRB+YDPHY3%FGTT_A(JG, 1)*PT (JLON&
    &, JLEV))/(1._JPRB+YDPHY3%FGTT_A(JG, 2)*PT (JLON, JLEV))
    ZB=YDPHY3%FGTT_B(JG, 0)*(1._JPRB+YDPHY3%FGTT_B(JG, 1)*PT (JLON&
    &, JLEV))/(1._JPRB+YDPHY3%FGTT_B(JG, 2)*PT (JLON, JLEV))
    ZT_FW (JLON, JLEV, JG)=ZA
    ZT_FS (JLON, JLEV, JG)=(ZA*ZA/MAX (ZB, ZEPSU))*PAPRSF (JLON, JLEV)
  
  ENDDO

ENDDO


ZC_FC (JLON, KTDIA-1)=YDPHY3%FGTC_C(1)*EXP (-YDPHY3%FGTC_C(2)*PT (JLON, KTDIA))*ZP 


DO JLEV=KTDIA, KLEV
  
  ZC_FC (JLON, JLEV)=YDPHY3%FGTC_C(1)*EXP (-YDPHY3%FGTC_C(2)*PT (JLON, JLEV))*PAPRSF (JLON, JLEV)
  
ENDDO


ZT_FC (JLON, KTDIA-1)=YDPHY3%FGTT_C(1)*EXP (-YDPHY3%FGTT_C(2)*PT (JLON, KTDIA))*ZP 


DO JLEV=KTDIA, KLEV
  
  ZT_FC (JLON, JLEV)=YDPHY3%FGTT_C(1)*EXP (-YDPHY3%FGTT_C(2)*PT (JLON, JLEV))*PAPRSF (JLON, JLEV)
  
ENDDO


ZDU (1)=2._JPRB*ZDELP *ZQ (JLON, KTDIA)
ZDU (2)=2._JPRB*ZDELP *PQCO2 (JLON, KTDIA)*(1._JPRB-ZQ (JLON, KTDIA))
ZDU (3)=ZNSOR *(1._JPRB-ZQ (JLON, KTDIA))
ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, KTDIA)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, KTDIA))

ZC_UW (:)=ZEPSU
ZC_US (:)=ZEPSU
ZC_US_IRHOV (:)=ZEPSU
ZC_UC =ZEPSU
ZC_U (:)=ZEPSU
ZC_PU (:)=ZEPSU
ZC_TU (:)=ZEPSU
ZT_UW (:)=ZEPSU
ZT_US (:)=ZEPSU
ZT_US_IRHOV (:)=ZEPSU
ZT_UC =ZEPSU
ZT_U (:)=ZEPSU
ZT_PU (:)=ZEPSU
ZT_TU (:)=ZEPSU




DO JG=1, 3
  
  ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, (KTDIA-1), JG)*ZDU (JG)
  ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, (KTDIA-1))*ZC_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
  Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
  ZAFVOI=1._JPRB

  IF (YDPHY%LVOIGT) THEN
    ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

    IF (YDPHY%LVFULL) THEN
      ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
    ELSE
      ZVOIEMP=ZVOISIM
    ENDIF

    ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
    &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
  ENDIF

  ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
ENDDO


ZC_UC =ZC_UC +ZC_FC (JLON, (KTDIA-1))*ZDU (4)*ZMD
ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
&*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)


DO JG=1, 3
  
  ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
  & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
  ZC_U (JG)=ZC_U (JG)+ZDU (JG)
  ZC_PU (JG)=ZC_PU (JG)+ZP *ZDU (JG)
  ZC_TU (JG)=ZC_TU (JG)+PT (JLON, KTDIA)*ZDU (JG)
  ZP_AVG=ZC_PU (JG)/ZC_U (JG)
  ZT_AVG=ZC_TU (JG)/ZC_U (JG)
  ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
  ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
  &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
  &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
  &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
  &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
  &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
  &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
  &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
ENDDO


ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
ZAC (3)=1._JPRB-EXP (-ZDELTA (3))


ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))


DO JO=1, 3
  
  ZTAUC (JO)=1._JPRB-ZAR (JO)

  

  IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
    
    ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
    &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
  
  ENDIF

ENDDO


ZDEOTA0 (JLON, KTDIA-1)=-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC&
& (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))


ZDEOTA0 (JLON, KTDIA-1)=MAX (ZDEOTA0 (JLON, KTDIA-1), ZDELTA (1), ZDELTA (2), ZDELTA (3))








DO JG=1, 3
  
  ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, (KTDIA-1), JG)*ZDU (JG)
  ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, (KTDIA-1))*ZT_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
  Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
  ZAFVOI=1._JPRB

  IF (YDPHY%LVOIGT) THEN
    ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

    IF (YDPHY%LVFULL) THEN
      ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
    ELSE
      ZVOIEMP=ZVOISIM
    ENDIF

    ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
    &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
  ENDIF

  ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
ENDDO


ZT_UC =ZT_UC +ZT_FC (JLON, (KTDIA-1))*ZDU (4)*ZMD
ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
&*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)


DO JG=1, 3
  
  ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
  & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
  ZT_U (JG)=ZT_U (JG)+ZDU (JG)
  ZT_PU (JG)=ZT_PU (JG)+ZP *ZDU (JG)
  ZT_TU (JG)=ZT_TU (JG)+PT (JLON, KTDIA)*ZDU (JG)
  ZP_AVG=ZT_PU (JG)/ZT_U (JG)
  ZT_AVG=ZT_TU (JG)/ZT_U (JG)
  ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
  ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
  &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
  &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
  &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
  &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
  &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
  &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
  &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
ENDDO


ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
ZAT (3)=1._JPRB-EXP (-ZDELTA (3))


ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))


DO JO=1, 3
  
  ZTAUT (JO)=1._JPRB-ZAR (JO)

  

  IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
    
    ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
    &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
  
  ENDIF

ENDDO


ZDEOTA1 (JLON, KTDIA-1)=-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT&
& (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))


ZDEOTA1 (JLON, KTDIA-1)=MAX (ZDEOTA1 (JLON, KTDIA-1), ZDELTA (1), ZDELTA (2), ZDELTA (3))





PDEOTI (JLON, KTDIA-1)=ZDEOTA1 (JLON, KTDIA-1)


DO JLEV=KTDIA, KLEV
  
  ZDU (1)=2._JPRB*PDELP (JLON, JLEV)*ZQ (JLON, JLEV)
  ZDU (2)=2._JPRB*PDELP (JLON, JLEV)*PQCO2 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (3)=2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV))

  

  

  

  DO JG=1, 3
    
    ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, JLEV, JG)*ZDU (JG)
    ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZC_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
    Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
  ENDDO

  
  ZC_UC =ZC_UC +ZC_FC (JLON, JLEV)*ZDU (4)*ZMD
  ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
  &*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)

  

  DO JG=1, 3
    
    ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
    & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
    ZC_U (JG)=ZC_U (JG)+ZDU (JG)
    ZC_PU (JG)=ZC_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)
    ZC_TU (JG)=ZC_TU (JG)+PT (JLON, JLEV)*ZDU (JG)
    ZP_AVG=ZC_PU (JG)/ZC_U (JG)
    ZT_AVG=ZC_TU (JG)/ZC_U (JG)
    ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
    ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
    &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
    &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
    &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
    &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
    &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
    &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
    &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
  ENDDO

  
  ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
  ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
  ZAC (3)=1._JPRB-EXP (-ZDELTA (3))
  
  
  ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
  ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
  ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
  ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
  ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
  ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))

  

  DO JO=1, 3
    
    ZTAUC (JO)=1._JPRB-ZAR (JO)

    

    IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
      
      ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
      &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
    
    ENDIF

  ENDDO

  
  ZDEOTA0 (JLON, JLEV)=-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC&
  & (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
  
  
  ZDEOTA0 (JLON, JLEV)=MAX (ZDEOTA0 (JLON, JLEV), ZDELTA (1), ZDELTA (2), ZDELTA (3))

  

  

  

  

  

  

  DO JG=1, 3
    
    ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, JLEV, JG)*ZDU (JG)
    ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZT_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
    Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
  ENDDO

  
  ZT_UC =ZT_UC +ZT_FC (JLON, JLEV)*ZDU (4)*ZMD
  ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
  &*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)

  

  DO JG=1, 3
    
    ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
    & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
    ZT_U (JG)=ZT_U (JG)+ZDU (JG)
    ZT_PU (JG)=ZT_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)
    ZT_TU (JG)=ZT_TU (JG)+PT (JLON, JLEV)*ZDU (JG)
    ZP_AVG=ZT_PU (JG)/ZT_U (JG)
    ZT_AVG=ZT_TU (JG)/ZT_U (JG)
    ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
    ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
    &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
    &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
    &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
    &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
    &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
    &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
    &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
  ENDDO

  
  ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
  ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
  ZAT (3)=1._JPRB-EXP (-ZDELTA (3))
  
  
  ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
  ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
  ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
  ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
  ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
  ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))

  

  DO JO=1, 3
    
    ZTAUT (JO)=1._JPRB-ZAR (JO)

    

    IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
      
      ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
      &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
    
    ENDIF

  ENDDO

  
  ZDEOTA1 (JLON, JLEV)=-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT&
  & (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
  
  
  ZDEOTA1 (JLON, JLEV)=MAX (ZDEOTA1 (JLON, JLEV), ZDELTA (1), ZDELTA (2), ZDELTA (3))
  
  
  
  
  
  PDEOTI (JLON, JLEV)=MAX (ZDEOTA1 (JLON, JLEV)-ZDEOTA1 (JLON, JLEV-1), 0._JPRB)
  
ENDDO


ZTCORR=4._JPRB*(PT (JLON, KTDIA)/YDPHY3%RTL-1._JPRB)
ZTAU0A =EXP (MAX (-ZDEOTA0 (JLON, KTDIA-1), ZARGLI))
ZTAU1A =EXP (MAX (-ZDEOTA1 (JLON, KTDIA-1), ZARGLI))
ZTAU =ZTAU0A +ZTCORR*(ZTAU1A -ZTAU0A )
ZDEOTA2 (JLON, KTDIA-1)=-LOG (MAX (ZTAU , ZTRLI))
PDEOTI2 (JLON, KTDIA-1)=ZDEOTA2 (JLON, KTDIA-1)


DO JLEV=KTDIA, KLEV
  
  ZTCORR=4._JPRB*(PT (JLON, JLEV)/YDPHY3%RTL-1._JPRB)
  ZTAU0B =EXP (MAX (-ZDEOTA0 (JLON, JLEV), ZARGLI))
  ZTAU1B =EXP (MAX (-ZDEOTA1 (JLON, JLEV), ZARGLI))
  ZTAU =ZTAU +ZTAU0B -ZTAU0A +ZTCORR*(ZTAU1B -ZTAU1A -ZTAU0B +ZTAU0A )
  ZDEOTA2 (JLON, JLEV)=-LOG (MAX (ZTAU , ZTRLI))
  PDEOTI2 (JLON, JLEV)=MAX (ZDEOTA2 (JLON, JLEV)-ZDEOTA2 (JLON, JLEV-1), 0._JPRB)
  ZTAU0A =ZTAU0B 
  ZTAU1A =ZTAU1B 
  
ENDDO

ZEOTO =0._JPRB
ZC_UW (:)=ZEPSU
ZC_US (:)=ZEPSU
ZC_US_IRHOV (:)=ZEPSU
ZC_UC =ZEPSU
ZC_U (:)=ZEPSU
ZC_PU (:)=ZEPSU
ZC_TU (:)=ZEPSU
ZT_UW (:)=ZEPSU
ZT_US (:)=ZEPSU
ZT_US_IRHOV (:)=ZEPSU
ZT_UC =ZEPSU
ZT_U (:)=ZEPSU
ZT_PU (:)=ZEPSU
ZT_TU (:)=ZEPSU

DO JLEV=KLEV, KTDIA,-1
  
  ZDU (1)=2._JPRB*PDELP (JLON, JLEV)*ZQ (JLON, JLEV)
  ZDU (2)=2._JPRB*PDELP (JLON, JLEV)*PQCO2 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (3)=2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
  ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV))

  

  

  

  DO JG=1, 3
    
    ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, JLEV, JG)*ZDU (JG)
    ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZC_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
    Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
  ENDDO

  
  ZC_UC =ZC_UC +ZC_FC (JLON, JLEV)*ZDU (4)*ZMD
  ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
  &*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)

  

  DO JG=1, 3
    
    ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
    & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
    ZC_U (JG)=ZC_U (JG)+ZDU (JG)
    ZC_PU (JG)=ZC_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)
    ZC_TU (JG)=ZC_TU (JG)+PT (JLON, JLEV)*ZDU (JG)
    ZP_AVG=ZC_PU (JG)/ZC_U (JG)
    ZT_AVG=ZC_TU (JG)/ZC_U (JG)
    ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
    ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
    &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
    &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
    &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
    &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
    &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
    &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
    &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
  ENDDO

  
  ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
  ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
  ZAC (3)=1._JPRB-EXP (-ZDELTA (3))
  
  
  ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
  ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
  ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
  ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
  ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
  ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))

  

  DO JO=1, 3
    
    ZTAUC (JO)=1._JPRB-ZAR (JO)

    

    IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
      
      ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
      &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
    
    ENDIF

  ENDDO

  
  ZUEOTA0 (JLON, JLEV)=-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC&
  & (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
  
  
  ZUEOTA0 (JLON, JLEV)=MAX (ZUEOTA0 (JLON, JLEV), ZDELTA (1), ZDELTA (2), ZDELTA (3))

  

  

  

  

  

  

  DO JG=1, 3
    
    ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, JLEV, JG)*ZDU (JG)
    ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZT_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
    ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
    Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
    ZAFVOI=1._JPRB

    IF (YDPHY%LVOIGT) THEN
      ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

      IF (YDPHY%LVFULL) THEN
        ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
      ELSE
        ZVOIEMP=ZVOISIM
      ENDIF

      ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
      &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
    ENDIF

    ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
  ENDDO

  
  ZT_UC =ZT_UC +ZT_FC (JLON, JLEV)*ZDU (4)*ZMD
  ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
  &*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)

  

  DO JG=1, 3
    
    ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
    & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
    ZT_U (JG)=ZT_U (JG)+ZDU (JG)
    ZT_PU (JG)=ZT_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)
    ZT_TU (JG)=ZT_TU (JG)+PT (JLON, JLEV)*ZDU (JG)
    ZP_AVG=ZT_PU (JG)/ZT_U (JG)
    ZT_AVG=ZT_TU (JG)/ZT_U (JG)
    ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
    ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
    &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
    &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
    &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
    &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
    &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
    &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
    ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
    &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
  ENDDO

  
  ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
  ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
  ZAT (3)=1._JPRB-EXP (-ZDELTA (3))
  
  
  ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
  ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
  ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
  ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
  ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
  ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))

  

  DO JO=1, 3
    
    ZTAUT (JO)=1._JPRB-ZAR (JO)

    

    IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
      
      ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
      &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
    
    ENDIF

  ENDDO

  
  ZUEOTA1 (JLON, JLEV)=-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT&
  & (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
  
  
  ZUEOTA1 (JLON, JLEV)=MAX (ZUEOTA1 (JLON, JLEV), ZDELTA (1), ZDELTA (2), ZDELTA (3))
  
  
  
  
  
  PUEOTI (JLON, JLEV)=MAX (ZUEOTA1 (JLON, JLEV)-ZEOTO , 0._JPRB)
  ZEOTO =ZUEOTA1 (JLON, JLEV)
  
ENDDO


ZDU (1)=2._JPRB*ZDELP *ZQ (JLON, KTDIA)
ZDU (2)=2._JPRB*ZDELP *PQCO2 (JLON, KTDIA)*(1._JPRB-ZQ (JLON, KTDIA))
ZDU (3)=ZNSOR *(1._JPRB-ZQ (JLON, KTDIA))
ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, KTDIA)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, KTDIA))





DO JG=1, 3
  
  ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, (KTDIA-1), JG)*ZDU (JG)
  ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, (KTDIA-1))*ZC_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
  Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
  ZAFVOI=1._JPRB

  IF (YDPHY%LVOIGT) THEN
    ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

    IF (YDPHY%LVFULL) THEN
      ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
    ELSE
      ZVOIEMP=ZVOISIM
    ENDIF

    ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
    &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
  ENDIF

  ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
ENDDO


ZC_UC =ZC_UC +ZC_FC (JLON, (KTDIA-1))*ZDU (4)*ZMD
ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
&*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)


DO JG=1, 3
  
  ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
  & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
  ZC_U (JG)=ZC_U (JG)+ZDU (JG)
  ZC_PU (JG)=ZC_PU (JG)+ZP *ZDU (JG)
  ZC_TU (JG)=ZC_TU (JG)+PT (JLON, KTDIA)*ZDU (JG)
  ZP_AVG=ZC_PU (JG)/ZC_U (JG)
  ZT_AVG=ZC_TU (JG)/ZC_U (JG)
  ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
  ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
  &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
  &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
  &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
  &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
  &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
  &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
  &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
ENDDO


ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
ZAC (3)=1._JPRB-EXP (-ZDELTA (3))


ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))


DO JO=1, 3
  
  ZTAUC (JO)=1._JPRB-ZAR (JO)

  

  IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
    
    ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
    &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
  
  ENDIF

ENDDO


ZUEOTA0 (JLON, KTDIA-1)=-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC&
& (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))


ZUEOTA0 (JLON, KTDIA-1)=MAX (ZUEOTA0 (JLON, KTDIA-1), ZDELTA (1), ZDELTA (2), ZDELTA (3))








DO JG=1, 3
  
  ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, (KTDIA-1), JG)*ZDU (JG)
  ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, (KTDIA-1))*ZT_FS (JLON, (KTDIA-1), JG)*ZDU (JG)*ZMD
  ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
  Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
  ZAFVOI=1._JPRB

  IF (YDPHY%LVOIGT) THEN
    ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

    IF (YDPHY%LVFULL) THEN
      ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
    ELSE
      ZVOIEMP=ZVOISIM
    ENDIF

    ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
    &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
  ENDIF

  ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
  
ENDDO


ZT_UC =ZT_UC +ZT_FC (JLON, (KTDIA-1))*ZDU (4)*ZMD
ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
&*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)


DO JG=1, 3
  
  ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
  & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
  ZT_U (JG)=ZT_U (JG)+ZDU (JG)
  ZT_PU (JG)=ZT_PU (JG)+ZP *ZDU (JG)
  ZT_TU (JG)=ZT_TU (JG)+PT (JLON, KTDIA)*ZDU (JG)
  ZP_AVG=ZT_PU (JG)/ZT_U (JG)
  ZT_AVG=ZT_TU (JG)/ZT_U (JG)
  ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
  ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
  &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
  &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
  &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
  &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
  &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
  &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
  ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
  &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
  
ENDDO


ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
ZAT (3)=1._JPRB-EXP (-ZDELTA (3))


ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))


DO JO=1, 3
  
  ZTAUT (JO)=1._JPRB-ZAR (JO)

  

  IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
    
    ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
    &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
  
  ENDIF

ENDDO


ZUEOTA1 (JLON, KTDIA-1)=-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT&
& (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))


ZUEOTA1 (JLON, KTDIA-1)=MAX (ZUEOTA1 (JLON, KTDIA-1), ZDELTA (1), ZDELTA (2), ZDELTA (3))





PUEOTI (JLON, KTDIA-1)=MAX (ZUEOTA1 (JLON, KTDIA-1)-ZUEOTA1 (JLON, KTDIA), 0._JPRB)


ZTAU0A =1._JPRB
ZTAU1A =1._JPRB
ZTAU =1._JPRB
ZUEOTA2 (JLON, KLEV+1)=0._JPRB


DO JLEV=KLEV, KTDIA-1,-1
  ILEV=MAX (KTDIA, JLEV)
  
  ZTT=PT (JLON, ILEV)/PTS (JLON)
  ZTCORR=4._JPRB*((PTS (JLON)/YDPHY3%RTL)*(1._JPRB+ZTT*(1._JPRB+ZTT*(1._JPRB+ZTT&
  &*(1._JPRB+ZTT))))/(1._JPRB+ZTT*(1._JPRB+ZTT*(1._JPRB+ZTT)))-1._JPRB)
  ZTAU0B =EXP (MAX (-ZUEOTA0 (JLON, JLEV), ZARGLI))
  ZTAU1B =EXP (MAX (-ZUEOTA1 (JLON, JLEV), ZARGLI))
  ZTAU =ZTAU +ZTAU0B -ZTAU0A +ZTCORR*(ZTAU1B -ZTAU1A -ZTAU0B +ZTAU0A )
  ZUEOTA2 (JLON, JLEV)=-LOG (MAX (ZTAU , ZTRLI))
  PUEOTI2 (JLON, JLEV)=MAX (ZUEOTA2 (JLON, JLEV)-ZUEOTA2 (JLON, JLEV+1), 0._JPRB)
  ZTAU0A =ZTAU0B 
  ZTAU1A =ZTAU1B 
  
ENDDO


IF (.NOT.LDAUTO) THEN

  DO JLEV1=KTDIA-1, KLEV-1
    ZC_UW (:)=ZEPSU
    ZC_US (:)=ZEPSU
    ZC_US_IRHOV (:)=ZEPSU
    ZC_UC =ZEPSU
    ZC_U (:)=ZEPSU
    ZC_PU (:)=ZEPSU
    ZC_TU (:)=ZEPSU
    ZT_UW (:)=ZEPSU
    ZT_US (:)=ZEPSU
    ZT_US_IRHOV (:)=ZEPSU
    ZT_UC =ZEPSU
    ZT_U (:)=ZEPSU
    ZT_PU (:)=ZEPSU
    ZT_TU (:)=ZEPSU

    IF (YDPHY%LRPROX) THEN
      ILEV=MIN (JLEV1+2, KLEV)
    ELSE
      ILEV=JLEV1+1
    ENDIF


    DO JLEV2=JLEV1+1, ILEV
      
      ZDU (1)=2._JPRB*PDELP (JLON, JLEV2)*ZQ (JLON, JLEV2)
      ZDU (2)=2._JPRB*PDELP (JLON, JLEV2)*PQCO2 (JLON, JLEV2)*(1._JPRB-ZQ (JLON, JLEV2))
      ZDU (3)=2._JPRB*PDELP (JLON, JLEV2)*PQO3 (JLON, JLEV2)*(1._JPRB-ZQ (JLON, JLEV2))
      ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV2)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV2))

      

      

      

      DO JG=1, 3
        
        ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, JLEV2, JG)*ZDU (JG)
        ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, JLEV2)*ZC_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
        Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
        ZAFVOI=1._JPRB

        IF (YDPHY%LVOIGT) THEN
          ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

          IF (YDPHY%LVFULL) THEN
            ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
          ELSE
            ZVOIEMP=ZVOISIM
          ENDIF

          ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
          &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
        ENDIF

        ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
      
      ENDDO

      
      ZC_UC =ZC_UC +ZC_FC (JLON, JLEV2)*ZDU (4)*ZMD
      ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
      &*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)

      

      DO JG=1, 3
        
        ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
        & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
        ZC_U (JG)=ZC_U (JG)+ZDU (JG)
        ZC_PU (JG)=ZC_PU (JG)+PAPRSF (JLON, JLEV2)*ZDU (JG)
        ZC_TU (JG)=ZC_TU (JG)+PT (JLON, JLEV2)*ZDU (JG)
        ZP_AVG=ZC_PU (JG)/ZC_U (JG)
        ZT_AVG=ZC_TU (JG)/ZC_U (JG)
        ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
        ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
        &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
        &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
        &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
        &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
        &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
        &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
        &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
      
      ENDDO

      
      ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
      ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
      ZAC (3)=1._JPRB-EXP (-ZDELTA (3))
      
      
      ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
      ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
      ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
      ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
      ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
      ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))

      

      DO JO=1, 3
        
        ZTAUC (JO)=1._JPRB-ZAR (JO)

        

        IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
          
          ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
          &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
        
        ENDIF

      ENDDO

      
      ZDEL0 =-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
      
      
      ZDEL0 =MAX (ZDEL0 , ZDELTA (1), ZDELTA (2), ZDELTA (3))

      

      

      

      

      

      

      DO JG=1, 3
        
        ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, JLEV2, JG)*ZDU (JG)
        ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, JLEV2)*ZT_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
        Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
        ZAFVOI=1._JPRB

        IF (YDPHY%LVOIGT) THEN
          ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

          IF (YDPHY%LVFULL) THEN
            ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
          ELSE
            ZVOIEMP=ZVOISIM
          ENDIF

          ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
          &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
        ENDIF

        ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
      
      ENDDO

      
      ZT_UC =ZT_UC +ZT_FC (JLON, JLEV2)*ZDU (4)*ZMD
      ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
      &*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)

      

      DO JG=1, 3
        
        ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
        & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
        ZT_U (JG)=ZT_U (JG)+ZDU (JG)
        ZT_PU (JG)=ZT_PU (JG)+PAPRSF (JLON, JLEV2)*ZDU (JG)
        ZT_TU (JG)=ZT_TU (JG)+PT (JLON, JLEV2)*ZDU (JG)
        ZP_AVG=ZT_PU (JG)/ZT_U (JG)
        ZT_AVG=ZT_TU (JG)/ZT_U (JG)
        ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
        ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
        &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
        &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
        &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
        &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
        &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
        &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
        &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
      
      ENDDO

      
      ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
      ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
      ZAT (3)=1._JPRB-EXP (-ZDELTA (3))
      
      
      ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
      ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
      ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
      ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
      ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
      ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))

      

      DO JO=1, 3
        
        ZTAUT (JO)=1._JPRB-ZAR (JO)

        

        IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
          
          ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
          &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
        
        ENDIF

      ENDDO

      
      ZDEL1 =-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
      
      
      ZDEL1 =MAX (ZDEL1 , ZDELTA (1), ZDELTA (2), ZDELTA (3))

      

      

      

      

      IF (YDPHY%LRPROX) THEN
        
        ZTAU0 (JLON, JLEV1, JLEV2)=EXP (MAX (-ZDEL0 , ZARGLI))
        ZTAU1 (JLON, JLEV1, JLEV2)=EXP (MAX (-ZDEL1 , ZARGLI))
      
      ENDIF


      IF (JLEV2==JLEV1+1) THEN
        
        PEOLT (JLON, JLEV1+1)=ZDEL1 
      
      ELSEIF (JLEV2==JLEV1+2) THEN
        
        ZDEL1D (JLON, JLEV1+1)=ZDEL1 
      
      ENDIF

    ENDDO

  ENDDO

  ZC_UW (:)=ZEPSU
  ZC_US (:)=ZEPSU
  ZC_US_IRHOV (:)=ZEPSU
  ZC_UC =ZEPSU
  ZC_U (:)=ZEPSU
  ZC_PU (:)=ZEPSU
  ZC_TU (:)=ZEPSU
  ZT_UW (:)=ZEPSU
  ZT_US (:)=ZEPSU
  ZT_US_IRHOV (:)=ZEPSU
  ZT_UC =ZEPSU
  ZT_U (:)=ZEPSU
  ZT_PU (:)=ZEPSU
  ZT_TU (:)=ZEPSU

  DO JLEV=KTDIA, KLEV
    
    ZDU (1)=2._JPRB*PDELP (JLON, JLEV)*ZQ (JLON, JLEV)
    ZDU (2)=2._JPRB*PDELP (JLON, JLEV)*PQCO2 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
    ZDU (3)=2._JPRB*PDELP (JLON, JLEV)*PQO3 (JLON, JLEV)*(1._JPRB-ZQ (JLON, JLEV))
    ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV))

    

    

    

    DO JG=1, 3
      
      ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, JLEV, JG)*ZDU (JG)
      ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
      ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZC_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
      ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
      Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
      ZAFVOI=1._JPRB

      IF (YDPHY%LVOIGT) THEN
        ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

        IF (YDPHY%LVFULL) THEN
          ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
        ELSE
          ZVOIEMP=ZVOISIM
        ENDIF

        ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
        &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
      ENDIF

      ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
    
    ENDDO

    
    ZC_UC =ZC_UC +ZC_FC (JLON, JLEV)*ZDU (4)*ZMD
    ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
    &*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)

    

    DO JG=1, 3
      
      ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
      & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
      ZC_U (JG)=ZC_U (JG)+ZDU (JG)
      ZC_PU (JG)=ZC_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)
      ZC_TU (JG)=ZC_TU (JG)+PT (JLON, JLEV)*ZDU (JG)
      ZP_AVG=ZC_PU (JG)/ZC_U (JG)
      ZT_AVG=ZC_TU (JG)/ZC_U (JG)
      ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
      ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
      ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
      &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
      &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
      &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
      &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
      &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
      &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
      ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
      &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
    
    ENDDO

    
    ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
    ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
    ZAC (3)=1._JPRB-EXP (-ZDELTA (3))
    
    
    ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
    ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
    ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
    ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
    ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
    ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))

    

    DO JO=1, 3
      
      ZTAUC (JO)=1._JPRB-ZAR (JO)

      

      IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
        
        ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
        &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
      
      ENDIF

    ENDDO

    
    ZDEL0 =-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
    
    
    ZDEL0 =MAX (ZDEL0 , ZDELTA (1), ZDELTA (2), ZDELTA (3))

    

    

    

    

    

    

    DO JG=1, 3
      
      ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, JLEV, JG)*ZDU (JG)
      ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
      ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, JLEV)*ZT_FS (JLON, JLEV, JG)*ZDU (JG)*ZMD
      ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
      Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
      ZAFVOI=1._JPRB

      IF (YDPHY%LVOIGT) THEN
        ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

        IF (YDPHY%LVFULL) THEN
          ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
        ELSE
          ZVOIEMP=ZVOISIM
        ENDIF

        ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
        &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
      ENDIF

      ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
    
    ENDDO

    
    ZT_UC =ZT_UC +ZT_FC (JLON, JLEV)*ZDU (4)*ZMD
    ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
    &*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)

    

    DO JG=1, 3
      
      ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
      & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
      ZT_U (JG)=ZT_U (JG)+ZDU (JG)
      ZT_PU (JG)=ZT_PU (JG)+PAPRSF (JLON, JLEV)*ZDU (JG)
      ZT_TU (JG)=ZT_TU (JG)+PT (JLON, JLEV)*ZDU (JG)
      ZP_AVG=ZT_PU (JG)/ZT_U (JG)
      ZT_AVG=ZT_TU (JG)/ZT_U (JG)
      ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
      ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
      ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
      &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
      &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
      &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
      &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
      &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
      &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
      ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
      &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
    
    ENDDO

    
    ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
    ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
    ZAT (3)=1._JPRB-EXP (-ZDELTA (3))
    
    
    ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
    ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
    ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
    ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
    ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
    ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))

    

    DO JO=1, 3
      
      ZTAUT (JO)=1._JPRB-ZAR (JO)

      

      IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
        
        ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
        &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
      
      ENDIF

    ENDDO

    
    ZDEL1 =-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
    
    
    ZDEL1 =MAX (ZDEL1 , ZDELTA (1), ZDELTA (2), ZDELTA (3))
  
  
  
  
  ENDDO

  
  ZTAU0 (JLON, KTDIA-1, KLEV)=EXP (MAX (-ZDEL0 , ZARGLI))
  ZTAU1 (JLON, KTDIA-1, KLEV)=EXP (MAX (-ZDEL1 , ZARGLI))
  
ELSE

  DO JLEV1=KTDIA-1, KLEV
    ZC_UW (:)=ZEPSU
    ZC_US (:)=ZEPSU
    ZC_US_IRHOV (:)=ZEPSU
    ZC_UC =ZEPSU
    ZC_U (:)=ZEPSU
    ZC_PU (:)=ZEPSU
    ZC_TU (:)=ZEPSU
    ZT_UW (:)=ZEPSU
    ZT_US (:)=ZEPSU
    ZT_US_IRHOV (:)=ZEPSU
    ZT_UC =ZEPSU
    ZT_U (:)=ZEPSU
    ZT_PU (:)=ZEPSU
    ZT_TU (:)=ZEPSU
    
    ZTAU0 (JLON, JLEV1, JLEV1)=1._JPRB
    ZTAU1 (JLON, JLEV1, JLEV1)=1._JPRB

    

    DO JLEV2=JLEV1+1, KLEV
      
      ZDU (1)=2._JPRB*PDELP (JLON, JLEV2)*ZQ (JLON, JLEV2)
      ZDU (2)=2._JPRB*PDELP (JLON, JLEV2)*PQCO2 (JLON, JLEV2)*(1._JPRB-ZQ (JLON, JLEV2))
      ZDU (3)=2._JPRB*PDELP (JLON, JLEV2)*PQO3 (JLON, JLEV2)*(1._JPRB-ZQ (JLON, JLEV2))
      ZDU (4)=ZDU (1)*YDCST%RV*ZQ (JLON, JLEV2)/(YDCST%RD+(YDCST%RV-YDCST%RD)*ZQ (JLON, JLEV2))

      

      

      

      DO JG=1, 3
        
        ZC_UW (JG)=ZC_UW (JG)+ZC_FW (JLON, JLEV2, JG)*ZDU (JG)
        ZC_US (JG)=ZC_US (JG)+ZC_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZC_US_IRHOV (JG)=ZC_US_IRHOV (JG)+ZIRHOV (JLON, JLEV2)*ZC_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZA2B=ZC_US (JG)/(2._JPRB*ZC_UW (JG))
        Z4BU=4._JPRB*ZC_UW (JG)*ZC_UW (JG)/ZC_US (JG)
        ZAFVOI=1._JPRB

        IF (YDPHY%LVOIGT) THEN
          ZVOIGT=ZT_RHOZ0V (JG)*ZC_US_IRHOV (JG)/ZC_US (JG)

          IF (YDPHY%LVFULL) THEN
            ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
          ELSE
            ZVOIEMP=ZVOISIM
          ENDIF

          ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
          &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
        ENDIF

        ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
      
      ENDDO

      
      ZC_UC =ZC_UC +ZC_FC (JLON, JLEV2)*ZDU (4)*ZMD
      ZDELTA (1)=ZDELTA (1)+ZC_UC /(1._JPRB+YDPHY3%FGTC_C(3)&
      &*ZC_UC )+YDPHY3%FGTC_C(4)*ZC_UC **YDPHY3%FGTC_C(5)

      

      DO JG=1, 3
        
        ZDELTA (JG)=(YDPHY3%FGTC_DELTA0(JG)/YDPHY3%FGTC_ALPHA(JG))*((1._JPRB+ZDELTA&
        & (JG)/YDPHY3%FGTC_DELTA0(JG))**YDPHY3%FGTC_ALPHA(JG)-1._JPRB)
        ZC_U (JG)=ZC_U (JG)+ZDU (JG)
        ZC_PU (JG)=ZC_PU (JG)+PAPRSF (JLON, JLEV2)*ZDU (JG)
        ZC_TU (JG)=ZC_TU (JG)+PT (JLON, JLEV2)*ZDU (JG)
        ZP_AVG=ZC_PU (JG)/ZC_U (JG)
        ZT_AVG=ZC_TU (JG)/ZC_U (JG)
        ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTC_D(JG))
        ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTC_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTC_P00(JG, 1)+ZT_AVG*YDPHY3&
        &%FGTC_P00(JG, 2))+ZAUX*(YDPHY3%FGTC_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTC_P&
        &(JG, 0, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 1&
        &, 2))+ZLOG*(YDPHY3%FGTC_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 2, 2))+ZLOG&
        &*(YDPHY3%FGTC_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 3, 2))+ZLOG*(YDPHY3&
        &%FGTC_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTC_P&
        &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTC_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTC_P(JG, 5, 2)))))))))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTC_Q(JG, 0)+ZP_AVG*(YDPHY3&
        &%FGTC_Q(JG, 1)+ZP_AVG*YDPHY3%FGTC_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
      
      ENDDO

      
      ZAC (1)=1._JPRB-EXP (-ZDELTA (1))
      ZAC (2)=1._JPRB-EXP (-ZDELTA (2))
      ZAC (3)=1._JPRB-EXP (-ZDELTA (3))
      
      
      ZAR (1)=ZAC (1)+ZAC (2)-ZAC (1)*ZAC (2)
      ZAR (2)=ZAC (1)+ZAC (3)-ZAC (1)*ZAC (3)
      ZAR (3)=ZAC (2)+ZAC (3)-ZAC (2)*ZAC (3)
      ZCOEF (1)=2._JPRB*ZAC (1)*ZAC (2)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (2)*ZAC (2))
      ZCOEF (2)=2._JPRB*ZAC (1)*ZAC (3)/(ZEPSD+ZAC (1)*ZAC (1)+ZAC (3)*ZAC (3))
      ZCOEF (3)=2._JPRB*ZAC (2)*ZAC (3)/(ZEPSD+ZAC (2)*ZAC (2)+ZAC (3)*ZAC (3))

      

      DO JO=1, 3
        
        ZTAUC (JO)=1._JPRB-ZAR (JO)

        

        IF (YDPHY3%FGTC_OA(JO)/=0._JPRB) THEN
          
          ZTAUC (JO)=ZTAUC (JO)-ZCOEF (JO)*YDPHY3%FGTC_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTC_OB&
          &(JO)*ZAR (JO)**YDPHY3%FGTC_OC(JO)*(1._JPRB-YDPHY3%FGTC_OD(JO)*ZAR (JO))
        
        ENDIF

      ENDDO

      
      ZDEL0 =-LOG (MAX (ZTRLI, ZTAUC (1)*ZTAUC (2)*ZTAUC (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
      
      
      ZDEL0 =MAX (ZDEL0 , ZDELTA (1), ZDELTA (2), ZDELTA (3))

      

      

      

      

      

      

      DO JG=1, 3
        
        ZT_UW (JG)=ZT_UW (JG)+ZT_FW (JLON, JLEV2, JG)*ZDU (JG)
        ZT_US (JG)=ZT_US (JG)+ZT_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZT_US_IRHOV (JG)=ZT_US_IRHOV (JG)+ZIRHOV (JLON, JLEV2)*ZT_FS (JLON, JLEV2, JG)*ZDU (JG)*ZMD
        ZA2B=ZT_US (JG)/(2._JPRB*ZT_UW (JG))
        Z4BU=4._JPRB*ZT_UW (JG)*ZT_UW (JG)/ZT_US (JG)
        ZAFVOI=1._JPRB

        IF (YDPHY%LVOIGT) THEN
          ZVOIGT=ZT_RHOZ0V (JG)*ZT_US_IRHOV (JG)/ZT_US (JG)

          IF (YDPHY%LVFULL) THEN
            ZVOIEMP=EXP (ZEPSV*LOG (ZIBV0*(Z4BU/ZVOIGT))*LOG (ZIZV0*ZVOIGT))
          ELSE
            ZVOIEMP=ZVOISIM
          ENDIF

          ZAFVOI=1._JPRB+ZVOIGT/(YDCST%RPI*(Z4BU/ZVOIGT)/(1.5_JPRB*SQRT (Z4BU)&
          &)+4._JPRB/(Z4BU/ZVOIGT)+5._JPRB+ZGAMV*SQRT (Z4BU/ZVOIGT)*ZVOIEMP)
        ENDIF

        ZDELTA (JG)=ZA2B*(SQRT (1._JPRB+ZAFVOI*Z4BU)-1._JPRB)
      
      ENDDO

      
      ZT_UC =ZT_UC +ZT_FC (JLON, JLEV2)*ZDU (4)*ZMD
      ZDELTA (1)=ZDELTA (1)+ZT_UC /(1._JPRB+YDPHY3%FGTT_C(3)&
      &*ZT_UC )+YDPHY3%FGTT_C(4)*ZT_UC **YDPHY3%FGTT_C(5)

      

      DO JG=1, 3
        
        ZDELTA (JG)=(YDPHY3%FGTT_DELTA0(JG)/YDPHY3%FGTT_ALPHA(JG))*((1._JPRB+ZDELTA&
        & (JG)/YDPHY3%FGTT_DELTA0(JG))**YDPHY3%FGTT_ALPHA(JG)-1._JPRB)
        ZT_U (JG)=ZT_U (JG)+ZDU (JG)
        ZT_PU (JG)=ZT_PU (JG)+PAPRSF (JLON, JLEV2)*ZDU (JG)
        ZT_TU (JG)=ZT_TU (JG)+PT (JLON, JLEV2)*ZDU (JG)
        ZP_AVG=ZT_PU (JG)/ZT_U (JG)
        ZT_AVG=ZT_TU (JG)/ZT_U (JG)
        ZAUX=ZDELTA (JG)/(ZDELTA (JG)+YDPHY3%FGTT_D(JG))
        ZLOG=LOG (MAX (ZDELTA (JG), ZTRLI))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, YDPHY3%FGTT_P00(JG, 0)+ZT_AVG*(YDPHY3%FGTT_P00(JG, 1)+ZT_AVG*YDPHY3&
        &%FGTT_P00(JG, 2))+ZAUX*(YDPHY3%FGTT_P(JG, 0, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 0, 1)+ZT_AVG*YDPHY3%FGTT_P&
        &(JG, 0, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 1, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 1, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 1&
        &, 2))+ZLOG*(YDPHY3%FGTT_P(JG, 2, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 2, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 2, 2))+ZLOG&
        &*(YDPHY3%FGTT_P(JG, 3, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 3, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 3, 2))+ZLOG*(YDPHY3&
        &%FGTT_P(JG, 4, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 4, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 4, 2))+ZLOG*(YDPHY3%FGTT_P&
        &(JG, 5, 0)+ZT_AVG*(YDPHY3%FGTT_P(JG, 5, 1)+ZT_AVG*YDPHY3%FGTT_P(JG, 5, 2)))))))))
        ZDELTA (JG)=ZDELTA (JG)*MAX (0._JPRB, 1._JPRB+(YDPHY3%FGTT_Q(JG, 0)+ZP_AVG*(YDPHY3&
        &%FGTT_Q(JG, 1)+ZP_AVG*YDPHY3%FGTT_Q(JG, 2)))/(1._JPRB+ZDELTA (JG)))
      
      ENDDO

      
      ZAT (1)=1._JPRB-EXP (-ZDELTA (1))
      ZAT (2)=1._JPRB-EXP (-ZDELTA (2))
      ZAT (3)=1._JPRB-EXP (-ZDELTA (3))
      
      
      ZAR (1)=ZAT (1)+ZAT (2)-ZAT (1)*ZAT (2)
      ZAR (2)=ZAT (1)+ZAT (3)-ZAT (1)*ZAT (3)
      ZAR (3)=ZAT (2)+ZAT (3)-ZAT (2)*ZAT (3)
      ZCOEF (1)=2._JPRB*ZAT (1)*ZAT (2)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (2)*ZAT (2))
      ZCOEF (2)=2._JPRB*ZAT (1)*ZAT (3)/(ZEPSD+ZAT (1)*ZAT (1)+ZAT (3)*ZAT (3))
      ZCOEF (3)=2._JPRB*ZAT (2)*ZAT (3)/(ZEPSD+ZAT (2)*ZAT (2)+ZAT (3)*ZAT (3))

      

      DO JO=1, 3
        
        ZTAUT (JO)=1._JPRB-ZAR (JO)

        

        IF (YDPHY3%FGTT_OA(JO)/=0._JPRB) THEN
          
          ZTAUT (JO)=ZTAUT (JO)-ZCOEF (JO)*YDPHY3%FGTT_OA(JO)*(1._JPRB-ZAR (JO))**YDPHY3%FGTT_OB&
          &(JO)*ZAR (JO)**YDPHY3%FGTT_OC(JO)*(1._JPRB-YDPHY3%FGTT_OD(JO)*ZAR (JO))
        
        ENDIF

      ENDDO

      
      ZDEL1 =-LOG (MAX (ZTRLI, ZTAUT (1)*ZTAUT (2)*ZTAUT (3)))-(ZDELTA (1)+ZDELTA (2)+ZDELTA (3))
      
      
      ZDEL1 =MAX (ZDEL1 , ZDELTA (1), ZDELTA (2), ZDELTA (3))
      
      
      
      
      
      ZTAU0 (JLON, JLEV1, JLEV2)=EXP (MAX (-ZDEL0 , ZARGLI))
      ZTAU1 (JLON, JLEV1, JLEV2)=EXP (MAX (-ZDEL1 , ZARGLI))

      

      IF (JLEV2==JLEV1+1) THEN
        
        PEOLT (JLON, JLEV1+1)=ZDEL1 
      
      ELSEIF (YDPHY%LRPROX.AND.(JLEV2==JLEV1+2)) THEN
        
        ZDEL1D (JLON, JLEV1+1)=ZDEL1 
      
      ENDIF

    ENDDO

  ENDDO


  DO JLEV1=KTDIA, KLEV

    IF (YDPHY%LRPROX) THEN
      ILEV=JLEV1+2
    ELSE
      ILEV=JLEV1+1
    ENDIF


    DO JLEV2=ILEV, KLEV
      
      PPNER0 (JLON, JLEV1, JLEV2)=ZTAU0 (JLON, JLEV1, JLEV2)-ZTAU0 (JLON, JLEV1&
      &-1, JLEV2)-ZTAU0 (JLON, JLEV1, JLEV2-1)+ZTAU0 (JLON, JLEV1-1, JLEV2-1)
      PPNER1 (JLON, JLEV1, JLEV2)=ZTAU1 (JLON, JLEV1, JLEV2)-ZTAU1 (JLON, JLEV1&
      &-1, JLEV2)-ZTAU1 (JLON, JLEV1, JLEV2-1)+ZTAU1 (JLON, JLEV1-1, JLEV2-1)
    
    ENDDO

  ENDDO

ENDIF


IF (YDPHY%LRPROX) THEN
  
  PEOXT (JLON, KTDIA)=ZDEL1D (JLON, KTDIA)-PEOLT (JLON, KTDIA)
  PEOXT (JLON, KTDIA+1)=ZDEL1D (JLON, KTDIA+1)-PEOLT (JLON, KTDIA+1)
  PEOXT (JLON, KLEV-1)=ZDEL1D (JLON, KLEV-2)-PEOLT (JLON, KLEV-1)
  PEOXT (JLON, KLEV)=ZDEL1D (JLON, KLEV-1)-PEOLT (JLON, KLEV)

  

  DO JLEV=KTDIA+2, KLEV-2
    
    PEOXT (JLON, JLEV)=MAX (ZDEL1D (JLON, JLEV-1)-PEOLT (JLON&
    &, JLEV), ZDEL1D (JLON, JLEV)-PEOLT (JLON, JLEV))
  
  ENDDO

  PRPROX (JLON,:)=0._JPRB

  DO JLEV=KTDIA, KLEV-1
    
    ZTT=PT (JLON, JLEV)/PT (JLON, JLEV+1)
    ZTCORR=4._JPRB*((PT (JLON, JLEV+1)/YDPHY3%RTL)*(1._JPRB+ZTT*(1._JPRB+ZTT*(1._JPRB&
    &+ZTT*(1._JPRB+ZTT))))/(1._JPRB+ZTT*(1._JPRB+ZTT*(1._JPRB+ZTT)))-1._JPRB)
    PRPROX (JLON, JLEV)=((1._JPRB-ZTCORR)*(ZTAU0 (JLON, JLEV-1, JLEV+1)-ZTAU0 (JLON, JLEV-1&
    &, JLEV)-ZTAU0 (JLON, JLEV, JLEV+1))+ZTCORR*(ZTAU1 (JLON, JLEV-1, JLEV+1)-ZTAU1 (JLON,&
    & JLEV-1, JLEV)-ZTAU1 (JLON, JLEV, JLEV+1))+ZTAU1 (JLON, JLEV-1, JLEV)+ZTAU1 (JLON, JLEV&
    &, JLEV+1))/MAX (ZTAU1 (JLON, JLEV-1, JLEV)*ZTAU1 (JLON, JLEV, JLEV+1), ZTRLI)
  
  ENDDO

ELSE

  DO JLEV=KTDIA, KLEV
    
    PEOXT (JLON, JLEV)=PEOLT (JLON, JLEV)
  
  ENDDO

ENDIF

PRSURF (JLON)=0._JPRB

DO JLEV=KTDIA, KLEV
  
  PRSURF (JLON)=PRSURF (JLON)+PDEOTI2 (JLON, JLEV)
  
ENDDO


ZTCORR=4._JPRB*(PTS (JLON)/YDPHY3%RTL-1._JPRB)
PRSURF (JLON)=(ZTAU0 (JLON, KTDIA-1, KLEV)+ZTCORR*(ZTAU1 (JLON, KTDIA-1, KLEV&
&)-ZTAU0 (JLON, KTDIA-1, KLEV)))/EXP (MAX (-PRSURF (JLON), ZARGLI))






END SUBROUTINE ACRANEB_TRANST_OPENACC
